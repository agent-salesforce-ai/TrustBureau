<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trust Bureau | High Vis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        mono: ['JetBrains Mono', 'monospace'],
                    },
                    colors: {
                        // Crisp grays for light mode
                        slate: { 
                            50: '#f8fafc', 
                            100: '#f1f5f9', 
                            200: '#e2e8f0',
                            800: '#1e293b',
                            900: '#0f172a'
                        },
                        dark: { bg: '#050505', card: '#111', border: '#333' }
                    },
                    animation: {
                        'pulse-fast': 'pulse 1s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #333; }
        
        /* --- ADVANCED FORMATTING --- */
        
        /* Highlights */
        .highlight-val {
            font-weight: 700;
            color: #0f172a; /* Slate 900 */
            background-color: #f1f5f9; /* Slate 100 */
            padding: 2px 6px;
            border-radius: 4px;
            border: 1px solid #e2e8f0;
        }
        .dark .highlight-val {
            background-color: rgba(255,255,255,0.15);
            color: #fff;
            border-color: rgba(255,255,255,0.1);
        }

        /* Data Rows (Zebra Striping) */
        .data-row {
            display: flex;
            justify-content: space-between;
            padding: 12px 16px; /* More padding */
            border-bottom: 1px solid #f1f5f9;
            font-size: 0.95rem; /* Larger text */
            align-items: center;
        }
        .dark .data-row { border-bottom: 1px solid #222; }
        .data-row:last-child { border-bottom: none; }
        .data-row:nth-child(odd) { background-color: #f8fafc; }
        .dark .data-row:nth-child(odd) { background-color: #0a0a0a; }

        .data-key { 
            color: #64748b; /* Slate 500 */
            font-weight: 600; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 0.05em; 
        }
        .dark .data-key { color: #888; }

        .data-val { 
            font-weight: 600; 
            text-align: right; 
            color: #0f172a; 
            font-family: 'Inter', sans-serif;
        }
        .dark .data-val { color: #fff; }

        /* Lists */
        .styled-list { margin: 12px 0; }
        .styled-list li {
            position: relative;
            padding-left: 24px;
            margin-bottom: 8px;
            font-size: 1rem;
            line-height: 1.6;
            color: #334155;
        }
        .dark .styled-list li { color: #ccc; }
        
        .styled-list li::before {
            content: "→";
            position: absolute;
            left: 0;
            color: #000;
            font-weight: bold;
        }
        .dark .styled-list li::before { color: #fff; }

        /* Headers within logs */
        h3 {
            font-size: 0.8rem;
            font-weight: 900;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            color: #94a3b8;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 4px;
            display: inline-block;
        }
        .dark h3 { color: #666; border-color: #333; }

        *:focus-visible { outline: 2px solid currentColor; outline-offset: 2px; }
    </style>
</head>
<body class="bg-slate-100 text-slate-900 dark:bg-dark-bg dark:text-white transition-colors duration-300 min-h-screen flex flex-col font-sans antialiased selection:bg-black selection:text-white dark:selection:bg-white dark:selection:text-black">

    <!-- HEADER -->
    <header class="fixed top-0 w-full z-50 border-b border-slate-200 dark:border-white/10 bg-white/80 dark:bg-black/80 backdrop-blur-md">
        <div class="max-w-5xl mx-auto px-4 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-9 h-9 bg-black dark:bg-white text-white dark:text-black rounded-lg flex items-center justify-center font-black text-xl shadow-lg">T</div>
                <h1 class="font-black tracking-tight text-xl uppercase text-slate-800 dark:text-white">Trust Bureau</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="connection-status" class="hidden md:flex items-center gap-2 text-xs font-bold uppercase tracking-wider text-slate-400">
                    <span class="w-2 h-2 bg-slate-300 dark:bg-slate-700 rounded-full"></span> Ready
                </div>
                <button onclick="toggleTheme()" class="p-2 rounded-full hover:bg-slate-200 dark:hover:bg-white/10 transition-colors text-slate-600 dark:text-slate-300">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
                </button>
                <button onclick="logout()" class="text-xs font-black uppercase tracking-widest hover:underline text-slate-900 dark:text-white">Reset</button>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main class="flex-1 pt-28 pb-12 px-4 max-w-4xl mx-auto w-full">

        <!-- SECTION: CONFIG -->
        <div id="config-panel" class="max-w-md mx-auto mt-8 transition-all duration-500">
            <div class="bg-white dark:bg-dark-card border border-slate-200 dark:border-white/20 rounded-2xl p-10 shadow-xl">
                <h2 class="text-3xl font-black mb-3 uppercase tracking-tight">System Access</h2>
                <p class="text-slate-500 dark:text-slate-400 mb-8 font-medium">Enter authorized credentials to proceed.</p>
                
                <div class="space-y-5">
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1 text-slate-500">Google API Key</label>
                        <input type="password" id="api-key" placeholder="AIzaSy..." 
                            class="w-full bg-slate-50 dark:bg-black border border-slate-200 dark:border-white/20 rounded-lg p-4 text-base font-mono focus:border-black dark:focus:border-white outline-none transition-all shadow-sm">
                    </div>
                    
                    <div>
                        <label class="block text-xs font-bold uppercase mb-1 text-slate-500">Intelligence Model</label>
                        <div class="relative">
                            <select id="model-select" class="w-full bg-slate-50 dark:bg-black border border-slate-200 dark:border-white/20 rounded-lg p-4 text-base font-medium appearance-none focus:border-black dark:focus:border-white outline-none shadow-sm cursor-pointer">
                                <option value="gemini-2.5-flash">Gemini 2.5 Flash (Standard)</option>
                                <option value="gemini-2.5-pro">Gemini 2.5 Pro (Reasoning)</option>
                                <option value="gemini-1.5-flash">Gemini 1.5 Flash (Fallback)</option>
                            </select>
                            <div class="absolute right-4 top-4 pointer-events-none opacity-50">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
                            </div>
                        </div>
                    </div>

                    <button onclick="saveAndConnect()" class="w-full bg-black dark:bg-white text-white dark:text-black font-black py-4 rounded-lg hover:opacity-80 transition-all uppercase tracking-widest text-sm shadow-lg">
                        Authenticate
                    </button>
                    
                    <div class="text-center pt-2">
                         <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-xs font-bold text-slate-400 hover:text-black dark:hover:text-white underline transition-colors">Get Free API Key &rarr;</a>
                    </div>
                </div>
            </div>
        </div>

        <!-- SECTION: OPERATIONS -->
        <div id="ops-panel" class="hidden space-y-8">
            
            <!-- Search Bar -->
            <div class="relative group z-20">
                <div class="relative flex bg-white dark:bg-dark-card rounded-xl p-2 shadow-xl border border-slate-200 dark:border-white/20">
                    <input type="text" id="target-input" placeholder="Enter Target Entity (e.g. Acme Corp)..." 
                        onkeydown="if(event.key==='Enter') runScan()"
                        class="w-full bg-transparent text-xl p-4 outline-none placeholder-slate-300 dark:placeholder-slate-600 text-slate-900 dark:text-white font-bold">
                    <button id="scan-btn" onclick="runScan()" class="bg-black dark:bg-white text-white dark:text-black font-black px-8 rounded-lg transition-all hover:scale-105 active:scale-95 flex items-center gap-2 shadow-md">
                        <span>BEGIN</span>
                    </button>
                </div>
            </div>

            <!-- Metrics Grid -->
            <div id="metrics-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4 hidden opacity-0 transition-opacity duration-500">
                <!-- Filled by JS -->
            </div>

            <!-- Feed / Log -->
            <div class="relative">
                <!-- Header -->
                <div class="flex items-center justify-between mb-4 px-2">
                    <div class="text-xs font-black uppercase tracking-widest text-slate-400">Intelligence Feed</div>
                    <button onclick="resetAll()" class="text-xs font-bold hover:text-red-500 text-slate-400 transition-colors">CLEAR FEED</button>
                </div>

                <!-- Console Content -->
                <div id="console" class="min-h-[500px] flex flex-col pb-12 space-y-8">
                    <div class="text-center opacity-30 py-20">
                        <div class="mb-3 font-black text-sm tracking-widest">AWAITING ASSIGNMENT</div>
                        <div class="w-16 h-1 bg-current mx-auto rounded-full"></div>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIG ---
        const STORAGE_KEY = 'tb_v49_vis';
        let STATE = { key: '', model: 'gemini-2.5-flash', target: '', theme: 'light', isRunning: false };
        
        // --- WORKFLOW ---
        const WORKFLOW = {
            'BASE': 'REGISTRY',
            'REGISTRY': 'LEGAL',
            'LEGAL': 'REVIEWS',
            'REVIEWS': 'UCC',
            'UCC': null
        };

        // --- INIT ---
        window.onload = () => {
            const savedTheme = localStorage.getItem('tb_theme');
            // Default to Light if not set, or if set to light
            if (savedTheme === 'dark') {
                STATE.theme = 'dark';
                document.documentElement.classList.add('dark');
            } else {
                STATE.theme = 'light';
                document.documentElement.classList.remove('dark');
            }

            const savedKey = localStorage.getItem(STORAGE_KEY);
            if (savedKey) {
                document.getElementById('api-key').value = savedKey;
                STATE.key = savedKey;
                verifyConnection();
            }
        };

        // --- UTILS ---
        function toggleTheme() {
            const html = document.documentElement;
            if (html.classList.contains('dark')) {
                html.classList.remove('dark');
                localStorage.setItem('tb_theme', 'light');
                STATE.theme = 'light';
            } else {
                html.classList.add('dark');
                localStorage.setItem('tb_theme', 'dark');
                STATE.theme = 'dark';
            }
        }

        function saveAndConnect() {
            const k = document.getElementById('api-key').value.trim();
            const m = document.getElementById('model-select').value;
            if (k.length < 10) return alert("Invalid API Key");
            localStorage.setItem(STORAGE_KEY, k);
            STATE.key = k; STATE.model = m;
            verifyConnection();
        }

        async function verifyConnection() {
            const statusEl = document.getElementById('connection-status');
            document.getElementById('config-panel').classList.add('hidden');
            document.getElementById('ops-panel').classList.remove('hidden');
            try {
                await callGemini("Reply 'ACK'.");
                statusEl.innerHTML = `<span class="w-2 h-2 bg-green-500 rounded-full"></span> Online`;
            } catch (e) {
                document.getElementById('config-panel').classList.remove('hidden');
                document.getElementById('ops-panel').classList.add('hidden');
                alert("Connection Failed: " + e.message);
            }
        }

        function logout() { localStorage.removeItem(STORAGE_KEY); location.reload(); }

        function resetAll() {
            STATE.isRunning = false;
            document.getElementById('console').innerHTML = `<div class="text-center opacity-30 py-20"><div class="mb-3 font-black text-sm tracking-widest">SYSTEM RESET</div></div>`;
            document.getElementById('metrics-grid').classList.add('hidden');
            document.getElementById('target-input').value = '';
            document.getElementById('target-input').focus();
            const btn = document.getElementById('scan-btn');
            btn.disabled = false;
            btn.classList.remove('opacity-50');
        }

        // --- FORMATTING ENGINE ---
        function formatText(text) {
            let html = text.replace(/### (.*)/g, '<h3>$1</h3>');
            
            const lines = html.split('\n');
            let output = '';
            let inList = false;
            let inGrid = false;

            lines.forEach((line, index) => {
                line = line.trim();
                if(!line) {
                    if(inGrid) { output += '</div>'; inGrid = false; }
                    return;
                }

                if(line.startsWith('* ') || line.startsWith('- ')) {
                    if(inGrid) { output += '</div>'; inGrid = false; }
                    if(!inList) { output += '<ul class="styled-list">'; inList = true; }
                    
                    let content = line.substring(2).replace(/\*\*(.*?)\*\*/g, '<span class="highlight-val">$1</span>');
                    output += `<li>${content}</li>`;
                } 
                else if(line.match(/^[A-Za-z0-9\s\(\)]+:\s.+/) && !line.startsWith('<h')) {
                    if(inList) { output += '</ul>'; inList = false; }
                    if(!inGrid) { output += '<div class="border border-slate-200 dark:border-white/10 rounded-lg overflow-hidden my-4 bg-white dark:bg-transparent shadow-sm">'; inGrid = true; }
                    
                    const parts = line.split(':');
                    const k = parts.shift().trim();
                    const v = parts.join(':').trim().replace(/\*\*(.*?)\*\*/g, '<span class="highlight-val">$1</span>');
                    
                    output += `
                        <div class="data-row">
                            <div class="data-key">${k}</div>
                            <div class="data-val">${v}</div>
                        </div>
                    `;
                } 
                else {
                    if(inList) { output += '</ul>'; inList = false; }
                    if(inGrid) { output += '</div>'; inGrid = false; }
                    
                    let content = line.replace(/\*\*(.*?)\*\*/g, '<span class="highlight-val">$1</span>');
                    if(!line.startsWith('<h')) output += `<p class="mb-3 text-slate-700 dark:text-slate-300 leading-relaxed font-medium">${content}</p>`;
                    else output += line;
                }
            });

            if(inList) output += '</ul>';
            if(inGrid) output += '</div>';
            
            return output;
        }

        function addLogEntry(title, content, isTemp = false) {
            const consoleDiv = document.getElementById('console');
            if(consoleDiv.innerHTML.includes('AWAITING ASSIGNMENT')) consoleDiv.innerHTML = '';

            const id = 'log-' + Date.now();
            const time = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const formattedHTML = isTemp ? content : formatText(content);
            
            const opacityClass = isTemp ? 'opacity-50 animate-pulse' : 'opacity-100 animate-in fade-in slide-in-from-bottom-2 duration-500';
            
            // Card styling for entries
            const containerClass = isTemp 
                ? 'border-l-4 border-slate-300 pl-4' 
                : 'bg-white dark:bg-dark-card border border-slate-200 dark:border-white/10 rounded-xl shadow-sm p-6';

            const html = `
                <div id="${id}" class="${opacityClass} mb-6">
                    <div class="${containerClass}">
                        <div class="flex items-baseline justify-between mb-4 pb-2 border-b border-slate-100 dark:border-white/5">
                            <span class="text-xs font-black uppercase tracking-widest text-slate-400 dark:text-slate-500">${title}</span>
                            <span class="text-[10px] font-bold font-mono text-slate-300 dark:text-slate-600">${time}</span>
                        </div>
                        <div class="text-slate-800 dark:text-gray-200">
                            ${formattedHTML}
                        </div>
                        <div id="${id}-actions" class="mt-6 pt-2 border-t border-slate-50 dark:border-white/5 empty:hidden"></div>
                    </div>
                </div>
            `;
            
            const wrapper = document.createElement('div');
            wrapper.innerHTML = html;
            consoleDiv.appendChild(wrapper);
            
            // Auto scroll only if near bottom to allow reading
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
            
            return { div: document.getElementById(id), actions: document.getElementById(`${id}-actions`) };
        }

        function renderMetrics(data) {
            const grid = document.getElementById('metrics-grid');
            grid.classList.remove('hidden', 'opacity-0');
            grid.classList.add('opacity-100');

            grid.innerHTML = `
                <div class="bg-white dark:bg-dark-card border border-slate-200 dark:border-white/20 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Trust Score</div>
                    <div class="text-4xl font-black text-slate-900 dark:text-white">${data.score}</div>
                </div>
                <div class="bg-white dark:bg-dark-card border border-slate-200 dark:border-white/20 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Status</div>
                    <div class="text-sm font-bold truncate text-slate-900 dark:text-white">${data.status}</div>
                </div>
                <div class="bg-white dark:bg-dark-card border border-slate-200 dark:border-white/20 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Founded</div>
                    <div class="text-sm font-mono font-bold text-slate-900 dark:text-white">${data.start_date}</div>
                </div>
                <div class="bg-white dark:bg-dark-card border border-slate-200 dark:border-white/20 p-5 rounded-xl shadow-sm hover:shadow-md transition-shadow">
                    <div class="text-[10px] uppercase text-slate-400 font-bold tracking-wider mb-1">Location</div>
                    <div class="text-sm truncate font-bold text-slate-900 dark:text-white" title="${data.location}">${data.location}</div>
                </div>
            `;
        }

        // --- AUTO-SEQUENCE ENGINE ---

        async function runScan() {
            const target = document.getElementById('target-input').value.trim();
            if(!target) return;
            STATE.target = target;
            STATE.isRunning = true;

            const btn = document.getElementById('scan-btn');
            btn.disabled = true;
            btn.classList.add('opacity-50');

            document.getElementById('console').innerHTML = '';
            document.getElementById('metrics-grid').classList.add('hidden');

            addLogEntry("SYSTEM", `Initializing Dossier Sequence: <span class="highlight-val">${target.toUpperCase()}</span>...`);
            
            const prompt = `
                Investigate "${target}" using Google Search.
                CRITICAL: You MUST find the exact **Incorporation Date**, **Founding Date**, or **Start Date**.
                Find: Legal Name, HQ Location, Operational Status, and Trust Score (0-100).
                
                Output strictly Valid JSON:
                { "name": "Legal Name", "location": "City, State", "status": "Active/Defunct", "start_date": "YYYY-MM-DD", "score": 0-100, "summary": "2 sentence summary." }
            `;

            try {
                const raw = await callGemini(prompt);
                const data = JSON.parse(extractJSON(raw));
                
                renderMetrics(data);
                
                const summaryText = `**Subject:** ${data.name}\n**Summary:** ${data.summary}`;
                const logObj = addLogEntry("BASE DOSSIER", summaryText);
                appendControls(logObj.actions, 'BASE');

                if(STATE.isRunning) await triggerAutoSequence('REGISTRY');

            } catch (e) {
                addLogEntry("ERROR", `JSON Parse Failed: ${e.message}`);
                btn.disabled = false;
                btn.classList.remove('opacity-50');
            }
        }

        async function triggerAutoSequence(type) {
            if(!STATE.isRunning) return;
            
            const tempLog = addLogEntry("SYSTEM", `Running **${type}** intelligence module...`, true);
            
            // Force scroll to bottom
            const c = document.getElementById('console');
            c.scrollTop = c.scrollHeight;

            let prompt = "";
            switch(type) {
                case 'REGISTRY': prompt = `Perform a deep search for "${STATE.target}" in Secretary of State registries. 
                Find the exact **Entity Formation Date** (or Incorporation Date), **Entity ID**, **Registered Agent**, and **State of Formation**.
                Format results as Key: Value pairs.`; break;
                
                case 'LEGAL': prompt = `Search "${STATE.target}" litigation and dockets. Return a list of cases. Use **bold** for Case Numbers.`; break;
                case 'REVIEWS': prompt = `Search "${STATE.target}" reviews (BBB, Trustpilot, Reddit). Summarize sentiment. Use **bold** for ratings.`; break;
                case 'UCC': prompt = `Search "${STATE.target}" UCC filings, tax liens, and judgments. Return list. Use **bold** for amounts.`; break;
            }

            try {
                const raw = await callGemini(prompt);
                tempLog.div.remove();

                const logObj = addLogEntry(`${type} REPORT`, raw);
                appendControls(logObj.actions, type);

                const nextStep = WORKFLOW[type];
                if(nextStep) {
                    await new Promise(r => setTimeout(r, 1500)); 
                    await triggerAutoSequence(nextStep);
                } else {
                    addLogEntry("SYSTEM", "**DOSSIER COMPLETE.** All intelligence modules executed successfully.");
                    const btn = document.getElementById('scan-btn');
                    btn.disabled = false;
                    btn.classList.remove('opacity-50');
                    STATE.isRunning = false;
                }
            } catch(e) {
                tempLog.div.remove();
                addLogEntry("ERROR", `Module ${type} failed: ${e.message}`);
            }
        }

        // --- INTERACTION ---

        async function runReScan(type) {
            addLogEntry("SYSTEM", `Re-running **${type}** module manual override...`);
            let prompt = `Re-investigate "${STATE.target}" specifically for **${type}** data. Provide updated detailed findings as Key: Value pairs or bullet points. Use **bold** for facts.`;
            try {
                const raw = await callGemini(prompt);
                const logObj = addLogEntry(`${type} UPDATE`, raw);
                appendControls(logObj.actions, type);
            } catch(e) {
                addLogEntry("ERROR", e.message);
            }
        }

        async function runFollowUp(btn) {
            const input = btn.previousElementSibling;
            const q = input.value.trim();
            if(!q) return;
            input.value = ''; 

            addLogEntry("USER QUERY", q);
            
            try {
                const prompt = `Context: Investigation of "${STATE.target}". Question: "${q}". Answer concisely with **bold** facts.`;
                const raw = await callGemini(prompt);
                addLogEntry("ANALYSIS", raw);
            } catch(e) {
                addLogEntry("ERROR", "Could not answer query.");
            }
        }

        function appendControls(container, currentType) {
            const div = document.createElement('div');
            div.className = 'flex flex-col gap-3';

            const html = `
                <div class="flex gap-3">
                    <button onclick="runReScan('${currentType}')" class="px-4 py-2 rounded-lg border border-slate-200 dark:border-white/20 text-xs font-bold hover:bg-slate-50 dark:hover:bg-white/10 transition-colors uppercase text-slate-600 dark:text-slate-300">
                        ↺ Re-Run
                    </button>
                    <input type="text" placeholder="Ask about this section..." 
                        onkeydown="if(event.key==='Enter') this.nextElementSibling.click()"
                        class="flex-1 bg-slate-50 dark:bg-black border border-slate-200 dark:border-white/20 rounded-lg px-4 py-2 text-xs focus:border-black dark:focus:border-white outline-none font-medium text-slate-900 dark:text-white">
                    <button onclick="runFollowUp(this)" class="px-5 py-2 bg-slate-900 dark:bg-white text-white dark:text-black rounded-lg text-xs font-bold hover:opacity-90 transition-colors">ASK</button>
                </div>
            `;

            div.innerHTML = html;
            container.appendChild(div);
        }

        // --- API ---
        async function callGemini(text) {
            let model = STATE.model;
            let url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${STATE.key}`;
            let response = await makeReq(url, text);
            if(response.status === 404) {
                console.warn("Model not found, falling back to 1.5-flash");
                url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${STATE.key}`;
                response = await makeReq(url, text);
            }
            if(!response.ok) {
                const err = await response.json();
                throw new Error(err.error?.message || "API Error");
            }
            const json = await response.json();
            const content = json.candidates?.[0]?.content?.parts?.[0]?.text;
            if(!content) throw new Error("No data returned.");
            return content;
        }

        function makeReq(url, text) {
            return fetch(url, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text }] }], tools: [{ google_search: {} }] })
            });
        }

        function extractJSON(str) {
            let clean = str.replace(/```json/g, '').replace(/```/g, '').trim();
            const first = clean.indexOf('{');
            const last = clean.lastIndexOf('}');
            if (first !== -1 && last !== -1) return clean.substring(first, last + 1);
            return clean;
        }
    </script>
</body>
</html>
