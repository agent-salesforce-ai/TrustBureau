<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Trust Bureau - Forensic Report</title>
  <meta name="theme-color" content="#F8FAFC">

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <!-- Added weight 900 (Black) to Plus Jakarta Sans for the heavy logo text -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Plus+Jakarta+Sans:wght@500;600;700;800;900&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">

  <!-- Tailwind Config -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            heading: ['Plus Jakarta Sans', 'sans-serif'],
            sans: ['Inter', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace'],
          },
          colors: {
            'brand-yellow': '#FACC15',
            'brand-dark': '#0F172A',
            'brand-gray': '#64748B',
            'brand-bg': '#F8FAFC',
            'brand-border': '#E2E8F0',
          },
          backgroundImage: {
            'grid-pattern': "radial-gradient(#E2E8F0 1px, transparent 1px)",
          },
          backgroundSize: {
            'grid-pattern': '24px 24px',
          }
        },
      },
    };
  </script>

  <style>
    /* UTILS */
    :root { --tb-yellow: #FACC15; }
    body { background-color: #F8FAFC; color: #0F172A; }
    .forensic-table { width: 100%; border-collapse: collapse; font-size: 0.75rem; }
    .forensic-table th { text-align: left; padding: 10px 12px; background: #F8FAFC; color: #64748B; font-weight: 700; text-transform: uppercase; font-size: 0.65rem; letter-spacing: 0.05em; border-bottom: 1px solid #E2E8F0; white-space: nowrap; }
    .forensic-table td { padding: 10px 12px; border-bottom: 1px solid #F1F5F9; vertical-align: top; }
    .forensic-table tr:last-child td { border-bottom: none; }
    
    /* GAUGE */
    .risk-gauge {
      width: 140px; height: 140px; border-radius: 50%; display: flex;
      flex-direction: column; align-items: center; justify-content: center;
      border: 8px solid #E2E8F0; font-family: 'Plus Jakarta Sans'; 
      background: #fff; transition: all 1s ease;
    }
    .risk-high { border-color: #EF4444; background-color: #FEF2F2; color: #B91C1C; }
    .risk-med  { border-color: #FACC15; background-color: #FEFCE8; color: #854D0E; }
    .risk-low  { border-color: #22C55E; background-color: #F0FDF4; color: #15803D; }

    /* CHARTS */
    .chart-container { height: 100px; display: flex; align-items: flex-end; gap: 4px; }
    .bar { flex: 1; background: #E2E8F0; border-radius: 2px 2px 0 0; position: relative; min-height: 2px; transition: height 1s ease; }
    .bar:hover { background: #FACC15; }

    /* LOADER */
    .scan-line { width: 100%; height: 2px; background: linear-gradient(90deg, transparent, #FACC15, transparent); animation: scan 1.5s linear infinite; }
    @keyframes scan { 0% { transform: translateX(-100%); } 100% { transform: translateX(100%); } }
    
    /* ENHANCE BTN - YELLOW THEME */
    .enhance-btn {
        font-size: 0.65rem;
        text-transform: uppercase;
        font-weight: 800;
        letter-spacing: 0.05em;
        color: #854D0E; /* yellow-900ish */
        border: 1px solid #FDE047; /* yellow-300 */
        background: #FEFCE8; /* yellow-50 */
        padding: 4px 8px;
        border-radius: 4px;
        display: flex;
        align-items: center;
        gap: 4px;
        transition: all 0.2s;
        white-space: nowrap;
    }
    .enhance-btn:hover:not(:disabled) {
        color: #0F172A; /* brand-dark */
        border-color: #FACC15; /* brand-yellow */
        background: #FACC15; /* brand-yellow */
        cursor: pointer;
        box-shadow: 0 2px 4px rgba(250, 204, 21, 0.2);
    }
    .enhance-btn:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        filter: grayscale(100%);
    }
    .enhance-btn svg {
        color: #EAB308; /* yellow-600 */
    }
    .enhance-btn:hover svg {
        color: #0F172A;
    }

    /* LINKS */
    a.data-link {
        color: #2563EB;
        text-decoration: none;
        border-bottom: 1px dotted #2563EB;
        transition: all 0.2s;
        word-break: break-all; /* Prevent long URLs from breaking layout */
    }
    a.data-link:hover {
        color: #1E40AF;
        background-color: #EFF6FF;
        border-bottom: 1px solid #1E40AF;
    }
    
    /* SECTION OVERLAY */
    .section-loading {
        position: absolute;
        inset: 0;
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(4px);
        z-index: 20;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        border-radius: 0.75rem;
        transition: opacity 0.3s ease;
    }

    /* SEARCH BACKGROUND */
    .hero-bg {
        background-image: radial-gradient(#cbd5e1 1px, transparent 1px);
        background-size: 32px 32px;
    }
  </style>
</head>

<body>
<div id="app" class="min-h-screen flex flex-col">

  <!-- Header -->
  <header class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-brand-border shadow-sm">
    <div class="max-w-7xl mx-auto px-4 md:px-6 py-3 md:py-4 flex items-center justify-between">
      <div class="flex items-center gap-3 cursor-pointer" onclick="location.reload()">
        <!-- Updated "T" Box Logo -->
        <div class="w-8 h-8 md:w-10 md:h-10 bg-black rounded-lg flex items-center justify-center flex-shrink-0 shadow-sm">
          <span class="text-white font-heading font-bold text-lg md:text-2xl">T</span>
        </div>
        
        <div>
          <!-- Updated Header Text: Matches Image (TRUST BUREAU) with Heavy Weight -->
          <h1 class="font-heading font-black text-xl md:text-2xl text-brand-dark tracking-tight uppercase leading-none">TRUST BUREAU</h1>
          <p class="text-[8px] text-brand-gray uppercase tracking-wider font-bold hidden sm:block mt-0.5">Data Aggregator v5.12</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
          <button id="settings-btn" class="text-brand-gray hover:text-brand-dark p-2 rounded-full hover:bg-gray-100 transition-colors" title="API Settings">
              <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          </button>
          <div class="text-[10px] md:text-xs font-bold uppercase tracking-wide text-green-600 bg-green-50 border border-green-200 rounded px-2 py-1 md:px-3 md:py-2">
            ‚óè Active
          </div>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="flex-grow bg-brand-bg hero-bg relative">
    <!-- Optional overlay gradient to soften the grid edges -->
    <div class="absolute inset-0 bg-gradient-to-b from-transparent via-brand-bg/50 to-brand-bg pointer-events-none"></div>
    
    <!-- SEARCH HERO -->
    <div id="search-view" class="relative z-10 py-20 md:py-32 px-4 md:px-6 text-center max-w-4xl mx-auto transition-all duration-300 flex flex-col items-center justify-center min-h-[60vh]">
      
      <div class="inline-flex items-center gap-2 bg-white border border-brand-border px-3 py-1.5 rounded-full text-xs font-semibold text-brand-gray mb-8 shadow-sm">
        <span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span>
        Live Data Aggregation System
      </div>

      <h2 class="text-4xl md:text-6xl font-heading font-bold text-brand-dark mb-6 leading-tight tracking-tight">
        Verify Any Business. <br class="hidden md:block"/> <span class="text-brand-gray">Instantly.</span>
      </h2>
      
      <p class="text-lg text-brand-gray mb-12 leading-relaxed max-w-2xl font-light">
        Forensic-grade aggregation of Secretary of State filings, court dockets, BBB profiles, and corporate compliance records.
      </p>
      
      <div class="relative w-full max-w-2xl mx-auto group">
        <!-- Grey shadow search bar -->
        <div class="relative flex flex-col sm:flex-row bg-white rounded-xl shadow-xl shadow-gray-200 border border-gray-100 overflow-hidden p-1">
          <div class="flex-grow relative flex items-center">
             <svg class="w-5 h-5 text-gray-400 absolute left-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
             <input type="text" id="search-input" class="w-full pl-12 pr-4 py-4 text-base md:text-lg text-brand-dark outline-none placeholder-gray-400 bg-transparent font-medium" placeholder="Enter entity name (e.g., Tesla, Inc.)">
          </div>
          <button id="generate-btn" class="mt-1 sm:mt-0 bg-brand-dark text-white font-bold text-sm uppercase tracking-wide px-8 py-4 rounded-lg hover:bg-gray-800 transition-all transform hover:scale-[1.02] active:scale-95 sm:ml-1 shadow-lg">
            Start Audit
          </button>
        </div>
      </div>
      
      <!-- Quick Suggestions -->
      <div class="mt-10 flex justify-center gap-3 flex-wrap opacity-80">
         <span class="text-xs font-bold text-gray-400 uppercase tracking-wide pt-1.5">Try:</span>
         <button onclick="window.runSearch('OpenAI')" class="text-xs font-medium text-gray-600 bg-white border border-gray-200 hover:border-brand-yellow hover:text-brand-dark px-4 py-1.5 rounded-full transition-all cursor-pointer shadow-sm">OpenAI</button>
         <button onclick="window.runSearch('SpaceX')" class="text-xs font-medium text-gray-600 bg-white border border-gray-200 hover:border-brand-yellow hover:text-brand-dark px-4 py-1.5 rounded-full transition-all cursor-pointer shadow-sm">SpaceX</button>
         <button onclick="window.runSearch('Anthropic')" class="text-xs font-medium text-gray-600 bg-white border border-gray-200 hover:border-brand-yellow hover:text-brand-dark px-4 py-1.5 rounded-full transition-all cursor-pointer shadow-sm">Anthropic</button>
      </div>
    </div>

    <!-- LOADER -->
    <div id="loader-view" class="hidden py-32 text-center px-6 relative z-20">
      <div class="max-w-md mx-auto bg-white rounded-xl shadow-2xl border border-brand-border overflow-hidden p-10">
        <div class="relative w-16 h-16 mx-auto mb-6">
            <div class="absolute inset-0 border-4 border-brand-bg rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-brand-yellow rounded-full animate-spin"></div>
        </div>
        <h3 class="text-xl font-bold text-brand-dark mb-2">Initializing Forensic Scan</h3>
        <p id="loader-step" class="text-sm text-brand-gray font-mono mb-6">Connecting to secure databases...</p>
        <div class="h-1 w-full bg-gray-100 overflow-hidden rounded-full">
          <div class="scan-line"></div>
        </div>
      </div>
    </div>

    <!-- REPORT VIEW -->
    <div id="report-view" class="hidden max-w-7xl mx-auto px-4 md:px-6 py-8 md:py-12 space-y-8 relative z-20">
      
      <!-- 1. HEADER & SCORE -->
      <div class="bg-white border border-brand-border rounded-2xl p-4 md:p-8 shadow-sm relative overflow-hidden">
        <div class="flex flex-col lg:flex-row justify-between items-start gap-6 md:gap-8">
          <div class="flex-grow w-full">
            <div class="flex flex-wrap items-center gap-3 mb-2">
              <h1 id="h-name" class="text-2xl md:text-4xl font-heading font-extrabold text-brand-dark break-words">--</h1>
              <span id="sos-badge" class="text-[10px] bg-gray-100 text-gray-500 px-2 py-1 rounded font-bold uppercase tracking-wider border border-gray-200 whitespace-nowrap">Verifying...</span>
              <span id="h-founded" class="text-xs font-mono text-gray-500 border-l pl-3 border-gray-300 hidden"></span>
            </div>
            <div class="flex flex-wrap gap-4 md:gap-6 text-sm text-brand-gray mb-6">
              <span class="flex items-center gap-1.5"><span class="text-brand-yellow">üìç</span> <span id="h-loc" class="break-all">--</span></span>
              <span class="flex items-center gap-1.5"><span class="text-brand-yellow">üåê</span> <a id="h-web" href="#" target="_blank" class="data-link break-all">--</a></span>
              <span class="flex items-center gap-1.5"><span class="text-brand-yellow">üìû</span> <span id="h-phone">--</span></span>
            </div>
            <div class="bg-gray-50 border-l-4 border-brand-yellow pl-4 py-3 pr-4 rounded-r-lg">
              <h4 class="text-[10px] font-bold uppercase text-gray-400 mb-1">Risk Analysis</h4>
              <p id="h-memo" class="text-sm leading-relaxed text-gray-700 italic"></p>
            </div>
          </div>

          <div class="flex-shrink-0 flex flex-col items-center w-full lg:w-auto">
            <button id="reverify-btn" class="mb-4 text-xs font-bold text-green-700 hover:text-green-900 border border-green-200 hover:border-green-400 bg-green-50 px-4 py-2 rounded-full shadow-sm transition-all flex items-center gap-2 group">
              <svg class="w-3 h-3 text-green-600 group-hover:text-green-800 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              Run Full Audit
            </button>
            <div id="g-circle" class="risk-gauge mb-3">
              <span id="g-score" class="text-4xl font-extrabold">--</span>
              <span class="text-[10px] font-bold uppercase tracking-wide mt-1 text-gray-400">Risk Score</span>
            </div>
            <div id="g-badge" class="px-5 py-1.5 rounded-full text-xs font-extrabold uppercase tracking-wide text-white bg-gray-400 shadow-sm">
              Pending
            </div>
          </div>
        </div>
      </div>

      <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
        
        <!-- LEFT COLUMN (8) -->
        <div class="lg:col-span-8 space-y-8">
          
          <!-- 2. CORPORATE REGISTRY -->
          <div id="sec-sos" class="relative bg-white border border-brand-border rounded-xl shadow-sm overflow-hidden transition-all">
            <div class="bg-gray-50 px-4 md:px-6 py-3 border-b border-brand-border flex justify-between items-center">
              <h3 class="font-bold text-brand-dark text-sm uppercase tracking-wider">Official Corporate Filings</h3>
              <button class="enhance-btn" data-section="sos">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                ENHANCE
              </button>
            </div>
            <div class="p-4 md:p-6 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
              <div class="col-span-1 sm:col-span-2">
                <label class="text-[10px] text-gray-400 uppercase font-bold">Legal Entity Name</label>
                <div id="c-name" class="font-mono text-sm text-brand-dark font-semibold mt-1 break-words">--</div>
              </div>
              <div class="col-span-1 sm:col-span-2">
                <label class="text-[10px] text-gray-400 uppercase font-bold">Entity / File ID</label>
                <div id="c-id" class="font-mono text-sm text-brand-dark mt-1 bg-gray-50 inline-block px-2 py-0.5 rounded border border-gray-200 break-all">--</div>
              </div>
              <div>
                <label class="text-[10px] text-gray-400 uppercase font-bold">Jurisdiction</label>
                <div id="c-state" class="text-sm text-brand-dark mt-1">--</div>
              </div>
              <div>
                <label class="text-[10px] text-gray-400 uppercase font-bold">Date Founded</label>
                <div id="c-date" class="text-sm text-brand-dark mt-1">--</div>
              </div>
              <div class="col-span-1 sm:col-span-2">
                <label class="text-[10px] text-gray-400 uppercase font-bold">Registered Agent</label>
                <div id="c-agent" class="text-sm text-brand-dark mt-1 break-words">--</div>
              </div>
            </div>
          </div>

          <!-- 3. CONSUMER PROTECTION (BBB) - NEW -->
          <div id="sec-reputation" class="relative bg-white border border-brand-border rounded-xl shadow-sm overflow-hidden transition-all">
            <div class="bg-gray-50 px-4 md:px-6 py-3 border-b border-brand-border flex justify-between items-center">
               <h3 class="font-bold text-brand-dark text-sm uppercase tracking-wider">Consumer Protection &amp; BBB</h3>
               <button class="enhance-btn" data-section="reputation">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                ENHANCE
               </button>
            </div>
            <div class="p-4 md:p-6 grid grid-cols-1 sm:grid-cols-3 gap-6 border-b border-brand-border">
               <!-- Grade -->
               <div class="text-center border-b sm:border-b-0 sm:border-r border-gray-100 pb-4 sm:pb-0 last:border-0">
                  <span class="text-[10px] text-gray-400 uppercase font-bold">BBB Grade</span>
                  <div id="bbb-grade" class="text-3xl font-extrabold text-brand-dark mt-1">--</div>
               </div>
               <!-- Accreditation -->
               <div class="text-center border-b sm:border-b-0 sm:border-r border-gray-100 pb-4 sm:pb-0 last:border-0">
                  <span class="text-[10px] text-gray-400 uppercase font-bold">Status</span>
                  <div id="bbb-status" class="text-sm font-bold text-brand-dark mt-2">Checking...</div>
               </div>
               <!-- Complaints -->
               <div class="text-center">
                  <span class="text-[10px] text-gray-400 uppercase font-bold">Complaints (3 Yrs)</span>
                  <div id="bbb-complaints" class="text-xs font-semibold text-brand-dark mt-1 leading-tight px-1">--</div>
               </div>
            </div>
            <div class="p-4 bg-gray-50">
               <h5 class="text-[10px] text-gray-400 uppercase font-bold mb-2">BBB Analysis</h5>
               <p id="bbb-summary" class="text-xs text-gray-600 italic">Connecting to Better Business Bureau database...</p>
            </div>
          </div>

          <!-- 4. LITIGATION & UCC -->
          <div id="sec-litigation" class="relative bg-white border border-brand-border rounded-xl shadow-sm overflow-hidden transition-all">
             <div class="bg-gray-50 px-4 md:px-6 py-3 border-b border-brand-border flex justify-between items-center">
               <h3 class="font-bold text-brand-dark text-sm uppercase tracking-wider">Legal &amp; Collateral</h3>
               <button class="enhance-btn" data-section="litigation">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                ENHANCE
               </button>
             </div>
             
             <!-- Litigation Table -->
             <div class="px-4 py-2 bg-gray-50 border-b border-gray-200 text-xs font-bold text-gray-500 uppercase">Litigation History</div>
             <div class="overflow-x-auto">
               <table class="forensic-table">
                 <thead><tr><th>Type</th><th>Case ID</th><th>Plaintiff / Parties</th><th>Date</th><th>Status</th></tr></thead>
                 <tbody id="legal-rows"></tbody>
               </table>
             </div>
             <div id="legal-empty" class="p-3 text-center text-xs text-gray-400 italic hidden">No adverse court records found.</div>

             <!-- UCC Table -->
             <div class="px-4 py-2 bg-gray-50 border-y border-gray-200 text-xs font-bold text-gray-500 uppercase">UCC Filings</div>
             <div class="overflow-x-auto">
               <table class="forensic-table">
                 <thead><tr><th>Filing Date</th><th>Filing #</th><th>Secured Party (Lender)</th><th>Status</th></tr></thead>
                 <tbody id="ucc-rows"></tbody>
               </table>
             </div>
             <div id="ucc-empty" class="p-3 text-center text-xs text-gray-400 italic hidden">No UCC-1 records found.</div>
          </div>

        </div>

        <!-- RIGHT COLUMN (4) -->
        <div class="lg:col-span-4 space-y-8">
          
          <!-- 5. REVIEWS FEED (NEW) -->
          <div id="sec-reviews" class="relative bg-white border border-brand-border rounded-xl shadow-sm overflow-hidden transition-all">
            <div class="bg-gray-50 px-4 md:px-6 py-3 border-b border-brand-border flex justify-between items-center">
               <h3 class="font-bold text-brand-dark text-sm uppercase tracking-wider">Voice of Customer</h3>
               <button class="enhance-btn" data-section="reviews">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                ENHANCE
               </button>
            </div>
            <div id="reviews-list" class="divide-y divide-gray-100 max-h-[400px] overflow-y-auto"></div>
          </div>

          <!-- 7. COMPLIANCE -->
          <div id="sec-compliance" class="relative bg-white border border-brand-border rounded-xl shadow-sm p-4 md:p-6 transition-all">
            <div class="flex justify-between items-center mb-4">
              <h4 class="font-bold text-brand-dark text-sm uppercase tracking-wider">Compliance</h4>
              <button class="enhance-btn" data-section="compliance">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                ENHANCE
              </button>
            </div>
            <ul class="space-y-3 text-sm">
              <li class="flex justify-between items-center"><span class="text-gray-500">OFAC / Sanctions</span><span id="reg-ofac" class="text-xs font-bold px-2 py-1 rounded bg-gray-100">Checking...</span></li>
              <li class="flex justify-between items-center"><span class="text-gray-500">Gov Contracts</span><span id="reg-gov" class="text-xs font-bold px-2 py-1 rounded bg-gray-100">Checking...</span></li>
            </ul>
          </div>

        </div>
      </div>

      <!-- 8. EVIDENCE LOCKER (LINKS) -->
      <div class="bg-white border border-brand-border rounded-xl p-4 md:p-8 shadow-sm mt-12">
        <h3 class="text-brand-dark font-heading font-bold text-lg mb-4 flex items-center gap-2">
           <svg class="w-5 h-5 text-brand-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"/></svg>
           Evidence Locker & Verified Sources
        </h3>
        <div id="source-links" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 text-xs font-mono"></div>
      </div>
      
      <!-- NEW: AI ANALYST Q&A (MOVED TO BOTTOM) -->
      <div id="sec-qa" class="bg-white border border-brand-border rounded-xl p-8 shadow-sm mt-8">
         <h3 class="font-bold text-brand-dark font-heading text-lg mb-4 flex items-center gap-2">
            <svg class="w-5 h-5 text-brand-yellow" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"></path></svg>
            Ask the Forensic Analyst
         </h3>
         <div class="relative max-w-3xl">
           <input type="text" id="qa-input" class="w-full bg-gray-50 border border-gray-200 rounded-lg px-4 py-3 pr-20 text-sm focus:outline-none focus:border-brand-yellow text-brand-dark placeholder-gray-400 transition-colors" placeholder="E.g., Is this a shell company?">
           <button id="qa-btn" class="absolute right-1.5 top-1.5 bg-brand-dark text-white text-xs font-bold px-4 py-2 rounded hover:bg-gray-800 transition-colors">ASK</button>
         </div>
         <div id="qa-response" class="mt-6 text-sm leading-relaxed text-brand-gray hidden p-4 bg-gray-50 rounded-lg border border-gray-100"></div>
      </div>

    </div>
  </main>
</div>

<!-- Settings Modal -->
<div id="api-modal" class="fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm hidden flex items-center justify-center">
  <div class="bg-white rounded-xl p-6 w-full max-w-md mx-4 shadow-2xl">
    <div class="flex justify-between items-center mb-4">
        <h3 class="font-bold text-lg text-brand-dark">API Configuration</h3>
        <button id="close-api-btn" class="text-gray-400 hover:text-gray-600">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
        </button>
    </div>
    <p class="text-xs text-gray-500 mb-4">Enter Google Gemini API Key (overrides environment key).</p>
    <input id="api-key-input" type="password" class="w-full border border-gray-300 rounded-lg px-4 py-3 mb-4 focus:ring-2 focus:ring-brand-yellow outline-none text-sm" placeholder="AIza...">
    <div class="flex justify-end gap-3">
      <button id="clear-key" class="px-4 py-2 text-red-500 hover:bg-red-50 rounded text-sm font-bold">Clear</button>
      <button id="save-key" class="px-6 py-2 bg-brand-dark text-white rounded hover:bg-gray-800 text-sm font-bold">Save Key</button>
    </div>
  </div>
</div>

<script>
// Define global functions for quick actions
window.runSearch = (name) => {
  document.getElementById('search-input').value = name;
  document.getElementById('generate-btn').click();
}

document.addEventListener('DOMContentLoaded', () => {
  const envApiKey = ""; // Runtime injection
  
  // Global state within module
  let lastReportData = null; 

  // Settings Elements
  const settingsBtn = document.getElementById('settings-btn');
  const apiModal = document.getElementById('api-modal');
  const closeApiBtn = document.getElementById('close-api-btn');
  const saveKeyBtn = document.getElementById('save-key');
  const clearKeyBtn = document.getElementById('clear-key');
  const apiKeyInput = document.getElementById('api-key-input');

  // Get API Key (User > Env)
  const getApiKey = () => localStorage.getItem('tb_api_key') || envApiKey;

  // Settings UI Logic
  if(settingsBtn) {
      settingsBtn.onclick = () => {
          apiKeyInput.value = localStorage.getItem('tb_api_key') || '';
          apiModal.classList.remove('hidden');
      };
  }
  
  const closeSettings = () => apiModal.classList.add('hidden');
  if(closeApiBtn) closeApiBtn.onclick = closeSettings;
  
  if(saveKeyBtn) {
      saveKeyBtn.onclick = () => {
          const key = apiKeyInput.value.trim();
          if(key) {
              localStorage.setItem('tb_api_key', key);
              alert("API Key saved locally.");
          }
          closeSettings();
      };
  }

  if(clearKeyBtn) {
      clearKeyBtn.onclick = () => {
          localStorage.removeItem('tb_api_key');
          apiKeyInput.value = '';
          alert("API Key cleared.");
      };
  }

  const refs = {
    viewSearch: document.getElementById('search-view'),
    viewLoader: document.getElementById('loader-view'),
    viewReport: document.getElementById('report-view'),
    input: document.getElementById('search-input'),
    btn: document.getElementById('generate-btn'),
    reverify: document.getElementById('reverify-btn'),
    qaInput: document.getElementById('qa-input'),
    qaBtn: document.getElementById('qa-btn'),
    qaResponse: document.getElementById('qa-response'),
  };

  // --- HELPER: CREATE CLICKABLE LINK IF URL EXISTS ---
  const makeLink = (text, url, className = "font-bold text-brand-dark") => {
      if (url && url.startsWith('http') && text && text !== '--') {
          return `<a href="${url}" target="_blank" class="${className} underline decoration-dotted hover:text-blue-600 hover:decoration-solid transition-colors" title="View Source">${text}</a> ‚Üó`;
      }
      return `<span class="${className}">${text || '--'}</span>`;
  };

  // --- Q&A LOGIC ---
  const handleQa = async () => {
      const question = refs.qaInput.value.trim();
      const currentKey = getApiKey();
      
      if (!question) return;
      if (!lastReportData) {
          alert("Please run a report first.");
          return;
      }
      
      const originalText = refs.qaBtn.innerText;
      refs.qaBtn.innerText = "...";
      refs.qaBtn.disabled = true;
      
      try {
          // Special prompt for Q&A
          const qaPrompt = `
            ROLE: Senior Forensic Auditor.
            CONTEXT: You have just generated a report for "${lastReportData.info.name}".
            REPORT DATA: ${JSON.stringify(lastReportData)}
            
            USER QUESTION: "${question}"
            
            TASK: Answer the question based strictly on the report data and your forensic expertise. 
            If the data is missing, state that clearly. Be professional, concise, and objective.
            
            OUTPUT: Plain text answer (max 3 sentences). No markdown.
          `;
          
          const resp = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${currentKey}`, {
             method: 'POST', 
             headers: {'Content-Type':'application/json'},
             body: JSON.stringify({
               contents: [{parts:[{text: qaPrompt}]}]
             })
          });
          
          const raw = await resp.json();
          const answer = raw.candidates?.[0]?.content?.parts?.[0]?.text || "Unable to generate an answer.";
          
          refs.qaResponse.innerText = answer;
          refs.qaResponse.classList.remove('hidden');
          
      } catch (e) {
          console.error(e);
          refs.qaResponse.innerText = "Error: " + e.message;
          refs.qaResponse.classList.remove('hidden');
      } finally {
          refs.qaBtn.innerText = originalText;
          refs.qaBtn.disabled = false;
      }
  };
  
  refs.qaBtn.onclick = handleQa;
  refs.qaInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') handleQa();
  });

  // --- PROMPT ENGINEERING ---
  const getPrompt = (name, isEnhanced, existingData, focusSection) => {
    
    let context = '';
    let taskDescription = '';
    let mandate = '';

    if (isEnhanced) {
        if (existingData) {
            // RE-VERIFICATION or DEEP DIVE
            taskDescription = `ROLE: FORENSIC DATA AUDITOR. OBJECTIVE: Verify and Expand Report.`;
            let specificInstruction = "";
            
            if (focusSection) {
                specificInstruction = `
                FOCUS: DEEP DIVE into "${focusSection}".
                MANDATE: Find URLS for this specific section.
                - If 'sos': Return url to Secretary of State entity page or search portal. VERIFY the "Formation Date" or "Start Date".
                - If 'reputation': Return url to BBB profile, Trustpilot, or general search results.
                - If 'litigation': Return url to court docket, legal news source, or case summary.
                `;
            } else {
                 specificInstruction = `
                 FOCUS: Global Update. Find missing URLS and DATA for all fields.
                 CRITICAL: Ensure "date" in "sos" is populated with a Year or Full Date.
                 `;
            }
            
            context += `
            EXISTING DATA:
            ${JSON.stringify(existingData)}
            
            INSTRUCTIONS:
            ${specificInstruction}
            1. PRESERVE valid data.
            2. FILL missing URLs (use search portal links if deep links fail).
            3. MERGE into complete JSON.
            `;
        } else {
            // INITIAL SEARCH - AGGRESSIVE - V5.3 UPDATE
            taskDescription = `ROLE: ELITE FORENSIC INVESTIGATOR. OBJECTIVE: Build a COMPLETE dossier on "${name}".`;
            
            mandate = `
            EXECUTE THE FOLLOWING SEARCH PLAN BEFORE GENERATING JSON:
            
            1. **CRITICAL: BUSINESS START DATE VERIFICATION:**
               - You MUST find the "Formation Date", "Incorporation Date", or "Founded Year".
               - **CROSS-REFERENCE:** Do not rely solely on the first SOS result if it looks too old (e.g., 2005). Check the company's **LinkedIn "Founded" date** or Website "About Us" to match the *current* operational entity.
               - If there is a discrepancy (e.g., SOS says 2005 but Website says 2017), prefer the date that matches the *current* active business operations.
               - **DO NOT RETURN NULL.** Estimate the year (e.g., "Est. 2017") if exact date is hidden.

            2. **LITIGATION SWEEP:**
               - Search for: "${name} lawsuit", "${name} v.", "${name} court docket", "${name} class action", "${name} settlement", "${name} complaint".
               - **REQUIREMENT:** You MUST populate the 'litigation' array. If no specific case is found, find a relevant legal news article or a search result page from a legal database (Justia, PacerMonitor, etc.) and use that as the URL. Do NOT return an empty array unless you are 100% certain no record exists anywhere.
               
            3. **REPUTATION & REVIEWS:**
               - Search for: "${name} reviews", "${name} complaints", "BBB ${name}", "Trustpilot ${name}", "Glassdoor ${name}", "Reddit ${name} scam".
               - **REQUIREMENT:** You MUST find at least 3 distinct reviews or ratings. If specific reviews are hidden, summarize the general sentiment found in search snippets. Populate the 'reviews' array with at least 3 items.
               
            4. **DATA COMPLETENESS:**
               - **URLS:** Every major finding (SOS, BBB, Lawsuit) MUST have a 'url' field. If a direct link to the document is impossible, provide the URL of the search result page or the main portal where the info was found.
            `;
            
            context = `
            MODE: INITIAL AGGREGATION (AGGRESSIVE).
            ${mandate}
            `;
        }
    }

    return `
    ${taskDescription}
    Target Entity: "${name}".
    ${context}
    
    REQUIRED OUTPUT FORMAT (JSON ONLY):
    {
      "meta": { "memo": "Brief risk summary.", "trustScore": 0-1000, "status": "Active/Inactive" },
      "info": { "name": "string", "address": "string", "website": "string", "phone": "string", "location": "string" },
      "sos": { "name": "string", "id": "string", "date": "YYYY-MM-DD or Year", "state": "string", "agent": "string", "url": "URL_TO_SOS_FILING" },
      "reputation": {
        "bbb": { "grade": "A+/F/NR", "accredited": "Yes/No", "complaints": "count", "summary": "string", "url": "URL_TO_BBB_PROFILE" },
        "reviews": [{"source":"Google/Trustpilot/Glassdoor/Reddit", "rating":"string", "text":"string", "url":"URL_TO_REVIEW_PAGE"}]
      },
      "ucc_filings": [{"date":"string", "file_num":"string", "lender":"string", "status":"Active", "url":"URL_TO_FILING"}],
      "litigation": [{"type":"string", "case_id":"string", "parties":"string", "date":"string", "status":"string", "url":"URL_TO_DOCKET"}],
      "financials": { "revenue": "string", "margin": "string", "cash": "string", "fico": "string", "charts": {"rev":[0,0,0], "debt":[0,0,0]} },
      "compliance": { "ofac": "Clean/Hit", "govContracts": "Yes/No" },
      "sources": [{"title":"string", "url":"string"}]
    }
    
    RULES:
    1. NO CONVERSATIONAL TEXT. JSON ONLY.
    2. "url" fields MUST be valid http/https links or null.
    3. Populate "sources" with all valid URLs found.
    4. ENSURE "reviews" array has at least 3 items.
    5. STRICTLY NO TRAILING COMMAS IN JSON.
    6. STRICTLY NO EMPTY KEYS like "": "" in JSON.
  `;
  };

  // --- RENDER LOGIC ---
  const render = (data) => {
    lastReportData = data; // Save state
    
    const txt = (id, v) => { const el = document.getElementById(id); if(el) el.innerText = v || '--'; };
    const html = (id, v) => { const el = document.getElementById(id); if(el) el.innerHTML = v || '--'; };
    
    // Header
    txt('h-name', data.info.name);
    txt('h-loc', data.info.location);
    txt('h-phone', data.info.phone);
    const link = document.getElementById('h-web'); 
    if(link) { 
        link.href = data.info.website || '#'; 
        link.innerText = data.info.website || '--'; 
    }
    txt('h-memo', data.meta.memo);
    
    // Gauge
    txt('g-score', data.meta.trustScore);
    const sc = data.meta.trustScore || 0;
    const gc = document.getElementById('g-circle');
    const gb = document.getElementById('g-badge');
    
    if(sc >= 700) { 
       gc.className = 'risk-gauge risk-low'; gb.innerText = 'Low Risk'; gb.className = 'px-5 py-1.5 rounded-full text-xs font-extrabold uppercase bg-green-600 text-white';
    } else if(sc >= 550) { 
       gc.className = 'risk-gauge risk-med'; gb.innerText = 'Medium Risk'; gb.className = 'px-5 py-1.5 rounded-full text-xs font-extrabold uppercase bg-yellow-500 text-white';
    } else { 
       gc.className = 'risk-gauge risk-high'; gb.innerText = 'High Risk'; gb.className = 'px-5 py-1.5 rounded-full text-xs font-extrabold uppercase bg-red-600 text-white';
    }

    // SOS
    const sosBadge = document.getElementById('sos-badge');
    sosBadge.innerText = data.meta.status;
    sosBadge.className = (data.meta.status||'').toLowerCase().includes('active') ? 'text-[10px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold uppercase border border-green-200' : 'text-[10px] bg-red-100 text-red-700 px-2 py-1 rounded font-bold uppercase border border-red-200';
    
    html('c-name', makeLink(data.sos.name, data.sos.url));
    html('c-id', makeLink(data.sos.id, data.sos.url, "font-mono text-sm text-brand-dark mt-1 bg-gray-50 inline-block px-2 py-0.5 rounded border border-gray-200 break-all"));
    txt('c-state', data.sos.state);
    txt('c-date', data.sos.date);
    txt('c-agent', data.sos.agent);

    // Populate header date
    const hFounded = document.getElementById('h-founded');
    if (data.sos.date) {
        hFounded.innerText = `Est. ${data.sos.date}`;
        hFounded.classList.remove('hidden');
    } else {
        hFounded.classList.add('hidden');
    }

    // BBB Section
    const bbb = data.reputation?.bbb || {};
    html('bbb-grade', makeLink(bbb.grade, bbb.url, "text-3xl font-extrabold text-brand-dark mt-1"));
    txt('bbb-status', bbb.accredited === 'Yes' ? '‚úÖ Accredited' : 'Not Accredited');
    txt('bbb-complaints', bbb.complaints);
    txt('bbb-summary', bbb.summary);
    
    // Grade Color Override
    const grade = document.getElementById('bbb-grade').querySelector('a') || document.getElementById('bbb-grade').querySelector('span');
    if(grade && (bbb.grade||'').includes('A')) grade.classList.add('text-green-600');
    else if(grade && (bbb.grade||'').includes('F')) grade.classList.add('text-red-600');

    // Reviews Feed
    const revList = document.getElementById('reviews-list'); revList.innerHTML='';
    if(data.reputation?.reviews && data.reputation.reviews.length > 0) {
      data.reputation.reviews.forEach(r => {
         const sourceHtml = makeLink(r.source, r.url, "font-bold text-xs text-brand-dark");
         revList.innerHTML += `
           <div class="p-4 hover:bg-gray-50 transition-colors">
             <div class="flex justify-between items-center mb-1">
               ${sourceHtml}
               <span class="text-xs font-bold text-brand-yellow bg-gray-800 px-2 py-0.5 rounded">${r.rating}</span>
             </div>
             <p class="text-xs text-brand-gray italic line-clamp-2">"${r.text}"</p>
           </div>
         `;
      });
    } else {
      revList.innerHTML = '<div class="p-6 text-center text-xs text-gray-400 italic">No recent reviews found.</div>';
    }

    // UCC & Legal
    const uccTb = document.getElementById('ucc-rows'); uccTb.innerHTML='';
    if(data.ucc_filings && data.ucc_filings.length > 0) {
      document.getElementById('ucc-empty').classList.add('hidden');
      data.ucc_filings.forEach(r => {
         const fileLink = makeLink(r.file_num || 'View', r.url, "font-mono text-xs text-blue-600 underline break-all");
         uccTb.innerHTML += `<tr><td class="font-mono text-xs">${r.date}</td><td>${fileLink}</td><td class="font-bold text-brand-dark text-xs">${r.lender}</td><td><span class="bg-gray-100 text-gray-600 text-[10px] px-2 py-0.5 rounded font-bold uppercase">${r.status}</span></td></tr>`;
      });
    } else {
      document.getElementById('ucc-empty').classList.remove('hidden');
    }

    const legTb = document.getElementById('legal-rows'); legTb.innerHTML='';
    if(data.litigation && data.litigation.length > 0) {
       document.getElementById('legal-empty').classList.add('hidden');
       data.litigation.forEach(r => {
          const caseLink = makeLink(r.case_id || 'Docket', r.url, "font-mono text-xs text-blue-600 underline break-all");
          legTb.innerHTML += `<tr><td><span class="bg-red-50 text-red-600 border border-red-100 text-[10px] px-2 py-0.5 rounded font-bold uppercase">${r.type}</span></td><td>${caseLink}</td><td class="text-xs font-semibold text-brand-dark">${r.parties}</td><td class="text-xs">${r.date}</td><td class="text-xs text-gray-500 italic">${r.status}</td></tr>`;
       });
    } else {
       document.getElementById('legal-empty').classList.remove('hidden');
    }

    // Financials - Removed UI but keep data structure intact if API returns it
    // ...
    
    txt('reg-ofac', data.compliance.ofac);
    txt('reg-gov', data.compliance.govContracts);
    const ofac = document.getElementById('reg-ofac');
    ofac.className = (data.compliance.ofac||'').includes('Clean') ? 'text-xs font-bold px-2 py-1 rounded bg-green-100 text-green-700' : 'text-xs font-bold px-2 py-1 rounded bg-red-100 text-red-700';
    
    // Sources
    const linksDiv = document.getElementById('source-links'); linksDiv.innerHTML='';
    const validSources = data.sources && data.sources.length > 0 ? data.sources : [];
    
    validSources.forEach(x => {
        if (x.url && x.url.startsWith('http')) {
            linksDiv.innerHTML += `<a href="${x.url}" target="_blank" class="flex items-center gap-2 text-brand-gray hover:text-brand-dark transition-colors truncate p-2 bg-gray-50 border border-gray-200 rounded hover:bg-gray-100"><span class="text-brand-yellow">üîó</span> ${x.title}</a>`;
        }
    });
  };

  // --- FETCH & RETRY ---
  const cleanJson = (str) => {
    let s = str;
    // Remove markdown fences
    s = s.replace(/```json/gi, '').replace(/```/g, '').trim();
    
    // Extract JSON object
    const firstOpen = s.indexOf('{');
    const lastClose = s.lastIndexOf('}');
    if (firstOpen !== -1 && lastClose !== -1) {
        s = s.substring(firstOpen, lastClose + 1);
    }

    // Fix common LLM JSON errors
    // 1. Trailing commas before closing braces/brackets
    s = s.replace(/,(\s*[}\]])/g, '$1');
    
    // 2. Fix empty keys resulting from hallucinations like "key": "val", ""
    
    return s;
  };

  const fetchWithRetry = async (url, options, retries = 5) => {
    const delays = [1000, 2000, 4000, 8000, 16000];
    for (let i = 0; i < retries; i++) {
      try {
        const response = await fetch(url, options);
        if (response.ok) return response;
        // Don't retry 404 (Not Found) or 400 (Bad Request), allow them to propagate
        if (response.status === 404 || response.status === 400) return response;
        if (response.status === 503 || response.status === 429) throw new Error(`Status ${response.status}`);
        return response;
      } catch (error) {
        if (i === retries - 1) throw error;
        await new Promise(resolve => setTimeout(resolve, delays[i]));
      }
    }
  };

  // Core Investigation Function
  const performInvestigation = async (name, isEnhanced = false, focusSection = null, btnElement = null) => {
    // Get the current API Key for this request
    const currentKey = getApiKey();
    
    // UI State Management
    let overlay = null;
    let originalBtnText = '';
    const steps = document.getElementById('loader-step');

    if (focusSection) {
        // Local Loading
        const sectionEl = document.getElementById(`sec-${focusSection}`);
        if(sectionEl) {
            overlay = document.createElement('div');
            overlay.className = 'section-loading';
            overlay.innerHTML = `<div class="flex flex-col items-center"><div class="w-8 h-8 border-4 border-brand-border border-t-brand-yellow rounded-full animate-spin mb-2"></div><span class="text-xs font-bold text-brand-gray animate-pulse">AGGREGATING LINKS...</span></div>`;
            sectionEl.appendChild(overlay);
        }
    } else {
        // Global Loading
        refs.viewSearch.classList.add('hidden');
        refs.viewLoader.classList.remove('hidden');
    }

    // Button Loading State
    if (btnElement) {
        originalBtnText = btnElement.innerHTML;
        btnElement.disabled = true;
        btnElement.innerHTML = `<svg class="animate-spin h-3 w-3 mr-1 inline-block" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> WAIT`;
    }
    
    let msgs = [];
    if(focusSection) {
        msgs = [`Scanning databases for ${focusSection}...`, "Locating direct links...", "Verifying source urls...", "Updating records..."];
    } else {
        // Default to deep audit messages
        msgs = ["Scanning Secretary of State databases...", "Searching Court Dockets...", "Aggregating BBB & Trustpilot data...", "Compiling direct links..."];
    }
    
    let s=0; 
    if(steps) steps.innerText = msgs[0];
    const t = setInterval(()=> { if(steps) steps.innerText=msgs[s++%msgs.length]; }, 2000);

    // Fallback Model Logic
    const models = ["gemini-3.0-pro-preview", "gemini-2.5-flash-preview-09-2025"];
    let successRaw = null;

    try {
      for (const model of models) {
        try {
            console.log(`Attempting investigation using model: ${model}`);
            const resp = await fetchWithRetry(
             `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${currentKey}`, 
             {
               method: 'POST', 
               headers: {'Content-Type':'application/json'},
               body: JSON.stringify({
                 contents: [{parts:[{text: `Generate FORENSIC report for: ${name}`}]}],
                 tools: [{google_search:{}}],
                 // ADDED SAFETY SETTINGS TO PREVENT BLOCKING
                 safetySettings: [
                    { category: "HARM_CATEGORY_HARASSMENT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_HATE_SPEECH", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_SEXUALLY_EXPLICIT", threshold: "BLOCK_ONLY_HIGH" },
                    { category: "HARM_CATEGORY_DANGEROUS_CONTENT", threshold: "BLOCK_ONLY_HIGH" }
                 ],
                 systemInstruction: {parts:[{text: getPrompt(name, isEnhanced, isEnhanced ? lastReportData : null, focusSection)}]}
               })
             }
           );
           
           if (resp.ok) {
               const raw = await resp.json();
               if (raw.candidates && raw.candidates[0]?.content) {
                   successRaw = raw;
                   break; 
               }
           }
           console.warn(`Model ${model} failed or returned empty results. Switching to fallback...`);

        } catch (e) {
           console.warn(`Error with model ${model}:`, e);
        }
      }

      if (!successRaw) {
           throw new Error("All available models failed to generate a report. Please try again later.");
      }

      const jsonText = successRaw.candidates[0].content.parts[0].text;
      let json;
      try {
           json = JSON.parse(cleanJson(jsonText));
      } catch(e) {
           console.error("JSON Parse Error", jsonText);
           throw new Error("Failed to parse forensic data.");
      }
       
      // Fallback: If JSON sources are empty, try metadata
      if (!json.sources || json.sources.length === 0) {
           const metaSources = successRaw.candidates[0].groundingMetadata?.groundingAttributions || [];
           json.sources = metaSources.map(m => ({ title: m.web?.title || "Source", url: m.web?.uri || "#" }));
      }
       
      render(json);

    } catch(e) {
       console.error(e);
       alert("Investigation interrupted: " + e.message + ". Please try again.");
    } finally {
       clearInterval(t);
       
       // UI Reset
       if (btnElement) {
           btnElement.innerHTML = originalBtnText;
           btnElement.disabled = false;
       }
       if (overlay) overlay.remove();
       
       // Only hide main loader if we weren't in a focusSection mode (because focusSection implies main view was already visible)
       // Actually, regardless of mode, if we are done, we should ensure the report is visible and loader hidden
       refs.viewLoader.classList.add('hidden');
       if (lastReportData) {
           refs.viewReport.classList.remove('hidden');
           refs.viewSearch.classList.add('hidden');
       } else {
           // If failed and no data, show search
           refs.viewSearch.classList.remove('hidden');
       }
    }
  };

  // Initial Search Button - FORCED ENHANCED MODE
  refs.btn.onclick = function() {
    const name = refs.input.value.trim();
    if(!name) { 
        refs.input.focus(); 
        return; 
    }
    // Pass 'this' as the button element, FORCE isEnhanced = true
    performInvestigation(name, true, null, this);
  };
  
  // Top "Enhanced Search" Button
  if(refs.reverify) {
    refs.reverify.onclick = function() {
        const currentName = document.getElementById('h-name').innerText;
        if(currentName && currentName !== '--') {
            performInvestigation(currentName, true, null, this); 
        }
    };
  }

  // Section "ENHANCE" Buttons
  document.querySelectorAll('.enhance-btn').forEach(btn => {
      btn.addEventListener('click', function() {
          const currentName = document.getElementById('h-name').innerText;
          const section = this.dataset.section;
          if(currentName && currentName !== '--') {
             performInvestigation(currentName, true, section, this);
          }
      });
  });

  // Allow Enter key
  refs.input.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') refs.btn.click();
  });

});
</script>
</body>
</html>
