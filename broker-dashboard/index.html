<!DOCTYPE html>
<html lang="en" class="theme-light accent-mint">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>TrustBureau.ai | Payments Offer Calculator</title>
<!-- Tailwind -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
<style>
body { font-family: 'Inter', sans-serif; }
input[type=number]::-webkit-inner-spin-button,
input[type=number]::-webkit-outer-spin-button {
-webkit-appearance: none;
margin: 0;
}
input[type=number] { -moz-appearance: textfield; }
.input-icon { top: 50%; transform: translateY(-50%); }
/* --- BASE THEMES --- */
/* Light Theme */
html.theme-light {
--bg-body: #ffffff;
--bg-card: #ffffff;
--bg-card-inner: #f9fafb;
--bg-slider-track: #e2e8f0;
--bg-input: #ffffff;
--bg-toggle-inactive: #f1f5f9;
--border-primary: #e2e8f0;
--text-primary: #0f172a;
--text-secondary: #334155;
--text-muted: #64748b;
--text-success: #16a34a;
--shadow-color: rgba(0, 0, 0, 0.06);
}
/* Dark Theme (Gray-900) */
html.theme-dark {
--bg-body: #111827;
--bg-card: #1f2937;
--bg-card-inner: #111827;
--bg-slider-track: #374151;
--bg-input: #1f2937;
--bg-toggle-inactive: #111827;
--border-primary: #374151;
--text-primary: #f9fafb;
--text-secondary: #e5e7eb;
--text-muted: #9ca3af;
--text-success: #4ade80;
--shadow-color: rgba(0, 0, 0, 0.3);
}
/* Black Theme (Pure Black/Deep Navy) */
html.theme-black {
--bg-body: #020617;
--bg-card: #020617;
--bg-card-inner: #0f172a;
--bg-slider-track: #1e293b;
--bg-input: #020617;
--bg-toggle-inactive: #0f172a;
--border-primary: #1e293b;
--text-primary: #f8fafc;
--text-secondary: #cbd5e1;
--text-muted: #64748b;
--text-success: #4ade80;
--shadow-color: rgba(0, 0, 0, 0.5);
}
body { background-color: var(--bg-body); transition: background-color 0.2s; }
/* --- ACCENT COLORS --- */
/* 11. Mint (Requested) */
html.accent-mint {
--accent-color: #42D197;
--accent-color-light: #74eabc;
--accent-color-dark: #2d9668;
--accent-text-inverted: #ffffff;
}
/* Other accent colors omitted for brevity - include all from original */
/* --- COMPONENT STYLES --- */
.card-bg {
background-color: var(--bg-card);
border-color: var(--border-primary);
}
.shell {
border-color: var(--accent-color);
border-width: 3px;
box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color);
}
.card-inner-bg { 
background-color: var(--bg-card-inner); 
border: 1px solid var(--border-primary); 
}
.text-primary { color: var(--text-primary); }
.text-secondary { color: var(--text-secondary); }
.text-muted { color: var(--text-muted); }
.text-success { color: var(--text-success); }
.border-primary { border-color: var(--border-primary); }
.slider-track { background-color: var(--bg-slider-track); }
.slider-thumb { accent-color: var(--accent-color); }
.input-field {
background-color: var(--bg-input);
border-color: var(--border-primary);
color: var(--text-primary);
}
.input-field:focus,
.input-field:focus-within {
border-color: var(--accent-color);
box-shadow: 0 0 0 1px var(--accent-color-light);
outline: none;
}
input[type="date"] {
background-color: var(--bg-input);
color: var(--text-primary);
border-color: var(--border-primary);
}
::-webkit-calendar-picker-indicator {
filter: invert(0.5);
cursor: pointer;
}
html.theme-light ::-webkit-calendar-picker-indicator {
filter: invert(0);
}
.text-hero {
color: var(--accent-color);
}
.toggle-inactive {
background-color: var(--bg-toggle-inactive);
color: var(--text-secondary);
}
.toggle-active {
background-color: var(--accent-color);
color: var(--accent-text-inverted);
font-weight: 700;
}
.button-primary {
background-color: var(--accent-color);
color: var(--accent-text-inverted);
font-weight: 700;
border-radius: 0.5rem;
padding: 0.6rem 1.75rem;
border: 1px solid var(--accent-color-dark);
transition: all 0.2s ease;
}
.button-primary:hover {
background-color: var(--accent-color-light);
box-shadow:
0 0 0 1px var(--accent-color),
0 0 15px var(--accent-color-light);
transform: translateY(-1px) scale(1.01);
}
.button-primary:disabled {
background-color: var(--bg-slider-track);
color: var(--text-muted);
cursor: not-allowed;
transform: none;
box-shadow: none;
border-color: transparent;
}
/* Table Styles */
.amort-table th {
background-color: var(--bg-slider-track);
color: var(--text-secondary);
font-size: 0.75rem;
text-transform: uppercase;
letter-spacing: 0.05em;
padding: 0.75rem 0.5rem;
font-weight: 600;
}
.amort-table td {
border-bottom: 1px solid var(--border-primary);
color: var(--text-primary);
font-size: 0.8rem;
padding: 0.6rem 0.5rem;
}
.amort-table tr:last-child td {
border-bottom: none;
}
</style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 transition-colors duration-200">

<!-- Authentication Check -->
<div id="authCheck" class="hidden">
  <div class="w-full max-w-xl card-bg shell text-primary rounded-xl shadow-lg p-8 border text-center">
    <h2 class="text-2xl font-bold text-hero mb-4">Access Required</h2>
    <p class="text-secondary mb-4">This approval link requires authentication.</p>
    <p class="text-muted text-sm">Please use the link provided by your representative.</p>
  </div>
</div>

<div id="mainCalculator" class="w-full max-w-xl card-bg shell text-primary rounded-xl shadow-lg p-4 md:p-6 space-y-4 border">
  
  <!-- HEADER -->
  <div id="headerContainer" class="pb-3 border-b border-primary flex flex-col items-center gap-3">
    <div class="flex flex-col items-center justify-center flex-shrink-0">
      <div id="headerLogoWrapper" class="flex items-center justify-center mb-2">
        <img id="headerLogo" src="" alt="Company Logo" class="h-16 w-auto object-contain hidden" />
        <svg id="placeholderIcon" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-hero" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.285z" />
        </svg>
      </div>
      <h1 id="headerTitle" class="text-primary text-xl mt-0 text-center font-normal tracking-wide">TrustBureau.ai</h1>
      <span id="headerPoweredBy" class="text-xs font-semibold text-muted uppercase tracking-widest mt-1 hidden">powered by TrustBureau.ai</span>
    </div>
    
    <!-- Dashboard Button (Approval View Only) -->
    <div id="dashboardButtonContainer" class="hidden">
      <button id="dashboardButton" type="button"
        class="px-4 py-2 text-sm rounded-lg border-2 border-primary text-primary hover:bg-accent-color hover:text-accent-text-inverted hover:border-accent-color flex items-center gap-2 transition-all font-semibold">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
        </svg>
        View Dashboard
      </button>
    </div>
  </div>

  <!-- OFFER CALCULATOR -->
  <div id="calculatorInputs" class="space-y-4 pt-2 hidden">
    <div id="businessNameContainer" class="px-1 mt-2">
      <label for="businessNameInput" class="block text-xs font-semibold text-muted">
        Business Name
      </label>
      <input id="businessNameInput" type="text"
        class="mt-1 w-full p-2 text-sm border rounded-lg shadow-sm input-field"
        placeholder="e.g., Acme Holdings LLC" />
    </div>
    <div class="card-inner-bg p-4 rounded-xl shadow-inner space-y-4">
      <div id="amountContainer" class="space-y-1">
        <label for="calcAmount" class="block text-xs font-semibold text-muted">
          Amount You Get ($)
        </label>
        <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1" value="50000"
          class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb mb-2" />
        <div class="relative group">
          <span class="absolute left-3 input-icon text-muted text-sm">$</span>
          <input id="calcAmountInput" inputmode="numeric"
            class="w-full p-2 pl-8 text-sm border rounded-lg shadow-sm input-field" />
        </div>
      </div>
      <div id="factorContainer" class="space-y-1 hidden">
        <label for="calcFactor" class="block text-xs font-semibold text-muted">Factor Rate</label>
        <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25"
          class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb" />
        <div class="relative group">
          <svg xmlns="http://www.w3.org/2000/svg"
            class="h-4 w-4 absolute left-3 input-icon text-muted"
            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M6 18 18 6M6 6l12 12" />
          </svg>
          <input id="calcFactorInput" type="number" step="0.01"
            class="w-full p-2 pl-9 text-sm border rounded-lg shadow-sm input-field" />
        </div>
      </div>
      <div id="termContainer" class="space-y-1 hidden">
        <label for="calcTerm" class="block text-xs font-semibold text-muted">
          Number of Payments
        </label>
        <input id="calcTermSlider" type="range" min="3" max="528" step="1" value="130"
          class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb" />
        <div class="relative group">
          <svg xmlns="http://www.w3.org/2000/svg"
            class="h-3 w-3 absolute left-3 input-icon text-muted"
            fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z" />
          </svg>
          <input id="calcTermInput" type="number" step="1"
            class="w-full p-2 pl-8 text-sm border rounded-lg shadow-sm input-field" />
        </div>
      </div>
    </div>
    <div id="toggleContainer" class="flex items-center justify-center space-x-2 hidden">
      <button id="toggleDaily" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
        Daily
      </button>
      <button id="toggleWeekly" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
        Weekly
      </button>
      <button id="toggleMonthly" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
        Monthly
      </button>
    </div>
  </div>

  <!-- OFFER CARD -->
  <div id="offerCard" class="card-bg p-4 rounded-lg shadow-md border border-primary">
    <div class="flex justify-center items-center border-b border-primary pb-3 pt-3">
      <h4 class="text-sm font-semibold text-secondary">Offer 1 â€“ Your Approved Terms</h4>
    </div>
    <div class="text-center py-6">
      <span id="businessNameDisplay"
        class="text-sm font-semibold text-primary block mb-1 hidden"></span>
      <span class="text-xs font-semibold text-muted block">You Get</span>
      <span id="summaryAmountOut"
        class="text-5xl font-bold block my-2 text-hero leading-tight">$50,000</span>
      <span class="text-sm font-medium text-secondary block">
        Total Payback:
        <span id="summaryPaybackOut" class="font-semibold text-primary"></span>
      </span>
    </div>
    <div class="flex justify-center items-center border-b border-primary pb-2">
      <h5 class="text-sm font-semibold text-secondary text-center">Offer Details</h5>
    </div>
    
    <div class="mt-6 border border-primary rounded-lg overflow-hidden">
      <div class="divide-y divide-primary">
        <!-- Row 1: Term Info -->
        <div class="grid grid-cols-2 divide-x divide-primary bg-card-inner-bg/50">
          <div class="p-3 text-center">
            <span class="text-xs font-medium text-muted block">Term Length</span>
            <span id="summaryTermLengthOut" class="text-xs font-normal text-primary block mt-1"></span>
          </div>
          <div class="p-3 text-center">
            <span class="text-xs font-medium text-muted block">Payments</span>
            <span id="summaryTermOut" class="text-xs font-normal text-primary block mt-1"></span>
          </div>
        </div>
        
        <!-- Row 2: Rates & Cost -->
        <div class="grid grid-cols-2 divide-x divide-primary bg-card-inner-bg/50">
          <div class="p-3 text-center">
            <span class="text-xs font-medium text-muted block">Factor Rate</span>
            <span id="summaryFactorOut" class="text-xs font-normal text-primary block mt-1"></span>
          </div>
          <div class="p-3 text-center">
            <span class="text-xs font-medium text-muted block">Total Cost of Funds</span>
            <span id="summaryCostOut" class="text-xs font-normal text-primary block mt-1"></span>
          </div>
        </div>
        
        <!-- Row 3: Fee & Net -->
        <div id="detailsRowFee" class="grid grid-cols-2 divide-x divide-primary bg-card-inner-bg/50">
          <div id="feeGridItem" class="p-3 text-center">
            <span class="text-xs font-medium text-muted block">Origination Fee</span>
            <span id="summaryFeeOut" class="text-xs font-normal text-primary block mt-1"></span>
          </div>
          <div id="netGridItem" class="p-3 text-center">
            <span class="text-xs font-medium text-muted block">Net Proceeds</span>
            <span id="summaryNetOut" class="text-xs font-normal text-primary block mt-1"></span>
          </div>
        </div>
        
        <!-- Footer: Payment -->
        <div class="p-4 text-center bg-slider-track/20">
          <span id="summaryPaymentLabel" class="text-xs font-medium text-muted block">Est. Daily Payment</span>
          <span id="summaryPaymentValue" class="text-xs font-normal text-primary block mt-1"></span>
        </div>
      </div>
    </div>

    <!-- Prepay Discount Section -->
    <div id="prepaySection" class="mt-4 pt-4 border-t border-primary">
      <button id="togglePrepay" class="w-full text-xs font-semibold text-muted hover:text-primary flex items-center justify-center gap-1 transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        Calculate Prepayment Discount
      </button>
      
      <div id="prepayContainer" class="hidden mt-4 card-inner-bg p-4 rounded-lg border border-primary">
        <div class="flex justify-between items-center mb-2 pb-2 border-b border-primary">
          <span class="text-xs font-semibold text-secondary">Prepayment Discount</span>
          <span id="prepayPercentDisplay" class="text-xs font-bold text-hero">0%</span>
        </div>
        
        <!-- Client View: Date Picker -->
        <div id="prepayDateContainer" class="hidden mb-4 pt-2">
          <label class="block text-xs font-semibold text-muted mb-1 text-center">Select Payoff Date</label>
          <input id="prepayDateInput" type="date"
            class="w-full p-2 text-sm rounded-lg border border-primary input-field text-center" />
        </div>
        
        <div class="grid grid-cols-2 gap-4 text-center border-t border-primary pt-3">
          <div>
            <span class="text-xs font-semibold text-muted block uppercase tracking-wider">Savings</span>
            <span id="prepaySavingsDisplay" class="text-sm font-bold text-success">$0.00</span>
          </div>
          <div>
            <span class="text-xs font-semibold text-muted block uppercase tracking-wider">New Payoff</span>
            <span id="prepayTotalDisplay" class="text-sm font-bold text-primary">$0.00</span>
          </div>
        </div>
        
        <!-- Amortization Button -->
        <div id="amortizationBtnContainer" class="mt-4 text-center hidden">
          <button id="viewAmortizationBtn" type="button"
            class="text-xs font-semibold text-hero underline hover:text-primary transition-colors">
            View Amortization Schedule
          </button>
        </div>
      </div>
    </div>

    <div id="repContactBlock"
      class="mt-6 pt-3 border-t border-primary text-xs text-secondary text-center hidden">
      <div class="font-semibold text-muted mb-1">Your Funding Specialist</div>
      <div id="repNameDisplay" class="font-medium"></div>
      <div id="repEmailDisplay"></div>
      <div id="repPhoneDisplay"></div>
    </div>
  </div>

  <!-- ADDITIONAL OFFERS -->
  <div id="savedOffersSection"
    class="card-bg mt-4 p-4 rounded-lg shadow-md border border-primary hidden">
    <div class="flex justify-between items-center border-b border-primary pb-2 mb-4">
      <h5 class="text-sm font-semibold text-secondary">Additional Offers</h5>
    </div>
    <div id="savedOffersContainer"
      class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
  </div>
</div>

<!-- AMORTIZATION MODAL -->
<div id="amortizationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm p-4">
  <div class="card-bg w-full max-w-2xl max-h-[85vh] rounded-xl shadow-2xl flex flex-col border border-primary">
    <div class="p-4 border-b border-primary flex justify-between items-center bg-slate-50 dark:bg-slate-900 rounded-t-xl">
      <h3 class="font-semibold text-lg text-primary">Amortization Schedule</h3>
      <button id="closeAmortizationBtn" class="text-muted hover:text-primary transition-colors">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    <div class="overflow-auto p-0 flex-1">
      <table class="w-full text-left amort-table">
        <thead class="sticky top-0 z-10 shadow-sm">
          <tr>
            <th>#</th>
            <th>Date</th>
            <th>Payment</th>
            <th>Balance</th>
            <th>Prepay Savings</th>
            <th>Payoff Amount</th>
          </tr>
        </thead>
        <tbody id="amortizationTableBody">
        </tbody>
      </table>
    </div>
    <div class="p-3 border-t border-primary text-center text-xs text-muted bg-slate-50 dark:bg-slate-900 rounded-b-xl">
      * Schedule is an estimate. Actual payoff dates and amounts may vary based on banking holidays and clear dates.
    </div>
  </div>
</div>

<script>
const elements = {
  authCheck: document.getElementById('authCheck'),
  mainCalculator: document.getElementById('mainCalculator'),
  dashboardButton: document.getElementById('dashboardButton'),
  dashboardButtonContainer: document.getElementById('dashboardButtonContainer'),
  calcAmountSlider: document.getElementById('calcAmountSlider'),
  calcFactorSlider: document.getElementById('calcFactorSlider'),
  calcTermSlider: document.getElementById('calcTermSlider'),
  calcAmountInput: document.getElementById('calcAmountInput'),
  calcFactorInput: document.getElementById('calcFactorInput'),
  calcTermInput: document.getElementById('calcTermInput'),
  toggleDaily: document.getElementById('toggleDaily'),
  toggleWeekly: document.getElementById('toggleWeekly'),
  toggleMonthly: document.getElementById('toggleMonthly'),
  summaryAmountOut: document.getElementById('summaryAmountOut'),
  summaryPaybackOut: document.getElementById('summaryPaybackOut'),
  summaryFactorOut: document.getElementById('summaryFactorOut'),
  summaryTermOut: document.getElementById('summaryTermOut'),
  summaryCostOut: document.getElementById('summaryCostOut'),
  summaryPaymentLabel: document.getElementById('summaryPaymentLabel'),
  summaryPaymentValue: document.getElementById('summaryPaymentValue'),
  summaryFeeOut: document.getElementById('summaryFeeOut'),
  summaryNetOut: document.getElementById('summaryNetOut'),
  summaryTermLengthOut: document.getElementById('summaryTermLengthOut'),
  feeGridItem: document.getElementById('feeGridItem'),
  netGridItem: document.getElementById('netGridItem'),
  detailsRowFee: document.getElementById('detailsRowFee'),
  businessNameInput: document.getElementById('businessNameInput'),
  businessNameDisplay: document.getElementById('businessNameDisplay'),
  businessNameContainer: document.getElementById('businessNameContainer'),
  repContactBlock: document.getElementById('repContactBlock'),
  repNameDisplay: document.getElementById('repNameDisplay'),
  repEmailDisplay: document.getElementById('repEmailDisplay'),
  repPhoneDisplay: document.getElementById('repPhoneDisplay'),
  headerTitle: document.getElementById('headerTitle'),
  headerLogo: document.getElementById('headerLogo'),
  placeholderIcon: document.getElementById('placeholderIcon'),
  headerLogoWrapper: document.getElementById('headerLogoWrapper'),
  headerPoweredBy: document.getElementById('headerPoweredBy'),
  headerContainer: document.getElementById('headerContainer'),
  calculatorInputs: document.getElementById('calculatorInputs'),
  factorContainer: document.getElementById('factorContainer'),
  termContainer: document.getElementById('termContainer'),
  toggleContainer: document.getElementById('toggleContainer'),
  savedOffersSection: document.getElementById('savedOffersSection'),
  savedOffersContainer: document.getElementById('savedOffersContainer'),
  prepaySection: document.getElementById('prepaySection'),
  togglePrepay: document.getElementById('togglePrepay'),
  prepayContainer: document.getElementById('prepayContainer'),
  prepayDateContainer: document.getElementById('prepayDateContainer'),
  prepayDateInput: document.getElementById('prepayDateInput'),
  prepayPercentDisplay: document.getElementById('prepayPercentDisplay'),
  prepaySavingsDisplay: document.getElementById('prepaySavingsDisplay'),
  prepayTotalDisplay: document.getElementById('prepayTotalDisplay'),
  amortizationBtnContainer: document.getElementById('amortizationBtnContainer'),
  viewAmortizationBtn: document.getElementById('viewAmortizationBtn'),
  amortizationModal: document.getElementById('amortizationModal'),
  closeAmortizationBtn: document.getElementById('closeAmortizationBtn'),
  amortizationTableBody: document.getElementById('amortizationTableBody'),
};

let paymentFrequency = 'daily';
let currentBaseTheme = 'theme-light';
let currentAccentClass = 'accent-mint';
let amountSliderMax = 1000000;
let savedOffers = [];
let isApprovalView = false;
let prepayDiscountPercent = 0;
let accessToken = '';
let dashboardUrl = '';

const DEFAULT_COMPANY_NAME = "TrustBureau.ai";
const DEFAULT_LOGO_URL = "";

function setBaseTheme(themeName) {
  document.documentElement.classList.remove('theme-light', 'theme-dark', 'theme-black');
  currentBaseTheme = themeName;
  document.documentElement.classList.add(themeName);
  applyTheme();
}

function setAccent(accentName) {
  const classes = document.documentElement.classList;
  for (let i = classes.length - 1; i >= 0; i--) {
    if (classes[i].startsWith('accent-')) {
      classes.remove(classes[i]);
    }
  }
  currentAccentClass = accentName;
  document.documentElement.classList.add(accentName);
  applyTheme();
}

function setAmountSliderMax(cap) {
  amountSliderMax = cap;
  if (elements.calcAmountSlider) {
    elements.calcAmountSlider.max = String(cap);
  }
}

function formatCurrency(num) {
  const n = Number(num);
  if (isNaN(n)) return '$0';
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 0,
    maximumFractionDigits: 2,
  }).format(n);
}

function parseFormattedNumber(val) {
  if (typeof val !== 'string' || !val) return 0;
  return parseFloat(val.replace(/[\$,]/g, '')) || 0;
}

function computeOffer(amount, factor, termPayments, frequency, feePercent) {
  const totalPayback = amount * factor;
  const totalCost = totalPayback - amount;
  const paymentsCount = termPayments > 0 ? termPayments : 1;
  const paymentAmount = totalPayback / paymentsCount;
  const feeAmount = amount * (feePercent / 100);
  const netProceeds = amount - feeAmount;

  let rawMonths;
  if (frequency === 'weekly') {
    rawMonths = termPayments * (12 / 52);
  } else if (frequency === 'monthly') {
    rawMonths = termPayments;
  } else {
    rawMonths = termPayments * (12 / 250);
  }
  const termLengthMonths = Math.round(rawMonths * 2) / 2;

  let paymentLabel = 'Est. Daily Payment';
  if (frequency === 'weekly') paymentLabel = 'Est. Weekly Payment';
  if (frequency === 'monthly') paymentLabel = 'Est. Monthly Payment';

  return {
    amount,
    factor,
    feePercent,
    feeAmount,
    netProceeds,
    termMonths: termPayments,
    termLengthMonths,
    totalPayback,
    totalCost,
    payment: paymentAmount,
    paymentLabel,
    frequency,
  };
}

function getCurrentOffer() {
  const amount = parseFormattedNumber(elements.calcAmountInput.value);
  const factor = parseFloat(elements.calcFactorInput.value) || 1.05;
  const termPayments = parseInt(elements.calcTermInput.value) || 1;
  const fee = 0; // No fee in approval view
  return computeOffer(amount, factor, termPayments, paymentFrequency, fee);
}

function renderSavedOffers() {
  if (!elements.savedOffersSection || !elements.savedOffersContainer) return;
  const used = savedOffers.length;
  if (used === 0) {
    elements.savedOffersSection.classList.add('hidden');
    elements.savedOffersContainer.innerHTML = '';
    return;
  }
  elements.savedOffersSection.classList.remove('hidden');
  const cardsHtml = savedOffers.map((offer, index) => {
    const labelIndex = index + 2;
    return `
      <div class="card-bg rounded-lg border border-primary overflow-hidden">
        <div class="p-3 border-b border-primary flex justify-between items-center bg-slate-50 dark:bg-slate-800/50">
          <span class="text-xs font-semibold text-secondary">Offer ${labelIndex}</span>
        </div>
        <div class="p-4 text-center border-b border-primary">
          <span class="text-[10px] font-semibold text-muted uppercase tracking-wide">You Get</span>
          <span class="text-3xl font-bold text-hero mt-1 block">${formatCurrency(offer.amount)}</span>
        </div>
        <div class="divide-y divide-primary text-xs">
          <div class="grid grid-cols-2 divide-x divide-primary">
            <div class="p-2 text-center">
              <span class="text-[10px] text-muted block">Factor</span>
              <span class="font-medium text-primary">${offer.factor.toFixed(2)}x</span>
            </div>
            <div class="p-2 text-center">
              <span class="text-[10px] text-muted block">Term</span>
              <span class="font-medium text-primary">${offer.termMonths}</span>
            </div>
          </div>
          <div class="grid grid-cols-2 divide-x divide-primary">
            <div class="p-2 text-center">
              <span class="text-[10px] text-muted block">Payback</span>
              <span class="font-medium text-primary">${formatCurrency(offer.totalPayback)}</span>
            </div>
            <div class="p-2 text-center">
              <span class="text-[10px] text-muted block">${offer.frequency === 'weekly' ? 'Weekly' : 'Daily'}</span>
              <span class="font-medium text-primary">${formatCurrency(offer.payment)}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }).join('');
  elements.savedOffersContainer.innerHTML = cardsHtml;
}

function syncInputs(slider, input, isCurrency, min, max, callback) {
  const isAmountSlider = (slider === elements.calcAmountSlider);
  const getMax = () => (isAmountSlider ? amountSliderMax : max);
  const initialValue = parseFloat(slider.value);
  input.value = isCurrency ? formatCurrency(initialValue) : initialValue.toString();

  slider.addEventListener('input', () => {
    let val = parseFloat(slider.value);
    const cap = getMax();
    if (!isNaN(val) && val > cap) {
      val = cap;
      slider.value = val;
    }
    input.value = isCurrency ? formatCurrency(val) : val;
    callback();
  });

  input.addEventListener('input', () => {
    let val = isCurrency ? parseFormattedNumber(input.value) : parseFloat(input.value);
    const cap = getMax();
    if (!isNaN(val) && val >= min && val <= cap) {
      slider.value = val;
      callback();
    } else if (input.value === '') {
      callback();
    }
  });

  input.addEventListener('blur', () => {
    let val = isCurrency ? parseFormattedNumber(input.value) : parseFloat(input.value);
    const cap = getMax();
    if (isNaN(val) || val < min) val = min;
    if (val > cap) val = cap;
    slider.value = val;
    input.value = isCurrency ? formatCurrency(val) : val.toString();
    callback();
  });
}

function applyTheme() {
  document.documentElement.className = `${currentBaseTheme} ${currentAccentClass}`;
  try {
    localStorage.setItem('theme', currentBaseTheme);
  } catch (e) {
    // ignore
  }
}

function updateRepDisplay() {
  if (!elements.repContactBlock) return;
  const repName = new URLSearchParams(window.location.search).get('repName') || '';
  const repEmail = new URLSearchParams(window.location.search).get('repEmail') || '';
  const repPhone = new URLSearchParams(window.location.search).get('repPhone') || '';
  
  const hasAny = repName || repEmail || repPhone;
  if (hasAny) {
    elements.repContactBlock.classList.remove('hidden');
  } else {
    elements.repContactBlock.classList.add('hidden');
  }
  if (elements.repNameDisplay) elements.repNameDisplay.textContent = repName;
  if (elements.repEmailDisplay) elements.repEmailDisplay.textContent = repEmail;
  if (elements.repPhoneDisplay) elements.repPhoneDisplay.textContent = repPhone;
}

function updateBranding() {
  const params = new URLSearchParams(window.location.search);
  const cName = params.get('cName') || '';
  const cLogo = params.get('cLogo') || '';

  if (cName) {
    elements.headerTitle.textContent = cName;
    elements.headerTitle.classList.remove('hidden');
    elements.headerPoweredBy.classList.remove('hidden');
  } else {
    elements.headerTitle.textContent = DEFAULT_COMPANY_NAME;
    elements.headerTitle.classList.remove('hidden');
    elements.headerPoweredBy.classList.add('hidden');
  }

  if (cLogo) {
    elements.headerLogo.src = cLogo;
    elements.headerLogo.classList.remove('hidden');
    elements.placeholderIcon.classList.add('hidden');
  } else {
    elements.headerLogo.src = "";
    elements.headerLogo.classList.add('hidden');
    elements.placeholderIcon.classList.remove('hidden');
  }
}

function updatePaymentToggleUI() {
  const toggles = [elements.toggleDaily, elements.toggleWeekly, elements.toggleMonthly];
  const frequencies = ['daily', 'weekly', 'monthly'];
  toggles.forEach((toggle, index) => {
    if (!toggle) return;
    toggle.classList.remove('toggle-active', 'toggle-inactive');
    if (paymentFrequency === frequencies[index]) {
      toggle.classList.add('toggle-active');
    } else {
      toggle.classList.add('toggle-inactive');
    }
  });
}

function generateSchedule(offer) {
  const schedule = [];
  let currentDate = new Date();
  currentDate.setHours(0,0,0,0);

  const totalPayments = offer.termMonths;
  const paymentAmount = offer.payment;
  const totalPayback = offer.totalPayback;
  const maxDiscount = totalPayback * (prepayDiscountPercent / 100);

  let runningDate = new Date(currentDate);
  let paidSoFar = 0;

  for (let i = 1; i <= totalPayments; i++) {
    if (offer.frequency === 'weekly') {
      runningDate.setDate(runningDate.getDate() + 7);
    } else if (offer.frequency === 'monthly') {
      runningDate.setMonth(runningDate.getMonth() + 1);
    } else {
      do {
        runningDate.setDate(runningDate.getDate() + 1);
      } while (runningDate.getDay() === 0 || runningDate.getDay() === 6);
    }

    paidSoFar += paymentAmount;
    const remainingBalance = totalPayback - paidSoFar;
    const fractionRemaining = (totalPayments - i) / totalPayments;
    const savings = maxDiscount * fractionRemaining;
    let payoff = remainingBalance - savings;
    if (payoff < 0) payoff = 0;

    schedule.push({
      num: i,
      date: new Date(runningDate),
      payment: paymentAmount,
      balance: remainingBalance < 0.01 ? 0 : remainingBalance,
      savings: savings,
      payoff: payoff
    });
  }
  return schedule;
}

function renderAmortizationSchedule(offer) {
  if (!elements.amortizationTableBody) return;
  const schedule = generateSchedule(offer);
  const rows = schedule.map(row => {
    const dateStr = row.date.toLocaleDateString();
    return `
      <tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
        <td class="font-mono text-xs text-muted">${row.num}</td>
        <td>${dateStr}</td>
        <td>${formatCurrency(row.payment)}</td>
        <td>${formatCurrency(row.balance)}</td>
        <td class="text-success font-medium">${formatCurrency(row.savings)}</td>
        <td class="font-semibold text-primary">${formatCurrency(row.payoff)}</td>
      </tr>
    `;
  }).join('');
  elements.amortizationTableBody.innerHTML = rows;
}

function calculatePrepay(offer) {
  if (isApprovalView) {
    if (prepayDiscountPercent > 0) {
      if (elements.amortizationBtnContainer)
        elements.amortizationBtnContainer.classList.remove('hidden');
    } else {
      if (elements.amortizationBtnContainer)
        elements.amortizationBtnContainer.classList.add('hidden');
    }
  }

  if (isApprovalView && prepayDiscountPercent === 0) {
    if (elements.prepaySection) elements.prepaySection.classList.add('hidden');
    return;
  }

  if (elements.prepaySection) elements.prepaySection.classList.remove('hidden');
  if (!elements.prepayContainer || elements.prepayContainer.classList.contains('hidden')) return;

  const totalPayback = offer.totalPayback;
  let savings = 0;

  if (isApprovalView) {
    const dateVal = elements.prepayDateInput.value;
    if (!dateVal) {
      const today = new Date().toISOString().split('T')[0];
      elements.prepayDateInput.value = today;
    }

    const startDate = new Date();
    startDate.setHours(0,0,0,0);

    let termDays = 0;
    if (offer.frequency === 'weekly') {
      termDays = offer.termMonths * 7;
    } else if (offer.frequency === 'monthly') {
      termDays = offer.termMonths * 30.44;
    } else {
      termDays = offer.termMonths * 1.42;
    }

    const endDate = new Date(startDate);
    endDate.setDate(endDate.getDate() + Math.ceil(termDays));

    elements.prepayDateInput.min = startDate.toISOString().split('T')[0];
    elements.prepayDateInput.max = endDate.toISOString().split('T')[0];

    let selectedDate = new Date(elements.prepayDateInput.value);
    selectedDate.setHours(0,0,0,0);
    if (selectedDate < startDate) selectedDate = startDate;
    if (selectedDate > endDate) selectedDate = endDate;

    const totalTime = endDate.getTime() - startDate.getTime();
    const remainingTime = endDate.getTime() - selectedDate.getTime();
    let fractionRemaining = 0;
    if (totalTime > 0) {
      fractionRemaining = remainingTime / totalTime;
    }
    if (fractionRemaining < 0) fractionRemaining = 0;
    if (fractionRemaining > 1) fractionRemaining = 1;

    const maxPotentialSavings = totalPayback * (prepayDiscountPercent / 100);
    savings = maxPotentialSavings * fractionRemaining;
    elements.prepayPercentDisplay.textContent = `${prepayDiscountPercent}% Max`;
  }

  const newPayoff = totalPayback - savings;
  elements.prepaySavingsDisplay.textContent = formatCurrency(savings);
  elements.prepayTotalDisplay.textContent = formatCurrency(newPayoff);
}

function runCalculator() {
  try {
    const amount = parseFormattedNumber(elements.calcAmountInput.value);
    const factor = parseFloat(elements.calcFactorInput.value) || 1.05;
    const termPayments = parseInt(elements.calcTermInput.value) || 1;
    const fee = 0;
    const offer = computeOffer(amount, factor, termPayments, paymentFrequency, fee);

    const businessName = elements.businessNameInput ? elements.businessNameInput.value.trim() : '';
    if (elements.businessNameDisplay) {
      if (businessName) {
        elements.businessNameDisplay.textContent = businessName;
        elements.businessNameDisplay.classList.remove('hidden');
      } else {
        elements.businessNameDisplay.textContent = '';
        elements.businessNameDisplay.classList.add('hidden');
      }
    }

    elements.summaryAmountOut.textContent = formatCurrency(offer.amount);
    elements.summaryPaybackOut.textContent = formatCurrency(offer.totalPayback);
    elements.summaryFactorOut.textContent = `${offer.factor.toFixed(2)}x`;
    elements.summaryTermOut.textContent = `${offer.termMonths} payments`;
    elements.summaryCostOut.textContent = formatCurrency(offer.totalCost);
    elements.summaryPaymentLabel.textContent = offer.paymentLabel;
    elements.summaryPaymentValue.textContent = formatCurrency(offer.payment);
    elements.summaryFeeOut.textContent = formatCurrency(offer.feeAmount);
    elements.summaryNetOut.textContent = formatCurrency(offer.netProceeds);

    if (offer.feePercent <= 0 && isApprovalView) {
      if (elements.feeGridItem) elements.feeGridItem.classList.add('hidden');
      if (elements.netGridItem) elements.netGridItem.classList.add('hidden');
      if (elements.detailsRowFee) elements.detailsRowFee.classList.add('hidden');
    } else {
      if (elements.feeGridItem) elements.feeGridItem.classList.remove('hidden');
      if (elements.netGridItem) elements.netGridItem.classList.remove('hidden');
      if (elements.detailsRowFee) elements.detailsRowFee.classList.remove('hidden');
    }

    if (elements.summaryTermLengthOut) {
      let months = offer.termLengthMonths;
      if (months && months > 0) {
        const rounded = Math.round(months * 2) / 2;
        const display = Number.isInteger(rounded) ? rounded.toString() : rounded.toFixed(1);
        elements.summaryTermLengthOut.textContent = `${display} months`;
      } else {
        elements.summaryTermLengthOut.textContent = '';
      }
    }

    calculatePrepay(offer);
    updateRepDisplay();
  } catch (e) {
    console.error('Calculator error:', e);
  }
}

function checkAuthentication() {
  const params = new URLSearchParams(window.location.search);
  accessToken = params.get('token') || '';
  dashboardUrl = params.get('dashboard') || '';
  
  // For now, we'll allow access if token exists or if not in approval view
  // In production, you'd validate the token against your backend
  const viewMode = params.get('view');
  isApprovalView = (viewMode === 'approval');
  
  if (isApprovalView && !accessToken) {
    // Show auth error
    elements.authCheck.classList.remove('hidden');
    elements.mainCalculator.classList.add('hidden');
    return false;
  }
  
  elements.authCheck.classList.add('hidden');
  elements.mainCalculator.classList.remove('hidden');
  return true;
}

function initializeFromURL() {
  if (!checkAuthentication()) {
    return;
  }

  const params = new URLSearchParams(window.location.search);
  const amountParam = params.get('amount');
  const amount = amountParam ? parseFloat(amountParam) : 50000;
  const factor = params.get('factor') || 1.25;
  const term = params.get('term') || 130;
  const freq = params.get('freq');
  const paramTheme = params.get('theme');
  const paramAccent = params.get('accent');
  const offersParam = params.get('offers');
  const businessNameParam = params.get('businessName') || '';
  const prepayParam = params.get('prepay');

  if (prepayParam) {
    prepayDiscountPercent = parseInt(prepayParam, 10);
  }

  if(paramTheme) currentBaseTheme = paramTheme;
  if(paramAccent) currentAccentClass = paramAccent;
  applyTheme();

  if (isApprovalView) {
    setAmountSliderMax(amount);
    
    // Show dashboard button if URL provided
    if (dashboardUrl) {
      elements.dashboardButtonContainer.classList.remove('hidden');
    }
  } else {
    setAmountSliderMax(1000000);
  }

  elements.calcAmountInput.value = formatCurrency(amount);
  elements.calcAmountSlider.value = amount;
  elements.calcFactorSlider.value = factor;
  elements.calcFactorInput.value = factor;
  elements.calcTermSlider.value = term;
  elements.calcTermInput.value = term;

  if (elements.businessNameInput) elements.businessNameInput.value = businessNameParam;
  updateBranding();

  paymentFrequency = freq || 'daily';
  savedOffers = [];
  
  if (offersParam) {
    try {
      const rawOffers = JSON.parse(offersParam);
      if (Array.isArray(rawOffers)) {
        savedOffers = rawOffers.map((raw) => {
          const a = Number(raw.a ?? raw.amount ?? 0);
          const f = Number(raw.f ?? raw.factor ?? 1.1);
          const tRaw = raw.t ?? raw.term ?? 3;
          const t = parseInt(tRaw, 10);
          const termPayments = Number.isNaN(t) ? 1 : t;
          const q = raw.q ?? raw.frequency ?? 'daily';
          const fe = Number(raw.fee ?? 0);
          return computeOffer(a, f, termPayments, q, fe);
        });
      }
    } catch (err) {
      console.error('Error parsing offers from URL', err);
    }
  }

  if (isApprovalView) {
    if (elements.factorContainer) elements.factorContainer.style.display = 'none';
    if (elements.termContainer) elements.termContainer.style.display = 'none';
    if (elements.toggleContainer) elements.toggleContainer.style.display = 'none';
    if (elements.businessNameContainer) elements.businessNameContainer.style.display = 'none';
    if (elements.businessNameInput) elements.businessNameInput.disabled = true;
    if (elements.calculatorInputs) elements.calculatorInputs.classList.add('hidden');
    if (elements.prepayDateContainer) elements.prepayDateContainer.classList.remove('hidden');
    elements.headerContainer.classList.remove('justify-between');
    elements.headerContainer.classList.add('justify-center');
  } else {
    if (elements.prepayDateContainer) elements.prepayDateContainer.classList.add('hidden');
  }
}

function initializeCalculator() {
  initializeFromURL();
  applyTheme();

  if (elements.calcAmountSlider && elements.calcAmountInput) {
    syncInputs(elements.calcAmountSlider, elements.calcAmountInput, true, 5000, amountSliderMax, runCalculator);
  }
  if (elements.calcFactorSlider && elements.calcFactorInput) {
    syncInputs(elements.calcFactorSlider, elements.calcFactorInput, false, 1.05, 1.7, runCalculator);
  }
  if (elements.calcTermSlider && elements.calcTermInput) {
    syncInputs(elements.calcTermSlider, elements.calcTermInput, false, 1, 528, runCalculator);
  }

  if (elements.toggleDaily) {
    elements.toggleDaily.addEventListener('click', () => {
      paymentFrequency = 'daily';
      updatePaymentToggleUI();
      runCalculator();
    });
  }
  if (elements.toggleWeekly) {
    elements.toggleWeekly.addEventListener('click', () => {
      paymentFrequency = 'weekly';
      updatePaymentToggleUI();
      runCalculator();
    });
  }
  if (elements.toggleMonthly) {
    elements.toggleMonthly.addEventListener('click', () => {
      paymentFrequency = 'monthly';
      updatePaymentToggleUI();
      runCalculator();
    });
  }

  if (elements.businessNameInput) {
    elements.businessNameInput.addEventListener('input', runCalculator);
  }

  if (elements.togglePrepay) {
    elements.togglePrepay.addEventListener('click', () => {
      elements.prepayContainer.classList.toggle('hidden');
      runCalculator();
    });
  }

  if (elements.prepayDateInput) {
    elements.prepayDateInput.addEventListener('change', () => {
      runCalculator();
    });
  }

  if (elements.viewAmortizationBtn) {
    elements.viewAmortizationBtn.addEventListener('click', () => {
      const currentOffer = getCurrentOffer();
      renderAmortizationSchedule(currentOffer);
      elements.amortizationModal.classList.remove('hidden');
    });
  }

  if (elements.closeAmortizationBtn) {
    elements.closeAmortizationBtn.addEventListener('click', () => {
      elements.amortizationModal.classList.add('hidden');
    });
  }

  // Dashboard button handler
  if (elements.dashboardButton) {
    elements.dashboardButton.addEventListener('click', () => {
      if (dashboardUrl) {
        window.location.href = dashboardUrl;
      }
    });
  }

  if (elements.prepayDateInput) {
    const today = new Date().toISOString().split('T')[0];
    elements.prepayDateInput.value = today;
  }

  updatePaymentToggleUI();
  runCalculator();
  renderSavedOffers();
}

initializeCalculator();
</script>
</body>
</html>
