<!DOCTYPE html>
<!-- Default theme is set by script -->
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TrustBureau.ai | Offer Calculator</title>
  <!-- Load Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Load Inter font -->
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />
  <!-- REMOVED html2canvas -->
  <style>
    /* Use Inter as the default font */
    body { font-family: 'Inter', sans-serif; }
    
    /* Custom styles for input number fields (hide arrows) */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }
    input[type=number] { -moz-appearance: textfield; }
    
    /* Helper for icon positioning */
    .input-icon { 
      top: 50%; 
      transform: translateY(-50%); 
    }
    
    /********************************/
    /* === BASE THEME SYSTEM === */
    /********************************/
    
    /* 1. Slate (Dark) */
    html.theme-slate {
      --bg-body: #111827; /* gray-900 */
      --bg-card: #1f2937; /* gray-800 */
      --bg-card-inner: #374151; /* gray-700 */
      --bg-slider-track: #4b5563; /* gray-600 */
      --bg-input: #1f2937;
      --bg-toggle-inactive: #4b5563;
      --border-primary: #4b5563;
      --text-primary: #f9fafb; /* gray-50 */
      --text-secondary: #e5e7eb; /* gray-200 */
      --text-muted: #d1d5db; /* gray-300 */
    }
    html.theme-slate body {
      background-color: var(--bg-body);
    }

    /* 2. Carbon (Black) */
    html.theme-carbon {
      --bg-body: #050505;
      --bg-card: #080808;
      --bg-card-inner: #121212;
      --bg-slider-track: #222222;
      --bg-input: #080808;
      --bg-toggle-inactive: #222222;
      --border-primary: #222222;
      --text-primary: #e0e0e0;
      --text-secondary: #c7c7c7;
      --text-muted: #a8a8a8;
    }
    html.theme-carbon body {
      background-color: var(--bg-body);
    }
    
    /* 3. Corporate (Light) */
    html.theme-corporate {
      --bg-body: #f3f4f6; /* gray-100 */
      --bg-card: #ffffff;
      --bg-card-inner: #f9fafb; /* gray-50 */
      --bg-slider-track: #e5e7eb; /* gray-200 */
      --bg-input: #ffffff;
      --bg-toggle-inactive: #e5e7eb;
      --border-primary: #e5e7eb;
      --text-primary: #111827; /* gray-900 */
      --text-secondary: #374151; /* gray-700 */
      --text-muted: #6b7280; /* gray-500 */
    }
    html.theme-corporate body {
      background-color: var(--bg-body);
    }

    /********************************/
    /* === ACCENT COLOR SYSTEM === */
    /********************************/

    /* 1. Blue */
    html.accent-blue {
      --accent-color: #3b82f6; /* blue-500 */
      --accent-color-light: #60a5fa; /* blue-400 */
      --accent-color-dark: #2563eb; /* blue-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(59, 130, 246, 0.5); /* blue glow */
      --button-text-color: #ffffff; 
    }
    
    /* 2. Green */
    html.accent-green {
      --accent-color: #22c55e; /* green-500 */
      --accent-color-light: #4ade80; /* green-400 */
      --accent-color-dark: #16a34a; /* green-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(34, 197, 94, 0.5); /* green glow */
      --button-text-color: #ffffff; 
    }

    /* 3. Cyan */
    html.accent-cyan {
      --accent-color: #06b6d4; /* cyan-500 */
      --accent-color-light: #22d3ee; /* cyan-400 */
      --accent-color-dark: #0891b2; /* cyan-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(6, 182, 212, 0.5); /* cyan glow */
      --button-text-color: #111827; /* Dark text */
    }

    /* 4. Red */
    html.accent-red {
      --accent-color: #ef4444; /* red-500 */
      --accent-color-light: #f87171; /* red-400 */
      --accent-color-dark: #dc2626; /* red-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(239, 68, 68, 0.5); /* red glow */
      --button-text-color: #ffffff; 
    }
    
    /* 5. Gray */
    html.accent-gray {
      --accent-color: #6b7280; /* gray-500 */
      --accent-color-light: #9ca3af; /* gray-400 */
      --accent-color-dark: #4b5563; /* gray-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(107, 114, 128, 0.5); /* gray glow */
      --button-text-color: #ffffff; 
    }

    /* 6. Purple */
    html.accent-purple {
      --accent-color: #8b5cf6; /* violet-500 */
      --accent-color-light: #a78bfa; /* violet-400 */
      --accent-color-dark: #7c3aed; /* violet-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(139, 92, 246, 0.5); /* purple glow */
      --button-text-color: #ffffff; 
    }

    /* 7. Orange */
    html.accent-orange {
      --accent-color: #f97316; /* orange-500 */
      --accent-color-light: #fb923c; /* orange-400 */
      --accent-color-dark: #ea580c; /* orange-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(249, 115, 22, 0.5); /* orange glow */
      --button-text-color: #ffffff; 
    }

    /* 8. Teal */
    html.accent-teal {
      --accent-color: #14b8a6; /* teal-500 */
      --accent-color-light: #2dd4bf; /* teal-400 */
      --accent-color-dark: #0d9488; /* teal-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(20, 184, 166, 0.5); /* teal glow */
      --button-text-color: #ffffff; 
    }
    
    /* 9. Indigo */
    html.accent-indigo {
      --accent-color: #6366f1; /* indigo-500 */
      --accent-color-light: #818cf8; /* indigo-400 */
      --accent-color-dark: #4f46e5; /* indigo-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(99, 102, 241, 0.5); /* indigo glow */
      --button-text-color: #ffffff; 
    }

    /* 10. Pink */
    html.accent-pink {
      --accent-color: #ec4899; /* pink-500 */
      --accent-color-light: #f472b6; /* pink-400 */
      --accent-color-dark: #db2777; /* pink-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(236, 72, 153, 0.5); /* pink glow */
      --button-text-color: #111827; /* Dark text */
    }

    /* 11. Yellow */
    html.accent-yellow {
      --accent-color: #eab308; /* yellow-500 */
      --accent-color-light: #fde047; /* yellow-400 */
      --accent-color-dark: #ca8a04; /* yellow-600 */
      --accent-text-inverted: #ffffff;
      --accent-shadow: 0 0 15px rgba(234, 179, 8, 0.5); /* yellow glow */
      --button-text-color: #111827; /* Dark text */
    }

    /* === THEME-AWARE CLASSES === */
    /* Apply variables to semantic classes */
    
    body {
      transition: background-color 0.2s;
    }
    .card-bg {
      background-color: var(--bg-card);
      border-color: var(--border-primary);
    }
    .card-inner-bg {
      background-color: var(--bg-card-inner);
      border: 1px solid var(--border-primary);
    }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-muted { color: var(--text-muted); }
    .border-primary { border-color: var(--border-primary); }
    
    /* These classes now pull from the accent system */
    .text-accent { color: var(--accent-color); }
    
    .slider-track {
      background-color: var(--bg-slider-track);
    }
    .slider-thumb {
      accent-color: var(--accent-color);
    }
    
    .input-field {
      background-color: var(--bg-input);
      border-color: var(--border-primary);
      color: var(--text-primary);
    }
    .input-field:focus-within, .input-field:focus {
        border-color: var(--accent-color);
        /* Stronger focus ring */
        box-shadow: 0 0 0 2px var(--accent-color-light);
    }
    
    /* Special class for the hero text */
    .text-hero {
      color: var(--accent-color);
      text-shadow: var(--accent-shadow);
    }
    
    .toggle-inactive {
      background-color: var(--bg-toggle-inactive);
      color: var(--text-secondary);
    }
    .toggle-active {
      background-color: var(--accent-color-dark);
      color: var(--accent-text-inverted);
    }
    .header-icon {
      color: var(--accent-color);
    }

    /* NEW: Primary Button Style */
    .button-primary {
      background-color: var(--accent-color);
      color: var(--button-text-color); /* UPDATED */
      font-weight: 600; /* semibold */
      border-radius: 0.5rem; /* rounded-lg */
      padding: 0.5rem 1.5rem; /* py-2 px-6 */
      transition: background-color 0.2s;
    }
    .button-primary:hover {
      background-color: var(--accent-color-dark);
    }
    .button-primary:disabled {
      background-color: var(--bg-slider-track);
      color: var(--text-muted);
      cursor: not-allowed;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 transition-colors duration-200">
  
  <!-- Main Card -->
  <div class="w-full max-w-xl card-bg text-primary rounded-xl shadow-lg p-4 md:p-6 space-y-4 border">
    
    <!-- HEADER -->
    <div id="headerContainer" class="pb-2 border-b border-primary flex items-center justify-between gap-2">
      <div class="flex items-center space-x-2 flex-shrink-0">
        <!-- FIXED SVG: SHIELD LOGO -->
        <svg class="h-6 w-6 header-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75 11.25 15 15 9.75m-3-7.036A11.959 11.959 0 0 1 3.598 6 11.99 11.99 0 0 0 3 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622A11.99 11.99 0 0 0 18.402 6a11.959 11.959 0 0 1-2.036-1.286A11.977 11.977 0 0 0 12 2.75c-2.662 0-5.18.897-7.164 2.464z" />
        </svg>
        <h1 class="text-xl md:text-2xl font-bold text-primary">
          TrustBureau.ai
        </h1>
      </div>

      <!-- Theme/Accent Selectors -->
      <div id="themeControls" class="flex items-center gap-2">
        <select id="themeSelector" class="input-field p-1.5 text-xs rounded-lg border-primary">
          <option value="theme-corporate">Corporate (Light)</option>
          <option value="theme-slate">Slate (Dark)</option>
          <option value="theme-carbon">Carbon (Black)</option>
        </select>
        <select id="accentSelector" class="input-field p-1.5 text-xs rounded-lg border-primary">
          <option value="accent-blue">Blue</option>
          <option value="accent-green">Green</option>
          <option value="accent-cyan">Cyan</option>
          <option value="accent-red">Red</option>
          <option value="accent-purple">Purple</option>
          <option value="accent-gray">Gray</option>
          <option value="accent-orange">Orange</option>
          <option value="accent-teal">Teal</option>
          <option value="accent-indigo">Indigo</option>
          <option value="accent-pink">Pink</option>
          <option value="accent-yellow">Yellow</option>
        </select>
      </div>

    </div>
    <!-- END HEADER -->

    <!-- OFFER CALCULATOR -->
    <div id="calculatorInputs" class="space-y-4 pt-2">
      <!-- Centered Heading -->
      <h2 class="text-base font-semibold text-primary flex items-center justify-center w-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M12 17h.01M15 17h.01M15 14h.01M18 17h.01M18 14h.01M18 11h.01M6 17h.01M6 14h.01M6 11h.01M6 7h.01M3 7h.01M3 11h.01M3 14h.01M3 17h.01M12 3v.01M12 6v.01M12 21v-.01M12 18v-.01" />
        </svg>
        Your Offer Calculator
      </h2>

      <!-- Sliders -->
      <div class="card-inner-bg p-4 rounded-xl shadow-inner space-y-4">
        
        <div id="amountContainer" class="space-y-1">
          <label for="calcAmount" class="block text-xs font-semibold text-muted">Amount You Get ($)</label>
          <!-- Amount Slider -->
          <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000" value="50000" class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb mb-2" />
          <div class="relative group">
            <span class="absolute left-3 input-icon text-muted text-sm">$</span>
            <input id="calcAmountInput" inputmode="numeric" class="w-full p-1.5 pl-8 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <div id="factorContainer" class="space-y-1">
          <label for="calcFactor" class="block text-xs font-semibold text-muted">Factor Rate</label>
          <input id="calcFactorSlider" type="range" min="1.1" max="1.5" step="0.01" value="1.25" class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb" />
          <div class="relative group">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 input-icon text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18 18 6M6 6l12 12" />
            </svg>
            <input id="calcFactorInput" type="number" step="0.01" class="w-full p-1.5 pl-9 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <div id="termContainer" class="space-y-1">
          <label for="calcTerm" class="block text-xs font-semibold text-muted">Term (Months)</label>
          <input id="calcTermSlider" type="range" min="3" max="24" step="1" value="6" class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb" />
          <div class="relative group">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 absolute left-3 input-icon text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z" />
            </svg>
            <input id="calcTermInput" type="number" step="1" class="w-full p-1.5 pl-9 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>
      </div>

      <div id="toggleContainer" class="flex items-center justify-center space-x-2">
        <button id="toggleDaily" class="text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200">
          Daily
        </button>
        <button id="toggleWeekly" class="text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200">
          Weekly
        </button>
        <button id="toggleMonthly" class="text-sm font-semibold px-4 py-1.5 rounded-lg transition-colors duration-200">
          Monthly
        </button>
      </div>
    </div>
    <!-- === END: OFFER CALCULATOR === -->


    <!-- OFFER PRESENTATION CARD -->
    <div id="offerCard" class="card-bg p-4 rounded-lg shadow-md border border-primary">
      <!-- Card Header -->
      <div class="flex justify-center items-center border-b border-primary pb-2 pt-2">
        <h4 class="text-base font-semibold text-primary">
          Your Approved Terms
        </h4>
      </div>

      <!-- Hero Amount -->
      <div class="text-center py-6">
        <span class="text-sm font-semibold text-muted block">You Get</span>
        <span id="summaryAmountOut" class="text-5xl font-semibold block my-2 text-hero">
          $50,000
        </span>
        <span class="text-base font-medium text-secondary block">
          Total Payback:
          <span id="summaryPaybackOut" class="font-semibold text-primary"></span>
        </span>
      </div>

      <!-- Offer Details -->
      <div class="flex justify-center items-center border-b border-primary pb-2">
        <h5 class="text-sm font-semibold text-secondary text-center">Offer Details</h5>
      </div>
      
      <div class="pt-6">
        <div class="grid grid-cols-2 gap-4">
          <div class="text-center">
            <span class="text-xs font-semibold text-muted block">Factor Rate</span>
            <span id="summaryFactorOut" class="text-xl font-semibold text-primary block"></span>
          </div>
          <div class="text-center">
            <span class="text-xs font-semibold text-muted block">Term</span>
            <span id="summaryTermOut" class="text-xl font-semibold text-primary block"></span>
          </div>
          <div class="text-center">
            <span class="text-xs font-semibold text-muted block">Total Cost of Funds</span>
            <span id="summaryCostOut" class="text-xl font-semibold text-primary block"></span>
          </div>
          <!-- DYNAMIC: Payment Column -->
          <div id="summaryPaymentContainer" class="text-center">
            <span id="summaryPaymentLabel" class="text-xs font-semibold text-muted block">Est. Daily Payment</span>
            <span id="summaryPaymentValue" class="text-xl font-semibold text-primary block"></span>
          </div>
        </div>
      </div>
    </div>
    <!-- === END: OFFER PRESENTATION CARD === -->
    
    <!-- BUTTON LOCATION -->
    <div id="buttonContainer" class="pt-4 border-t border-primary">
      <div class="relative flex justify-center">
        <button id="shareLinkButton" class="button-primary flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
          </svg>
          Share Approval Link
        </button>
      </div>
    </div>

  </div>
  <!-- === END: Main Card === -->

  <script>
    // === DOM Elements ===
    const elements = {
      // Sliders
      calcAmountSlider: document.getElementById('calcAmountSlider'),
      calcFactorSlider: document.getElementById('calcFactorSlider'),
      calcTermSlider: document.getElementById('calcTermSlider'),
      
      // Inputs
      calcAmountInput: document.getElementById('calcAmountInput'),
      calcFactorInput: document.getElementById('calcFactorInput'),
      calcTermInput: document.getElementById('calcTermInput'),
      
      // Toggles
      toggleDaily: document.getElementById('toggleDaily'),
      toggleWeekly: document.getElementById('toggleWeekly'),
      toggleMonthly: document.getElementById('toggleMonthly'),
      
      // Theme Elements
      themeSelector: document.getElementById('themeSelector'),
      accentSelector: document.getElementById('accentSelector'),

      // Share Button
      shareLinkButton: document.getElementById('shareLinkButton'),

      // Summary Outputs
      summaryAmountOut: document.getElementById('summaryAmountOut'),
      summaryPaybackOut: document.getElementById('summaryPaybackOut'),
      summaryFactorOut: document.getElementById('summaryFactorOut'),
      summaryTermOut: document.getElementById('summaryTermOut'),
      summaryCostOut: document.getElementById('summaryCostOut'),
      summaryPaymentLabel: document.getElementById('summaryPaymentLabel'),
      summaryPaymentValue: document.getElementById('summaryPaymentValue'),
      
      headerContainer: document.getElementById('headerContainer'),
      themeControls: document.getElementById('themeControls'),
      calculatorInputs: document.getElementById('calculatorInputs'),
      amountContainer: document.getElementById('amountContainer'),
      factorContainer: document.getElementById('factorContainer'),
      termContainer: document.getElementById('termContainer'),
      toggleContainer: document.getElementById('toggleContainer'),
      buttonContainer: document.getElementById('buttonContainer'),
    };

    // === State ===
    let paymentFrequency = 'daily'; // 'daily', 'weekly', or 'monthly'
    let currentTheme = 'theme-corporate';
    let currentAccent = 'accent-blue';
    // Dynamic cap for the amount slider; defaults to 1,000,000 in calculator view
    let amountSliderMax = 1000000;

    // === Utility Functions ===
    
    const formatCurrency = (num) => {
      const numericValue = Number(num);
      if (isNaN(numericValue)) return '$0';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(numericValue);
    };

    const parseFormattedNumber = (val) => {
      if (typeof val !== 'string' || !val) return 0;
      return parseFloat(val.replace(/[\$,]/g, '')) || 0;
    };

    /**
     * Links a slider and a text input, handling formatting and validation.
     */
    function syncInputs(slider, input, isCurrency, min, max, callback) {
      // Set initial value from slider (or from URL via slider)
      const initialValue = parseFloat(slider.value);
      input.value = isCurrency ? formatCurrency(initialValue) : initialValue.toString();
      
      slider.addEventListener('input', () => {
        const val = slider.value;
        input.value = isCurrency ? formatCurrency(val) : val;
        callback();
      });

      input.addEventListener('input', () => {
        let val = isCurrency ? parseFormattedNumber(input.value) : parseFloat(input.value);
        if (!isNaN(val) && val >= min && val <= max) {
          slider.value = val;
          callback();
        } else if (input.value === '') {
          // Don't default to min on every keystroke, just run calc
          callback();
        }
      });

      input.addEventListener('blur', () => {
        let val = isCurrency ? parseFormattedNumber(input.value) : parseFloat(input.value);
        if (isNaN(val) || val < min) val = min;
        if (val > max) val = max;
        slider.value = val;
        // Format on blur
        input.value = isCurrency ? formatCurrency(val) : val.toString();
        callback();
      });
    }

    // === Theme Logic ===
    
    /**
     * Applies the selected theme AND accent to the <html> tag and saves it.
     */
    function applyTheme() {
      document.documentElement.className = `${currentTheme} ${currentAccent}`;
      localStorage.setItem('theme', currentTheme);
      localStorage.setItem('accent', currentAccent);
    }

    /**
     * Sets the initial theme and accent on load from localStorage or defaults.
     */
    function initializeAppearance() {
      // Note: currentTheme and currentAccent are set by initializeFromURL() first
      applyTheme();
      
      // Sync the dropdowns to show the correct selections
      elements.themeSelector.value = currentTheme;
      elements.accentSelector.value = currentAccent;
    }
    
    /**
     * Updates the active state of the payment frequency toggles.
     */
    function updatePaymentToggleUI() {
      const toggles = [elements.toggleDaily, elements.toggleWeekly, elements.toggleMonthly];
      const frequencies = ['daily', 'weekly', 'monthly'];
      
      toggles.forEach((toggle, index) => {
        toggle.classList.remove('toggle-active', 'toggle-inactive');
        if (paymentFrequency === frequencies[index]) {
          toggle.classList.add('toggle-active');
        } else {
          toggle.classList.add('toggle-inactive');
        }
      });
    }
    
    // === Share/URL Logic ===

    /**
     * Reads URL params and sets the initial state of the calculator / approval page.
     */
    function initializeFromURL() {
      const params = new URLSearchParams(window.location.search);
      
      // Get values or set defaults
      const amountParam = params.get('amount');
      const amount = amountParam ? parseFloat(amountParam) : 50000;
      const factor = params.get('factor') || 1.25; 
      const term = params.get('term') || 6;
      const freq = params.get('freq');
      const paramTheme = params.get('theme');
      const paramAccent = params.get('accent');
      const viewMode = params.get('view');

      // Set defaults to Carbon / Yellow
      currentTheme = paramTheme || localStorage.getItem('theme') || 'theme-carbon';
      currentAccent = paramAccent || localStorage.getItem('accent') || 'accent-yellow';
      
      // Set the values in the inputs/state
      elements.calcAmountInput.value = formatCurrency(amount);
      elements.calcAmountSlider.value = amount;
      elements.calcFactorSlider.value = factor;
      elements.calcTermSlider.value = term;
      
      paymentFrequency = freq || 'daily';

      // Cap the amount slider differently in approval view
      if (viewMode === 'approval') {
        // Cap at the approved amount (with a sensible fallback)
        amountSliderMax = amount > 0 ? amount : 50000;
      } else {
        amountSliderMax = 1000000;
      }
      elements.calcAmountSlider.max = amountSliderMax;

      if (viewMode === 'approval') {
        // Hide all calculator inputs except Amount
        elements.factorContainer.style.display = 'none';
        elements.termContainer.style.display = 'none';
        elements.toggleContainer.style.display = 'none';
        
        // Hide header controls and center the logo
        elements.themeControls.style.display = 'none';
        elements.headerContainer.classList.remove('justify-between');
        elements.headerContainer.classList.add('justify-center');
        
        // Hide the share button
        elements.buttonContainer.style.display = 'none';
      }
    }
    
    /**
     * The main calculation function. Runs every time a value changes.
     */
    function runCalculator() {
      try {
        const amount = parseFormattedNumber(elements.calcAmountInput.value);
        const factor = parseFloat(elements.calcFactorInput.value) || 1.1;
        const termMonths = parseInt(elements.calcTermInput.value) || 3;

        const totalPayback = amount * factor;
        const totalCost = totalPayback - amount;
        
        // Correct math using totalPayback
        const monthlyPayment = termMonths > 0 ? totalPayback / termMonths : 0;
        const weeklyPayment = termMonths > 0 ? totalPayback / (termMonths * 4.3333) : 0;
        const dailyPayment = termMonths > 0 ? totalPayback / (termMonths * 22) : 0; 

        elements.summaryAmountOut.textContent = formatCurrency(amount);
        elements.summaryPaybackOut.textContent = formatCurrency(totalPayback);
        elements.summaryFactorOut.textContent = `${factor.toFixed(2)}x`;
        elements.summaryTermOut.textContent = `${termMonths} mo`;
        elements.summaryCostOut.textContent = formatCurrency(totalCost);
        
        switch (paymentFrequency) {
          case 'daily':
            elements.summaryPaymentLabel.textContent = 'Est. Daily Payment';
            elements.summaryPaymentValue.textContent = formatCurrency(dailyPayment);
            break;
          case 'weekly':
            elements.summaryPaymentLabel.textContent = 'Est. Weekly Payment';
            elements.summaryPaymentValue.textContent = formatCurrency(weeklyPayment);
            break;
          case 'monthly':
            elements.summaryPaymentLabel.textContent = 'Est. Monthly Payment';
            elements.summaryPaymentValue.textContent = formatCurrency(monthlyPayment);
            break;
        }
      } catch (e) {
        console.error("Calculator error:", e);
      }
    }

    /**
     * Sets up all event listeners for the entire application.
     */
    function initializeCalculator() {
      // Load from URL first to set initial state
      initializeFromURL();

      // Set initial theme based on URL/localStorage/defaults
      initializeAppearance();

      // Amount slider is now capped by `amountSliderMax` in approval view
      syncInputs(elements.calcAmountSlider, elements.calcAmountInput, true, 5000, amountSliderMax, runCalculator);
      
      // Link Sliders and Inputs (they will pick up values set by initializeFromURL)
      syncInputs(elements.calcFactorSlider, elements.calcFactorInput, false, 1.1, 1.5, runCalculator);
      syncInputs(elements.calcTermSlider, elements.calcTermInput, false, 3, 24, runCalculator);

      // Link Toggle Buttons
      elements.toggleDaily.addEventListener('click', () => {
        paymentFrequency = 'daily';
        updatePaymentToggleUI();
        runCalculator();
      });
      elements.toggleWeekly.addEventListener('click', () => {
        paymentFrequency = 'weekly';
        updatePaymentToggleUI();
        runCalculator();
      });
      elements.toggleMonthly.addEventListener('click', () => {
        paymentFrequency = 'monthly';
        updatePaymentToggleUI();
        runCalculator();
      });

      // Link Theme Selectors
      elements.themeSelector.addEventListener('change', (e) => {
        currentTheme = e.target.value;
        applyTheme();
      });
      elements.accentSelector.addEventListener('change', (e) => {
        currentAccent = e.target.value;
        applyTheme();
      });
      
      // "SHARE LINK" LOGIC - FALLBACK ONLY
      elements.shareLinkButton.addEventListener('click', (e) => {
        const shareBtn = elements.shareLinkButton;
        const originalText = shareBtn.innerText;
        
        // Get current state
        const amount = parseFormattedNumber(elements.calcAmountInput.value);
        const factor = parseFloat(elements.calcFactorInput.value);
        const term = parseInt(elements.calcTermInput.value);
        const freq = paymentFrequency;
        const theme = currentTheme;
        const accent = currentAccent;
        
        // Build the new URL
        const url = new URL(window.location.href);
        const params = new URLSearchParams({
          amount,
          factor,
          term,
          freq,
          theme,
          accent,
          view: 'approval' // The magic parameter
        });
        url.search = params.toString();
        
        // Fallback-only clipboard copy
        const textArea = document.createElement('textarea');
        textArea.value = url.toString();
        textArea.style.position = 'fixed'; // Avoid scrolling
        textArea.style.top = '0';
        textArea.style.left = '0';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
          document.execCommand('copy');
          shareBtn.innerText = 'Copied!';
          setTimeout(() => { shareBtn.innerText = originalText; }, 2000);
        } catch (errFallback) {
          console.error('Fallback copy failed:', errFallback);
          shareBtn.innerText = 'Error';
          setTimeout(() => { shareBtn.innerText = originalText; }, 2000);
        }
        document.body.removeChild(textArea);
      });

      // Run once on load to populate summary from URL/defaults
      updatePaymentToggleUI();
      runCalculator(); 
    }

    // Start the calculator
    initializeCalculator();
  </script>
</body>
</html>
