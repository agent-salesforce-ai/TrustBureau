<!DOCTYPE html>
<html lang="en" class="theme-light">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Funding Calculator | TrustBureau.ai</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z%22 fill=%22%2342D197%22/><path d=%22M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z%22 fill=%22white%22/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter', 'sans-serif'] },
          colors: {
            mint: { 
              500: 'var(--accent-color)', 
              600: 'var(--accent-color-dark)' 
            },
            brand: {
              dark: 'var(--brand-dark)',
              light: 'var(--brand-light)'
            },
            card: 'var(--bg-card)',
            slate: {
                50: 'var(--bg-inner)',
                100: 'var(--border-primary)',
                200: 'var(--border-secondary)',
                300: 'var(--border-strong)',
                400: 'var(--text-muted)',
                500: 'var(--text-secondary)',
                600: 'var(--text-secondary-dark)',
                700: 'var(--text-primary-light)',
                800: 'var(--text-primary)',
                900: 'var(--brand-dark)', 
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Base Variables */
    :root {
      /* Default Light Theme */
      --accent-color: #42D197;
      --accent-color-dark: #2d9668;
      --brand-dark: #0f172a;
      --brand-light: #f8fafc;
      
      --bg-card: #ffffff;
      --bg-inner: #f8fafc;
      
      --border-primary: #f1f5f9;
      --border-secondary: #e2e8f0;
      --border-strong: #cbd5e1;
      
      --text-muted: #94a3b8;
      --text-secondary: #64748b;
      --text-secondary-dark: #475569;
      --text-primary-light: #334155;
      --text-primary: #0f172a;
      
      --accent-text-inverted: #ffffff;
      --bg-slider-track: #e2e8f0;
    }

    body { 
      font-family: 'Inter', sans-serif; 
      background-color: var(--brand-light); 
      color: var(--text-primary); 
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      text-rendering: optimizeLegibility;
      transition: background-color 0.3s ease, color 0.3s ease;
    }

    /* Form Elements */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; margin: 0; 
    }

    .input-field {
      transition: all 0.2s ease;
      background-color: var(--bg-card);
      color: var(--text-primary);
    }
    .input-field:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px rgba(66, 209, 151, 0.2);
      outline: none;
    }

    /* Buttons */
    .button-primary {
      background-color: var(--accent-color);
      color: var(--accent-text-inverted);
      transition: all 0.2s ease;
    }
    .button-primary:hover {
      background-color: var(--accent-color-dark);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .button-secondary {
      background: var(--bg-card);
      border: 1px solid var(--border-secondary);
      color: var(--text-secondary);
      transition: all 0.2s ease;
    }
    .button-secondary:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    /* Tabs */
    .calc-tab {
      position: relative;
      transition: all 0.2s;
    }
    .calc-tab.active {
      color: var(--accent-color);
      background: var(--bg-card);
      border-color: var(--border-secondary);
      border-bottom-color: var(--bg-card);
    }
    .calc-tab.active::after {
      content: '';
      position: absolute;
      top: -1px; left: 0; right: 0;
      height: 3px;
      background: var(--accent-color);
      border-radius: 3px 3px 0 0;
    }

    /* Toggles */
    .toggle-btn.active {
      background: var(--accent-color);
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Custom Switch */
    .switch input:checked + .switch-slider { background-color: var(--accent-color); }
    .switch input:checked + .switch-slider:before { transform: translateX(20px); }

    /* Custom Range Slider */
    .slider {
      -webkit-appearance: none;
      height: 6px;
      background: var(--bg-slider-track);
      border-radius: 999px;
      outline: none;
    }
    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      height: 22px; width: 22px;
      border-radius: 50%;
      background: var(--bg-card);
      border: 2px solid var(--accent-color);
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: transform 0.1s;
      margin-top: -8px; /* Alignment fix */
    }
    .slider::-webkit-slider-thumb:hover { transform: scale(1.1); }
    
    /* Dark Theme Slider Variant */
    .slider-dark {
      background: rgba(255, 255, 255, 0.15); 
    }
    .slider-dark::-webkit-slider-thumb {
        border-width: 0;
        box-shadow: 0 0 0 4px rgba(255,255,255,0.1);
        background: var(--accent-color);
    }
    .slider-dark::-webkit-slider-thumb:hover {
        transform: scale(1.1);
        box-shadow: 0 0 0 6px rgba(255,255,255,0.2);
    }
    
    /* Firefox slider fixes */
    .slider::-moz-range-track {
        height: 6px;
        background: var(--bg-slider-track);
        border-radius: 999px;
    }
    .slider::-moz-range-thumb {
        height: 22px; width: 22px;
        border-radius: 50%;
        background: var(--bg-card);
        border: 2px solid var(--accent-color);
        cursor: pointer;
        box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    /* Charts */
    .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 100%; }
    .circle-bg { fill: none; stroke: var(--border-secondary); stroke-width: 2.5; }
    .circle { 
      fill: none; 
      stroke-width: 2.5; 
      stroke-linecap: round; 
      stroke: var(--accent-color); 
      transition: stroke-dasharray 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Table */
    .amort-table th { position: sticky; top: 0; background: var(--bg-card); z-index: 10; }
    
    /* Animations */
    .fade-enter { animation: fadeIn 0.3s ease-in-out; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    .toast {
      transform: translateY(100%);
      transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .toast.show { transform: translateY(0); }
    
    /* Color Picker Input Override */
    input[type="color"] {
        -webkit-appearance: none;
        border: none;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        padding: 0;
        overflow: hidden;
        cursor: pointer;
    }
    input[type="color"]::-webkit-color-swatch-wrapper { padding: 0; }
    input[type="color"]::-webkit-color-swatch { border: none; border-radius: 50%; }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8 flex justify-center transition-colors duration-300">

  <!-- WRAPPER -->
  <div class="w-full max-w-7xl">

      <!-- ========================================== -->
      <!-- ADMIN PANEL (Calculator Input View)        -->
      <!-- ========================================== -->
      <div id="adminPanel">
          <!-- HEADER -->
          <header class="flex flex-col md:flex-row items-center justify-between gap-4 mb-8">
            <div class="flex items-center gap-3">
                <div class="bg-card p-2 rounded-xl shadow-sm border border-slate-100">
                    <!-- Logo uses accent color -->
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="var(--accent-color)" /><path d="M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" fill="#ffffff" /></svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-slate-800 tracking-tight">Funding Calculator</h1>
                    <p class="text-xs text-slate-500 font-medium">TrustBureau.ai</p>
                </div>
            </div>
            <div class="flex gap-3 w-full md:w-auto">
                <!-- Theme Button (More Obvious) -->
                <button onclick="openThemeModal()" class="button-secondary px-5 py-2.5 rounded-xl shadow-sm flex items-center justify-center gap-2 font-semibold hover:text-mint-500 group">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-400 group-hover:text-mint-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01" /></svg>
                    Theme
                </button>
                <button onclick="resetCalculator()" class="button-secondary flex-1 md:flex-none px-5 py-2.5 rounded-xl text-sm font-semibold shadow-sm">Reset</button>
                <button onclick="previewClientView()" class="button-secondary flex-1 md:flex-none px-5 py-2.5 rounded-xl text-sm font-semibold shadow-sm flex items-center justify-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                    Preview
                </button>
                <button onclick="shareOffer()" class="button-primary flex-1 md:flex-none px-5 py-2.5 rounded-xl text-sm font-semibold shadow-lg shadow-mint-500/20">Create & Share</button>
            </div>
          </header>

          <!-- ADMIN GRID -->
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
              
              <!-- LEFT: INPUTS (7 Columns) -->
              <div class="lg:col-span-7 space-y-6">
                
                <!-- Client Info Card -->
                <div class="bg-card rounded-2xl border border-slate-200 shadow-sm p-6 transition-colors">
                    <div class="flex justify-between items-center mb-5">
                       <div class="flex items-center gap-2">
                           <span class="w-1 h-6 bg-mint-500 rounded-full"></span>
                           <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">Client Information</h3>
                       </div>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-500 mb-1.5 ml-1">Business Name</label>
                            <input id="calcBusinessName" type="text" class="w-full p-3 border border-slate-200 rounded-xl input-field text-sm font-medium" placeholder="e.g. Acme Corporation LLC" value="Acme Corporation LLC" />
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1.5 ml-1">Contact Name</label>
                                <input id="calcContactName" type="text" class="w-full p-3 border border-slate-200 rounded-xl input-field text-sm font-medium" placeholder="First Last" value="First Last" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold text-slate-500 mb-1.5 ml-1">Email Address</label>
                                <input id="calcEmail" type="email" class="w-full p-3 border border-slate-200 rounded-xl input-field text-sm font-medium" placeholder="name@company.com" value="name@company.com" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Terms Card -->
                <div class="bg-card rounded-2xl border border-slate-200 shadow-sm p-6 transition-colors">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <span class="w-1 h-6 bg-mint-500 rounded-full"></span>
                            <h3 class="text-sm font-bold text-slate-700 uppercase tracking-wider">Structure Offer</h3>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="flex gap-2 border-b border-slate-200 mb-6 px-1">
                        <button id="tab-btn-0" class="calc-tab active px-4 py-2 text-sm font-semibold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(0)">Option A</button>
                        <button id="tab-btn-1" class="calc-tab hidden px-4 py-2 text-sm font-semibold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(1)">Option B</button>
                        <button id="tab-btn-2" class="calc-tab hidden px-4 py-2 text-sm font-semibold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(2)">Option C</button>
                        <button id="add-tab-btn" class="ml-auto text-xs font-bold text-mint-500 hover:text-mint-600 px-3 py-2" onclick="addCalcOption()">+ Add Option</button>
                    </div>
                    
                    <div class="space-y-8 fade-enter">
                        <!-- Main Sliders -->
                        <div class="bg-slate-50 rounded-xl p-5 border border-slate-100">
                            <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-slate-500 uppercase">Funding Amount</label>
                                <button id="remove-option-btn" onclick="removeCalcOption()" class="text-xs text-red-500 hidden font-bold hover:underline">Remove This Option</button>
                            </div>
                            <div class="flex items-baseline gap-1 mb-3">
                                <span class="text-slate-400 font-medium text-lg">$</span>
                                <input id="calcAmount" type="text" class="w-full bg-transparent border-none p-0 text-3xl font-extrabold text-slate-800 focus:ring-0" value="50,000" />
                            </div>
                            <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000" value="50000" class="slider w-full h-2" />
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">Factor Rate</label>
                                <div class="flex items-center justify-between mb-3 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    <input id="calcFactor" type="number" step="0.01" class="bg-transparent font-bold text-slate-800 outline-none w-20" value="1.25" />
                                    <span class="text-xs text-slate-400 font-bold bg-card px-2 py-1 rounded border border-slate-100">PTR</span>
                                </div>
                                <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25" class="slider w-full" />
                            </div>
                            <div>
                                <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">Term Length</label>
                                <div class="flex items-center justify-between mb-3 bg-slate-50 p-2 rounded-lg border border-slate-100">
                                    <input id="calcTerm" type="number" class="bg-transparent font-bold text-slate-800 outline-none w-20" value="130" />
                                    <span class="text-xs text-slate-400 font-bold bg-card px-2 py-1 rounded border border-slate-100">Pmts</span>
                                </div>
                                <input id="calcTermSlider" type="range" min="5" max="520" step="1" value="130" class="slider w-full" />
                            </div>
                        </div>

                        <div>
                            <label class="text-xs font-bold text-slate-500 uppercase mb-3 block">Payment Frequency</label>
                            <div class="toggle-group inline-flex bg-slate-100 p-1 rounded-xl w-full border border-slate-200">
                                <button class="toggle-btn active flex-1 py-2.5 rounded-lg text-sm font-medium transition-all" data-freq="daily" onclick="setFrequency('daily')">Daily</button>
                                <button class="toggle-btn flex-1 py-2.5 rounded-lg text-sm font-medium transition-all" data-freq="weekly" onclick="setFrequency('weekly')">Weekly</button>
                                <button class="toggle-btn flex-1 py-2.5 rounded-lg text-sm font-medium transition-all" data-freq="monthly" onclick="setFrequency('monthly')">Monthly</button>
                            </div>
                        </div>

                        <div class="border-t border-slate-100 my-4"></div>
                        
                        <!-- Advanced Toggles Grid -->
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <!-- Fee -->
                            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 transition-all hover:border-mint-500/50">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-slate-700">Origination Fee</span>
                                    <label class="switch relative inline-block w-11 h-6">
                                        <input id="toggleFee" type="checkbox" onchange="toggleSection('Fee', this.checked)">
                                        <span class="switch-slider absolute cursor-pointer inset-0 bg-slate-300 rounded-full transition-all before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-card before:rounded-full before:transition-all"></span>
                                    </label>
                                </div>
                                <div id="secFee" class="hidden mt-4 pt-3 border-t border-slate-200">
                                    <div class="flex items-center gap-2 mb-2">
                                        <input id="calcFee" type="number" step="0.5" min="0" max="15" class="w-16 bg-card border border-slate-300 rounded p-1 text-sm font-bold text-center outline-none focus:border-mint-500" value="0" />
                                        <span class="text-sm font-bold text-slate-500">%</span>
                                    </div>
                                    <input id="calcFeeSlider" type="range" min="0" max="15" step="0.5" value="0" class="slider h-1 w-full" />
                                </div>
                            </div>

                            <!-- Prepay -->
                            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 transition-all hover:border-mint-500/50">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-slate-700">Prepay Discount</span>
                                    <label class="switch relative inline-block w-11 h-6">
                                        <input id="togglePrepay" type="checkbox" onchange="toggleSection('Prepay', this.checked)">
                                        <span class="switch-slider absolute cursor-pointer inset-0 bg-slate-300 rounded-full transition-all before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-card before:rounded-full before:transition-all"></span>
                                    </label>
                                </div>
                                <div id="secPrepay" class="hidden mt-4 pt-3 border-t border-slate-200">
                                    <div class="flex items-center gap-2 mb-2">
                                        <input id="calcPrepay" type="number" step="1" min="0" max="50" class="w-16 bg-card border border-slate-300 rounded p-1 text-sm font-bold text-center outline-none focus:border-mint-500" value="0" />
                                        <span class="text-sm font-bold text-slate-500">%</span>
                                    </div>
                                    <input id="calcPrepaySlider" type="range" min="0" max="50" step="1" value="0" class="slider h-1 w-full" />
                                </div>
                            </div>

                            <!-- Custom Label -->
                            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-slate-700">Custom Term Label</span>
                                    <label class="switch relative inline-block w-11 h-6">
                                        <input id="toggleOverride" type="checkbox" onchange="toggleSection('Override', this.checked)">
                                        <span class="switch-slider absolute cursor-pointer inset-0 bg-slate-300 rounded-full transition-all before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-card before:rounded-full before:transition-all"></span>
                                    </label>
                                </div>
                                <div id="secOverride" class="hidden mt-3">
                                    <input id="calcTermOverride" type="text" class="w-full bg-card border border-slate-300 rounded-lg p-2 text-xs" placeholder="e.g. 6 Months" />
                                </div>
                            </div>

                            <!-- Expiry -->
                            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-slate-700">Offer Expiration</span>
                                    <label class="switch relative inline-block w-11 h-6">
                                        <input id="toggleExpiry" type="checkbox" onchange="toggleSection('Expiry', this.checked)">
                                        <span class="switch-slider absolute cursor-pointer inset-0 bg-slate-300 rounded-full transition-all before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-card before:rounded-full before:transition-all"></span>
                                    </label>
                                </div>
                                <div id="secExpiry" class="hidden mt-3">
                                    <input id="calcExpiryDate" type="date" class="w-full bg-card border border-slate-300 rounded-lg p-2 text-xs" />
                                </div>
                            </div>

                            <!-- Offer Notes (Renamed from Additional Terms) -->
                            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 transition-all hover:border-mint-500/50">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-slate-700">Offer Notes</span>
                                    <label class="switch relative inline-block w-11 h-6">
                                        <input id="toggleNotes" type="checkbox" onchange="toggleSection('Notes', this.checked)">
                                        <span class="switch-slider absolute cursor-pointer inset-0 bg-slate-300 rounded-full transition-all before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-card before:rounded-full before:transition-all"></span>
                                    </label>
                                </div>
                                <div id="secNotes" class="hidden mt-3">
                                    <textarea id="calcNotes" class="w-full bg-card border border-slate-300 rounded-lg p-2 text-xs" rows="3" placeholder="Enter specific approval conditions..."></textarea>
                                </div>
                            </div>

                            <!-- Closing Documents (Now Editable) -->
                            <div class="bg-slate-50 rounded-xl p-4 border border-slate-200 transition-all hover:border-mint-500/50">
                                <div class="flex justify-between items-center">
                                    <span class="text-sm font-semibold text-slate-700">Closing Documents</span>
                                    <label class="switch relative inline-block w-11 h-6">
                                        <input id="toggleDocs" type="checkbox" onchange="toggleSection('Docs', this.checked)">
                                        <span class="switch-slider absolute cursor-pointer inset-0 bg-slate-300 rounded-full transition-all before:absolute before:content-[''] before:h-4 before:w-4 before:left-1 before:bottom-1 before:bg-card before:rounded-full before:transition-all"></span>
                                    </label>
                                </div>
                                <div id="secDocs" class="hidden mt-3 pt-2 border-t border-slate-200">
                                    <p class="text-[10px] uppercase font-bold text-slate-400 mb-2">Required Items (One per line)</p>
                                    <textarea id="calcDocs" class="w-full bg-card border border-slate-300 rounded-lg p-2 text-xs font-mono text-slate-600" rows="4">Voided Check
Government Issued ID</textarea>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
              </div>

              <!-- RIGHT: PREVIEW (5 Columns) -->
              <div class="lg:col-span-5 relative">
                  
                  <!-- Admin Preview Container (Sticky Wrapper) -->
                  <div class="sticky top-8 relative mt-6">
                      
                      <!-- Badge Removed -->

                      <!-- Admin Preview Card -->
                      <div class="bg-card rounded-3xl border-4 border-mint-500 shadow-2xl shadow-mint-500/10 overflow-hidden relative z-10">
                        
                        <!-- Merged Header & Hero Numbers -->
                        <div class="p-8 pb-8 text-center bg-brand-dark relative overflow-hidden transition-colors duration-300">
                          <div class="absolute inset-0 bg-gradient-to-br from-black/10 to-black/40 z-0 pointer-events-none"></div>
                          
                          <div class="relative z-10 pt-2">
                            <div id="previewLabelContainer" class="mb-4 hidden">
                                <span id="previewOptionLabel" class="inline-block text-[10px] font-bold text-mint-500 uppercase tracking-widest bg-mint-500/10 px-3 py-1 rounded border border-mint-500/20">Option A</span>
                            </div>
                            <div id="previewBusinessName" class="text-xs font-bold text-[#94a3b8] mt-2 mb-2 hidden"></div>
                            
                            <span class="text-[11px] font-bold text-[#94a3b8] uppercase tracking-widest block mb-2">You Get</span>
                            <span id="previewAmount" class="text-5xl md:text-6xl font-extrabold text-[#ffffff] block tracking-tighter transition-all">$50,000</span>
                          </div>
                        </div>
                        
                        <!-- Visual Chart (Restored) -->
                        <div class="px-8 py-8 flex items-center justify-center gap-6 md:gap-8 bg-card transition-colors">
                           <div class="relative w-36 h-36 flex-shrink-0">
                              <svg viewBox="0 0 36 36" class="circular-chart transform -rotate-90">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path id="previewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                              </svg>
                              <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-[10px] font-bold text-slate-400 uppercase">Payback</span>
                                <span id="previewPaybackChart" class="text-base font-bold text-slate-700 block tracking-tight">$62,500</span>
                              </div>
                           </div>
                           <div class="space-y-3 text-xs">
                               <div class="flex items-center gap-2">
                                 <span class="w-3 h-3 rounded-full bg-mint-500 shadow-sm"></span>
                                 <span class="font-semibold text-slate-600">Principal</span>
                               </div>
                               <div class="flex items-center gap-2">
                                 <span class="w-3 h-3 rounded-full bg-slate-200"></span>
                                 <span class="font-semibold text-slate-600">Cost of Capital</span>
                               </div>
                           </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="border-t border-slate-100 bg-slate-50/50 transition-colors">
                          <div class="grid grid-cols-2 divide-x divide-slate-100 border-b border-slate-100">
                            <div class="p-4 text-center group">
                              <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Term Length</span>
                              <span id="previewTermLength" class="text-sm font-bold text-slate-700 group-hover:text-mint-500 transition-colors">6 months</span>
                            </div>
                            <div class="p-4 text-center group">
                              <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Payments</span>
                              <span id="previewTermPayments" class="text-sm font-bold text-slate-700 group-hover:text-mint-500 transition-colors">130</span>
                            </div>
                          </div>
                          <div class="grid grid-cols-2 divide-x divide-slate-100 border-b border-slate-100">
                            <div class="p-4 text-center group">
                              <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Factor Rate</span>
                              <span id="previewFactor" class="text-sm font-bold text-slate-700 group-hover:text-mint-500 transition-colors">1.25x</span>
                            </div>
                            <div class="p-4 text-center group">
                              <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Total Cost</span>
                              <span id="previewCost" class="text-sm font-bold text-slate-700 group-hover:text-mint-500 transition-colors">$12,500</span>
                            </div>
                          </div>
                          
                          <div id="previewFeeRow" class="grid grid-cols-2 divide-x divide-slate-100 border-b border-slate-100 hidden bg-orange-50/30">
                            <div class="p-4 text-center">
                              <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Origination Fee</span>
                              <span id="previewFeeAmount" class="text-sm font-bold text-slate-700">$0</span>
                            </div>
                            <div class="p-4 text-center">
                              <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Net Proceeds</span>
                              <span id="previewNet" class="text-sm font-bold text-slate-700">$50,000</span>
                            </div>
                          </div>

                          <!-- Payment Box -->
                          <div class="p-6 text-center bg-card border-t border-slate-100 relative overflow-hidden transition-colors">
                            <div class="relative z-10">
                                <span id="previewPaymentLabel" class="text-[10px] font-bold text-slate-400 block uppercase tracking-widest mb-1">Daily Payment</span>
                                <span id="previewPayment" class="text-3xl font-bold tracking-tight text-slate-800">$480.77</span>
                            </div>
                          </div>
                        </div>
                        
                        <div class="p-4 text-center bg-card border-t border-slate-100 transition-colors">
                              <button onclick="openAmortSchedule()" class="text-xs font-bold text-mint-500 hover:text-mint-600 flex items-center justify-center gap-1 mx-auto group">
                                  <span>View Payment Schedule</span>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                              </button>
                        </div>

                      </div>
                  </div>
              </div>
          </div>
      </div>
      
      <!-- ========================================== -->
      <!-- CLIENT PANEL (Client View)                 -->
      <!-- ========================================== -->
      <div id="clientPanel" class="hidden w-full max-w-4xl mx-auto mt-6">
          <div id="clientPreviewBar" class="hidden bg-slate-800 text-white p-4 sticky top-0 z-50 flex justify-between items-center mb-6 rounded-xl shadow-lg ring-1 ring-white/10">
              <span class="font-bold text-sm uppercase tracking-wider text-mint-500 flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                  Preview Mode
              </span>
              <button onclick="exitPreview()" class="text-xs font-bold text-white hover:text-mint-500 bg-white/10 hover:bg-white/20 px-3 py-1.5 rounded transition-colors">Back to Editor</button>
          </div>

          <div class="text-center mb-8">
              <!-- UPDATED BADGE: TRUST BUREAU VERIFIED -->
              <div class="inline-flex items-center gap-2.5 bg-card px-6 py-2.5 rounded-full shadow-xl shadow-slate-200/60 border border-slate-100 mb-6 fade-enter">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 24 24" fill="none">
                      <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="var(--accent-color)" />
                      <path d="M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" fill="#ffffff" />
                  </svg>
                  <span class="text-xs font-extrabold uppercase tracking-widest text-slate-800">Trust Bureau Verified</span>
              </div>
              
              <h1 id="clientGreeting" class="text-3xl font-bold text-slate-800 mb-2">Hello, Business Owner</h1>
              <p class="text-slate-500 max-w-lg mx-auto">Your business <span id="clientBusinessName" class="font-semibold text-slate-700"></span> has been pre-approved for funding.</p>
          </div>

          <!-- CLIENT CARD WRAPPER - EXACT MIRROR OF ADMIN -->
          <div class="max-w-md mx-auto relative"> 

              <div class="bg-card rounded-3xl border-4 border-mint-500 shadow-2xl shadow-mint-500/10 overflow-hidden relative z-10">
                  
                  <!-- HEADER (Dark) -->
                  <div class="p-8 pb-8 text-center bg-brand-dark text-[#ffffff] relative overflow-hidden">
                    <div class="absolute inset-0 bg-gradient-to-br from-slate-800 to-slate-900 z-0"></div>
                    
                    <div class="relative z-10 pt-2">
                      
                      <!-- Tabs / Label -->
                      <div id="clientTabsContainer" class="flex justify-center gap-2 mb-6 hidden">
                          <!-- Injected via JS -->
                      </div>
                      <div id="cPreviewLabelContainer" class="mb-4 hidden">
                          <span id="cPreviewOptionLabel" class="inline-block text-[10px] font-bold text-mint-500 uppercase tracking-widest bg-mint-500/10 px-3 py-1 rounded border border-mint-500/20">Option A</span>
                      </div>

                      <span class="text-[11px] font-bold text-slate-400 uppercase tracking-widest block mb-2">You Get</span>
                      <span id="cPreviewAmount" class="text-5xl md:text-6xl font-extrabold text-[#ffffff] block tracking-tighter transition-all">$50,000</span>
                      
                      <!-- SLIDER (Cleaned up position) -->
                      <div class="mt-8 px-2 relative z-20">
                          <input id="clientAmountSlider" type="range" class="slider slider-dark w-full h-2" />
                          <div class="flex justify-between text-[10px] font-bold text-slate-500 mt-3 uppercase tracking-widest">
                              <span>$5k</span>
                              <span id="clientMaxLabelSlider">Max</span>
                          </div>
                      </div>

                    </div>
                  </div>

                  <!-- Chart Section (Restored) -->
                  <div class="px-8 py-8 flex items-center justify-center gap-6 md:gap-8 bg-card transition-colors">
                     <div class="relative w-36 h-36 flex-shrink-0">
                        <svg viewBox="0 0 36 36" class="circular-chart transform -rotate-90">
                          <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                          <path id="cPreviewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                          <span class="text-[10px] font-bold text-slate-400 uppercase">Payback</span>
                          <span id="cPreviewPayback" class="text-base font-bold text-slate-700 block tracking-tight">$62,500</span>
                        </div>
                     </div>
                     <div class="space-y-3 text-xs">
                         <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-mint-500 shadow-sm"></span><span class="font-semibold text-slate-600">Principal</span></div>
                         <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-slate-200"></span><span class="font-semibold text-slate-600">Cost of Capital</span></div>
                     </div>
                  </div>

                  <!-- STATS GRID -->
                  <div class="border-t border-slate-100 bg-slate-50/50 transition-colors">
                      <div class="grid grid-cols-2 divide-x divide-slate-100 border-b border-slate-100">
                        <div class="p-4 text-center group">
                          <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Term Length</span>
                          <span id="cPreviewTerm" class="text-sm font-bold text-slate-700 group-hover:text-mint-500 transition-colors">6 months</span>
                        </div>
                        <div class="p-4 text-center group">
                          <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Payments</span>
                          <span id="cPreviewCount" class="text-sm font-bold text-slate-700 group-hover:text-mint-500 transition-colors">130</span>
                        </div>
                      </div>
                      <div class="grid grid-cols-2 divide-x divide-slate-100 border-b border-slate-100">
                        <div class="p-4 text-center group">
                          <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Factor Rate</span>
                          <span id="previewFactor" class="text-sm font-bold text-slate-700 group-hover:text-mint-500 transition-colors">1.25x</span>
                        </div>
                        <div class="p-4 text-center group">
                          <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Total Cost</span>
                          <span id="previewCost" class="text-sm font-bold text-slate-700 group-hover:text-mint-500 transition-colors">$12,500</span>
                        </div>
                      </div>
                      
                      <div id="cPreviewFeeRow" class="grid grid-cols-2 divide-x divide-slate-100 border-b border-slate-100 hidden bg-orange-50/30">
                        <div class="p-4 text-center">
                          <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Origination Fee</span>
                          <span id="cPreviewFee" class="text-sm font-bold text-slate-700">$0</span>
                        </div>
                        <div class="p-4 text-center">
                          <span class="text-[10px] font-bold text-slate-400 block uppercase mb-1">Net Proceeds</span>
                          <span id="cPreviewNet" class="text-sm font-bold text-slate-700">$50,000</span>
                        </div>
                      </div>

                      <div class="p-6 text-center bg-card border-t border-slate-100 relative overflow-hidden transition-colors">
                          <div class="relative z-10">
                              <span id="cPreviewPaymentLabel" class="text-[10px] font-bold text-slate-400 block uppercase tracking-widest mb-1">Daily Payment</span>
                              <span id="cPreviewPayment" class="text-3xl font-bold tracking-tight text-slate-800">$480.77</span>
                          </div>
                      </div>
                  </div>

                  <!-- VIEW PAYMENT SCHEDULE (Re-added to match Admin) -->
                  <div class="p-4 text-center bg-card border-t border-slate-100 transition-colors">
                      <button onclick="openAmortSchedule()" class="text-xs font-bold text-mint-500 hover:text-mint-600 flex items-center justify-center gap-1 mx-auto group">
                          <span>View Payment Schedule</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
                      </button>
                  </div>

                  <!-- BUTTON FOOTER -->
                  <div class="bg-card p-6 border-t border-slate-100 transition-colors">
                      <button onclick="acceptOffer()" class="relative w-full button-primary py-3 rounded-xl text-base font-bold shadow-lg shadow-mint-500/10 hover:shadow-mint-500/30 transform hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2">
                          <span>Accept Offer</span>
                      </button>
                      <p class="text-center text-[10px] text-slate-400 mt-3">Clicking accept is non-binding.</p>
                  </div>

              </div>

              <!-- OTHER OPTIONS CARDS (New Section) -->
              <div id="clientOtherOptionsContainer" class="mt-6 grid grid-cols-2 gap-4 hidden">
                  <!-- Injected via JS -->
              </div>

              <!-- TERMS & DOCUMENTS (Grid Layout Below Card) -->
              <div id="clientTermsContainer" class="mt-12 px-2 max-w-2xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-8 hidden">
                  
                  <!-- Left: Offer Notes -->
                  <div id="clientTermsCol">
                      <h4 class="font-bold text-xs text-slate-400 mb-3 uppercase tracking-widest border-b border-slate-200 pb-2">Offer Notes</h4>
                      <ul class="space-y-3 text-xs text-slate-500">
                          <li id="clientExpiryRow" class="hidden flex items-start gap-2">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-orange-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                              <span>Offer expires on <span id="clientExpiryDate" class="font-bold text-slate-700"></span>.</span>
                          </li>
                          <li id="clientNotesRow" class="hidden flex items-start gap-2">
                              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-500 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                              <span class="italic"><span class="font-semibold text-slate-700 not-italic">Note:</span> <span id="clientNotesText"></span></span>
                          </li>
                          <li id="clientNoTermsRow" class="hidden text-slate-400 italic">Standard terms apply. No additional stipulations.</li>
                      </ul>
                  </div>

                  <!-- Right: Closing Documents (Dynamic) -->
                  <div id="clientDocsCol" class="hidden">
                      <h4 class="font-bold text-xs text-slate-400 mb-3 uppercase tracking-widest border-b border-slate-200 pb-2">Closing Documents</h4>
                      <ul id="clientDocsList" class="space-y-3 text-xs text-slate-500">
                          <!-- Injected via JS -->
                      </ul>
                  </div>

              </div>

          </div>
      </div>

      <!-- THEME MODAL -->
      <div id="themeModal" class="modal-overlay fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
        <!-- FIXED: Changed bg-white to bg-card -->
        <div class="bg-card rounded-2xl w-full max-w-md shadow-2xl p-6 max-h-[90vh] overflow-y-auto transition-colors duration-300">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-lg font-bold text-slate-800">Theme Settings</h3>
                <button onclick="$('themeModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">&times;</button>
            </div>
            
            <!-- PRESETS -->
            <div class="mb-8">
                <label class="block text-xs font-bold text-slate-500 uppercase mb-3">Presets</label>
                
                <!-- Dark Themes (Updated to AMOLED/Neutral) -->
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Dark / AMOLED</p>
                <div class="grid grid-cols-5 gap-2 mb-4">
                    <!-- Mint Night: Black BG, Neutral Dark Header -->
                    <button type="button" onclick="setTheme('#42D197', '#121212', '#000000')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #000000; border-color: #42D197;" title="Mint Night"></button>
                    <!-- Cyber Blue: Black BG, Neutral Header -->
                    <button type="button" onclick="setTheme('#00e1ff', '#121212', '#000000')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #000000; border-color: #00e1ff;" title="Cyber Blue"></button>
                    <!-- Neon Purple -->
                    <button type="button" onclick="setTheme('#d946ef', '#121212', '#000000')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #000000; border-color: #d946ef;" title="Neon Purple"></button>
                    <!-- Luxury Gold -->
                    <button type="button" onclick="setTheme('#fbbf24', '#1c1917', '#000000')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #000000; border-color: #fbbf24;" title="Luxury Gold"></button>
                    <!-- Crimson Red -->
                    <button type="button" onclick="setTheme('#f43f5e', '#121212', '#000000')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #000000; border-color: #f43f5e;" title="Crimson Red"></button>
                </div>

                <!-- Light Themes -->
                <p class="text-[10px] text-slate-400 uppercase font-bold mb-2">Light</p>
                <div class="grid grid-cols-5 gap-2">
                    <button type="button" onclick="setTheme('#42D197', '#0f172a', '#f8fafc')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #f8fafc; border-color: #42D197;" title="Trust Mint"></button>
                    <button type="button" onclick="setTheme('#3b82f6', '#1e3a8a', '#eff6ff')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #eff6ff; border-color: #3b82f6;" title="Ocean Blue"></button>
                    <button type="button" onclick="setTheme('#10b981', '#064e3b', '#f0fdf4')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #f0fdf4; border-color: #10b981;" title="Forest Green"></button>
                    <button type="button" onclick="setTheme('#f97316', '#7c2d12', '#fff7ed')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #fff7ed; border-color: #f97316;" title="Sunset Orange"></button>
                    <button type="button" onclick="setTheme('#8b5cf6', '#4c1d95', '#f5f3ff')" class="h-8 w-full rounded-lg border border-slate-200 shadow-sm transition-transform hover:scale-105" style="background: #f5f3ff; border-color: #8b5cf6;" title="Royal Violet"></button>
                </div>
            </div>

            <!-- CUSTOM PICKERS -->
            <div class="space-y-6 border-t border-slate-100 pt-6">
                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Primary Accent</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="accentColorPicker" class="rounded-full h-10 w-10 cursor-pointer shadow-sm border border-slate-200" value="#42D197" oninput="updateThemeColor('accent', this.value)">
                        <span id="accentColorValue" class="text-sm font-mono text-slate-600 bg-slate-50 px-2 py-1 rounded">#42D197</span>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Brand Dark (Headers)</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="darkColorPicker" class="rounded-full h-10 w-10 cursor-pointer shadow-sm border border-slate-200" value="#0f172a" oninput="updateThemeColor('dark', this.value)">
                        <span id="darkColorValue" class="text-sm font-mono text-slate-600 bg-slate-50 px-2 py-1 rounded">#0f172a</span>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Background</label>
                    <div class="flex items-center gap-3">
                        <input type="color" id="lightColorPicker" class="rounded-full h-10 w-10 cursor-pointer shadow-sm border border-slate-200" value="#f8fafc" oninput="updateThemeColor('light', this.value)">
                        <span id="lightColorValue" class="text-sm font-mono text-slate-600 bg-slate-50 px-2 py-1 rounded">#f8fafc</span>
                    </div>
                </div>
            </div>

            <div class="mt-8 pt-4 border-t border-slate-100">
                 <button onclick="resetTheme()" class="w-full py-2 text-sm font-bold text-slate-500 hover:text-slate-700 bg-slate-50 hover:bg-slate-100 rounded-lg transition-colors">Reset to Default</button>
            </div>
        </div>
      </div>

  </div> <!-- End Wrapper -->

  <!-- MODAL: SUCCESS -->
  <div id="successModal" class="modal-overlay fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <!-- FIXED: Changed bg-white to bg-card -->
    <div class="bg-card rounded-3xl w-full max-w-md shadow-2xl p-8 text-center relative overflow-hidden">
      <!-- Decorative Confetti BG -->
      <div class="absolute inset-0 bg-gradient-to-b from-mint-500/5 to-transparent pointer-events-none"></div>
      
      <div class="w-16 h-16 bg-mint-500/10 rounded-full flex items-center justify-center mx-auto mb-6 relative z-10">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-mint-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
      </div>
      
      <h3 class="text-2xl font-bold text-slate-800 mb-3 relative z-10">Offer Accepted!</h3>
      <p class="text-slate-600 mb-8 relative z-10">Great news! Your pre-approval has been registered. Please contact your funding representative immediately to finalize the documents and receive your funds.</p>
      
      <div class="relative z-10">
          <button onclick="$('successModal').classList.add('hidden')" class="w-full button-primary py-3 rounded-xl font-bold shadow-lg shadow-mint-500/20">
              Close
          </button>
      </div>
    </div>
  </div>

  <!-- MODAL: AMORTIZATION -->
  <div id="amortModal" class="modal-overlay fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <!-- FIXED: Changed bg-white to bg-card -->
    <div class="bg-card rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden max-h-[80vh] flex flex-col">
      <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-slate-50">
          <h3 class="font-bold text-slate-800">Payment Schedule</h3>
          <button onclick="$('amortModal').classList.add('hidden')" class="text-slate-400 hover:text-slate-600">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
      </div>
      <div class="overflow-y-auto p-0 flex-1">
          <table class="w-full text-sm amort-table">
              <thead class="bg-slate-50 text-slate-500">
                  <tr>
                      <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">#</th>
                      <th class="px-6 py-3 text-left text-xs font-bold uppercase tracking-wider">Date</th>
                      <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider">Payment</th>
                      <th class="px-6 py-3 text-right text-xs font-bold uppercase tracking-wider">Balance</th>
                  </tr>
              </thead>
              <tbody id="amortTableBody" class="divide-y divide-slate-100 bg-white"></tbody>
          </table>
      </div>
    </div>
  </div>

  <!-- MODAL: SHARE -->
  <div id="shareModal" class="modal-overlay fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4">
    <!-- FIXED: Changed bg-white to bg-card -->
    <div class="bg-card rounded-2xl w-full max-w-md shadow-2xl p-8 text-center">
      <div class="w-12 h-12 bg-mint-500/10 rounded-full flex items-center justify-center mx-auto mb-4">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-mint-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
      </div>
      <h3 class="text-xl font-bold text-slate-800 mb-2">Share Offer</h3>
      <p class="text-sm text-slate-500 mb-6">Create a link to send this specific funding scenario to your client or team.</p>
      <div class="grid grid-cols-2 gap-3 mb-6">
          <button onclick="copyLink()" class="button-secondary py-3 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg> 
              <span class="text-xs font-semibold">Copy Link</span>
          </button>
          <button onclick="copyText()" class="button-secondary py-3 rounded-xl flex flex-col items-center justify-center gap-1 hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg> 
              <span class="text-xs font-semibold">Email Template</span>
          </button>
      </div>
      <button onclick="$('shareModal').classList.add('hidden')" class="text-sm font-semibold text-slate-400 hover:text-slate-600">Cancel</button>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast fixed bottom-6 right-6 bg-slate-800 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3">
    <div class="bg-green-500/20 p-1 rounded-full">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
    </div>
    <span id="toastMessage" class="font-medium text-sm">Success!</span>
  </div>

  <script>
    // --- UTILS ---
    const $ = (id) => document.getElementById(id);
    const $$ = (s) => document.querySelectorAll(s);
    const formatCurrency = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(n);
    const parseNumber = (v) => parseFloat(v.toString().replace(/[\$,]/g, '')) || 0;
    const formatNumber = (n) => new Intl.NumberFormat('en-US').format(n);
    const getLetter = (i) => String.fromCharCode(65 + i); // 0->A, 1->B

    // --- STATE ---
    let calcOptions = [];
    let activeCalcTab = 0;
    
    // Client Side State
    let clientData = null;
    let clientActiveIdx = 0;
    let clientSelectedAmount = 0;

    // --- SHARED CALC LOGIC ---
    function calculate(a, f, t, fr, fe) { 
        const tp = a * f; 
        const tc = tp - a; 
        const p = tp / t; 
        const fa = a * (fe / 100); 
        const net = a - fa; 
        return { amount: a, factor: f, term: t, frequency: fr, fee: fe, feeAmount: fa, net: net, totalPayback: tp, totalCost: tc, payment: p }; 
    }

    // --- ADMIN LOGIC ---
    function initDefaultOption() { 
        return { amount: 50000, factor: 1.25, term: 130, frequency: 'daily', fee: 0, prepay: 0, termOverride: '', notes: '', docs: false, docsText: "Voided Check\nGovernment Issued ID" }; 
    }

    function addCalcOption() { 
        if (calcOptions.length >= 3) return; 
        const p = calcOptions[calcOptions.length - 1] || initDefaultOption(); 
        calcOptions.push({ ...p }); 
        updateTabsUI(); 
        switchCalcTab(calcOptions.length - 1); 
    }

    function removeCalcOption() { 
        if (calcOptions.length <= 1) return; 
        calcOptions.splice(activeCalcTab, 1); 
        if (activeCalcTab >= calcOptions.length) activeCalcTab = calcOptions.length - 1; 
        updateTabsUI(); 
        switchCalcTab(activeCalcTab); 
    }

    function switchCalcTab(i) { 
        saveState(activeCalcTab); 
        activeCalcTab = i; 
        updateTabsUI(); 
        loadState(activeCalcTab); 
        updatePreview(); 
        updateSliders(); 
    }
    
    function updateTabsUI() { 
        for(let i=0; i<3; i++) { 
            const b = $(`tab-btn-${i}`); 
            if (i < calcOptions.length) { 
                b.classList.remove('hidden'); 
                b.classList.toggle('active', i === activeCalcTab); 
                b.textContent = `Option ${getLetter(i)}`;
            } else { 
                b.classList.add('hidden'); 
            } 
        } 
        $('add-tab-btn').classList.toggle('hidden', calcOptions.length >= 3); 
        $('remove-option-btn').classList.toggle('hidden', calcOptions.length <= 1); 
    }

    function getVal(id, num=false) { 
        const el = $(id); 
        if (!el) return num ? 0 : ''; 
        if (num) return parseNumber(el.value); 
        return el.value.trim(); 
    }

    function setVal(id, v) { 
        if($(id)) $(id).value = v; 
    }

    function saveState(i) { 
        if (!calcOptions[i]) return; 
        const freqBtn = document.querySelector('.toggle-btn.active');
        const fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        
        calcOptions[i] = { 
            amount: getVal('calcAmount', true), 
            factor: getVal('calcFactor', true), 
            term: getVal('calcTerm', true), 
            frequency: fr, 
            fee: $('toggleFee').checked ? getVal('calcFee', true) : 0, 
            prepay: $('togglePrepay').checked ? getVal('calcPrepay', true) : 0, 
            termOverride: $('toggleOverride').checked ? getVal('calcTermOverride') : '', 
            notes: $('toggleNotes').checked ? getVal('calcNotes') : '',
            docs: $('toggleDocs').checked,
            docsText: getVal('calcDocs') // Save custom docs text
        }; 
    }

    function loadState(i) { 
        const o = calcOptions[i]; 
        if (!o) return; 
        
        setVal('calcAmount', formatNumber(o.amount)); setVal('calcAmountSlider', o.amount); 
        setVal('calcFactor', o.factor); setVal('calcFactorSlider', o.factor); 
        setVal('calcTerm', o.term); setVal('calcTermSlider', o.term); 
        
        const hf = o.fee > 0; $('toggleFee').checked = hf; toggleSection('Fee', hf); if(hf) { setVal('calcFee', o.fee); setVal('calcFeeSlider', o.fee); }
        const hp = o.prepay > 0; $('togglePrepay').checked = hp; toggleSection('Prepay', hp); if(hp) { setVal('calcPrepay', o.prepay); setVal('calcPrepaySlider', o.prepay); }
        const ho = !!o.termOverride; $('toggleOverride').checked = ho; toggleSection('Override', ho); if(ho) setVal('calcTermOverride', o.termOverride);
        const hn = !!o.notes; $('toggleNotes').checked = hn; toggleSection('Notes', hn); if(hn) setVal('calcNotes', o.notes);
        
        // Docs
        const hd = !!o.docs;
        $('toggleDocs').checked = hd;
        toggleSection('Docs', hd);
        // Load custom docs text or default if missing
        setVal('calcDocs', o.docsText || "Voided Check\nGovernment Issued ID");
        
        setFrequency(o.frequency);
    }

    function updatePreview() {
        const a = getVal('calcAmount', true); 
        const f = getVal('calcFactor', true) || 1.25; 
        const t = getVal('calcTerm', true) || 130;
        const freqBtn = document.querySelector('.toggle-btn.active');
        const fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        
        const fe = $('toggleFee').checked ? (getVal('calcFee', true) || 0) : 0;
        const c = calculate(a, f, t, fr, fe);
        
        const bn = getVal('calcBusinessName');
        if(bn) { $('previewBusinessName').textContent = bn; $('previewBusinessName').classList.remove('hidden'); } else { $('previewBusinessName').classList.add('hidden'); }
        
        if (calcOptions.length > 1) {
            $('previewLabelContainer').classList.remove('hidden');
            $('previewOptionLabel').textContent = `Option ${getLetter(activeCalcTab)}`;
        } else {
            $('previewLabelContainer').classList.add('hidden');
        }

        $('previewAmount').textContent = formatCurrency(c.amount); 
        $('previewPaybackChart').textContent = formatCurrency(c.totalPayback);
        
        const to = $('toggleOverride').checked ? getVal('calcTermOverride') : '';
        let tm = t; if(fr === 'weekly') tm = t / 4.33; else if (fr === 'daily') tm = t / 21;
        const monthLabel = Math.round(tm * 2) / 2 + ' months';

        $('previewTermLength').textContent = to ? to : monthLabel; 
        $('previewTermPayments').textContent = c.term; 
        $('previewFactor').textContent = c.factor.toFixed(2) + 'x'; 
        $('previewCost').textContent = formatCurrency(c.totalCost);
        
        const pLabel = fr === 'weekly' ? 'Weekly Payment' : fr === 'monthly' ? 'Monthly Payment' : 'Daily Payment';
        $('previewPaymentLabel').textContent = pLabel;
        $('previewPayment').textContent = formatCurrency(c.payment);
        
        if (fe > 0) { $('previewFeeRow').classList.remove('hidden'); $('previewFeeAmount').textContent = formatCurrency(c.feeAmount); $('previewNet').textContent = formatCurrency(c.net); } else { $('previewFeeRow').classList.add('hidden'); }
        
        const pp = c.totalPayback > 0 ? (c.amount / c.totalPayback) * 100 : 0; 
        $('previewCircle').setAttribute('stroke-dasharray', `${pp}, ${100 - pp}`);
    }

    // --- CLIENT VIEW HELPERS ---
    function getCurrentData() {
        saveState(activeCalcTab);
        return {
            b: getVal('calcBusinessName'), c: getVal('calcContactName'), e: getVal('calcEmail'),
            ex: $('toggleExpiry').checked ? getVal('calcExpiryDate') : null,
            o: calcOptions.map(op => ({ a: op.amount, f: op.factor, t: op.term, q: op.frequency, fe: op.fee, pp: op.prepay, to: op.termOverride, n: op.notes, d: op.docs, dt: op.docsText }))
        };
    }

    function previewClientView() {
        const data = getCurrentData();
        initClientView(data);
        $('clientPreviewBar').classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function exitPreview() {
        $('clientPanel').classList.add('hidden');
        $('adminPanel').classList.remove('hidden');
        $('clientPreviewBar').classList.add('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function acceptOffer() {
        confetti({
            particleCount: 150,
            spread: 80,
            origin: { y: 0.6 },
            colors: ['#42D197', '#2d9668', '#74eabc']
        });
        $('successModal').classList.remove('hidden');
    }

    // --- CLIENT VIEW LOGIC ---
    function initClientView(data) {
        // Toggle Views
        $('adminPanel').classList.add('hidden');
        $('clientPanel').classList.remove('hidden');
        
        clientData = data;
        clientActiveIdx = 0;
        
        // Populate Header Info
        $('clientGreeting').textContent = `Hello, ${data.c || 'Business Owner'}`;
        $('clientBusinessName').textContent = data.b || 'your business';
        if(data.ex) {
            $('clientExpiryRow').classList.remove('hidden');
            $('clientExpiryDate').textContent = new Date(data.ex).toLocaleDateString();
        }

        // Setup Tabs if multiple options
        const tabsContainer = $('clientTabsContainer');
        tabsContainer.innerHTML = '';
        if(data.o.length > 1) {
             tabsContainer.classList.remove('hidden');
             data.o.forEach((opt, idx) => {
                 const btn = document.createElement('button');
                 // Styled to look like tags inside the dark header
                 btn.className = `py-1 px-4 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border ${idx===0 ? 'bg-mint-500 text-white border-mint-500 shadow-md' : 'bg-white/10 text-slate-300 border-white/20 hover:bg-white/20'}`;
                 btn.textContent = `Option ${getLetter(idx)}`;
                 btn.onclick = () => switchClientTab(idx, btn);
                 tabsContainer.appendChild(btn);
             });
        } else {
             tabsContainer.classList.add('hidden');
        }
        
        // Initial Render
        setupClientOption(0);
    }

    function switchClientTab(idx, btn) {
        clientActiveIdx = idx;
        // UI Update
        const btns = $('clientTabsContainer').children;
        Array.from(btns).forEach(b => b.className = 'py-1 px-4 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border bg-white/10 text-slate-300 border-white/20 hover:bg-white/20');
        if (btn) {
            btn.className = 'py-1 px-4 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border bg-mint-500 text-white border-mint-500 shadow-md';
        } else {
            // If triggered from card, find button by index
            if (btns[idx]) btns[idx].className = 'py-1 px-4 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border bg-mint-500 text-white border-mint-500 shadow-md';
        }
        
        setupClientOption(idx);
        // Scroll back to top of card to show selection
        if (!btn) $('clientPanel').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function renderOtherOptions() {
        const container = $('clientOtherOptionsContainer');
        container.innerHTML = '';
        
        // Only show if there are multiple options
        if(clientData.o.length <= 1) {
            container.classList.add('hidden');
            return;
        }
        
        container.classList.remove('hidden');
        
        clientData.o.forEach((opt, idx) => {
            // Skip the currently active option
            if(idx === clientActiveIdx) return;
            
            const letter = getLetter(idx);
            const card = document.createElement('div');
            
            // Calculate simple summary for card
            // We assume max amount for the preview card
            const calc = calculate(opt.a, opt.f, opt.t, opt.q, opt.fe);
            
            card.className = "bg-white p-4 rounded-2xl border border-slate-200 shadow-sm hover:shadow-md hover:border-mint-500 cursor-pointer transition-all group";
            card.onclick = () => switchClientTab(idx);
            
            card.innerHTML = `
                <div class="flex justify-between items-start mb-3">
                    <span class="text-[10px] font-bold text-slate-400 uppercase tracking-widest bg-slate-100 px-2 py-1 rounded">Option ${letter}</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-300 group-hover:text-mint-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 7l5 5m0 0l-5 5m5-5H6" /></svg>
                </div>
                <div class="mb-1">
                    <span class="text-xs font-medium text-slate-400 block">Amount</span>
                    <span class="text-lg font-extrabold text-slate-800">${formatCurrency(opt.a)}</span>
                </div>
                <div class="flex justify-between items-end">
                     <div>
                        <span class="text-[10px] font-medium text-slate-400 block">Term</span>
                        <span class="text-xs font-bold text-slate-600">${opt.to || (opt.t + ' Pmts')}</span>
                     </div>
                     <div class="text-right">
                        <span class="text-[10px] font-medium text-slate-400 block">Payment</span>
                        <span class="text-xs font-bold text-slate-600">${formatCurrency(calc.payment)}</span>
                     </div>
                </div>
            `;
            
            container.appendChild(card);
        });
    }

    function setupClientOption(idx) {
        const opt = clientData.o[idx];
        const maxAmt = opt.a;
        
        // Reset or clamp current selection
        clientSelectedAmount = maxAmt; 
        
        // Setup Inputs
        $('clientMaxLabelSlider').textContent = `Max ${formatCurrency(maxAmt)}`;
        
        const slider = $('clientAmountSlider');
        slider.min = 5000;
        slider.max = maxAmt;
        slider.step = 1; 
        slider.value = maxAmt;
        updateSliderFill(slider);
        
        // Setup Notes & Expiry Visibility
        const hasNotes = !!opt.n;
        const hasExpiry = !!clientData.ex; 
        const hasDocs = !!opt.d; 
        
        const termsContainer = $('clientTermsContainer');
        const notesRow = $('clientNotesRow');
        const expiryRow = $('clientExpiryRow');
        const noTermsRow = $('clientNoTermsRow');
        const docsCol = $('clientDocsCol');
        
        // Logic to show/hide sections
        let showTerms = hasNotes || hasExpiry;
        let showDocs = hasDocs;

        if (showTerms || showDocs) {
            termsContainer.classList.remove('hidden');
            
            // Handle Terms Column Visibility
            if (showTerms) {
                noTermsRow.classList.add('hidden');
                if (hasNotes) {
                    notesRow.classList.remove('hidden');
                    $('clientNotesText').textContent = opt.n;
                } else {
                    notesRow.classList.add('hidden');
                }
                if (hasExpiry) {
                    expiryRow.classList.remove('hidden');
                    $('clientExpiryDate').textContent = new Date(clientData.ex).toLocaleDateString(); 
                } else {
                    expiryRow.classList.add('hidden');
                }
            } else {
                noTermsRow.classList.remove('hidden');
                notesRow.classList.add('hidden');
                expiryRow.classList.add('hidden');
            }

            // Handle Docs Column
            if (showDocs) {
                docsCol.classList.remove('hidden');
                // Build Dynamic List
                const docsList = $('clientDocsList');
                docsList.innerHTML = '';
                const items = (opt.dt || "Voided Check\nGovernment Issued ID").split('\n');
                
                items.forEach(item => {
                    if(!item.trim()) return;
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2";
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-mint-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <span>${item.trim()}</span>
                    `;
                    docsList.appendChild(li);
                });

            } else {
                docsCol.classList.add('hidden');
            }

        } else {
            termsContainer.classList.add('hidden');
        }
        
        // Render the small cards for other options
        renderOtherOptions();

        updateClientPreview();
    }

    function updateClientPreview() {
        const opt = clientData.o[clientActiveIdx];
        const amt = clientSelectedAmount;
        
        const calc = calculate(amt, opt.f, opt.t, opt.q, opt.fe);
        
        if (clientData.o.length > 1) {
             $('cPreviewLabelContainer').classList.add('hidden'); // Hidden because tabs are shown
        } else {
             $('cPreviewLabelContainer').classList.add('hidden');
        }

        $('cPreviewAmount').textContent = formatCurrency(calc.amount);
        $('cPreviewPayback').textContent = formatCurrency(calc.totalPayback);
        
        const to = opt.to;
        let tm = opt.t; if(opt.q === 'weekly') tm = opt.t / 4.33; else if (opt.q === 'daily') tm = opt.t / 21;
        const monthLabel = Math.round(tm * 2) / 2 + ' months';
        $('cPreviewTerm').textContent = to ? to : monthLabel;
        $('cPreviewCount').textContent = calc.term;
        
        if(calc.fee > 0) {
            $('cPreviewFeeRow').classList.remove('hidden');
            $('cPreviewFee').textContent = formatCurrency(calc.feeAmount);
            $('cPreviewNet').textContent = formatCurrency(calc.net);
        } else {
            $('cPreviewFeeRow').classList.add('hidden');
        }
        
        const pLabel = opt.q === 'weekly' ? 'Weekly Payment' : opt.q === 'monthly' ? 'Monthly Payment' : 'Daily Payment';
        $('cPreviewPaymentLabel').textContent = pLabel;
        $('cPreviewPayment').textContent = formatCurrency(calc.payment);
        
        // Chart Logic
        const pp = calc.totalPayback > 0 ? (calc.amount / calc.totalPayback) * 100 : 0; 
        $('cPreviewCircle').setAttribute('stroke-dasharray', `${pp}, ${100 - pp}`);
    }

    // --- THEME LOGIC ---
    function openThemeModal() {
        $('themeModal').classList.remove('hidden');
    }

    function setTheme(accent, dark, light) {
        updateThemeColor('accent', accent);
        updateThemeColor('dark', dark);
        updateThemeColor('light', light);
        
        // Update inputs
        $('accentColorPicker').value = accent;
        $('darkColorPicker').value = dark;
        $('lightColorPicker').value = light;
    }

    function updateThemeColor(type, color) {
        const root = document.documentElement;
        if (type === 'accent') {
            root.style.setProperty('--accent-color', color);
            // Approximate a darker shade for hover
            const darkColor = adjustBrightness(color, -20);
            root.style.setProperty('--accent-color-dark', darkColor);
            $('accentColorValue').textContent = color;
        } else if (type === 'dark') {
            root.style.setProperty('--brand-dark', color);
            $('darkColorValue').textContent = color;
        } else if (type === 'light') {
            root.style.setProperty('--brand-light', color);
            $('lightColorValue').textContent = color;
            
            // Auto-switch card/text colors based on brightness
            const brightness = getBrightness(color);
            if (brightness < 128) { // Dark Mode
                // Set dark mode variables - AMOLED / NEUTRAL GREYS (No Blue Tones)
                root.style.setProperty('--bg-card', '#121212'); // Neutral Dark Grey
                root.style.setProperty('--bg-inner', '#181818'); // Slightly lighter neutral
                
                root.style.setProperty('--border-primary', '#262626'); // Neutral 800
                root.style.setProperty('--border-secondary', '#404040'); // Neutral 700
                root.style.setProperty('--border-strong', '#525252'); // Neutral 600
                
                root.style.setProperty('--text-primary', '#ffffff'); // White
                root.style.setProperty('--text-primary-light', '#e5e5e5'); // Neutral 200
                root.style.setProperty('--text-secondary', '#a3a3a3'); // Neutral 400
                root.style.setProperty('--text-secondary-dark', '#737373'); // Neutral 500
                root.style.setProperty('--text-muted', '#525252'); // Neutral 600
            } else { // Light Mode
                // Reset to light mode variables
                root.style.setProperty('--bg-card', '#ffffff');
                root.style.setProperty('--bg-inner', '#f8fafc');
                
                root.style.setProperty('--border-primary', '#f1f5f9');
                root.style.setProperty('--border-secondary', '#e2e8f0');
                root.style.setProperty('--border-strong', '#cbd5e1');
                
                root.style.setProperty('--text-primary', '#0f172a');
                root.style.setProperty('--text-primary-light', '#334155');
                root.style.setProperty('--text-secondary', '#64748b');
                root.style.setProperty('--text-secondary-dark', '#475569');
                root.style.setProperty('--text-muted', '#94a3b8');
            }
        }
    }
    
    // Simple Hex Brightness Adjuster
    function adjustBrightness(hex, percent) {
        let num = parseInt(hex.replace("#", ""), 16),
        amt = Math.round(2.55 * percent),
        R = (num >> 16) + amt,
        G = (num >> 8 & 0x00FF) + amt,
        B = (num & 0x0000FF) + amt;
        return "#" + (0x1000000 + (R<255?R<1?0:R:255)*0x10000 + (G<255?G<1?0:G:255)*0x100 + (B<255?B<1?0:B:255)).toString(16).slice(1);
    }
    
    function getBrightness(hex) {
        hex = hex.replace('#', '');
        var r = parseInt(hex.substring(0, 2), 16);
        var g = parseInt(hex.substring(2, 4), 16);
        var b = parseInt(hex.substring(4, 6), 16);
        return ((r * 299) + (g * 587) + (b * 114)) / 1000;
    }
    
    function resetTheme() {
        setTheme('#42D197', '#0f172a', '#f8fafc');
    }

    // --- SHARED UI HANDLERS ---
    function updateSliderFill(s) { 
        if (!s) return; 
        const m = parseFloat(s.min), mx = parseFloat(s.max), v = parseFloat(s.value);
        const p = ((v - m) / (mx - m)) * 100; 
        s.style.background = `linear-gradient(to right, var(--accent-color) 0%, var(--accent-color) ${p}%, var(--bg-slider-track) ${p}%, var(--bg-slider-track) 100%)`; 
    }
    
    function updateSliders() { 
        $$('.slider').forEach(s => updateSliderFill(s)); 
    }

    function toggleSection(id, show) { 
        const el = $('sec'+id); 
        if(show) { el.classList.remove('hidden'); el.classList.add('fade-enter'); } 
        else { el.classList.add('hidden'); updatePreview(); } 
    }

    function setFrequency(f) { 
        $$('.toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.freq === f)); 
        updatePreview(); 
    }

    function resetCalculator() { 
        calcOptions = [initDefaultOption()]; 
        activeCalcTab = 0; 
        setVal('calcBusinessName',''); setVal('calcContactName',''); setVal('calcEmail',''); 
        ['toggleFee','togglePrepay','toggleOverride','toggleExpiry','toggleNotes','toggleDocs'].forEach(id => { 
            const el = $(id); if(el) { el.checked = false; toggleSection(id.replace('toggle',''), false); }
        });
        updateTabsUI(); loadState(0); updatePreview(); updateSliders(); 
        showToast('Calculator Reset');
    }
    
    function shareOffer() { 
        saveState(activeCalcTab); 
        $('shareModal').classList.remove('hidden'); 
    }

    // --- RE-ADDED GETLINK HELPER ---
    function getLink() {
        saveState(activeCalcTab);
        const d = { 
            b: getVal('calcBusinessName'), c: getVal('calcContactName'), e: getVal('calcEmail'),
            ex: $('toggleExpiry').checked ? getVal('calcExpiryDate') : null,
            o: calcOptions.map(op => ({ a: op.amount, f: op.factor, t: op.term, q: op.frequency, fe: op.fee, pp: op.prepay, to: op.termOverride, n: op.notes, d: op.docs, dt: op.docsText }))
        };
        const json = JSON.stringify(d);
        const enc = btoa(encodeURIComponent(json).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1)));
        return `${window.location.origin}${window.location.pathname}?d=${enc}`;
    }
    
    function copyLink() { 
        const l = getLink(); 
        if (navigator.clipboard) { navigator.clipboard.writeText(l).then(() => showToast('Link copied!')).catch(() => prompt("Copy Link:", l)); } else { prompt("Copy Link:", l); }
        $('shareModal').classList.add('hidden');
    }
    
    function copyText() {
        const l = getLink();
        const c = getVal('calcBusinessName') || 'Business Funding';
        
        let cardsHtml = '';
        
        calcOptions.forEach((opt, i) => {
            const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
            const freqLabel = opt.frequency.charAt(0).toUpperCase() + opt.frequency.slice(1);
            const fontMain = "font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;";
            
            // Calculate chart percentage
            const pp = cal.totalPayback > 0 ? (cal.amount / cal.totalPayback) * 100 : 0;
            
            // Option Label Logic for Email
            const optionLabelHtml = calcOptions.length > 1 
                ? `<div style="display: inline-block; background-color: rgba(66, 209, 151, 0.1); border: 1px solid rgba(66, 209, 151, 0.2); border-radius: 4px; padding: 4px 12px; margin-bottom: 12px;">
                       <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #42D197; margin: 0;">Option ${getLetter(i)}</p>
                   </div>`
                : '';

            cardsHtml += `
            <!-- CARD WRAPPER TABLE (Centering) -->
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                <tr>
                    <td align="center">
                        <!-- CARD DIV (Border & Radius) -->
                        <div style="max-width: 420px; margin: 0 auto 40px auto; background-color: #ffffff; border-radius: 24px; overflow: hidden; border: 4px solid #42D197; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); position: relative;">
                            
                            <!-- Badge Removed from Email Card -->

                            <!-- HERO RIBBON (Dark) -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="background-color: #0f172a; padding: 40px 20px 32px 20px;">
                                        ${optionLabelHtml}
                                        <p style="${fontMain} font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; margin: 0 0 8px 0;">You Get</p>
                                        <h1 style="${fontMain} font-size: 56px; font-weight: 800; line-height: 1; letter-spacing: -2px; color: #ffffff; margin: 0;">${formatCurrency(opt.amount)}</h1>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- CHART SECTION (Restored) -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="padding: 32px 20px; background-color: #ffffff;">
                                        <div style="position: relative; width: 140px; height: 140px; margin: 0 auto;">
                                             <!-- SVG Chart -->
                                             <svg viewBox="0 0 36 36" style="display: block; width: 100%; height: 100%; transform: rotate(-90deg);">
                                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#e2e8f0" stroke-width="2.5" />
                                                <path d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" fill="none" stroke="#42D197" stroke-width="2.5" stroke-dasharray="${pp}, ${100-pp}" />
                                            </svg>
                                            <!-- Centered Text -->
                                            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; width: 100%;">
                                                <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 2px 0;">Payback</p>
                                                <p style="${fontMain} font-size: 16px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.totalPayback)}</p>
                                            </div>
                                        </div>
                                        <!-- Legend -->
                                        <table border="0" cellspacing="0" cellpadding="0" style="margin-top: 16px;">
                                            <tr>
                                                <td style="padding-right: 12px;">
                                                    <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: #42D197; margin-right: 4px;"></span>
                                                    <span style="${fontMain} font-size: 10px; color: #64748b; font-weight: bold;">Principal</span>
                                                </td>
                                                 <td>
                                                    <span style="display: inline-block; width: 8px; height: 8px; border-radius: 50%; background-color: #e2e8f0; margin-right: 4px;"></span>
                                                    <span style="${fontMain} font-size: 10px; color: #64748b; font-weight: bold;">Cost</span>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <!-- 4. STATS GRID (Light Gray Bg with Dividers) -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; border-top: 1px solid #f1f5f9;">
                                <tr>
                                    <td width="50%" align="center" style="padding: 16px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Term Length</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${opt.termOverride || (cal.term + ' Pmts')}</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 16px; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Payments</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${cal.term}</p>
                                    </td>
                                </tr>
                                <tr>
                                    <td width="50%" align="center" style="padding: 16px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Factor Rate</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${parseFloat(opt.factor).toFixed(2)}x</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 16px; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Total Cost</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.totalCost)}</p>
                                    </td>
                                </tr>
                                ${cal.fee > 0 ? `
                                <tr>
                                    <td width="50%" align="center" style="padding: 16px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0; background-color: #fff7ed;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Fee</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.feeAmount)}</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 16px; border-bottom: 1px solid #e2e8f0; background-color: #fff7ed;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Net Proceeds</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.net)}</p>
                                    </td>
                                </tr>` : ''}
                            </table>

                            <!-- 5. PAYMENT BOX (White) -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="background-color: #ffffff; padding: 25px;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 6px 0; letter-spacing: 1px;">${freqLabel} Payment</p>
                                        <p style="${fontMain} font-size: 30px; font-weight: 800; color: #0f172a; margin: 0; letter-spacing: -1px;">${formatCurrency(cal.payment)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                        </div>
                    </td>
                </tr>
            </table>`;
        });
        
        // WRAPPER TABLE
        const html = `
            <!DOCTYPE html>
            <html>
            <body style="margin: 0; padding: 0; background-color: #f8fafc;">
            <center>
            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
                <tr>
                    <td align="center" style="padding: 40px 20px;">
                        
                        <!-- TITLE HEADER -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 30px;">
                            <tr>
                                <td align="center">
                                    <h2 style="margin: 0 0 8px 0; color: #0f172a; font-size: 24px; font-weight: 800;">${c}</h2>
                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Funding Approval Options</p>
                                </td>
                            </tr>
                        </table>

                        <!-- CARDS -->
                        ${cardsHtml}

                        <!-- BUTTON SECTION -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin-top: 10px;">
                            <tr>
                                <td align="center">
                                    <a href="${l}" target="_blank" style="font-size: 16px; font-family: Helvetica, Arial, sans-serif; color: #ffffff; text-decoration: none; border-radius: 12px; padding: 18px 36px; background-color: #42D197; border: 1px solid #42D197; display: inline-block; font-weight: bold; box-shadow: 0 10px 15px -3px rgba(66, 209, 151, 0.4);">
                                        View & Accept Offer
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td align="center" style="padding-top: 24px;">
                                    <!-- Clean Link Text -->
                                    <p style="margin: 0 0 8px 0; font-size: 14px; color: #64748b;">Click the button above to view full details and proceed.</p>
                                    <p style="margin: 0; font-size: 12px; color: #94a3b8;"><a href="${l}" style="color: #94a3b8; text-decoration: underline;">Open in Browser</a></p>
                                </td>
                            </tr>
                        </table>
                        
                    </td>
                </tr>
            </table>
            </center>
            </body>
            </html>
        `;
        
        const div = document.createElement('div'); 
        div.innerHTML = html; 
        div.style.position='fixed'; div.style.opacity='0'; div.contentEditable='true'; 
        document.body.appendChild(div);
        
        const range = document.createRange(); 
        range.selectNodeContents(div); 
        const sel = window.getSelection(); 
        sel.removeAllRanges(); 
        sel.addRange(range);
        
        try { 
            document.execCommand('copy'); 
            showToast('Email template copied!'); 
        } catch(e) { 
            copyLink(); 
        }
        document.body.removeChild(div); 
        $('shareModal').classList.add('hidden');
    }

    function openAmortSchedule() { 
        let a, f, t, fr;
        
        if($('adminPanel').classList.contains('hidden')) {
            // Client Mode
            const opt = clientData.o[clientActiveIdx];
            a = clientSelectedAmount;
            f = opt.f;
            t = opt.t;
            fr = opt.q;
        } else {
            // Admin Mode
            a = getVal('calcAmount', true);
            f = getVal('calcFactor', true);
            t = getVal('calcTerm', true);
            const freqBtn = document.querySelector('.toggle-btn.active');
            fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        }
        
        const c = calculate(a, f, t, fr, 0);
        let b = c.totalPayback, d = new Date(), html = '';
        
        for(let i=1; i<=t; i++) {
            if(i > 300 && i < t) continue;
            if(i === 300 && t > 300) { html += `<tr><td colspan="4" class="text-center text-slate-400 py-3 bg-slate-50 italic">... (${t - 300} remaining payments) ...</td></tr>`; continue; }
            if(fr==='weekly') d.setDate(d.getDate()+7); else if(fr==='monthly') d.setMonth(d.getMonth()+1); else { d.setDate(d.getDate()+1); if(d.getDay()===0) d.setDate(d.getDate()+1); if(d.getDay()===6) d.setDate(d.getDate()+2); }
            b -= c.payment; if(b<0) b=0;
            html += `<tr class="hover:bg-slate-50 transition-colors"><td class="px-6 py-2.5 text-slate-500 font-medium">${i}</td><td class="px-6 py-2.5 text-slate-700">${d.toLocaleDateString()}</td><td class="px-6 py-2.5 text-right font-mono text-slate-700">${formatCurrency(c.payment)}</td><td class="px-6 py-2.5 text-right font-mono font-bold text-slate-900">${formatCurrency(b)}</td></tr>`;
        }
        $('amortTableBody').innerHTML = html; $('amortModal').classList.remove('hidden'); 
    }

    function showToast(m) { const t=$('toast'); $('toastMessage').textContent=m; t.classList.add('show'); setTimeout(()=>t.classList.remove('show'), 3000); }

    // --- EVENTS ---
    ['calcAmount','calcFactor','calcTerm','calcFee','calcPrepay'].forEach(id => {
        const el = $(id); if(!el) return;
        el.addEventListener('input', function() { 
            const v = parseFloat(this.value.replace(/,/g,''))||0; 
            const slider = $(id+'Slider'); if(slider) { slider.value = v; updateSliderFill(slider); }
            updatePreview(); 
        });
    });
    ['calcAmountSlider','calcFactorSlider','calcTermSlider','calcFeeSlider','calcPrepaySlider'].forEach(id => {
        const el = $(id); if(!el) return;
        el.addEventListener('input', function() { 
            const k = id.replace('Slider',''); setVal(k, k==='calcAmount'?formatNumber(this.value):this.value); 
            updatePreview(); updateSliderFill(this); 
        });
    });
    
    // Client Events
    $('clientAmountSlider').addEventListener('input', function() {
        clientSelectedAmount = parseInt(this.value);
        // $('clientAmountInput').value = clientSelectedAmount; // REMOVED INPUT REFERENCE
        updateSliderFill(this);
        updateClientPreview();
    });
    
    // REMOVED clientAmountInput listener

    ['calcTermOverride','calcBusinessName'].forEach(id => $(id).addEventListener('input', updatePreview));

    // --- INIT ---
    window.addEventListener('load', () => {
        resetCalculator();
        const params = new URLSearchParams(window.location.search);
        const d = params.get('d');
        if (d) {
            try {
                const json = decodeURIComponent(atob(d).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1)));
                const data = JSON.parse(json);
                if(data.o && data.o.length) {
                    initClientView(data);
                }
            } catch(e) { console.error("Error loading shared data", e); }
        }
    });
  </script>
</body>
</html>
