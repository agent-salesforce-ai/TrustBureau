<!DOCTYPE html>
<html lang="en" class="theme-light accent-mint">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TrustBureau.ai | Payments Offer Calculator</title>

  <!-- PWA & Mobile Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="TrustBureau">
  <meta name="theme-color" content="#ffffff">

  <!-- Favicon: White Shield with Black Checkmark -->
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z' fill='white' stroke='black' stroke-width='1.5' stroke-linejoin='round'/%3E%3Cpath d='M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z' fill='black'/%3E%3C/svg%3E">
  <link rel="apple-touch-icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Crect width='24' height='24' fill='white'/%3E%3Cpath d='M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z' fill='white' stroke='black' stroke-width='1.5' stroke-linejoin='round'/%3E%3Cpath d='M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z' fill='black'/%3E%3C/svg%3E">

  <!-- Tailwind & Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />

  <style>
    body { font-family: 'Inter', sans-serif; }

    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    .input-icon { top: 50%; transform: translateY(-50%); }

    /* --- BASE THEMES --- */
    html.theme-light {
      --bg-body: #ffffff;
      --bg-card: #ffffff;
      --bg-card-inner: #f9fafb;
      --bg-slider-track: #e2e8f0;
      --bg-input: #ffffff;
      --bg-toggle-inactive: #f1f5f9;
      --border-primary: #e2e8f0;
      --text-primary: #0f172a;
      --text-secondary: #334155;
      --text-muted: #64748b;
      --text-success: #16a34a;
      --shadow-color: rgba(0, 0, 0, 0.06);
      --chart-secondary: #cbd5e1;
    }
    html.theme-dark {
      --bg-body: #111827;
      --bg-card: #1f2937;
      --bg-card-inner: #111827;
      --bg-slider-track: #374151;
      --bg-input: #1f2937;
      --bg-toggle-inactive: #111827;
      --border-primary: #374151;
      --text-primary: #f9fafb;
      --text-secondary: #e5e7eb;
      --text-muted: #9ca3af;
      --text-success: #4ade80;
      --shadow-color: rgba(0, 0, 0, 0.3);
      --chart-secondary: #4b5563;
    }
    html.theme-black {
      --bg-body: #020617;
      --bg-card: #020617;
      --bg-card-inner: #0f172a;
      --bg-slider-track: #1e293b;
      --bg-input: #020617;
      --bg-toggle-inactive: #0f172a;
      --border-primary: #1e293b;
      --text-primary: #f8fafc;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --text-success: #4ade80;
      --shadow-color: rgba(0, 0, 0, 0.5);
      --chart-secondary: #334155;
    }

    body { background-color: var(--bg-body); transition: background-color 0.2s; }

    /* --- ACCENT COLORS --- */
    html.accent-mint { --accent-color: #42D197; --accent-color-light: #74eabc; --accent-color-dark: #2d9668; --accent-text-inverted: #ffffff; }
    html.accent-gold { --accent-color: #D19B2B; --accent-color-light: #e6b650; --accent-color-dark: #a6781c; --accent-text-inverted: #020617; }
    html.accent-blue { --accent-color: #3b82f6; --accent-color-light: #60a5fa; --accent-color-dark: #2563eb; --accent-text-inverted: #ffffff; }
    html.accent-green { --accent-color: #22c55e; --accent-color-light: #4ade80; --accent-color-dark: #16a34a; --accent-text-inverted: #ffffff; }
    html.accent-red { --accent-color: #ef4444; --accent-color-light: #f87171; --accent-color-dark: #dc2626; --accent-text-inverted: #ffffff; }
    html.accent-orange { --accent-color: #f97316; --accent-color-light: #fb923c; --accent-color-dark: #ea580c; --accent-text-inverted: #ffffff; }
    html.accent-purple { --accent-color: #a855f7; --accent-color-light: #c084fc; --accent-color-dark: #9333ea; --accent-text-inverted: #ffffff; }
    html.accent-pink { --accent-color: #ec4899; --accent-color-light: #f472b6; --accent-color-dark: #db2777; --accent-text-inverted: #ffffff; }
    html.accent-teal { --accent-color: #14b8a6; --accent-color-light: #2dd4bf; --accent-color-dark: #0d9488; --accent-text-inverted: #ffffff; }
    html.accent-indigo { --accent-color: #6366f1; --accent-color-light: #818cf8; --accent-color-dark: #4f46e5; --accent-text-inverted: #ffffff; }
    html.accent-cyan { --accent-color: #06b6d4; --accent-color-light: #22d3ee; --accent-color-dark: #0891b2; --accent-text-inverted: #ffffff; }
    html.accent-lime { --accent-color: #84cc16; --accent-color-light: #a3e635; --accent-color-dark: #65a30d; --accent-text-inverted: #020617; }
    html.accent-fuchsia { --accent-color: #d946ef; --accent-color-light: #e879f9; --accent-color-dark: #c026d3; --accent-text-inverted: #ffffff; }
    html.accent-sky { --accent-color: #0ea5e9; --accent-color-light: #38bdf8; --accent-color-dark: #0284c7; --accent-text-inverted: #ffffff; }
    html.accent-yellow { --accent-color: #eab308; --accent-color-light: #facc15; --accent-color-dark: #ca8a04; --accent-text-inverted: #020617; }
    html.accent-black { --accent-color: #000000; --accent-color-light: #333333; --accent-color-dark: #000000; --accent-text-inverted: #ffffff; }
    html.theme-dark.accent-black, html.theme-black.accent-black { --accent-color: #f3f4f6; --accent-color-light: #ffffff; --accent-color-dark: #d1d5db; --accent-text-inverted: #000000; }
    html.accent-white { --accent-color: #ffffff; --accent-color-light: #f0f0f0; --accent-color-dark: #e0e0e0; --accent-text-inverted: #000000; }
    html.theme-dark.accent-white, html.theme-black.accent-white { --accent-color: #1a1a1a; --accent-color-light: #333333; --accent-color-dark: #000000; --accent-text-inverted: #ffffff; }
    html.accent-gray { --accent-color: #111827; --accent-color-light: #374151; --accent-color-dark: #000000; --accent-text-inverted: #ffffff; }
    html.theme-dark.accent-gray, html.theme-black.accent-gray { --accent-color: #f3f4f6; --accent-color-light: #ffffff; --accent-color-dark: #d1d5db; --accent-text-inverted: #000000; }

    /* --- COMPONENT STYLES --- */
    .card-bg { background-color: var(--bg-card); border-color: var(--border-primary); }
    .shell {
      border-color: var(--accent-color);
      border-width: 3px;
      box-shadow: 0 4px 6px -1px var(--shadow-color), 0 2px 4px -1px var(--shadow-color);
    }
    .card-inner-bg { background-color: var(--bg-card-inner); border: 1px solid var(--border-primary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-muted { color: var(--text-muted); }
    .text-success { color: var(--text-success); }
    .border-primary { border-color: var(--border-primary); }
    .slider-track { background-color: var(--bg-slider-track); }
    .slider-thumb { accent-color: var(--accent-color); }
    .input-field {
      background-color: var(--bg-input);
      border-color: var(--border-primary);
      color: var(--text-primary);
    }
    .input-field:focus, .input-field:focus-within {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 1px var(--accent-color-light);
      outline: none;
    }
    input[type="date"] {
      background-color: var(--bg-input);
      color: var(--text-primary);
      border-color: var(--border-primary);
    }
    ::-webkit-calendar-picker-indicator { filter: invert(0.5); cursor: pointer; }
    html.theme-light ::-webkit-calendar-picker-indicator { filter: invert(0); }
    .text-hero { color: var(--accent-color); }
    .toggle-inactive { background-color: var(--bg-toggle-inactive); color: var(--text-secondary); }
    .toggle-active { background-color: var(--accent-color); color: var(--accent-text-inverted); font-weight: 700; }
    .button-primary {
      background-color: var(--accent-color);
      color: var(--accent-text-inverted);
      font-weight: 700;
      border-radius: 0.5rem; 
      padding: 0.6rem 1.75rem;
      border: 1px solid var(--accent-color-dark);
      transition: all 0.2s ease;
    }
    .button-primary:hover {
      background-color: var(--accent-color-light);
      box-shadow: 0 0 0 1px var(--accent-color), 0 0 15px var(--accent-color-light);
      transform: translateY(-1px) scale(1.01);
    }
    .button-primary:disabled {
      background-color: var(--bg-slider-track);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      border-color: transparent;
    }
    .color-swatch {
      width: 20px; height: 20px; border-radius: 50%; cursor: pointer;
      border: 2px solid transparent; transition: transform 0.1s; display: inline-block;
    }
    .color-swatch:hover { transform: scale(1.1); }
    .color-swatch.selected { border-color: var(--text-primary); box-shadow: 0 0 0 2px var(--bg-card); }
    .amort-table th {
      background-color: var(--bg-slider-track); color: var(--text-secondary);
      font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;
      padding: 0.75rem 0.5rem; font-weight: 600;
    }
    .amort-table td {
      border-bottom: 1px solid var(--border-primary); color: var(--text-primary);
      font-size: 0.8rem; padding: 0.6rem 0.5rem;
    }
    .amort-table tr:last-child td { border-bottom: none; }

    /* --- CHART & TOOLTIP STYLES --- */
    .donut-container {
      position: relative;
      width: 100px; height: 100px;
      border-radius: 50%;
      background: conic-gradient(var(--accent-color) 0% 80%, var(--chart-secondary) 80% 100%);
      display: flex; justify-content: center; align-items: center;
      margin: 0 auto;
    }
    .donut-inner {
      width: 70px; height: 70px;
      background-color: var(--bg-card);
      border-radius: 50%;
      display: flex; flex-direction: column;
      justify-content: center; align-items: center;
    }
    .tooltip-icon {
      display: inline-flex; justify-content: center; align-items: center;
      width: 14px; height: 14px; border-radius: 50%;
      background-color: var(--text-muted); color: var(--bg-card);
      font-size: 10px; font-weight: bold; cursor: help;
      margin-left: 4px; vertical-align: middle;
    }
    .tooltip-wrapper { position: relative; display: inline-block; }
    .tooltip-content {
      visibility: hidden; opacity: 0;
      position: absolute; bottom: 130%; left: 50%; transform: translateX(-50%);
      width: 200px; background-color: #334155; color: #fff;
      text-align: center; border-radius: 6px; padding: 8px;
      font-size: 0.75rem; font-weight: normal; z-index: 50;
      transition: opacity 0.2s; pointer-events: none;
      box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
    }
    .tooltip-wrapper:hover .tooltip-content { visibility: visible; opacity: 1; }
    .tooltip-arrow {
      position: absolute; top: 100%; left: 50%; margin-left: -5px;
      border-width: 5px; border-style: solid;
      border-color: #334155 transparent transparent transparent;
    }

    /* --- PRINT STYLES --- */
    @media print {
      body { background: white; color: black; -webkit-print-color-adjust: exact; }
      .shell { border: none; box-shadow: none; max-width: 100%; width: 100%; padding: 0; }
      #calculatorInputs, #themeControls, #buttonContainer, #repSettingsPanel, 
      #feeContainer button, #prepaySection button, #headerPoweredBy, 
      .tooltip-icon { display: none !important; }
      #offerCard { border: 1px solid #ddd; box-shadow: none; break-inside: avoid; }
      #headerContainer { justify-content: center !important; border-bottom: 2px solid #000; margin-bottom: 20px; }
      #headerTitle { font-size: 24px; font-weight: bold; color: black; }
      .text-hero { color: black !important; }
      .donut-container { border: 1px solid #eee; }
      .card-inner-bg { background-color: #fff; border: 1px solid #eee; }
      /* Ensure inputs display values as text */
      input { border: none; background: transparent; padding: 0; margin: 0; }
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-2 transition-colors duration-200">

  <div class="w-full max-w-xl card-bg shell text-primary rounded-xl shadow-lg p-4 md:p-6 space-y-4 border">

    <!-- HEADER -->
    <div id="headerContainer" class="pb-3 border-b border-primary flex flex-col items-center gap-3">
      <div class="flex flex-col items-center justify-center flex-shrink-0">
        <div id="headerLogoWrapper" class="flex items-center justify-center mb-2">
            <!-- Image is hidden by default -->
            <img id="headerLogo" src="" alt="Company Logo" class="h-16 w-auto object-contain hidden" />
            <!-- Placeholder Icon (Accent Color Shield with Transparent Check) -->
            <svg id="placeholderIcon" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-hero" viewBox="0 0 24 24" fill="currentColor">
               <path fill-rule="evenodd" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4zm-2 16l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" clip-rule="evenodd"/>
            </svg>
        </div>
        <h1 id="headerTitle" class="text-primary text-xl mt-0 text-center font-normal tracking-wide">TrustBureau.ai</h1>
        <span id="headerPoweredBy" class="text-xs font-semibold text-muted uppercase tracking-widest mt-1 hidden">powered by TrustBureau.ai</span>
      </div>
      <div id="themeControls" class="flex items-center justify-center">
        <button id="repSettingsToggle" type="button"
                class="px-2 py-1 text-xs rounded-lg border border-primary text-muted hover:text-primary hover:border-primary flex items-center gap-1 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z" />
            <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 016 0z" />
          </svg>
          Settings
        </button>
      </div>
    </div>

    <!-- OFFER CALCULATOR -->
    <div id="calculatorInputs" class="space-y-4 pt-2">
      <div id="businessNameContainer" class="px-1 mt-2">
        <label for="businessNameInput" class="block text-xs font-semibold text-muted">
          Business Name
        </label>
        <input id="businessNameInput" type="text"
               class="mt-1 w-full p-2 text-sm border rounded-lg shadow-sm input-field"
               placeholder="e.g., Acme Holdings LLC" />
      </div>

      <div class="card-inner-bg p-4 rounded-xl shadow-inner space-y-4">
        <div id="amountContainer" class="space-y-1">
          <label for="calcAmount" class="block text-xs font-semibold text-muted">
            Amount You Get ($)
          </label>
          <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1"
                 value="50000"
                 class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb mb-2" />
          <div class="relative group">
            <span class="absolute left-3 input-icon text-muted text-sm">$</span>
            <input id="calcAmountInput" inputmode="numeric"
                   class="w-full p-2 pl-8 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <div id="factorContainer" class="space-y-1">
          <label for="calcFactor" class="block text-xs font-semibold text-muted">
            Factor Rate
            <div class="tooltip-wrapper">
              <span class="tooltip-icon">i</span>
              <div class="tooltip-content">
                The multiplier applied to the amount you receive. E.g., 1.25x on $10k means paying back $12.5k.
                <div class="tooltip-arrow"></div>
              </div>
            </div>
          </label>
          <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25"
                 class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb" />
          <div class="relative group">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-4 w-4 absolute left-3 input-icon text-muted"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M6 18 18 6M6 6l12 12" />
            </svg>
            <input id="calcFactorInput" type="number" step="0.01"
                   class="w-full p-2 pl-9 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <div id="termContainer" class="space-y-1">
          <label for="calcTerm" class="block text-xs font-semibold text-muted">
            Number of Payments
          </label>
          <input id="calcTermSlider" type="range" min="3" max="528" step="1" value="130"
                 class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb" />
          <div class="relative group">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-3 w-3 absolute left-3 input-icon text-muted"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z" />
            </svg>
            <input id="calcTermInput" type="number" step="1"
                   class="w-full p-2 pl-8 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <div id="termLengthMonthsContainer" class="space-y-1">
          <label for="termLengthMonthsInput" class="block text-xs font-semibold text-muted">
            Term Length (Display Override)
          </label>
          <div class="relative group">
            <input id="termLengthMonthsInput" type="number" step="0.5" min="1"
                   class="w-full p-2 text-sm border rounded-lg shadow-sm input-field"
                   placeholder="Auto" />
          </div>
        </div>
      </div>

      <div id="toggleContainer" class="flex items-center justify-center space-x-2">
        <button id="toggleDaily" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
          Daily
        </button>
        <button id="toggleWeekly" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
          Weekly
        </button>
        <button id="toggleMonthly" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
          Monthly
        </button>
      </div>
    </div>

    <!-- OFFER 1 CARD -->
    <div id="offerCard" class="card-bg p-4 rounded-lg shadow-md border border-primary">
      <div class="flex justify-center items-center border-b border-primary pb-3 pt-3">
        <h4 class="text-sm font-semibold text-secondary">Offer 1 â€“ Your Approved Terms</h4>
      </div>
      
      <!-- Top Summary Section with Donut Chart -->
      <div class="flex flex-col items-center justify-center py-6 gap-6">
        <div class="text-center">
          <span id="businessNameDisplay"
                class="text-sm font-semibold text-primary block mb-1 hidden"></span>
          <span class="text-xs font-semibold text-muted block">You Get</span>
          <span id="summaryAmountOut"
                class="text-5xl font-bold block my-2 text-hero leading-tight">$50,000</span>
          <span class="text-sm font-medium text-secondary block">
            Total Payback:
            <span id="summaryPaybackOut" class="font-semibold text-primary"></span>
          </span>
        </div>
        
        <!-- VISUAL BREAKDOWN (DONUT CHART) -->
        <div class="flex flex-col items-center">
           <div id="donutChart" class="donut-container">
             <div class="donut-inner">
               <span class="text-[10px] text-muted font-semibold">Cost</span>
               <span id="donutPercent" class="text-xs font-bold text-primary">$12,500</span>
             </div>
           </div>
           <span class="text-[10px] text-muted mt-2">Breakdown</span>
        </div>
      </div>

      <div class="flex justify-center items-center border-b border-primary pb-2">
        <h5 class="text-sm font-semibold text-secondary text-center">Offer Details</h5>
      </div>
      
      <!-- TABLE LAYOUT -->
      <div class="mt-6 border border-primary rounded-lg overflow-hidden">
        <div class="divide-y divide-primary">
           <!-- Row 1: Term Info -->
           <div class="grid grid-cols-2 divide-x divide-primary bg-card-inner-bg/50">
             <div class="p-3 text-center">
               <span class="text-xs font-medium text-muted block">Term Length</span>
               <span id="summaryTermLengthOut" class="text-xs font-normal text-primary block mt-1"></span>
             </div>
             <div class="p-3 text-center">
               <span class="text-xs font-medium text-muted block">Payments</span>
               <span id="summaryTermOut" class="text-xs font-normal text-primary block mt-1"></span>
             </div>
           </div>
           
           <!-- Row 2: Rates & Cost -->
           <div class="grid grid-cols-2 divide-x divide-primary bg-card-inner-bg/50">
             <div class="p-3 text-center">
               <span class="text-xs font-medium text-muted block">
                 Factor Rate
                 <div class="tooltip-wrapper">
                   <span class="tooltip-icon">i</span>
                   <div class="tooltip-content">
                     Your buy rate. 1.30 means you pay back $1.30 for every $1.00 borrowed.
                     <div class="tooltip-arrow"></div>
                   </div>
                 </div>
               </span>
               <span id="summaryFactorOut" class="text-xs font-normal text-primary block mt-1"></span>
             </div>
             <div class="p-3 text-center">
               <span class="text-xs font-medium text-muted block">
                 Total Cost of Funds
                 <div class="tooltip-wrapper">
                   <span class="tooltip-icon">i</span>
                   <div class="tooltip-content">
                     The total amount of interest/fees you will pay over the life of the advance.
                     <div class="tooltip-arrow"></div>
                   </div>
                 </div>
               </span>
               <span id="summaryCostOut" class="text-xs font-normal text-primary block mt-1"></span>
             </div>
           </div>
           
           <!-- Row 3: Fee & Net -->
           <div id="detailsRowFee" class="grid grid-cols-2 divide-x divide-primary bg-card-inner-bg/50">
             <div id="feeGridItem" class="p-3 text-center">
               <span class="text-xs font-medium text-muted block">
                 Origination Fee
                 <div class="tooltip-wrapper">
                   <span class="tooltip-icon">i</span>
                   <div class="tooltip-content">
                     A one-time processing fee deducted from the funded amount at closing.
                     <div class="tooltip-arrow"></div>
                   </div>
                 </div>
               </span>
               <span id="summaryFeeOut" class="text-xs font-normal text-primary block mt-1"></span>
             </div>
             <div id="netGridItem" class="p-3 text-center">
               <span class="text-xs font-medium text-muted block">Net Proceeds</span>
               <span id="summaryNetOut" class="text-xs font-normal text-primary block mt-1"></span>
             </div>
           </div>
           
           <!-- Footer: Payment -->
           <div class="p-4 text-center bg-slider-track/20">
             <span id="summaryPaymentLabel" class="text-xs font-medium text-muted block">Est. Daily Payment</span>
             <span id="summaryPaymentValue" class="text-xs font-normal text-primary block mt-1"></span>
           </div>
        </div>
      </div>

      <!-- Fee Container -->
      <div id="feeContainer" class="mt-4 pt-4 border-t border-primary">
          <button id="toggleFeeBtn" type="button" class="w-full text-xs font-semibold text-muted hover:text-primary flex items-center justify-center gap-1 transition-colors">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-hero" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Add Origination Fee
          </button>
          <div id="feeInputWrapper" class="hidden mt-4 card-inner-bg p-4 rounded-lg border border-primary">
            <label for="calcFee" class="block text-xs font-semibold text-muted">Origination Fee (%)</label>
            <input id="calcFeeSlider" type="range" min="0" max="10" step="0.5" value="0"
                   class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb" />
            <div class="relative group mt-1">
               <span class="absolute left-3 input-icon text-muted text-sm">%</span>
              <input id="calcFeeInput" type="number" step="0.1"
                     class="w-full p-2 pl-8 text-sm border rounded-lg shadow-sm input-field" />
            </div>
          </div>
      </div>

      <!-- Prepay Discount Section -->
      <div id="prepaySection" class="mt-4 pt-4 border-t border-primary">
        <button id="togglePrepay" class="w-full text-xs font-semibold text-muted hover:text-primary flex items-center justify-center gap-1 transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-hero" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          Calculate Prepayment Discount
        </button>

        <div id="prepayContainer" class="hidden mt-4 card-inner-bg p-4 rounded-lg border border-primary">
          <div class="flex justify-between items-center mb-2 pb-2 border-b border-primary">
            <span class="text-xs font-semibold text-secondary">Prepayment Discount</span>
            <span id="prepayPercentDisplay" class="text-xs font-bold text-hero">0%</span>
          </div>

          <!-- Rep View: Slider -->
          <div id="prepaySliderContainer" class="pt-2">
             <input id="prepaySlider" type="range" min="0" max="25" step="1" value="0"
                    class="w-full h-1.5 slider-track rounded-lg cursor-pointer slider-thumb mb-4" />
             <p class="text-xs text-muted text-center italic">Adjust max discount policy (Rep View)</p>
          </div>

          <!-- Client View: Date Picker -->
          <div id="prepayDateContainer" class="hidden mb-4 pt-2">
            <label class="block text-xs font-semibold text-muted mb-1 text-center">Select Payoff Date</label>
            <input id="prepayDateInput" type="date"
                   class="w-full p-2 text-sm rounded-lg border border-primary input-field text-center" />
          </div>

          <div class="grid grid-cols-2 gap-4 text-center border-t border-primary pt-3">
            <div>
              <span class="text-xs font-semibold text-muted block uppercase tracking-wider">Savings</span>
              <span id="prepaySavingsDisplay" class="text-sm font-bold text-success">$0.00</span>
            </div>
            <div>
              <span class="text-xs font-semibold text-muted block uppercase tracking-wider">New Payoff</span>
              <span id="prepayTotalDisplay" class="text-sm font-bold text-primary">$0.00</span>
            </div>
          </div>

          <!-- Amortization Button -->
          <div id="amortizationBtnContainer" class="mt-4 text-center hidden">
            <button id="viewAmortizationBtn" type="button"
                    class="text-xs font-semibold text-hero underline hover:text-primary transition-colors">
              View Amortization Schedule
            </button>
          </div>
        </div>
      </div>

      <div id="repContactBlock" class="mt-6 pt-3 border-t border-primary text-xs text-secondary text-center hidden">
        <div class="font-semibold text-muted mb-1">Your Funding Specialist</div>
        <div id="repNameDisplay" class="font-medium"></div>
        <div id="repEmailDisplay"></div>
        <div id="repPhoneDisplay"></div>
      </div>
    </div>

    <!-- STATIC ADDITIONAL OFFERS -->
    <div id="savedOffersSection" class="card-bg mt-4 p-4 rounded-lg shadow-md border border-primary hidden">
      <div class="flex justify-between items-center border-b border-primary pb-2 mb-4">
        <h5 class="text-sm font-semibold text-secondary">Additional Offers</h5>
      </div>
      <div id="savedOffersContainer" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <!-- BUTTONS -->
    <div id="buttonContainer" class="pt-4 border-t border-primary space-y-3">
      <!-- Sales Tools Row -->
      <div class="">
        <button id="copyEmailButton" class="w-full px-4 py-2 rounded-lg border border-primary text-secondary hover:bg-slider-track transition-colors flex items-center justify-center gap-2 text-xs font-semibold">
           <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
             <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
           </svg>
           Copy Email Script
        </button>
      </div>

      <!-- Action Row -->
      <div class="relative flex justify-center gap-3 flex-wrap">
        <button id="addOfferButton" class="button-primary flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
          </svg>
          Add Offer
        </button>
        <button id="shareLinkButton" class="button-primary flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684z"/>
          </svg>
          Share Link
        </button>
      </div>
    </div>

  </div>

  <!-- AMORTIZATION MODAL -->
  <div id="amortizationModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 hidden backdrop-blur-sm p-4">
    <div class="card-bg w-full max-w-2xl max-h-[85vh] rounded-xl shadow-2xl flex flex-col border border-primary">
      <div class="p-4 border-b border-primary flex justify-between items-center bg-slate-50 dark:bg-slate-900 rounded-t-xl">
        <h3 class="font-semibold text-lg text-primary">Amortization Schedule</h3>
        <button id="closeAmortizationBtn" class="text-muted hover:text-primary transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div class="overflow-auto p-0 flex-1">
         <table class="w-full text-left amort-table">
           <thead class="sticky top-0 z-10 shadow-sm">
             <tr>
               <th>#</th>
               <th>Date</th>
               <th>Payment</th>
               <th>Balance</th>
               <th>Prepay Savings</th>
               <th>Payoff Amount</th>
             </tr>
           </thead>
           <tbody id="amortizationTableBody">
             <!-- JS injected rows -->
           </tbody>
         </table>
      </div>
      <div class="p-3 border-t border-primary text-center text-xs text-muted bg-slate-50 dark:bg-slate-900 rounded-b-xl">
        * Schedule is an estimate. Actual payoff dates and amounts may vary based on banking holidays and clear dates.
      </div>
    </div>
  </div>

  <script>
    const elements = {
      calcAmountSlider: document.getElementById('calcAmountSlider'),
      calcFactorSlider: document.getElementById('calcFactorSlider'),
      calcFeeSlider: document.getElementById('calcFeeSlider'),
      calcTermSlider: document.getElementById('calcTermSlider'),
      calcAmountInput: document.getElementById('calcAmountInput'),
      calcFactorInput: document.getElementById('calcFactorInput'),
      calcFeeInput: document.getElementById('calcFeeInput'),
      calcTermInput: document.getElementById('calcTermInput'),
      termLengthMonthsInput: document.getElementById('termLengthMonthsInput'),

      toggleDaily: document.getElementById('toggleDaily'),
      toggleWeekly: document.getElementById('toggleWeekly'),
      toggleMonthly: document.getElementById('toggleMonthly'),

      shareLinkButton: document.getElementById('shareLinkButton'),
      addOfferButton: document.getElementById('addOfferButton'),
      copyEmailButton: document.getElementById('copyEmailButton'),

      summaryAmountOut: document.getElementById('summaryAmountOut'),
      summaryPaybackOut: document.getElementById('summaryPaybackOut'),
      summaryFactorOut: document.getElementById('summaryFactorOut'),
      summaryTermOut: document.getElementById('summaryTermOut'),
      summaryCostOut: document.getElementById('summaryCostOut'),
      summaryPaymentLabel: document.getElementById('summaryPaymentLabel'),
      summaryPaymentValue: document.getElementById('summaryPaymentValue'),
      summaryFeeOut: document.getElementById('summaryFeeOut'),
      summaryNetOut: document.getElementById('summaryNetOut'),
      summaryTermLengthOut: document.getElementById('summaryTermLengthOut'),
      feeGridItem: document.getElementById('feeGridItem'),
      netGridItem: document.getElementById('netGridItem'),
      detailsRowFee: document.getElementById('detailsRowFee'),

      businessNameInput: document.getElementById('businessNameInput'),
      businessNameDisplay: document.getElementById('businessNameDisplay'),
      businessNameContainer: document.getElementById('businessNameContainer'),

      repSettingsToggle: document.getElementById('repSettingsToggle'),
      repSettingsPanel: document.getElementById('repSettingsPanel'),
      repNameInput: document.getElementById('repNameInput'),
      repEmailInput: document.getElementById('repEmailInput'),
      repPhoneInput: document.getElementById('repPhoneInput'),
      repContactBlock: document.getElementById('repContactBlock'),
      repNameDisplay: document.getElementById('repNameDisplay'),
      repEmailDisplay: document.getElementById('repEmailDisplay'),
      repPhoneDisplay: document.getElementById('repPhoneDisplay'),
      
      companyNameInput: document.getElementById('companyNameInput'),
      companyLogoInput: document.getElementById('companyLogoInput'),
      headerTitle: document.getElementById('headerTitle'),
      headerLogo: document.getElementById('headerLogo'),
      placeholderIcon: document.getElementById('placeholderIcon'),
      headerLogoWrapper: document.getElementById('headerLogoWrapper'),
      headerPoweredBy: document.getElementById('headerPoweredBy'),

      headerContainer: document.getElementById('headerContainer'),
      themeControls: document.getElementById('themeControls'),
      calculatorInputs: document.getElementById('calculatorInputs'),
      factorContainer: document.getElementById('factorContainer'),
      
      feeContainer: document.getElementById('feeContainer'),
      toggleFeeBtn: document.getElementById('toggleFeeBtn'),
      feeInputWrapper: document.getElementById('feeInputWrapper'),

      termContainer: document.getElementById('termContainer'),
      termLengthMonthsContainer: document.getElementById('termLengthMonthsContainer'),
      toggleContainer: document.getElementById('toggleContainer'),
      buttonContainer: document.getElementById('buttonContainer'),

      savedOffersSection: document.getElementById('savedOffersSection'),
      savedOffersContainer: document.getElementById('savedOffersContainer'),

      prepaySection: document.getElementById('prepaySection'),
      togglePrepay: document.getElementById('togglePrepay'),
      prepayContainer: document.getElementById('prepayContainer'),
      prepaySliderContainer: document.getElementById('prepaySliderContainer'),
      prepaySlider: document.getElementById('prepaySlider'),
      prepayDateContainer: document.getElementById('prepayDateContainer'),
      prepayDateInput: document.getElementById('prepayDateInput'),
      prepayPercentDisplay: document.getElementById('prepayPercentDisplay'),
      prepaySavingsDisplay: document.getElementById('prepaySavingsDisplay'),
      prepayTotalDisplay: document.getElementById('prepayTotalDisplay'),

      amortizationBtnContainer: document.getElementById('amortizationBtnContainer'),
      viewAmortizationBtn: document.getElementById('viewAmortizationBtn'),
      amortizationModal: document.getElementById('amortizationModal'),
      closeAmortizationBtn: document.getElementById('closeAmortizationBtn'),
      amortizationTableBody: document.getElementById('amortizationTableBody'),
      
      donutChart: document.getElementById('donutChart'),
      donutPercent: document.getElementById('donutPercent')
    };

    let paymentFrequency = 'daily';
    let currentBaseTheme = 'theme-light';
    let currentAccentClass = 'accent-mint';
    let amountSliderMax = 1000000;
    const MAX_ADDITIONAL_OFFERS = 2;
    let savedOffers = [];
    let isApprovalView = false;
    let termLengthManualDirty = false;
    let prepayDiscountPercent = 0;
    
    const DEFAULT_COMPANY_NAME = "TrustBureau.ai";
    const DEFAULT_LOGO_URL = "";

    function setBaseTheme(themeName) {
      document.documentElement.classList.remove('theme-light', 'theme-dark', 'theme-black');
      currentBaseTheme = themeName;
      document.documentElement.classList.add(themeName);
      applyTheme();
    }

    function setAccent(accentName) {
       const classes = document.documentElement.classList;
       for (let i = classes.length - 1; i >= 0; i--) {
           if (classes[i].startsWith('accent-')) classes.remove(classes[i]);
       }
       currentAccentClass = accentName;
       document.documentElement.classList.add(accentName);
       applyTheme();
    }

    function setAmountSliderMax(cap) {
      amountSliderMax = cap;
      if (elements.calcAmountSlider) elements.calcAmountSlider.max = String(cap);
    }

    function formatCurrency(num) {
      const n = Number(num);
      if (isNaN(n)) return '$0';
      return new Intl.NumberFormat('en-US', {
        style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2,
      }).format(n);
    }

    function parseFormattedNumber(val) {
      if (typeof val !== 'string' || !val) return 0;
      return parseFloat(val.replace(/[\$,]/g, '')) || 0;
    }

    function computeOffer(amount, factor, termPayments, frequency, feePercent) {
      const totalPayback = amount * factor;
      const totalCost = totalPayback - amount;
      const paymentsCount = termPayments > 0 ? termPayments : 1;
      const paymentAmount = totalPayback / paymentsCount;
      const feeAmount = amount * (feePercent / 100);
      const netProceeds = amount - feeAmount;

      let rawMonths;
      if (frequency === 'weekly') rawMonths = termPayments * (12 / 52);
      else if (frequency === 'monthly') rawMonths = termPayments;
      else rawMonths = termPayments * (12 / 250);
      
      const termLengthMonths = Math.round(rawMonths * 2) / 2;
      let paymentLabel = 'Est. Daily Payment';
      if (frequency === 'weekly') paymentLabel = 'Est. Weekly Payment';
      if (frequency === 'monthly') paymentLabel = 'Est. Monthly Payment';

      return {
        amount, factor, feePercent, feeAmount, netProceeds, termMonths: termPayments,
        termLengthMonths, totalPayback, totalCost, payment: paymentAmount,
        paymentLabel, frequency,
      };
    }

    function getCurrentOffer() {
      const amount = parseFormattedNumber(elements.calcAmountInput.value);
      const factor = parseFloat(elements.calcFactorInput.value) || 1.05;
      const termPayments = parseInt(elements.calcTermInput.value) || 1;
      const fee = parseFloat(elements.calcFeeInput.value) || 0;
      return computeOffer(amount, factor, termPayments, paymentFrequency, fee);
    }

    function renderSavedOffers() {
      if (!elements.savedOffersSection || !elements.savedOffersContainer) return;
      if (savedOffers.length === 0) {
        elements.savedOffersSection.classList.add('hidden');
        elements.savedOffersContainer.innerHTML = '';
        return;
      }
      elements.savedOffersSection.classList.remove('hidden');

      const cardsHtml = savedOffers.map((offer, index) => {
        const labelIndex = index + 2;
        return `
          <div class="card-bg rounded-lg border border-primary overflow-hidden">
            <div class="p-3 border-b border-primary flex justify-center items-center">
                <span class="text-xs font-semibold text-secondary">Offer ${labelIndex}</span>
            </div>
            <div class="p-4 text-center border-b border-primary">
                <span class="text-[10px] font-semibold text-muted uppercase tracking-wide">You Get</span>
                <span class="text-3xl font-bold text-hero mt-1 block">${formatCurrency(offer.amount)}</span>
            </div>
            <div class="divide-y divide-primary text-xs">
                <div class="grid grid-cols-2 divide-x divide-primary">
                    <div class="p-2 text-center">
                        <span class="text-[10px] text-muted block">Factor</span>
                        <span class="font-medium text-primary">${offer.factor.toFixed(2)}x</span>
                    </div>
                    <div class="p-2 text-center">
                        <span class="text-[10px] text-muted block">Term</span>
                        <span class="font-medium text-primary">${offer.termMonths}</span>
                    </div>
                </div>
                 <div class="grid grid-cols-2 divide-x divide-primary">
                    <div class="p-2 text-center">
                        <span class="text-[10px] text-muted block">Payback</span>
                        <span class="font-medium text-primary">${formatCurrency(offer.totalPayback)}</span>
                    </div>
                    <div class="p-2 text-center">
                        <span class="text-[10px] text-muted block">${offer.frequency === 'weekly' ? 'Weekly' : 'Daily'}</span>
                        <span class="font-medium text-primary">${formatCurrency(offer.payment)}</span>
                    </div>
                </div>
            </div>
          </div>
        `;
      }).join('');
      elements.savedOffersContainer.innerHTML = cardsHtml;
    }

    function updateAddOfferButtonState() {
      if (!elements.addOfferButton) return;
      const remaining = MAX_ADDITIONAL_OFFERS - savedOffers.length;
      elements.addOfferButton.disabled = remaining <= 0;
    }

    function handleAddOffer() {
      if (savedOffers.length >= MAX_ADDITIONAL_OFFERS) return;
      const offer = getCurrentOffer();
      savedOffers.push({ ...offer });
      renderSavedOffers();
      updateAddOfferButtonState();
    }

    function syncInputs(slider, input, isCurrency, min, max, callback) {
      const isAmountSlider = (slider === elements.calcAmountSlider);
      const getMax = () => (isAmountSlider ? amountSliderMax : max);
      const initialValue = parseFloat(slider.value);
      input.value = isCurrency ? formatCurrency(initialValue) : initialValue.toString();

      slider.addEventListener('input', () => {
        let val = parseFloat(slider.value);
        const cap = getMax();
        if (!isNaN(val) && val > cap) { val = cap; slider.value = val; }
        input.value = isCurrency ? formatCurrency(val) : val;
        callback();
      });

      input.addEventListener('input', () => {
        let val = isCurrency ? parseFormattedNumber(input.value) : parseFloat(input.value);
        const cap = getMax();
        if (!isNaN(val) && val >= min && val <= cap) { slider.value = val; callback(); }
        else if (input.value === '') { callback(); }
      });

      input.addEventListener('blur', () => {
        let val = isCurrency ? parseFormattedNumber(input.value) : parseFloat(input.value);
        const cap = getMax();
        if (isNaN(val) || val < min) val = min;
        if (val > cap) val = cap;
        slider.value = val;
        input.value = isCurrency ? formatCurrency(val) : val.toString();
        callback();
      });
    }

    function applyTheme() {
      document.documentElement.className = `${currentBaseTheme} ${currentAccentClass}`;
      try { localStorage.setItem('theme', currentBaseTheme); } catch (e) {}
    }

    function updateRepDisplay() {
      if (!elements.repContactBlock) return;
      const name = elements.repNameInput ? elements.repNameInput.value.trim() : '';
      const email = elements.repEmailInput ? elements.repEmailInput.value.trim() : '';
      const phone = elements.repPhoneInput ? elements.repPhoneInput.value.trim() : '';
      const hasAny = name || email || phone;
      if (hasAny) elements.repContactBlock.classList.remove('hidden');
      else elements.repContactBlock.classList.add('hidden');
      if (elements.repNameDisplay) elements.repNameDisplay.textContent = name;
      if (elements.repEmailDisplay) elements.repEmailDisplay.textContent = email;
      if (elements.repPhoneDisplay) elements.repPhoneDisplay.textContent = phone;
    }
    
    function updateBranding() {
       const cName = elements.companyNameInput.value.trim();
       const cLogo = elements.companyLogoInput.value.trim();
       if (cName) {
          elements.headerTitle.textContent = cName;
          elements.headerTitle.classList.remove('hidden');
          elements.headerPoweredBy.classList.remove('hidden');
       } else {
          elements.headerTitle.textContent = DEFAULT_COMPANY_NAME;
          elements.headerTitle.classList.remove('hidden');
          elements.headerPoweredBy.classList.add('hidden');
       }
       if (cLogo) {
         elements.headerLogo.src = cLogo;
         elements.headerLogo.classList.remove('hidden');
         elements.placeholderIcon.classList.add('hidden');
       } else {
         elements.headerLogo.src = "";
         elements.headerLogo.classList.add('hidden');
         elements.placeholderIcon.classList.remove('hidden');
       }
    }

    function updatePaymentToggleUI() {
      const toggles = [elements.toggleDaily, elements.toggleWeekly, elements.toggleMonthly];
      const frequencies = ['daily', 'weekly', 'monthly'];
      toggles.forEach((toggle, index) => {
        if (!toggle) return;
        toggle.classList.remove('toggle-active', 'toggle-inactive');
        if (paymentFrequency === frequencies[index]) toggle.classList.add('toggle-active');
        else toggle.classList.add('toggle-inactive');
      });
    }

    function initializeFromURL() {
      const params = new URLSearchParams(window.location.search);
      const amountParam = params.get('amount');
      const amount = amountParam ? parseFloat(amountParam) : 50000;
      const factor = params.get('factor') || 1.25;
      const term = params.get('term') || 130; 
      const fee = parseFloat(params.get('fee')) || 0;
      const freq = params.get('freq');
      const paramTheme = params.get('theme');
      const paramAccent = params.get('accent');
      const offersParam = params.get('offers');
      const businessNameParam = params.get('businessName') || '';
      const repNameParam = params.get('repName') || '';
      const repEmailParam = params.get('repEmail') || '';
      const repPhoneParam = params.get('repPhone') || '';
      const prepayParam = params.get('prepay');
      const cNameParam = params.get('cName') || '';
      const cLogoParam = params.get('cLogo') || '';

      if (prepayParam) {
        prepayDiscountPercent = parseInt(prepayParam, 10);
        if (elements.prepaySlider) elements.prepaySlider.value = prepayDiscountPercent;
      }

      isApprovalView = (params.get('view') === 'approval');
      if(paramTheme) currentBaseTheme = paramTheme;
      if(paramAccent) currentAccentClass = paramAccent;
      applyTheme();

      setAmountSliderMax(isApprovalView ? amount : 1000000);

      elements.calcAmountInput.value = formatCurrency(amount);
      elements.calcAmountSlider.value = amount;
      elements.calcFactorSlider.value = factor;
      elements.calcFactorInput.value = factor;
      elements.calcTermSlider.value = term;
      elements.calcTermInput.value = term;
      elements.calcFeeSlider.value = fee;
      elements.calcFeeInput.value = fee;
      
      if (fee > 0 && !isApprovalView && elements.feeInputWrapper) elements.feeInputWrapper.classList.remove('hidden');
      if (elements.businessNameInput) elements.businessNameInput.value = businessNameParam;
      if (elements.repNameInput) elements.repNameInput.value = repNameParam;
      if (elements.repEmailInput) elements.repEmailInput.value = repEmailParam;
      if (elements.repPhoneInput) elements.repPhoneInput.value = repPhoneParam;
      if (elements.companyNameInput) elements.companyNameInput.value = cNameParam;
      if (elements.companyLogoInput) elements.companyLogoInput.value = cLogoParam;

      updateBranding();
      paymentFrequency = freq || 'daily';
      savedOffers = [];
      if (offersParam) {
        try {
          const rawOffers = JSON.parse(offersParam);
          if (Array.isArray(rawOffers)) {
            savedOffers = rawOffers.map((raw) => {
              const a = Number(raw.a ?? raw.amount ?? 0);
              const f = Number(raw.f ?? raw.factor ?? 1.1);
              const tRaw = raw.t ?? raw.term ?? 3;
              const t = parseInt(tRaw, 10);
              const termPayments = Number.isNaN(t) ? 1 : t;
              const q = raw.q ?? raw.frequency ?? 'daily';
              const fe = Number(raw.fee ?? 0);
              return computeOffer(a, f, termPayments, q, fe);
            });
          }
        } catch (err) { console.error('Error parsing offers from URL', err); }
      }

      if (isApprovalView) {
        if (elements.factorContainer) elements.factorContainer.style.display = 'none';
        if (elements.feeContainer) elements.feeContainer.style.display = 'none';
        if (elements.termContainer) elements.termContainer.style.display = 'none';
        if (elements.termLengthMonthsContainer) elements.termLengthMonthsContainer.style.display = 'none';
        if (elements.toggleContainer) elements.toggleContainer.style.display = 'none';
        if (elements.businessNameContainer) elements.businessNameContainer.style.display = 'none';
        if (elements.businessNameInput) elements.businessNameInput.disabled = true;
        if (elements.themeControls) elements.themeControls.style.display = 'none';
        if (elements.repSettingsToggle) elements.repSettingsToggle.style.display = 'none';
        if (elements.repSettingsPanel) elements.repSettingsPanel.style.display = 'none';
        
        // Hide Sales Tools in Client View (optional, currently hiding entire container)
        if (elements.buttonContainer) elements.buttonContainer.style.display = 'none';

        if (elements.prepaySliderContainer) elements.prepaySliderContainer.style.display = 'none';
        if (elements.prepayDateContainer) elements.prepayDateContainer.classList.remove('hidden');
        elements.headerContainer.classList.remove('justify-between');
        elements.headerContainer.classList.add('justify-center');
      } else {
        if (elements.prepayDateContainer) elements.prepayDateContainer.classList.add('hidden');
      }
    }

    function generateSchedule(offer) {
      const schedule = [];
      let currentDate = new Date();
      currentDate.setHours(0,0,0,0);
      const totalPayments = offer.termMonths;
      const paymentAmount = offer.payment;
      const totalPayback = offer.totalPayback;
      const maxDiscount = totalPayback * (prepayDiscountPercent / 100);
      let runningDate = new Date(currentDate);
      let paidSoFar = 0;

      for (let i = 1; i <= totalPayments; i++) {
         if (offer.frequency === 'weekly') runningDate.setDate(runningDate.getDate() + 7);
         else if (offer.frequency === 'monthly') runningDate.setMonth(runningDate.getMonth() + 1);
         else {
            do { runningDate.setDate(runningDate.getDate() + 1); } 
            while (runningDate.getDay() === 0 || runningDate.getDay() === 6);
         }
         paidSoFar += paymentAmount;
         const remainingBalance = totalPayback - paidSoFar;
         const fractionRemaining = (totalPayments - i) / totalPayments;
         const savings = maxDiscount * fractionRemaining;
         let payoff = remainingBalance - savings;
         if (payoff < 0) payoff = 0;

         schedule.push({
            num: i, date: new Date(runningDate), payment: paymentAmount,
            balance: remainingBalance < 0.01 ? 0 : remainingBalance,
            savings: savings, payoff: payoff
         });
      }
      return schedule;
    }

    function renderAmortizationSchedule(offer) {
       if (!elements.amortizationTableBody) return;
       const schedule = generateSchedule(offer);
       const rows = schedule.map(row => {
          return `<tr class="hover:bg-slate-50 dark:hover:bg-slate-800/50 transition-colors">
              <td class="font-mono text-xs text-muted">${row.num}</td>
              <td>${row.date.toLocaleDateString()}</td>
              <td>${formatCurrency(row.payment)}</td>
              <td>${formatCurrency(row.balance)}</td>
              <td class="text-success font-medium">${formatCurrency(row.savings)}</td>
              <td class="font-semibold text-primary">${formatCurrency(row.payoff)}</td>
            </tr>`;
       }).join('');
       elements.amortizationTableBody.innerHTML = rows;
    }

    function calculatePrepay(offer) {
      if (isApprovalView) {
        if (prepayDiscountPercent > 0) elements.amortizationBtnContainer.classList.remove('hidden');
        else elements.amortizationBtnContainer.classList.add('hidden');
      }
      if (isApprovalView && prepayDiscountPercent === 0) {
        elements.prepaySection.classList.add('hidden');
        return;
      }
      elements.prepaySection.classList.remove('hidden');
      if (!elements.prepayContainer || elements.prepayContainer.classList.contains('hidden')) return;

      const totalPayback = offer.totalPayback;
      let savings = 0;

      if (isApprovalView) {
        const dateVal = elements.prepayDateInput.value;
        if (!dateVal) {
           const today = new Date().toISOString().split('T')[0];
           elements.prepayDateInput.value = today;
        }
        const startDate = new Date(); startDate.setHours(0,0,0,0);
        let termDays = 0;
        if (offer.frequency === 'weekly') termDays = offer.termMonths * 7;
        else if (offer.frequency === 'monthly') termDays = offer.termMonths * 30.44;
        else termDays = offer.termMonths * 1.42; 

        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + Math.ceil(termDays));
        elements.prepayDateInput.min = startDate.toISOString().split('T')[0];
        elements.prepayDateInput.max = endDate.toISOString().split('T')[0];

        let selectedDate = new Date(elements.prepayDateInput.value);
        selectedDate.setHours(0,0,0,0);
        if (selectedDate < startDate) selectedDate = startDate;
        if (selectedDate > endDate) selectedDate = endDate;

        const totalTime = endDate.getTime() - startDate.getTime();
        const remainingTime = endDate.getTime() - selectedDate.getTime();
        let fractionRemaining = 0;
        if (totalTime > 0) fractionRemaining = remainingTime / totalTime;
        if (fractionRemaining < 0) fractionRemaining = 0;
        if (fractionRemaining > 1) fractionRemaining = 1;

        const maxPotentialSavings = totalPayback * (prepayDiscountPercent / 100);
        savings = maxPotentialSavings * fractionRemaining;
        elements.prepayPercentDisplay.textContent = `${prepayDiscountPercent}% Max`;
      } else {
        savings = totalPayback * (prepayDiscountPercent / 100);
        elements.prepayPercentDisplay.textContent = `${prepayDiscountPercent}%`;
      }
      const newPayoff = totalPayback - savings;
      elements.prepaySavingsDisplay.textContent = formatCurrency(savings);
      elements.prepayTotalDisplay.textContent = formatCurrency(newPayoff);
    }

    function runCalculator() {
      try {
        const amount = parseFormattedNumber(elements.calcAmountInput.value);
        const factor = parseFloat(elements.calcFactorInput.value) || 1.05;
        const termPayments = parseInt(elements.calcTermInput.value) || 1; 
        const fee = parseFloat(elements.calcFeeInput.value) || 0;
        const offer = computeOffer(amount, factor, termPayments, paymentFrequency, fee);

        const businessName = elements.businessNameInput ? elements.businessNameInput.value.trim() : '';
        if (elements.businessNameDisplay) {
          if (businessName) {
            elements.businessNameDisplay.textContent = businessName;
            elements.businessNameDisplay.classList.remove('hidden');
          } else {
            elements.businessNameDisplay.textContent = '';
            elements.businessNameDisplay.classList.add('hidden');
          }
        }

        elements.summaryAmountOut.textContent = formatCurrency(offer.amount);
        elements.summaryPaybackOut.textContent = formatCurrency(offer.totalPayback);
        elements.summaryFactorOut.textContent = `${offer.factor.toFixed(2)}x`;
        elements.summaryTermOut.textContent = `${offer.termMonths} payments`;
        elements.summaryCostOut.textContent = formatCurrency(offer.totalCost);
        elements.summaryPaymentLabel.textContent = offer.paymentLabel;
        elements.summaryPaymentValue.textContent = formatCurrency(offer.payment);
        elements.summaryFeeOut.textContent = formatCurrency(offer.feeAmount);
        elements.summaryNetOut.textContent = formatCurrency(offer.netProceeds);
        
        // Donut Chart Update
        if(elements.donutChart) {
           const costPct = (offer.totalCost / offer.totalPayback) * 100;
           const principalPct = 100 - costPct;
           // The gradient starts with Accent (Principal) then switches to Gray (Cost)
           elements.donutChart.style.background = `conic-gradient(var(--accent-color) 0% ${principalPct}%, var(--chart-secondary) ${principalPct}% 100%)`;
           // CHANGED: Now displays Amount instead of Percent
           elements.donutPercent.textContent = formatCurrency(offer.totalCost);
        }

        if (offer.feePercent <= 0 && isApprovalView) {
           if (elements.feeGridItem) elements.feeGridItem.classList.add('hidden');
           if (elements.netGridItem) elements.netGridItem.classList.add('hidden');
           if (elements.detailsRowFee) elements.detailsRowFee.classList.add('hidden');
        } else {
           if (elements.feeGridItem) elements.feeGridItem.classList.remove('hidden');
           if (elements.netGridItem) elements.netGridItem.classList.remove('hidden');
           if (elements.detailsRowFee) elements.detailsRowFee.classList.remove('hidden');
        }

        if (elements.summaryTermLengthOut) {
          let months = offer.termLengthMonths;
          if (elements.termLengthMonthsInput) {
            if (!termLengthManualDirty) {
              const autoRounded = Math.round(months * 2) / 2;
              elements.termLengthMonthsInput.value = Number.isInteger(autoRounded) ? autoRounded.toString() : autoRounded.toFixed(1);
            }
            const manualVal = parseFloat(elements.termLengthMonthsInput.value);
            if (!isNaN(manualVal) && manualVal > 0) months = manualVal;
          }
          if (months && months > 0) {
            const rounded = Math.round(months * 2) / 2;
            const display = Number.isInteger(rounded) ? rounded.toString() : rounded.toFixed(1);
            elements.summaryTermLengthOut.textContent = `${display} months`;
          } else {
            elements.summaryTermLengthOut.textContent = '';
          }
        }
        calculatePrepay(offer);
        updateRepDisplay();
      } catch (e) { console.error('Calculator error:', e); }
    }

    function initializeCalculator() {
      initializeFromURL();
      applyTheme();
      if (elements.themeSelector) elements.themeSelector.value = currentTheme;
      if (elements.calcAmountSlider && elements.calcAmountInput) syncInputs(elements.calcAmountSlider, elements.calcAmountInput, true, 5000, amountSliderMax, runCalculator);
      if (elements.calcFactorSlider && elements.calcFactorInput) syncInputs(elements.calcFactorSlider, elements.calcFactorInput, false, 1.05, 1.7, runCalculator);
      if (elements.calcFeeSlider && elements.calcFeeInput) syncInputs(elements.calcFeeSlider, elements.calcFeeInput, false, 0, 10, runCalculator);
      if (elements.calcTermSlider && elements.calcTermInput) syncInputs(elements.calcTermSlider, elements.calcTermInput, false, 1, 528, runCalculator);

      if (elements.toggleDaily) elements.toggleDaily.addEventListener('click', () => { paymentFrequency = 'daily'; updatePaymentToggleUI(); runCalculator(); });
      if (elements.toggleWeekly) elements.toggleWeekly.addEventListener('click', () => { paymentFrequency = 'weekly'; updatePaymentToggleUI(); runCalculator(); });
      if (elements.toggleMonthly) elements.toggleMonthly.addEventListener('click', () => { paymentFrequency = 'monthly'; updatePaymentToggleUI(); runCalculator(); });

      if (elements.businessNameInput) elements.businessNameInput.addEventListener('input', runCalculator);

      if (elements.termLengthMonthsInput) {
        elements.termLengthMonthsInput.addEventListener('input', () => { termLengthManualDirty = true; runCalculator(); });
        elements.termLengthMonthsInput.addEventListener('blur', () => {
          const v = parseFloat(elements.termLengthMonthsInput.value);
          if (!isNaN(v) && v > 0) {
            const rounded = Math.round(v * 2) / 2;
            elements.termLengthMonthsInput.value = Number.isInteger(rounded) ? rounded.toString() : rounded.toFixed(1);
          }
          runCalculator();
        });
      }

      if (elements.toggleFeeBtn) elements.toggleFeeBtn.addEventListener('click', () => elements.feeInputWrapper.classList.toggle('hidden'));
      if (elements.togglePrepay) elements.togglePrepay.addEventListener('click', () => { elements.prepayContainer.classList.toggle('hidden'); runCalculator(); });
      if (elements.prepaySlider) elements.prepaySlider.addEventListener('input', (e) => { prepayDiscountPercent = parseInt(e.target.value, 10); runCalculator(); });
      if (elements.prepayDateInput) elements.prepayDateInput.addEventListener('change', () => runCalculator());

      if (elements.viewAmortizationBtn) elements.viewAmortizationBtn.addEventListener('click', () => { renderAmortizationSchedule(getCurrentOffer()); elements.amortizationModal.classList.remove('hidden'); });
      if (elements.closeAmortizationBtn) elements.closeAmortizationBtn.addEventListener('click', () => elements.amortizationModal.classList.add('hidden'));

      if (elements.repSettingsToggle && elements.repSettingsPanel) elements.repSettingsToggle.addEventListener('click', () => elements.repSettingsPanel.classList.toggle('hidden'));
      if (elements.repNameInput) elements.repNameInput.addEventListener('input', updateRepDisplay);
      if (elements.repEmailInput) elements.repEmailInput.addEventListener('input', updateRepDisplay);
      if (elements.repPhoneInput) elements.repPhoneInput.addEventListener('input', updateRepDisplay);
      if (elements.companyNameInput) elements.companyNameInput.addEventListener('input', updateBranding);
      if (elements.companyLogoInput) elements.companyLogoInput.addEventListener('input', updateBranding);

      if (elements.addOfferButton) elements.addOfferButton.addEventListener('click', handleAddOffer);

      // --- NEW: Copy Email Function with HTML Table ---
      if (elements.copyEmailButton) {
        elements.copyEmailButton.addEventListener('click', async () => {
          const offer = getCurrentOffer();
          const businessName = elements.businessNameInput.value || "Business Owner";
          const repName = elements.repNameInput.value || "Your Funding Specialist";
          const repPhone = elements.repPhoneInput.value || "";
          const repEmail = elements.repEmailInput.value || "";

          // 1. Plain Text Version (Fallback)
          const plainText = `Hi ${businessName},

Great news! Based on our conversation, I've secured the following approval for your business:

Approval Amount: ${formatCurrency(offer.amount)}
Term: ${offer.termMonths} Payments (${offer.termLengthMonths} Months)
Payment: ${formatCurrency(offer.payment)} / ${offer.frequency}
Net Funding: ${formatCurrency(offer.netProceeds)}

This offer is available immediately. Let me know if you'd like me to send over the agreement.

Best,
${repName}
${repPhone}
${repEmail}`;

          // 2. HTML Version (Styled Table)
          const htmlContent = `
            <div style="font-family: sans-serif; font-size: 14px; color: #1e293b; line-height: 1.5;">
              <p>Hi ${businessName},</p>
              <p>Great news! Based on our conversation, I've secured the following approval for your business:</p>
              
              <div style="max-width: 400px; background-color: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin: 20px 0;">
                
                <!-- Card Header -->
                <div style="background-color: #fff; padding: 16px; border-bottom: 1px solid #e2e8f0; text-align: center;">
                   <div style="font-size: 12px; text-transform: uppercase; color: #64748b; font-weight: 600; letter-spacing: 0.05em;">You Get</div>
                   <div style="font-size: 36px; font-weight: 800; color: #0f172a; margin: 4px 0;">${formatCurrency(offer.amount)}</div>
                   <div style="font-size: 13px; color: #334155;">Total Payback: <strong>${formatCurrency(offer.totalPayback)}</strong></div>
                </div>

                <!-- Card Details -->
                <div style="padding: 16px;">
                  <table style="width: 100%; border-collapse: collapse;">
                    <tr>
                      <td style="padding: 8px 0; color: #64748b; font-size: 13px;">Term Length</td>
                      <td style="padding: 8px 0; color: #0f172a; font-weight: 600; text-align: right; font-size: 13px;">${offer.termLengthMonths} Months</td>
                    </tr>
                    <tr>
                      <td style="padding: 8px 0; color: #64748b; font-size: 13px;">Payments</td>
                      <td style="padding: 8px 0; color: #0f172a; font-weight: 600; text-align: right; font-size: 13px;">${offer.termMonths}</td>
                    </tr>
                    <tr>
                      <td style="padding: 8px 0; color: #64748b; font-size: 13px;">Factor Rate</td>
                      <td style="padding: 8px 0; color: #0f172a; font-weight: 600; text-align: right; font-size: 13px;">${offer.factor.toFixed(2)}x</td>
                    </tr>
                    <tr>
                      <td style="padding: 8px 0; color: #64748b; font-size: 13px;">Frequency</td>
                      <td style="padding: 8px 0; color: #0f172a; font-weight: 600; text-align: right; font-size: 13px; text-transform: capitalize;">${offer.frequency}</td>
                    </tr>
                    <tr style="border-top: 1px solid #e2e8f0;">
                      <td style="padding: 12px 0 0; color: #64748b; font-size: 13px;"><strong>Payment</strong></td>
                      <td style="padding: 12px 0 0; color: #0f172a; font-weight: 700; text-align: right; font-size: 14px;">${formatCurrency(offer.payment)}</td>
                    </tr>
                  </table>
                </div>
              </div>

              <p>This offer is available immediately. Let me know if you'd like me to send over the agreement.</p>
              
              <p style="margin-top: 24px;">
                Best,<br>
                <strong>${repName}</strong><br>
                ${repPhone}<br>
                ${repEmail}
              </p>
            </div>
          `;

          try {
            const typeHtml = "text/html";
            const typeText = "text/plain";
            const blobHtml = new Blob([htmlContent], { type: typeHtml });
            const blobText = new Blob([plainText], { type: typeText });
            const data = [new ClipboardItem({ [typeHtml]: blobHtml, [typeText]: blobText })];

            await navigator.clipboard.write(data);
            const originalText = elements.copyEmailButton.innerText;
            elements.copyEmailButton.innerText = "Copied!";
            setTimeout(() => elements.copyEmailButton.innerText = originalText, 2000);
          } catch (err) {
            console.error('Failed to copy HTML:', err);
            // Fallback
            navigator.clipboard.writeText(plainText).then(() => {
                const originalText = elements.copyEmailButton.innerText;
                elements.copyEmailButton.innerText = "Copied Text!";
                setTimeout(() => elements.copyEmailButton.innerText = originalText, 2000);
            });
          }
        });
      }

      if (elements.shareLinkButton) {
        elements.shareLinkButton.addEventListener('click', () => {
          const shareBtn = elements.shareLinkButton;
          const originalText = shareBtn.innerText;
          const amount = parseFormattedNumber(elements.calcAmountInput.value);
          const factor = parseFloat(elements.calcFactorInput.value);
          const term = parseInt(elements.calcTermInput.value) || 1;
          const fee = parseFloat(elements.calcFeeInput.value) || 0;
          const freq = paymentFrequency;
          const theme = currentBaseTheme;
          const accent = currentAccentClass;
          
          const businessName = elements.businessNameInput ? elements.businessNameInput.value.trim() : '';
          const repName = elements.repNameInput ? elements.repNameInput.value.trim() : '';
          const repEmail = elements.repEmailInput ? elements.repEmailInput.value.trim() : '';
          const repPhone = elements.repPhoneInput ? elements.repPhoneInput.value.trim() : '';
          const cName = elements.companyNameInput.value;
          const cLogo = elements.companyLogoInput.value;

          const offersForUrl = savedOffers.map((offer) => ({
            a: offer.amount, f: offer.factor, t: offer.termMonths, q: offer.frequency || freq, fee: offer.feePercent || 0,
          }));

          const url = new URL(window.location.href);
          const params = new URLSearchParams({
            amount, factor, term, fee, freq, theme, accent, businessName, repName, repEmail, repPhone, cName, cLogo,
            prepay: prepayDiscountPercent, offers: JSON.stringify(offersForUrl), view: 'approval',
          });
          url.search = params.toString();

          const textArea = document.createElement('textarea');
          textArea.value = url.toString();
          textArea.style.position = 'fixed'; textArea.style.top = '0'; textArea.style.left = '0';
          document.body.appendChild(textArea);
          textArea.focus(); textArea.select();

          try {
            document.execCommand('copy');
            shareBtn.innerText = 'Copied!';
            setTimeout(() => { shareBtn.innerText = originalText; }, 2000);
          } catch (errFallback) {
            shareBtn.innerText = 'Error';
            setTimeout(() => { shareBtn.innerText = originalText; }, 2000);
          }
          document.body.removeChild(textArea);
        });
      }

      if (elements.prepayDateInput) {
        const today = new Date().toISOString().split('T')[0];
        elements.prepayDateInput.value = today;
      }

      updatePaymentToggleUI();
      runCalculator();
      renderSavedOffers();
      updateAddOfferButtonState();
    }

    initializeCalculator();
  </script>
</body>
</html>
