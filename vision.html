<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustBureau | Vision</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z' fill='white' opacity='0.1' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M9 12l2 2 4-4' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            /* Dark Theme (Original Aurora) */
            --bg-body: #0a0a0a;
            --bg-aurora: #2c2c2c;
            --bg-card: rgba(20, 20, 20, 0.4);
            --bg-card-hover: rgba(30, 30, 30, 0.6);
            --border-primary: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #888888;
            --accent-green: #15803d;
            --accent-red: #991b1b;
            --accent-yellow: #eab308;
            --grid-color: rgba(255,255,255,0.03);
            --modal-bg: #0a0a0a;
            --input-bg: rgba(0,0,0,0.4);
            --vision-box-bg: rgba(255, 255, 255, 0.03);
            --vision-box-hover: rgba(255, 255, 255, 0.08);
        }

        [data-theme="light"] {
            --bg-body: #ffffff;
            --bg-aurora: #f3f4f6;
            --bg-card: #ffffff;
            --bg-card-hover: #f9fafb;
            --border-primary: #e5e7eb;
            --border-hover: #d1d5db;
            --text-primary: #111827; 
            --text-secondary: #4b5563; 
            --text-muted: #9ca3af; 
            --accent-green: #15803d;
            --accent-red: #991b1b;
            --accent-yellow: #eab308;
            --grid-color: rgba(0,0,0,0.04);
            --modal-bg: #ffffff;
            --input-bg: #f3f4f6;
            --vision-box-bg: #f3f4f6;
            --vision-box-hover: #e5e7eb;
        }

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            position: relative;
            overflow-x: hidden;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        body::before {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: radial-gradient(ellipse 120% 80% at 50% 20%, var(--bg-aurora) 0%, transparent 50%);
            pointer-events: none; z-index: -3; animation: auroraPulse 10s infinite;
            transition: background 0.3s ease;
        }
        @keyframes auroraPulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
        body::after {
            content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-image: linear-gradient(var(--grid-color) 1px, transparent 1px), linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 60px 60px; pointer-events: none; z-index: -2;
            mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, black 0%, transparent 70%);
            -webkit-mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, black 0%, transparent 70%);
            transition: background-image 0.3s ease;
        }
        .container { max-width: 1400px; width: 100%; margin: 0 auto; padding: 0 2rem; flex: 1; display: flex; flex-direction: column; position: relative; z-index: 1; }
        
        header { padding: 1.5rem 0; display: grid; grid-template-columns: 1fr auto 1fr; align-items: center; margin-bottom: 2rem; }
        .logo-group { grid-column: 1; display: flex; align-items: center; gap: 1rem; }
        .logo { display: flex; align-items: center; gap: 0.875rem; text-decoration: none; color: var(--text-primary); }
        .logo-text { font-size: 0.875rem; font-weight: 700; letter-spacing: 0.05em; text-transform: uppercase; }
        
        .header-center { grid-column: 2; justify-self: center; display: flex; align-items: center; justify-content: center; }
        .vision-brand { display: flex; align-items: center; gap: 1rem; cursor: pointer; }
        .vision-icon-box { width: 48px; height: 48px; background: var(--vision-box-bg); border: 1px solid var(--border-primary); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05); transition: all 0.3s ease; }
        .vision-brand:hover .vision-icon-box { border-color: var(--text-primary); background: var(--vision-box-hover); transform: scale(1.05); }
        .vision-title-text { font-size: 1rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-primary); line-height: 1; padding-top: 3px; }

        .header-actions { grid-column: 3; justify-self: end; position: relative; z-index: 10; display: flex; gap: 0.75rem; }
        .btn-api { display: flex; align-items: center; gap: 0.5rem; padding: 0.625rem 1rem; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; color: var(--text-secondary); font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: 0.3s; }
        .btn-api:hover { border-color: var(--border-hover); color: var(--text-primary); background: var(--bg-card-hover); transform: translateY(-2px); box-shadow: 0 0 20px rgba(0,0,0,0.05); }
        
        .status-dot { width: 6px; height: 6px; background: #fff; border-radius: 50%; display: inline-block; box-shadow: 0 0 10px rgba(255,255,255,0.5); }
        .status-dot.active { background: var(--accent-green); box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); }
        .status-dot.inactive { background: var(--accent-red); box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); }

        .vision-wrapper { max-width: 1100px; margin: 0 auto; width: 100%; animation: slideUp 0.6s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .upload-zone { border: 2px dashed var(--border-primary); border-radius: 16px; padding: 4rem 2rem; text-align: center; cursor: pointer; transition: all 0.3s; background: var(--bg-card); position: relative; overflow: hidden; backdrop-filter: blur(20px); box-shadow: 0 0 30px rgba(0,0,0,0.02); max-width: 680px; margin: 2rem auto; }
        .upload-zone:hover { border-color: var(--text-muted); background: var(--bg-card-hover); transform: translateY(-2px); }
        .upload-zone.dragover { border-color: var(--accent-green); background: rgba(34, 197, 94, 0.05); }
        .upload-icon { width: 64px; height: 64px; margin-bottom: 1.5rem; color: var(--text-muted); opacity: 0.6; }
        .upload-text { font-size: 1rem; font-weight: 700; color: var(--text-primary); margin-bottom: 0.5rem; letter-spacing: 0.15em; text-transform: uppercase; }
        .upload-subtext { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; font-weight: 500; }

        .file-preview { display: flex; align-items: center; gap: 1rem; background: var(--bg-card); border: 1px solid var(--border-primary); padding: 1rem; border-radius: 12px; margin: 1rem auto 0; max-width: 680px; }
        .file-icon { width: 32px; height: 32px; color: var(--accent-green); }
        .file-info { flex: 1; }
        .file-name { font-size: 0.875rem; font-weight: 500; color: var(--text-primary); }
        .file-status { font-size: 0.75rem; color: var(--text-muted); }
        
        .btn-analyze { width: 100%; max-width: 680px; margin: 1.5rem auto 0; padding: 1rem; background: var(--text-primary); color: var(--bg-body); border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: 0.3s; display: none; text-align: center; }
        .btn-analyze:hover { opacity: 0.9; transform: translateY(-1px); }

        .btn-reset { margin: 4rem auto 2rem; display: flex; align-items: center; justify-content: center; gap: 0.5rem; padding: 0.75rem 2rem; background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 12px; color: var(--text-secondary); font-size: 0.875rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; width: fit-content; text-decoration: none; }
        .btn-reset:hover { border-color: var(--accent-red); color: var(--accent-red); background: var(--bg-card-hover); transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .loading-spinner { animation: spin 1s linear infinite; width: 20px; height: 20px; color: var(--text-muted); }

        /* Report Grid System */
        .report-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap: 1.5rem; margin-top: 2rem; }
        .report-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 2rem; display: flex; flex-direction: column; height: 100%; transition: 0.3s; backdrop-filter: blur(10px); }
        .report-card:hover { border-color: var(--border-hover); background: var(--bg-card-hover); transform: translateY(-4px); }
        .report-card.full-width { grid-column: 1 / -1; }
        .report-card.wide-card { grid-column: span 2; }
        
        .card-header { display: flex; justify-content: space-between; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 1px solid var(--border-primary); align-items: center; }
        .header-title-group { display: flex; align-items: center; gap: 0.75rem; }
        .card-title { font-size: 0.75rem; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase; color: var(--text-muted); }
        .card-content { font-size: 0.9375rem; line-height: 1.7; color: var(--text-secondary); }

        /* Rich HTML Analysis Styles */
        .analysis-section { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; overflow: hidden; margin-bottom: 1.5rem; animation: fadeIn 0.5s; }
        .analysis-section-header { background: var(--bg-card-hover); padding: 1rem 1.5rem; border-bottom: 1px solid var(--border-primary); display: flex; align-items: center; gap: 0.75rem; }
        .analysis-section-title { font-size: 0.8125rem; font-weight: 700; color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.1em; }
        .analysis-content { padding: 0; }
        .analysis-content.padded { padding: 1.5rem; color: var(--text-secondary); line-height: 1.6; }

        .rich-table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
        .rich-table th { text-align: left; padding: 1rem 1.5rem; color: var(--text-muted); font-size: 0.7rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; border-bottom: 1px solid var(--border-primary); background: var(--bg-card-hover); }
        .rich-table td { padding: 1rem 1.5rem; color: var(--text-secondary); border-bottom: 1px solid var(--border-primary); vertical-align: middle; }
        .rich-table tr:last-child td { border-bottom: none; }
        .rich-table tr:hover td { background: var(--bg-card-hover); color: var(--text-primary); }
        .averages-row { background: rgba(16, 185, 129, 0.1) !important; font-weight: 700; }
        .averages-row td { color: var(--text-primary) !important; border-top: 2px solid var(--border-primary); }
        
        .col-money { font-family: 'Plus Jakarta Sans', monospace; font-weight: 600; color: var(--text-primary); }
        .text-pos { color: var(--accent-green) !important; }
        .text-neg { color: var(--accent-red) !important; }
        .text-warn { color: var(--accent-yellow) !important; }
        
        .badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 100px; font-size: 0.7rem; font-weight: 700; letter-spacing: 0.02em; text-transform: uppercase; }
        .badge-yellow { background: rgba(234, 179, 8, 0.1); color: var(--accent-yellow); border: 1px solid var(--accent-yellow); opacity: 0.8; }
        .badge-green { background: rgba(21, 128, 61, 0.1); color: var(--accent-green); border: 1px solid var(--accent-green); opacity: 0.8; }
        .badge-red { background: rgba(153, 27, 27, 0.1); color: var(--accent-red); border: 1px solid var(--accent-red); opacity: 0.8; }

        .risk-list { display: flex; flex-direction: column; gap: 0.75rem; }
        .risk-item { display: flex; gap: 1rem; padding: 1rem; background: rgba(239, 68, 68, 0.05); border: 1px solid rgba(239, 68, 68, 0.15); border-radius: 12px; align-items: flex-start; }
        .risk-icon { color: var(--accent-red); margin-top: 0.1rem; flex-shrink: 0; font-size: 1.2rem; }
        .risk-content { flex: 1; }
        .risk-content strong { display: block; color: var(--text-primary); margin-bottom: 0.25rem; font-size: 0.95rem; }
        .risk-content p { margin: 0; font-size: 0.85rem; color: var(--text-secondary); line-height: 1.5; }

        /* Background Loader */
        .bg-loader-card {
            margin-top: 1.5rem;
            animation: fadeIn 0.5s ease-out;
            grid-column: 1 / -1;
        }
        .bg-loader {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            padding: 2rem;
            background: var(--bg-card);
            border: 1px dashed var(--border-primary);
            border-radius: 16px;
            color: var(--text-muted);
            font-size: 0.9rem;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Settings Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(12px); z-index: 100; display: none; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s; }
        .modal-overlay.open { display: flex; opacity: 1; }
        .modal { background: var(--modal-bg); border: 1px solid var(--border-primary); border-radius: 20px; padding: 0; width: 100%; max-width: 520px; box-shadow: 0 40px 80px -12px rgba(0, 0, 0, 0.5), 0 0 40px rgba(0,0,0,0.05); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); overflow: hidden; }
        .modal-overlay.open .modal { transform: scale(1); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; padding: 2rem 2.5rem 1.5rem; border-bottom: 1px solid var(--border-primary); background: transparent; }
        .modal-title { font-size: 1.25rem; font-weight: 700; color: var(--text-primary); letter-spacing: -0.02em; }
        .btn-close { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 0.5rem; transition: all 0.2s; display: flex; border-radius: 50%; }
        .btn-close:hover { color: var(--text-primary); background: var(--bg-card-hover); }
        .modal-body { padding: 2.5rem; display: flex; flex-direction: column; gap: 2rem; }
        .status-card { background: var(--bg-card-hover); border: 1px solid var(--border-primary); border-radius: 14px; padding: 1.25rem; display: flex; align-items: center; gap: 1rem; }
        .status-icon-wrapper { width: 40px; height: 40px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border-primary); display: flex; align-items: center; justify-content: center; }
        .status-details { display: flex; flex-direction: column; gap: 0.25rem; }
        .status-label-text { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-muted); font-weight: 600; }
        .status-value-text { font-size: 0.9375rem; color: var(--text-primary); font-weight: 500; }
        .form-group { display: flex; flex-direction: column; gap: 0.75rem; }
        .form-header { display: flex; justify-content: space-between; align-items: baseline; }
        .form-label { font-size: 1rem; color: var(--text-primary); font-weight: 600; letter-spacing: -0.01em; }
        .form-hint { font-size: 0.8125rem; color: var(--text-muted); line-height: 1.5; }
        .form-hint a { color: var(--text-secondary); text-decoration: underline; text-underline-offset: 3px; transition: color 0.2s; }
        .form-hint a:hover { color: var(--text-primary); }
        .form-input { width: 100%; background: var(--input-bg); border: 1px solid var(--border-primary); border-radius: 12px; padding: 1.25rem; color: var(--text-primary); font-family: 'Plus Jakarta Sans', sans-serif; font-size: 1rem; transition: all 0.3s; }
        .form-input:focus { outline: none; border-color: var(--border-hover); box-shadow: 0 0 0 4px rgba(255,255,255,0.05); }
        .modal-actions { display: flex; flex-direction: column; gap: 1rem; margin-top: 0.5rem; }
        .btn-save { width: 100%; padding: 1.125rem; background: var(--text-primary); color: var(--bg-body); border: none; border-radius: 12px; font-weight: 700; font-size: 1rem; cursor: pointer; transition: all 0.3s; letter-spacing: -0.01em; }
        .btn-save:hover { opacity: 0.9; transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .btn-reset-key { width: fit-content; margin: 0 auto; background: none; border: none; color: var(--text-muted); cursor: pointer; }

        /* Manual Entity Input */
        .entity-input-group { display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: center; display: none; }
        .entity-input { background: var(--bg-card); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 0.5rem 1rem; border-radius: 8px; width: 250px; }
        .btn-small { padding: 0.5rem 1rem; background: var(--text-primary); color: var(--bg-body); border: none; border-radius: 8px; font-weight: 600; cursor: pointer; }

        /* Key-Value Table Styles */
        .kv-table { width: 100%; font-size: 0.9rem; }
        .kv-table tr { border-bottom: 1px solid var(--border-primary); }
        .kv-table tr:last-child { border-bottom: none; }
        .kv-table td { padding: 0.75rem 0; vertical-align: top; }
        .kv-label { width: 40%; color: var(--text-muted); font-weight: 600; }
        .kv-val { color: var(--text-secondary); text-align: right; }

        footer { margin-top: auto; padding: 2rem 0; border-top: 1px solid var(--border-primary); text-align: center; color: var(--text-muted); font-size: 0.8125rem; }
    </style>
</head>
<body>
    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">System Configuration</div>
                <button class="btn-close" onclick="toggleSettings()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="status-card">
                    <div class="status-icon-wrapper">
                        <span class="status-dot active" id="modalStatusDot"></span>
                    </div>
                    <div class="status-details">
                        <div class="status-label-text">Connection Status</div>
                        <div class="status-value-text" id="keyStatusTextLabel">Using: System Default Key</div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-header">
                        <label class="form-label">Gemini API Key</label>
                    </div>
                    <input type="password" class="form-input" id="apiKeyInput" placeholder="Paste your AIzaSy... key here">
                </div>
                
                <div class="modal-actions">
                    <button class="btn-save" onclick="saveApiKey()">Save Configuration</button>
                    <button class="btn-reset-key" onclick="clearApiKey()">Reset to Default System Key</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo-group">
                <a href="index.html" class="logo">
                    <svg style="width:32px; height:32px;" viewBox="0 0 24 24" fill="none"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" stroke="var(--text-primary)" stroke-width="1.5"/><path d="M9 12l2 2 4-4" stroke="var(--text-primary)" stroke-width="2"/></svg>
                    <span class="logo-text">TRUST<span style="color:var(--text-muted);">BUREAU</span></span>
                </a>
            </div>
            <div class="header-center">
                <div class="vision-brand" onclick="resetApp()">
                    <div class="vision-icon-box">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                            <circle cx="6" cy="12" r="5"></circle>
                            <circle cx="18" cy="12" r="5"></circle>
                            <line x1="11" y1="12" x2="13" y2="12"></line>
                        </svg>
                    </div>
                    <span class="vision-title-text">VISION</span>
                </div>
            </div>
            <div class="header-actions">
                <button class="btn-api" onclick="toggleTheme()" title="Switch Theme">
                    <svg id="themeIcon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
                <button class="btn-api" onclick="resetApp()">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                    Reset
                </button>
                <button class="btn-api" onclick="toggleSettings()">
                    <span class="status-dot active" id="systemStatusDot"></span> 
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                    API
                </button>
            </div>
        </header>

        <div class="vision-wrapper">
            <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
                <input type="file" id="fileInput" hidden accept="image/*,application/pdf" multiple>
                <svg class="upload-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                <div class="upload-text">Analyze Financial Documents</div>
                <div class="upload-subtext">Drag & Drop Bank Statements, Tax Returns (PDF/IMG)</div>
            </div>
            
            <div id="filePreviewContainer" style="display:none; margin-top: 2rem;"></div>
            
            <button id="btnAnalyze" class="btn-analyze" onclick="triggerAnalysis()">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="margin-right:8px;"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                Run Analysis
            </button>

            <!-- Analysis Dashboard -->
            <div id="docAnalysisResult" style="display:none; margin-top:2rem;"></div>
            
            <!-- Manual Entity Correction (Hidden by default) -->
            <div id="entityInputGroup" class="entity-input-group">
                <input type="text" id="manualEntityName" class="entity-input" placeholder="Enter Business Name Manually">
                <button class="btn-small" onclick="manualBackgroundTrigger()">Search</button>
            </div>
            
            <!-- Dynamic Background Report Container -->
            <div id="bgScanSection" class="bg-loader-card" style="display:none;">
                <div class="bg-loader">
                    <svg class="loading-spinner" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                    <span>Running External Background Intelligence Scan on <strong id="bgScanEntityName">Entity</strong>...</span>
                </div>
            </div>
            
            <div id="bgReportGrid" class="report-grid" style="display:none;">
                <!-- 6. Secretary of State -->
                <div class="report-card">
                    <div class="card-header"><div class="header-title-group"><span class="card-title">6. Secretary of State</span></div></div>
                    <div class="card-content" id="content-sos"></div>
                </div>
                <!-- 7. UCC Liens -->
                <div class="report-card">
                    <div class="card-header"><div class="header-title-group"><span class="card-title">7. UCC Liens</span></div></div>
                    <div class="card-content" id="content-ucc"></div>
                </div>
                <!-- 8. Legal -->
                <div class="report-card">
                    <div class="card-header"><div class="header-title-group"><span class="card-title">8. Legal & Litigation</span></div></div>
                    <div class="card-content" id="content-legal"></div>
                </div>
                <!-- 9. Reputation -->
                <div class="report-card">
                    <div class="card-header"><div class="header-title-group"><span class="card-title">9. Reputation</span></div></div>
                    <div class="card-content" id="content-rep"></div>
                </div>
            </div>

            <button id="btnResetBottom" class="btn-reset" onclick="resetApp()" style="display:none;">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>
                Analyze New Documents
            </button>
        </div>

        <footer>© 2025 TrustBureau.ai</footer>
    </div>

    <!-- Hidden Logic Elements -->
    <div id="hiddenEntityName" style="display:none;"></div>
    <div id="hiddenEntityLocation" style="display:none;"></div>

    <script>
        const apiKey = "";
        let userApiKey = localStorage.getItem('trustbureau_api_key') || "";
        let pendingFiles = [];
        let extractedEntity = "";
        let extractedLoc = "";

        function getEffectiveKey() { return userApiKey || apiKey; }
        
        function initTheme() {
            const savedTheme = localStorage.getItem('trustbureau_theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || 'dark';
            const next = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', next);
            localStorage.setItem('trustbureau_theme', next);
            updateThemeIcon(next);
        }

        function updateThemeIcon(theme) {
            const icon = document.getElementById('themeIcon');
            if (theme === 'light') {
                icon.innerHTML = '<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>';
            } else {
                icon.innerHTML = '<circle cx="12" cy="12" r="5"></circle><line x1="12" y1="1" x2="12" y2="3"></line><line x1="12" y1="21" x2="12" y2="23"></line><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line><line x1="1" y1="12" x2="3" y2="12"></line><line x1="21" y1="12" x2="23" y2="12"></line><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>';
            }
        }
        initTheme();

        function updateKeyStatus() {
            const statusText = document.getElementById('keyStatusTextLabel');
            const dot = document.getElementById('systemStatusDot');
            const modalDot = document.getElementById('modalStatusDot');
            
            if (userApiKey) {
                if(statusText) { statusText.innerText = "Using: Custom User API Key"; statusText.style.color = "var(--accent-green)"; }
                if(dot) dot.className = "status-dot active";
                if(modalDot) modalDot.className = "status-dot active";
            } else if (apiKey) {
                if(statusText) { statusText.innerText = "Using: Environment Test Key"; statusText.style.color = "var(--text-muted)"; }
                if(dot) dot.className = "status-dot active";
                if(modalDot) modalDot.className = "status-dot active";
            } else {
                if(statusText) { statusText.innerText = "No API Key Available"; statusText.style.color = "var(--accent-red)"; }
                if(dot) dot.className = "status-dot inactive";
                if(modalDot) modalDot.className = "status-dot inactive";
            }
        }
        updateKeyStatus();

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            if(modal) {
                modal.classList.toggle('open');
                if(modal.classList.contains('open') && userApiKey) {
                    document.getElementById('apiKeyInput').value = userApiKey;
                }
            }
        }

        function saveApiKey() {
            const val = document.getElementById('apiKeyInput').value.trim();
            if(val) {
                userApiKey = val;
                localStorage.setItem('trustbureau_api_key', val);
                toggleSettings();
                updateKeyStatus();
            }
        }

        function clearApiKey() {
            if(confirm("Clear custom API key?")) {
                userApiKey = "";
                try { localStorage.removeItem('trustbureau_api_key'); } catch(e){}
                document.getElementById('apiKeyInput').value = "";
                updateKeyStatus();
            }
        }

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');

        dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('dragover'); });
        dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
        dropZone.addEventListener('drop', (e) => { e.preventDefault(); dropZone.classList.remove('dragover'); if(e.dataTransfer.files.length) handleFilesSelect(e.dataTransfer.files); });
        fileInput.addEventListener('change', () => { if(fileInput.files.length) handleFilesSelect(fileInput.files); });

        async function handleFilesSelect(files) {
            if (!getEffectiveKey()) {
                alert("Please configure your API Key first.");
                toggleSettings();
                document.getElementById('fileInput').value = '';
                return;
            }

            Array.from(files).forEach(f => pendingFiles.push(f));
            updateFileListUI();
        }

        function updateFileListUI() {
            const container = document.getElementById('filePreviewContainer');
            container.innerHTML = '';
            container.style.display = 'block';
            document.getElementById('dropZone').style.display = 'none';

            pendingFiles.forEach((file, index) => {
                const div = document.createElement('div');
                div.className = 'file-preview';
                div.innerHTML = `
                    <svg class="file-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline></svg>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${(file.size/1024).toFixed(1)} KB</div>
                    </div>
                    <div class="file-status" style="font-size:0.75rem; color:var(--text-muted);">Queued</div>
                    <span style="cursor:pointer; color:var(--accent-red); margin-left:10px;" onclick="removeFile(${index})">×</span>
                `;
                container.appendChild(div);
            });

            if (pendingFiles.length > 0) document.getElementById('btnAnalyze').style.display = 'block';
        }

        function removeFile(index) {
            pendingFiles.splice(index, 1);
            updateFileListUI();
        }

        async function triggerAnalysis() {
            if(!getEffectiveKey()) { alert("Please set API Key"); toggleSettings(); return; }
            
            document.getElementById('btnAnalyze').style.display = 'none';
            // Update status
            document.querySelectorAll('.file-status').forEach(el => {
                el.innerText = "Processing...";
                el.style.color = "var(--accent-yellow)";
            });
            
            // Process Files to Base64
            const processed = await Promise.all(pendingFiles.map(async (f) => {
                const b64 = await new Promise(r => {
                    const reader = new FileReader();
                    reader.onload = e => r(e.target.result.split(',')[1]);
                    reader.readAsDataURL(f);
                });
                return { inlineData: { mimeType: f.type, data: b64 } };
            }));

            runAnalysisStep(processed);
        }

        async function runAnalysisStep(fileParts) {
            const resultBox = document.getElementById('docAnalysisResult');
            resultBox.innerHTML = '<div style="padding:2rem; text-align:center; color:var(--text-muted);">Analyzing documents...</div>';
            resultBox.style.display = 'block';

            // IMPORTANT: Request Full Monthly Breakdown & Averages
            const promptText = `
            Analyze these financial documents.
            
            TASKS:
            1. **Entity Extraction:** Identify Legal Name and Location (City, State).
            2. **Document Classification:** Identify if it is a Business Tax Return or Bank Statement. **CRITICAL: If Bank Statement, include the Bank Name (e.g., "Chase Bank Statement", "BoA Statement").**
            3. **Financials:** Extract or Estimate.
               - **Revenue:** Gross Receipts (Tax) or Total Deposits (Bank).
               - **Net Income:** Ordinary Income (Tax) or Revenue - Debits (Bank).
               - **EBITDA:** Calculate or estimate via Net Income.
               - **DSCR:** Estimate (Net Income / Debt Service).
            3. **MCA Bank Analysis:**
               - **Months:** Create an array for each month found.
               - **For Each Month:** Extract Total Deposits, Total Debits, # Deposits, Avg Balance, # Neg Days, # NSFs.
               - **True Deposits:** Total Deposits MINUS Transfers/Wires.
               - **True Debits:** Total Debits MINUS Transfers/Wires.
               - **Averages:** Calculate averages for all columns.
               - **Large Transactions:** List single transactions > $7,500.
               - **Recurring Debt:** Identify daily/weekly lender payments.
            4. **Integrity:** Check for fraud/tampering.
            
            OUTPUT: Return a valid JSON object ONLY. Structure:
            {
                "entityName": "ABC Corp",
                "location": "City, State",
                "docType": "Bank Statement",
                "summary": { "revenue": "$100k", "netIncome": "$20k", "ebitda": "$25k", "dscr": "1.5x" },
                "fraudCheck": { "status": "Pass", "issues": [] },
                "mca": { 
                    "months": [ {"month": "Jan", "totalDeps": "$10k", "trueDeps": "$8k", "totalDebs": "$5k", "trueDebs": "$4k", "avgBal": "$2k", "negDays": "0", "nsfs": "0"} ],
                    "averages": { "totalDeps": "$10k", "trueDeps": "$8k", "totalDebs": "$5k", "trueDebs": "$4k", "avgBal": "$2k", "negDays": "0", "nsfs": "0" },
                    "largeTx": [ {"date": "2023-01-01", "amt": "$10,000", "desc": "Wire"} ] 
                },
                "debt": [ {"lender": "OnDeck", "freq": "Daily", "amount": "$500"} ]
            }`;

            try {
                const key = getEffectiveKey();
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ role: "user", parts: [{ text: promptText }, ...fileParts] }] })
                });
                const data = await res.json();
                
                // Robust JSON Parsing
                let text = data.candidates[0].content.parts[0].text;
                text = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const json = JSON.parse(text);
                
                // Render HTML from JSON
                renderAnalysisHTML(json);
                
                // Mark Files as Complete in UI
                document.querySelectorAll('.file-status').forEach(el => {
                    el.innerText = "Complete";
                    el.style.color = "var(--accent-green)";
                });

                // --- AUTO BACKGROUND CHECK TRIGGER ---
                if(json.entityName && json.entityName !== "Unknown") {
                    extractedEntity = json.entityName;
                    extractedLoc = json.location || "";
                    runBackgroundCheck(extractedEntity, extractedLoc, key);
                } else {
                    document.getElementById('entityInputGroup').style.display = 'flex';
                    document.getElementById('btnResetBottom').style.display = 'flex';
                }

            } catch(e) { console.error(e); alert("Analysis failed"); resetApp(); }
        }

        function renderAnalysisHTML(data) {
            const resultBox = document.getElementById('docAnalysisResult');
            const avg = data.mca?.averages || {totalDeps:'-', trueDeps:'-', totalDebs:'-', trueDebs:'-', avgBal:'-', negDays:'-', nsfs:'-'};
            
            const html = `
            <div class="analysis-wrapper">
                <!-- 1. Executive Summary -->
                <div class="analysis-section">
                    <div class="analysis-section-header">
                        <span class="analysis-section-title">1. Executive Summary</span>
                    </div>
                    <div class="analysis-content padded">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                            <div style="background:var(--bg-card-hover); padding:1rem; border-radius:12px; border:1px solid var(--border-primary);">
                                <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Entity Name</div>
                                <div style="font-size:1rem; font-weight:600; color:var(--text-primary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${data.entityName || 'Unknown'}</div>
                            </div>
                            <div style="background:var(--bg-card-hover); padding:1rem; border-radius:12px; border:1px solid var(--border-primary);">
                                <div style="font-size:0.7rem; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.05em; margin-bottom:0.5rem;">Doc Type</div>
                                <div style="font-size:1rem; font-weight:600; color:var(--text-primary);">${data.docType || 'N/A'}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 2. Document Integrity & Fraud Analysis -->
                <div class="analysis-section">
                    <div class="analysis-section-header">
                        <span class="analysis-section-title" style="color: var(--accent-yellow);">2. Document Integrity Analysis</span>
                    </div>
                    <div class="analysis-content padded">
                        <div style="display: flex; gap: 1rem; margin-bottom: 1rem; align-items: center;">
                            <div class="badge badge-yellow">${data.fraudCheck?.status || 'Check'}</div>
                            <span style="font-size: 0.9rem; color: var(--text-secondary); font-weight:600;">Automated Fraud Scan</span>
                        </div>
                        <ul style="margin:0; padding-left:1.2rem; font-size:0.9rem; color:var(--text-secondary); line-height:1.6;">
                            ${(data.fraudCheck?.issues || ["No issues detected."]).map(i => `<li>${i}</li>`).join('')}
                        </ul>
                    </div>
                </div>

                <!-- 3. Financial Overview & Ratios -->
                <div class="analysis-section">
                    <div class="analysis-section-header">
                        <span class="analysis-section-title">3. Financial Overview & Ratios</span>
                    </div>
                    <div class="analysis-content">
                        <table class="rich-table">
                            <thead><tr><th>Metric</th><th>Value</th><th>Notes</th></tr></thead>
                            <tbody>
                                <tr><td>Revenue</td><td class="col-money">${data.summary.revenue}</td><td class="text-pos">Gross Receipts / Deposits</td></tr>
                                <tr><td>Net Income (Est)</td><td class="col-money">${data.summary.netIncome}</td><td>Extrapolated</td></tr>
                                <tr><td><strong>EBITDA (Est)</strong></td><td class="col-money"><strong>${data.summary.ebitda}</strong></td><td>Net Inc + Addbacks</td></tr>
                                <tr><td><strong>DSCR (Est)</strong></td><td class="col-money"><strong>${data.summary.dscr}</strong></td><td>Cash Flow Coverage</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 4. MCA Bank Analysis -->
                <div class="analysis-section">
                    <div class="analysis-section-header">
                        <span class="analysis-section-title">4. MCA Bank Analysis</span>
                    </div>
                    <div class="analysis-content">
                        <div style="overflow-x:auto;">
                            <table class="rich-table">
                                <thead>
                                    <tr>
                                        <th>Month</th><th>Total Deps</th><th>True Deps</th><th>Total Debits</th><th>True Debits</th><th>Avg Bal</th><th>Neg Days</th><th>NSFs</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${(data.mca?.months || []).map(m => `
                                        <tr>
                                            <td>${m.month}</td>
                                            <td class="col-money">${m.totalDeps}</td>
                                            <td class="col-money text-pos">${m.trueDeps}</td>
                                            <td class="col-money">${m.totalDebs}</td>
                                            <td class="col-money">${m.trueDebs}</td>
                                            <td class="col-money">${m.avgBal}</td>
                                            <td style="color:${parseInt(m.negDays)>0?'var(--accent-red)':'inherit'}">${m.negDays}</td>
                                            <td style="color:${parseInt(m.nsfs)>0?'var(--accent-red)':'inherit'}">${m.nsfs}</td>
                                        </tr>
                                    `).join('')}
                                    <tr class="averages-row">
                                        <td>AVERAGES</td>
                                        <td>${avg.totalDeps}</td>
                                        <td>${avg.trueDeps}</td>
                                        <td>${avg.totalDebs}</td>
                                        <td>${avg.trueDebs}</td>
                                        <td>${avg.avgBal}</td>
                                        <td>${avg.negDays}</td>
                                        <td>${avg.nsfs}</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Large Transactions -->
                        <div style="padding: 1.5rem; border-top: 1px solid var(--border-primary);">
                            <strong style="display:block; color:var(--text-primary); font-size:0.8rem; text-transform:uppercase; margin-bottom:0.75rem;">Large Transactions (> $7,500)</strong>
                            <table class="rich-table" style="margin-top:0.5rem; border:1px solid var(--border-primary);">
                                <thead><tr><th>Date</th><th style="width:120px;">Amount</th><th>Description</th></tr></thead>
                                <tbody>
                                    ${(data.mca?.largeTx || []).map(t => `<tr><td>${t.date}</td><td class="col-money text-neg">${t.amt}</td><td>${t.desc}</td></tr>`).join('') || '<tr><td colspan="3" style="text-align:center;">No large transactions found.</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- 5. Existing Debt Stack -->
                <div class="analysis-section">
                    <div class="analysis-section-header">
                        <span class="analysis-section-title">5. Existing Debt Stack</span>
                    </div>
                    <div class="analysis-content">
                        <table class="rich-table">
                            <thead><tr><th>Lender</th><th>Frequency</th><th>Amount</th></tr></thead>
                            <tbody>
                                ${(data.debt || []).map(d => `<tr><td>${d.lender}</td><td>${d.freq}</td><td class="col-money">${d.amount}</td></tr>`).join('') || '<tr><td colspan="3" style="text-align:center;">No recurring debt found.</td></tr>'}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>`;
            
            resultBox.innerHTML = html;
        }

        async function runBackgroundCheck(entityName, entityLoc, key) {
            const bgSection = document.getElementById('bgScanSection');
            const nameDisplay = document.getElementById('bgScanEntityName');
            
            bgSection.style.display = 'grid'; 
            nameDisplay.innerText = entityName;
            
            const prompt = `Perform a background check on "${entityName}" located in "${entityLoc}". 
            
            TASKS:
            1. **SOS:** Find Entity Registration Status. If missing, check Delaware or assume "Operating" based on bank activity.
            2. **Reputation:** Find ACTUAL customer reviews text (Google/Yelp). Quote them.
            
            Output JSON Only:
            {
                "sos": "Status: Active | State: DE | Filed: 2020-01-01",
                "ucc": "No active liens found.",
                "legal": "No judgements found.",
                "reputation": "4.5 Stars on Google. 'Great service, fast shipping.'"
            }`;

            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        contents: [{ parts: [{ text: prompt }] }],
                        tools: [{ google_search: {} }] 
                    })
                });
                
                const data = await res.json();
                const raw = data.candidates[0].content.parts[0].text;
                const json = JSON.parse(raw.replace(/```json/g, '').replace(/```/g, '').trim());

                bgSection.style.display = 'none'; // Hide loader
                document.getElementById('bgReportGrid').style.display = 'grid';
                
                // Populate cards with structured table for SOS
                const sosData = json.sos.split('|').map(s => s.trim());
                let sosHTML = `<table class="kv-table">`;
                sosData.forEach(item => {
                    const parts = item.split(':');
                    if(parts.length > 1) {
                        sosHTML += `<tr><td class="kv-label">${parts[0].trim()}</td><td class="kv-val">${parts[1].trim()}</td></tr>`;
                    } else {
                        sosHTML += `<tr><td colspan="2" class="kv-val" style="text-align:left">${item}</td></tr>`;
                    }
                });
                sosHTML += `</table>`;

                document.getElementById('content-sos').innerHTML = sosHTML;
                document.getElementById('content-ucc').innerHTML = `<p>${json.ucc}</p>`;
                document.getElementById('content-legal').innerHTML = `<p>${json.legal}</p>`;
                document.getElementById('content-rep').innerHTML = `<p>${json.reputation}</p>`;
                
                document.getElementById('btnResetBottom').style.display = 'flex';

            } catch(e) {
                console.error(e);
                bgSection.innerHTML = `<div style="color:var(--accent-red);">Background check failed.</div>`;
            }
        }

        function manualBackgroundTrigger() {
            const name = document.getElementById('manualEntityName').value;
            if(name) runBackgroundCheck(name, "", getEffectiveKey());
        }

        function resetApp() {
            pendingFiles = [];
            document.getElementById('filePreviewContainer').innerHTML = '';
            document.getElementById('docAnalysisResult').innerHTML = '';
            document.getElementById('bgReportGrid').style.display = 'none';
            document.getElementById('bgScanSection').style.display = 'none';
            document.getElementById('dropZone').style.display = 'block';
            document.getElementById('btnResetBottom').style.display = 'none';
            document.getElementById('btnAnalyze').style.display = 'none';
            document.getElementById('entityInputGroup').style.display = 'none';
        }
    </script>
</body>
</html>
