<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live AI Business Report ‚Äî TrustBureau.ai</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            heading: ['Plus Jakarta Sans','sans-serif'],
            sans: ['Inter','sans-serif'],
          },
          colors: {
            'brand-green':'#00C09A',
            'brand-dark':'#1A1A1A',
            'brand-gray':'#666',
            'brand-light':'#F8F9FA',
            'brand-border':'#E5E7EB',
          }
        }
      }
    }
  </script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet"/>

  <!-- API key (you can also set window.zakk before loading this page) -->
  <script>
    const zakk = (typeof window !== 'undefined' && window.zakk && String(window.zakk).trim())
      ? String(window.zakk).trim()
      : 'REPLACE_WITH_YOUR_DEV_KEY';
    if (typeof window !== 'undefined' && (!window.zakk || !String(window.zakk).trim())) {
      window.zakk = zakk;
    }
  </script>

  <style>
    html{scroll-behavior:smooth}
    body{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background:#fff}
    .cta-button{transition:all .3s ease}
    .cta-button:hover{transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,192,154,.15)}
    .cta-disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
    .widget-card{border:1px solid #E5E7EB;border-radius:.75rem;background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.06)}
    /* score */
    .score-circle{width:120px;height:120px;border-radius:9999px;display:flex;align-items:center;justify-content:center;font-family:'Plus Jakarta Sans',sans-serif;font-weight:800;font-size:2.5rem;border:8px solid}
    .score-red{border-color:#FECACA;color:#DC2626;background:#FEF2F2}
    .score-yellow{border-color:#FDE68A;color:#D97706;background:#FFFBEB}
    .score-green{border-color:#A7F3D0;color:#059669;background:#ECFDF5}
    /* loader: radar + stepper + skeleton */
    .radar{width:72px;height:72px;border-radius:9999px;position:relative;border:2px solid #E5E7EB;overflow:hidden;background:
      radial-gradient(closest-side,rgba(0,192,154,.12),transparent 70%),
      conic-gradient(from 0deg,rgba(0,192,154,0) 0deg,rgba(0,192,154,.35) 35deg,rgba(0,192,154,0) 36deg);
      animation: radar-spin 1.6s linear infinite}
    .radar::before{content:"";position:absolute;inset:10%;border-radius:9999px;box-shadow:0 0 0 1px rgba(0,192,154,.12) inset,0 0 0 22px rgba(0,192,154,.06) inset}
    @keyframes radar-spin{to{transform:rotate(360deg)}}
    @keyframes shimmer{0%{background-position:200% 0}100%{background-position:-200% 0}}
    .shimmer{background:linear-gradient(100deg,#F3F4F6 40%,#E5E7EB 50%,#F3F4F6 60%);background-size:200% 100%;animation:shimmer 1.15s ease-in-out infinite}
    .skeleton-card{border:1px solid #E5E7EB;border-radius:.75rem;padding:1rem;background:#fff}
    .skel-line{height:.7rem;border-radius:.35rem}
    .step-icon{display:inline-flex;align-items:center;justify-content:center;width:1.1rem;height:1.1rem;border-radius:9999px;background:#E5E7EB;color:#fff;flex:none;margin-top:2px}
    .step-icon.done{background:#059669}
    .step-icon svg{display:none;width:.7rem;height:.7rem}
    .step-icon.done svg{display:block}
    .loader-bar{height:.5rem;border-radius:9999px;background:#E5E7EB;overflow:hidden}
    .loader-bar>span{display:block;height:100%;background:#00C09A;width:6%;transition:width .6s ease}
    /* map pin */
    .pin{width:20px;height:20px;border-radius:9999px;background:#EF4444;display:inline-block;position:relative}
    .pin::after{content:"";position:absolute;left:50%;transform:translateX(-50%);bottom:-7px;width:0;height:0;border-left:6px solid transparent;border-right:6px solid transparent;border-top:7px solid #EF4444}
  </style>
</head>

<body class="font-sans text-brand-dark">
  <!-- Header -->
  <header class="bg-white/80 border-b border-brand-border sticky top-0 z-50 backdrop-blur-md">
    <nav class="container mx-auto px-4 md:px-6 py-4 flex items-center justify-between">
      <a href="/" class="flex items-center gap-2.5">
        <svg width="32" height="32" viewBox="0 0 50 50" fill="none" aria-hidden="true">
          <path d="M25 5L42.5 12.5V27.5C42.5 37.5 25 45 25 45C25 45 7.5 37.5 7.5 27.5V12.5L25 5Z" fill="#00C09A"/>
          <path d="M17.5 25L22.5 30L32.5 20" stroke="white" stroke-width="4" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span class="font-heading text-xl md:text-2xl font-extrabold">TrustBureau.ai</span>
      </a>
      <a href="/index.html" class="inline-flex items-center gap-2 text-sm md:text-base font-medium hover:text-brand-green">
        ‚Üê Back to Main
      </a>
    </nav>
  </header>

  <!-- Search -->
  <section class="container mx-auto px-4 md:px-6 py-10 md:py-16">
    <div class="max-w-3xl mx-auto">
      <h1 class="font-heading text-3xl md:text-5xl font-extrabold text-center">Live AI Business Report</h1>
      <p class="text-gray-500 text-center mt-3">US‚Äëpreferred ‚Ä¢ Search a company and the full report appears below.</p>

      <div class="widget-card p-3 md:p-4 mt-6">
        <form id="search-form" class="flex flex-col sm:flex-row gap-3" autocomplete="off">
          <input id="business-name" type="text" placeholder="e.g., Costco Wholesale Corporation"
            class="flex-1 px-4 py-3 border border-brand-border rounded-lg placeholder-gray-500 focus:outline-none focus:ring-brand-green focus:border-brand-green">
          <button id="generate-report-btn" type="submit"
            class="inline-flex items-center justify-center gap-2 bg-brand-green text-white font-bold rounded-lg px-5 py-3 text-lg cta-button">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
              <path d="M17.293 15.707a1 1 0 00-1.414-1.414l-3.04-3.04A7 7 0 109 16a6.96 6.96 0 004.253-1.469l3.04 3.04a1 1 0 001.414-1.414zM9 14a5 5 0 110-10 5 5 0 010 10z"/>
            </svg>
            Generate
          </button>
        </form>
        <p class="text-xs text-gray-500 mt-2">Tip: Use the **US legal name** for best SOS & public‚Äërecords matching.</p>
      </div>
    </div>
  </section>

  <!-- Results -->
  <section id="results" class="container mx-auto px-4 md:px-6 pb-16">
    <div id="report-results-container" class="max-w-6xl mx-auto" style="display:none;">
      <!-- LOADER -->
      <div id="report-loader" style="display:none;" class="widget-card p-6 md:p-8 space-y-6" role="status" aria-live="polite" aria-busy="true">
        <div class="flex items-center gap-5">
          <div class="radar" aria-hidden="true"></div>
          <div class="flex-1">
            <div class="flex items-center justify-between mb-2">
              <div class="font-heading font-semibold">Building your report‚Ä¶</div>
              <div id="loader-timer" class="text-xs text-gray-500">00:00</div>
            </div>
            <div class="loader-bar"><span id="loader-bar" style="width:6%"></span></div>
            <p class="text-xs text-gray-500 mt-2">Usually 10‚Äì30s ‚Äî SOS filings, public records, reviews, headlines.</p>
          </div>
        </div>
        <ol id="loader-steps" class="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm"></ol>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div class="skeleton-card space-y-3">
            <div class="w-28 skel-line shimmer"></div>
            <div class="w-full h-20 shimmer rounded-md"></div>
            <div class="w-3/4 skel-line shimmer"></div>
            <div class="w-1/2 skel-line shimmer"></div>
          </div>
          <div class="skeleton-card space-y-3">
            <div class="w-32 skel-line shimmer"></div>
            <div class="w-full h-20 shimmer rounded-md"></div>
            <div class="w-2/3 skel-line shimmer"></div>
            <div class="w-1/3 skel-line shimmer"></div>
          </div>
          <div class="skeleton-card space-y-3">
            <div class="w-36 skel-line shimmer"></div>
            <div class="w-full h-20 shimmer rounded-md"></div>
            <div class="w-5/6 skel-line shimmer"></div>
            <div class="w-1/2 skel-line shimmer"></div>
          </div>
        </div>
      </div>

      <!-- Error -->
      <div id="report-error-container" style="display:none;" class="widget-card p-6 border-red-200 bg-red-50">
        <p id="report-error-message" class="text-sm text-red-700"></p>
      </div>

      <!-- Content -->
      <div id="report-content" style="display:none;" class="space-y-8">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <h2 id="report-title" class="font-heading text-2xl md:text-3xl font-extrabold"></h2>
            <p class="text-xs text-gray-500 mt-1">US‚Äëpreferred ‚Ä¢ live verification snapshot</p>
          </div>
          <div class="flex items-center gap-3">
            <button id="rerun" class="inline-flex items-center justify-center gap-2 bg-brand-green text-white font-bold rounded-lg px-4 py-2 cta-button">Re‚Äërun</button>
          </div>
        </div>

        <!-- Score + Summary -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">AI Risk Score</h3>
            <div class="flex flex-col items-center">
              <div id="report-score-circle" class="score-circle mb-4"><span id="report-score-digit">‚Ä¶</span></div>
              <p id="report-score-justification" class="text-center text-gray-500 text-sm mb-4 italic"></p>
              <div class="w-full text-left">
                <h4 class="text-xs font-semibold uppercase text-gray-500 mb-2">Key Factors</h4>
                <ul id="report-score-positives" class="space-y-1.5 mb-2"></ul>
                <ul id="report-score-negatives" class="space-y-1.5"></ul>
              </div>
            </div>
          </div>

          <div class="md:col-span-2 widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Business Summary</h3>
            <p id="report-summary" class="text-sm text-gray-700 leading-relaxed"></p>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
              <div class="p-4 border border-brand-border rounded-lg bg-brand-light">
                <h4 class="text-sm font-semibold text-brand-dark mb-3">Company Facts</h4>
                <ul class="text-sm text-gray-700 space-y-1">
                  <li><span class="text-gray-500">Founded:</span> <span id="facts-founded" class="ml-1"></span></li>
                  <li><span class="text-gray-500">Headquarters:</span> <span id="facts-hq" class="ml-1"></span></li>
                  <li><span class="text-gray-500">Employees:</span> <span id="facts-employees" class="ml-1"></span></li>
                  <li><span class="text-gray-500">Industry:</span> <span id="facts-industry" class="ml-1"></span></li>
                  <li><span class="text-gray-500">Ticker:</span> <span id="facts-ticker" class="ml-1"></span></li>
                  <li><span class="text-gray-500">Website:</span> <span id="facts-website" class="ml-1"></span></li>
                </ul>
              </div>
              <div class="p-4 border border-brand-border rounded-lg bg-brand-light">
                <h4 class="text-sm font-semibold text-brand-dark mb-3">Recent Headlines</h4>
                <ul id="report-news-list" class="space-y-2"></ul>
              </div>
            </div>
          </div>
        </div>

        <!-- Contact + Owners -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Contact & Location</h3>
            <ul class="text-sm text-gray-700 space-y-1">
              <li><span class="text-gray-500">Address:</span> <span id="contact-address" class="ml-1"></span></li>
              <li><span class="text-gray-500">Phone:</span> <span id="contact-phone" class="ml-1"></span></li>
              <li><span class="text-gray-500">Email:</span> <span id="contact-email" class="ml-1"></span></li>
              <li><span class="text-gray-500">Hours:</span> <span id="contact-hours" class="ml-1"></span></li>
              <li class="mt-2"><span class="pin" aria-hidden="true"></span>
                <a id="contact-maps" href="#" target="_blank" rel="noopener" class="ml-2 text-brand-green hover:underline">Open in Google Maps</a>
              </li>
            </ul>
          </div>

          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Owners</h3>
            <ul id="owners-list" class="space-y-2 text-sm text-gray-700"></ul>
          </div>
        </div>

        <!-- Filings + Public Records -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Corporate Filings (SOS)</h3>
            <ul class="text-sm text-gray-700 space-y-1">
              <li><span class="text-gray-500">Entity Name:</span> <span id="report-sos-name" class="ml-1"></span></li>
              <li><span class="text-gray-500">Entity Type:</span> <span id="report-sos-entity" class="ml-1"></span></li>
              <li><span class="text-gray-500">Status:</span> <span id="report-sos-status" class="ml-1"></span></li>
              <li><span class="text-gray-500">Jurisdiction:</span> <span id="report-sos-jurisdiction" class="ml-1"></span></li>
              <li><span class="text-gray-500">Formation Date:</span> <span id="report-sos-date" class="ml-1"></span></li>
              <li><span class="text-gray-500">Registered Agent:</span> <span id="report-sos-agent" class="ml-1"></span></li>
            </ul>
          </div>

          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Public Records</h3>
            <ul id="report-records-list" class="space-y-2 list-disc list-inside text-sm text-gray-700 leading-relaxed"></ul>
          </div>
        </div>

        <!-- Leadership / Products / Competitors / Web Signals -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Leadership</h3>
            <ul id="report-leadership-list" class="space-y-2 text-sm text-gray-700"></ul>
          </div>
          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Products & Services</h3>
            <ul id="report-products-list" class="space-y-2 text-sm text-gray-700"></ul>
          </div>
          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Competitors</h3>
            <ul id="report-competitors-list" class="space-y-2 text-sm text-gray-700"></ul>
          </div>
          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Web & Social Signals</h3>
            <ul id="report-social-list" class="space-y-1.5 text-sm text-gray-700"></ul>
          </div>
        </div>

        <!-- Reviews + Charts -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Customer Reviews</h3>
            <div id="report-reviews-list" class="space-y-3"></div>
          </div>

          <div class="widget-card p-5 md:p-6">
            <h3 class="font-heading font-semibold mb-3">Financial Charts (Fictional)</h3>
            <div class="grid grid-cols-1 gap-4">
              <div>
                <h5 class="text-sm font-medium text-brand-dark mb-1">Revenue Trend</h5>
                <div id="report-chart-revenue" class="h-24"></div>
              </div>
              <div>
                <h5 class="text-sm font-medium text-brand-dark mb-1">Cash Flow</h5>
                <div id="report-chart-cashflow" class="h-24"></div>
              </div>
            </div>
          </div>
        </div>

        <!-- Sources -->
        <div id="report-sources-container" class="widget-card p-5 md:p-6" style="display:none;">
          <div class="flex items-center justify-between">
            <h4 class="text-xs font-semibold text-gray-500 uppercase">Sources & Links</h4>
            <button id="toggle-sources" type="button" class="text-xs text-brand-green hover:underline">Show list</button>
          </div>
          <div id="report-sources-chips" class="flex flex-wrap gap-2 mt-3"></div>
          <ul id="report-sources" class="mt-4 space-y-1 list-disc list-inside hidden"></ul>
        </div>
      </div>
    </div>
  </section>

  <footer class="border-top border-brand-border">
    <div class="container mx-auto px-4 md:px-6 py-10 text-center text-sm text-gray-500">
      &copy; 2025 TrustBureau.ai ‚Äî Live AI Business Report
    </div>
  </footer>

  <script>
    /* ===================== Config ===================== */
    const MODEL_CANDIDATES = [
      'gemini-2.5-pro',                  // richer
      'gemini-2.5-flash',                // fast
      'gemini-2.5-flash-preview-09-2025',
      'gemini-2.0-flash'
    ];
    const USE_SEARCH_TOOL = true;
    const MAX_OUTPUT_TOKENS = 33192;

    /* ===================== Utilities ===================== */
    const el = id => document.getElementById(id);
    const setText = (node, v) => node.textContent = (v && String(v).trim()) ? v : 'N/A';
    const toDomain = url => { try { return new URL(url).hostname.replace(/^www\./,''); } catch { return url; } };
    const linkify = v => (!v) ? 'N/A' :
      /^https?:\/\//i.test(String(v).trim())
        ? `<a href="${v}" target="_blank" rel="noopener" class="text-brand-green hover:underline">${toDomain(v)}</a>`
        : String(v);

    /* ===================== Loader UI ===================== */
    let __loaderCtl = null;
    function startLoading() {
      const steps = [
        'Match US entity','Search web','SOS filings','Public records',
        'Leadership & owners','Products/services','Competitors',
        'Web/social signals','Headlines','Reviews','Risk model & charts'
      ];
      el('loader-steps').innerHTML = steps.map((s,i)=>`
        <li class="flex items-start gap-2">
          <span class="step-icon" id="ld_${i}">
            <svg viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>
          </span><span>${s}</span>
        </li>`).join('');
      let elapsed=0, idx=0;
      const bar=el('loader-bar'), timer=el('loader-timer');
      const tTimer=setInterval(()=>{elapsed+=200; const m=Math.floor(elapsed/1000/60),s=Math.floor((elapsed/1000)%60); timer.textContent=`${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`},200);
      const tSteps=setInterval(()=>{ if(idx<steps.length){ el(`ld_${idx}`)?.classList.add('done'); idx++; bar.style.width=Math.min(98,Math.round((idx/steps.length)*100-2))+'%'; } else { bar.style.width=Math.min(99,(parseFloat(bar.style.width)||98)+0.2)+'%'; } }, 1200);
      return { stop(){ clearInterval(tTimer); clearInterval(tSteps); bar.style.width='100%'; } };
    }
    function showState(state, msg='') {
      el('report-results-container').style.display='block';
      el('report-loader').style.display='none';
      el('report-error-container').style.display='none';
      el('report-content').style.display='none';
      if (__loaderCtl) { __loaderCtl.stop(); __loaderCtl=null; }
      if (state==='loading'){ el('report-loader').style.display='block'; __loaderCtl=startLoading(); }
      if (state==='error'){ el('report-error-container').style.display='block'; el('report-error-message').textContent=msg||'Something went wrong.'; }
      if (state==='content'){ el('report-content').style.display='block'; }
    }

    /* ===================== JSON parsing ===================== */
    function parseCandidateJSON(candidate) {
      const parts = candidate?.content?.parts || [];
      for (const p of parts) if (typeof p?.text==='string' && p.text.trim()) {
        const raw=p.text.replace(/```json/g,'').replace(/```/g,'').trim();
        try { return JSON.parse(raw); } catch {}
        const cut=Math.max(raw.lastIndexOf('}'),raw.lastIndexOf(']')); if (cut>0) { try { return JSON.parse(raw.slice(0,cut+1)); } catch {} }
      }
      for (const p of parts) if (p?.inline_data?.data && String(p.inline_data.mimeType||'').includes('json')) {
        try { return JSON.parse(atob(p.inline_data.data)); } catch {}
      }
      throw new Error('Model returned no parseable JSON.');
    }

    /* ===================== Sources helpers ===================== */
    function normalizeUrl(u){ try{ const url=new URL(u); url.search=''; if(url.pathname!=='/'&&url.pathname.endsWith('/')) url.pathname=url.pathname.slice(0,-1); return url.toString(); }catch{return null} }
    function prettyUrl(u){ try{ const url=new URL(u); let out=url.hostname.replace(/^www\./,''); if(url.pathname&&url.pathname!=='/') out+=url.pathname; return out.length>60?out.slice(0,57)+'‚Ä¶':out; }catch{return u} }
    function collectSources(json, modelSources){
      const out=[], push=(title,url,kind)=>{ const norm=normalizeUrl(url); if(!norm) return; out.push({title:title||prettyUrl(norm), url:norm, kind}); };
      (json?.citations||[]).forEach(c=>push(c.title||c.url,c.url,'citation'));
      (modelSources||[]).forEach(s=>push(s.title||s.uri,s.uri,'source'));
      if (json?.profile?.website) push('Website', json.profile.website,'site');
      const w=json?.webPresence||{};
      if (w.twitter) push('Twitter', w.twitter,'social');
      if (w.linkedin) push('LinkedIn', w.linkedin,'social');
      if (w.youtube) push('YouTube', w.youtube,'social');
      (json?.news||[]).forEach(n=>n?.url&&push(n.title||n.source||'News', n.url,'news'));
      (json?.reviews||[]).forEach(r=>r?.url&&push(r.source||'Review', r.url,'review'));
      const seen=new Set(); return out.filter(({url})=>!seen.has(url)&&seen.add(url));
    }
    function populateSources(links){
      const chips=el('report-sources-chips'), ul=el('report-sources'), box=el('report-sources-container');
      chips.innerHTML=''; ul.innerHTML='';
      if(!Array.isArray(links)||!links.length){ box.style.display='none'; return; }
      box.style.display='block';
      links.forEach(({url,title,kind})=>{
        const emoji= kind==='news'?'üì∞':kind==='review'?'‚≠ê':kind==='social'?'üîó':kind==='site'?'üè¢':kind==='citation'?'üìö':'üîó';
        const span=document.createElement('span');
        span.className='border border-brand-border rounded-full bg-brand-light px-2 py-1 text-xs';
        span.innerHTML = `${emoji} <a href="${url}" target="_blank" rel="noopener" class="text-brand-green font-semibold hover:underline">${title||prettyUrl(url)}</a>`;
        chips.appendChild(span);
      });
      links.forEach(({url,title})=>{
        const li=document.createElement('li');
        li.className='text-sm';
        li.innerHTML=`<a class="text-brand-green hover:underline" href="${url}" target="_blank" rel="noopener">${title||prettyUrl(url)}</a><span class="text-xs text-gray-400 ml-1">(${prettyUrl(url)})</span>`;
        ul.appendChild(li);
      });
      let open=false;
      el('toggle-sources').onclick=()=>{ open=!open; ul.classList.toggle('hidden',!open); el('toggle-sources').textContent=open?'Hide list':'Show list'; };
    }

    /* ===================== Charts ===================== */
    function renderLineChart(container, values, color) {
      if (!Array.isArray(values)||values.length<2){ container.innerHTML='<p class="text-sm text-gray-700">Chart not available.</p>'; return; }
      const nums=values.map(v=>Number.isFinite(+v)?+v:0), min=Math.min(...nums), max=Math.max(...nums);
      const norm = (max-min)>0 ? nums.map(n=> (100*(n-min))/(max-min) ) : nums.map(()=>50);
      const step = 100/(norm.length-1);
      const pts = norm.map((v,i)=> `${(i*step).toFixed(2)},${(50-(v/100)*44-3).toFixed(2)}` ).join(' ');
      container.innerHTML=`<svg width="100%" height="100%" viewBox="0 0 100 50" preserveAspectRatio="none">
        <polyline fill="none" stroke="${color}" stroke-width="2" points="${pts}"/>
        <line x1="0" y1="48" x2="100" y2="48" stroke="#E5E7EB" stroke-width="1"/></svg>`;
    }

    /* ===================== Scoring fixes ===================== */
    function clamp(v, lo, hi){ return Math.max(lo, Math.min(hi, v)); }
    function normalizeScore(raw) {
      if (raw==null || isNaN(+raw)) return null;
      const n = +raw;
      if (n<=10) return clamp(Math.round(300 + (n/10)*550), 300, 850);   // 1‚Äì10 ‚Üí 300‚Äì850
      if (n<=100) return clamp(Math.round(300 + (n/100)*550), 300, 850); // 0‚Äì100 ‚Üí 300‚Äì850
      return clamp(Math.round(n), 300, 850);                             // assume already on 300‚Äì850
    }
    function heuristicScore(data) {
      // Base and adjustments from factual hints
      let score = 650;
      const founded = parseInt((data?.profile?.founded||'').toString().match(/\d{4}/)?.[0]||'');
      if (founded) {
        const age = new Date().getFullYear() - founded;
        if (age>=15) score += 40; else if (age>=7) score += 15; else score -= 25;
      }
      const status = (data?.sos?.status||'').toLowerCase();
      if (status.includes('active')) score += 35;
      if (status.includes('inactive') || status.includes('dissolved') || status.includes('revoked')) score -= 120;

      const negatives=(data?.publicRecords?.findings||[])
        .filter(f=>/lien|judg|bankrupt|lawsuit|fine|penalty|sanction|default|tax/i.test(f?.type||f?.details||'')).length;
      score -= negatives*35;

      const web = data?.webPresence||{};
      if (web?.linkedin) score += 10;
      if (web?.twitter) score += 5;
      if (web?.traffic && /[0-9]/.test(web.traffic)) score += 10;

      return clamp(Math.round(score), 300, 850);
    }

    /* ===================== Populate DOM ===================== */
    function populateReport(data) {
      setText(el('report-title'), data?.summary?.companyName);
      el('report-summary').textContent = data?.summary?.summary || 'No summary could be found.';

      // Score normalization + fallback
      let score = normalizeScore(data?.riskScore?.score);
      if (score==null) score = heuristicScore(data);
      el('report-score-digit').textContent = score;
      el('report-score-justification').textContent = data?.riskScore?.justification || 'Composite risk score computed from age, status, public records and web presence.';
      const circle = el('report-score-circle'); circle.className='score-circle mb-4';
      if (score<550) circle.classList.add('score-red');
      else if (score<700) circle.classList.add('score-yellow');
      else circle.classList.add('score-green');

      const pos=el('report-score-positives'); pos.innerHTML='';
      (data?.riskScore?.positiveFactors||[]).forEach(f=>{
        const li=document.createElement('li'); li.className='flex items-start';
        li.innerHTML='<svg class="w-4 h-4 text-green-500 mr-2 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/></svg>' +
          `<span class="text-sm text-brand-dark">${f}</span>`; pos.appendChild(li);
      });
      const neg=el('report-score-negatives'); neg.innerHTML='';
      (data?.riskScore?.negativeFactors||[]).forEach(f=>{
        const li=document.createElement('li'); li.className='flex items-start';
        li.innerHTML='<svg class="w-4 h-4 text-red-500 mr-2 mt-0.5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/></svg>' +
          `<span class="text-sm text-brand-dark">${f}</span>`; neg.appendChild(li);
      });

      const sos=data?.sos||{};
      setText(el('report-sos-name'), sos.entityName); setText(el('report-sos-entity'), sos.entityType);
      setText(el('report-sos-status'), sos.status); setText(el('report-sos-jurisdiction'), sos.jurisdiction);
      setText(el('report-sos-date'), sos.formationDate); setText(el('report-sos-agent'), sos.registeredAgent);

      const p=data?.profile||{};
      setText(el('facts-founded'), p.founded); setText(el('facts-hq'), p.headquarters||p.hq);
      setText(el('facts-employees'), p.employees); setText(el('facts-industry'), p.industry||p.subindustry);
      setText(el('facts-ticker'), p.ticker);
      el('facts-website').innerHTML = linkify(p.website || data?.summary?.website);

      // Contact & maps
      const c=data?.contact||{};
      setText(el('contact-address'), c.address);
      setText(el('contact-phone'), c.phone);
      setText(el('contact-email'), c.email);
      setText(el('contact-hours'), c.hours);
      const mapsQ = encodeURIComponent(c.mapsQuery||c.address||p.headquarters||data?.summary?.companyName||'');
      el('contact-maps').href = `https://www.google.com/maps/search/?api=1&query=${mapsQ}`;

      // Owners
      const owners = el('owners-list'); owners.innerHTML='';
      (data?.owners||[]).forEach(o=>{
        const li=document.createElement('li');
        li.innerHTML = `<span class="font-medium text-brand-dark">${o.name||'Owner'}</span> ‚Äî <span class="text-gray-700">${o.role||''}</span>`
          + (o.linkedin ? ` ¬∑ <a class="text-brand-green hover:underline" target="_blank" rel="noopener" href="${o.linkedin}">LinkedIn</a>` : '');
        owners.appendChild(li);
      });
      if (!owners.children.length) owners.innerHTML='<li class="text-sm text-gray-600">No owner records.</li>';

      // News
      const news=el('report-news-list'); news.innerHTML='';
      (data?.news||[]).slice(0,8).forEach(n=>{
        const li=document.createElement('li');
        li.innerHTML=`<a class="text-brand-dark hover:text-brand-green font-medium leading-tight" href="${n.url||'#'}" target="_blank" rel="noopener">${n.title||'Untitled'}</a>
          <div class="text-xs text-gray-500">${n.source||'Source'}${n.date?' ‚Ä¢ '+n.date:''}</div>`;
        news.appendChild(li);
      });
      if (!news.children.length) news.innerHTML='<li class="text-sm text-gray-600">No recent news.</li>';

      // Leadership / Products / Competitors / Social
      const L=el('report-leadership-list'); L.innerHTML='';
      (data?.leadership||[]).slice(0,12).forEach(x=>{
        const li=document.createElement('li'); li.innerHTML=`<span class="font-medium text-brand-dark">${x.name||'N/A'}</span> ‚Äî <span class="text-gray-700">${x.title||''}</span>`;
        L.appendChild(li);
      });
      if (!L.children.length) L.innerHTML='<li class="text-sm text-gray-600">No leadership data.</li>';

      const P=el('report-products-list'); P.innerHTML='';
      (data?.products||[]).slice(0,14).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; P.appendChild(li); });
      if (!P.children.length) P.innerHTML='<li class="text-sm text-gray-600">No products listed.</li>';

      const C=el('report-competitors-list'); C.innerHTML='';
      (data?.competitors||[]).slice(0,14).forEach(t=>{ const li=document.createElement('li'); li.textContent=t; C.appendChild(li); });
      if (!C.children.length) C.innerHTML='<li class="text-sm text-gray-600">No competitors listed.</li>';

      const S=el('report-social-list'); S.innerHTML='';
      const web=data?.webPresence||{};
      [['Website Traffic',web.traffic],['Twitter/X',web.twitter],['LinkedIn',web.linkedin],['YouTube',web.youtube]].forEach(([k,v])=>{
        if(!v) return; const li=document.createElement('li'); li.innerHTML=`<span class="text-gray-500">${k}:</span> <span class="font-medium text-brand-dark">${linkify(v)}</span>`; S.appendChild(li);
      });
      if (!S.children.length) S.innerHTML='<li class="text-sm text-gray-600">No social signals.</li>';

      // Public records
      const rec=el('report-records-list'); rec.innerHTML='';
      if (Array.isArray(data?.publicRecords?.findings) && data.publicRecords.findings.length){
        data.publicRecords.findings.forEach(f=>{
          const li=document.createElement('li'); const isNeg=/lien|judg|bankrupt|lawsuit|fine|penalty|sanction|default|tax/i.test(f?.type||f?.details||'');
          li.className=isNeg?'text-red-600':'text-green-600';
          li.innerHTML=`<strong>${f.type||'Finding'}:</strong> <span class="text-gray-700">${f.details||''}</span>`;
          rec.appendChild(li);
        });
      } else { rec.innerHTML='<li class="text-sm text-gray-600">No significant public records found.</li>'; }

      // Reviews
      const R=el('report-reviews-list'); R.innerHTML='';
      (data?.reviews||[]).slice(0,6).forEach(r=>{
        const b=document.createElement('blockquote'); b.className='p-4 border-l-4 border-brand-border bg-brand-light';
        b.innerHTML = `<p class="text-sm italic text-brand-gray">"${r.snippet||'No snippet'}"</p><footer class="mt-2 text-xs text-brand-dark font-medium">${r.source||'Review'}${r.url?` ‚Äî <a href="${r.url}" target="_blank" rel="noopener" class="text-brand-green hover:underline">${toDomain(r.url)}</a>`:''}</footer>`;
        R.appendChild(b);
      });
      if (!R.children.length) R.innerHTML='<p class="text-sm text-gray-600">No recent customer reviews.</p>';

      // Charts (use provided or sensible defaults)
      const pts = data?.chartPoints||{};
      renderLineChart(el('report-chart-revenue'), Array.isArray(pts.revenue)&&pts.revenue.length>1?pts.revenue:[40,45,50,55,60,62,66,70], '#00C09A');
      renderLineChart(el('report-chart-cashflow'), Array.isArray(pts.cashFlow)&&pts.cashFlow.length>1?pts.cashFlow:[60,58,59,55,53,52,50,49], '#3B82F6');
    }

    /* ===================== API (v1beta) ===================== */
    function getApiKey(){
      const fromWindow=(typeof window!=='undefined'&&window.zakk)?String(window.zakk).trim():'';
      const fromConst=(typeof zakk!=='undefined'&&zakk)?String(zakk).trim():'';
      return fromWindow||fromConst;
    }
    async function fetchWithBackoff(url, options, retries=3, delay=800){
      let lastError;
      for(let i=0;i<retries;i++){
        try{
          const res=await fetch(url, options);
          if(!res.ok){ let body=null; try{body=await res.json()}catch{}; const msg=body?.error?.message||res.statusText||'Request failed'; const err=new Error(`${msg} (HTTP ${res.status})`); err.code=body?.error?.status; throw err; }
          return await res.json();
        }catch(e){ lastError=e; if(i<retries-1) await new Promise(r=>setTimeout(r, delay*Math.pow(2,i))); }
      }
      throw lastError||new Error('API request failed.');
    }
    function makePayload(systemPrompt, userQuery, withSearch) {
      const payload = {
        contents: [{ role:'user', parts:[{ text:userQuery }] }],
        systemInstruction: { parts:[{ text: systemPrompt }] },
        generationConfig: {
          maxOutputTokens: MAX_OUTPUT_TOKENS,
          temperature: 0.2,
          topP: 0.95,
          responseMimeType: 'application/json'
        }
      };
      if (withSearch) payload.tools=[{ googleSearch:{} }];
      return payload;
    }
    async function callReportAPI(systemPrompt, userQuery){
      const key=getApiKey(); if(!key) throw new Error('Missing API key (zakk).');
      const base='https://generativelanguage.googleapis.com/v1beta/models';
      let lastErr;
      for (const model of MODEL_CANDIDATES){
        const url=`${base}/${model}:generateContent?key=${encodeURIComponent(key)}`;
        let payload=makePayload(systemPrompt, userQuery, USE_SEARCH_TOOL);
        for (let attempt=1; attempt<=2; attempt++){
          try{
            const data=await fetchWithBackoff(url,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
            const cand=data?.candidates?.[0]; if(!cand) throw new Error('No candidates in response.');
            const json=parseCandidateJSON(cand);
            const atts=cand?.groundingMetadata?.groundingAttributions||[];
            const sources=atts.map(a=>({uri:a.web?.uri, title:a.web?.title})).filter(s=>s.uri);
            return { json, sources };
          }catch(e){
            lastErr=e;
            const noisy=/no parseable json|no json|unexpected end/i.test(e.message||'');
            if (attempt===1 && noisy){
              const stricter = systemPrompt + `

IMPORTANT: Return **one valid JSON object only** (no commentary, no fences). If info is unknown, use "N/A" or [].`;
              payload = makePayload(stricter, userQuery, USE_SEARCH_TOOL);
              continue;
            }
            break;
          }
        }
      }
      throw lastErr||new Error('All model attempts failed.');
    }

    /* ===================== Prompts ===================== */
    function basePrompt(){
      return `
ROLE: US-focused business analyst. Prefer US entities, US Secretary of State (SOS) pages, IRS/EIN references, US news and US review sources.
TASK: Return ONE JSON object ONLY (no prose). Do web.search if helpful.

REQUIRED JSON FIELDS:
summary: { companyName, summary }
profile: { founded, headquarters, employees, website, industry, subindustry, ticker }
contact: { address, phone, email, hours, mapsQuery }
owners: [{ name, role, linkedin }]
leadership: [{ name, title }]
products: [string]
competitors: [string]
webPresence: { twitter, linkedin, youtube, traffic }
sos: { entityName, status, entityType, jurisdiction, formationDate, registeredAgent }
publicRecords: { findings: [{ type, details }] }
news: [{ title, date, source, url }]
reviews: [{ snippet, source, url }]
riskScore: { score (300-850 ONLY), justification, positiveFactors:[string], negativeFactors:[string] }
chartPoints: { revenue:[number], cashFlow:[number] } // 10‚Äì24 points
citations: [{ title, url }]

US BIAS / LINKEDIN:
- Choose the US entity if multiple matches; use US addresses/phone formats.
- Actively search LinkedIn: site:linkedin.com/company for the business; site:linkedin.com/in for founder/CEO/owner.

COMPLETENESS TARGETS:
- news ‚â• 4, leadership ‚â• 4, products ‚â• 6, competitors ‚â• 6, reviews ‚â• 3.
- If unknown, set "N/A" or [].
STRICT: Only valid JSON. No markdown fences. No commentary.
`.trim();
    }
    function fillMissingPrompt(missingList){
      return `
ROLE: Same as above. You are **filling missing sections only** for a US company report.
Return ONE JSON object with ONLY these fields populated if missing or too short: ${missingList.join(', ')}.
Reuse any reliable US sources. Keep riskScore strictly within 300‚Äì850. No commentary. JSON only.
`.trim();
    }

    function needsMore(json){
      const lacks = [];
      if (!json?.news || json.news.length<4) lacks.push('news (‚â•4)');
      if (!json?.leadership || json.leadership.length<4) lacks.push('leadership (‚â•4)');
      if (!json?.products || json.products.length<6) lacks.push('products (‚â•6)');
      if (!json?.competitors || json.competitors.length<6) lacks.push('competitors (‚â•6)');
      if (!json?.reviews || json.reviews.length<3) lacks.push('reviews (‚â•3)');
      if (!json?.owners || json.owners.length<1) lacks.push('owners (‚â•1)');
      if (!json?.contact || !json.contact.address) lacks.push('contact.address');
      return lacks;
    }

    /* ===================== Wire up ===================== */
    document.addEventListener('DOMContentLoaded', ()=>{
      const form=el('search-form'), input=el('business-name'), btn=el('generate-report-btn'), rerun=el('rerun');

      async function runReport(query){
        showState('loading'); btn.disabled=true; btn.classList.add('cta-disabled');
        const sys=basePrompt();
        const uq = `Generate a comprehensive **US** business report for: "${query}". Match the US legal entity if any.`;
        try{
          // Pass 1
          const { json: j1, sources: s1 } = await callReportAPI(sys, uq);
          let data=j1, sources=s1;

          // Pass 2 if needed
          const missing = needsMore(data);
          if (missing.length){
            const { json: j2, sources: s2 } = await callReportAPI(fillMissingPrompt(missing), `Fill missing sections only for "${query}" (US entity).`);
            // Merge shallowly where fields missing/short
            const mergeArr=(a,b,min=0)=> Array.isArray(b)&&b.length>=min ? b : (Array.isArray(a)?a:[]);
            data.summary ??= j2.summary;
            data.profile ??= j2.profile;
            data.contact = Object.assign({}, j2.contact||{}, data.contact||{}); // prefer j2 for contact
            data.owners = mergeArr(data.owners, j2.owners, 1);
            data.leadership = mergeArr(data.leadership, j2.leadership, 4);
            data.products = mergeArr(data.products, j2.products, 6);
            data.competitors = mergeArr(data.competitors, j2.competitors, 6);
            data.webPresence = Object.assign({}, data.webPresence||{}, j2.webPresence||{});
            data.sos ??= j2.sos;
            data.publicRecords ??= j2.publicRecords;
            data.news = mergeArr(data.news, j2.news, 4);
            data.reviews = mergeArr(data.reviews, j2.reviews, 3);
            data.riskScore = j2.riskScore || data.riskScore;
            data.chartPoints = j2.chartPoints || data.chartPoints;
            sources = [...(sources||[]), ...(s2||[])];
          }

          // Populate UI
          populateReport(data);
          populateSources(collectSources(data, sources));
          showState('content');
        }catch(e){
          console.error(e);
          showState('error', e.message||'Failed to generate report.');
        }finally{
          btn.disabled=false; btn.classList.remove('cta-disabled');
        }
      }

      form.addEventListener('submit', e=>{ e.preventDefault(); const q=(input.value||'').trim(); if(!q){ showState('error','Please enter a business name.'); return; } runReport(q); });
      rerun?.addEventListener('click', ()=>{ const q=(input.value||'').trim(); if(!q){ showState('error','Please enter a business name.'); return; } runReport(q); });
    });
  </script>
</body>
</html>
