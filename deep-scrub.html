<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustBureau DeepScrub | AI Due Diligence</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z' fill='white' opacity='0.1' stroke='white' stroke-width='1.5'/%3E%3Cpath d='M9 12l2 2 4-4' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round' fill='none'/%3E%3C/svg%3E">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-body: #0a0a0a;
            --bg-aurora: #1a2c2a;
            --bg-card: rgba(20, 20, 20, 0.4);
            --bg-card-hover: rgba(30, 30, 30, 0.6);
            --border-primary: rgba(255, 255, 255, 0.1);
            --border-hover: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: #a1a1aa;
            --text-muted: #888888;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-red: #ef4444;
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
            position: relative;
            overflow-x: hidden;
        }

        /* Aurora Background */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(ellipse 120% 80% at 50% 20%, var(--bg-aurora) 0%, transparent 50%),
                        radial-gradient(ellipse 80% 60% at 80% 50%, rgba(20, 40, 35, 0.3) 0%, transparent 50%),
                        radial-gradient(ellipse 60% 80% at 20% 80%, rgba(15, 30, 25, 0.2) 0%, transparent 50%);
            pointer-events: none;
            z-index: -3;
            animation: auroraPulse 10s ease-in-out infinite;
        }

        @keyframes auroraPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }

        /* Grid Pattern */
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 60px 60px;
            mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, black 0%, transparent 70%);
            -webkit-mask-image: radial-gradient(ellipse 80% 50% at 50% 0%, black 0%, transparent 70%);
            pointer-events: none;
            z-index: -2;
        }

        /* Noise Texture */
        .noise-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
            z-index: -1;
            opacity: 0.04;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 0 2rem;
            flex: 1;
            display: flex;
            flex-direction: column;
            position: relative;
            z-index: 1;
        }

        /* Header */
        header {
            padding: 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 4rem;
            animation: fadeIn 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .logo-group {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .logo:hover {
            transform: translateX(4px);
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            filter: drop-shadow(0 0 12px rgba(34, 197, 94, 0.2));
        }

        .logo-text {
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-text .bureau {
            color: var(--text-muted);
        }

        .logo-text .deepscrub {
            color: var(--text-muted);
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-api {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .btn-api:hover {
            border-color: var(--border-hover);
            color: var(--text-primary);
            background: var(--bg-card-hover);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255,255,255,0.05);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            display: inline-block;
        }
        
        .status-dot.active { 
            background: var(--accent-green); 
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.6); 
        }
        .status-dot.inactive { 
            background: var(--accent-red); 
            box-shadow: 0 0 8px rgba(239, 68, 68, 0.6); 
        }

        /* Search Input Area */
        .search-wrapper {
            max-width: 680px;
            margin: 0 auto;
            position: relative;
            width: 100%;
            animation: slideUp 0.6s ease-out;
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(20px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        .input-group {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 0.35rem 0.35rem 0.35rem 1.5rem;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 
                0 0 30px rgba(255,255,255,0.03),
                0 0 60px rgba(255,255,255,0.02),
                inset 0 0 20px rgba(255,255,255,0.02);
            backdrop-filter: blur(20px);
        }

        .input-group:focus-within {
            border-color: var(--border-hover);
            box-shadow: 
                0 0 40px rgba(255,255,255,0.08),
                0 0 80px rgba(255,255,255,0.04),
                0 0 2px rgba(255,255,255,0.3),
                inset 0 0 30px rgba(255,255,255,0.03);
            transform: scale(1.01);
        }

        .unibox {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.125rem;
            padding: 0.75rem 0;
            outline: none;
            width: 100%;
            flex: 1;
        }

        .unibox::placeholder {
            color: #555;
        }

        .btn-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 52px;
            height: 52px;
            border-radius: 12px;
            background: var(--text-primary);
            color: #000;
            border: none;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            flex-shrink: 0;
            padding: 0;
        }

        .btn-action:hover {
            transform: scale(1.05);
            background: #fff;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.4);
        }

        .btn-action:disabled {
            opacity: 0.8;
            cursor: wait;
            background: #333;
            color: #666;
            transform: none;
            box-shadow: none;
        }

        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }

        /* Report Layout & Animation Container */
        .report-container-wrapper {
            position: relative;
            margin-top: 3rem;
            margin-bottom: 2rem;
        }

        #loadingCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #loadingCanvas.active {
            opacity: 1;
        }

        .report-grid {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(380px, 1fr));
            gap: 1.5rem;
            opacity: 0; 
            transition: filter 0.5s ease-out, opacity 0.5s ease-out;
        }
        
        .report-grid.scanning {
            display: grid;
            filter: blur(20px);
            opacity: 0.4;
        }
        
        .report-grid.resolved {
            filter: blur(0px);
            opacity: 1;
        }

        .report-card {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            padding: 2rem;
            position: relative;
            display: flex;
            flex-direction: column;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 
                0 0 30px rgba(255,255,255,0.03),
                0 0 60px rgba(255,255,255,0.02),
                inset 0 0 20px rgba(255,255,255,0.02),
                0 0 1px rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
        }

        .report-card:hover {
            border-color: var(--border-hover);
            background: var(--bg-card-hover);
            transform: translateY(-4px);
            box-shadow: 
                0 0 40px rgba(255,255,255,0.08),
                0 0 80px rgba(255,255,255,0.04),
                0 0 2px rgba(255,255,255,0.3),
                inset 0 0 30px rgba(255,255,255,0.03);
        }

        .report-card.full-width {
            grid-column: 1 / -1;
            border-color: var(--border-hover);
        }
        
        @media (min-width: 900px) {
            .report-card.wide-card { grid-column: span 2; }
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .header-title-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon { 
            color: var(--text-muted);
            opacity: 0.7;
        }

        .card-title {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .btn-deep {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            color: var(--text-muted);
            font-size: 0.65rem;
            padding: 0.375rem 0.75rem;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
            letter-spacing: 0.1em;
            transition: all 0.3s;
        }

        .btn-deep:hover {
            color: var(--text-primary);
            border-color: var(--border-hover);
            background: var(--bg-card-hover);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }

        .btn-deep:disabled {
            opacity: 0.5;
            cursor: wait;
        }

        .card-content {
            font-size: 0.9375rem;
            line-height: 1.7;
            color: var(--text-secondary);
            flex: 1;
        }

        /* Data Rows */
        .data-list {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 0.875rem 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .data-row:last-child { border-bottom: none; }

        .data-label-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .data-icon {
            color: var(--text-muted);
            width: 14px;
            height: 14px;
            opacity: 0.6;
        }

        .data-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 90px;
            padding-top: 0.1rem;
            font-weight: 600;
        }

        .check-icon {
            color: var(--accent-green);
            width: 14px;
            height: 14px;
            filter: drop-shadow(0 0 4px rgba(34, 197, 94, 0.4));
        }

        .data-value {
            font-size: 0.9375rem;
            color: var(--text-primary);
            text-align: right;
            font-weight: 500;
            word-break: break-word;
            max-width: 250px;
        }

        .source-link {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            margin-top: 1.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.2s;
            align-self: flex-start;
        }

        .source-link:hover { 
            color: var(--text-primary); 
        }

        /* Map Embed Styles */
        .map-container {
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--border-primary);
            background: rgba(0,0,0,0.3);
            margin-top: 0.5rem;
            height: 250px;
            position: relative;
        }
        
        .map-iframe {
            width: 100%;
            height: 100%;
            border: 0;
            display: block;
            filter: grayscale(100%) invert(90%);
            pointer-events: none;
        }

        .map-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn-map-action {
            flex: 1;
            padding: 0.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 12px;
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            text-align: center;
            text-decoration: none;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-map-action:hover {
            background: var(--bg-card-hover);
            color: var(--text-primary);
            border-color: var(--border-hover);
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(255,255,255,0.08);
        }

        /* Review Styles */
        .review-item {
            padding: 1.25rem;
            background: rgba(255,255,255,0.02);
            border-radius: 12px;
            border: 1px solid var(--border-primary);
            margin-bottom: 0.75rem;
            transition: all 0.3s;
        }
        
        .review-item:last-child { margin-bottom: 0; }

        .review-item:hover {
            border-color: var(--border-hover);
            background: rgba(255,255,255,0.04);
        }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .review-text {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            line-height: 1.6;
        }

        .review-rating {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Findings */
        .finding-item {
            display: flex;
            gap: 0.875rem;
            align-items: flex-start;
            padding: 0.625rem 0;
        }

        .finding-dot {
            width: 6px;
            height: 6px;
            background: var(--text-primary);
            border-radius: 50%;
            margin-top: 0.5rem;
            flex-shrink: 0;
            box-shadow: 0 0 10px rgba(255,255,255,0.4);
        }

        .finding-text {
            font-size: 0.9375rem;
            color: var(--text-primary);
            line-height: 1.6;
        }

        /* Report Meta Header */
        .report-meta {
            grid-column: 1 / -1;
            background: rgba(10,10,10,0.6);
            padding: 2rem;
            border-radius: 16px;
            border: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(10px);
            box-shadow: 
                0 0 30px rgba(255,255,255,0.03),
                inset 0 0 20px rgba(255,255,255,0.02);
        }

        .meta-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        .meta-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            border: 1px solid var(--border-hover);
            border-radius: 100px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text-primary);
            background: var(--bg-card);
            cursor: pointer;
            transition: all 0.3s;
        }

        .status-pill:hover { 
            background: var(--bg-card-hover);
            box-shadow: 0 0 15px rgba(255,255,255,0.1);
        }

        /* Follow Up Section */
        .follow-up-container {
            display: none;
            margin-top: 2rem; 
            margin-bottom: 2rem;
            text-align: center;
            max-width: 100%;
            margin-left: auto;
            margin-right: auto;
            animation: fadeIn 0.5s ease-out;
        }

        .follow-up-container .search-wrapper {
            max-width: 100%;
        }

        .follow-up-response {
            margin-top: 1.5rem;
            padding: 1.75rem;
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px;
            font-size: 0.9375rem;
            line-height: 1.8;
            color: var(--text-secondary);
            display: none;
            text-align: left;
            box-shadow: 
                0 0 30px rgba(255,255,255,0.03),
                inset 0 0 20px rgba(255,255,255,0.02);
            backdrop-filter: blur(10px);
        }
        
        .follow-up-response strong { 
            color: var(--text-primary); 
            font-weight: 600; 
        }
        .follow-up-response p { margin-bottom: 1rem; }

        /* Alternatives Section */
        .alternatives-container {
            display: none;
            max-width: 680px;
            margin: 2rem auto 0 auto;
            text-align: center;
            animation: fadeIn 1s ease-out;
        }

        .alt-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.1em;
            margin-bottom: 1rem;
            font-weight: 600;
        }

        .alt-grid {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.75rem;
        }

        .alt-chip {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            padding: 0.625rem 1.25rem;
            border-radius: 100px;
            font-size: 0.8125rem;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            backdrop-filter: blur(10px);
        }

        .alt-chip:hover {
            background: var(--bg-card-hover);
            border-color: var(--border-hover);
            color: var(--text-primary);
            transform: translateY(-2px);
            box-shadow: 0 0 20px rgba(255,255,255,0.08);
        }

        .alt-icon {
            width: 14px;
            height: 14px;
            opacity: 0.5;
        }

        /* Footer */
        footer {
            margin-top: auto;
            padding: 2rem 0;
            border-top: 1px solid var(--border-primary);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        footer a {
            color: var(--text-secondary);
            text-decoration: none;
            transition: color 0.2s;
        }

        footer a:hover {
            color: var(--text-primary);
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.9);
            backdrop-filter: blur(12px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .modal-overlay.open { display: flex; opacity: 1; }
        
        .modal {
            background: #0a0a0a;
            border: 1px solid var(--border-primary);
            border-radius: 20px;
            padding: 0;
            width: 100%;
            max-width: 520px; 
            box-shadow: 
                0 40px 80px -12px rgba(0, 0, 0, 0.95),
                0 0 40px rgba(255,255,255,0.03),
                inset 0 0 30px rgba(255,255,255,0.02);
            transform: scale(0.95);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            overflow: hidden;
        }
        .modal-overlay.open .modal { transform: scale(1); }
        
        .modal-header {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 2rem 2.5rem 1.5rem;
            border-bottom: 1px solid var(--border-primary); 
            background: transparent;
        }
        
        .modal-title { 
            font-size: 1.25rem; 
            font-weight: 700; 
            color: var(--text-primary); 
            letter-spacing: -0.02em; 
        }
        
        .btn-close { 
            background: transparent; 
            border: none; 
            color: var(--text-muted); 
            cursor: pointer; 
            padding: 0.5rem; 
            transition: all 0.2s; 
            display: flex; 
            border-radius: 50%;
        }
        .btn-close:hover { 
            color: var(--text-primary); 
            background: rgba(255,255,255,0.05); 
        }
        
        .modal-body { 
            padding: 2.5rem; 
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }
        
        .status-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid var(--border-primary);
            border-radius: 14px;
            padding: 1.25rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .status-icon-wrapper {
            width: 40px; 
            height: 40px;
            border-radius: 50%;
            background: rgba(0,0,0,0.3);
            border: 1px solid var(--border-primary);
            display: flex; 
            align-items: center; 
            justify-content: center;
        }

        .status-details { 
            display: flex; 
            flex-direction: column; 
            gap: 0.25rem; 
        }
        
        .status-label-text { 
            font-size: 0.75rem; 
            text-transform: uppercase; 
            letter-spacing: 0.05em; 
            color: var(--text-muted); 
            font-weight: 600; 
        }
        
        .status-value-text { 
            font-size: 0.9375rem; 
            color: var(--text-primary); 
            font-weight: 500; 
        }

        .form-group { 
            display: flex; 
            flex-direction: column; 
            gap: 0.75rem; 
        }
        
        .form-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: baseline; 
        }
        
        .form-label { 
            font-size: 1rem; 
            color: var(--text-primary); 
            font-weight: 600; 
            letter-spacing: -0.01em;
        }

        .form-hint { 
            font-size: 0.8125rem; 
            color: var(--text-muted); 
            line-height: 1.5;
        }
        .form-hint a { 
            color: var(--text-secondary); 
            text-decoration: underline; 
            text-underline-offset: 3px; 
            transition: color 0.2s; 
        }
        .form-hint a:hover { color: var(--text-primary); }
        
        .form-input {
            width: 100%; 
            background: rgba(0,0,0,0.4); 
            border: 1px solid var(--border-primary); 
            border-radius: 12px; 
            padding: 1.25rem; 
            color: var(--text-primary); 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            font-size: 1rem; 
            transition: all 0.3s;
        }
        .form-input:focus { 
            outline: none; 
            border-color: var(--border-hover); 
            box-shadow: 0 0 0 4px rgba(255,255,255,0.05); 
        }
        
        .modal-actions { 
            display: flex; 
            flex-direction: column; 
            gap: 1rem; 
            margin-top: 0.5rem; 
        }
        
        .btn-save { 
            width: 100%; 
            padding: 1.125rem; 
            background: var(--text-primary); 
            color: #000; 
            border: none; 
            border-radius: 12px; 
            font-weight: 700; 
            font-size: 1rem; 
            cursor: pointer; 
            transition: all 0.3s; 
            letter-spacing: -0.01em; 
        }
        .btn-save:hover { 
            background: #fff; 
            transform: translateY(-2px); 
            box-shadow: 0 4px 20px rgba(255,255,255,0.2); 
        }
        
        .btn-reset {
            background: transparent; 
            border: none; 
            color: var(--text-muted); 
            font-size: 0.875rem; 
            cursor: pointer; 
            padding: 0.5rem; 
            transition: color 0.2s; 
            width: fit-content; 
            margin: 0 auto;
        }
        .btn-reset:hover { color: var(--accent-red); }
        
        /* Pong Game Styles */
        .pong-container { 
            width: 100%; 
            height: 200px; 
            background: #000; 
            position: relative; 
            overflow: hidden; 
            border-radius: 12px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
        }
        canvas { display: block; cursor: none; }
        .pong-overlay { 
            position: absolute; 
            top: 50%; 
            left: 50%; 
            transform: translate(-50%, -50%); 
            text-align: center; 
            pointer-events: none; 
            text-transform: uppercase; 
            font-size: 0.75rem; 
            letter-spacing: 0.1em; 
            color: #666; 
            animation: pulse 2s infinite; 
        }
        @keyframes pulse { 
            0% { opacity: 0.5; } 
            50% { opacity: 1; } 
            100% { opacity: 0.5; } 
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
            
            header {
                margin-bottom: 2rem;
            }
            
            .report-grid {
                grid-template-columns: 1fr;
            }
            
            .report-card.wide-card {
                grid-column: 1;
            }
            
            .meta-title {
                font-size: 1.25rem;
            }
            
            .report-meta {
                flex-direction: column;
                gap: 1rem;
                text-align: center;
            }
        }
    </style>
</head>
<body>

    <!-- Noise Texture Overlay -->
    <svg class="noise-overlay" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <filter id="noise">
            <feTurbulence type="fractalNoise" baseFrequency="0.9" numOctaves="4" stitchTiles="stitch"/>
        </filter>
        <rect width="100%" height="100%" filter="url(#noise)" opacity="1"/>
    </svg>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">System Configuration</div>
                <button class="btn-close" onclick="toggleSettings()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
                </button>
            </div>
            
            <div class="modal-body">
                <div class="status-card">
                    <div class="status-icon-wrapper">
                        <span class="status-dot active" id="modalStatusDot"></span>
                    </div>
                    <div class="status-details">
                        <div class="status-label-text">Connection Status</div>
                        <div class="status-value-text" id="keyStatusTextLabel">Using: System Default Key</div>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-header">
                        <label class="form-label">Gemini API Key</label>
                    </div>
                    <div class="form-hint">
                        Required for deep dive investigations. <a href="https://aistudio.google.com/app/apikey" target="_blank">Get a free key here &rarr;</a>
                    </div>
                    <input type="password" class="form-input" id="apiKeyInput" placeholder="Paste your AIzaSy... key here">
                </div>
                
                <div class="modal-actions">
                    <button class="btn-save" onclick="saveApiKey()">Save Configuration</button>
                    <button class="btn-reset" onclick="clearApiKey()">Reset to Default System Key</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo-group">
                <a href="index.html" class="logo">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="white" opacity="0.1"/>
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" stroke="white" stroke-width="1.5" fill="none"/>
                        <path d="M9 12l2 2 4-4" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="logo-text">
                        TRUST<span class="bureau">BUREAU</span>
                        <span class="deepscrub">DeepScrub</span>
                    </span>
                </a>
            </div>

            <div class="header-actions">
                <button class="btn-api" onclick="toggleSettings()" title="Configure API">
                    <span class="status-dot active" id="systemStatusDot"></span>
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="4" y1="21" x2="4" y2="14"></line><line x1="4" y1="10" x2="4" y2="3"></line><line x1="12" y1="21" x2="12" y2="12"></line><line x1="12" y1="8" x2="12" y2="3"></line><line x1="20" y1="21" x2="20" y2="16"></line><line x1="20" y1="12" x2="20" y2="3"></line><line x1="1" y1="14" x2="7" y2="14"></line><line x1="9" y1="8" x2="15" y2="8"></line><line x1="17" y1="16" x2="23" y2="16"></line></svg>
                    API
                </button>
            </div>
        </header>

        <div class="search-wrapper" id="initialSearchWrapper">
            <div class="input-group">
                <input type="text" class="unibox" id="searchInput" placeholder="Enter Business Name and State..." autocomplete="off">
                <button class="btn-action" id="btnScrub" onclick="runScrub()" aria-label="Run Investigation">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                </button>
            </div>
        </div>

        <div class="alternatives-container" id="alternativesContainer">
            <div class="alt-label">Possible Alternative Matches</div>
            <div class="alt-grid" id="alternativesGrid"></div>
        </div>

        <div class="follow-up-container" id="followUpContainer">
            <div class="search-wrapper">
                <div class="input-group">
                    <input type="text" class="unibox" id="followUpInput" placeholder="Ask follow-up questions about this entity..." autocomplete="off">
                    <button class="btn-action" id="btnFollowUp" onclick="askFollowUp()">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>
                    </button>
                </div>
            </div>
            <div class="follow-up-response" id="followUpResponse"></div>
        </div>

        <div class="report-container-wrapper">
            <canvas id="loadingCanvas"></canvas>
            <div id="reportContainer" class="report-grid">
                <div class="report-meta">
                    <div>
                        <div class="meta-title" id="reportName">Acme Logistics LLC</div>
                        <div class="meta-subtitle">Report Generated: <span id="timestamp"></span></div>
                    </div>
                    <div class="status-pill">Confidence: High</div>
                </div>

                <div class="report-card full-width">
                    <div class="card-header">
                        <div class="header-title-group">
                            <svg class="card-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>
                            <span class="card-title">Key Findings</span>
                        </div>
                    </div>
                    <div class="card-content" id="summaryContent">Pending...</div>
                </div>

                <div class="report-card">
                    <div class="card-header">
                        <div class="header-title-group">
                            <svg class="card-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-2a4 4 0 0 1 4-4v0a4 4 0 0 1 4 4v2"/></svg>
                            <span class="card-title">Corporate Registry</span>
                        </div>
                        <button class="btn-deep" onclick="runDeepDive('sos')">DEEP</button>
                    </div>
                    <div class="card-content" id="sosContent">Pending...</div>
                </div>

                <div class="report-card">
                    <div class="card-header">
                        <div class="header-title-group">
                            <svg class="card-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2l-9.5 17h19L12 2zm0 3.3L18.4 19H5.6L12 5.3z"/><path d="M12 16a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-7v5"/></svg>
                            <span class="card-title">Litigation & Filings</span>
                        </div>
                        <button class="btn-deep" onclick="runDeepDive('legal')">DEEP</button>
                    </div>
                    <div class="card-content" id="legalContent">Pending...</div>
                </div>

                <div class="report-card">
                    <div class="card-header">
                        <div class="header-title-group">
                            <svg class="card-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7z"></path><circle cx="12" cy="9" r="2.5"></circle></svg>
                            <span class="card-title">Location Intelligence</span>
                        </div>
                    </div>
                    <div class="card-content" id="locationContent">Pending...</div>
                </div>

                 <div class="report-card">
                    <div class="card-header">
                        <div class="header-title-group">
                            <svg class="card-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon><line x1="8" y1="2" x2="8" y2="18"></line><line x1="16" y1="6" x2="16" y2="22"></line></svg>
                            <span class="card-title">Digital Footprint</span>
                        </div>
                        <button class="btn-deep" onclick="runDeepDive('footprint')">DEEP</button>
                    </div>
                    <div class="card-content" id="footprintContent">Pending...</div>
                </div>

                <div class="report-card wide-card">
                    <div class="card-header">
                        <div class="header-title-group">
                            <svg class="card-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                            <span class="card-title">Reviews & Reputation</span>
                        </div>
                        <button class="btn-deep" onclick="runDeepDive('reviews')">DEEP</button>
                    </div>
                    <div class="card-content" id="reviewsContent">Pending...</div>
                </div>
            </div>
        </div>

        <footer>
            Â© 2025 <a href="index.html">TrustBureau.ai</a>. AI-generated report. Not a formal background check.
        </footer>
    </div>

    <script>
        const apiKey = ""; 
        let userApiKey = localStorage.getItem('trustbureau_api_key') || "";
        let currentSearchQuery = "";
        let gameActive = false;
        let animationFrameId;
        let blurInterval;
        let simulationTimeouts = [];
        let gridAnimationId;

        function updateKeyStatus() {
            const statusText = document.getElementById('keyStatusTextLabel');
            const dot = document.getElementById('systemStatusDot');
            const modalDot = document.getElementById('modalStatusDot');
            
            if (userApiKey) {
                if(statusText) { statusText.innerText = "Using: Custom User API Key"; statusText.style.color = "#22c55e"; }
                if(dot) dot.className = "status-dot active";
                if(modalDot) modalDot.className = "status-dot active";
            } else if (apiKey) {
                if(statusText) { statusText.innerText = "Using: Environment Test Key"; statusText.style.color = "#a3a3a3"; }
                if(dot) dot.className = "status-dot active";
                if(modalDot) modalDot.className = "status-dot active";
            } else {
                if(statusText) { statusText.innerText = "No API Key Available"; statusText.style.color = "#ef4444"; }
                if(dot) dot.className = "status-dot inactive";
                if(modalDot) modalDot.className = "status-dot inactive";
            }
        }
        updateKeyStatus();

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('open');
            if(modal.classList.contains('open') && userApiKey) {
                document.getElementById('apiKeyInput').value = userApiKey;
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if (input) {
                userApiKey = input;
                localStorage.setItem('trustbureau_api_key', input);
                alert("API Key saved.");
                toggleSettings();
                updateKeyStatus();
            } else {
                alert("Please enter a valid key.");
            }
        }

        function clearApiKey() {
            if(confirm("Clear custom API key?")) {
                userApiKey = "";
                localStorage.removeItem('trustbureau_api_key');
                document.getElementById('apiKeyInput').value = "";
                updateKeyStatus();
            }
        }
        
        function clearSimulation() {
            simulationTimeouts.forEach(id => clearTimeout(id));
            simulationTimeouts = [];
            if(blurInterval) clearInterval(blurInterval);
            if(gridAnimationId) cancelAnimationFrame(gridAnimationId);
        }

        function getEffectiveApiKey() { return userApiKey || apiKey; }

        function startActiveGrid(canvasId) {
            const canvas = document.getElementById(canvasId);
            if(!canvas) return;
            const ctx = canvas.getContext('2d');
            const parent = canvas.parentElement;
            
            canvas.width = parent.offsetWidth;
            canvas.height = parent.offsetHeight;
            canvas.classList.add('active');

            const dots = [];
            const spacing = 40;
            const cols = Math.ceil(canvas.width / spacing);
            const rows = Math.ceil(canvas.height / spacing);

            for(let i=0; i<cols; i++){
                for(let j=0; j<rows; j++){
                    dots.push({ x: i * spacing + spacing/2, y: j * spacing + spacing/2, opacity: 0.1, targetOpacity: 0.1, pulseSpeed: Math.random() * 0.05 + 0.01 });
                }
            }

            let scanY = 0;
            
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                scanY += 8;
                if(scanY > canvas.height + 100) scanY = -100;
                dots.forEach(dot => {
                    const dist = Math.abs(dot.y - scanY);
                    if(dist < 50) { dot.opacity = Math.max(dot.opacity, 1 - (dist/50)); }
                    if(dot.opacity > 0.15) dot.opacity -= 0.05;
                    ctx.fillStyle = `rgba(255, 255, 255, ${dot.opacity})`;
                    ctx.beginPath();
                    ctx.arc(dot.x, dot.y, 1.5, 0, Math.PI * 2);
                    ctx.fill();
                });
                gridAnimationId = requestAnimationFrame(animate);
            }
            animate();
            return () => { canvas.classList.remove('active'); setTimeout(() => cancelAnimationFrame(gridAnimationId), 500); };
        }

        function startPong(container) {
            container.innerHTML = `<div class="pong-container"><canvas id="pongCanvas"></canvas><div class="pong-overlay">DEEP SCANNING...</div></div>`;
            const canvas = document.getElementById('pongCanvas');
            const ctx = canvas.getContext('2d');
            canvas.width = container.offsetWidth;
            canvas.height = 200;
            let playerY = 75, aiY = 75, ballX = canvas.width/2, ballY = 100, ballSX = 4, ballSY = 4;
            const paddleH = 50, paddleW = 8;
            canvas.addEventListener('mousemove', e => { const r = canvas.getBoundingClientRect(); playerY = e.clientY - r.top - paddleH/2; });
            gameActive = true;
            function draw() {
                if(!gameActive) return;
                ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,canvas.width,canvas.height);
                ctx.fillStyle = '#fff';
                ctx.fillRect(10, playerY, paddleW, paddleH);
                ctx.fillRect(canvas.width-10-paddleW, aiY, paddleW, paddleH);
                ctx.beginPath(); ctx.arc(ballX, ballY, 5, 0, Math.PI*2); ctx.fill();
                ballX += ballSX; ballY += ballSY;
                if(ballY<0 || ballY>200) ballSY = -ballSY;
                if(ballX < 20) { if(ballY > playerY && ballY < playerY+paddleH) ballSX = -ballSX; else { ballX=canvas.width/2; ballY=100; } }
                if(ballX > canvas.width-20) { if(ballY > aiY && ballY < aiY+paddleH) ballSX = -ballSX; else { ballX=canvas.width/2; ballY=100; } }
                if(aiY + paddleH/2 < ballY - 20) aiY += 3; else if(aiY + paddleH/2 > ballY + 20) aiY -= 3;
                requestAnimationFrame(draw);
            }
            draw();
            return () => { gameActive = false; };
        }

        function cleanJson(text) {
            const startObject = text.indexOf('{');
            const startArray = text.indexOf('[');
            let startIndex = -1, endIndex = -1;
            if (startObject !== -1 && (startArray === -1 || startObject < startArray)) { startIndex = startObject; endIndex = text.lastIndexOf('}'); }
            else if (startArray !== -1) { startIndex = startArray; endIndex = text.lastIndexOf(']'); }
            if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) { return text.substring(startIndex, endIndex + 1); }
            return text.replace(/```json\n|\n```|```/g, "").trim();
        }

        const iconMap = {
            'status': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 12h-4l-3 9L9 3l-3 9H2"/></svg>',
            'formationDate': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>',
            'entityType': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-2a4 4 0 0 1 4-4v0a4 4 0 0 1 4 4v2"/></svg>',
            'registeredAgent': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>',
            'principals': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>',
            'riskLevel': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>',
            'bankruptcies': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="12" y1="18" x2="12" y2="12"></line><line x1="9" y1="15" x2="15" y2="15"></line></svg>',
            'liens': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.5 12H16c-.7 2-2 3-4 3s-3.3-1-4-3H2.5"/><path d="M5.5 5.1L2 12v6c0 1.1.9 2 2 2h16a2 2 0 0 0 2-2v-6l-3.4-6.9A2 2 0 0 0 16.8 4H7.2a2 2 0 0 0-1.8 1.1z"/></svg>',
            'judgments': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12.01" y2="16"></line></svg>',
            'uccFilings': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
            'website': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>',
            'domainAge': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>',
            'addressType': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',
            'socialPresence': '<svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>'
        };
        
        function renderDataGrid(dataObj, type) {
            if (!dataObj) return '<div class="data-value">No data available</div>';
            let html = '<div class="data-list">';
            const config = {
                'sos': [ { key: 'status', label: 'Status', color: true }, { key: 'formationDate', label: 'Formed' }, { key: 'entityType', label: 'Type' }, { key: 'registeredAgent', label: 'Agent' }, { key: 'principals', label: 'Principals' } ],
                'legal': [ { key: 'riskLevel', label: 'Risk Level', color: true }, { key: 'bankruptcies', label: 'Bankruptcies', isArray: true }, { key: 'liens', label: 'Liens', isArray: true }, { key: 'judgments', label: 'Judgments', isArray: true }, { key: 'uccFilings', label: 'UCC Filings', isArray: true } ],
                'footprint': [ { key: 'website', label: 'Website' }, { key: 'domainAge', label: 'Domain' }, { key: 'addressType', label: 'Addr Type' }, { key: 'socialPresence', label: 'Socials' } ]
            };
            const fields = config[type] || [];
            fields.forEach(field => {
                if (dataObj[field.key] !== undefined) {
                     let val = dataObj[field.key];
                     let style = '';
                     let checkIcon = '<svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg>';
                     if (field.key === 'website' && val && val.includes('.')) { let href = val.startsWith('http') ? val : 'https://' + val; val = `<a href="${href}" target="_blank" style="color:inherit; text-decoration:underline;">${val}</a>`; }
                     if (field.isArray) { if (!Array.isArray(val) || val.length === 0 || (val.length === 1 && (val[0].toLowerCase().includes('none') || val[0].toLowerCase().includes('clean')))) { val = 'None found'; style = 'color: var(--accent-green)'; } else { if (val.length === 1 && val[0].toLowerCase().includes('none')) { val = 'None found'; style = 'color: var(--accent-green)'; } else { style = 'color: var(--accent-red)'; val = val.join('<br>'); } } }
                     else if (field.color) { const v = String(val).toLowerCase(); if (v.includes('active') || v.includes('low') || v.includes('clean')) style = 'color: var(--accent-green)'; else if (v.includes('inactive') || v.includes('medium') || v.includes('mod')) style = 'color: var(--accent-yellow)'; else if (v.includes('dissolved') || v.includes('high') || v.includes('found')) style = 'color: var(--accent-red)'; if (field.key === 'riskLevel' && (v.includes('low') || v.includes('clean'))) style = 'color: var(--accent-green)'; }
                     html += `<div class="data-row"><div class="data-label-group">${checkIcon}${iconMap[field.key] || ''}<div class="data-label">${field.label}</div></div><div class="data-value" style="${style}">${val}</div></div>`;
                }
            });
            html += '</div>';
            if (dataObj.sourceUrl) { html += `<a href="${dataObj.sourceUrl}" target="_blank" class="source-link">Source Reference &rarr;</a>`; }
            return html;
        }

        function renderLocation(data) {
            if (!data || !data.address) return '<div class="data-value">No location data found</div>';
            let html = `<div class="data-list"><div class="data-row"><div class="data-label-group"><svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg><svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path><circle cx="12" cy="10" r="3"></circle></svg><div class="data-label">Address</div></div><div class="data-value">${data.address}</div></div><div class="data-row"><div class="data-label-group"><svg class="check-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"></polyline></svg><svg class="data-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg><div class="data-label">Type</div></div><div class="data-value">${data.locationType || 'Unknown'}</div></div></div>`;
            let safeAddr = data.address.replace(/#\w+/g, '').replace(/(Unit|Suite|Ste|Floor|Fl)\s?\S+/gi, '');
            const encodedAddr = encodeURIComponent(safeAddr);
            const mapUrl = `https://maps.google.com/maps?q=${encodedAddr}&t=&z=13&ie=UTF8&iwloc=&output=embed`;
            html += `<div class="map-container"><iframe class="map-iframe" src="${mapUrl}"></iframe></div><div class="map-actions"><a href="https://www.google.com/maps/search/?api=1&query=${encodedAddr}&layer=c" target="_blank" class="btn-map-action"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v8M8 12h8"></path></svg>Launch Street View</a><a href="https://www.google.com/maps/search/?api=1&query=${encodedAddr}" target="_blank" class="btn-map-action"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>Open Maps</a></div>`;
            return html;
        }

        function renderListGroup(items, type) {
            if (!items || items.length === 0) return '<div class="data-value">No data available</div>';
            let html = '<div class="data-list">';
            items.forEach(item => {
                let sentimentColor = '#888';
                if(item.sentiment && (item.sentiment.toLowerCase().includes('pos') || item.sentiment.toLowerCase().includes('accred'))) sentimentColor = '#22c55e';
                else if(item.sentiment && item.sentiment.toLowerCase().includes('neg')) sentimentColor = '#ef4444';
                html += `<div class="review-item"><div class="review-header"><span>${item.source || item.platform}</span><span style="opacity:0.7">${item.date || ''}</span></div><div class="review-text">"${item.text || 'No text'}"</div><div class="review-rating" style="color:${sentimentColor}">â ${item.rating}</div></div>`;
            });
            html += '</div>';
            return html;
        }

        function renderFindings(findings) {
            if (!findings || findings.length === 0) return '<div class="data-value">No findings generated</div>';
            let html = '<div class="data-list">';
            findings.forEach(f => { html += `<div class="finding-item"><div class="finding-dot"></div><div class="finding-text">${f}</div></div>`; });
            html += '</div>';
            return html;
        }

        function renderAlternatives(alts) {
            const container = document.getElementById('alternativesContainer');
            const grid = document.getElementById('alternativesGrid');
            if (!alts || alts.length === 0) { container.style.display = 'none'; return; }
            let html = '';
            alts.forEach(alt => {
                const displayText = alt.location ? `${alt.name} (${alt.location})` : alt.name;
                const safeName = displayText.replace(/'/g, "\\'");
                html += `<div class="alt-chip" onclick="triggerNewSearch('${safeName}')"><svg class="alt-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>${displayText}</div>`;
            });
            grid.innerHTML = html;
            container.style.display = 'block';
        }

        function triggerNewSearch(name) { 
            document.getElementById('searchInput').value = name; 
            // Re-show initial search for transition effect if needed
            document.getElementById('initialSearchWrapper').style.display = 'block';
            runScrub(); 
            window.scrollTo({ top: 0, behavior: 'smooth' }); 
        }

        async function runScrub() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) { alert('Enter a business name.'); return; }
            currentSearchQuery = query;
            const key = getEffectiveApiKey();
            if (!key) { toggleSettings(); return; }
            const btn = document.getElementById('btnScrub');
            const report = document.getElementById('reportContainer');
            const altsContainer = document.getElementById('alternativesContainer');
            const stopGridAnim = startActiveGrid('loadingCanvas');
            btn.disabled = true;
            btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;
            report.style.display = 'grid';
            report.classList.remove('resolved');
            report.classList.add('scanning');
            document.getElementById('followUpContainer').style.display = 'none'; 
            altsContainer.style.display = 'none';
            const followUpResponse = document.getElementById('followUpResponse');
            if (followUpResponse) followUpResponse.style.display = 'none'; 
            const fillPlaceholders = (id) => { const el = document.getElementById(id); if (el) { el.innerHTML = `<div style="font-family:monospace; color:#444; word-break:break-all;">${Math.random().toString(36).substring(2, 15) + Math.random().toString(36).substring(2, 15)}...</div>`; } };
            ['sosContent', 'legalContent', 'footprintContent', 'locationContent', 'reviewsContent', 'summaryContent'].forEach(fillPlaceholders);
            let currentBlur = 20;
            clearSimulation();
            blurInterval = setInterval(() => { if (currentBlur > 5) { currentBlur -= 0.5; const grid = document.getElementById('reportContainer'); if (grid.classList.contains('scanning')) { grid.style.filter = `blur(${currentBlur}px)`; ['sosContent', 'legalContent', 'footprintContent', 'locationContent', 'reviewsContent', 'summaryContent'].forEach(fillPlaceholders); } } }, 500);
            const prompt = `Investigate "${query}". Return ONLY JSON.\n\nREQUIREMENTS:\n1. Standard DeepScrub analysis.\n2. Identify 2-3 alternative businesses if the search is ambiguous or return related entities (e.g. parent co, similar names).\n\nJSON: { "entityName": "Name", "sosData": { "status": "Active", "formationDate": "Date", "entityType": "Type", "registeredAgent": "Name", "principals": "Names", "sourceUrl": "URL" }, "legalData": { "riskLevel": "Low", "bankruptcies": [], "liens": [], "judgments": [], "uccFilings": [], "sourceUrl": "URL" }, "footprintData": { "website": "URL", "domainAge": "Age", "addressType": "Type", "socialPresence": "High" }, "locationData": { "address": "Address", "locationType": "Type", "sourceUrl": "URL" }, "reviewsData": [ { "source": "Google", "rating": "4.5", "text": "text", "date": "date", "sentiment": "pos" } ], "summaryData": { "keyFindings": ["Finding 1", "Finding 2"] }, "alternatives": [ { "name": "Alt Business Name", "location": "State/City" } ] }`;
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] }) });
                const json = await res.json();
                const data = JSON.parse(cleanJson(json.candidates[0].content.parts[0].text));
                clearInterval(blurInterval);
                if(stopGridAnim) stopGridAnim();
                const grid = document.getElementById('reportContainer');
                grid.style.filter = 'blur(0px)';
                grid.classList.remove('scanning');
                grid.classList.add('resolved');
                document.getElementById('reportName').innerText = data.entityName;
                document.getElementById('timestamp').innerText = new Date().toLocaleDateString();
                document.getElementById('sosContent').innerHTML = renderDataGrid(data.sosData, 'sos');
                document.getElementById('legalContent').innerHTML = renderDataGrid(data.legalData, 'legal');
                document.getElementById('footprintContent').innerHTML = renderDataGrid(data.footprintData, 'footprint');
                document.getElementById('locationContent').innerHTML = renderLocation(data.locationData);
                document.getElementById('reviewsContent').innerHTML = renderListGroup(data.reviewsData, 'reviews');
                document.getElementById('summaryContent').innerHTML = renderFindings(data.summaryData?.keyFindings);
                renderAlternatives(data.alternatives);
                
                // Hide initial search and show follow-up
                document.getElementById('initialSearchWrapper').style.display = 'none';
                document.getElementById('followUpContainer').style.display = 'block'; 
                
                // Auto-focus to show blinking cursor
                setTimeout(() => document.getElementById('followUpInput').focus(), 100);
            } catch(e) {
                clearInterval(blurInterval);
                if(stopGridAnim) stopGridAnim();
                document.getElementById('reportContainer').style.filter = 'blur(0px)';
                document.getElementById('reportContainer').classList.remove('scanning');
                document.getElementById('reportContainer').style.opacity = '1';
                console.error(e);
                alert("Search failed.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>`;
            }
        }
        
        async function runDeepDive(section) {
            const targetDiv = document.getElementById(section + 'Content');
            const original = targetDiv.innerHTML;
            const stop = startPong(targetDiv);
            const prompt = `Deep dive for "${currentSearchQuery}" on section: ${section}. Return ONLY JSON matching the specific structure for this section previously defined. Be extremely detailed.`;
            try {
                const key = getEffectiveApiKey();
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] }) });
                const json = await res.json();
                stop();
                const data = JSON.parse(cleanJson(json.candidates[0].content.parts[0].text));
                if(section === 'reviews') targetDiv.innerHTML = renderListGroup(data, 'reviews');
                else targetDiv.innerHTML = renderDataGrid(data, section);
            } catch(e) { stop(); console.error(e); targetDiv.innerHTML = original; alert("Deep dive failed."); }
        }

        async function askFollowUp() {
            const q = document.getElementById('followUpInput').value.trim();
            if(!q) return;
            const box = document.getElementById('followUpResponse');
            const btn = document.getElementById('btnFollowUp');
            const oldBtn = btn.innerHTML;
            btn.disabled = true; 
            btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><circle cx="12" cy="12" r="10"></circle><path d="M12 6v6l4 2"></path></svg>`;
            box.style.display = 'none';
            const prompt = `Answer question about "${currentSearchQuery}": "${q}". Keep it concise.`;
             try {
                const key = getEffectiveApiKey();
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] }) });
                const json = await res.json();
                box.innerHTML = marked.parse(json.candidates[0].content.parts[0].text);
                box.style.display = 'block';
            } catch(e) { alert("Error getting answer."); }
            finally { btn.disabled = false; btn.innerHTML = oldBtn; }
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => { if(e.key==='Enter') runScrub(); });
        document.getElementById('followUpInput').addEventListener('keypress', (e) => { if(e.key==='Enter') askFollowUp(); });
    </script>
</body>
</html>
