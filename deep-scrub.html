<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TrustBureau DeepScrub | AI Due Diligence</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-body: #000000;
            --bg-card: #0a0a0a;
            --bg-card-hover: #111111;
            --bg-modal: #111111;
            --border-primary: #1a1a1a;
            --border-hover: #2a2a2a;
            --text-primary: #f5f5f5;
            --text-secondary: #a3a3a3;
            --text-muted: #666666;
            --accent: #888888;
            --accent-green: #22c55e;
            --accent-yellow: #eab308;
            --accent-red: #ef4444;
            --accent-glow: rgba(136, 136, 136, 0.1);
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-body);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            -webkit-font-smoothing: antialiased;
        }

        /* Subtle background pattern */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: radial-gradient(circle at 1px 1px, var(--border-primary) 1px, transparent 0);
            background-size: 40px 40px;
            opacity: 0.3;
            pointer-events: none;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 0 2rem;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Header - Bold Editorial */
        header {
            padding: 1.5rem 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            margin-bottom: 6rem; 
        }

        .logo-group {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.875rem;
            text-decoration: none;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .logo:hover {
            transform: translateX(4px);
        }

        .logo-icon {
            width: 28px;
            height: 28px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }

        .logo:hover .logo-icon {
            opacity: 1;
        }

        .logo-text {
            font-size: 0.875rem;
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-text span {
            color: #555;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .btn-api {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.875rem;
            background: transparent;
            border: 1px solid var(--border-primary);
            border-radius: 6px; /* Squared */
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-api:hover {
            border-color: var(--text-secondary);
            color: var(--text-primary);
            background: rgba(255,255,255,0.02);
        }

        .status-dot {
            width: 6px;
            height: 6px;
            background: #fff;
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(255,255,255,0.5);
            display: inline-block;
        }
        
        .status-dot.active { background: #22c55e; box-shadow: 0 0 8px rgba(34, 197, 94, 0.4); }
        .status-dot.inactive { background: #ef4444; box-shadow: 0 0 8px rgba(239, 68, 68, 0.4); }

        /* Search Input Area - Squared */
        .search-wrapper {
            max-width: 680px;
            margin: 0 auto;
            position: relative;
            width: 100%;
        }

        .input-group {
            background: var(--bg-card);
            border: 1px solid var(--border-primary);
            border-radius: 16px; /* Soft Rounded */
            padding: 0.35rem 0.35rem 0.35rem 1.5rem;
            display: flex;
            flex-direction: row;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .input-group:focus-within {
            border-color: var(--text-secondary);
            box-shadow: 0 4px 30px rgba(255,255,255,0.05);
            transform: scale(1.01);
        }

        .unibox {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1.125rem;
            padding: 0.5rem 0;
            outline: none;
            width: 100%;
            flex: 1;
        }

        .unibox::placeholder {
            color: #444;
        }

        .btn-action {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            border-radius: 12px; /* Soft Rounded */
            background: var(--text-primary);
            color: #000;
            border: none;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.16, 1, 0.3, 1);
            flex-shrink: 0;
            padding: 0;
        }

        .btn-action:hover {
            transform: scale(1.05);
            background: #fff;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.3);
        }

        .btn-action:disabled {
            opacity: 0.8;
            cursor: wait;
            background: #333;
            color: #666;
            transform: none;
            box-shadow: none;
        }

        @keyframes spin { 
            100% { transform: rotate(360deg); } 
        }

        /* Terminal / Logs */
        .system-log {
            margin: 2rem auto;
            max-width: 600px;
            background: transparent;
            padding: 1rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: none;
            height: auto;
            min-height: 40px;
            text-align: center;
        }

        .log-entry {
            margin-bottom: 0.5rem;
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            animation: fadeIn 0.5s forwards;
            align-items: center;
            justify-content: center;
        }

        .log-time { display: none; }
        .log-msg-info { color: var(--text-secondary); }
        .log-msg-success { color: #fff; font-weight: 500; }
        .log-msg-warn { color: #ef4444; }

        @keyframes fadeIn { to { opacity: 1; } }

        /* Report Layout */
        .report-grid {
            display: none;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 1px;
            background: var(--border-primary);
            border: 1px solid var(--border-primary);
            border-radius: 16px; /* Soft Rounded */
            overflow: hidden;
            margin-bottom: 4rem;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
            margin-top: 4rem;
        }

        .report-card {
            background: var(--bg-card);
            padding: 2rem;
            position: relative;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
        }

        .report-card:hover {
            background: var(--bg-card-hover);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .header-title-group {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .card-icon {
            color: var(--text-muted);
        }

        .card-title {
            font-size: 0.75rem;
            font-weight: 700;
            letter-spacing: 0.15em;
            text-transform: uppercase;
            color: var(--text-muted);
        }

        .btn-deep {
            background: transparent;
            border: 1px solid var(--border-hover);
            color: var(--text-muted);
            font-size: 0.65rem;
            padding: 0.25rem 0.5rem;
            border-radius: 8px; /* Soft Rounded */
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.05em;
            transition: all 0.2s;
        }

        .btn-deep:hover {
            color: var(--text-primary);
            border-color: var(--text-secondary);
            background: rgba(255,255,255,0.05);
        }

        .btn-deep:disabled {
            opacity: 0.5;
            cursor: wait;
        }

        .card-content {
            font-size: 0.9375rem;
            line-height: 1.6;
            color: var(--text-secondary);
            flex: 1;
        }

        /* Unified Data Rows */
        .data-list {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .data-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .data-row:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .data-label {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            min-width: 90px;
            padding-top: 0.1rem;
        }

        .data-value {
            font-size: 0.9375rem;
            color: var(--text-primary);
            text-align: right;
            font-weight: 500;
            word-break: break-word;
            max-width: 75%;
        }

        /* Review Specific Styles */
        .review-item {
            padding: 1rem;
            background: rgba(255,255,255,0.02);
            border-radius: 12px; /* Soft Rounded */
            border: 1px solid var(--border-primary);
            margin-bottom: 0.75rem;
        }
        
        .review-item:last-child { margin-bottom: 0; }

        .review-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .review-text {
            font-style: italic;
            color: var(--text-secondary);
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .review-rating {
            color: var(--text-primary);
            font-weight: 600;
        }

        /* Findings (Summary) */
        .finding-item {
            display: flex;
            gap: 0.75rem;
            align-items: flex-start;
            padding: 0.5rem 0;
        }

        .finding-dot {
            width: 6px;
            height: 6px;
            background: var(--text-primary);
            border-radius: 50%;
            margin-top: 0.5rem;
            flex-shrink: 0;
            box-shadow: 0 0 8px rgba(255,255,255,0.3);
        }

        .finding-text {
            font-size: 0.9375rem;
            color: var(--text-primary);
            line-height: 1.5;
        }

        .source-link {
            display: inline-flex;
            align-items: center;
            gap: 0.375rem;
            margin-top: 1.5rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            text-decoration: none;
            transition: all 0.2s;
            align-self: flex-start;
        }

        .source-link:hover {
            color: var(--text-primary);
        }

        /* Map Embed Styles */
        .map-container {
            border-radius: 12px; /* Soft Rounded */
            overflow: hidden;
            border: 1px solid var(--border-primary);
            background: var(--bg-card-hover);
            margin-top: 0.5rem;
        }
        
        .map-iframe {
            width: 100%;
            height: 250px;
            border: 0;
            display: block;
            filter: grayscale(100%) invert(90%);
            pointer-events: none; /* Make static */
        }

        .map-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .btn-map-action {
            flex: 1;
            padding: 0.625rem;
            background: rgba(255,255,255,0.05);
            border: 1px solid var(--border-primary);
            border-radius: 8px; /* Soft Rounded */
            color: var(--text-secondary);
            font-size: 0.75rem;
            text-align: center;
            text-decoration: none;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-map-action:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
            border-color: var(--text-secondary);
        }

        /* Pong Game Styles */
        .pong-container {
            width: 100%;
            height: 200px;
            background: #000;
            position: relative;
            overflow: hidden;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        canvas {
            display: block;
            cursor: none; /* Hide default cursor over game */
        }

        .pong-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            pointer-events: none;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 0.1em;
            color: #666;
            animation: pulse 2s infinite;
        }

        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        /* Summary Header */
        .report-meta {
            grid-column: 1 / -1;
            background: #080808;
            padding: 2rem;
            border-bottom: 1px solid var(--border-primary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .meta-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .meta-subtitle {
            font-size: 0.875rem;
            color: var(--text-muted);
        }

        .status-pill {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-hover);
            border-radius: 12px; /* Soft Rounded */
            font-size: 0.75rem;
            color: var(--text-primary);
            background: rgba(255,255,255,0.02);
            cursor: pointer;
            transition: background 0.2s;
        }

        .status-pill:hover { background: rgba(255,255,255,0.05); }

        /* Footer */
        footer {
            margin-top: auto;
            padding: 2rem 0;
            border-top: 1px solid var(--border-primary);
            text-align: center;
            color: var(--text-muted);
            font-size: 0.8125rem;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Settings Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            backdrop-filter: blur(5px);
            z-index: 100;
            display: none;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modal-overlay.open {
            display: flex;
            opacity: 1;
        }

        .modal {
            background: var(--bg-modal);
            border: 1px solid var(--border-primary);
            border-radius: 16px; /* Soft Rounded */
            padding: 2rem;
            width: 100%;
            max-width: 480px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay.open .modal { transform: scale(1); }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .modal-title {
            font-size: 1.125rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .btn-close {
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
        }

        .form-label {
            display: block;
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .form-input {
            width: 100%;
            background: #000;
            border: 1px solid var(--border-primary);
            border-radius: 12px; /* Soft Rounded */
            padding: 0.75rem;
            color: var(--text-primary);
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 0.875rem;
            margin-bottom: 1.5rem;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--text-secondary);
        }

        .btn-save {
            width: 100%;
            padding: 0.75rem;
            background: var(--text-primary);
            color: #000;
            border: none;
            border-radius: 12px; /* Soft Rounded */
            font-weight: 600;
            cursor: pointer;
        }

        .key-status {
            font-size: 0.75rem;
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 8px; /* Soft Rounded */
            background: rgba(255,255,255,0.05);
            color: var(--text-secondary);
        }

    </style>
</head>
<body>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">API Configuration</div>
                <button class="btn-close" onclick="toggleSettings()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            
            <div class="key-status" id="keyStatusText">
                Using: System Default Key
            </div>

            <label class="form-label">Custom Gemini API Key</label>
            <input type="password" class="form-input" id="apiKeyInput" placeholder="AIzaSy...">
            
            <button class="btn-save" onclick="saveApiKey()">Save Configuration</button>
            <div style="text-align: center; margin-top: 1rem;">
                <a href="#" onclick="clearApiKey(); return false;" style="color: var(--text-muted); font-size: 0.75rem; text-decoration: none;">Clear Custom Key & Reset</a>
            </div>
        </div>
    </div>

    <div class="container">
        <header>
            <div class="logo-group">
                <a href="#" class="logo">
                    <svg class="logo-icon" viewBox="0 0 24 24" fill="none">
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor" opacity="0.1"/>
                        <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" stroke="#888888" stroke-width="1.5" fill="none"/>
                        <path d="M9 12l2 2 4-4" stroke="#888888" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    <span class="logo-text">Trust<span>Bureau</span> DeepScrub</span>
                </a>
            </div>

            <div class="header-actions">
                <button class="btn-api" onclick="toggleSettings()" title="Configure API">
                    <span class="status-dot active" id="systemStatusDot"></span>
                    API
                </button>
            </div>
        </header>

        <div class="search-wrapper">
            <div class="input-group">
                <input type="text" class="unibox" id="searchInput" placeholder="Enter Business Name and State..." autocomplete="off">
                <button class="btn-action" id="btnScrub" onclick="runScrub()" aria-label="Run Investigation">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M5 12h14M12 5l7 7-7 7"/>
                    </svg>
                </button>
            </div>
        </div>

        <div class="system-log" id="terminal">
            <!-- Logs appear here -->
        </div>

        <div id="reportContainer" class="report-grid">
            <div class="report-meta">
                <div>
                    <div class="meta-title" id="reportName">Acme Logistics LLC</div>
                    <div class="meta-subtitle">Report Generated: <span id="timestamp"></span></div>
                </div>
                <div class="status-pill">
                    Confidence: High
                </div>
            </div>

            <!-- Card 1: SOS -->
            <div class="report-card">
                <div class="card-header">
                    <div class="header-title-group">
                        <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 21h18M5 21V7l8-4 8 4v14M8 21v-2a4 4 0 0 1 4-4v0a4 4 0 0 1 4 4v2"/>
                        </svg>
                        <span class="card-title">Corporate Registry</span>
                    </div>
                    <button class="btn-deep" onclick="runDeepDive('sos')">DEEP</button>
                </div>
                <div class="card-content" id="sosContent">Pending...</div>
            </div>

            <!-- Card 2: Legal -->
            <div class="report-card">
                <div class="card-header">
                    <div class="header-title-group">
                        <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2l-9.5 17h19L12 2zm0 3.3L18.4 19H5.6L12 5.3z"/>
                            <path d="M12 16a1 1 0 1 0 0-2 1 1 0 0 0 0 2zm0-7v5"/>
                        </svg>
                        <span class="card-title">Litigation & Filings</span>
                    </div>
                    <button class="btn-deep" onclick="runDeepDive('legal')">DEEP</button>
                </div>
                <div class="card-content" id="legalContent">Pending...</div>
            </div>

            <!-- Card 3: Footprint -->
            <div class="report-card">
                <div class="card-header">
                    <div class="header-title-group">
                        <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="1 6 1 22 8 18 16 22 23 18 23 2 16 6 8 2 1 6"></polygon>
                            <line x1="8" y1="2" x2="8" y2="18"></line>
                            <line x1="16" y1="6" x2="16" y2="22"></line>
                        </svg>
                        <span class="card-title">Operational Footprint</span>
                    </div>
                    <button class="btn-deep" onclick="runDeepDive('footprint')">DEEP</button>
                </div>
                <div class="card-content" id="footprintContent">Pending...</div>
            </div>

            <!-- Card 7: Location -->
            <div class="report-card">
                <div class="card-header">
                    <div class="header-title-group">
                        <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M12 2a7 7 0 0 0-7 7c0 5.25 7 13 7 13s7-7.75 7-13a7 7 0 0 0-7-7z"></path>
                            <circle cx="12" cy="9" r="2.5"></circle>
                        </svg>
                        <span class="card-title">Location Intelligence</span>
                    </div>
                </div>
                <div class="card-content" id="locationContent">Pending...</div>
            </div>

            <!-- Card 4: Reviews -->
            <div class="report-card">
                <div class="card-header">
                    <div class="header-title-group">
                        <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                        </svg>
                        <span class="card-title">Reviews & Reputation</span>
                    </div>
                    <button class="btn-deep" onclick="runDeepDive('reviews')">DEEP</button>
                </div>
                <div class="card-content" id="reviewsContent">Pending...</div>
            </div>

            <!-- Card 6: Summary -->
            <div class="report-card">
                <div class="card-header">
                    <div class="header-title-group">
                        <svg class="card-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                            <polyline points="22 4 12 14.01 9 11.01"></polyline>
                        </svg>
                        <span class="card-title">Key Findings</span>
                    </div>
                </div>
                <div class="card-content" id="summaryContent">Pending...</div>
            </div>
        </div>

        <footer>
            © 2025 TrustBureau.ai. AI-generated report. Not a formal background check.
        </footer>
    </div>

    <script>
        const apiKey = ""; // Managed by environment
        let userApiKey = localStorage.getItem('trustbureau_api_key') || "";
        let currentSearchQuery = "";
        let gameActive = false;
        let animationFrameId;

        function updateKeyStatus() {
            const statusText = document.getElementById('keyStatusText');
            const dot = document.getElementById('systemStatusDot');
            
            if (userApiKey) {
                statusText.innerText = "Using: Custom User API Key";
                statusText.style.color = "#22c55e";
                dot.className = "status-dot active";
            } else if (apiKey) {
                statusText.innerText = "Using: Environment Test Key";
                statusText.style.color = "#a3a3a3";
                dot.className = "status-dot active";
            } else {
                statusText.innerText = "No API Key Available";
                statusText.style.color = "#ef4444";
                dot.className = "status-dot inactive";
            }
        }
        updateKeyStatus();

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            modal.classList.toggle('open');
            if(modal.classList.contains('open') && userApiKey) {
                document.getElementById('apiKeyInput').value = userApiKey;
            }
        }

        function saveApiKey() {
            const input = document.getElementById('apiKeyInput').value.trim();
            if (input) {
                userApiKey = input;
                localStorage.setItem('trustbureau_api_key', input);
                alert("API Key saved.");
                toggleSettings();
                updateKeyStatus();
            } else {
                alert("Please enter a valid key.");
            }
        }

        function clearApiKey() {
            if(confirm("Clear custom API key?")) {
                userApiKey = "";
                localStorage.removeItem('trustbureau_api_key');
                document.getElementById('apiKeyInput').value = "";
                updateKeyStatus();
            }
        }

        function getEffectiveApiKey() { return userApiKey || apiKey; }

        // --- PONG GAME ---
        function startPong(container) {
            container.innerHTML = `
                <div class="pong-container">
                    <canvas id="pongCanvas"></canvas>
                    <div class="pong-overlay">DEEP SCANNING...</div>
                </div>
            `;
            
            const canvas = document.getElementById('pongCanvas');
            const ctx = canvas.getContext('2d');
            
            // Set scale
            const width = container.offsetWidth;
            const height = 200;
            canvas.width = width;
            canvas.height = height;

            // Game State
            const paddleHeight = 50;
            const paddleWidth = 8;
            let playerY = (height - paddleHeight) / 2;
            let aiY = (height - paddleHeight) / 2;
            let ballX = width / 2;
            let ballY = height / 2;
            let ballSpeedX = 4;
            let ballSpeedY = 4;

            // Mouse Control
            canvas.addEventListener('mousemove', (e) => {
                const rect = canvas.getBoundingClientRect();
                const root = document.documentElement;
                const mouseY = e.clientY - rect.top - root.scrollTop;
                playerY = mouseY - (paddleHeight / 2);
            });

            gameActive = true;

            function draw() {
                if(!gameActive) return;

                // Clear
                ctx.fillStyle = '#0a0a0a';
                ctx.fillRect(0, 0, width, height);

                // Net
                ctx.strokeStyle = '#222';
                ctx.beginPath();
                ctx.setLineDash([5, 15]);
                ctx.moveTo(width/2, 0);
                ctx.lineTo(width/2, height);
                ctx.stroke();

                // Ball Movement
                ballX += ballSpeedX;
                ballY += ballSpeedY;

                // AI Movement (Simple tracking)
                const aiCenter = aiY + (paddleHeight/2);
                if (aiCenter < ballY - 35) {
                    aiY += 3;
                } else if (aiCenter > ballY + 35) {
                    aiY -= 3;
                }

                // Collisions
                if (ballY < 0 || ballY > height) ballSpeedY = -ballSpeedY;

                // Paddle Collision
                // Left (Player)
                if (ballX < paddleWidth + 10) {
                    if (ballY > playerY && ballY < playerY + paddleHeight) {
                        ballSpeedX = -ballSpeedX;
                        // Add some spin/speed variation
                        const deltaY = ballY - (playerY + paddleHeight/2);
                        ballSpeedY = deltaY * 0.35;
                    } else if (ballX < 0) {
                        // Reset
                        ballX = width/2;
                        ballY = height/2;
                        ballSpeedX = 4;
                    }
                }
                
                // Right (AI)
                if (ballX > width - paddleWidth - 10) {
                    if (ballY > aiY && ballY < aiY + paddleHeight) {
                        ballSpeedX = -ballSpeedX;
                        const deltaY = ballY - (aiY + paddleHeight/2);
                        ballSpeedY = deltaY * 0.35;
                    } else if (ballX > width) {
                        // Reset
                        ballX = width/2;
                        ballY = height/2;
                        ballSpeedX = -4;
                    }
                }

                // Draw Elements
                ctx.fillStyle = '#fff';
                // Player Paddle
                ctx.fillRect(10, playerY, paddleWidth, paddleHeight);
                // AI Paddle
                ctx.fillRect(width - 10 - paddleWidth, aiY, paddleWidth, paddleHeight);
                // Ball
                ctx.beginPath();
                ctx.arc(ballX, ballY, 5, 0, Math.PI*2, true);
                ctx.fill();

                animationFrameId = requestAnimationFrame(draw);
            }

            draw();

            return () => {
                gameActive = false;
                cancelAnimationFrame(animationFrameId);
            };
        }

        // --- PARSING ---
        function cleanJson(text) {
            const startObject = text.indexOf('{');
            const startArray = text.indexOf('[');
            
            let startIndex = -1;
            let endIndex = -1;

            if (startObject !== -1 && (startArray === -1 || startObject < startArray)) {
                startIndex = startObject;
                endIndex = text.lastIndexOf('}');
            } else if (startArray !== -1) {
                startIndex = startArray;
                endIndex = text.lastIndexOf(']');
            }

            if (startIndex !== -1 && endIndex !== -1 && endIndex > startIndex) {
                return text.substring(startIndex, endIndex + 1);
            }
            return text.replace(/```json\n|\n```|```/g, "").trim();
        }

        // --- RENDERING ---
        
        function renderDataGrid(dataObj, type) {
            if (!dataObj) return '<div class="data-value">No data available</div>';
            
            let html = '<div class="data-list">';
            
            const config = {
                'sos': [
                    { key: 'status', label: 'Status', color: true },
                    { key: 'formationDate', label: 'Formed' },
                    { key: 'entityType', label: 'Type' },
                    { key: 'registeredAgent', label: 'Agent' },
                    { key: 'principals', label: 'Owners' }
                ],
                'legal': [
                    { key: 'riskLevel', label: 'Risk Level', color: true },
                    { key: 'bankruptcies', label: 'Bankruptcies', isArray: true },
                    { key: 'liens', label: 'Liens', isArray: true },
                    { key: 'judgments', label: 'Judgments', isArray: true },
                    { key: 'uccFilings', label: 'UCC', isArray: true }
                ],
                'footprint': [
                    { key: 'website', label: 'Website' },
                    { key: 'domainAge', label: 'Domain' },
                    { key: 'addressType', label: 'Addr Type' },
                    { key: 'socialPresence', label: 'Socials' }
                ]
            };

            const fields = config[type] || [];

            fields.forEach(field => {
                if (dataObj[field.key] !== undefined) {
                     let val = dataObj[field.key];
                     let style = '';
                     
                     // Clickable website logic
                     if (field.key === 'website' && val && val !== 'None' && val !== 'Unknown' && val.includes('.')) {
                         let href = val.startsWith('http') ? val : 'https://' + val;
                         val = `<a href="${href}" target="_blank" style="color:inherit; text-decoration:underline;">${val}</a>`;
                     }

                     // Array Handling
                     if (field.isArray) {
                         if (!Array.isArray(val) || val.length === 0 || (val.length === 1 && (val[0].toLowerCase().includes('none') || val[0].toLowerCase().includes('clean')))) {
                             val = 'None found';
                             style = 'color: var(--accent-green)';
                         } else {
                             // Check again if it's a "None found" string inside array
                             if (val.length === 1 && val[0].toLowerCase().includes('none')) {
                                 val = 'None found';
                                 style = 'color: var(--accent-green)';
                             } else {
                                style = 'color: var(--accent-red)';
                                val = val.join('<br>');
                             }
                         }
                     } else {
                         // String Color Logic
                         if (field.color) {
                             const v = String(val).toLowerCase();
                             if (v.includes('active') || v.includes('low') || v.includes('clean')) style = 'color: var(--accent-green)'; 
                             else if (v.includes('inactive') || v.includes('medium') || v.includes('mod')) style = 'color: var(--accent-yellow)'; 
                             else if (v.includes('dissolved') || v.includes('high') || v.includes('found') || v.includes('bad')) style = 'color: var(--accent-red)'; 
                         }
                     }
                     
                     html += `<div class="data-row"><div class="data-label">${field.label}</div><div class="data-value" style="${style}">${val}</div></div>`;
                }
            });
            html += '</div>';

            if (dataObj.sourceUrl) {
                html += `<a href="${dataObj.sourceUrl}" target="_blank" class="source-link">Source Reference <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"></path><polyline points="15 3 21 3 21 9"></polyline><line x1="10" y1="14" x2="21" y2="3"></line></svg></a>`;
            }
            return html;
        }

        function renderLocation(data) {
            if (!data || !data.address) return '<div class="data-value">No location data found</div>';
            
            let html = `
            <div class="data-list">
                <div class="data-row">
                    <div class="data-label">Address</div>
                    <div class="data-value">${data.address}</div>
                </div>
                <div class="data-row">
                    <div class="data-label">Type</div>
                    <div class="data-value">${data.locationType || 'Unknown'}</div>
                </div>
            </div>`;

            // Embed Map - Corrected Syntax & Static Interaction
            const encodedAddr = encodeURIComponent(data.address);
            html += `
            <div class="map-container">
                <iframe class="map-iframe" src="[https://maps.google.com/maps?q=$](https://maps.google.com/maps?q=$){encodedAddr}&t=&z=13&ie=UTF8&iwloc=&output=embed" style="pointer-events:none;"></iframe>
            </div>
            <div class="map-actions">
                <a href="[https://www.google.com/maps/search/?api=1&query=$](https://www.google.com/maps/search/?api=1&query=$){encodedAddr}&layer=c" target="_blank" class="btn-map-action">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><path d="M12 8v8M8 12h8"></path></svg>
                    Launch Street View
                </a>
                <a href="[https://www.google.com/maps/search/?api=1&query=$](https://www.google.com/maps/search/?api=1&query=$){encodedAddr}" target="_blank" class="btn-map-action">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="3 11 22 2 13 21 11 13 3 11"></polygon></svg>
                    Open Maps
                </a>
            </div>
            `;
            return html;
        }

        function renderListGroup(items, type) {
            if (!items || items.length === 0) return '<div class="data-value">No data available</div>';
            let html = '<div class="list-group">';
            
            items.forEach(item => {
                if (type === 'reviews') {
                    let sentimentColor = '#888';
                    if(item.sentiment && (item.sentiment.toLowerCase().includes('pos') || item.sentiment.toLowerCase().includes('accred'))) sentimentColor = '#22c55e';
                    if(item.sentiment && item.sentiment.toLowerCase().includes('neg')) sentimentColor = '#ef4444';

                    html += `
                    <div class="review-item">
                        <div class="review-header">
                            <span>${item.source || item.platform}</span>
                            <span style="opacity:0.7">${item.date || ''}</span>
                        </div>
                        <div class="review-text">"${item.text || 'No text'}"</div>
                        <div class="review-rating" style="color:${sentimentColor}">★ ${item.rating}</div>
                    </div>`;
                }
            });
            html += '</div>';
            return html;
        }

        function renderFindings(findings) {
            if (!findings || findings.length === 0) return '<div class="data-value">No findings generated</div>';
            let html = '<div class="data-list">';
            findings.forEach(f => {
                html += `
                <div class="finding-item">
                    <div class="finding-dot"></div>
                    <div class="finding-text">${f}</div>
                </div>`;
            });
            html += '</div>';
            return html;
        }

        // --- MAIN LOGIC ---

        async function runScrub() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) { alert('Enter a business name.'); return; }
            
            currentSearchQuery = query;

            const key = getEffectiveApiKey();
            if (!key) { toggleSettings(); alert("API Key Required."); return; }

            const btn = document.getElementById('btnScrub');
            const terminal = document.getElementById('terminal');
            const report = document.getElementById('reportContainer');
            
            btn.disabled = true;
            btn.innerHTML = `<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation: spin 1s linear infinite;"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>`;
            
            terminal.style.display = 'block';
            report.style.display = 'none';
            terminal.innerHTML = '<div class="log-entry"><span class="log-msg-info">Initiating deep scan...</span></div>';

            const makeRequest = async (retry = 0) => {
                const prompt = `
                    You are a forensic business analyst. Investigate: "${query}".
                    Use Google Search tools to find real, current information.
                    
                    CRITICAL: Return ONLY a valid raw JSON object. No markdown. No prose.
                    
                    REQUIREMENTS:
                    1. NO WALLS OF TEXT. Return structured data only.
                    2. For "summaryData", return a list of specific, hard-hitting bullet points (findings).
                    3. For legal filings (bankruptcies, liens, etc.), return specific arrays of strings describing EACH finding (e.g., ["Case #12345 (2022)"]). Do not just say "Found". If none, return empty array.
                    4. Include "uccFilings" in legalData.
                    5. RIGOROUSLY SEARCH FOR UCC FILINGS, JUDGMENTS, AND LIENS. LIST EVERY SINGLE ONE FOUND. "Found" is not an acceptable answer.
                    6. Extract specific physical location address for map pin.

                    JSON STRUCTURE:
                    {
                        "entityName": "Official Verified Name",
                        "sosData": {
                            "status": "Active/Inactive/Dissolved",
                            "formationDate": "YYYY-MM-DD",
                            "entityType": "LLC/Corp",
                            "registeredAgent": "Name",
                            "principals": "Name1, Name2",
                            "sourceUrl": "URL"
                        },
                        "legalData": {
                            "riskLevel": "Low/Medium/High",
                            "bankruptcies": ["Specific Case 1", "Specific Case 2"],
                            "liens": ["Specific Lien 1"],
                            "judgments": ["Specific Judgment 1"],
                            "uccFilings": ["UCC-1 Filing #..."],
                            "sourceUrl": "URL"
                        },
                        "footprintData": {
                            "website": "URL",
                            "domainAge": "e.g. 10 Years",
                            "addressType": "Commercial/Residential",
                            "socialPresence": "High/Low",
                            "sourceUrl": "URL"
                        },
                        "locationData": {
                            "address": "Full physical address",
                            "locationType": "Office/Warehouse/Residential/Virtual",
                            "sourceUrl": "URL"
                        },
                        "reviewsData": [
                            { "source": "Google/Yelp", "rating": "4.5/5", "text": "Review text excerpt...", "date": "2023-..", "sentiment": "Positive/Negative" }
                        ],
                        "summaryData": {
                            "keyFindings": [
                                "Finding 1: e.g. Business was formed in 2023, relatively new.",
                                "Finding 2: e.g. No legal flags found.",
                                "Finding 3: e.g. Strong social proof."
                            ]
                        }
                    }
                `;

                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] })
                    });
                    
                    if (!res.ok) {
                        if(res.status === 429 && retry < 3) {
                            await new Promise(r => setTimeout(r, 2000));
                            return makeRequest(retry + 1);
                        }
                        throw new Error(res.status);
                    }
                    return res.json();
                } catch(e) { throw e; }
            };

            try {
                const result = await makeRequest();
                const text = cleanJson(result.candidates[0].content.parts[0].text);
                const data = JSON.parse(text);

                document.getElementById('reportName').innerText = data.entityName;
                document.getElementById('timestamp').innerText = new Date().toLocaleDateString();
                
                document.getElementById('sosContent').innerHTML = renderDataGrid(data.sosData, 'sos');
                document.getElementById('legalContent').innerHTML = renderDataGrid(data.legalData, 'legal');
                document.getElementById('footprintContent').innerHTML = renderDataGrid(data.footprintData, 'footprint');
                document.getElementById('locationContent').innerHTML = renderLocation(data.locationData);
                document.getElementById('reviewsContent').innerHTML = renderListGroup(data.reviewsData, 'reviews');
                document.getElementById('summaryContent').innerHTML = renderFindings(data.summaryData?.keyFindings);

                terminal.style.display = 'none';
                report.style.display = 'grid'; 
            } catch (e) {
                console.error(e);
                alert("Search failed. See console.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M5 12h14M12 5l7 7-7 7"/></svg>`;
            }
        }

        async function runDeepDive(section) {
            const targetDiv = document.getElementById(section + 'Content');
            const originalContent = targetDiv.innerHTML;
            const stopPong = startPong(targetDiv); // Start Pong Game

            let prompt = "";
            let jsonStructure = "";

            if (section === 'sos') {
                prompt = `Perform an aggressive deep dive into the corporate registry for "${currentSearchQuery}". Find exact filing dates, ALL past and present registered agents, and specific addresses of principals.`;
                jsonStructure = `{ "status": "...", "formationDate": "...", "entityType": "...", "registeredAgent": "Name & Address", "principals": "Name & Address (List all)", "sourceUrl": "..." }`;
            } else if (section === 'legal') {
                prompt = `Perform a forensic legal search for "${currentSearchQuery}". Look specifically for UCC-1 financing statements, federal tax liens, and civil litigation dockets. List exact case numbers and filing dates.`;
                jsonStructure = `{ "riskLevel": "...", "bankruptcies": ["Case..."], "liens": ["Lien..."], "judgments": ["Judgment..."], "uccFilings": ["UCC..."], "sourceUrl": "..." }`;
            } else if (section === 'footprint') {
                prompt = `Analyze the digital and physical footprint of "${currentSearchQuery}". Whois data, server location, and zoning verification of their primary address.`;
                jsonStructure = `{ "website": "...", "domainAge": "...", "addressType": "...", "socialPresence": "...", "sourceUrl": "..." }`;
            } else if (section === 'reviews') {
                prompt = `Find critical/negative reviews for "${currentSearchQuery}" to identify risk patterns. Quote them directly.`;
                jsonStructure = `[ { "source": "...", "rating": "...", "text": "...", "date": "...", "sentiment": "..." } ]`;
            }

            const fullPrompt = `
                ${prompt}
                CRITICAL: Return ONLY valid raw JSON matching this structure: ${jsonStructure}. No markdown.
            `;

            try {
                const result = await makeApiCall(fullPrompt);
                stopPong(); // Stop game
                
                const text = cleanJson(result.candidates[0].content.parts[0].text);
                const data = JSON.parse(text);

                // Re-render specifically based on section type
                if (section === 'reviews') {
                    targetDiv.innerHTML = renderListGroup(data, 'reviews');
                } else {
                    targetDiv.innerHTML = renderDataGrid(data, section);
                }

            } catch (e) {
                stopPong();
                console.error(e);
                alert("Deep dive failed. Reverting.");
                targetDiv.innerHTML = originalContent;
            }
        }

        async function makeApiCall(prompt) {
            const key = getEffectiveApiKey();
            return fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    tools: [{ google_search: {} }]
                })
            }).then(res => {
                if (!res.ok) throw new Error(res.status);
                return res.json();
            });
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => { if(e.key==='Enter') runScrub(); });
    </script>
</body>
</html>
