<!DOCTYPE html>
<html lang="en" class="theme-black accent-rainbow rainbow-mode">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Approval Toolbox | TrustBureau.ai</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z%22 fill=%22%2310b981%22/><path d=%22M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z%22 fill=%22white%22/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@500&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 
            sans: ['Plus Jakarta Sans', 'sans-serif'],
            mono: ['JetBrains Mono', 'monospace']
          },
          colors: {
            emerald: {
              450: '#34d399',
              550: '#10b981'
            },
            neutral: { 
              850: '#1a1a1a',
              925: '#0d0d0d'
            }
          }
        }
      }
    }
  </script>

  <style>
    /* ============================================
       DESIGN SYSTEM VARIABLES - LIGHT THEME (DEFAULT)
       ============================================ */
    :root,
    .theme-light {
      --bg-body: #f8fafc;
      --bg-body-gradient: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      --bg-card: #ffffff;
      --bg-card-inner: #f8fafc;
      --bg-input: #ffffff;
      --bg-toggle: #f1f5f9;
      --bg-option-card: #f8fafc;
      --bg-stat-hover: rgba(16, 185, 129, 0.08);
      --border-primary: #e2e8f0;
      --border-secondary: #f1f5f9;
      --text-primary: #0f172a;
      --text-secondary: #475569;
      --text-muted: #94a3b8;
      --slider-track: #e2e8f0;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.07), 0 2px 4px -2px rgb(0 0 0 / 0.07);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.08), 0 4px 6px -4px rgb(0 0 0 / 0.08);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.08), 0 8px 10px -6px rgb(0 0 0 / 0.08);
      --preview-header-bg: linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%);
      --preview-header-text: #ffffff;
      --pattern-color: rgba(0,0,0,0.02);
      --chart-bg: #e2e8f0;
      --modal-overlay: rgba(15, 23, 42, 0.6);
    }

    /* ============================================
       DARK THEME - Deep Navy
       ============================================ */
    .theme-dark {
      --bg-body: #0a0f1a;
      --bg-body-gradient: linear-gradient(135deg, #0a0f1a 0%, #111827 100%);
      --bg-card: #141c2e;
      --bg-card-inner: #0a0f1a;
      --bg-input: #1e293b;
      --bg-toggle: #1e293b;
      --bg-option-card: #0d1321;
      --bg-stat-hover: rgba(16, 185, 129, 0.15);
      --border-primary: #1e293b;
      --border-secondary: #141c2e;
      --text-primary: #f1f5f9;
      --text-secondary: #cbd5e1;
      --text-muted: #64748b;
      --slider-track: #1e293b;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.4);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.5), 0 2px 4px -2px rgb(0 0 0 / 0.4);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.6), 0 4px 6px -4px rgb(0 0 0 / 0.5);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.6), 0 8px 10px -6px rgb(0 0 0 / 0.5);
      --preview-header-bg: linear-gradient(135deg, #020617 0%, #0a0f1a 50%, #020617 100%);
      --preview-header-text: #f1f5f9;
      --pattern-color: rgba(255,255,255,0.02);
      --chart-bg: #1e293b;
      --modal-overlay: rgba(0, 0, 0, 0.85);
    }

    /* ============================================
       BLACK THEME (AMOLED)
       ============================================ */
    .theme-black {
      --bg-body: #000000;
      --bg-body-gradient: linear-gradient(135deg, #000000 0%, #050505 100%);
      --bg-card: #121212;
      --bg-card-inner: #0a0a0a;
      --bg-input: #1f1f1f;
      --bg-toggle: #1f1f1f;
      --bg-option-card: #0a0a0a;
      --bg-stat-hover: rgba(16, 185, 129, 0.2);
      --border-primary: #2a2a2a;
      --border-secondary: #1a1a1a;
      --text-primary: #f5f5f5;
      --text-secondary: #a3a3a3;
      --text-muted: #666666;
      --slider-track: #2a2a2a;
      --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.5);
      --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.6), 0 2px 4px -2px rgb(0 0 0 / 0.5);
      --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.7), 0 4px 6px -4px rgb(0 0 0 / 0.6);
      --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.7), 0 8px 10px -6px rgb(0 0 0 / 0.6);
      --preview-header-bg: linear-gradient(135deg, #000000 0%, #0a0a0a 50%, #000000 100%);
      --preview-header-text: #f5f5f5;
      --pattern-color: rgba(255,255,255,0.01);
      --chart-bg: #1f1f1f;
      --modal-overlay: rgba(0, 0, 0, 0.9);
    }

    /* ============================================
       ACCENT COLORS - MINT (DEFAULT)
       ============================================ */
    :root,
    .accent-mint {
      --accent: #10b981;
      --accent-light: #34d399;
      --accent-dark: #059669;
      --accent-glow: rgba(16, 185, 129, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 16, 185, 129;
    }

    /* BLUE ACCENT */
    .accent-blue {
      --accent: #3b82f6;
      --accent-light: #60a5fa;
      --accent-dark: #2563eb;
      --accent-glow: rgba(59, 130, 246, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 59, 130, 246;
    }

    /* PURPLE ACCENT */
    .accent-purple {
      --accent: #8b5cf6;
      --accent-light: #a78bfa;
      --accent-dark: #7c3aed;
      --accent-glow: rgba(139, 92, 246, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 139, 92, 246;
    }

    /* RAINBOW ACCENT - cycles via JavaScript */
    .accent-rainbow {
      --accent: #10b981;
      --accent-light: #34d399;
      --accent-dark: #059669;
      --accent-glow: rgba(16, 185, 129, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 16, 185, 129;
    }

    /* ORANGE ACCENT */
    .accent-orange {
      --accent: #f97316;
      --accent-light: #fb923c;
      --accent-dark: #ea580c;
      --accent-glow: rgba(249, 115, 22, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 249, 115, 22;
    }

    /* CYAN ACCENT */
    .accent-cyan {
      --accent: #06b6d4;
      --accent-light: #22d3ee;
      --accent-dark: #0891b2;
      --accent-glow: rgba(6, 182, 212, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 6, 182, 212;
    }

    /* GOLD ACCENT */
    .accent-gold {
      --accent: #eab308;
      --accent-light: #facc15;
      --accent-dark: #ca8a04;
      --accent-glow: rgba(234, 179, 8, 0.15);
      --accent-text: #0f172a;
      --accent-rgb: 234, 179, 8;
    }

    /* SLATE ACCENT (Monochrome) */
    .accent-slate {
      --accent: #525252;
      --accent-light: #737373;
      --accent-dark: #404040;
      --accent-glow: rgba(82, 82, 82, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 82, 82, 82;
    }

    /* FOREST ACCENT */
    .accent-lime {
      --accent: #166534;
      --accent-light: #22c55e;
      --accent-dark: #14532d;
      --accent-glow: rgba(22, 101, 52, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 22, 101, 52;
    }

    /* NAVY ACCENT */
    .accent-teal {
      --accent: #1e3a5f;
      --accent-light: #3b82f6;
      --accent-dark: #172554;
      --accent-glow: rgba(30, 58, 95, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 30, 58, 95;
    }

    /* BURGUNDY ACCENT */
    .accent-pink {
      --accent: #881337;
      --accent-light: #be185d;
      --accent-dark: #4c0519;
      --accent-glow: rgba(136, 19, 55, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 136, 19, 55;
    }

    /* STEEL ACCENT */
    .accent-indigo {
      --accent: #64748b;
      --accent-light: #94a3b8;
      --accent-dark: #475569;
      --accent-glow: rgba(100, 116, 139, 0.15);
      --accent-text: #ffffff;
      --accent-rgb: 100, 116, 139;
    }

    * {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    body { 
      font-family: 'Plus Jakarta Sans', sans-serif; 
      background: var(--bg-body-gradient);
      color: var(--text-primary); 
      min-height: 100vh;
      transition: background 0.3s ease, color 0.3s ease;
    }

    /* Subtle background pattern */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(circle at 1px 1px, var(--pattern-color) 1px, transparent 0);
      background-size: 24px 24px;
      pointer-events: none;
      z-index: -1;
    }

    /* ============================================
       FORM ELEMENTS
       ============================================ */
    input[type=number]::-webkit-inner-spin-button, 
    input[type=number]::-webkit-outer-spin-button { 
      -webkit-appearance: none; 
      margin: 0; 
    }

    .input-field {
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-input);
      color: var(--text-primary);
      border-color: var(--border-primary);
    }
    
    .input-field:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
      outline: none;
    }

    .input-field:hover:not(:focus) {
      border-color: var(--text-muted);
    }

    .input-field::placeholder {
      color: var(--text-muted);
    }

    /* ============================================
       BUTTONS
       ============================================ */
    .btn {
      position: relative;
      overflow: hidden;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .btn::after {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(to bottom, rgba(255,255,255,0.1), transparent);
      pointer-events: none;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: var(--accent-text);
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.3), var(--shadow-md);
      transition: all 0.2s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.5), var(--shadow-lg), 0 8px 20px -4px rgba(var(--accent-rgb), 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      color: var(--text-secondary);
      box-shadow: var(--shadow-sm);
      transition: all 0.2s ease;
    }

    .btn-secondary:hover {
      border-color: var(--accent);
      color: var(--accent);
      box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.2), var(--shadow-md);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-muted);
    }

    .btn-ghost:hover {
      color: var(--accent);
      background: var(--accent-glow);
    }

    /* ============================================
       CARDS
       ============================================ */
    .card {
      background: var(--bg-card);
      border-radius: 20px;
      border: 1px solid var(--border-secondary);
      box-shadow: var(--shadow-md);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .card:hover {
      box-shadow: var(--shadow-lg);
    }

    .card-section {
      border-left: 3px solid var(--accent);
    }

    /* ============================================
       TABS
       ============================================ */
    .calc-tab {
      position: relative;
      transition: all 0.2s;
      color: var(--text-muted);
    }

    .calc-tab:hover:not(.active) {
      color: var(--text-secondary);
    }

    .calc-tab.active {
      color: var(--accent);
      background: var(--bg-card);
      border-color: var(--border-primary);
      border-bottom-color: var(--bg-card);
    }

    .calc-tab.active::before {
      content: '';
      position: absolute;
      top: -1px;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--accent), var(--accent-light));
      border-radius: 3px 3px 0 0;
    }

    /* ============================================
       TOGGLES & SWITCHES
       ============================================ */
    .toggle-group {
      background: var(--bg-toggle);
      padding: 4px;
      border-radius: 12px;
      border: 1px solid var(--border-secondary);
    }

    .toggle-btn {
      color: var(--text-muted);
      font-weight: 600;
      transition: all 0.2s;
    }

    .toggle-btn:hover:not(.active) {
      color: var(--text-secondary);
    }

    .toggle-btn.active {
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: var(--accent-text);
      box-shadow: var(--shadow-md);
      border-radius: 8px;
    }

    /* Custom Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .switch-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: var(--slider-track);
      border-radius: 24px;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .switch-slider::before {
      content: '';
      position: absolute;
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background: white;
      border-radius: 50%;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }

    .switch input:checked + .switch-slider {
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
    }

    .switch input:checked + .switch-slider::before {
      transform: translateX(20px);
    }

    .switch input:focus + .switch-slider {
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    /* ============================================
       SLIDERS
       ============================================ */
    .slider {
      -webkit-appearance: none;
      appearance: none;
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
      outline: none;
      cursor: pointer;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      cursor: grab;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0,0,0,0.12);
      transition: all 0.15s ease, border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5), 0 4px 12px rgba(0,0,0,0.15);
    }

    .slider::-webkit-slider-thumb:active {
      cursor: grabbing;
      transform: scale(1.05);
    }

    .slider::-moz-range-thumb {
      height: 24px;
      width: 24px;
      border-radius: 50%;
      background: white;
      border: 3px solid var(--accent);
      cursor: grab;
      box-shadow: 0 0 12px rgba(var(--accent-rgb), 0.4), 0 2px 8px rgba(0,0,0,0.12);
      transition: all 0.15s ease, border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .slider::-moz-range-track {
      height: 8px;
      background: var(--slider-track);
      border-radius: 999px;
    }

    /* Dark variant for client slider */
    .slider-dark {
      background: rgba(255, 255, 255, 0.12);
      height: 10px;
    }

    .slider-dark::-webkit-slider-thumb {
      border: 0;
      background: linear-gradient(135deg, var(--accent-light), var(--accent));
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.5), 0 0 0 4px rgba(255,255,255,0.15), 0 4px 12px rgba(0,0,0,0.3);
      transition: all 0.15s ease, background 1.5s ease, box-shadow 1.5s ease;
    }

    .slider-dark::-webkit-slider-thumb:hover {
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.6), 0 0 0 6px rgba(255,255,255,0.2), 0 6px 16px rgba(0,0,0,0.35);
    }

    /* ============================================
       CHARTS
       ============================================ */
    .circular-chart {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 100%;
    }

    .circle-bg {
      fill: none;
      stroke: var(--chart-bg);
      stroke-width: 3;
    }

    .circle {
      fill: none;
      stroke-width: 3;
      stroke-linecap: round;
      stroke: url(#gradient);
      transition: stroke-dasharray 0.6s cubic-bezier(0.4, 0, 0.2, 1);
      filter: drop-shadow(0 2px 4px rgba(var(--accent-rgb), 0.3));
    }

    /* ============================================
       PREVIEW CARD
       ============================================ */
    .preview-card {
      background: var(--bg-card);
      border-radius: 28px;
      border: 4px solid var(--accent);
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.25),
        0 0 80px rgba(var(--accent-rgb), 0.1),
        0 25px 50px -12px rgba(0, 0, 0, 0.25);
      overflow: hidden;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-color 1.5s ease, box-shadow 1.5s ease;
    }

    .preview-card:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 0 60px rgba(var(--accent-rgb), 0.35),
        0 0 100px rgba(var(--accent-rgb), 0.15),
        0 30px 60px -12px rgba(0, 0, 0, 0.3);
    }

    .preview-header {
      background: var(--preview-header-bg);
      position: relative;
      overflow: hidden;
    }

    .preview-header::before {
      content: '';
      position: absolute;
      inset: 0;
      background: 
        radial-gradient(circle at 30% 20%, rgba(var(--accent-rgb), 0.08) 0%, transparent 50%),
        radial-gradient(circle at 70% 80%, rgba(var(--accent-rgb), 0.05) 0%, transparent 40%);
      pointer-events: none;
    }

    .preview-header::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    }

    .amount-display {
      font-size: clamp(2.5rem, 8vw, 3.5rem);
      font-weight: 800;
      letter-spacing: -0.03em;
      background: linear-gradient(180deg, #ffffff 0%, #e2e8f0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 2px 20px rgba(255,255,255,0.1);
    }

    /* Business Name Styling */
    .business-name-display {
      font-size: 1.125rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      color: #ffffff;
      text-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }

    /* Logo Styling */
    .preview-logo {
      max-height: 48px;
      max-width: 160px;
      object-fit: contain;
      filter: drop-shadow(0 2px 8px rgba(0,0,0,0.2));
    }

    .preview-logo-container {
      margin-bottom: 16px;
    }

    .company-name-display {
      font-size: 14px;
      font-weight: 600;
      color: var(--text-muted);
      letter-spacing: 0.05em;
      margin-bottom: 12px;
      text-transform: uppercase;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
    }

    .stat-cell {
      padding: 20px 16px;
      text-align: center;
      transition: all 0.2s;
      position: relative;
    }

    .stat-cell::after {
      content: '';
      position: absolute;
      inset: 8px;
      background: transparent;
      border-radius: 12px;
      transition: all 0.2s;
    }

    .stat-cell:hover::after {
      background: var(--bg-stat-hover);
    }

    .stat-label {
      display: block;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .stat-value {
      display: block;
      font-size: 14px;
      font-weight: 700;
      color: var(--text-primary);
      position: relative;
      z-index: 1;
    }

    /* ============================================
       THEME PICKER
       ============================================ */
    .theme-picker {
      position: relative;
    }

    .theme-picker-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      height: 36px;
      padding: 0 12px;
      background: transparent;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .theme-picker-btn:hover {
      background: var(--bg-card);
    }

    .theme-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      left: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 16px;
      box-shadow: var(--shadow-xl);
      z-index: 100;
      min-width: 300px;
      max-height: 80vh;
      overflow-y: auto;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .theme-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .theme-section-title {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .theme-mode-toggle {
      display: flex;
      gap: 8px;
      margin-bottom: 20px;
    }

    .theme-mode-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border-radius: 10px;
      border: 2px solid var(--border-primary);
      background: var(--bg-option-card);
      cursor: pointer;
      transition: all 0.2s;
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .theme-mode-btn:hover {
      border-color: var(--accent);
    }

    .theme-mode-btn.active {
      border-color: var(--accent);
      background: var(--accent-glow);
      color: var(--accent);
    }

    /* Mode Toggle Buttons */
    .mode-toggle-btn {
      transition: all 0.2s;
      border-radius: 20px;
    }
    .mode-toggle-btn:hover {
      background: var(--accent-glow);
    }
    .mode-toggle-btn.active {
      background: var(--accent);
      color: var(--accent-text) !important;
    }

    /* Tier Preset Buttons */
    .tier-preset-btn {
      cursor: pointer;
    }
    .tier-preset-btn:hover {
      border-color: var(--accent) !important;
      background: var(--bg-option-card) !important;
    }
    .tier-preset-btn.active {
      border-color: var(--accent) !important;
      background: var(--accent-glow) !important;
    }

    /* Preview Dropdown */
    .preview-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 8px;
      box-shadow: var(--shadow-xl);
      z-index: 100;
      min-width: 220px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .preview-dropdown.open {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }
    
    .preview-option {
      width: 100%;
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid transparent;
      background: transparent;
      cursor: pointer;
      transition: all 0.15s ease;
      text-align: left;
      color: var(--text-secondary);
    }
    
    .preview-option:hover {
      background: var(--bg-option-card);
      border-color: var(--accent);
      color: var(--text-primary);
      transform: translateX(4px);
    }
    
    .preview-option:hover .preview-option-title {
      color: var(--accent);
    }
    
    .preview-option:hover svg {
      color: var(--accent);
    }
    
    .preview-option svg {
      flex-shrink: 0;
      transition: color 0.15s ease;
    }
    
    .preview-option-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-primary);
      transition: color 0.15s ease;
    }
    
    .preview-option-desc {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }

    .color-swatches {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
    }

    .color-swatch {
      width: 100%;
      aspect-ratio: 1;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      border: 3px solid transparent;
      position: relative;
    }

    .color-swatch:hover {
      transform: scale(1.1);
    }

    .color-swatch.active {
      border-color: var(--text-primary);
    }

    .color-swatch.active::after {
      content: 'âœ“';
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
      color: white;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }

    .swatch-mint { background: linear-gradient(135deg, #10b981, #059669); }
    .swatch-blue { background: linear-gradient(135deg, #3b82f6, #2563eb); }
    .swatch-purple { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
    .swatch-rainbow { 
      background: linear-gradient(135deg, #10b981, #3b82f6, #8b5cf6, #f43f5e, #f97316, #eab308); 
      background-size: 300% 300%;
      animation: rainbowSwatch 6s ease infinite;
    }
    @keyframes rainbowSwatch {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    .swatch-orange { background: linear-gradient(135deg, #f97316, #ea580c); }
    .swatch-cyan { background: linear-gradient(135deg, #06b6d4, #0891b2); }
    .swatch-gold { background: linear-gradient(135deg, #eab308, #ca8a04); }
    .swatch-slate { background: linear-gradient(135deg, #525252, #404040); }
    .swatch-lime { background: linear-gradient(135deg, #166534, #14532d); }
    .swatch-teal { background: linear-gradient(135deg, #1e3a5f, #172554); }
    .swatch-pink { background: linear-gradient(135deg, #881337, #4c0519); }
    .swatch-indigo { background: linear-gradient(135deg, #64748b, #475569); }

    /* Logo Input in Theme Dropdown */
    .logo-input-container {
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border-secondary);
    }

    .logo-input {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid var(--border-primary);
      border-radius: 8px;
      font-size: 12px;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s;
    }

    .logo-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--accent-glow);
    }

    .logo-input::placeholder {
      color: var(--text-muted);
    }

    .logo-preview-small {
      margin-top: 10px;
      padding: 12px;
      background: var(--bg-option-card);
      border-radius: 8px;
      text-align: center;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .logo-preview-small img {
      max-height: 36px;
      max-width: 100%;
      object-fit: contain;
    }

    .logo-preview-placeholder {
      font-size: 11px;
      color: var(--text-muted);
    }

    .clear-logo-btn {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-muted);
      cursor: pointer;
      transition: color 0.2s;
    }

    .clear-logo-btn:hover {
      color: #ef4444;
    }

    /* Brand Section Locked State */
    .brand-section {
      position: relative;
      overflow: hidden;
    }

    .brand-section.locked .brand-content {
      filter: blur(1px);
      pointer-events: none;
      user-select: none;
      opacity: 0.7;
    }

    .brand-lock-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      gap: 6px;
    }

    .brand-section:not(.locked) .brand-lock-overlay {
      display: none;
    }

    .brand-lock-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 14px;
      background: var(--accent);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .brand-lock-btn:hover {
      filter: brightness(1.1);
      transform: scale(1.02);
    }

    .brand-lock-text {
      font-size: 10px;
      color: var(--text-muted);
    }

    /* Welcome/Login Screen */
    .welcome-screen {
      position: fixed;
      inset: 0;
      background: var(--modal-overlay);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 2000;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      padding: 20px;
      overflow-y: auto;
      opacity: 1;
      visibility: visible;
      transition: all 0.4s ease-out;
    }

    .welcome-screen.hidden {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }

    .hidden {
      display: none !important;
    }

    .welcome-card {
      background: var(--bg-card);
      border-radius: 24px;
      padding: 32px;
      width: 100%;
      max-width: 400px;
      margin: auto;
      border: 2px solid var(--accent);
      box-shadow: 0 0 40px rgba(var(--accent-rgb), 0.4), 0 0 80px rgba(var(--accent-rgb), 0.2), 0 25px 50px -12px rgba(0, 0, 0, 0.5);
      text-align: center;
      position: relative;
      overflow: visible;
    }
    
    .welcome-logo {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      color: var(--accent);
    }

    .welcome-logo svg {
      width: 100%;
      height: 100%;
    }

    .welcome-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .welcome-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
    }

    .welcome-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .welcome-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      background: var(--bg-input);
      color: var(--text-primary);
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .welcome-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    .welcome-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .welcome-btn-primary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px 20px;
      color: var(--accent-text);
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      border: none;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      letter-spacing: 0.02em;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), background 1.5s ease, box-shadow 1.5s ease;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(var(--accent-rgb), 0.4), 0 0 40px rgba(var(--accent-rgb), 0.2), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    
    .welcome-btn-primary::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(255,255,255,0.25) 0%, transparent 50%);
      opacity: 0;
      transition: opacity 0.3s;
    }

    .welcome-btn-primary:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 8px 30px rgba(var(--accent-rgb), 0.5), 0 0 60px rgba(var(--accent-rgb), 0.3), inset 0 1px 0 rgba(255,255,255,0.2);
    }
    
    .welcome-btn-primary:hover::before {
      opacity: 1;
    }
    
    .welcome-btn-primary:active {
      transform: translateY(-1px) scale(1.01);
    }
    
    .welcome-btn-primary svg {
      width: 18px;
      height: 18px;
    }
    
    .welcome-btn-primary .pro-badge {
      background: rgba(0,0,0,0.25);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 800;
      letter-spacing: 0.1em;
      border: 1px solid rgba(255,255,255,0.15);
    }

    .welcome-btn-secondary {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px 20px;
      background: var(--bg-card-inner);
      border: 1px solid var(--accent);
      border-radius: 14px;
      color: var(--accent);
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1), border-color 1.5s ease, color 1.5s ease, box-shadow 1.5s ease;
      position: relative;
      box-shadow: 0 0 20px rgba(var(--accent-rgb), 0.15);
    }

    .welcome-btn-secondary:hover {
      background: var(--accent-glow);
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(var(--accent-rgb), 0.25);
    }
    
    .welcome-btn-secondary:active {
      transform: translateY(0);
    }
    
    .welcome-btn-secondary .lite-badge {
      background: rgba(var(--accent-rgb), 0.15);
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--accent);
      border: 1px solid rgba(var(--accent-rgb), 0.3);
      transition: all 1.5s ease;
    }

    .welcome-error {
      font-size: 13px;
      color: #ef4444;
      text-align: center;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 10px;
      display: none;
      font-weight: 500;
    }

    .welcome-error.show {
      display: block;
    }

    .welcome-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .welcome-divider::before,
    .welcome-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-primary);
    }

    .welcome-features {
      margin-top: 24px;
      text-align: left;
    }

    .welcome-mode-toggle {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      margin-bottom: 20px;
    }
    
    .welcome-mode-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .welcome-mode-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .welcome-mode-btn:hover {
      color: var(--text-primary);
    }
    
    .welcome-mode-btn.active {
      color: var(--accent);
      background: rgba(255,255,255,0.1);
    }

    .welcome-features-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
    }

    .welcome-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 0;
    }

    .welcome-feature svg {
      width: 16px;
      height: 16px;
      color: var(--accent);
      flex-shrink: 0;
    }

    .welcome-feature.locked svg {
      color: var(--text-muted);
    }

    .welcome-feature.locked {
      color: var(--text-muted);
    }

    /* Login Modal (for later logins from brand section) */
    .login-modal-overlay {
      position: fixed;
      inset: 0;
      background: var(--modal-overlay);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      opacity: 0;
      visibility: hidden;
      transition: all 0.3s;
    }

    .login-modal-overlay.open {
      opacity: 1;
      visibility: visible;
    }

    .login-modal {
      width: 100%;
      max-width: 400px;
      transform: scale(0.9) translateY(20px);
      transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      border-radius: 24px;
      background: var(--bg-card);
      border: 2px solid var(--accent);
      box-shadow: 
        0 0 40px rgba(var(--accent-rgb), 0.4),
        0 0 80px rgba(var(--accent-rgb), 0.2),
        0 25px 50px -12px rgba(0, 0, 0, 0.5);
      overflow: visible;
    }
    
    .login-modal-overlay.open .login-modal {
      transform: scale(1) translateY(0);
    }

    .login-modal-content {
      padding: 32px;
      text-align: center;
      overflow: hidden;
      border-radius: 22px;
    }

    .login-modal-icon {
      width: 64px;
      height: 64px;
      margin: 0 auto 20px;
      color: var(--accent);
    }
    
    .login-modal-icon svg {
      width: 100%;
      height: 100%;
    }

    .login-modal-title {
      font-size: 24px;
      font-weight: 800;
      color: var(--text-primary);
      margin: 0 0 8px 0;
    }

    .login-modal-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
      margin: 0 0 24px 0;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .login-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      font-size: 14px;
      font-weight: 500;
      background: var(--bg-input);
      color: var(--text-primary);
      transition: all 0.2s;
      box-sizing: border-box;
    }

    .login-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    .login-input::placeholder {
      color: var(--text-muted);
      font-weight: 400;
    }

    .login-error {
      font-size: 13px;
      color: #ef4444;
      text-align: center;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      border-radius: 10px;
      display: none;
      font-weight: 500;
    }

    .login-error.show {
      display: block;
    }

    .login-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 16px;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-dark) 100%);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 4px;
    }

    .login-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(var(--accent-rgb), 0.3);
    }
    
    .login-btn svg {
      width: 18px;
      height: 18px;
    }

    .login-divider {
      display: flex;
      align-items: center;
      gap: 16px;
      margin: 20px 0;
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    .login-divider::before,
    .login-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--border-primary);
    }

    .login-free-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      padding: 14px 16px;
      background: transparent;
      border: 2px solid var(--border-primary);
      border-radius: 12px;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .login-free-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: var(--accent-glow);
    }

    .login-features {
      margin-top: 24px;
      text-align: left;
    }

    .login-features-title {
      font-size: 10px;
      font-weight: 700;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
    }

    .login-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 13px;
      color: var(--text-secondary);
      padding: 6px 0;
    }

    .login-feature svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    .login-feature-locked {
      color: var(--text-muted);
    }

    .login-feature-locked svg {
      color: var(--text-muted);
    }

    .login-close-btn {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      background: var(--bg-input);
      color: var(--text-secondary);
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      z-index: 10;
    }
    
    .login-close-btn:hover {
      background: var(--accent-glow);
      color: var(--accent);
    }

    /* User Badge in Header */
    .user-badge {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: var(--accent-glow);
      border: 1px solid var(--accent);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: var(--accent);
      box-shadow: 0 0 15px rgba(var(--accent-rgb), 0.3);
      transition: all 0.2s, border-color 1.5s ease, background 1.5s ease, color 1.5s ease, box-shadow 1.5s ease;
    }
    
    .user-badge:hover {
      background: var(--accent);
      color: var(--accent-text);
      border-color: var(--accent);
      box-shadow: 0 0 25px rgba(var(--accent-rgb), 0.5);
    }

    .user-badge svg {
      width: 14px;
      height: 14px;
    }

    .logout-btn {
      padding: 4px 8px;
      background: transparent;
      border: 1px solid var(--border-primary);
      border-radius: 6px;
      font-size: 10px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      border-color: #ef4444;
      color: #ef4444;
    }

    /* Lite Usage Badge */
    .lite-usage-badge {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(245, 158, 11, 0.1);
      border: 1px solid rgba(245, 158, 11, 0.3);
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      color: #f59e0b;
      transition: all 0.2s;
    }
    
    .lite-usage-badge .lite-count {
      font-weight: 800;
      font-size: 13px;
    }
    
    .lite-usage-badge .lite-label {
      font-weight: 500;
      opacity: 0.8;
    }
    
    .lite-usage-badge.low {
      background: rgba(239, 68, 68, 0.1);
      border-color: rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .lite-usage-badge.depleted {
      background: rgba(239, 68, 68, 0.15);
      border-color: rgba(239, 68, 68, 0.5);
      color: #ef4444;
      animation: pulse-warning 2s infinite;
    }
    
    @keyframes pulse-warning {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    /* ============================================
       ANIMATIONS
       ============================================ */
    @keyframes fadeIn {
      from { 
        opacity: 0; 
        transform: translateY(8px); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    .fade-enter {
      animation: fadeIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    @keyframes slideUp {
      from { 
        opacity: 0; 
        transform: translateY(100%); 
      }
      to { 
        opacity: 1; 
        transform: translateY(0); 
      }
    }

    @keyframes pulse-ring {
      0% { box-shadow: 0 0 0 0 var(--accent-glow); }
      70% { box-shadow: 0 0 0 10px transparent; }
      100% { box-shadow: 0 0 0 0 transparent; }
    }

    .pulse-ring {
      animation: pulse-ring 2s infinite;
    }

    /* Toast */
    .toast {
      transform: translateY(120%);
      transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .toast.show {
      transform: translateY(0);
    }

    /* ============================================
       SECTION LABELS
       ============================================ */
    .section-indicator {
      width: 4px;
      height: 24px;
      background: linear-gradient(180deg, var(--accent), var(--accent-light));
      border-radius: 4px;
    }

    .section-title {
      font-size: 11px;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      color: var(--text-secondary);
    }

    /* ============================================
       OPTION TOGGLE CARDS
       ============================================ */
    .option-card {
      background: var(--bg-option-card);
      border-radius: 14px;
      border: 1px solid var(--border-secondary);
      padding: 16px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .option-card:hover {
      border-color: rgba(var(--accent-rgb), 0.3);
    }

    .option-card.active {
      border-color: var(--accent);
      box-shadow: 0 0 0 4px var(--accent-glow);
    }

    /* ============================================
       MODALS
       ============================================ */
    .modal-overlay {
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      background: var(--modal-overlay);
    }

    .modal-content {
      animation: modalSlideIn 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: var(--bg-card);
      color: var(--text-primary);
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    /* ============================================
       TABLE STYLES
       ============================================ */
    .amort-table {
      font-family: 'Plus Jakarta Sans', sans-serif;
    }

    .amort-table th {
      position: sticky;
      top: 0;
      background: var(--bg-option-card);
      z-index: 10;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .amort-table tbody tr {
      transition: background 0.15s;
    }

    .amort-table tbody tr:hover {
      background: var(--bg-option-card);
    }

    .amort-table td {
      color: var(--text-secondary);
    }

    /* ============================================
       COLLAPSIBLE SECTIONS (All Screens)
       ============================================ */
    .mobile-collapsible .section-header {
      cursor: pointer;
      user-select: none;
    }
    
    .mobile-collapsible .section-header .collapse-icon {
      display: flex;
      transition: transform 0.3s ease;
    }
    
    .mobile-collapsible.collapsed .section-header .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .mobile-collapsible .section-content {
      transition: all 0.3s ease;
      overflow: hidden;
    }
    
    .mobile-collapsible.collapsed .section-content {
      max-height: 0 !important;
      opacity: 0;
      padding-top: 0 !important;
      margin-top: 0 !important;
    }
    
    .mobile-collapsible:not(.collapsed) .section-content {
      max-height: 2000px;
      opacity: 1;
    }
    
    /* Force expanded on desktop */
    @media (min-width: 769px) {
      .mobile-collapsible.collapsed .section-content {
        max-height: 2000px !important;
        opacity: 1 !important;
        padding-top: revert !important;
        margin-top: revert !important;
      }
      .mobile-collapsible .section-header .collapse-icon {
        display: none;
      }
    }

    /* ============================================
       RESPONSIVE ADJUSTMENTS
       ============================================ */
    @media (max-width: 768px) {
      .preview-card {
        border-width: 3px;
        border-radius: 24px;
      }

      .amount-display {
        font-size: 2.5rem;
      }

      .theme-dropdown {
        right: -50px;
        min-width: 260px;
      }

      .business-name-display {
        font-size: 1rem;
      }
    }

    /* ============================================
       SCROLLBAR STYLES
       ============================================ */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-option-card);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--slider-track);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }

    /* ============================================
       BADGE STYLES
       ============================================ */
    .trust-badge {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      box-shadow: var(--shadow-md), 0 0 0 1px rgba(var(--accent-rgb), 0.1);
      position: relative;
      overflow: hidden;
    }

    .trust-badge::before {
      content: '';
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(var(--accent-rgb), 0.08), transparent);
      pointer-events: none;
    }

    .trust-badge-icon {
      width: 20px;
      height: 20px;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(var(--accent-rgb), 0.4);
    }

    .trust-badge-icon svg {
      width: 12px;
      height: 12px;
      color: white;
    }

    .trust-badge-text {
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      color: var(--text-secondary);
    }

    .trust-badge-accent {
      color: var(--accent);
      font-weight: 800;
    }

    /* Light theme trust badge */
    .theme-light .trust-badge {
      background: white;
      border-color: rgba(var(--accent-rgb), 0.2);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(var(--accent-rgb), 0.1);
    }

    /* Dark theme trust badge */
    .theme-dark .trust-badge {
      background: rgba(30, 41, 59, 0.9);
      border-color: rgba(var(--accent-rgb), 0.3);
    }

    /* Black theme trust badge */
    .theme-black .trust-badge {
      background: rgba(20, 20, 20, 0.95);
      border-color: rgba(var(--accent-rgb), 0.4);
    }

    .option-badge {
      background: rgba(var(--accent-rgb), 0.1);
      border: 1px solid rgba(var(--accent-rgb), 0.2);
      color: var(--accent);
    }

    /* Dark theme specific overrides */
    .theme-dark .preview-header .amount-display {
      background: linear-gradient(180deg, #ffffff 0%, #94a3b8 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .theme-dark .btn-secondary:hover {
      background: var(--accent-glow);
    }

    .theme-dark input,
    .theme-dark textarea,
    .theme-dark select {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    /* Gradient fix for dark mode inputs */
    .theme-dark .option-card input,
    .theme-dark .option-card textarea {
      background: var(--bg-card);
      border-color: var(--border-primary);
    }

    .theme-dark .stats-grid {
      background: var(--bg-card-inner);
    }

    .theme-dark .stat-cell {
      border-color: var(--border-primary) !important;
    }

    /* Black theme specific overrides */
    .theme-black .preview-header .amount-display {
      background: linear-gradient(180deg, #ffffff 0%, #a3a3a3 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .theme-black .btn-secondary:hover {
      background: var(--accent-glow);
    }

    .theme-black input,
    .theme-black textarea,
    .theme-black select {
      color: var(--text-primary);
      background: var(--bg-input);
    }

    .theme-black .option-card input,
    .theme-black .option-card textarea {
      background: var(--bg-card);
      border-color: var(--border-primary);
    }

    .theme-black .stats-grid {
      background: #0a0a0a;
    }

    .theme-black .stats-grid:nth-child(even) {
      background: #0f0f0f;
    }

    .theme-black .stat-cell {
      border-color: var(--border-primary) !important;
    }

    /* Dashboard Styles */
    .offer-count-badge {
      background: var(--accent);
      color: var(--accent-text);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
      box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
    }
    
    /* Lite usage badge - grey by default, orange when low */
    .lite-badge {
      background: var(--bg-tertiary);
      color: var(--text-muted);
      font-size: 10px;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }
    
    .lite-badge.low {
      background: var(--accent);
      color: var(--accent-text);
      box-shadow: 0 0 10px rgba(var(--accent-rgb), 0.5);
    }
    
    .dashboard-modal {
      position: fixed;
      inset: 0;
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }
    
    .dashboard-backdrop {
      position: absolute;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      backdrop-filter: blur(4px);
      z-index: 1;
    }
    
    .dashboard-content {
      position: relative;
      z-index: 2;
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      width: 100%;
      max-width: 900px;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.4);
      pointer-events: auto;
    }
    
    .dashboard-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-primary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
      position: relative;
      z-index: 10;
    }
    
    .dashboard-title {
      font-size: 18px;
      font-weight: 700;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .dashboard-body {
      padding: 20px 24px;
      overflow-y: auto;
      flex: 1;
    }
    
    .offers-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .offers-table th {
      text-align: left;
      padding: 12px 16px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border-primary);
      background: var(--bg-toggle);
    }
    
    .offers-table td {
      padding: 14px 16px;
      font-size: 13px;
      color: var(--text-primary);
      border-bottom: 1px solid var(--border-secondary);
      vertical-align: middle;
    }
    
    .offers-table tr:hover td {
      background: var(--bg-toggle);
    }
    
    .offer-status {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .offer-status:hover {
      filter: brightness(1.1);
      transform: scale(1.02);
    }
    
    .offer-status .status-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
    }
    
    .offer-status.pending {
      background: rgba(251, 191, 36, 0.15);
      color: #f59e0b;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }
    
    .offer-status.accepted {
      background: rgba(34, 197, 94, 0.15);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.3);
    }
    
    .offer-status.expired {
      background: rgba(239, 68, 68, 0.15);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.3);
    }
    
    .offer-actions {
      display: flex;
      gap: 6px;
    }
    
    .offer-action-btn {
      padding: 6px 10px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 600;
      border: 1px solid var(--border-primary);
      background: var(--bg-toggle);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .offer-action-btn:hover {
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .offer-action-btn.delete:hover {
      border-color: #ef4444;
      color: #ef4444;
    }
    
    .clear-all-btn {
      cursor: pointer;
      border: none;
      background: transparent;
    }
    
    .clear-all-btn:hover {
      color: #ef4444 !important;
      background: rgba(239, 68, 68, 0.1);
    }
    
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    
    .empty-state svg {
      width: 48px;
      height: 48px;
      margin: 0 auto 16px;
      opacity: 0.5;
    }
    
    .empty-state p {
      font-size: 14px;
      margin-bottom: 8px;
    }
    
    .offer-amount {
      font-weight: 700;
      color: var(--accent);
    }
    
    .offer-terms {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 2px;
    }
    
    .offer-date {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* NUCLEAR: Kill ALL transitions when rainbow mode is active */
    html.rainbow-mode *,
    html.rainbow-mode *::before,
    html.rainbow-mode *::after {
      transition: none !important;
      animation: none !important;
    }
  </style>
</head>
<body class="min-h-screen p-4 md:p-6 lg:p-8 flex justify-center">

  <!-- SVG GRADIENT DEFINITION -->
  <svg width="0" height="0" style="position:absolute">
    <defs>
      <linearGradient id="gradient" x1="0%" y1="0%" x2="100%" y2="100%">
        <stop offset="0%" class="gradient-start" style="stop-color:var(--accent)"/>
        <stop offset="100%" class="gradient-end" style="stop-color:var(--accent-light)"/>
      </linearGradient>
    </defs>
  </svg>

  <!-- WELCOME SCREEN -->
  <div id="welcomeScreen" class="welcome-screen">
    <div class="welcome-card">
      <!-- Icon -->
      <div class="welcome-logo">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
          <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor"/>
          <path d="M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" fill="white"/>
        </svg>
      </div>
      
      <!-- Title -->
      <h1 class="welcome-title">Approval Toolbox</h1>
      <p class="welcome-subtitle">Create professional funding offers for your clients</p>
      
      <!-- Mode Toggle -->
      <div class="welcome-mode-toggle">
        <div class="welcome-mode-label">I am a:</div>
        <div class="flex items-center rounded-full overflow-hidden" style="background: var(--accent-glow); border: 1px solid var(--accent); padding: 6px 4px;">
          <button id="welcomeLenderModeBtn" onclick="setClientModeWelcome('lender')" class="mode-toggle-btn flex items-center gap-2 transition-all" style="color: var(--accent); padding: 0 8px; font-size: 12px; font-weight: 600;">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
            </svg>
            Lender
          </button>
          <div style="width: 1px; height: 14px; background: var(--accent); opacity: 0.3; margin: 0 4px;"></div>
          <button id="welcomeIsoModeBtn" onclick="setClientModeWelcome('iso')" class="mode-toggle-btn active flex items-center gap-2 transition-all" style="color: var(--accent); padding: 0 8px; font-size: 12px; font-weight: 600;">
            <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            ISO
          </button>
        </div>
      </div>
      
      <!-- Form -->
      <div class="welcome-form">
        <input type="text" id="welcomeUsername" class="welcome-input" placeholder="Username" autocomplete="username" />
        <input type="password" id="welcomePassword" class="welcome-input" placeholder="Password" autocomplete="current-password" />
        <div id="welcomeError" class="welcome-error">Invalid username or password</div>
        <button onclick="handleWelcomeLogin()" class="welcome-btn-primary">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
          </svg>
          Sign In
          <span class="pro-badge">PRO</span>
        </button>
      </div>
      
      <!-- Divider -->
      <div class="welcome-divider">or</div>
      
      <!-- Free Version Button -->
      <button onclick="continueAsFree()" class="welcome-btn-secondary">
          Continue
          <span class="lite-badge">LITE</span>
        </button>
      
      <!-- Features -->
      <div class="welcome-features">
        <div class="welcome-features-title">WHAT'S INCLUDED</div>
        <div class="welcome-feature">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
          Create unlimited funding offers
        </div>
        <div class="welcome-feature">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
          Share via link or email
        </div>
        <div class="welcome-feature">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
          </svg>
          Multiple theme options
        </div>
        <div class="welcome-feature locked">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
          </svg>
          Custom branding (Pro only)
        </div>
      </div>
    </div>
  </div>

  <!-- LOGIN MODAL (for unlocking brand section later) -->
  <div id="loginModal" class="login-modal-overlay">
    <div class="login-modal">
      <button onclick="closeLoginModal()" class="login-close-btn">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
      
      <!-- Content -->
      <div class="login-modal-content">
        <!-- Icon -->
        <div class="login-modal-icon">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none">
            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="currentColor"/>
            <path d="M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" fill="white"/>
          </svg>
        </div>
        
        <!-- Title -->
        <h2 class="login-modal-title">Approval Toolbox</h2>
        <p class="login-modal-subtitle">Create professional funding offers for your clients</p>
        
        <!-- Form -->
        <form class="login-form" id="loginForm">
          <input type="text" id="loginUsername" class="login-input" placeholder="Username" autocomplete="username" required />
          <input type="password" id="loginPassword" class="login-input" placeholder="Password" autocomplete="current-password" required />
          <div id="loginError" class="login-error">Invalid username or password</div>
          <button type="button" onclick="handleLogin()" class="login-btn" style="flex-direction: column; gap: 6px;">
            <span style="display: flex; align-items: center; gap: 8px;">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M11 16l-4-4m0 0l4-4m-4 4h14m-5 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h7a3 3 0 013 3v1" />
              </svg>
              Sign In
            </span>
            <span style="background: rgba(0,0,0,0.3); padding: 2px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em;">PRO</span>
          </button>
        </form>
        
        <!-- Divider -->
        <div class="login-divider">
          <span>or</span>
        </div>
        
        <!-- Free Version Button -->
        <button onclick="closeLoginModal()" class="login-free-btn" style="flex-direction: column; gap: 6px;">
          <span>Continue</span>
          <span style="background: rgba(255,255,255,0.15); padding: 2px 10px; border-radius: 4px; font-size: 10px; font-weight: 700; letter-spacing: 0.05em;">LITE</span>
        </button>
        
        <!-- Features -->
        <div class="login-features">
          <div class="login-features-title">WHAT'S INCLUDED</div>
          <div class="login-feature">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            Create unlimited funding offers
          </div>
          <div class="login-feature">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            Share via link or email
          </div>
          <div class="login-feature">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
              <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            Multiple theme options
          </div>
          <div class="login-feature login-feature-locked">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
            Custom branding (Pro only)
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- DASHBOARD MODAL -->
  <div id="dashboardModal" class="dashboard-modal hidden">
    <div class="dashboard-backdrop" onclick="closeDashboard()"></div>
    <div class="dashboard-content">
      <div class="dashboard-header">
        <div class="dashboard-title">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" style="color: var(--accent);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
          </svg>
          Offer Dashboard
        </div>
        <div style="display: flex; align-items: center; gap: 12px;">
          <button type="button" id="clearAllBtn" style="color: #ef4444; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; cursor: pointer; background: rgba(239,68,68,0.1); border: 1px solid rgba(239,68,68,0.3); position: relative; z-index: 100; pointer-events: auto;">
            Clear All
          </button>
          <button onclick="closeDashboard()" class="h-8 w-8 rounded-lg flex items-center justify-center transition-all" style="color: var(--text-muted);" onmouseover="this.style.color='var(--text-primary)'; this.style.background='var(--bg-toggle)'" onmouseout="this.style.color='var(--text-muted)'; this.style.background='transparent'">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>
      <div class="dashboard-body">
        <div id="offersTableContainer">
          <!-- Table or empty state rendered by JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- WRAPPER -->
  <div class="w-full max-w-7xl">

      <!-- ========================================== -->
      <!-- ADMIN PANEL                                -->
      <!-- ========================================== -->
      <div id="adminPanel">
          <!-- Floating Share Button -->
          <button id="floatingShareBtn" onclick="shareOffer()" class="fixed bottom-6 right-6 z-40 w-12 h-12 rounded-full flex items-center justify-center transition-all shadow-lg" style="background: var(--accent); color: white;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'" title="Share Offer">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
              </svg>
          </button>
          
          <!-- HEADER -->
          <header class="flex flex-col md:flex-row items-center justify-between gap-4 mb-10">
            <div class="flex flex-col md:flex-row items-center gap-4 text-center md:text-left">
                <div class="p-3 rounded-2xl shadow-md border" style="background: var(--bg-card); border-color: var(--border-secondary);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24">
                      <defs>
                        <linearGradient id="shieldGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                          <stop offset="0%" style="stop-color:var(--accent)"/>
                          <stop offset="100%" style="stop-color:var(--accent-dark)"/>
                        </linearGradient>
                      </defs>
                      <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="url(#shieldGrad)"/>
                      <path d="M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" fill="#ffffff"/>
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-extrabold tracking-tight" style="color: var(--text-primary);">Approval Toolbox</h1>
                    <p class="text-xs font-semibold tracking-wide" style="color: var(--text-muted);">TrustBureau.ai</p>
                </div>
                <!-- User Badge (shown when logged in) -->
                <div id="userBadge" class="user-badge hidden" style="cursor: pointer;" onclick="handleLogout()" title="Click to logout">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                    </svg>
                    <span id="userBadgeName">User</span>
                </div>
                
                
                <!-- Mode Toggle -->
                <div class="flex items-center rounded-full overflow-hidden" style="background: var(--accent-glow); border: 1px solid var(--accent); padding: 6px 4px;">
                    <button id="lenderModeBtn" onclick="setClientMode('lender')" class="mode-toggle-btn flex items-center gap-2 transition-all" style="color: var(--accent); padding: 0 8px; font-size: 12px; font-weight: 600;">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                        </svg>
                        Lender
                    </button>
                    <div style="width: 1px; height: 14px; background: var(--accent); opacity: 0.3; margin: 0 4px;"></div>
                    <button id="isoModeBtn" onclick="setClientMode('iso')" class="mode-toggle-btn active flex items-center gap-2 transition-all" style="color: var(--accent); padding: 0 8px; font-size: 12px; font-weight: 600;">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                        </svg>
                        ISO
                    </button>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <!-- Action Buttons -->
                <div class="flex items-center gap-2">
                    <!-- Settings Button -->
                    <div class="theme-picker relative">
                        <button id="settingsBtn" onclick="toggleThemeDropdown()" class="h-8 px-3 rounded-full flex items-center justify-center gap-2 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 12px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                            </svg>
                            Settings
                        </button>
                        <div id="themeDropdown" class="theme-dropdown">
                            <!-- Theme Mode Section -->
                            <div class="theme-section-title">Theme</div>
                            <div class="theme-mode-toggle">
                                <button onclick="setThemeMode('light')" class="theme-mode-btn" data-mode="light">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                                    </svg>
                                    Light
                                </button>
                                <button onclick="setThemeMode('dark')" class="theme-mode-btn" data-mode="dark">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                                    </svg>
                                    Dark
                                </button>
                                <button onclick="setThemeMode('black')" class="theme-mode-btn" data-mode="black">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="currentColor" viewBox="0 0 24 24">
                                        <circle cx="12" cy="12" r="10" />
                                    </svg>
                                    Black
                                </button>
                            </div>
                            
                            <!-- Lender Rate Settings (shown in lender mode) -->
                            <div id="lenderRateSettings" class="hidden" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
                                    <!-- Tier Preset Customization -->
                                    <div class="theme-section-title">Rate Tiers</div>
                                    <p class="text-xs mb-3" style="color: var(--text-muted);">Customize preset tiers (Buy / Max Sell)</p>
                                    
                                    <!-- Tier A -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span class="text-xs font-bold" style="color: var(--text-secondary); width: 45px;">Tier A</span>
                                        <input type="number" id="tierABuy" step="0.01" min="1.00" max="1.99" value="1.15"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('A')" />
                                        <span class="text-xs" style="color: var(--text-muted);">/</span>
                                        <input type="number" id="tierAMax" step="0.01" min="1.00" max="1.99" value="1.25"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('A')" />
                                    </div>
                                    
                                    <!-- Tier B -->
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
                                        <span class="text-xs font-bold" style="color: var(--text-secondary); width: 45px;">Tier B</span>
                                        <input type="number" id="tierBBuy" step="0.01" min="1.00" max="1.99" value="1.25"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('B')" />
                                        <span class="text-xs" style="color: var(--text-muted);">/</span>
                                        <input type="number" id="tierBMax" step="0.01" min="1.00" max="1.99" value="1.35"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('B')" />
                                    </div>
                                    
                                    <!-- Tier C -->
                                    <div style="display: flex; align-items: center; gap: 8px;">
                                        <span class="text-xs font-bold" style="color: var(--text-secondary); width: 45px;">Tier C</span>
                                        <input type="number" id="tierCBuy" step="0.01" min="1.00" max="1.99" value="1.35"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('C')" />
                                        <span class="text-xs" style="color: var(--text-muted);">/</span>
                                        <input type="number" id="tierCMax" step="0.01" min="1.00" max="1.99" value="1.45"
                                            class="flex-1 px-2 py-1.5 text-sm rounded-lg text-center"
                                            style="background: var(--bg-input); border: 1px solid var(--border-primary); color: var(--text-primary);"
                                            onchange="updateTierPreset('C')" />
                                    </div>
                                </div>
                            
                            <!-- Brand Section (Locked when not logged in) -->
                            <div id="brandSection" class="brand-section locked" style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary); position: relative;">
                                <div class="brand-lock-overlay">
                                    <button onclick="openLoginModal()" class="brand-lock-btn">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
                                        </svg>
                                        Unlock
                                    </button>
                                </div>
                                
                                <div class="brand-content">
                                    <div class="theme-section-title" style="display: flex; align-items: center; gap: 6px;">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" style="color: var(--accent);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                                        </svg>
                                        Brand
                                    </div>
                                    
                                    <!-- Company Name Input -->
                                    <div style="margin-bottom: 16px;">
                                        <label class="block text-xs font-medium mb-2" style="color: var(--text-secondary);">Company Name</label>
                                        <input 
                                            type="text" 
                                            id="companyNameInput" 
                                            class="logo-input" 
                                            placeholder="Your Company Name"
                                            oninput="updateCompanyName(this.value)"
                                            maxlength="50"
                                        />
                                    </div>
                                    
                                    <!-- Logo URL Input -->
                                    <div>
                                        <label class="block text-xs font-medium mb-2" style="color: var(--text-secondary);">Company Logo</label>
                                        <div class="flex gap-2">
                                            <input 
                                                type="text" 
                                                id="logoUrlInput" 
                                                class="logo-input flex-1" 
                                                placeholder="https://example.com/logo.png"
                                                oninput="updateLogoPreview(this.value)"
                                            />
                                            <button onclick="updateLogoPreview($('logoUrlInput').value)" class="px-3 py-2 rounded-lg text-xs font-semibold" style="background: var(--accent); color: white;">Load</button>
                                        </div>
                                        <div id="logoPreviewSmall" class="logo-preview-small">
                                            <span class="logo-preview-placeholder">Logo preview will appear here</span>
                                        </div>
                                        <div id="clearLogoBtn" class="clear-logo-btn hidden" onclick="clearLogo()">
                                            âœ• Remove Logo
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Accent Color Section -->
                            <div class="theme-section-title" style="margin-top: 16px;">Accent Color</div>
                            <div class="color-swatches">
                                <div onclick="setAccentColor('mint')" class="color-swatch swatch-mint" data-accent="mint" title="Mint"></div>
                                <div onclick="setAccentColor('blue')" class="color-swatch swatch-blue" data-accent="blue" title="Blue"></div>
                                <div onclick="setAccentColor('purple')" class="color-swatch swatch-purple" data-accent="purple" title="Purple"></div>
                                <div onclick="setAccentColor('rainbow')" class="color-swatch swatch-rainbow" data-accent="rainbow" title="Rainbow"></div>
                                <div onclick="setAccentColor('orange')" class="color-swatch swatch-orange" data-accent="orange" title="Orange"></div>
                                <div onclick="setAccentColor('cyan')" class="color-swatch swatch-cyan" data-accent="cyan" title="Cyan"></div>
                                <div onclick="setAccentColor('gold')" class="color-swatch swatch-gold" data-accent="gold" title="Gold"></div>
                                <div onclick="setAccentColor('slate')" class="color-swatch swatch-slate" data-accent="slate" title="Slate"></div>
                                <div onclick="setAccentColor('lime')" class="color-swatch swatch-lime" data-accent="lime" title="Forest"></div>
                                <div onclick="setAccentColor('teal')" class="color-swatch swatch-teal" data-accent="teal" title="Navy"></div>
                                <div onclick="setAccentColor('pink')" class="color-swatch swatch-pink" data-accent="pink" title="Burgundy"></div>
                                <div onclick="setAccentColor('indigo')" class="color-swatch swatch-indigo" data-accent="indigo" title="Steel"></div>
                            </div>
                            
                            <!-- Reset Button -->
                            <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border-secondary);">
                                <button onclick="resetBrandKit()" class="w-full text-xs font-semibold py-2 px-3 rounded-lg transition-all" style="color: var(--text-muted); background: var(--bg-option-card);" onmouseover="this.style.color='#ef4444'" onmouseout="this.style.color='var(--text-muted)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                    Reset Theme
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Dashboard Button -->
                    <button id="dashboardBtn" onclick="openDashboard()" class="h-8 px-3 rounded-full flex items-center justify-center gap-2 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 12px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        <span>Offers</span>
                        <span id="offerCount" class="offer-count-badge hidden">0</span>
                    </button>
                    
                    <!-- Preview Dropdown -->
                    <div class="preview-picker relative">
                        <button id="previewBtn" onclick="togglePreviewDropdown()" class="h-8 px-3 rounded-full flex items-center justify-center gap-2 transition-all font-semibold" style="background: transparent; border: 1px solid var(--border-primary); color: var(--text-muted); font-size: 12px;" onmouseover="this.style.borderColor='var(--accent)'; this.style.color='var(--accent)'" onmouseout="this.style.borderColor='var(--border-primary)'; this.style.color='var(--text-muted)'">
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                            </svg>
                            Preview
                            <svg xmlns="http://www.w3.org/2000/svg" style="width: 10px; height: 10px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </button>
                        <div id="previewDropdown" class="preview-dropdown">
                            <button onclick="previewClientView(); togglePreviewDropdown();" class="preview-option">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" />
                                </svg>
                                <div>
                                    <div class="preview-option-title">Client Preview</div>
                                    <div class="preview-option-desc">See what your client sees</div>
                                </div>
                            </button>
                            <button id="isoPreviewOption" onclick="previewISOView(); togglePreviewDropdown();" class="preview-option hidden">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                                <div>
                                    <div class="preview-option-title">ISO Preview</div>
                                    <div class="preview-option-desc">See what your ISO partner sees</div>
                                </div>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Share Button -->
                    <button onclick="shareOffer()" class="share-btn h-8 px-3 rounded-full flex items-center justify-center gap-2 font-semibold" style="background: transparent; border: 1px solid var(--accent); color: var(--accent); font-size: 12px;">
                        <span id="liteUsageBadge" class="lite-badge hidden">25</span>
                        <svg xmlns="http://www.w3.org/2000/svg" style="width: 14px; height: 14px;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                        </svg>
                        Share
                    </button>
                </div>
            </div>
          </header>

          <!-- ISO Preview Bar (shows in admin panel during ISO preview mode) -->
          <div id="isoPreviewBar" class="hidden p-4 sticky top-0 z-50 flex justify-between items-center mb-4 rounded-2xl shadow-xl ring-1" style="background: rgba(16, 185, 129, 0.15); border: 1px solid #10b981; ring-color: rgba(16, 185, 129, 0.3);">
              <span class="font-bold text-sm uppercase tracking-wider flex items-center gap-2" style="color: #10b981;">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  ISO Preview Mode
              </span>
              <div class="flex items-center gap-3">
                  <span class="text-xs" style="color: var(--text-muted);">This is what your ISO partner sees</span>
                  <button onclick="exitISOPreview()" class="text-xs font-bold px-4 py-2 rounded-lg transition-all" style="background: #10b981; color: white;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">Back to Editor</button>
              </div>
          </div>

          <!-- ADMIN GRID -->
          <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
              
              <!-- LEFT: INPUTS -->
              <div class="lg:col-span-7 space-y-6 order-2 lg:order-1">
                
                <!-- Client Info Card -->
                <div class="card p-6 mobile-collapsible collapsed" id="clientInfoCard">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('clientInfoCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Client Information</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="section-content mt-6 space-y-4">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-semibold mb-2 ml-1" style="color: var(--text-muted);">Business Name</label>
                                <input id="calcBusinessName" type="text" class="w-full p-3.5 border rounded-xl input-field text-sm font-medium" placeholder="e.g. Acme Corporation LLC" value="Acme Corporation LLC" />
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-2 ml-1" style="color: var(--text-muted);">Contact Name</label>
                                <input id="calcContactName" type="text" class="w-full p-3.5 border rounded-xl input-field text-sm font-medium" placeholder="First Last" value="First Last" />
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Terms Card -->
                <div class="card p-6 mobile-collapsible" id="structureOfferCard">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('structureOfferCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Structure Offer</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    
                    <div class="section-content">
                    <!-- Tabs -->
                    <div class="flex gap-2 border-b mb-8 mt-4" style="border-color: var(--border-primary);">
                        <button id="tab-btn-0" class="calc-tab active px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(0)">Option A</button>
                        <button id="tab-btn-1" class="calc-tab hidden px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(1)">Option B</button>
                        <button id="tab-btn-2" class="calc-tab hidden px-5 py-2.5 text-sm font-bold rounded-t-lg border border-transparent -mb-[1px]" onclick="switchCalcTab(2)">Option C</button>
                        <div class="ml-auto flex items-center gap-2">
                            <button onclick="resetCalculator()" class="text-xs font-bold px-3 py-2 rounded-lg transition-colors" style="color: var(--text-muted);" onmouseover="this.style.background='var(--bg-option-card)'; this.style.color='var(--text-secondary)'" onmouseout="this.style.background='transparent'; this.style.color='var(--text-muted)'" title="Reset Calculator">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                                Reset
                            </button>
                            <button id="add-tab-btn" class="text-xs font-bold px-3 py-2 rounded-lg transition-colors" style="color: var(--accent);" onmouseover="this.style.background='var(--accent-glow)'" onmouseout="this.style.background='transparent'" onclick="addCalcOption()">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 inline mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                                Add Option
                            </button>
                        </div>
                    </div>
                    
                    <div class="space-y-8 fade-enter">
                        <!-- Funding Amount Slider -->
                        <div class="rounded-2xl p-6 border" style="background: var(--bg-option-card); border-color: var(--border-secondary);">
                            <div class="flex justify-between items-center mb-3">
                                <label class="text-xs font-bold uppercase tracking-wide" style="color: var(--text-muted);">Funding Amount</label>
                                <button id="remove-option-btn" onclick="removeCalcOption()" class="text-xs hidden font-bold hover:underline flex items-center gap-1" style="color: #ef4444;">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                                    Remove
                                </button>
                            </div>
                            <div class="flex items-baseline gap-1.5 mb-5">
                                <span class="font-semibold text-xl" style="color: var(--text-muted);">$</span>
                                <input id="calcAmount" type="text" class="w-full bg-transparent border-none p-0 text-4xl font-extrabold focus:ring-0 focus:outline-none" style="color: var(--text-primary);" value="50,000" />
                            </div>
                            <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000" value="50000" class="slider w-full" />
                            <div class="flex justify-between text-[10px] font-semibold mt-2 uppercase tracking-wider" style="color: var(--text-muted);">
                                <span>$5k</span>
                                <span>$1M</span>
                            </div>
                        </div>
                        
                        <!-- Factor & Term Sliders -->
                        <div id="factorTermGrid" class="grid grid-cols-1 gap-6">
                            <div id="factorRateCard" class="option-card hidden">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Factor Rate</label>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="calcFactor" type="number" step="0.01" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">PTR</span>
                                </div>
                                <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25" class="slider w-full" />
                            </div>
                            <div class="option-card">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Term Length</label>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="calcTerm" type="number" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="130" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">Pmts</span>
                                </div>
                                <input id="calcTermSlider" type="range" min="5" max="520" step="1" value="130" class="slider w-full" />
                            </div>
                            
                            <!-- Payment Frequency -->
                            <div class="option-card">
                                <label class="text-xs font-bold uppercase tracking-wide mb-4 block" style="color: var(--text-muted);">Payment Frequency</label>
                                <div class="toggle-group inline-flex w-full">
                                    <button class="toggle-btn active flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="daily" onclick="setFrequency('daily')">Daily</button>
                                    <button class="toggle-btn flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="weekly" onclick="setFrequency('weekly')">Weekly</button>
                                    <button class="toggle-btn flex-1 py-3 rounded-lg text-sm font-semibold transition-all" data-freq="monthly" onclick="setFrequency('monthly')">Monthly</button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Lender Mode: Rate Settings -->
                        <div id="lenderRateSection" class="hidden">
                            <div class="option-card" style="border: 2px solid var(--accent); background: var(--accent-glow);">
                                <div class="flex items-center justify-between mb-4">
                                    <label class="text-xs font-bold uppercase tracking-wide" style="color: var(--accent);">Lender Rate Settings</label>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" style="background: var(--accent); color: var(--accent-text);">Lender Mode</span>
                                </div>
                                
                                <!-- Tier Presets -->
                                <div class="mb-4">
                                    <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Rate Tier Presets</label>
                                    <div class="grid grid-cols-3 gap-2">
                                        <button onclick="setLenderTier(1)" id="tierBtn1" class="tier-preset-btn active p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--accent);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier A</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.15 / 1.25</span>
                                        </button>
                                        <button onclick="setLenderTier(2)" id="tierBtn2" class="tier-preset-btn p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier B</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.25 / 1.35</span>
                                        </button>
                                        <button onclick="setLenderTier(3)" id="tierBtn3" class="tier-preset-btn p-3 rounded-lg border-2 text-center transition-all" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <span class="block text-xs font-bold mb-1" style="color: var(--text-muted);">Tier C</span>
                                            <span class="block text-sm font-bold" style="color: var(--text-primary);">1.35 / 1.45</span>
                                        </button>
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <!-- Buy Rate -->
                                    <div>
                                        <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Buy Rate (ISO)</label>
                                        <div class="flex items-center justify-between mb-2 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <input id="lenderBuyRate" type="number" step="0.01" min="1.05" max="1.60" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.15" />
                                            <span class="text-[10px] font-bold px-2 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">BUY</span>
                                        </div>
                                        <input id="lenderBuyRateSlider" type="range" min="1.05" max="1.60" step="0.01" value="1.15" class="slider w-full" />
                                    </div>
                                    
                                    <!-- Max Sell Rate -->
                                    <div>
                                        <label class="text-xs font-bold uppercase tracking-wide mb-2 block" style="color: var(--text-muted);">Max Sell Rate (ISO Ceiling)</label>
                                        <div class="flex items-center justify-between mb-2 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                            <input id="lenderMaxSell" type="number" step="0.01" min="1.10" max="1.70" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                            <span class="text-[10px] font-bold px-2 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">MAX</span>
                                        </div>
                                        <input id="lenderMaxSellSlider" type="range" min="1.10" max="1.70" step="0.01" value="1.25" class="slider w-full" />
                                    </div>
                                </div>
                                
                                <div class="grid grid-cols-2 gap-3 mb-4 p-3 rounded-lg" style="background: var(--bg-card);">
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Max Upsell</p>
                                        <p id="lenderMaxSpread" class="text-lg font-bold" style="color: var(--accent);">0.24</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Max ISO Profit</p>
                                        <p id="lenderMaxProfit" class="text-lg font-bold" style="color: #10b981;">$0</p>
                                    </div>
                                </div>
                                
                                <button onclick="shareWithISO()" class="w-full py-3 px-4 rounded-lg font-semibold text-sm flex items-center justify-center gap-2 transition-all" style="background: var(--accent); color: var(--accent-text);">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                    </svg>
                                    Share with ISO
                                </button>
                            </div>
                        </div>
                        
                        <!-- ISO Mode: Upsell Slider (when opened via shared link) -->
                        <div id="isoUpsellSection" class="hidden">
                            <div class="option-card" style="border: 2px solid #10b981; background: rgba(16, 185, 129, 0.1);">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="text-xs font-bold uppercase tracking-wide" style="color: #10b981;">Rate</label>
                                    <span class="text-xs font-semibold px-2 py-1 rounded" style="background: #10b981; color: white;">ISO Mode</span>
                                </div>
                                <p class="text-xs mb-3" style="color: var(--text-muted);">Adjust your sell rate to set your profit margin</p>
                                <div class="flex items-center justify-between mb-4 p-2.5 rounded-lg border" style="background: var(--bg-card); border-color: var(--border-primary);">
                                    <input id="isoSellRate" type="number" step="0.01" min="1.05" max="1.70" class="bg-transparent font-bold outline-none w-20 text-lg" style="color: var(--text-primary);" value="1.25" />
                                    <span class="text-[10px] font-bold px-2.5 py-1 rounded border uppercase tracking-wider" style="color: var(--text-muted); background: var(--bg-option-card); border-color: var(--border-secondary);">SELL</span>
                                </div>
                                <input id="isoSellRateSlider" type="range" min="1.05" max="1.70" step="0.01" value="1.25" class="slider w-full" />
                                <div class="grid grid-cols-3 gap-2 mt-4 pt-4" style="border-top: 1px solid var(--border-secondary);">
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Buy Rate</p>
                                        <p id="isoBuyRateDisplay" class="text-sm font-bold" style="color: var(--text-primary);">1.15</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Upsell</p>
                                        <p id="isoSpreadDisplay" class="text-sm font-bold" style="color: #10b981;">0.10</p>
                                    </div>
                                    <div class="text-center">
                                        <p class="text-[10px] uppercase font-bold" style="color: var(--text-muted);">Your Profit</p>
                                        <p id="isoProfitDisplay" class="text-sm font-bold" style="color: #10b981;">$0</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
                </div> <!-- end structureOfferCard -->
                
                <!-- Offer Options Card (Collapsible on Mobile) -->
                <div id="offerOptionsCard" class="card p-6 mobile-collapsible collapsed">
                    <div class="flex items-center justify-between section-header" onclick="toggleMobileSection('offerOptionsCard')">
                        <div class="flex items-center gap-3">
                            <div class="section-indicator"></div>
                            <h3 class="section-title">Offer Options</h3>
                        </div>
                        <div class="collapse-icon h-5 w-5 items-center justify-center rounded-full" style="color: var(--text-muted);">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    <div class="section-content mt-6">
                <!-- Options Grid - 2x3 -->
                <div class="grid grid-cols-2 gap-3">
                <!-- Origination Fee Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #ec4899, #db2777);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Origination Fee</span>
                        </div>
                        <label class="switch">
                            <input id="toggleFee" type="checkbox" onchange="toggleSection('Fee', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secFee" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <div class="flex items-center gap-3">
                            <input id="calcFee" type="number" step="0.5" min="0" max="15" class="w-16 border rounded-lg p-2 text-sm font-bold text-center outline-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" value="0" oninput="setVal('calcFeeSlider', this.value); updateSliderFill($('calcFeeSlider')); updatePreview()" />
                            <span class="text-sm font-bold" style="color: var(--text-muted);">%</span>
                            <input id="calcFeeSlider" type="range" min="0" max="15" step="0.5" value="0" class="slider h-1.5 flex-1" oninput="setVal('calcFee', this.value); updatePreview(); updateSliderFill(this);" />
                        </div>
                    </div>
                </div>
                
                <!-- Prepay Discount Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #14b8a6, #0d9488);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Prepay Discount</span>
                        </div>
                        <label class="switch">
                            <input id="togglePrepay" type="checkbox" onchange="toggleSection('Prepay', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secPrepay" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <div class="grid grid-cols-2 gap-3 mb-2">
                            <div class="flex items-center gap-2">
                                <input id="calcPrepay" type="number" step="1" min="0" max="50" class="w-14 border rounded-lg p-2 text-sm font-bold text-center outline-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" value="0" oninput="setVal('calcPrepaySlider', this.value); updateSliderFill($('calcPrepaySlider')); updatePreview()" />
                                <span class="text-xs font-bold" style="color: var(--text-muted);">%</span>
                            </div>
                            <input id="calcPrepayDate" type="date" class="w-full border rounded-lg p-2 text-xs font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" onchange="updatePreview()" />
                        </div>
                        <input id="calcPrepaySlider" type="range" min="0" max="50" step="1" value="0" class="slider h-1.5 w-full" oninput="setVal('calcPrepay', this.value); updatePreview(); updateSliderFill(this);" />
                    </div>
                </div>
                
                <!-- Custom Term Label Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #6366f1, #4f46e5);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Custom Term Label</span>
                        </div>
                        <label class="switch">
                            <input id="toggleOverride" type="checkbox" onchange="toggleSection('Override', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secOverride" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcTermOverride" type="text" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" placeholder="e.g. 6 Months" oninput="updatePreview()" />
                    </div>
                </div>
                
                <!-- Offer Expiration Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Offer Expiration</span>
                        </div>
                        <label class="switch">
                            <input id="toggleExpiry" type="checkbox" onchange="toggleSection('Expiry', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secExpiry" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <input id="calcExpiryDate" type="date" class="w-full border rounded-lg p-2 text-sm font-medium" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" onchange="updatePreview()" />
                    </div>
                </div>
                
                <!-- Offer Notes Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Offer Notes</span>
                        </div>
                        <label class="switch">
                            <input id="toggleNotes" type="checkbox" onchange="toggleSection('Notes', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secNotes" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <textarea id="calcNotes" class="w-full border rounded-lg p-2 text-sm font-medium resize-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" rows="3" placeholder="One note per line..." oninput="updatePreview()"></textarea>
                    </div>
                </div>
                
                <!-- Closing Documents Card -->
                <div class="card p-4">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                            <span class="text-sm font-semibold" style="color: var(--text-primary);">Closing Documents</span>
                        </div>
                        <label class="switch">
                            <input id="toggleDocs" type="checkbox" onchange="toggleSection('Docs', this.checked); updatePreview()">
                            <span class="switch-slider"></span>
                        </label>
                    </div>
                    <div id="secDocs" class="hidden mt-3 pt-3 border-t" style="border-color: var(--border-secondary);">
                        <textarea id="calcDocs" class="w-full border rounded-lg p-2 text-sm font-medium resize-none" style="background: var(--bg-option-card); border-color: var(--border-primary); color: var(--text-primary);" rows="3" oninput="updatePreview()">Voided Check
Government Issued ID</textarea>
                    </div>
                </div>
                </div> <!-- end 2x3 grid -->
                    </div> <!-- end section-content -->
                </div> <!-- end offerOptionsCard -->
              </div>

              <!-- RIGHT: PREVIEW -->
              <div class="lg:col-span-5 relative order-1 lg:order-2">
                  <div class="lg:sticky lg:top-8 lg:mt-6">
                      <!-- Preview Card -->
                      <div class="preview-card">
                        
                        <!-- Header -->
                        <div class="preview-header p-8 pb-10 text-center">
                          <div class="relative z-10 pt-2">
                            <!-- Logo Container -->
                            <div id="previewLogoContainer" class="preview-logo-container hidden">
                                <img id="previewLogo" src="" alt="Company Logo" class="preview-logo mx-auto" referrerpolicy="no-referrer" />
                            </div>
                            <div id="previewCompanyName" class="company-name-display hidden"></div>
                            
                            <div id="previewLabelContainer" class="mb-5 hidden">
                                <span id="previewOptionLabel" class="option-badge inline-block text-[10px] font-bold uppercase tracking-widest px-4 py-1.5 rounded-full">Option A</span>
                            </div>
                            <div id="previewBusinessName" class="business-name-display mt-2 mb-4 hidden"></div>
                            
                            <span class="text-[11px] font-bold uppercase tracking-widest block mb-3" style="color: var(--text-muted);">You Get</span>
                            <span id="previewAmount" class="amount-display block">$50,000</span>
                          </div>
                        </div>
                        
                        <!-- Chart Section -->
                        <div class="px-8 py-10 flex items-center justify-center gap-8" style="background: linear-gradient(to bottom, var(--bg-card), var(--bg-option-card));">
                           <div class="relative w-36 h-36 flex-shrink-0">
                              <svg viewBox="0 0 36 36" class="circular-chart transform -rotate-90">
                                <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                <path id="previewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                              </svg>
                              <div class="absolute inset-0 flex flex-col items-center justify-center">
                                <span class="text-[10px] font-bold uppercase tracking-wide" style="color: var(--text-muted);">Payback</span>
                                <span id="previewPaybackChart" class="text-base font-bold block tracking-tight mt-0.5" style="color: var(--text-primary);">$62,500</span>
                              </div>
                           </div>
                           <div class="space-y-3 text-xs">
                               <div class="flex items-center gap-2.5">
                                 <span class="w-3.5 h-3.5 rounded-full shadow-sm" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
                                 <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
                               </div>
                               <div class="flex items-center gap-2.5">
                                 <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
                                 <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
                               </div>
                           </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="border-t" style="border-color: var(--border-secondary); background: var(--bg-option-card);">
                          <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                            <div class="stat-cell">
                              <span class="stat-label">Term Length</span>
                              <span id="previewTermLength" class="stat-value">6 months</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Payments</span>
                              <span id="previewTermPayments" class="stat-value">130</span>
                            </div>
                          </div>
                          <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                            <div class="stat-cell">
                              <span class="stat-label">Factor Rate</span>
                              <span id="previewFactor" class="stat-value font-mono">1.19x</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Total Cost</span>
                              <span id="previewCost" class="stat-value">$12,500</span>
                            </div>
                          </div>
                          
                          <div id="previewFeeRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(251, 191, 36, 0.1);">
                            <div class="stat-cell">
                              <span class="stat-label">Origination Fee</span>
                              <span id="previewFeeAmount" class="stat-value">$0</span>
                            </div>
                            <div class="stat-cell">
                              <span class="stat-label">Net Proceeds</span>
                              <span id="previewNet" class="stat-value">$50,000</span>
                            </div>
                          </div>
                          
                          <div id="previewPrepayRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(34, 197, 94, 0.1);">
                            <div class="stat-cell" style="grid-column: span 2;">
                              <span class="stat-label">Prepay Discount</span>
                              <span id="previewPrepay" class="stat-value" style="color: #22c55e;">10% off if paid early</span>
                            </div>
                          </div>

                          <!-- Payment Display - GRADIENT REMOVED -->
                          <div class="p-8 text-center" style="background: var(--bg-card);">
                            <div>
                                <span id="previewPaymentLabel" class="text-[10px] font-bold block uppercase tracking-widest mb-2" style="color: var(--text-muted);">Daily Payment</span>
                                <span id="previewPayment" class="text-3xl font-extrabold tracking-tight" style="color: var(--text-primary);">$480.77</span>
                            </div>
                          </div>
                        </div>
                        
                        <div class="p-4 text-center border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                              <button onclick="openAmortSchedule()" class="text-xs font-bold flex items-center justify-center gap-1.5 mx-auto group transition-colors" style="color: var(--accent);">
                                  <span>View Payment Schedule</span>
                                  <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                              </button>
                        </div>

                      </div>
                      
                      <!-- Admin Preview: Notes Section -->
                      <div id="previewNotesSection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                              <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Offer Notes</h4>
                          </div>
                          <ul id="previewNotesList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                      
                      <!-- Admin Preview: Docs Section -->
                      <div id="previewDocsSection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                              <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Closing Documents</h4>
                          </div>
                          <ul id="previewDocsList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                      
                      <!-- Admin Preview: Expiration Section (at bottom) -->
                      <div id="previewExpirySection" class="mt-4 rounded-2xl p-4 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                              <div>
                                  <h4 class="font-bold text-xs uppercase tracking-wider" style="color: var(--text-muted);">Offer Expiration</h4>
                                  <p class="text-sm" style="color: var(--text-secondary);">Expires <span id="previewExpiryDate" class="font-bold" style="color: var(--accent);"></span></p>
                              </div>
                          </div>
                      </div>
                      
                  </div>
              </div>
          </div>
      </div>
      
      <!-- ========================================== -->
      <!-- CLIENT PANEL                               -->
      <!-- ========================================== -->
      <div id="clientPanel" class="hidden w-full max-w-4xl mx-auto mt-6">
          <div id="clientPreviewBar" class="hidden p-4 sticky top-0 z-50 flex justify-between items-center mb-8 rounded-2xl shadow-xl ring-1" style="background: rgba(99, 102, 241, 0.15); border: 1px solid #6366f1; ring-color: rgba(99, 102, 241, 0.3);">
              <span class="font-bold text-sm uppercase tracking-wider flex items-center gap-2" style="color: #6366f1;">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" /></svg>
                  Client Preview Mode
              </span>
              <div class="flex items-center gap-3">
                  <span class="text-xs" style="color: var(--text-muted);">This is what your client sees</span>
                  <button onclick="exitPreview()" class="text-xs font-bold px-4 py-2 rounded-lg transition-all" style="background: #6366f1; color: white;" onmouseover="this.style.filter='brightness(1.1)'" onmouseout="this.style.filter='brightness(1)'">Back to Editor</button>
              </div>
          </div>
          
          <div class="text-center mb-10">
              <!-- Trust Badge -->
              <div class="trust-badge inline-flex items-center gap-3 px-5 py-2.5 rounded-full mb-8">
                  <div class="trust-badge-icon">
                      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                          <path fill-rule="evenodd" d="M12.516 2.17a.75.75 0 00-1.032 0 11.209 11.209 0 01-7.877 3.08.75.75 0 00-.722.515A12.74 12.74 0 002.25 9.75c0 5.942 4.064 10.933 9.563 12.348a.749.749 0 00.374 0c5.499-1.415 9.563-6.406 9.563-12.348 0-1.352-.114-2.662-.334-3.908a.75.75 0 00-.722-.515 11.208 11.208 0 01-7.877-3.08zm3.134 7.09a.75.75 0 00-1.06-1.06L11 11.79l-1.09-1.09a.75.75 0 00-1.06 1.06l1.62 1.62a.75.75 0 001.06 0l4.12-4.12z" clip-rule="evenodd" />
                      </svg>
                  </div>
                  <span class="trust-badge-text"><span class="trust-badge-accent">TrustBureau</span> Verified</span>
              </div>
              
              <h1 id="clientGreeting" class="text-3xl font-extrabold mb-3" style="color: var(--text-primary);">Hello, Business Owner</h1>
              <p style="color: var(--text-muted);" class="max-w-lg mx-auto text-sm">Your business <span id="clientBusinessName" class="font-semibold" style="color: var(--text-primary);"></span> has been pre-approved for funding.</p>
          </div>

          <!-- Client Card -->
          <div class="max-w-md mx-auto relative">
              <div class="preview-card">
                  
                  <!-- Header -->
                  <div class="preview-header p-8 pb-10 text-center">
                    <div class="relative z-10 pt-2">
                      <!-- Logo Container -->
                      <div id="cPreviewLogoContainer" class="preview-logo-container hidden">
                          <img id="cPreviewLogo" src="" alt="Company Logo" class="preview-logo mx-auto" referrerpolicy="no-referrer" />
                      </div>
                      <div id="cPreviewCompanyName" class="company-name-display hidden"></div>
                      
                      <!-- Option Tabs -->
                      <div id="clientTabsContainer" class="flex justify-center gap-2 mb-6 hidden"></div>
                      <div id="cPreviewLabelContainer" class="mb-5 hidden">
                          <span id="cPreviewOptionLabel" class="option-badge inline-block text-[10px] font-bold uppercase tracking-widest px-4 py-1.5 rounded-full">Option A</span>
                      </div>

                      <span class="text-[11px] font-bold uppercase tracking-widest block mb-3" style="color: var(--text-muted);">You Get</span>
                      <span id="cPreviewAmount" class="amount-display block">$50,000</span>
                      
                      <!-- Amount Slider -->
                      <div class="mt-10 px-2 relative z-20">
                          <input id="clientAmountSlider" type="range" class="slider slider-dark w-full" />
                          <div class="flex justify-between text-[10px] font-bold mt-3 uppercase tracking-widest" style="color: var(--text-muted);">
                              <span>$5k</span>
                              <span id="clientMaxLabelSlider">Max</span>
                          </div>
                      </div>

                    </div>
                  </div>

                  <!-- Chart Section -->
                  <div class="px-8 py-10 flex items-center justify-center gap-8" style="background: linear-gradient(to bottom, var(--bg-card), var(--bg-option-card));">
                     <div class="relative w-36 h-36 flex-shrink-0">
                        <svg viewBox="0 0 36 36" class="circular-chart transform -rotate-90">
                          <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                          <path id="cPreviewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex flex-col items-center justify-center">
                          <span class="text-[10px] font-bold uppercase tracking-wide" style="color: var(--text-muted);">Payback</span>
                          <span id="cPreviewPayback" class="text-base font-bold block tracking-tight mt-0.5" style="color: var(--text-primary);">$62,500</span>
                        </div>
                     </div>
                     <div class="space-y-3 text-xs">
                         <div class="flex items-center gap-2.5">
                           <span class="w-3.5 h-3.5 rounded-full shadow-sm" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));"></span>
                           <span class="font-semibold" style="color: var(--text-secondary);">Principal</span>
                         </div>
                         <div class="flex items-center gap-2.5">
                           <span class="w-3.5 h-3.5 rounded-full" style="background: var(--chart-bg);"></span>
                           <span class="font-semibold" style="color: var(--text-secondary);">Cost of Capital</span>
                         </div>
                     </div>
                  </div>

                  <!-- Stats Grid -->
                  <div class="border-t" style="border-color: var(--border-secondary); background: var(--bg-option-card);">
                      <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                        <div class="stat-cell">
                          <span class="stat-label">Term Length</span>
                          <span id="cPreviewTerm" class="stat-value">6 months</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Payments</span>
                          <span id="cPreviewCount" class="stat-value">130</span>
                        </div>
                      </div>
                      <div class="stats-grid divide-x border-b" style="border-color: var(--border-secondary);">
                        <div class="stat-cell">
                          <span class="stat-label">Factor Rate</span>
                          <span id="cPreviewFactor" class="stat-value font-mono">1.19x</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Total Cost</span>
                          <span id="cPreviewCost" class="stat-value">$12,500</span>
                        </div>
                      </div>
                      
                      <div id="cPreviewFeeRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(251, 191, 36, 0.1);">
                        <div class="stat-cell">
                          <span class="stat-label">Origination Fee</span>
                          <span id="cPreviewFee" class="stat-value">$0</span>
                        </div>
                        <div class="stat-cell">
                          <span class="stat-label">Net Proceeds</span>
                          <span id="cPreviewNet" class="stat-value">$50,000</span>
                        </div>
                      </div>
                      
                      <div id="cPreviewPrepayRow" class="stats-grid divide-x border-b hidden" style="border-color: var(--border-secondary); background: rgba(34, 197, 94, 0.1);">
                        <div class="stat-cell" style="grid-column: span 2;">
                          <span class="stat-label">Prepay Discount</span>
                          <span id="cPreviewPrepay" class="stat-value" style="color: #22c55e;">10% off if paid early</span>
                        </div>
                      </div>

                      <!-- Payment Display - GRADIENT REMOVED -->
                      <div class="p-8 text-center" style="background: var(--bg-card);">
                          <div>
                              <span id="cPreviewPaymentLabel" class="text-[10px] font-bold block uppercase tracking-widest mb-2" style="color: var(--text-muted);">Daily Payment</span>
                              <span id="cPreviewPayment" class="text-3xl font-extrabold tracking-tight" style="color: var(--text-primary);">$480.77</span>
                          </div>
                      </div>
                  </div>

                  <!-- View Schedule Link -->
                  <div class="p-4 text-center border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                      <button onclick="openAmortSchedule()" class="text-xs font-bold flex items-center justify-center gap-1.5 mx-auto group transition-colors" style="color: var(--accent);">
                          <span>View Payment Schedule</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 group-hover:translate-x-1 transition-transform" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                      </button>
                  </div>

                  <!-- Accept Button -->
                  <div class="p-6 border-t" style="background: var(--bg-card); border-color: var(--border-secondary);">
                      <button onclick="acceptOffer()" class="btn btn-primary w-full py-4 rounded-xl text-base font-bold flex items-center justify-center gap-2.5">
                          <span>Accept Offer & Proceed</span>
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 8l4 4m0 0l-4 4m4-4H3" /></svg>
                      </button>
                      <p class="text-center text-[10px] mt-3 font-medium" style="color: var(--text-muted);">Clicking accept is non-binding.</p>
                  </div>

              </div>

              <!-- Terms & Documents - Separate Sections -->
              <div id="clientTermsContainer" class="mt-8 px-2 max-w-2xl mx-auto space-y-4 hidden">
                  
                  <!-- Notes & Documents - Side by Side -->
                  <div id="clientNotesDocsRow" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                      <!-- Notes Section -->
                      <div id="clientNotesSection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #3b82f6, #2563eb);"></div>
                              <h4 class="font-bold text-sm" style="color: var(--text-primary);">Offer Notes</h4>
                          </div>
                          <ul id="clientNotesList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>

                      <!-- Documents Section -->
                      <div id="clientDocsSection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                          <div class="flex items-center gap-3 mb-3">
                              <div class="section-indicator" style="background: linear-gradient(135deg, #8b5cf6, #7c3aed);"></div>
                              <h4 class="font-bold text-sm" style="color: var(--text-primary);">Closing Documents</h4>
                          </div>
                          <ul id="clientDocsList" class="space-y-2 text-sm pl-6" style="color: var(--text-secondary);"></ul>
                      </div>
                  </div>
                  
                  <!-- Expiration Section - At bottom -->
                  <div id="clientExpirySection" class="rounded-2xl p-5 hidden" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
                      <div class="flex items-center gap-3">
                          <div class="section-indicator" style="background: linear-gradient(135deg, #f59e0b, #d97706);"></div>
                          <p class="text-sm" style="color: var(--text-secondary);">This offer expires on <span id="clientExpiryDate" class="font-bold" style="color: var(--accent);">December 31, 2024</span></p>
                      </div>
                  </div>

              </div>

          </div>
      </div>

  </div>

  <!-- ========================================== -->
  <!-- MODALS                                     -->
  <!-- ========================================== -->
  
  <!-- Success Modal -->
  <div id="successModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-3xl w-full max-w-md shadow-2xl p-8 text-center relative overflow-hidden">
      <div class="absolute inset-0 pointer-events-none" style="background: linear-gradient(to bottom, var(--accent-glow), transparent);"></div>
      
      <div class="w-20 h-20 rounded-full flex items-center justify-center mx-auto mb-6 relative z-10 shadow-lg" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
      </div>
      
      <h3 class="text-2xl font-extrabold mb-3 relative z-10" style="color: var(--text-primary);">Offer Accepted!</h3>
      <p class="mb-8 relative z-10 text-sm leading-relaxed" style="color: var(--text-secondary);">Great news! Your pre-approval has been registered. Please contact your funding representative immediately to finalize the documents and receive your funds.</p>
      
      <div class="relative z-10">
          <button onclick="$('successModal').classList.add('hidden')" class="btn btn-primary w-full py-3.5 rounded-xl font-bold">
              Close
          </button>
      </div>
    </div>
  </div>

  <!-- Amortization Modal -->
  <div id="amortModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden max-h-[80vh] flex flex-col">
      <div class="p-5 border-b flex justify-between items-center" style="background: var(--bg-option-card); border-color: var(--border-primary);">
          <h3 class="font-bold" style="color: var(--text-primary);">Payment Schedule</h3>
          <button onclick="$('amortModal').classList.add('hidden')" class="p-1 rounded-lg transition-colors" style="color: var(--text-muted);" onmouseover="this.style.background='var(--bg-option-card)'" onmouseout="this.style.background='transparent'">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
      </div>
      <div class="overflow-y-auto p-0 flex-1">
          <table class="w-full text-sm amort-table">
              <thead>
                  <tr>
                      <th class="px-6 py-4 text-left">#</th>
                      <th class="px-6 py-4 text-left">Date</th>
                      <th class="px-6 py-4 text-right">Payment</th>
                      <th class="px-6 py-4 text-right">Balance</th>
                  </tr>
              </thead>
              <tbody id="amortTableBody" class="divide-y" style="border-color: var(--border-secondary);"></tbody>
          </table>
      </div>
    </div>
  </div>

  <!-- Share Modal -->
  <div id="shareModal" class="modal-overlay fixed inset-0 z-50 hidden flex items-center justify-center p-4">
    <div class="modal-content rounded-2xl w-full max-w-md shadow-2xl p-8 text-center">
      <div class="w-14 h-14 rounded-2xl flex items-center justify-center mx-auto mb-5 shadow-lg" style="background: linear-gradient(135deg, var(--accent-light), var(--accent));">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
      </div>
      <h3 class="text-xl font-extrabold mb-2" style="color: var(--text-primary);">Share Offer</h3>
      <p class="text-sm mb-8" style="color: var(--text-muted);">Create a link to send this funding scenario to your client.</p>
      <div class="grid grid-cols-2 gap-4 mb-6">
          <button onclick="copyLink()" class="btn btn-secondary py-4 rounded-xl flex flex-col items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg> 
              <span class="text-xs font-bold">Copy Link</span>
          </button>
          <button onclick="copyText()" class="btn btn-secondary py-4 rounded-xl flex flex-col items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" /></svg> 
              <span class="text-xs font-bold">Email Template</span>
          </button>
      </div>
      <button onclick="$('shareModal').classList.add('hidden')" class="text-sm font-semibold transition-colors" style="color: var(--text-muted);">Cancel</button>
    </div>
  </div>

  <!-- Upgrade Modal (shown when lite limit reached) -->
  <div id="upgradeModal" class="login-modal-overlay">
    <div class="login-modal rounded-2xl w-full max-w-md shadow-2xl p-8 text-center">
      <div class="w-16 h-16 rounded-2xl flex items-center justify-center mx-auto mb-6" style="background: linear-gradient(135deg, #f59e0b, #d97706);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
        </svg>
      </div>
      <h3 class="text-2xl font-extrabold mb-3" style="color: var(--text-primary);">Monthly Limit Reached</h3>
      <p class="text-sm mb-6" style="color: var(--text-secondary);">You've used all <strong>25 free shares</strong> this month. Upgrade to Pro for unlimited shares and white-label branding.</p>
      
      <div class="rounded-xl p-4 mb-6" style="background: var(--bg-card-inner); border: 1px solid var(--border-primary);">
        <div class="flex items-center justify-between mb-3">
          <span class="text-sm font-semibold" style="color: var(--text-muted);">LITE (Free)</span>
          <span class="text-sm font-bold" style="color: var(--text-muted);">Current</span>
        </div>
        <div class="flex items-center justify-between">
          <span class="text-sm font-semibold" style="color: var(--accent);">PRO</span>
          <span class="text-sm font-bold" style="color: var(--accent);">Unlimited + Branding</span>
        </div>
      </div>
      
      <button onclick="openLoginModal(); closeUpgradeModal();" class="btn btn-primary w-full py-4 rounded-xl font-bold mb-3">
        Sign In to Upgrade
      </button>
      <button onclick="closeUpgradeModal()" class="text-sm font-semibold transition-colors" style="color: var(--text-muted);">Maybe Later</button>
      
      <p class="text-xs mt-6" style="color: var(--text-muted);">Your limit resets on the 1st of each month.</p>
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast fixed bottom-6 right-6 text-white px-6 py-4 rounded-xl shadow-2xl z-50 flex items-center gap-3" style="background: var(--bg-card);">
    <div class="p-1.5 rounded-full" style="background: rgba(var(--accent-rgb), 0.2);">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" style="color: var(--accent);" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>
    </div>
    <span id="toastMessage" class="font-semibold text-sm">Success!</span>
  </div>

  <script>
    // ============================================
    // UTILITIES
    // ============================================
    const $ = (id) => document.getElementById(id);
    const $$ = (s) => document.querySelectorAll(s);
    const formatCurrency = (n) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0 }).format(n);
    const parseNumber = (v) => parseFloat(v.toString().replace(/[\$,]/g, '')) || 0;
    const formatNumber = (n) => new Intl.NumberFormat('en-US').format(n);
    const getLetter = (i) => String.fromCharCode(65 + i);

    // ============================================
    // THEME MANAGEMENT
    // ============================================
    let currentTheme = 'black';
    let currentAccent = 'rainbow';
    let currentLogoUrl = '';
    let currentCompanyName = '';
    let currentClientMode = 'iso';
    let lenderBuyRate = 1.15;
    let lenderMaxSellRate = 1.25;

    // Mobile collapsible sections
    function toggleMobileSection(cardId) {
        // Only toggle on mobile
        if (window.innerWidth > 768) return;
        
        const card = document.getElementById(cardId);
        if (card) {
            card.classList.toggle('collapsed');
        }
    }
    
    // Initialize mobile sections on load
    function initMobileSections() {
        if (window.innerWidth <= 768) {
            // Keep Structure Offer expanded by default on mobile
            const structureCard = document.getElementById('structureOfferCard');
            if (structureCard) {
                structureCard.classList.remove('collapsed');
            }
        }
    }
    
    // Re-check on resize
    window.addEventListener('resize', function() {
        const collapsibles = document.querySelectorAll('.mobile-collapsible');
        if (window.innerWidth > 768) {
            // Remove collapsed class on desktop
            collapsibles.forEach(el => el.classList.remove('collapsed'));
        }
    });

    function toggleThemeDropdown() {
        const dropdown = $('themeDropdown');
        dropdown.classList.toggle('open');
        
        // Close preview dropdown if open
        $('previewDropdown')?.classList.remove('open');
        
        // Sync tier preset inputs when opening
        if (dropdown.classList.contains('open')) {
            syncTierPresetInputs();
        }
        
        // Close when clicking outside
        if (dropdown.classList.contains('open')) {
            setTimeout(() => {
                document.addEventListener('click', closeThemeDropdownOnClickOutside);
            }, 10);
        }
    }
    
    function syncTierPresetInputs() {
        // Sync Tier A
        if ($('tierABuy')) $('tierABuy').value = LENDER_TIERS[1].buyRate.toFixed(2);
        if ($('tierAMax')) $('tierAMax').value = LENDER_TIERS[1].maxSell.toFixed(2);
        // Sync Tier B
        if ($('tierBBuy')) $('tierBBuy').value = LENDER_TIERS[2].buyRate.toFixed(2);
        if ($('tierBMax')) $('tierBMax').value = LENDER_TIERS[2].maxSell.toFixed(2);
        // Sync Tier C
        if ($('tierCBuy')) $('tierCBuy').value = LENDER_TIERS[3].buyRate.toFixed(2);
        if ($('tierCMax')) $('tierCMax').value = LENDER_TIERS[3].maxSell.toFixed(2);
    }

    function closeThemeDropdownOnClickOutside(e) {
        const dropdown = $('themeDropdown');
        const picker = document.querySelector('.theme-picker');
        if (!picker.contains(e.target)) {
            dropdown.classList.remove('open');
            document.removeEventListener('click', closeThemeDropdownOnClickOutside);
        }
    }
    
    function togglePreviewDropdown() {
        const dropdown = $('previewDropdown');
        dropdown.classList.toggle('open');
        
        // Close theme dropdown if open
        $('themeDropdown')?.classList.remove('open');
        
        // Close when clicking outside
        if (dropdown.classList.contains('open')) {
            setTimeout(() => {
                document.addEventListener('click', closePreviewDropdownOnClickOutside);
            }, 10);
        }
    }

    function closePreviewDropdownOnClickOutside(e) {
        const dropdown = $('previewDropdown');
        const picker = document.querySelector('.preview-picker');
        if (!picker.contains(e.target)) {
            dropdown.classList.remove('open');
            document.removeEventListener('click', closePreviewDropdownOnClickOutside);
        }
    }

    function setThemeMode(mode) {
        currentTheme = mode;
        const html = document.documentElement;
        html.classList.remove('theme-light', 'theme-dark', 'theme-black');
        html.classList.add(`theme-${mode}`);
        
        // Update mode buttons
        $$('.theme-mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === mode);
        });
        
        saveThemePreference();
        updateSliders();
    }

    function setAccentColor(accent) {
        currentAccent = accent;
        const html = document.documentElement;
        
        // Clear any existing rainbow interval
        if (window.rainbowInterval) {
            clearInterval(window.rainbowInterval);
            window.rainbowInterval = null;
        }
        
        // Remove all accent classes
        html.classList.remove('accent-mint', 'accent-blue', 'accent-purple', 'accent-rainbow', 'accent-orange', 'accent-cyan', 'accent-gold', 'accent-slate', 'accent-lime', 'accent-teal', 'accent-pink', 'accent-indigo', 'rainbow-mode');
        
        if (accent === 'rainbow') {
            // Rainbow mode - cycle through colors
            html.classList.add('rainbow-mode');
            const rainbowColors = ['mint', 'blue', 'purple', 'orange', 'cyan', 'gold', 'slate', 'lime', 'teal', 'pink', 'indigo'];
            let colorIndex = 0;
            
            const applyColor = () => {
                html.classList.remove('accent-mint', 'accent-blue', 'accent-purple', 'accent-orange', 'accent-cyan', 'accent-gold', 'accent-slate', 'accent-lime', 'accent-teal', 'accent-pink', 'accent-indigo');
                html.classList.add(`accent-${rainbowColors[colorIndex]}`);
                colorIndex = (colorIndex + 1) % rainbowColors.length;
            };
            
            applyColor();
            window.rainbowInterval = setInterval(applyColor, 4000);
        } else {
            html.classList.add(`accent-${accent}`);
        }
        
        // Update swatches
        $$('.color-swatch').forEach(swatch => {
            swatch.classList.toggle('active', swatch.dataset.accent === accent);
        });
        
        saveThemePreference();
        updateSliders();
    }

    // Welcome screen mode toggle
    function setClientModeWelcome(mode) {
        // Update welcome toggle buttons
        const isoBtn = $('welcomeIsoModeBtn');
        const lenderBtn = $('welcomeLenderModeBtn');
        if (isoBtn) isoBtn.classList.toggle('active', mode === 'iso');
        if (lenderBtn) lenderBtn.classList.toggle('active', mode === 'lender');
        
        // Store for use after login
        window.pendingClientMode = mode;
    }

    function setClientMode(mode) {
        currentClientMode = mode;
        
        // Update mode toggle buttons
        const isoBtn = $('isoModeBtn');
        const lenderBtn = $('lenderModeBtn');
        if (isoBtn) isoBtn.classList.toggle('active', mode === 'iso');
        if (lenderBtn) lenderBtn.classList.toggle('active', mode === 'lender');
        
        // Also sync welcome screen toggle
        const welcomeIsoBtn = $('welcomeIsoModeBtn');
        const welcomeLenderBtn = $('welcomeLenderModeBtn');
        if (welcomeIsoBtn) welcomeIsoBtn.classList.toggle('active', mode === 'iso');
        if (welcomeLenderBtn) welcomeLenderBtn.classList.toggle('active', mode === 'lender');
        
        // Hide factor rate card in both modes (controlled by lender rates)
        const factorRateCard = $('factorRateCard');
        if (factorRateCard) factorRateCard.classList.add('hidden');
        
        // Show/hide ISO preview option in dropdown (only visible in lender mode)
        const isoPreviewOption = $('isoPreviewOption');
        if (isoPreviewOption) {
            isoPreviewOption.classList.toggle('hidden', mode !== 'lender');
        }
        
        // Show/hide sections based on mode
        const lenderRateSection = $('lenderRateSection');
        const isoUpsellSection = $('isoUpsellSection');
        const lenderSettings = $('lenderRateSettings');
        
        if (mode === 'lender') {
            if (lenderRateSection) lenderRateSection.classList.remove('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
            if (lenderSettings) lenderSettings.classList.remove('hidden');
            updateLenderDisplay();
        } else {
            // ISO mode - set factor rate to max sell rate
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            
            // Check if this is a shared link (restricted range) or direct ISO login (full range)
            if (window.isoShareMode) {
                // Shared link: use the buy/max rates from URL params
                const maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
                const buyRate = parseFloat($('lenderBuyRate')?.value) || parseFloat($('buyRateInput')?.value) || 1.15;
                
                if (sellSlider) {
                    sellSlider.min = buyRate;
                    sellSlider.max = maxSell;
                    sellSlider.value = maxSell;
                    updateSliderFill(sellSlider);
                }
                if (sellInput) {
                    sellInput.value = maxSell.toFixed(2);
                }
                
                if ($('calcFactor')) $('calcFactor').value = maxSell;
                if ($('calcFactorSlider')) $('calcFactorSlider').value = maxSell;
            } else {
                // Direct ISO login: give full range 1.05-1.70
                const defaultRate = 1.25;
                
                if (sellSlider) {
                    sellSlider.min = 1.05;
                    sellSlider.max = 1.70;
                    sellSlider.value = defaultRate;
                    updateSliderFill(sellSlider);
                }
                if (sellInput) {
                    sellInput.value = defaultRate.toFixed(2);
                }
                
                // Update global vars for ISO calculations
                lenderBuyRate = 1.05;
                lenderMaxSellRate = 1.70;
                
                if ($('calcFactor')) $('calcFactor').value = defaultRate;
                if ($('calcFactorSlider')) $('calcFactorSlider').value = defaultRate;
            }
            
            updateSliderFill($('calcFactorSlider'));
            
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            if (lenderSettings) lenderSettings.classList.add('hidden');
            // Show ISO upsell section in ISO mode
            if (isoUpsellSection) isoUpsellSection.classList.remove('hidden');
            
            // Update ISO upsell display
            updateIsoUpsell();
        }
        
        updatePreview();
    }
    
    // Tier presets for lender mode (mutable for customization)
    let LENDER_TIERS = {
        1: { buyRate: 1.15, maxSell: 1.25 },
        2: { buyRate: 1.25, maxSell: 1.35 },
        3: { buyRate: 1.35, maxSell: 1.45 }
    };
    
    // Map tier letters to numbers
    const TIER_MAP = { 'A': 1, 'B': 2, 'C': 3 };
    
    function updateTierPreset(tierLetter) {
        const tierNum = TIER_MAP[tierLetter];
        const buyInput = $('tier' + tierLetter + 'Buy');
        const maxInput = $('tier' + tierLetter + 'Max');
        
        if (!buyInput || !maxInput) return;
        
        let buyRate = parseFloat(buyInput.value) || 1.15;
        let maxSell = parseFloat(maxInput.value) || 1.25;
        
        // Enforce minimum spread
        if (maxSell <= buyRate + 0.04) {
            maxSell = buyRate + 0.05;
            maxInput.value = maxSell.toFixed(2);
        }
        
        // Update the tier preset
        LENDER_TIERS[tierNum] = { buyRate, maxSell };
        
        // Update the tier button display
        const tierBtn = $('tierBtn' + tierNum);
        if (tierBtn) {
            const rateDisplay = tierBtn.querySelector('span:last-child');
            if (rateDisplay) {
                rateDisplay.textContent = buyRate.toFixed(2) + ' / ' + maxSell.toFixed(2);
            }
        }
        
        // If this tier is currently active, update the rates
        if (tierBtn && tierBtn.classList.contains('active')) {
            setLenderTier(tierNum);
        }
    }
    
    function clearTierSelection() {
        for (let i = 1; i <= 3; i++) {
            const btn = $('tierBtn' + i);
            if (btn) {
                btn.classList.remove('active');
                btn.style.borderColor = 'var(--border-primary)';
            }
        }
    }
    
    function setLenderTier(tier) {
        const preset = LENDER_TIERS[tier];
        if (!preset) return;
        
        // Update tier button states
        for (let i = 1; i <= 3; i++) {
            const btn = $('tierBtn' + i);
            if (btn) {
                btn.classList.toggle('active', i === tier);
                btn.style.borderColor = i === tier ? 'var(--accent)' : 'var(--border-primary)';
            }
        }
        
        // Update buy rate
        if ($('lenderBuyRate')) $('lenderBuyRate').value = preset.buyRate;
        if ($('lenderBuyRateSlider')) $('lenderBuyRateSlider').value = preset.buyRate;
        if ($('buyRateInput')) $('buyRateInput').value = preset.buyRate;
        if ($('buyRateSlider')) $('buyRateSlider').value = preset.buyRate;
        
        // Update max sell rate
        if ($('lenderMaxSell')) $('lenderMaxSell').value = preset.maxSell;
        if ($('lenderMaxSellSlider')) $('lenderMaxSellSlider').value = preset.maxSell;
        if ($('maxSellRateInput')) $('maxSellRateInput').value = preset.maxSell;
        if ($('maxSellRateSlider')) $('maxSellRateSlider').value = preset.maxSell;
        
        // Update display and recalculate
        updateLenderDisplay();
        updatePreview();
    }
    
    function updateLenderDisplay() {
        const buyRate = parseFloat($('lenderBuyRate')?.value) || 1.15;
        const maxSell = parseFloat($('lenderMaxSell')?.value) || 1.25;
        const fundingAmount = parseFloat($('calcAmount').value.replace(/[,$]/g, '')) || 0;
        
        // Update global vars
        lenderBuyRate = buyRate;
        lenderMaxSellRate = maxSell;
        
        // Calculate max spread and profit
        const maxSpread = maxSell - buyRate;
        const maxProfit = fundingAmount * maxSpread;
        
        if ($('lenderMaxSpread')) $('lenderMaxSpread').textContent = maxSpread.toFixed(2);
        if ($('lenderMaxProfit')) $('lenderMaxProfit').textContent = '$' + maxProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        
        // Sync factor rate with buy rate in lender mode
        if ($('calcFactor')) $('calcFactor').value = buyRate;
        if ($('calcFactorSlider')) {
            $('calcFactorSlider').value = buyRate;
            updateSliderFill($('calcFactorSlider'));
        }
    }
    
    function shareWithISO() {
        const buyRate = parseFloat($('lenderBuyRate')?.value) || 1.15;
        const maxSell = parseFloat($('lenderMaxSell')?.value) || 1.25;
        
        // Build URL with parameters
        const baseUrl = window.location.origin + window.location.pathname;
        const params = new URLSearchParams();
        params.set('iso', '1');
        params.set('buy', buyRate.toFixed(2));
        params.set('max', maxSell.toFixed(2));
        
        const shareUrl = baseUrl + '?' + params.toString();
        
        // Save to dashboard (ISO rate share)
        saveISOShareToDashboard(shareUrl, buyRate, maxSell);
        
        // Copy to clipboard
        navigator.clipboard.writeText(shareUrl).then(() => {
            showToast('ISO link copied to clipboard!');
        }).catch(() => {
            // Fallback
            prompt('Copy this ISO link:', shareUrl);
        });
    }
    
    // Save ISO rate share to dashboard (for lenders)
    function saveISOShareToDashboard(link, buyRate, maxSell) {
        const offers = getStoredOffers();
        
        const offer = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            businessName: 'ISO Rate Share',
            contactName: '',
            amount: 0,
            factor: maxSell,
            buyRate: buyRate,
            term: 0,
            frequency: 'daily',
            payment: 0,
            totalPayback: 0,
            optionCount: 0,
            link: link,
            status: 'pending',
            createdAt: new Date().toISOString(),
            mode: 'lender',
            isISOShare: true // Flag to identify ISO rate shares
        };
        
        offers.unshift(offer);
        
        if (offers.length > 100) {
            offers.splice(100);
        }
        
        saveStoredOffers(offers);
        updateOfferCount();
    }
    
    function checkISOShareMode() {
        const params = new URLSearchParams(window.location.search);
        
        if (params.get('iso') === '1') {
            window.isoShareMode = true;
            
            const buyRate = parseFloat(params.get('buy')) || 1.15;
            const maxSell = parseFloat(params.get('max')) || 1.25;
            
            lenderBuyRate = buyRate;
            lenderMaxSellRate = maxSell;
            
            // Set up ISO upsell slider
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            
            if (sellSlider && sellInput) {
                sellSlider.min = buyRate;
                sellSlider.max = maxSell;
                
                // Default to max sell rate
                sellSlider.value = maxSell;
                sellInput.value = maxSell.toFixed(2);
                
                updateSliderFill(sellSlider);
            }
            
            // Update display
            if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = buyRate.toFixed(2);
            
            // Show ISO section, hide lender section
            const isoUpsellSection = $('isoUpsellSection');
            const lenderRateSection = $('lenderRateSection');
            
            if (isoUpsellSection) isoUpsellSection.classList.remove('hidden');
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            
            // Set factor rate to max sell rate (ISO's default sell rate)
            if ($('calcFactor')) {
                $('calcFactor').value = maxSell;
                $('calcFactor').disabled = true;
            }
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSell;
                $('calcFactorSlider').disabled = true;
            }
            
            // Force ISO client mode in menu
            setClientMode('iso');
            
            // Update ISO profit display
            updateIsoUpsell();
            
            showToast('ISO Mode: Adjust your sell rate below');
        }
    }
    
    function updateLenderRates() {
        clearTierSelection();
        // Get values from theme menu inputs
        let buyFromMenu = parseFloat($('buyRateInput')?.value) || 1.15;
        let maxFromMenu = parseFloat($('maxSellRateInput')?.value) || 1.25;
        
        // Enforce minimum spread of 0.05 between buy and max sell
        if (maxFromMenu <= buyFromMenu + 0.04) {
            // Determine which one was just changed by comparing to current slider values
            const currentBuy = parseFloat($('lenderBuyRate')?.value) || 1.15;
            const currentMax = parseFloat($('lenderMaxSell')?.value) || 1.25;
            
            // If buy rate changed more, adjust max sell up
            if (Math.abs(buyFromMenu - currentBuy) > Math.abs(maxFromMenu - currentMax)) {
                maxFromMenu = Math.min(buyFromMenu + 0.05, 1.70);
                if ($('maxSellRateInput')) $('maxSellRateInput').value = maxFromMenu.toFixed(2);
            } else {
                // Max sell changed more, adjust buy rate down
                buyFromMenu = Math.max(maxFromMenu - 0.05, 1.05);
                if ($('buyRateInput')) $('buyRateInput').value = buyFromMenu.toFixed(2);
            }
        }
        
        // Sync to calculator area sliders
        if ($('lenderBuyRate')) {
            $('lenderBuyRate').value = buyFromMenu;
            if ($('lenderBuyRateSlider')) {
                $('lenderBuyRateSlider').value = buyFromMenu;
                updateSliderFill($('lenderBuyRateSlider'));
            }
        }
        if ($('lenderMaxSell')) {
            $('lenderMaxSell').value = maxFromMenu;
            if ($('lenderMaxSellSlider')) {
                $('lenderMaxSellSlider').value = maxFromMenu;
                updateSliderFill($('lenderMaxSellSlider'));
            }
        }
        
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxFromMenu;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxFromMenu;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        
        updateLenderDisplay();
    }
    
    function updateIsoUpsell() {
        const sellRate = parseFloat($('isoSellRate')?.value) || lenderBuyRate;
        const fundingAmount = parseFloat($('calcAmount').value.replace(/[,$]/g, '')) || 0;
        
        const spread = sellRate - lenderBuyRate;
        const isoProfit = fundingAmount * spread;
        
        if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = lenderBuyRate.toFixed(2);
        if ($('isoSpreadDisplay')) $('isoSpreadDisplay').textContent = spread.toFixed(2);
        if ($('isoProfitDisplay')) $('isoProfitDisplay').textContent = '$' + isoProfit.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        
        // When in ISO mode, the sell rate becomes the client's factor rate
        if (currentClientMode === 'iso' || window.isoShareMode || window.isoPreviewMode) {
            if ($('calcFactor')) $('calcFactor').value = sellRate;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = sellRate;
                updateSliderFill($('calcFactorSlider'));
            }
            
            // Update preview without triggering another updateIsoUpsell
            window._skipIsoUpdate = true;
            updatePreview();
            window._skipIsoUpdate = false;
        }
    }

    function updateLogoPreview(url) {
        currentLogoUrl = url ? url.trim() : '';
        const previewSmall = $('logoPreviewSmall');
        const clearBtn = $('clearLogoBtn');
        const previewContainer = $('previewLogoContainer');
        const previewLogo = $('previewLogo');
        
        if (currentLogoUrl) {
            // Display directly in small preview
            previewSmall.innerHTML = `<img src="${currentLogoUrl}" alt="Logo Preview" onload="this.style.opacity=1" onerror="this.parentElement.innerHTML='<span class=\\'logo-preview-placeholder\\'>Unable to load</span>'" style="opacity:0; transition: opacity 0.2s;" />`;
            clearBtn.classList.remove('hidden');
            
            // Show in main preview card
            previewLogo.src = currentLogoUrl;
            previewLogo.onload = function() {
                previewContainer.classList.remove('hidden');
            };
            previewLogo.onerror = function() {
                previewContainer.classList.add('hidden');
            };
            
            saveThemePreference();
        } else {
            previewSmall.innerHTML = '<span class="logo-preview-placeholder">Logo preview will appear here</span>';
            clearBtn.classList.add('hidden');
            previewContainer.classList.add('hidden');
        }
    }

    function clearLogo() {
        $('logoUrlInput').value = '';
        updateLogoPreview('');
    }

    function updateCompanyName(name) {
        currentCompanyName = name.trim();
        const previewName = $('previewCompanyName');
        const cPreviewName = $('cPreviewCompanyName');
        
        if (currentCompanyName) {
            previewName.textContent = currentCompanyName;
            previewName.classList.remove('hidden');
            cPreviewName.textContent = currentCompanyName;
            cPreviewName.classList.remove('hidden');
        } else {
            previewName.classList.add('hidden');
            cPreviewName.classList.add('hidden');
        }
        
        saveThemePreference();
    }

    function saveThemePreference() {
        localStorage.setItem('fundingCalcTheme', JSON.stringify({
            mode: currentTheme,
            accent: currentAccent,
            logoUrl: currentLogoUrl,
            companyName: currentCompanyName
        }));
    }

    function loadThemePreference() {
        const saved = localStorage.getItem('fundingCalcTheme');
        if (saved) {
            try {
                const pref = JSON.parse(saved);
                if (pref.mode) setThemeMode(pref.mode);
                if (pref.accent) setAccentColor(pref.accent);
                if (pref.logoUrl) {
                    $('logoUrlInput').value = pref.logoUrl;
                    updateLogoPreview(pref.logoUrl);
                }
                if (pref.companyName) {
                    $('companyNameInput').value = pref.companyName;
                    updateCompanyName(pref.companyName);
                }
            } catch (e) {
                console.error('Failed to load theme preference', e);
            }
        } else {
            // Default to black theme
            setThemeMode('black');
        }
        
        // Set initial active states
        $$('.theme-mode-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.mode === currentTheme);
        });
        $$('.color-swatch').forEach(swatch => {
            swatch.classList.toggle('active', swatch.dataset.accent === currentAccent);
        });
    }

    function resetBrandKit() {
        // Reset to defaults
        setThemeMode('black');
        setAccentColor('rainbow');
        setClientMode('iso');
        
        // Clear brand fields
        currentLogoUrl = '';
        currentCompanyName = '';
        $('logoUrlInput').value = '';
        $('companyNameInput').value = '';
        
        // Reset logo preview
        const previewSmall = $('logoPreviewSmall');
        previewSmall.innerHTML = '<span class="logo-preview-placeholder">Logo preview will appear here</span>';
        $('clearLogoBtn').classList.add('hidden');
        $('previewLogoContainer').classList.add('hidden');
        
        // Reset company name in preview
        const companyNameEl = $('previewCompanyName');
        if (companyNameEl) {
            companyNameEl.textContent = '';
            companyNameEl.classList.add('hidden');
        }
        
        // Clear localStorage
        localStorage.removeItem('fundingCalcTheme');
        
        showToast('Theme Reset');
    }

    // ============================================
    // AUTHENTICATION
    // ============================================
    const VALID_USERS = {
        'sutton': 'nouns'
    };
    
    // ============================================
    // LITE VERSION USAGE TRACKING
    // ============================================
    const LITE_MONTHLY_LIMIT = 25;
    
    function getLiteUsage() {
        try {
            const data = JSON.parse(localStorage.getItem('trustbureau_lite_usage') || '{}');
            const currentMonth = new Date().toISOString().slice(0, 7); // YYYY-MM
            
            // Reset if new month
            if (data.month !== currentMonth) {
                return { month: currentMonth, count: 0 };
            }
            return data;
        } catch (e) {
            return { month: new Date().toISOString().slice(0, 7), count: 0 };
        }
    }
    
    function saveLiteUsage(data) {
        localStorage.setItem('trustbureau_lite_usage', JSON.stringify(data));
    }
    
    function incrementLiteUsage() {
        const usage = getLiteUsage();
        usage.count++;
        saveLiteUsage(usage);
        updateLiteUsageUI();
        return usage.count;
    }
    
    function canUseLiteShare() {
        if (currentUser) return true; // Logged in users have unlimited
        const usage = getLiteUsage();
        return usage.count < LITE_MONTHLY_LIMIT;
    }
    
    function getRemainingLiteShares() {
        if (currentUser) return Infinity;
        const usage = getLiteUsage();
        return Math.max(0, LITE_MONTHLY_LIMIT - usage.count);
    }
    
    function updateLiteUsageUI() {
        const badge = $('liteUsageBadge');
        const remaining = getRemainingLiteShares();
        
        if (currentUser) {
            // Hide for logged in users
            if (badge) badge.classList.add('hidden');
            return;
        }
        
        if (badge) {
            badge.classList.remove('hidden');
            badge.textContent = remaining;
            
            // Change color when low (5 or less)
            if (remaining <= 5) {
                badge.classList.add('low');
            } else {
                badge.classList.remove('low');
            }
        }
    }
    
    function showUpgradeModal() {
        $('upgradeModal').classList.add('open');
    }
    
    function closeUpgradeModal() {
        $('upgradeModal').classList.remove('open');
    }
    
    let currentUser = null;

    function handleWelcomeLogin() {
        const username = $('welcomeUsername').value.trim();
        const password = $('welcomePassword').value;
        
        // Accept any username/password as long as password ends with !#
        if (username && password.endsWith('!#')) {
            currentUser = username;
            localStorage.setItem('fundingCalcUser', username);
            hideWelcomeScreen();
            updateAuthUI();
            showToast(`Welcome, ${username}!`);
        } else {
            $('welcomeError').classList.add('show');
            $('welcomePassword').value = '';
            $('welcomePassword').focus();
        }
    }

    function continueAsFree() {
        // Log out and reset to defaults
        currentUser = null;
        localStorage.removeItem('fundingCalcUser');
        resetBrandKit();
        hideWelcomeScreen();
        updateAuthUI();
    }

    function hideWelcomeScreen() {
        $('welcomeScreen').classList.add('hidden');
        
        // Apply the mode selected on welcome screen
        if (window.pendingClientMode) {
            setClientMode(window.pendingClientMode);
            window.pendingClientMode = null;
        }
    }

    function showWelcomeScreen() {
        $('welcomeScreen').classList.remove('hidden');
        $('welcomeUsername').value = '';
        $('welcomePassword').value = '';
        $('welcomeError').classList.remove('show');
    }

    function openLoginModal() {
        $('loginModal').classList.add('open');
        $('loginUsername').focus();
        $('loginError').classList.remove('show');
        $('loginUsername').value = '';
        $('loginPassword').value = '';
        $('loginPassword').type = 'password';
        $('eyeIcon').innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
    }

    function closeLoginModal() {
        $('loginModal').classList.remove('open');
    }

    function togglePasswordVisibility() {
        const passwordInput = $('loginPassword');
        const eyeIcon = $('eyeIcon');
        if (passwordInput.type === 'password') {
            passwordInput.type = 'text';
            eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M3.98 8.223A10.477 10.477 0 001.934 12C3.226 16.338 7.244 19.5 12 19.5c.993 0 1.953-.138 2.863-.395M6.228 6.228A10.45 10.45 0 0112 4.5c4.756 0 8.773 3.162 10.065 7.498a10.523 10.523 0 01-4.293 5.774M6.228 6.228L3 3m3.228 3.228l3.65 3.65m7.894 7.894L21 21m-3.228-3.228l-3.65-3.65m0 0a3 3 0 10-4.243-4.243m4.242 4.242L9.88 9.88" />';
        } else {
            passwordInput.type = 'password';
            eyeIcon.innerHTML = '<path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /><path stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />';
        }
    }

    function handleLogin() {
        const username = $('loginUsername').value.trim();
        const password = $('loginPassword').value;
        
        // Accept any username/password as long as password ends with !#
        if (username && password.endsWith('!#')) {
            currentUser = username;
            localStorage.setItem('fundingCalcUser', username);
            closeLoginModal();
            updateAuthUI();
            showToast(`Welcome back, ${username}!`);
        } else {
            // Failed
            $('loginError').classList.add('show');
            $('loginPassword').value = '';
            $('loginPassword').focus();
        }
    }

    function handleLogout() {
        currentUser = null;
        localStorage.removeItem('fundingCalcUser');
        updateAuthUI();
        showToast('Logged out successfully');
    }

    function updateAuthUI() {
        const brandSection = $('brandSection');
        const userBadge = $('userBadge');
        const userBadgeName = $('userBadgeName');
        
        if (currentUser) {
            // Logged in - unlock brand section
            brandSection.classList.remove('locked');
            userBadge.classList.remove('hidden');
            userBadgeName.textContent = currentUser;
        } else {
            // Logged out - lock brand section
            brandSection.classList.add('locked');
            userBadge.classList.add('hidden');
        }
        
        // Update lite usage display
        updateLiteUsageUI();
    }

    function loadAuthState() {
        const savedUser = localStorage.getItem('fundingCalcUser');
        
        if (savedUser) {
            currentUser = savedUser;
        }
        // Welcome screen always shows on page load
        // User must sign in or continue as free each session
        
        updateAuthUI();
    }

    // Keyboard handlers for modals and welcome screen
    document.addEventListener('keydown', (e) => {
        // Welcome screen - Enter to login
        if (e.key === 'Enter' && !$('welcomeScreen').classList.contains('hidden')) {
            const active = document.activeElement;
            if (active && (active.id === 'welcomeUsername' || active.id === 'welcomePassword')) {
                handleWelcomeLogin();
            }
        }
        // Login modal - Escape to close, Enter to submit
        if (e.key === 'Escape' && $('loginModal').classList.contains('open')) {
            closeLoginModal();
        }
        if (e.key === 'Enter' && $('loginModal').classList.contains('open')) {
            const active = document.activeElement;
            if (active && (active.id === 'loginUsername' || active.id === 'loginPassword')) {
                handleLogin();
            }
        }
    });

    // ============================================
    // STATE
    // ============================================
    let calcOptions = [];
    let activeCalcTab = 0;
    let clientData = null;
    let clientActiveIdx = 0;
    let clientSelectedAmount = 0;

    // ============================================
    // CORE CALCULATION
    // ============================================
    function calculate(a, f, t, fr, fe) { 
        const tp = a * f; 
        const tc = tp - a; 
        const p = tp / t; 
        const fa = a * (fe / 100); 
        const net = a - fa; 
        return { amount: a, factor: f, term: t, frequency: fr, fee: fe, feeAmount: fa, net: net, totalPayback: tp, totalCost: tc, payment: p }; 
    }

    // ============================================
    // ADMIN LOGIC
    // ============================================
    function initDefaultOption() { 
        return { amount: 50000, factor: 1.19, term: 130, frequency: 'daily', fee: 0, prepay: 0, termOverride: '', notes: '', docs: false, docsText: "Voided Check\nGovernment Issued ID" }; 
    }

    function addCalcOption() { 
        if (calcOptions.length >= 3) return; 
        const p = calcOptions[calcOptions.length - 1] || initDefaultOption(); 
        calcOptions.push({ ...p }); 
        updateTabsUI(); 
        switchCalcTab(calcOptions.length - 1); 
    }

    function removeCalcOption() { 
        if (calcOptions.length <= 1) return; 
        calcOptions.splice(activeCalcTab, 1); 
        if (activeCalcTab >= calcOptions.length) activeCalcTab = calcOptions.length - 1; 
        updateTabsUI(); 
        switchCalcTab(activeCalcTab); 
    }

    function switchCalcTab(i) { 
        saveState(activeCalcTab); 
        activeCalcTab = i; 
        updateTabsUI(); 
        loadState(activeCalcTab); 
        updatePreview(); 
        updateSliders(); 
    }
    
    function updateTabsUI() { 
        for(let i=0; i<3; i++) { 
            const b = $(`tab-btn-${i}`); 
            if (i < calcOptions.length) { 
                b.classList.remove('hidden'); 
                b.classList.toggle('active', i === activeCalcTab); 
                b.textContent = `Option ${getLetter(i)}`;
            } else { 
                b.classList.add('hidden'); 
            } 
        } 
        $('add-tab-btn').classList.toggle('hidden', calcOptions.length >= 3); 
        $('remove-option-btn').classList.toggle('hidden', calcOptions.length <= 1); 
    }

    function getVal(id, num=false) { 
        const el = $(id); 
        if (!el) return num ? 0 : ''; 
        if (num) return parseNumber(el.value); 
        return el.value.trim(); 
    }

    function setVal(id, v) { 
        if($(id)) $(id).value = v; 
    }

    function saveState(i) { 
        if (!calcOptions[i]) return; 
        const freqBtn = document.querySelector('.toggle-btn.active');
        const fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        
        calcOptions[i] = { 
            amount: getVal('calcAmount', true), 
            factor: getVal('calcFactor', true), 
            term: getVal('calcTerm', true), 
            frequency: fr, 
            fee: $('toggleFee').checked ? getVal('calcFee', true) : 0, 
            prepay: $('togglePrepay').checked ? getVal('calcPrepay', true) : 0,
            prepayDate: getVal('calcPrepayDate'),
            termOverride: $('toggleOverride').checked ? getVal('calcTermOverride') : '', 
            notes: $('toggleNotes').checked ? getVal('calcNotes') : '',
            expiry: $('toggleExpiry').checked,
            expiryDate: getVal('calcExpiryDate'),
            docs: $('toggleDocs').checked,
            docsText: getVal('calcDocs')
        }; 
    }

    function loadState(i) { 
        const o = calcOptions[i]; 
        if (!o) return; 
        
        setVal('calcAmount', formatNumber(o.amount)); setVal('calcAmountSlider', o.amount); 
        setVal('calcFactor', o.factor); setVal('calcFactorSlider', o.factor); 
        setVal('calcTerm', o.term); setVal('calcTermSlider', o.term); 
        
        const hf = o.fee > 0; $('toggleFee').checked = hf; toggleSection('Fee', hf); if(hf) { setVal('calcFee', o.fee); setVal('calcFeeSlider', o.fee); }
        const hp = o.prepay > 0; $('togglePrepay').checked = hp; toggleSection('Prepay', hp); if(hp) { setVal('calcPrepay', o.prepay); setVal('calcPrepaySlider', o.prepay); } if(o.prepayDate) setVal('calcPrepayDate', o.prepayDate);
        const ho = !!o.termOverride; $('toggleOverride').checked = ho; toggleSection('Override', ho); if(ho) setVal('calcTermOverride', o.termOverride);
        const hn = !!o.notes; $('toggleNotes').checked = hn; toggleSection('Notes', hn); if(hn) setVal('calcNotes', o.notes);
        const he = !!o.expiry; $('toggleExpiry').checked = he; toggleSection('Expiry', he); if(o.expiryDate) setVal('calcExpiryDate', o.expiryDate);
        
        const hd = !!o.docs;
        $('toggleDocs').checked = hd;
        toggleSection('Docs', hd);
        setVal('calcDocs', o.docsText || "Voided Check\nGovernment Issued ID");
        
        setFrequency(o.frequency);
    }

    function updatePreview() {
        const a = getVal('calcAmount', true); 
        const f = getVal('calcFactor', true) || 1.15; 
        const t = getVal('calcTerm', true) || 130;
        const freqBtn = document.querySelector('.toggle-btn.active');
        const fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        
        const fe = $('toggleFee').checked ? (getVal('calcFee', true) || 0) : 0;
        const c = calculate(a, f, t, fr, fe);
        
        // Update ISO profit if in lender mode or ISO share/preview mode
        if ((currentClientMode === 'lender' || window.isoShareMode || window.isoPreviewMode) && !window._skipIsoUpdate) {
            updateIsoUpsell();
        }
        
        const bn = getVal('calcBusinessName');
        if(bn) { 
            $('previewBusinessName').textContent = bn; 
            $('previewBusinessName').classList.remove('hidden'); 
        } else { 
            $('previewBusinessName').classList.add('hidden'); 
        }
        
        if (calcOptions.length > 1) {
            $('previewLabelContainer').classList.remove('hidden');
            $('previewOptionLabel').textContent = `Option ${getLetter(activeCalcTab)}`;
        } else {
            $('previewLabelContainer').classList.add('hidden');
        }

        $('previewAmount').textContent = formatCurrency(c.amount); 
        $('previewPaybackChart').textContent = formatCurrency(c.totalPayback);
        
        const to = $('toggleOverride').checked ? getVal('calcTermOverride') : '';
        let tm = t; if(fr === 'weekly') tm = t / 4.33; else if (fr === 'daily') tm = t / 21;
        const monthLabel = Math.round(tm * 2) / 2 + ' months';

        $('previewTermLength').textContent = to ? to : monthLabel; 
        $('previewTermPayments').textContent = c.term; 
        $('previewFactor').textContent = c.factor.toFixed(2) + 'x'; 
        $('previewCost').textContent = formatCurrency(c.totalCost);
        
        const pLabel = fr === 'weekly' ? 'Weekly Payment' : fr === 'monthly' ? 'Monthly Payment' : 'Daily Payment';
        $('previewPaymentLabel').textContent = pLabel;
        $('previewPayment').textContent = formatCurrency(c.payment);
        
        if (fe > 0) { $('previewFeeRow').classList.remove('hidden'); $('previewFeeAmount').textContent = formatCurrency(c.feeAmount); $('previewNet').textContent = formatCurrency(c.net); } else { $('previewFeeRow').classList.add('hidden'); }
        
        // Prepay discount
        const prepayVal = $('togglePrepay').checked ? getVal('calcPrepay', true) : 0;
        if (prepayVal > 0) {
            $('previewPrepayRow').classList.remove('hidden');
            const prepayDate = getVal('calcPrepayDate');
            if (prepayDate) {
                $('previewPrepay').textContent = prepayVal + '% off if paid by ' + new Date(prepayDate).toLocaleDateString();
            } else {
                $('previewPrepay').textContent = prepayVal + '% off if paid early';
            }
        } else {
            $('previewPrepayRow').classList.add('hidden');
        }
        
        // Notes, Expiry, Docs - Separate Sections
        const hasExpiry = $('toggleExpiry').checked;
        const hasNotes = $('toggleNotes').checked;
        const hasDocs = $('toggleDocs').checked;
        
        // Expiry Section
        if (hasExpiry) {
            $('previewExpirySection').classList.remove('hidden');
            const expDate = getVal('calcExpiryDate');
            $('previewExpiryDate').textContent = expDate ? new Date(expDate).toLocaleDateString() : 'Not set';
        } else {
            $('previewExpirySection').classList.add('hidden');
        }
        
        // Notes Section
        if (hasNotes) {
            const notesList = $('previewNotesList');
            notesList.innerHTML = '';
            const notesText = getVal('calcNotes').trim();
            const items = notesText ? notesText.split('\n') : [];
            let hasItems = false;
            items.forEach(item => {
                if (!item.trim()) return;
                hasItems = true;
                const li = document.createElement('li');
                li.className = "flex items-center gap-2";
                li.innerHTML = `
                    <div class="w-4 h-4 rounded-full flex items-center justify-center flex-shrink-0" style="background: rgba(59, 130, 246, 0.2);">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" style="color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <span style="color: var(--text-secondary);">${item.trim()}</span>
                `;
                notesList.appendChild(li);
            });
            if (hasItems) {
                $('previewNotesSection').classList.remove('hidden');
            } else {
                $('previewNotesSection').classList.add('hidden');
            }
        } else {
            $('previewNotesSection').classList.add('hidden');
        }
        
        // Docs Section
        if (hasDocs) {
            $('previewDocsSection').classList.remove('hidden');
            const docsList = $('previewDocsList');
            docsList.innerHTML = '';
            const items = getVal('calcDocs').split('\n');
            items.forEach(item => {
                if (!item.trim()) return;
                const li = document.createElement('li');
                li.className = "flex items-center gap-2";
                li.innerHTML = `
                    <div class="w-4 h-4 rounded-full flex items-center justify-center flex-shrink-0" style="background: var(--accent-glow);">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-2.5 w-2.5" style="color: var(--accent);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                    </div>
                    <span>${item.trim()}</span>
                `;
                docsList.appendChild(li);
            });
        } else {
            $('previewDocsSection').classList.add('hidden');
        }
        
        const pp = c.totalPayback > 0 ? (c.amount / c.totalPayback) * 100 : 0; 
        $('previewCircle').setAttribute('stroke-dasharray', `${pp}, ${100 - pp}`);
    }

    // ============================================
    // CLIENT VIEW
    // ============================================
    function getCurrentData() {
        saveState(activeCalcTab);
        return {
            b: getVal('calcBusinessName'), c: getVal('calcContactName'),
            ex: $('toggleExpiry').checked ? getVal('calcExpiryDate') : null,
            logo: currentLogoUrl,
            companyName: currentCompanyName,
            o: calcOptions.map(op => ({ a: op.amount, f: op.factor, t: op.term, q: op.frequency, fe: op.fee, pp: op.prepay, pd: op.prepayDate, to: op.termOverride, n: op.notes, d: op.docs, dt: op.docsText }))
        };
    }

    function previewClientView() {
        console.log('previewClientView called');
        try {
            // Hide ISO preview bar if visible
            const isoBar = $('isoPreviewBar');
            if (isoBar) isoBar.classList.add('hidden');
            
            // Clear ISO preview flags
            window.isoShareMode = false;
            window.isoPreviewMode = false;
            
            // Ensure factor rate is set to max sell rate for client preview
            const maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
            if ($('calcFactor')) $('calcFactor').value = maxSell;
            if ($('calcFactorSlider')) $('calcFactorSlider').value = maxSell;
            
            const data = getCurrentData();
            console.log('data:', data);
            initClientView(data);
            $('clientPreviewBar').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('previewClientView completed');
        } catch(e) {
            console.error('previewClientView error:', e);
        }
    }
    
    function previewISOView() {
        console.log('=== previewISOView START ===');
        try {
            // Get current lender rates (use defaults if in ISO mode)
            const buyRate = parseFloat($('lenderBuyRate')?.value) || parseFloat($('buyRateInput')?.value) || 1.15;
            const maxSell = parseFloat($('lenderMaxSell')?.value) || parseFloat($('maxSellRateInput')?.value) || 1.25;
            console.log('Rates - Buy:', buyRate, 'MaxSell:', maxSell);
            
            // Temporarily enable ISO preview mode flags
            window.isoShareMode = true;
            window.isoPreviewMode = true;
            lenderBuyRate = buyRate;
            lenderMaxSellRate = maxSell;
            
            // Expand Structure Your Offer card if collapsed (for mobile)
            const structureCard = $('structureOfferCard');
            if (structureCard && structureCard.classList.contains('collapsed')) {
                structureCard.classList.remove('collapsed');
            }
            
            // Set up ISO upsell slider with correct bounds
            const sellSlider = $('isoSellRateSlider');
            const sellInput = $('isoSellRate');
            console.log('Slider elements - sellSlider:', !!sellSlider, 'sellInput:', !!sellInput);
            
            if (sellSlider && sellInput) {
                // Set bounds first
                sellSlider.min = buyRate;
                sellSlider.max = maxSell;
                sellSlider.step = 0.01;
                
                // Default to max sell rate (full margin for ISO)
                sellSlider.value = maxSell;
                sellInput.value = maxSell.toFixed(2);
                
                updateSliderFill(sellSlider);
                console.log('Slider configured');
            }
            
            // Update buy rate display
            if ($('isoBuyRateDisplay')) $('isoBuyRateDisplay').textContent = buyRate.toFixed(2);
            
            // Show ISO section, hide lender section
            const isoUpsellSection = $('isoUpsellSection');
            const lenderRateSection = $('lenderRateSection');
            console.log('Sections - isoUpsell:', !!isoUpsellSection, 'lenderRate:', !!lenderRateSection);
            
            if (isoUpsellSection) {
                isoUpsellSection.classList.remove('hidden');
                console.log('isoUpsellSection shown');
            }
            if (lenderRateSection) {
                lenderRateSection.classList.add('hidden');
                console.log('lenderRateSection hidden');
            }
            
            // Set factor rate to max sell rate (ISO's default sell rate)
            const calcFactor = $('calcFactor');
            const calcFactorSlider = $('calcFactorSlider');
            if (calcFactor) calcFactor.value = maxSell.toFixed(2);
            if (calcFactorSlider) {
                calcFactorSlider.value = maxSell;
                updateSliderFill(calcFactorSlider);
            }
            
            // Update ISO profit display and recalculate
            updateIsoUpsell();
            updatePreview();
            
            // Show ISO preview bar
            const previewBar = $('isoPreviewBar');
            console.log('isoPreviewBar element:', !!previewBar);
            if (previewBar) {
                previewBar.classList.remove('hidden');
                console.log('isoPreviewBar shown');
            }
            
            showToast('ISO Preview: Showing what your ISO partner sees');
            window.scrollTo({ top: 0, behavior: 'smooth' });
            console.log('=== previewISOView END ===');
        } catch(e) {
            console.error('previewISOView error:', e);
            showToast('Error entering ISO preview mode');
        }
    }
    
    function exitISOPreview() {
        window.isoShareMode = false;
        window.isoPreviewMode = false;
        
        const isoUpsellSection = $('isoUpsellSection');
        const lenderRateSection = $('lenderRateSection');
        const isoPreviewBar = $('isoPreviewBar');
        
        // Restore based on current client mode
        if (currentClientMode === 'lender') {
            if (lenderRateSection) lenderRateSection.classList.remove('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
            // Restore lender display (resets factor rate to buy rate)
            updateLenderDisplay();
        } else {
            if (lenderRateSection) lenderRateSection.classList.add('hidden');
            if (isoUpsellSection) isoUpsellSection.classList.add('hidden');
        }
        
        // Hide preview bar
        if (isoPreviewBar) isoPreviewBar.classList.add('hidden');
        
        updatePreview();
        showToast('Returned to editor mode');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function exitPreview() {
        $('clientPanel').classList.add('hidden');
        $('adminPanel').classList.remove('hidden');
        $('clientPreviewBar').classList.add('hidden');
        $('floatingShareBtn').classList.remove('hidden');
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function acceptOffer() {
        // Get accent color for confetti
        const style = getComputedStyle(document.documentElement);
        const accent = style.getPropertyValue('--accent').trim();
        const accentLight = style.getPropertyValue('--accent-light').trim();
        const accentDark = style.getPropertyValue('--accent-dark').trim();
        
        confetti({
            particleCount: 150,
            spread: 80,
            origin: { y: 0.6 },
            colors: [accent, accentLight, accentDark]
        });
        $('successModal').classList.remove('hidden');
    }

    function initClientView(data) {
        console.log('initClientView called with:', data);
        $('adminPanel').classList.add('hidden');
        $('clientPanel').classList.remove('hidden');
        $('floatingShareBtn').classList.add('hidden');
        console.log('panels toggled');
        
        clientData = data;
        clientActiveIdx = 0;
        
        $('clientGreeting').textContent = `Hello, ${data.c || 'Business Owner'}`;
        $('clientBusinessName').textContent = data.b || 'your business';
        if(data.ex) {
            $('clientExpirySection').classList.remove('hidden');
            $('clientExpiryDate').textContent = new Date(data.ex).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
        }

        // Handle logo in client view
        const cLogoContainer = $('cPreviewLogoContainer');
        const cLogo = $('cPreviewLogo');
        if (data.logo) {
            cLogo.referrerPolicy = 'no-referrer';
            cLogo.src = data.logo;
            cLogo.onerror = function() {
                cLogoContainer.classList.add('hidden');
            };
            cLogo.onload = function() {
                cLogoContainer.classList.remove('hidden');
            };
        } else {
            cLogoContainer.classList.add('hidden');
        }

        // Handle company name in client view
        const cCompanyName = $('cPreviewCompanyName');
        if (data.companyName) {
            cCompanyName.textContent = data.companyName;
            cCompanyName.classList.remove('hidden');
        } else {
            cCompanyName.classList.add('hidden');
        }

        // Apply theme from share link
        if (data.theme) {
            setThemeMode(data.theme);
        }
        if (data.accent) {
            setAccentColor(data.accent);
        }

        const tabsContainer = $('clientTabsContainer');
        tabsContainer.innerHTML = '';
        if(data.o.length > 1) {
             tabsContainer.classList.remove('hidden');
             data.o.forEach((opt, idx) => {
                 const btn = document.createElement('button');
                 btn.className = `py-1.5 px-5 rounded-full text-[10px] font-bold uppercase tracking-widest transition-all border`;
                 if (idx === 0) {
                     btn.style.background = 'linear-gradient(135deg, var(--accent-light), var(--accent))';
                     btn.style.color = 'white';
                     btn.style.borderColor = 'var(--accent)';
                     btn.style.boxShadow = 'var(--shadow-md)';
                 } else {
                     btn.style.background = 'rgba(255,255,255,0.1)';
                     btn.style.color = 'var(--text-muted)';
                     btn.style.borderColor = 'rgba(255,255,255,0.2)';
                 }
                 btn.textContent = `Option ${getLetter(idx)}`;
                 btn.onclick = () => switchClientTab(idx, btn);
                 tabsContainer.appendChild(btn);
             });
        } else {
             tabsContainer.classList.add('hidden');
        }
        
        setupClientOption(0);
    }

    function switchClientTab(idx, btn) {
        clientActiveIdx = idx;
        const btns = $('clientTabsContainer').children;
        Array.from(btns).forEach(b => {
            b.style.background = 'rgba(255,255,255,0.1)';
            b.style.color = 'var(--text-muted)';
            b.style.borderColor = 'rgba(255,255,255,0.2)';
            b.style.boxShadow = 'none';
        });
        btn.style.background = 'linear-gradient(135deg, var(--accent-light), var(--accent))';
        btn.style.color = 'white';
        btn.style.borderColor = 'var(--accent)';
        btn.style.boxShadow = 'var(--shadow-md)';
        setupClientOption(idx);
    }

    function setupClientOption(idx) {
        console.log('setupClientOption called with idx:', idx);
        const opt = clientData.o[idx];
        console.log('opt:', opt);
        const maxAmt = opt.a;
        console.log('maxAmt:', maxAmt);
        
        clientSelectedAmount = maxAmt; 
        
        $('clientMaxLabelSlider').textContent = `Max ${formatCurrency(maxAmt)}`;
        
        const slider = $('clientAmountSlider');
        slider.min = 5000;
        slider.max = maxAmt;
        slider.step = 1; 
        slider.value = maxAmt;
        updateSliderFill(slider);
        
        const hasNotes = !!opt.n;
        const hasExpiry = !!clientData.ex; 
        const hasDocs = !!opt.d; 
        
        const termsContainer = $('clientTermsContainer');
        const expirySection = $('clientExpirySection');
        const notesSection = $('clientNotesSection');
        const docsSection = $('clientDocsSection');
        const notesDocsRow = $('clientNotesDocsRow');
        
        if (hasNotes || hasExpiry || hasDocs) {
            termsContainer.classList.remove('hidden');
            
            // Expiration Section
            if (hasExpiry) {
                expirySection.classList.remove('hidden');
                $('clientExpiryDate').textContent = new Date(clientData.ex).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' }); 
            } else {
                expirySection.classList.add('hidden');
            }
            
            // Notes & Docs Row
            if (hasNotes || hasDocs) {
                notesDocsRow.classList.remove('hidden');
            } else {
                notesDocsRow.classList.add('hidden');
            }
            
            // Notes Section
            if (hasNotes) {
                notesSection.classList.remove('hidden');
                const notesList = $('clientNotesList');
                notesList.innerHTML = '';
                const items = opt.n.split('\n');
                items.forEach(item => {
                    if (!item.trim()) return;
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2";
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" style="color: #3b82f6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                        <span>${item.trim()}</span>
                    `;
                    notesList.appendChild(li);
                });
            } else {
                notesSection.classList.add('hidden');
            }

            // Documents Section
            if (hasDocs) {
                docsSection.classList.remove('hidden');
                const docsList = $('clientDocsList');
                docsList.innerHTML = '';
                const items = (opt.dt || "Voided Check\nGovernment Issued ID").split('\n');
                
                items.forEach(item => {
                    if(!item.trim()) return;
                    const li = document.createElement('li');
                    li.className = "flex items-center gap-2";
                    li.innerHTML = `
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 flex-shrink-0" style="color: #8b5cf6;" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" /></svg>
                        <span>${item.trim()}</span>
                    `;
                    docsList.appendChild(li);
                });

            } else {
                docsSection.classList.add('hidden');
            }

        } else {
            termsContainer.classList.add('hidden');
        }

        updateClientPreview();
    }

    function updateClientPreview() {
        const opt = clientData.o[clientActiveIdx];
        const amt = clientSelectedAmount;
        
        const calc = calculate(amt, opt.f, opt.t, opt.q, opt.fe);
        
        if (clientData.o.length > 1) {
             $('cPreviewLabelContainer').classList.add('hidden');
        } else {
             $('cPreviewLabelContainer').classList.add('hidden');
        }

        $('cPreviewAmount').textContent = formatCurrency(calc.amount);
        $('cPreviewPayback').textContent = formatCurrency(calc.totalPayback);
        
        const to = opt.to;
        let tm = opt.t; if(opt.q === 'weekly') tm = opt.t / 4.33; else if (opt.q === 'daily') tm = opt.t / 21;
        const monthLabel = Math.round(tm * 2) / 2 + ' months';
        $('cPreviewTerm').textContent = to ? to : monthLabel;
        $('cPreviewCount').textContent = calc.term;
        $('cPreviewFactor').textContent = calc.factor.toFixed(2) + 'x';
        $('cPreviewCost').textContent = formatCurrency(calc.totalCost);
        
        if(calc.fee > 0) {
            $('cPreviewFeeRow').classList.remove('hidden');
            $('cPreviewFee').textContent = formatCurrency(calc.feeAmount);
            $('cPreviewNet').textContent = formatCurrency(calc.net);
        } else {
            $('cPreviewFeeRow').classList.add('hidden');
        }
        
        // Prepay discount
        if (opt.pp && opt.pp > 0) {
            $('cPreviewPrepayRow').classList.remove('hidden');
            if (opt.pd) {
                $('cPreviewPrepay').textContent = opt.pp + '% off if paid by ' + new Date(opt.pd).toLocaleDateString();
            } else {
                $('cPreviewPrepay').textContent = opt.pp + '% off if paid early';
            }
        } else {
            $('cPreviewPrepayRow').classList.add('hidden');
        }
        
        const pLabel = opt.q === 'weekly' ? 'Weekly Payment' : opt.q === 'monthly' ? 'Monthly Payment' : 'Daily Payment';
        $('cPreviewPaymentLabel').textContent = pLabel;
        $('cPreviewPayment').textContent = formatCurrency(calc.payment);
        
        const pp = calc.totalPayback > 0 ? (calc.amount / calc.totalPayback) * 100 : 0; 
        $('cPreviewCircle').setAttribute('stroke-dasharray', `${pp}, ${100 - pp}`);
    }

    // ============================================
    // UI HELPERS
    // ============================================
    function updateSliderFill(s) { 
        if (!s) return; 
        const m = parseFloat(s.min), mx = parseFloat(s.max), v = parseFloat(s.value);
        const p = ((v - m) / (mx - m)) * 100; 
        const isDark = s.classList.contains('slider-dark');
        const trackColor = isDark ? 'rgba(255,255,255,0.12)' : 'var(--slider-track)';
        s.style.background = `linear-gradient(to right, var(--accent) 0%, var(--accent-light) ${p}%, ${trackColor} ${p}%, ${trackColor} 100%)`; 
    }
    
    function updateSliders() { 
        $$('.slider').forEach(s => updateSliderFill(s)); 
    }

    function toggleSection(id, show) { 
        const el = $('sec'+id); 
        if(show) { 
            el.classList.remove('hidden'); 
            el.classList.add('fade-enter'); 
            updatePreview();
        } else { 
            el.classList.add('hidden'); 
            updatePreview(); 
        } 
    }

    function setFrequency(f) { 
        $$('.toggle-btn').forEach(b => b.classList.toggle('active', b.dataset.freq === f)); 
        updatePreview(); 
    }

    function resetCalculator() { 
        calcOptions = [initDefaultOption()]; 
        activeCalcTab = 0; 
        setVal('calcBusinessName',''); setVal('calcContactName',''); 
        ['toggleFee','togglePrepay','toggleOverride','toggleExpiry','toggleNotes','toggleDocs'].forEach(id => { 
            const el = $(id); if(el) { el.checked = false; toggleSection(id.replace('toggle',''), false); }
        });
        updateTabsUI(); loadState(0); updatePreview(); updateSliders(); 
        showToast('Calculator Reset');
    }
    
    function shareOffer() { 
        saveState(activeCalcTab); 
        $('shareModal').classList.remove('hidden'); 
    }

    function getLink() {
        saveState(activeCalcTab);
        const d = { 
            b: getVal('calcBusinessName'), c: getVal('calcContactName'),
            ex: $('toggleExpiry').checked ? getVal('calcExpiryDate') : null,
            logo: currentLogoUrl,
            companyName: currentCompanyName,
            theme: currentTheme,
            accent: currentAccent,
            o: calcOptions.map(op => ({ a: op.amount, f: op.factor, t: op.term, q: op.frequency, fe: op.fee, pp: op.prepay, pd: op.prepayDate, to: op.termOverride, n: op.notes, d: op.docs, dt: op.docsText }))
        };
        const json = JSON.stringify(d);
        const enc = LZString.compressToEncodedURIComponent(json);
        return `${window.location.origin}${window.location.pathname}?d=${enc}`;
    }
    
    function copyLink() { 
        // Check lite usage limit
        if (!canUseLiteShare()) {
            showUpgradeModal();
            return;
        }
        
        const l = getLink(); 
        saveOfferToDashboard(l); // Save offer to dashboard
        
        // Increment usage for lite users
        if (!currentUser) {
            incrementLiteUsage();
        }
        
        if (navigator.clipboard) { navigator.clipboard.writeText(l).then(() => showToast('Link copied!')).catch(() => prompt("Copy Link:", l)); } else { prompt("Copy Link:", l); }
        $('shareModal').classList.add('hidden');
    }
    
    // ============================================
    // OFFER DASHBOARD FUNCTIONS
    // ============================================
    
    function getStoredOffers() {
        try {
            const offers = JSON.parse(localStorage.getItem('trustbureau_offers') || '[]');
            // Filter out any corrupted/incomplete offers
            return offers.filter(o => o && o.id && o.factor !== undefined);
        } catch (e) {
            return [];
        }
    }
    
    function saveStoredOffers(offers) {
        localStorage.setItem('trustbureau_offers', JSON.stringify(offers));
    }
    
    function saveOfferToDashboard(link) {
        const offers = getStoredOffers();
        const businessName = getVal('calcBusinessName') || 'Unnamed Business';
        const contactName = getVal('calcContactName') || '';
        
        // Get first option details for summary
        const opt = calcOptions[0];
        if (!opt || !opt.factor) {
            console.warn('No valid option to save');
            return;
        }
        const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
        
        const offer = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2, 5),
            businessName: businessName,
            contactName: contactName,
            amount: opt.amount || 0,
            factor: opt.factor || 1.0,
            term: opt.term || 0,
            frequency: opt.frequency || 'daily',
            payment: cal.payment || 0,
            totalPayback: cal.totalPayback || 0,
            optionCount: calcOptions.length,
            link: link,
            status: 'pending', // pending, accepted, expired
            createdAt: new Date().toISOString(),
            mode: currentClientMode || 'iso' // lender or iso
        };
        
        offers.unshift(offer); // Add to beginning
        
        // Keep max 100 offers
        if (offers.length > 100) {
            offers.splice(100);
        }
        
        saveStoredOffers(offers);
        updateOfferCount();
    }
    
    function updateOfferCount() {
        const offers = getStoredOffers();
        const countEl = $('offerCount');
        if (offers.length > 0) {
            countEl.textContent = offers.length;
            countEl.classList.remove('hidden');
        } else {
            countEl.classList.add('hidden');
        }
    }
    
    function loadOfferCount() {
        updateOfferCount();
    }
    
    function openDashboard() {
        renderOffersDashboard();
        $('dashboardModal').classList.remove('hidden');
        
        // Re-attach Clear All button handler each time modal opens
        setTimeout(() => {
            const clearBtn = $('clearAllBtn');
            if (clearBtn) {
                clearBtn.onclick = function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    this.style.opacity = '0.5';
                    clearAllOffers();
                    this.style.opacity = '1';
                };
            }
        }, 100);
    }
    
    function closeDashboard() {
        $('dashboardModal').classList.add('hidden');
    }
    
    function renderOffersDashboard() {
        const offers = getStoredOffers();
        const container = $('offersTableContainer');
        
        if (offers.length === 0) {
            container.innerHTML = `
                <div style="text-align: center; padding: 60px 20px;">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto mb-4" style="color: var(--text-muted);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h3 style="font-size: 18px; font-weight: 600; color: var(--text-primary); margin-bottom: 8px;">No Offers Yet</h3>
                    <p style="font-size: 14px; color: var(--text-muted);">Create and share your first offer to see it here.</p>
                </div>
            `;
            return;
        }
        
        let tableHtml = `
            <div style="overflow-x: auto;">
                <table class="offers-table">
                    <thead>
                        <tr>
                            <th>Business</th>
                            <th>Amount</th>
                            <th>Terms</th>
                            <th>Payment</th>
                            <th>Status</th>
                            <th>Created</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        offers.forEach(offer => {
            // Handle missing/malformed offers
            if (!offer || !offer.id) return;
            
            const statusClass = offer.status === 'accepted' ? 'accepted' : offer.status === 'expired' ? 'expired' : 'pending';
            const statusLabel = (offer.status || 'pending').charAt(0).toUpperCase() + (offer.status || 'pending').slice(1);
            const createdDate = offer.createdAt ? new Date(offer.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : '-';
            
            // Handle ISO Rate Shares differently
            if (offer.isISOShare) {
                const buyRate = offer.buyRate ? offer.buyRate.toFixed(2) : '0.00';
                const maxSell = offer.factor ? offer.factor.toFixed(2) : '0.00';
                
                tableHtml += `
                    <tr>
                        <td>
                            <div style="font-weight: 600; color: var(--accent);">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 inline-block mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                </svg>
                                ISO Rate Share
                            </div>
                            <div style="font-size: 11px; color: var(--text-muted);">Lender â†’ ISO</div>
                        </td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: var(--text-muted);">â€”</td>
                        <td>
                            <span style="font-family: 'JetBrains Mono', monospace;">${buyRate}x</span>
                            <span style="color: var(--text-muted);">â†’</span>
                            <span style="font-family: 'JetBrains Mono', monospace;">${maxSell}x</span>
                        </td>
                        <td style="font-family: 'JetBrains Mono', monospace; color: var(--text-muted);">â€”</td>
                        <td>
                            <div class="offer-status ${statusClass}" onclick="cycleOfferStatus('${offer.id}')" title="Click to change status">
                                <span class="status-dot"></span>
                                ${statusLabel}
                            </div>
                        </td>
                        <td style="color: var(--text-muted);">${createdDate}</td>
                        <td>
                            <div class="offer-actions">
                                <button class="offer-action-btn" onclick="copyOfferLink('${offer.id}')" title="Copy Link">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                                <button class="offer-action-btn" onclick="openOfferLink('${offer.id}')" title="Open Link">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </button>
                                <button class="offer-action-btn" onclick="deleteOffer('${offer.id}')" title="Delete" style="color: #ef4444;">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            } else {
                // Regular customer offer
                const freqShort = offer.frequency === 'daily' ? 'D' : offer.frequency === 'weekly' ? 'W' : 'M';
                const optionsLabel = offer.optionCount > 1 ? `<span style="font-size: 10px; color: var(--text-muted);"> (${offer.optionCount} opts)</span>` : '';
                const factorDisplay = offer.factor ? offer.factor.toFixed(2) : '0.00';
                const termDisplay = offer.term || '-';
                const modeLabel = offer.mode === 'lender' ? '<span style="font-size: 9px; padding: 2px 6px; background: rgba(99, 102, 241, 0.1); color: #6366f1; border-radius: 4px; margin-left: 6px;">Lender</span>' : '';
                
                tableHtml += `
                    <tr>
                        <td>
                            <div style="font-weight: 600;">${escapeHtml(offer.businessName || 'Unknown')}${modeLabel}</div>
                            ${offer.contactName ? `<div style="font-size: 11px; color: var(--text-muted);">${escapeHtml(offer.contactName)}</div>` : ''}
                        </td>
                        <td>
                            <span style="font-weight: 600; font-family: 'JetBrains Mono', monospace;">${formatCurrency(offer.amount || 0)}</span>
                            ${optionsLabel}
                        </td>
                        <td>
                            <span style="font-family: 'JetBrains Mono', monospace;">${factorDisplay}x</span>
                            <span style="color: var(--text-muted);">Â·</span>
                            <span>${termDisplay}${freqShort}</span>
                        </td>
                        <td style="font-family: 'JetBrains Mono', monospace;">${formatCurrency(offer.payment || 0)}</td>
                        <td>
                            <div class="offer-status ${statusClass}" onclick="cycleOfferStatus('${offer.id}')" title="Click to change status">
                                <span class="status-dot"></span>
                                ${statusLabel}
                            </div>
                        </td>
                        <td style="color: var(--text-muted);">${createdDate}</td>
                        <td>
                            <div class="offer-actions">
                                <button class="offer-action-btn" onclick="copyOfferLink('${offer.id}')" title="Copy Link">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                </button>
                                <button class="offer-action-btn" onclick="openOfferLink('${offer.id}')" title="Open Link">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14" />
                                    </svg>
                                </button>
                                <button class="offer-action-btn" onclick="deleteOffer('${offer.id}')" title="Delete" style="color: #ef4444;">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }
        });
        
        tableHtml += `
                    </tbody>
                </table>
            </div>
        `;
        
        container.innerHTML = tableHtml;
    }
    
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    function cycleOfferStatus(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer) {
            // Cycle: pending -> accepted -> expired -> pending
            if (offer.status === 'pending') offer.status = 'accepted';
            else if (offer.status === 'accepted') offer.status = 'expired';
            else offer.status = 'pending';
            
            saveStoredOffers(offers);
            renderOffersDashboard();
        }
    }
    
    function copyOfferLink(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer && offer.link) {
            if (navigator.clipboard) {
                navigator.clipboard.writeText(offer.link).then(() => showToast('Link copied!')).catch(() => prompt("Copy Link:", offer.link));
            } else {
                prompt("Copy Link:", offer.link);
            }
        }
    }
    
    function openOfferLink(offerId) {
        const offers = getStoredOffers();
        const offer = offers.find(o => o.id === offerId);
        if (offer && offer.link) {
            window.open(offer.link, '_blank');
        }
    }
    
    function deleteOffer(offerId) {
        if (!confirm('Delete this offer?')) return;
        
        let offers = getStoredOffers();
        offers = offers.filter(o => o.id !== offerId);
        saveStoredOffers(offers);
        updateOfferCount();
        renderOffersDashboard();
        showToast('Offer deleted');
    }
    
    function clearAllOffers() {
        console.log('clearAllOffers called');
        try {
            const offers = getStoredOffers();
            console.log('Offers found:', offers.length);
            if (offers.length === 0) {
                showToast('No offers to clear');
                return;
            }
            
            // Clear directly without confirm dialog
            localStorage.removeItem('trustbureau_offers');
            updateOfferCount();
            renderOffersDashboard();
            showToast('All offers cleared');
            console.log('Done');
        } catch (e) {
            console.error('Error in clearAllOffers:', e);
            alert('Error: ' + e.message);
        }
    }
    
    function copyText() {
        const l = getLink();
        const businessName = getVal('calcBusinessName') || 'Business Funding';
        const contactName = getVal('calcContactName') || '';
        const fontMain = "font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;";
        
        let cardsHtml = '';
        
        calcOptions.forEach((opt, i) => {
            const cal = calculate(opt.amount, opt.factor, opt.term, opt.frequency, opt.fee);
            const freqLabel = opt.frequency.charAt(0).toUpperCase() + opt.frequency.slice(1);
            
            // Calculate term length display
            let termLengthDisplay = opt.termOverride || '';
            if (!termLengthDisplay) {
                if (opt.frequency === 'daily') {
                    const months = Math.round(opt.term / 22);
                    termLengthDisplay = months + (months === 1 ? ' month' : ' months');
                } else if (opt.frequency === 'weekly') {
                    const months = Math.round(opt.term / 4.33);
                    termLengthDisplay = months + (months === 1 ? ' month' : ' months');
                } else {
                    termLengthDisplay = opt.term + (opt.term === 1 ? ' month' : ' months');
                }
            }
            
            // Calculate principal percentage for visual
            const principalPct = Math.round((opt.amount / cal.totalPayback) * 100);
            
            const optionLabelHtml = calcOptions.length > 1 
                ? `<div style="display: inline-block; background-color: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); border-radius: 20px; padding: 6px 16px; margin-bottom: 16px;">
                       <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #10b981; margin: 0;">Option ${getLetter(i)}</p>
                   </div>`
                : '';

            const logoHtml = currentLogoUrl 
                ? `<div style="margin-bottom: 20px;"><img src="${currentLogoUrl}" alt="Logo" style="max-height: 48px; max-width: 160px;" /></div>`
                : '';

            const companyNameHtml = currentCompanyName
                ? `<p style="${fontMain} font-size: 12px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; color: #64748b; margin: 0 0 16px 0;">${currentCompanyName}</p>`
                : '';
            
            // Notes section (conditional)
            let notesHtml = '';
            if (opt.notes && opt.notes.trim()) {
                const noteLines = opt.notes.split('\n').filter(n => n.trim()).map(n => 
                    `<li style="${fontMain} font-size: 13px; color: #475569; margin-bottom: 6px;">${n.trim()}</li>`
                ).join('');
                notesHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-top: 1px solid #e2e8f0;">
                    <tr>
                        <td style="padding: 20px;">
                            <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 10px;">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #3b82f6, #2563eb); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; font-weight: bold; color: #0f172a;">Offer Notes</td>
                                </tr>
                            </table>
                            <ul style="margin: 0; padding-left: 20px;">${noteLines}</ul>
                        </td>
                    </tr>
                </table>`;
            }
            
            // Documents section (conditional)
            let docsHtml = '';
            if (opt.docs && opt.docs.length > 0) {
                const docsText = opt.docsText || 'The following documents are required to complete your funding';
                const docItems = opt.docs.map(d => 
                    `<li style="${fontMain} font-size: 13px; color: #475569; margin-bottom: 6px;">${d}</li>`
                ).join('');
                docsHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #ffffff; border-top: 1px solid #e2e8f0;">
                    <tr>
                        <td style="padding: 20px;">
                            <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 10px;">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #8b5cf6, #7c3aed); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; font-weight: bold; color: #0f172a;">Closing Documents</td>
                                </tr>
                            </table>
                            <p style="${fontMain} font-size: 12px; color: #64748b; margin: 0 0 10px 0;">${docsText}</p>
                            <ul style="margin: 0; padding-left: 20px;">${docItems}</ul>
                        </td>
                    </tr>
                </table>`;
            }
            
            // Fee row (conditional)
            const feeRowHtml = opt.fee > 0 
                ? `<table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: rgba(251, 191, 36, 0.1);">
                    <tr>
                        <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Origination Fee</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.feeAmount)}</p>
                        </td>
                        <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Net Proceeds</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.net)}</p>
                        </td>
                    </tr>
                </table>`
                : '';
            
            // Prepay row (conditional)
            const prepayRowHtml = opt.prepay > 0 
                ? `<table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: rgba(34, 197, 94, 0.1);">
                    <tr>
                        <td align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                            <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Prepay Discount</p>
                            <p style="${fontMain} font-size: 14px; font-weight: bold; color: #22c55e; margin: 0;">${opt.prepay}% off if paid early</p>
                        </td>
                    </tr>
                </table>`
                : '';

            cardsHtml += `
            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                <tr>
                    <td align="center">
                        <div style="max-width: 420px; margin: 0 auto 40px auto; background-color: #ffffff; border-radius: 24px; overflow: hidden; border: 4px solid #10b981; box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1);">
                            
                            <!-- Header -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); padding: 40px 20px 32px 20px;">
                                        ${logoHtml}
                                        ${companyNameHtml}
                                        ${optionLabelHtml}
                                        <p style="${fontMain} font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; color: #94a3b8; margin: 0 0 8px 0;">You Get</p>
                                        <h1 style="${fontMain} font-size: 52px; font-weight: 800; line-height: 1; letter-spacing: -2px; color: #ffffff; margin: 0;">${formatCurrency(opt.amount)}</h1>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Chart/Breakdown Section -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background: linear-gradient(to bottom, #ffffff, #f8fafc);">
                                <tr>
                                    <td align="center" style="padding: 28px 20px;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 1px; color: #94a3b8; margin: 0 0 6px 0;">Total Payback</p>
                                        <p style="${fontMain} font-size: 26px; font-weight: bold; color: #0f172a; margin: 0 0 16px 0;">${formatCurrency(cal.totalPayback)}</p>
                                        <table border="0" cellspacing="0" cellpadding="0" style="margin: 0 auto;">
                                            <tr>
                                                <td style="padding-right: 20px;">
                                                    <table border="0" cellspacing="0" cellpadding="0">
                                                        <tr>
                                                            <td style="width: 12px; height: 12px; background: linear-gradient(135deg, #34d399, #10b981); border-radius: 50%;"></td>
                                                            <td style="padding-left: 8px; ${fontMain} font-size: 12px; color: #64748b;">Principal</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                                <td>
                                                    <table border="0" cellspacing="0" cellpadding="0">
                                                        <tr>
                                                            <td style="width: 12px; height: 12px; background: #e2e8f0; border-radius: 50%;"></td>
                                                            <td style="padding-left: 8px; ${fontMain} font-size: 12px; color: #64748b;">Cost of Capital</td>
                                                        </tr>
                                                    </table>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                            </table>

                            <!-- Stats Grid Row 1: Term & Payments -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; border-top: 1px solid #f1f5f9;">
                                <tr>
                                    <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Term Length</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${termLengthDisplay}</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Payments</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${cal.term}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Stats Grid Row 2: Factor & Cost -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc;">
                                <tr>
                                    <td width="50%" align="center" style="padding: 14px; border-right: 1px solid #e2e8f0; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Factor Rate</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${parseFloat(opt.factor).toFixed(2)}x</p>
                                    </td>
                                    <td width="50%" align="center" style="padding: 14px; border-bottom: 1px solid #e2e8f0;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 4px 0;">Total Cost</p>
                                        <p style="${fontMain} font-size: 14px; font-weight: bold; color: #334155; margin: 0;">${formatCurrency(cal.totalCost)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Fee Row (conditional) -->
                            ${feeRowHtml}
                            
                            <!-- Prepay Row (conditional) -->
                            ${prepayRowHtml}

                            <!-- Payment Section -->
                            <table width="100%" border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td align="center" style="background-color: #ffffff; padding: 28px;">
                                        <p style="${fontMain} font-size: 10px; font-weight: bold; text-transform: uppercase; color: #94a3b8; margin: 0 0 6px 0; letter-spacing: 1px;">${freqLabel} Payment</p>
                                        <p style="${fontMain} font-size: 32px; font-weight: 800; color: #0f172a; margin: 0; letter-spacing: -1px;">${formatCurrency(cal.payment)}</p>
                                    </td>
                                </tr>
                            </table>
                            
                            <!-- Notes Section (conditional) -->
                            ${notesHtml}
                            
                            <!-- Documents Section (conditional) -->
                            ${docsHtml}
                            
                        </div>
                    </td>
                </tr>
            </table>`;
        });
        
        // Build expiration section HTML
        const expiryDate = $('toggleExpiry').checked ? getVal('calcExpiryDate') : null;
        let expiryHtml = '';
        if (expiryDate) {
            const formattedExpiry = new Date(expiryDate).toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' });
            expiryHtml = `
                <table width="100%" border="0" cellspacing="0" cellpadding="0" style="max-width: 420px; margin: 20px auto 0 auto;">
                    <tr>
                        <td style="padding: 16px; background-color: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
                            <table border="0" cellspacing="0" cellpadding="0">
                                <tr>
                                    <td style="width: 4px; height: 16px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 2px;"></td>
                                    <td style="padding-left: 10px; ${fontMain} font-size: 13px; color: #475569;">This offer expires on <span style="font-weight: bold; color: #10b981;">${formattedExpiry}</span></td>
                                </tr>
                            </table>
                        </td>
                    </tr>
                </table>`;
        }
        
        // Build greeting
        const greetingName = contactName || 'Business Owner';
        
        const html = `
            <!DOCTYPE html>
            <html>
            <body style="margin: 0; padding: 0; background-color: #f8fafc;">
            <center>
            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="background-color: #f8fafc; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif;">
                <tr>
                    <td align="center" style="padding: 40px 20px;">
                        
                        <!-- Trust Badge -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 24px;">
                            <tr>
                                <td align="center">
                                    <div style="display: inline-block; background: linear-gradient(135deg, rgba(16, 185, 129, 0.15), rgba(16, 185, 129, 0.05)); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 50px; padding: 10px 20px;">
                                        <table border="0" cellspacing="0" cellpadding="0">
                                            <tr>
                                                <td style="width: 20px; height: 20px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 50%; text-align: center; vertical-align: middle;">
                                                    <span style="color: white; font-size: 12px; line-height: 20px;">âœ“</span>
                                                </td>
                                                <td style="padding-left: 10px; ${fontMain} font-size: 12px; font-weight: 600; color: #475569;">
                                                    <span style="color: #10b981; font-weight: 700;">TrustBureau</span> Verified
                                                </td>
                                            </tr>
                                        </table>
                                    </div>
                                </td>
                            </tr>
                        </table>
                        
                        <!-- Greeting -->
                        <table border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 30px;">
                            <tr>
                                <td align="center">
                                    <h2 style="margin: 0 0 8px 0; color: #0f172a; font-size: 26px; font-weight: 800;">Hello, ${greetingName}</h2>
                                    <p style="margin: 0; color: #64748b; font-size: 14px;">Your business <span style="font-weight: 600; color: #0f172a;">${businessName}</span> has been pre-approved for funding.</p>
                                </td>
                            </tr>
                        </table>

                        ${cardsHtml}
                        
                        ${expiryHtml}

                        <table border="0" cellspacing="0" cellpadding="0" style="margin-top: 30px;">
                            <tr>
                                <td align="center">
                                    <a href="${l}" target="_blank" style="font-size: 16px; font-family: Helvetica, Arial, sans-serif; color: #ffffff; text-decoration: none; border-radius: 12px; padding: 18px 40px; background: linear-gradient(135deg, #10b981, #059669); display: inline-block; font-weight: bold; box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.4);">
                                        View & Accept Offer
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <td align="center" style="padding-top: 24px;">
                                    <p style="margin: 0; font-size: 12px; color: #94a3b8;"><a href="${l}" style="color: #94a3b8; text-decoration: underline;">Open in Browser</a></p>
                                </td>
                            </tr>
                        </table>
                        
                    </td>
                </tr>
            </table>
            </center>
            </body>
            </html>
        `;
        
        const div = document.createElement('div'); 
        div.innerHTML = html; 
        div.style.position='fixed'; div.style.opacity='0'; div.contentEditable='true'; 
        document.body.appendChild(div);
        
        const range = document.createRange(); 
        range.selectNodeContents(div); 
        const sel = window.getSelection(); 
        sel.removeAllRanges(); 
        sel.addRange(range);
        
        try { 
            document.execCommand('copy'); 
            saveOfferToDashboard(l); // Save offer to dashboard
            showToast('Email template copied!'); 
        } catch(e) { 
            copyLink(); 
        }
        document.body.removeChild(div); 
        $('shareModal').classList.add('hidden');
    }

    function openAmortSchedule() { 
        let a, f, t, fr;
        
        if($('adminPanel').classList.contains('hidden')) {
            const opt = clientData.o[clientActiveIdx];
            a = clientSelectedAmount;
            f = opt.f;
            t = opt.t;
            fr = opt.q;
        } else {
            a = getVal('calcAmount', true);
            f = getVal('calcFactor', true);
            t = getVal('calcTerm', true);
            const freqBtn = document.querySelector('.toggle-btn.active');
            fr = freqBtn ? freqBtn.dataset.freq : 'daily';
        }
        
        const c = calculate(a, f, t, fr, 0);
        let b = c.totalPayback, d = new Date(), html = '';
        
        for(let i=1; i<=t; i++) {
            if(i > 300 && i < t) continue;
            if(i === 300 && t > 300) { html += `<tr><td colspan="4" class="text-center py-4 italic text-xs" style="color: var(--text-muted); background: var(--bg-option-card);">... (${t - 300} remaining payments) ...</td></tr>`; continue; }
            if(fr==='weekly') d.setDate(d.getDate()+7); else if(fr==='monthly') d.setMonth(d.getMonth()+1); else { d.setDate(d.getDate()+1); if(d.getDay()===0) d.setDate(d.getDate()+1); if(d.getDay()===6) d.setDate(d.getDate()+2); }
            b -= c.payment; if(b<0) b=0;
            html += `<tr><td class="px-6 py-3 font-medium">${i}</td><td class="px-6 py-3">${d.toLocaleDateString()}</td><td class="px-6 py-3 text-right font-mono">${formatCurrency(c.payment)}</td><td class="px-6 py-3 text-right font-mono font-bold" style="color: var(--text-primary);">${formatCurrency(b)}</td></tr>`;
        }
        $('amortTableBody').innerHTML = html; 
        $('amortModal').classList.remove('hidden'); 
    }

    function showToast(m) { 
        const t=$('toast'); 
        $('toastMessage').textContent=m; 
        t.classList.add('show'); 
        setTimeout(()=>t.classList.remove('show'), 3000); 
    }

    // ============================================
    // EVENT LISTENERS
    // ============================================
    ['calcAmount','calcFactor','calcTerm','calcFee','calcPrepay'].forEach(id => {
        const el = $(id); if(!el) return;
        el.addEventListener('input', function() { 
            const v = parseFloat(this.value.replace(/,/g,''))||0; 
            const slider = $(id+'Slider'); if(slider) { slider.value = v; updateSliderFill(slider); }
            updatePreview(); 
        });
    });
    
    ['calcAmountSlider','calcFactorSlider','calcTermSlider','calcFeeSlider','calcPrepaySlider'].forEach(id => {
        const el = $(id); if(!el) return;
        el.addEventListener('input', function() { 
            const k = id.replace('Slider',''); setVal(k, k==='calcAmount'?formatNumber(this.value):this.value); 
            updatePreview(); updateSliderFill(this); 
        });
    });
    
    // ISO Sell Rate slider
    $('isoSellRateSlider')?.addEventListener('input', function() {
        if ($('isoSellRate')) $('isoSellRate').value = parseFloat(this.value).toFixed(2);
        updateSliderFill(this);
        updateIsoUpsell();
    });
    
    $('isoSellRate')?.addEventListener('input', function() {
        const slider = $('isoSellRateSlider');
        const minVal = parseFloat(slider?.min) || 1.05;
        const maxVal = parseFloat(slider?.max) || 1.70;
        
        let val = parseFloat(this.value) || minVal;
        val = Math.max(minVal, Math.min(maxVal, val));
        this.value = val.toFixed(2);
        
        if (slider) {
            slider.value = val;
            updateSliderFill(slider);
        }
        updateIsoUpsell();
    });
    
    // Lender Buy Rate slider
    $('lenderBuyRateSlider')?.addEventListener('input', function() {
        clearTierSelection();
        const buyVal = parseFloat(this.value);
        const maxSellEl = $('lenderMaxSell');
        const maxSellSlider = $('lenderMaxSellSlider');
        let maxSellVal = parseFloat(maxSellEl?.value) || 1.25;
        
        // If buy rate >= max sell, push max sell up (maintain 0.05 min spread)
        if (buyVal >= maxSellVal - 0.04) {
            maxSellVal = Math.min(buyVal + 0.05, 1.70);
            if (maxSellEl) maxSellEl.value = maxSellVal.toFixed(2);
            if (maxSellSlider) {
                maxSellSlider.value = maxSellVal;
                updateSliderFill(maxSellSlider);
            }
            if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2);
        }
        
        if ($('lenderBuyRate')) $('lenderBuyRate').value = buyVal.toFixed(2);
        if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2); // Sync to theme menu
        updateSliderFill(this);
        updateLenderDisplay();
    });
    
    $('lenderBuyRate')?.addEventListener('input', function() {
        clearTierSelection();
        // Clamp value to slider bounds
        let buyVal = parseFloat(this.value) || 1.15;
        buyVal = Math.max(1.05, Math.min(1.60, buyVal));
        this.value = buyVal.toFixed(2);
        
        const maxSellEl = $('lenderMaxSell');
        const maxSellSlider = $('lenderMaxSellSlider');
        let maxSellVal = parseFloat(maxSellEl?.value) || 1.25;
        
        // If buy rate >= max sell, push max sell up (maintain 0.05 min spread)
        if (buyVal >= maxSellVal - 0.04) {
            maxSellVal = Math.min(buyVal + 0.05, 1.70);
            if (maxSellEl) maxSellEl.value = maxSellVal.toFixed(2);
            if (maxSellSlider) {
                maxSellSlider.value = maxSellVal;
                updateSliderFill(maxSellSlider);
            }
            if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2);
        }
        
        if ($('lenderBuyRateSlider')) {
            $('lenderBuyRateSlider').value = buyVal;
            updateSliderFill($('lenderBuyRateSlider'));
        }
        if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2); // Sync to theme menu
        updateLenderDisplay();
    });
    
    // Lender Max Sell slider
    $('lenderMaxSellSlider')?.addEventListener('input', function() {
        clearTierSelection();
        const maxSellVal = parseFloat(this.value);
        const buyRateEl = $('lenderBuyRate');
        const buyRateSlider = $('lenderBuyRateSlider');
        let buyVal = parseFloat(buyRateEl?.value) || 1.15;
        
        // If max sell <= buy rate, push buy rate down (maintain 0.05 min spread)
        if (maxSellVal <= buyVal + 0.04) {
            buyVal = Math.max(maxSellVal - 0.05, 1.05);
            if (buyRateEl) buyRateEl.value = buyVal.toFixed(2);
            if (buyRateSlider) {
                buyRateSlider.value = buyVal;
                updateSliderFill(buyRateSlider);
            }
            if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2);
        }
        
        if ($('lenderMaxSell')) $('lenderMaxSell').value = maxSellVal.toFixed(2);
        if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2); // Sync to theme menu
        updateSliderFill(this);
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxSellVal.toFixed(2);
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSellVal;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        updateLenderDisplay();
    });
    
    $('lenderMaxSell')?.addEventListener('input', function() {
        clearTierSelection();
        // Clamp value to slider bounds
        let maxSellVal = parseFloat(this.value) || 1.25;
        maxSellVal = Math.max(1.10, Math.min(1.70, maxSellVal));
        this.value = maxSellVal.toFixed(2);
        
        const buyRateEl = $('lenderBuyRate');
        const buyRateSlider = $('lenderBuyRateSlider');
        let buyVal = parseFloat(buyRateEl?.value) || 1.15;
        
        // If max sell <= buy rate, push buy rate down (maintain 0.05 min spread)
        if (maxSellVal <= buyVal + 0.04) {
            buyVal = Math.max(maxSellVal - 0.05, 1.05);
            if (buyRateEl) buyRateEl.value = buyVal.toFixed(2);
            if (buyRateSlider) {
                buyRateSlider.value = buyVal;
                updateSliderFill(buyRateSlider);
            }
            if ($('buyRateInput')) $('buyRateInput').value = buyVal.toFixed(2);
        }
        
        if ($('lenderMaxSellSlider')) {
            $('lenderMaxSellSlider').value = maxSellVal;
            updateSliderFill($('lenderMaxSellSlider'));
        }
        if ($('maxSellRateInput')) $('maxSellRateInput').value = maxSellVal.toFixed(2); // Sync to theme menu
        // In ISO mode, calcFactor should match max sell rate
        if (currentClientMode === 'iso') {
            if ($('calcFactor')) $('calcFactor').value = maxSellVal;
            if ($('calcFactorSlider')) {
                $('calcFactorSlider').value = maxSellVal;
                updateSliderFill($('calcFactorSlider'));
            }
            updatePreview();
        }
        updateLenderDisplay();
    });
    
    $('clientAmountSlider').addEventListener('input', function() {
        clientSelectedAmount = parseInt(this.value);
        updateSliderFill(this);
        updateClientPreview();
    });

    ['calcTermOverride','calcBusinessName'].forEach(id => $(id).addEventListener('input', updatePreview));

    // ============================================
    // INITIALIZATION
    // ============================================
    window.addEventListener('load', () => {
        // Check for client share link FIRST - bypass login entirely
        const params = new URLSearchParams(window.location.search);
        const d = params.get('d');
        let isClientShareLink = false;
        let clientShareData = null;
        
        if (d) {
            try {
                // Try LZString decompression first (new format)
                let json = LZString.decompressFromEncodedURIComponent(d);
                
                // Fall back to old base64 format for backwards compatibility
                if (!json) {
                    json = decodeURIComponent(atob(d).replace(/%([0-9A-F]{2})/g, (m, p1) => String.fromCharCode('0x' + p1)));
                }
                
                const data = JSON.parse(json);
                if(data.o && data.o.length) {
                    isClientShareLink = true;
                    clientShareData = data;
                    // Hide welcome screen immediately for client share links
                    $('welcomeScreen').classList.add('hidden');
                }
            } catch(e) { console.error("Error parsing shared data", e); }
        }
        
        resetBrandKit();
        
        // Only load auth state if NOT a client share link
        if (!isClientShareLink) {
            loadAuthState();
        }
        
        resetCalculator();
        initMobileSections();
        
        // Only check ISO share mode if NOT a client share link
        if (!isClientShareLink) {
            checkISOShareMode();
        }
        
        loadOfferCount(); // Load offer count on startup
        
        // Attach Clear All button handler
        const clearBtn = $('clearAllBtn');
        if (clearBtn) {
            clearBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                console.log('Clear All clicked via addEventListener');
                clearAllOffers();
            });
        }
        
        // Close login modal on overlay click
        $('loginModal').addEventListener('click', (e) => {
            if (e.target === $('loginModal')) {
                closeLoginModal();
            }
        });
        
        // Close upgrade modal on overlay click
        $('upgradeModal').addEventListener('click', (e) => {
            if (e.target === $('upgradeModal')) {
                closeUpgradeModal();
            }
        });
        
        // Initialize lite usage UI
        updateLiteUsageUI();
        
        // Initialize client view if this is a client share link
        if (isClientShareLink && clientShareData) {
            initClientView(clientShareData);
        }
    });
  </script>
</body>
</html>
