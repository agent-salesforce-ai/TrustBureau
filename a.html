<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Approval Calculator</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://rsms.me/inter/inter.css" />

  <style>
    :root {
      /* Accent defaults (overridden by accent-* classes) */
      --accent-color: #f59e0b;
      --accent-color-light: #fbbf24;
      --accent-color-dark: #92400e;
      --accent-shadow: 0 0 26px rgba(245, 158, 11, 0.75);

      /* Base light-ish defaults (overridden by theme-* classes) */
      --bg-body: #f1f5f9;
      --bg-card: #ffffff;
      --bg-card-inner: #f9fafb;
      --bg-slider-track: #e5e7eb;
      --bg-input: #ffffff;
      --bg-toggle-inactive: #e5e7eb;

      --border-primary: #cbd5e1;
      --text-primary: #020617;
      --text-secondary: #111827;
      --text-muted: #4b5563;

      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.16);

      --transition-fast: 150ms ease-out;
      --transition-med: 220ms ease;
    }

    body {
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      background-color: var(--bg-body);
      color: var(--text-primary);
      transition:
        background-color var(--transition-med),
        color var(--transition-fast);
    }

    /* Remove number spinners */
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type=number] { -moz-appearance: textfield; }

    input,
    button,
    select,
    textarea {
      font-family: inherit;
    }

    .input-icon {
      top: 50%;
      transform: translateY(-50%);
    }

    /* ----------------------------
     * Themes
     * ---------------------------- */

    /* Light */
    html.theme-light {
      color-scheme: light;
      --bg-body: #eef2f7;
      --bg-card: #ffffff;
      --bg-card-inner: #f9fafb;
      --bg-slider-track: #e5e7eb;
      --bg-input: #ffffff;
      --bg-toggle-inactive: #e5e7eb;
      --border-primary: #cbd5e1;
      --text-primary: #020617;
      --text-secondary: #111827;
      --text-muted: #4b5563;
      --shadow-soft: 0 18px 45px rgba(15, 23, 42, 0.16);
    }
    html.theme-light body {
      background:
        radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.22), transparent 55%),
        linear-gradient(to bottom, #f9fafb, #e5e7eb);
      background-attachment: fixed;
    }

    /* Dark */
    html.theme-dark {
      color-scheme: dark;
      --bg-body: #020617;
      --bg-card: rgba(15, 23, 42, 0.98);
      --bg-card-inner: rgba(15, 23, 42, 0.94);
      --bg-slider-track: #111827;
      --bg-input: rgba(15, 23, 42, 0.98);
      --bg-toggle-inactive: #020617;
      --border-primary: #1f2937;
      --text-primary: #f9fafb;
      --text-secondary: #e5e7eb;
      --text-muted: #9ca3af;
      --shadow-soft: 0 28px 70px rgba(15, 23, 42, 0.85);
    }
    html.theme-dark body {
      background:
        radial-gradient(circle at 0 0, rgba(37, 99, 235, 0.35), transparent 55%),
        radial-gradient(circle at 100% 100%, rgba(20, 184, 166, 0.35), #020617);
      background-attachment: fixed;
    }

    /* AMOLED black */
    html.theme-black {
      color-scheme: dark;
      --bg-body: #000000;
      --bg-card: rgba(0, 0, 0, 0.98);
      --bg-card-inner: rgba(0, 0, 0, 0.98);
      --bg-slider-track: #111111;
      --bg-input: rgba(0, 0, 0, 0.98);
      --bg-toggle-inactive: #060606;
      --border-primary: #171717;
      --text-primary: #f9fafb;
      --text-secondary: #e5e5e5;
      --text-muted: #9ca3af;
      --accent-color: #ffffff;
      --accent-color-light: #e5e5e5;
      --accent-color-dark: #ffffff;
      --accent-shadow: 0 0 22px rgba(255, 255, 255, 0.7);
      --shadow-soft: 0 32px 80px rgba(0, 0, 0, 1);
    }
    html.theme-black body {
      background-color: #000000;
    }

    /* ----------------------------
     * Accents
     * ---------------------------- */

    html.accent-red {
      --accent-color: #ef4444;
      --accent-color-light: #f97373;
      --accent-color-dark: #b91c1c;
      --accent-shadow: 0 0 18px rgba(239, 68, 68, 0.55);
    }
    html.accent-orange {
      --accent-color: #f97316;
      --accent-color-light: #fdba74;
      --accent-color-dark: #c2410c;
      --accent-shadow: 0 0 18px rgba(249, 115, 22, 0.55);
    }
    html.accent-yellow {
      --accent-color: #eab308;
      --accent-color-light: #fde047;
      --accent-color-dark: #a16207;
      --accent-shadow: 0 0 18px rgba(234, 179, 8, 0.55);
    }
    html.accent-gold {
      --accent-color: #f59e0b;
      --accent-color-light: #fbbf24;
      --accent-color-dark: #92400e;
      --accent-shadow: 0 0 26px rgba(245, 158, 11, 0.75);
    }
    html.accent-green {
      --accent-color: #22c55e;
      --accent-color-light: #4ade80;
      --accent-color-dark: #15803d;
      --accent-shadow: 0 0 18px rgba(34, 197, 94, 0.55);
    }
    html.accent-blue,
    html.accent-primary {
      --accent-color: #2563eb;
      --accent-color-light: #3b82f6;
      --accent-color-dark: #1d4ed8;
      --accent-shadow: 0 0 18px rgba(37, 99, 235, 0.55);
    }
    html.accent-indigo {
      --accent-color: #4f46e5;
      --accent-color-light: #6366f1;
      --accent-color-dark: #3730a3;
      --accent-shadow: 0 0 18px rgba(79, 70, 229, 0.55);
    }
    html.accent-violet {
      --accent-color: #8b5cf6;
      --accent-color-light: #a855f7;
      --accent-color-dark: #6d28d9;
      --accent-shadow: 0 0 18px rgba(139, 92, 246, 0.55);
    }
    html.accent-teal {
      --accent-color: #14b8a6;
      --accent-color-light: #2dd4bf;
      --accent-color-dark: #0f766e;
      --accent-shadow: 0 0 18px rgba(20, 184, 166, 0.55);
    }
    html.accent-cyan {
      --accent-color: #06b6d4;
      --accent-color-light: #22d3ee;
      --accent-color-dark: #0e7490;
      --accent-shadow: 0 0 18px rgba(6, 182, 212, 0.55);
    }
    html.accent-sky {
      --accent-color: #0ea5e9;
      --accent-color-light: #38bdf8;
      --accent-color-dark: #0369a1;
      --accent-shadow: 0 0 18px rgba(14, 165, 233, 0.55);
    }
    html.accent-lime {
      --accent-color: #84cc16;
      --accent-color-light: #a3e635;
      --accent-color-dark: #4d7c0f;
      --accent-shadow: 0 0 18px rgba(132, 204, 22, 0.55);
    }
    html.accent-emerald {
      --accent-color: #10b981;
      --accent-color-light: #34d399;
      --accent-color-dark: #047857;
      --accent-shadow: 0 0 18px rgba(16, 185, 129, 0.55);
    }
    html.accent-rose {
      --accent-color: #f43f5e;
      --accent-color-light: #fb7185;
      --accent-color-dark: #be123c;
      --accent-shadow: 0 0 18px rgba(244, 63, 94, 0.55);
    }
    html.accent-pink {
      --accent-color: #ec4899;
      --accent-color-light: #f472b6;
      --accent-color-dark: #be185d;
      --accent-shadow: 0 0 18px rgba(236, 72, 153, 0.55);
    }
    html.accent-slate {
      --accent-color: #64748b;
      --accent-color-light: #94a3b8;
      --accent-color-dark: #475569;
      --accent-shadow: 0 0 18px rgba(100, 116, 139, 0.55);
    }
    html.accent-gray {
      --accent-color: #6b7280;
      --accent-color-light: #9ca3af;
      --accent-color-dark: #374151;
      --accent-shadow: 0 0 18px rgba(107, 114, 128, 0.55);
    }
    html.accent-brown {
      --accent-color: #92400e;
      --accent-color-light: #fbbf24;
      --accent-color-dark: #451a03;
      --accent-shadow: 0 0 18px rgba(146, 64, 14, 0.55);
    }

    /* ----------------------------
     * Shared UI styling
     * ---------------------------- */

    .card-bg,
    .card-inner-bg,
    .input-field,
    .toggle-inactive,
    .toggle-active,
    .button-primary {
      transition:
        background-color 0.2s var(--transition-fast),
        border-color 0.2s var(--transition-fast),
        box-shadow 0.2s var(--transition-fast),
        color 0.15s var(--transition-fast),
        transform 0.12s var(--transition-fast);
    }

    .card-bg {
      background-color: var(--bg-card);
      border-color: var(--border-primary);
      box-shadow: var(--shadow-soft);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
    }

    .card-inner-bg {
      background-color: var(--bg-card-inner);
      border: 1px solid rgba(148, 163, 184, 0.5);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }

    .shell {
      border-width: 1px;
      border-style: solid;
      border-color: rgba(148, 163, 184, 0.7);
      box-shadow:
        0 18px 50px rgba(15, 23, 42, 0.35),
        0 0 0 1px rgba(15, 23, 42, 0.12);
      border-radius: 1.25rem;
    }
    html.theme-black .shell {
      border-color: var(--accent-color);
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.4),
        var(--accent-shadow);
    }
    .shell:hover {
      transform: translateY(-1px);
    }

    /* Depth system */
    .depth-scene {
      perspective: 1400px;
    }

    .main-shell {
      transform-style: preserve-3d;
    }

    .depth-layer-1,
    .depth-layer-2 {
      position: relative;
      transform-style: preserve-3d;
      transform-origin: center;
    }

    .depth-layer-1 {
      transform: translateZ(0);
    }

    .depth-layer-2 {
      transform: translateZ(24px);
    }

    .depth-layer-1:hover {
      transform: translateZ(10px) translateY(-1px);
    }

    .depth-layer-2:hover {
      transform: translateZ(32px) translateY(-2px);
    }

    /* Adjust card shadows by depth */
    .card-inner-bg.depth-layer-1,
    #savedOffersSection.depth-layer-1 {
      box-shadow:
        0 18px 45px rgba(15, 23, 42, 0.28),
        0 0 0 1px rgba(148, 163, 184, 0.25);
    }

    #offerCard.depth-layer-2 {
      box-shadow:
        0 22px 55px rgba(15, 23, 42, 0.42),
        0 0 0 1px rgba(148, 163, 184, 0.35);
    }

    /* The approved amount block: closest to the viewer */
    .amount-elevated {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      border-radius: 1.4rem;
      padding: 0.9rem 1.8rem;
      background:
        radial-gradient(circle at 0 0, rgba(148, 163, 184, 0.22), transparent 60%),
        var(--bg-card-inner);
      box-shadow:
        0 28px 70px rgba(15, 23, 42, 0.65),
        0 0 0 1px rgba(148, 163, 184, 0.6),
        0 0 0 1px rgba(255, 255, 255, 0.03) inset;
      transform: translateZ(48px) translateY(-2px);
      transform-style: preserve-3d;
    }
    .amount-elevated::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: inherit;
      background: radial-gradient(circle at 50% 0, rgba(255, 255, 255, 0.12), transparent 55%);
      opacity: 0.9;
      pointer-events: none;
    }
    .amount-elevated:hover {
      transform: translateZ(60px) translateY(-4px) scale(1.01);
    }

    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-muted { color: var(--text-muted); }
    .border-primary { border-color: var(--border-primary); }

    .text-hero {
      color: var(--accent-color);
    }
    /* Glow only on dark/black themes */
    html.theme-dark .text-hero,
    html.theme-black .text-hero {
      text-shadow: 0 0 18px rgba(15, 23, 42, 0.7);
    }

    /* Inputs */
    .input-field {
      background-color: var(--bg-input);
      border-color: var(--border-primary);
      color: var(--text-primary);
      border-radius: 0.75rem;
    }
    .input-field::placeholder {
      color: var(--text-muted);
      opacity: 0.75;
    }
    .input-field:focus,
    .input-field:focus-visible,
    .input-field:focus-within {
      border-color: var(--accent-color-light);
      box-shadow:
        0 0 0 1px rgba(148, 163, 184, 0.7),
        0 0 0 4px rgba(56, 189, 248, 0.45);
      outline: none;
    }

    /* Sliders */
    .slider-track {
      -webkit-appearance: none;
      appearance: none;
      width: 100%;
      height: 0.3rem;
      border-radius: 9999px;
      background-color: var(--bg-slider-track);
    }
    .slider-track::-webkit-slider-runnable-track {
      height: 0.3rem;
      border-radius: 9999px;
      background-color: var(--bg-slider-track);
    }
    .slider-track::-moz-range-track {
      height: 0.3rem;
      border-radius: 9999px;
      background-color: var(--bg-slider-track);
    }
    .slider-thumb {
      accent-color: var(--accent-color);
    }
    .slider-track::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 9999px;
      margin-top: -6px;
      background: var(--accent-color);
      border: 2px solid var(--bg-card);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.18),
        0 0 0 6px rgba(148, 163, 184, 0.35);
      cursor: pointer;
    }
    .slider-track::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 9999px;
      background: var(--accent-color);
      border: 2px solid var(--bg-card);
      box-shadow:
        0 0 0 1px rgba(15, 23, 42, 0.18),
        0 0 0 6px rgba(148, 163, 184, 0.35);
      cursor: pointer;
    }

    /* Frequency toggle */
    #toggleContainer {
      background-color: var(--bg-card-inner);
      border-radius: 9999px;
      border: 1px solid var(--border-primary);
      padding: 0.15rem;
      gap: 0.15rem;
    }
    #toggleContainer button {
      flex: 1 1 0;
      border-radius: 9999px;
      border: none;
      font-size: 0.8rem;
      line-height: 1.25rem;
    }
    .toggle-inactive {
      background-color: transparent;
      color: var(--text-muted);
    }
    .toggle-active {
      background-image: linear-gradient(
        135deg,
        var(--accent-color-light),
        var(--accent-color)
      );
      color: #020617;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.45);
      transform: translateY(-0.5px);
    }

    /* Buttons */
    .button-primary {
      background-image: linear-gradient(
        135deg,
        var(--accent-color-light),
        var(--accent-color)
      );
      color: #020617;
      font-weight: 600;
      border-radius: 9999px;
      padding: 0.6rem 1.75rem;
      border: 1px solid var(--accent-color-dark);
      box-shadow: 0 14px 36px rgba(15, 23, 42, 0.45);
    }
    .button-primary:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.6);
      filter: brightness(1.03);
    }
    .button-primary:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 10px 26px rgba(15, 23, 42, 0.42);
      filter: brightness(0.98);
    }
    .button-primary:disabled {
      background-image: none;
      background-color: var(--bg-slider-track);
      color: var(--text-muted);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
      border-color: var(--border-primary);
    }

    #headerContainer {
      border-bottom-color: rgba(148, 163, 184, 0.6);
    }
    #themeControls button {
      border-radius: 9999px;
      background-color: rgba(148, 163, 184, 0.08);
      border-color: rgba(148, 163, 184, 0.45);
    }
    #themeControls button:hover {
      background-color: rgba(148, 163, 184, 0.16);
      border-color: rgba(148, 163, 184, 0.7);
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.28);
      transform: translateY(-0.5px);
    }
    #themeSelector,
    #accentSelector {
      background-image: linear-gradient(
        to right,
        rgba(148, 163, 184, 0.18),
        var(--bg-card-inner)
      );
    }

    button:focus-visible,
    select:focus-visible {
      outline: 2px solid var(--accent-color-light);
      outline-offset: 2px;
    }
  </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4 transition-colors duration-200 depth-scene">

  <div class="w-full max-w-xl card-bg shell main-shell text-primary rounded-xl shadow-lg p-4 md:p-6 space-y-4 border">

    <!-- HEADER -->
    <div id="headerContainer" class="pb-3 border-b border-primary flex flex-col items-center gap-3">
      <div class="flex flex-col items-center justify-center flex-shrink-0 gap-2">
        <div class="flex items-center gap-2">
          <!-- TrustBureau.ai placeholder logo -->
          <svg class="h-6 w-6 text-hero" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M16 3L7 6.5V15.5C7 21 10.8 25.9 16 27l9-3.5V6.5L16 3Z" stroke="currentColor" stroke-width="1.6" stroke-linejoin="round"/>
            <path d="M12 11H17.5C19.985 11 22 13.015 22 15.5C22 17.985 19.985 20 17.5 20H12" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
            <path d="M12 11V21" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
          </svg>
          <span class="text-[11px] font-semibold tracking-wide text-secondary">TrustBureau.ai</span>
        </div>
        <span class="text-xs font-semibold text-muted uppercase tracking-[0.18em]">
          APPROVAL CALCULATOR
        </span>
      </div>
      <div id="themeControls" class="flex items-center justify-center gap-2">
        <button id="repSettingsToggle" type="button"
                class="px-2 py-1 text-[11px] rounded-lg border border-primary text-muted hover:text-primary hover:border-primary flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
               stroke-width="1.8" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 0 0 2.573 1.066c1.543-.89 3.31.876 2.42 2.42a1.724 1.724 0 0 0 1.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 0 0-1.066 2.573c.89 1.543-.876 3.31-2.42 2.42a1.724 1.724 0 0 0-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 0 0-2.573-1.066c-1.543.89-3.31-.876-2.42-2.42a1.724 1.724 0 0 0-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 0 0 1.066-2.573c-.89-1.543.876-3.31 2.42-2.42.996.574 2.272.115 2.573-1.065Z"/>
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z"/>
          </svg>
          Settings
        </button>
        <button id="themePanelToggle" type="button"
                class="px-2 py-1 text-[11px] rounded-lg border border-primary text-muted hover:text-primary hover:border-primary flex items-center gap-1">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" fill="none" viewBox="0 0 24 24"
               stroke-width="1.8" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 3c2.755 0 5 2.245 5 5 0 4-5 9-5 9s-5-5-5-9c0-2.755 2.245-5 5-5zm0 3a2 2 0 100 4 2 2 0 000-4z" />
          </svg>
          Theme
        </button>
      </div>
    </div>

    <!-- REP + THEME SETTINGS PANEL -->
    <div id="repSettingsPanel"
         class="w-full mt-3 card-inner-bg border border-primary rounded-lg p-3 hidden depth-layer-1">
      <div class="flex items-center justify-between mb-2">
        <span class="text-xs font-semibold text-secondary">Rep & Theme Settings</span>
        <span class="text-[11px] text-muted">Shown on client approval view</span>
      </div>
      <div class="grid grid-cols-1 gap-2 text-xs">
        <div class="grid grid-cols-2 gap-2">
          <div>
            <label for="themeSelector" class="block font-semibold text-muted">Theme</label>
            <select id="themeSelector"
                    class="mt-1 w-full p-1.5 text-xs rounded-lg border border-primary input-field">
              <option value="theme-light">Light</option>
              <option value="theme-dark">Dark</option>
              <option value="theme-black">AMOLED (Pure Black)</option>
              <option value="theme-auto">Auto (System)</option>
            </select>
          </div>
          <div>
            <label for="accentSelector" class="block font-semibold text-muted">Accent Color</label>
            <select id="accentSelector"
                    class="mt-1 w-full p-1.5 text-xs rounded-lg border border-primary input-field">
              <option value="accent-gold">Gold (Default)</option>
              <option value="accent-red">Red</option>
              <option value="accent-orange">Orange</option>
              <option value="accent-yellow">Yellow</option>
              <option value="accent-green">Green</option>
              <option value="accent-blue">Blue</option>
              <option value="accent-indigo">Indigo</option>
              <option value="accent-violet">Violet</option>
              <option value="accent-teal">Teal</option>
              <option value="accent-cyan">Cyan</option>
              <option value="accent-sky">Sky</option>
              <option value="accent-lime">Lime</option>
              <option value="accent-emerald">Emerald</option>
              <option value="accent-rose">Rose</option>
              <option value="accent-pink">Pink</option>
              <option value="accent-slate">Slate</option>
              <option value="accent-gray">Gray</option>
              <option value="accent-brown">Brown</option>
            </select>
          </div>
        </div>
        <div>
          <label for="repNameInput" class="block font-semibold text-muted">Your Name</label>
          <input id="repNameInput" type="text"
                 class="mt-1 w-full p-1.5 text-xs border rounded-lg shadow-sm input-field"
                 placeholder="Rep Name" />
        </div>
        <div>
          <label for="repEmailInput" class="block font-semibold text-muted">Your Email</label>
          <input id="repEmailInput" type="email"
                 class="mt-1 w-full p-1.5 text-xs border rounded-lg shadow-sm input-field"
                 placeholder="rep@example.com" />
        </div>
        <div>
          <label for="repPhoneInput" class="block font-semibold text-muted">Your Phone</label>
          <input id="repPhoneInput" type="tel"
                 class="mt-1 w-full p-1.5 text-xs border rounded-lg shadow-sm input-field"
                 placeholder="(555) 123-4567" />
        </div>
      </div>
    </div>

    <!-- CALCULATOR -->
    <div id="calculatorInputs" class="space-y-4 pt-2">
      <div id="businessNameContainer" class="px-1 mt-2">
        <label for="businessNameInput" class="block text-xs font-semibold text-muted">
          Business Name
        </label>
        <input id="businessNameInput" type="text"
               class="mt-1 w-full p-1.5 text-sm border rounded-lg shadow-sm input-field"
               placeholder="e.g., Acme Holdings LLC" />
      </div>

      <div class="card-inner-bg p-4 rounded-xl shadow-inner space-y-4 depth-layer-1">
        <!-- Amount -->
        <div id="amountContainer" class="space-y-1">
          <label for="calcAmount" class="block text-xs font-semibold text-muted">
            Amount You Get ($)
          </label>
          <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000"
                 value="50000"
                 class="w-full slider-track rounded-lg cursor-pointer slider-thumb mb-2" />
          <div class="relative group">
            <span class="absolute left-3 input-icon text-muted text-sm">$</span>
            <input id="calcAmountInput" inputmode="numeric"
                   class="w-full p-1.5 pl-8 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <!-- Factor -->
        <div id="factorContainer" class="space-y-1">
          <label for="calcFactor" class="block text-xs font-semibold text-muted">Factor Rate</label>
          <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25"
                 class="w-full slider-track rounded-lg cursor-pointer slider-thumb" />
          <div class="relative group">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-4 w-4 absolute left-3 input-icon text-muted"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M6 18 18 6M6 6l12 12" />
            </svg>
            <input id="calcFactorInput" type="number" step="0.01"
                   class="w-full p-1.5 pl-9 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <!-- Number of Payments -->
        <div id="termContainer" class="space-y-1">
          <label for="calcTerm" class="block text-xs font-semibold text-muted">
            Number of Payments
          </label>
          <input id="calcTermSlider" type="range" min="3" max="528" step="1" value="6"
                 class="w-full slider-track rounded-lg cursor-pointer slider-thumb" />
          <div class="relative group">
            <svg xmlns="http://www.w3.org/2000/svg"
                 class="h-4 w-4 absolute left-3 input-icon text-muted"
                 fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round"
                    d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2z" />
            </svg>
            <input id="calcTermInput" type="number" step="1"
                   class="w-full p-1.5 pl-9 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <!-- Origination Fee -->
        <div id="originationContainer" class="space-y-1">
          <label for="originationSlider" class="block text-xs font-semibold text-muted">
            Origination Fee (%)
          </label>
          <input id="originationSlider" type="range" min="0" max="10" step="0.1" value="0"
                 class="w-full slider-track rounded-lg cursor-pointer slider-thumb" />
          <div class="relative group">
            <span class="absolute left-3 input-icon text-muted text-xs">%</span>
            <input id="originationInput" type="number" step="0.1" min="0" max="10"
                   class="w-full p-1.5 pl-7 text-sm border rounded-lg shadow-sm input-field" />
          </div>
        </div>

        <!-- Manual Term Length (Months - Display Only) -->
        <div id="termLengthMonthsContainer" class="space-y-1">
          <label for="termLengthMonthsInput" class="block text-xs font-semibold text-muted">
            Term Length (Months - Display Only)
          </label>
          <div class="relative group">
            <input id="termLengthMonthsInput" type="number" step="0.5" min="1"
                   class="w-full p-1.5 text-sm border rounded-lg shadow-sm input-field"
                   placeholder="Auto" />
          </div>
        </div>
      </div>

      <!-- Frequency toggle -->
      <div id="toggleContainer" class="flex items-center justify-center space-x-2 mt-2 depth-layer-1">
        <button id="toggleDaily" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
          Daily
        </button>
        <button id="toggleWeekly" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
          Weekly
        </button>
        <button id="toggleMonthly" class="text-sm font-semibold px-4 py-1.5 rounded-lg">
          Monthly
        </button>
      </div>
    </div>

    <!-- OFFER CARD -->
    <div id="offerCard" class="card-bg depth-layer-2 p-4 rounded-lg shadow-md border border-primary mt-4">
      <div class="flex justify-center items-center border-b border-primary pb-3 pt-3">
        <h4 class="text-sm font-semibold text-secondary">Offer 1 â€“ Your Approved Terms</h4>
      </div>
      <div class="text-center py-6 space-y-3">
        <span id="businessNameDisplay"
              class="text-sm font-semibold text-primary block mb-1 hidden"></span>

        <!-- Approved amount: visually closest element -->
        <div class="amount-elevated">
          <span class="text-[11px] font-semibold text-muted tracking-wide uppercase">You Get</span>
          <span id="summaryAmountOut"
                class="text-5xl font-semibold text-hero leading-tight mt-1">$50,000</span>
        </div>

        <span class="text-base font-medium text-secondary block pt-1">
          Total Payback:
          <span id="summaryPaybackOut" class="font-semibold text-primary"></span>
        </span>
      </div>
      <div class="flex justify-center items-center border-b border-primary pb-2">
        <h5 class="text-sm font-semibold text-secondary text-center">Offer Details</h5>
      </div>
      <div class="pt-6">
        <div class="grid grid-cols-2 gap-4 justify-items-center">
          <!-- Term Length highlight row -->
          <div class="text-center col-span-2">
            <span class="text-[11px] font-semibold text-muted uppercase tracking-wide block">Term Length</span>
            <span id="summaryTermLengthOut"
                  class="text-2xl font-semibold text-primary block"></span>
          </div>

          <!-- Factor & Payments -->
          <div class="text-center">
            <span class="text-[11px] font-medium text-muted uppercase tracking-wide block">Factor Rate</span>
            <span id="summaryFactorOut"
                  class="text-lg font-semibold text-primary block"></span>
          </div>
          <div class="text-center">
            <span class="text-[11px] font-medium text-muted uppercase tracking-wide block">Payments</span>
            <span id="summaryTermOut"
                  class="text-lg font-semibold text-primary block"></span>
          </div>

          <!-- Cost & Payment -->
          <div class="text-center">
            <span class="text-[11px] font-medium text-muted uppercase tracking-wide block">Total Cost of Funds</span>
            <span id="summaryCostOut"
                  class="text-lg font-semibold text-primary block"></span>
          </div>
          <div class="text-center">
            <span id="summaryPaymentLabel"
                  class="text-[11px] font-medium text-muted uppercase tracking-wide block">Est. Daily Payment</span>
            <span id="summaryPaymentValue"
                  class="text-lg font-semibold text-primary block"></span>
          </div>

          <!-- Origination -->
          <div class="text-center">
            <span class="text-[11px] font-medium text-muted uppercase tracking-wide block">Origination Fee (%)</span>
            <span id="summaryOriginationPercentOut"
                  class="text-lg font-semibold text-primary block"></span>
          </div>
          <div class="text-center">
            <span class="text-[11px] font-medium text-muted uppercase tracking-wide block">Origination Fee ($)</span>
            <span id="summaryOriginationAmountOut"
                  class="text-lg font-semibold text-primary block"></span>
          </div>
        </div>
      </div>
      <div id="repContactBlock"
           class="mt-6 pt-3 border-t border-primary text-xs text-secondary text-center hidden">
        <div class="font-semibold text-muted mb-1">Your Funding Specialist</div>
        <div id="repNameDisplay" class="font-medium"></div>
        <div id="repEmailDisplay"></div>
        <div id="repPhoneDisplay"></div>
      </div>
    </div>

    <!-- ADDITIONAL OFFERS -->
    <div id="savedOffersSection"
         class="card-bg depth-layer-1 mt-4 p-4 rounded-lg shadow-md border border-primary hidden">
      <div class="flex justify-between items-center border-b border-primary pb-2 mb-4">
        <h5 class="text-sm font-semibold text-secondary">Additional Offers</h5>
      </div>
      <div id="savedOffersContainer"
           class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <!-- BUTTONS -->
    <div id="buttonContainer" class="pt-4 border-t border-primary mt-4">
      <div class="relative flex justify-center gap-3 flex-wrap">
        <button id="addOfferButton" class="button-primary flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
               fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M12 4v16m8-8H4" />
          </svg>
          Add Offer
        </button>
        <button id="shareLinkButton" class="button-primary flex items-center gap-2" type="button">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4"
               fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round"
                  d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684z"/>
          </svg>
          Share Approval Link
        </button>
      </div>
      <div id="shareLinkContainer" class="mt-3 hidden">
        <label class="block text-xs font-semibold text-muted mb-1">Shareable Approval Link</label>
        <input id="shareLinkOutput" type="text" readonly
               class="w-full text-xs input-field border border-primary rounded-lg px-2 py-1" />
        <p class="mt-1 text-[11px] text-muted">Link copied to clipboard (when possible). If not, copy from here.</p>
      </div>
    </div>

  </div>

  <script>
    const elements = {
      calcAmountSlider: document.getElementById('calcAmountSlider'),
      calcFactorSlider: document.getElementById('calcFactorSlider'),
      calcTermSlider: document.getElementById('calcTermSlider'),
      calcAmountInput: document.getElementById('calcAmountInput'),
      calcFactorInput: document.getElementById('calcFactorInput'),
      calcTermInput: document.getElementById('calcTermInput'),
      termLengthMonthsInput: document.getElementById('termLengthMonthsInput'),
      originationSlider: document.getElementById('originationSlider'),
      originationInput: document.getElementById('originationInput'),

      toggleDaily: document.getElementById('toggleDaily'),
      toggleWeekly: document.getElementById('toggleWeekly'),
      toggleMonthly: document.getElementById('toggleMonthly'),

      themeSelector: document.getElementById('themeSelector'),
      accentSelector: document.getElementById('accentSelector'),
      repSettingsToggle: document.getElementById('repSettingsToggle'),
      themePanelToggle: document.getElementById('themePanelToggle'),
      repSettingsPanel: document.getElementById('repSettingsPanel'),

      businessNameInput: document.getElementById('businessNameInput'),
      businessNameDisplay: document.getElementById('businessNameDisplay'),

      repNameInput: document.getElementById('repNameInput'),
      repEmailInput: document.getElementById('repEmailInput'),
      repPhoneInput: document.getElementById('repPhoneInput'),
      repContactBlock: document.getElementById('repContactBlock'),
      repNameDisplay: document.getElementById('repNameDisplay'),
      repEmailDisplay: document.getElementById('repEmailDisplay'),
      repPhoneDisplay: document.getElementById('repPhoneDisplay'),

      summaryAmountOut: document.getElementById('summaryAmountOut'),
      summaryPaybackOut: document.getElementById('summaryPaybackOut'),
      summaryFactorOut: document.getElementById('summaryFactorOut'),
      summaryTermOut: document.getElementById('summaryTermOut'),
      summaryCostOut: document.getElementById('summaryCostOut'),
      summaryPaymentLabel: document.getElementById('summaryPaymentLabel'),
      summaryPaymentValue: document.getElementById('summaryPaymentValue'),
      summaryTermLengthOut: document.getElementById('summaryTermLengthOut'),
      summaryOriginationPercentOut: document.getElementById('summaryOriginationPercentOut'),
      summaryOriginationAmountOut: document.getElementById('summaryOriginationAmountOut'),

      addOfferButton: document.getElementById('addOfferButton'),
      savedOffersSection: document.getElementById('savedOffersSection'),
      savedOffersContainer: document.getElementById('savedOffersContainer'),

      calculatorInputs: document.getElementById('calculatorInputs'),
      buttonContainer: document.getElementById('buttonContainer'),
      themeControls: document.getElementById('themeControls'),
      businessNameContainer: document.getElementById('businessNameContainer'),
      factorContainer: document.getElementById('factorContainer'),
      termContainer: document.getElementById('termContainer'),
      originationContainer: document.getElementById('originationContainer'),
      termLengthMonthsContainer: document.getElementById('termLengthMonthsContainer'),
      toggleContainer: document.getElementById('toggleContainer'),

      shareLinkButton: document.getElementById('shareLinkButton'),
      shareLinkContainer: document.getElementById('shareLinkContainer'),
      shareLinkOutput: document.getElementById('shareLinkOutput'),
    };

    let paymentFrequency = 'daily';
    let currentTheme = 'theme-light';
    let currentAccent = 'accent-gold';
    let amountSliderMax = 1000000;
    const MAX_ADDITIONAL_OFFERS = 2;
    let savedOffers = [];
    let isApprovalView = false;
    let termLengthManualDirty = false;

    // Load saved theme/accent or respect OS preference
    try {
      const storedTheme = localStorage.getItem('generic_offer_calc_theme');
      const storedAccent = localStorage.getItem('generic_offer_calc_accent');

      if (storedTheme) {
        currentTheme = storedTheme;
      } else if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
        currentTheme = 'theme-dark';
      }

      if (storedAccent) currentAccent = storedAccent;
    } catch (_) {}

    function formatCurrency(num) {
      const numericValue = Number(num);
      if (isNaN(numericValue)) return '$0';
      return new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: 'USD',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      }).format(numericValue);
    }

    function parseFormattedNumber(val) {
      if (typeof val !== 'string' || !val) return 0;
      return parseFloat(val.replace(/[\$,]/g, '')) || 0;
    }

    function setAmountSliderMax(cap) {
      amountSliderMax = cap;
      if (elements.calcAmountSlider) {
        elements.calcAmountSlider.max = String(cap);
      }
    }

    function computeOffer(amount, factor, termPayments, frequency) {
      const totalPayback = amount * factor;
      const totalCost = totalPayback - amount;

      const paymentsCount = termPayments > 0 ? termPayments : 1;
      const paymentAmount = totalPayback / paymentsCount;

      let rawMonths;
      if (frequency === 'weekly') {
        rawMonths = termPayments * (12 / 52);
      } else if (frequency === 'monthly') {
        rawMonths = termPayments;
      } else {
        rawMonths = termPayments * (12 / 250);
      }
      const termLengthMonths = Math.round(rawMonths * 2) / 2;

      let paymentLabel = 'Est. Daily Payment';
      if (frequency === 'weekly') paymentLabel = 'Est. Weekly Payment';
      if (frequency === 'monthly') paymentLabel = 'Est. Monthly Payment';

      return {
        amount,
        factor,
        termMonths: termPayments,
        termLengthMonths,
        totalPayback,
        totalCost,
        payment: paymentAmount,
        paymentLabel,
        frequency,
      };
    }

    function getCurrentOffer() {
      const amount = parseFormattedNumber(elements.calcAmountInput.value);
      const factor = parseFloat(elements.calcFactorInput.value) || 1.05;
      const termPayments = parseInt(elements.calcTermInput.value) || 1;
      return computeOffer(amount, factor, termPayments, paymentFrequency);
    }

    function renderSavedOffers() {
      if (!elements.savedOffersSection || !elements.savedOffersContainer) return;

      if (!savedOffers.length) {
        elements.savedOffersSection.classList.add('hidden');
        elements.savedOffersContainer.innerHTML = '';
        return;
      }

      elements.savedOffersSection.classList.remove('hidden');

      const html = savedOffers.map((offer, index) => {
        const labelIndex = index + 2;
        return `
          <div class="card-bg rounded-lg border border-primary p-3 space-y-3 depth-layer-1">
            <div class="flex items-center justify-between">
              <span class="text-xs font-semibold text-secondary">Offer ${labelIndex}</span>
            </div>
            <div class="text-center mt-2">
              <span class="text-[11px] font-semibold text-muted block">You Get</span>
              <span class="text-2xl font-semibold text-hero block">${formatCurrency(offer.amount)}</span>
            </div>
            <div class="grid grid-cols-2 gap-3 text-center text-xs mt-2">
              <div>
                <span class="text-[11px] font-semibold text-muted block">Factor</span>
                <span class="text-sm font-semibold text-primary block">${offer.factor.toFixed(2)}x</span>
              </div>
              <div>
                <span class="text-[11px] font-semibold text-muted block">Payments</span>
                <span class="text-sm font-semibold text-primary block">${offer.termMonths}</span>
              </div>
              <div>
                <span class="text-[11px] font-semibold text-muted block">Payback</span>
                <span class="text-sm font-semibold text-primary block">${formatCurrency(offer.totalPayback)}</span>
              </div>
              <div>
                <span class="text-[11px] font-semibold text-muted block">${offer.paymentLabel}</span>
                <span class="text-sm font-semibold text-primary block">${formatCurrency(offer.payment)}</span>
              </div>
            </div>
          </div>
        `;
      }).join('');

      elements.savedOffersContainer.innerHTML = html;
    }

    function updateAddOfferButtonState() {
      if (!elements.addOfferButton) return;
      elements.addOfferButton.disabled = savedOffers.length >= MAX_ADDITIONAL_OFFERS;
    }

    function handleAddOffer() {
      if (savedOffers.length >= MAX_ADDITIONAL_OFFERS) return;
      savedOffers.push(getCurrentOffer());
      renderSavedOffers();
      updateAddOfferButtonState();
    }

    function syncInputs(slider, input, isCurrency, min, max, callback) {
      const initialValue = parseFloat(slider.value);
      input.value = isCurrency ? formatCurrency(initialValue) : initialValue.toString();

      slider.addEventListener('input', () => {
        let val = parseFloat(slider.value);
        if (!isNaN(val) && val > max) {
          val = max;
          slider.value = val;
        }
        input.value = isCurrency ? formatCurrency(val) : String(val);
        callback();
      });

      input.addEventListener('input', () => {
        let val = isCurrency ? parseFormattedNumber(input.value) : parseFloat(input.value);
        if (!isNaN(val) && val >= min && val <= max) {
          slider.value = val;
          callback();
        } else if (input.value === '') {
          callback();
        }
      });

      input.addEventListener('blur', () => {
        let val = isCurrency ? parseFormattedNumber(input.value) : parseFloat(input.value);
        if (isNaN(val) || val < min) val = min;
        if (val > max) val = max;
        slider.value = val;
        input.value = isCurrency ? formatCurrency(val) : String(val);
        callback();
      });
    }

    function applyTheme() {
      let themeClass = currentTheme;

      if (currentTheme === 'theme-auto') {
        const prefersDark =
          window.matchMedia &&
          window.matchMedia('(prefers-color-scheme: dark)').matches;
        themeClass = prefersDark ? 'theme-dark' : 'theme-light';
      }

      document.documentElement.className = `${themeClass} ${currentAccent}`;
      document.documentElement.dataset.effectiveTheme = themeClass;

      try {
        localStorage.setItem('generic_offer_calc_theme', currentTheme);
        localStorage.setItem('generic_offer_calc_accent', currentAccent);
      } catch (_) {}
    }

    function updateRepDisplay() {
      if (!elements.repContactBlock) return;

      const name = elements.repNameInput?.value.trim() || '';
      const email = elements.repEmailInput?.value.trim() || '';
      const phone = elements.repPhoneInput?.value.trim() || '';

      const hasAny = name || email || phone;

      elements.repContactBlock.classList.toggle('hidden', !hasAny);
      if (elements.repNameDisplay) elements.repNameDisplay.textContent = name;
      if (elements.repEmailDisplay) elements.repEmailDisplay.textContent = email;
      if (elements.repPhoneDisplay) elements.repPhoneDisplay.textContent = phone;
    }

    function updatePaymentToggleUI() {
      const btns = [
        { el: elements.toggleDaily, freq: 'daily' },
        { el: elements.toggleWeekly, freq: 'weekly' },
        { el: elements.toggleMonthly, freq: 'monthly' },
      ];
      btns.forEach(({ el, freq }) => {
        if (!el) return;
        el.classList.remove('toggle-active', 'toggle-inactive');
        el.classList.add(paymentFrequency === freq ? 'toggle-active' : 'toggle-inactive');
      });
    }

    // Base64 encode/decode helpers for compact URL config
    function encodeConfig(config) {
      try {
        const json = JSON.stringify(config);
        // UTF-8 safe base64
        return btoa(unescape(encodeURIComponent(json)));
      } catch (e) {
        console.error('encodeConfig failed', e);
        return '';
      }
    }

    function decodeConfig(encoded) {
      try {
        const json = decodeURIComponent(escape(atob(encoded)));
        return JSON.parse(json);
      } catch (e) {
        console.error('decodeConfig failed', e);
        return null;
      }
    }

    function initializeFromURL() {
      const params = new URLSearchParams(window.location.search);
      const configParam = params.get('c');
      let config = null;

      if (configParam) {
        config = decodeConfig(configParam);
      }

      const viewMode = params.get('view');
      isApprovalView = viewMode === 'approval';

      let amount = 50000;
      let factor = 1.25;
      let term = 6;
      let freq = 'daily';
      let paramTheme = null;
      let paramAccent = null;
      let businessNameParam = '';
      let repNameParam = '';
      let repEmailParam = '';
      let repPhoneParam = '';
      let offersRaw = null;

      if (config) {
        amount = Number(config.amount ?? amount) || amount;
        factor = Number(config.factor ?? factor) || factor;
        term = parseInt(config.term ?? term) || term;
        freq = config.freq || freq;
        paramTheme = config.theme || null;
        paramAccent = config.accent || null;
        businessNameParam = config.businessName || '';
        repNameParam = config.repName || '';
        repEmailParam = config.repEmail || '';
        repPhoneParam = config.repPhone || '';
        if (Array.isArray(config.offers)) offersRaw = config.offers;
      } else {
        const amountParam = params.get('amount');
        if (amountParam) {
          const parsedAmount = parseFloat(amountParam);
          if (!isNaN(parsedAmount)) amount = parsedAmount;
        }
        const factorParam = params.get('factor');
        if (factorParam) factor = parseFloat(factorParam) || factor;
        const termParam = params.get('term');
        if (termParam) term = parseInt(termParam) || term;
        if (params.get('freq')) freq = params.get('freq');

        paramTheme = params.get('theme');
        paramAccent = params.get('accent');
        businessNameParam = params.get('businessName') || '';
        repNameParam = params.get('repName') || '';
        repEmailParam = params.get('repEmail') || '';
        repPhoneParam = params.get('repPhone') || '';

        const offersParam = params.get('offers');
        if (offersParam) {
          try {
            const parsed = JSON.parse(offersParam);
            if (Array.isArray(parsed)) offersRaw = parsed;
          } catch (e) {
            console.error('Error parsing offers from URL', e);
          }
        }
      }

      if (paramTheme) currentTheme = paramTheme;
      if (paramAccent) currentAccent = paramAccent;

      if (isApprovalView) {
        setAmountSliderMax(amount);
      } else {
        setAmountSliderMax(1000000);
      }

      elements.calcAmountInput.value = formatCurrency(amount);
      elements.calcAmountSlider.value = amount;
      elements.calcFactorSlider.value = factor;
      elements.calcTermSlider.value = term;

      if (elements.businessNameInput) elements.businessNameInput.value = businessNameParam;
      if (elements.repNameInput) elements.repNameInput.value = repNameParam;
      if (elements.repEmailInput) elements.repEmailInput.value = repEmailParam;
      if (elements.repPhoneInput) elements.repPhoneInput.value = repPhoneParam;

      paymentFrequency = freq || 'daily';

      savedOffers = [];
      if (Array.isArray(offersRaw)) {
        savedOffers = offersRaw.map(o =>
          computeOffer(
            Number(o.a ?? o.amount ?? 0),
            Number(o.f ?? o.factor ?? 1.1),
            Number(o.t ?? o.term ?? 3),
            o.q ?? o.frequency ?? 'daily'
          )
        );
      }

      if (isApprovalView) {
        if (elements.factorContainer) elements.factorContainer.style.display = 'none';
        if (elements.termContainer) elements.termContainer.style.display = 'none';
        if (elements.originationContainer) elements.originationContainer.style.display = 'none';
        if (elements.termLengthMonthsContainer) elements.termLengthMonthsContainer.style.display = 'none';
        if (elements.toggleContainer) elements.toggleContainer.style.display = 'none';
        if (elements.businessNameContainer) elements.businessNameContainer.style.display = 'none';

        if (elements.repSettingsPanel) elements.repSettingsPanel.style.display = 'none';
        if (elements.buttonContainer) elements.buttonContainer.style.display = 'none';
        if (elements.themeControls) elements.themeControls.style.display = 'none';
      }
    }

    function runCalculator() {
      try {
        const amount = parseFormattedNumber(elements.calcAmountInput.value);
        const factor = parseFloat(elements.calcFactorInput.value) || 1.1;
        const termPayments = parseInt(elements.calcTermInput.value) || 1;

        const offer = computeOffer(amount, factor, termPayments, paymentFrequency);

        const businessName = elements.businessNameInput?.value.trim() || '';
        if (elements.businessNameDisplay) {
          if (businessName) {
            elements.businessNameDisplay.textContent = businessName;
            elements.businessNameDisplay.classList.remove('hidden');
          } else {
            elements.businessNameDisplay.textContent = '';
            elements.businessNameDisplay.classList.add('hidden');
          }
        }

        elements.summaryAmountOut.textContent = formatCurrency(offer.amount);
        elements.summaryPaybackOut.textContent = formatCurrency(offer.totalPayback);
        elements.summaryFactorOut.textContent = `${offer.factor.toFixed(2)}x`;
        elements.summaryTermOut.textContent = `${offer.termMonths} payments`;
        elements.summaryCostOut.textContent = formatCurrency(offer.totalCost);
        elements.summaryPaymentLabel.textContent = offer.paymentLabel;
        elements.summaryPaymentValue.textContent = formatCurrency(offer.payment);

        const origPct = parseFloat(elements.originationInput.value) || 0;
        const origFeeAmount = amount * (origPct / 100);
        elements.summaryOriginationPercentOut.textContent = `${origPct.toFixed(2)}%`;
        elements.summaryOriginationAmountOut.textContent = formatCurrency(origFeeAmount);

        let months = offer.termLengthMonths;
        if (elements.termLengthMonthsInput) {
          if (!termLengthManualDirty) {
            const autoRounded = Math.round(months * 2) / 2;
            elements.termLengthMonthsInput.value = Number.isInteger(autoRounded)
              ? String(autoRounded)
              : autoRounded.toFixed(1);
          }
          const manualVal = parseFloat(elements.termLengthMonthsInput.value);
          if (!isNaN(manualVal) && manualVal > 0) {
            months = manualVal;
          }
        }

        if (months && months > 0) {
          const rounded = Math.round(months * 2) / 2;
          const display = Number.isInteger(rounded) ? String(rounded) : rounded.toFixed(1);
          elements.summaryTermLengthOut.textContent = `${display} months`;
        } else {
          elements.summaryTermLengthOut.textContent = '';
        }

        updateRepDisplay();
      } catch (e) {
        console.error('Calculator error:', e);
      }
    }

    function initializeCalculator() {
      initializeFromURL();
      applyTheme();

      // React to system theme changes when using Auto
      if (window.matchMedia) {
        const mq = window.matchMedia('(prefers-color-scheme: dark)');
        const handleSystemThemeChange = () => {
          if (currentTheme === 'theme-auto') {
            applyTheme();
          }
        };
        if (mq.addEventListener) {
          mq.addEventListener('change', handleSystemThemeChange);
        } else if (mq.addListener) {
          mq.addListener(handleSystemThemeChange);
        }
      }

      if (elements.themeSelector) elements.themeSelector.value = currentTheme;
      if (elements.accentSelector) elements.accentSelector.value = currentAccent;

      if (elements.calcAmountSlider && elements.calcAmountInput) {
        syncInputs(elements.calcAmountSlider, elements.calcAmountInput, true, 5000, amountSliderMax, runCalculator);
      }
      if (!isApprovalView && elements.calcFactorSlider && elements.calcFactorInput) {
        syncInputs(elements.calcFactorSlider, elements.calcFactorInput, false, 1.05, 1.7, runCalculator);
      }
      if (!isApprovalView && elements.calcTermSlider && elements.calcTermInput) {
        syncInputs(elements.calcTermSlider, elements.calcTermInput, false, 1, 528, runCalculator);
      }
      if (!isApprovalView && elements.originationSlider && elements.originationInput) {
        syncInputs(elements.originationSlider, elements.originationInput, false, 0, 10, runCalculator);
      }

      if (!isApprovalView && elements.toggleDaily) {
        elements.toggleDaily.addEventListener('click', () => {
          paymentFrequency = 'daily';
          updatePaymentToggleUI();
          runCalculator();
        });
      }
      if (!isApprovalView && elements.toggleWeekly) {
        elements.toggleWeekly.addEventListener('click', () => {
          paymentFrequency = 'weekly';
          updatePaymentToggleUI();
          runCalculator();
        });
      }
      if (!isApprovalView && elements.toggleMonthly) {
        elements.toggleMonthly.addEventListener('click', () => {
          paymentFrequency = 'monthly';
          updatePaymentToggleUI();
          runCalculator();
        });
      }

      if (!isApprovalView && elements.businessNameInput) {
        elements.businessNameInput.addEventListener('input', runCalculator);
      }

      if (!isApprovalView && elements.termLengthMonthsInput) {
        elements.termLengthMonthsInput.addEventListener('input', () => {
          termLengthManualDirty = true;
          runCalculator();
        });
        elements.termLengthMonthsInput.addEventListener('blur', () => {
          const v = parseFloat(elements.termLengthMonthsInput.value);
          if (!isNaN(v) && v > 0) {
            const rounded = Math.round(v * 2) / 2;
            elements.termLengthMonthsInput.value = Number.isInteger(rounded)
              ? String(rounded)
              : rounded.toFixed(1);
          }
          runCalculator();
        });
      }

      // Settings + Theme buttons both toggle the same panel (open/close)
      if (!isApprovalView && elements.repSettingsPanel) {
        const togglePanel = () => {
          elements.repSettingsPanel.classList.toggle('hidden');
        };
        if (elements.repSettingsToggle) {
          elements.repSettingsToggle.addEventListener('click', togglePanel);
        }
        if (elements.themePanelToggle) {
          elements.themePanelToggle.addEventListener('click', togglePanel);
        }
      }

      if (!isApprovalView && elements.repNameInput) elements.repNameInput.addEventListener('input', updateRepDisplay);
      if (!isApprovalView && elements.repEmailInput) elements.repEmailInput.addEventListener('input', updateRepDisplay);
      if (!isApprovalView && elements.repPhoneInput) elements.repPhoneInput.addEventListener('input', updateRepDisplay);

      if (!isApprovalView && elements.themeSelector) {
        elements.themeSelector.addEventListener('change', e => {
          currentTheme = e.target.value;
          applyTheme();
        });
      }

      if (!isApprovalView && elements.accentSelector) {
        elements.accentSelector.addEventListener('change', e => {
          currentAccent = e.target.value;
          applyTheme();
        });
      }

      if (!isApprovalView && elements.addOfferButton) {
        elements.addOfferButton.addEventListener('click', handleAddOffer);
      }

      if (!isApprovalView && elements.shareLinkButton) {
        elements.shareLinkButton.addEventListener('click', async () => {
          const shareBtn = elements.shareLinkButton;
          const originalText = shareBtn.innerText;

          const amount = parseFormattedNumber(elements.calcAmountInput.value);
          const factor = parseFloat(elements.calcFactorInput.value);
          const term = parseInt(elements.calcTermInput.value) || 1;
          const freq = paymentFrequency;
          const theme = currentTheme;
          const accent = currentAccent;
          const businessName = elements.businessNameInput?.value.trim() || '';
          const repName = elements.repNameInput?.value.trim() || '';
          const repEmail = elements.repEmailInput?.value.trim() || '';
          const repPhone = elements.repPhoneInput?.value.trim() || '';

          const offersForUrl = savedOffers.map(o => ({
            a: o.amount,
            f: o.factor,
            t: o.termMonths,
            q: o.frequency || freq,
          }));

          const config = {
            amount,
            factor,
            term,
            freq,
            theme,
            accent,
            businessName,
            repName,
            repEmail,
            repPhone,
            offers: offersForUrl,
          };

          const encodedConfig = encodeConfig(config);

          const url = new URL(window.location.href);
          const params = new URLSearchParams({
            c: encodedConfig,
            view: 'approval',
          });
          url.search = params.toString();
          const shareUrl = url.toString();

          if (elements.shareLinkOutput && elements.shareLinkContainer) {
            elements.shareLinkOutput.value = shareUrl;
            elements.shareLinkContainer.classList.remove('hidden');
            elements.shareLinkOutput.focus();
            elements.shareLinkOutput.select();
          }

          const setStatus = (msg) => {
            shareBtn.innerText = msg;
            setTimeout(() => { shareBtn.innerText = originalText; }, 2000);
          };

          try {
            if (navigator.clipboard && navigator.clipboard.writeText) {
              await navigator.clipboard.writeText(shareUrl);
              setStatus('Copied!');
            } else {
              throw new Error('Clipboard API not available');
            }
          } catch (err) {
            console.warn('Clipboard API failed, falling back:', err);
            try {
              const ta = document.createElement('textarea');
              ta.value = shareUrl;
              ta.style.position = 'fixed';
              ta.style.top = '0';
              ta.style.left = '0';
              ta.style.opacity = '0';
              document.body.appendChild(ta);
              ta.focus();
              ta.select();
              const ok = document.execCommand('copy');
              document.body.removeChild(ta);
              if (ok) {
                setStatus('Copied!');
              } else {
                throw new Error('execCommand copy failed');
              }
            } catch (fallbackErr) {
              console.error('All copy methods failed:', fallbackErr);
              setStatus('Copy failed');
            }
          }
        });
      }

      updatePaymentToggleUI();
      runCalculator();
      renderSavedOffers();
      updateAddOfferButtonState();
    }

    initializeCalculator();
  </script>
</body>
</html>
