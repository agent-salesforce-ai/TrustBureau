import { Component, OnInit, signal, computed, ViewChild, ElementRef } from '@angular/core';
import { CommonModule, CurrencyPipe, DatePipe, DecimalPipe } from '@angular/common';
import { FormsModule } from '@angular/forms';

// --- Interfaces ---
interface OfferOption {
  amount: number;
  factor: number;
  term: number;
  frequency: 'daily' | 'weekly' | 'monthly';
  fee: number;
  prepayDiscount: number;
  termOverride: string;
  notes: string;
  // Calculated
  payment?: number;
  totalPayback?: number;
  totalCost?: number;
  apr?: number;
  feeAmount?: number;
  netProceeds?: number;
  termMonths?: number;
}

interface Offer {
  id: string;
  status: 'pending' | 'accepted' | 'declined' | 'expired';
  createdAt: number;
  expiresAt: number;
  businessName: string;
  contactName: string;
  email: string;
  options: OfferOption[];
  repName?: string;
  repEmail?: string;
  repPhone?: string;
  companyName?: string;
  logoUrl?: string;
  accent?: string;
  showApr?: boolean;
  acceptedAt?: number;
  acceptedOptionIndex?: number;
}

interface Settings {
  repName: string;
  repEmail: string;
  repPhone: string;
  companyName: string;
  logoUrl: string;
  defaultFactor: number;
  defaultTerm: number;
  defaultExpiry: number;
  accent: string;
  apiKey: string;
  showApr: boolean;
}

interface AmortizationRow {
  index: number;
  date: Date;
  payment: number;
  balance: number;
}

@Component({
  selector: 'app-root',
  standalone: true,
  imports: [CommonModule, FormsModule],
  template: `
    <!-- Main Wrapper with Theme Classes -->
    <div class="font-sans min-h-screen transition-colors duration-300"
         [class.theme-dark]="isDark()"
         [class.theme-light]="!isDark()"
         [ngClass]="'accent-' + settings().accent">

      <canvas #confettiCanvas class="fixed inset-0 pointer-events-none z-[9999]"></canvas>

      <!-- Toast -->
      <div class="toast" [class.show]="toastVisible()">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
        </svg>
        <span>{{ toastMessage() }}</span>
      </div>

      <!-- === DASHBOARD LAYOUT === -->
      <div *ngIf="viewMode() !== 'client'" class="flex min-h-screen bg-[var(--bg-body)] text-[var(--text-primary)]">
        
        <!-- Sidebar -->
        <aside class="fixed inset-y-0 left-0 z-40 w-64 transform transition-transform duration-300 bg-[var(--bg-sidebar)] border-r border-[var(--border-primary)] flex flex-col -translate-x-full md:translate-x-0"
               [class.translate-x-0]="sidebarOpen()">
          
          <div class="p-6 border-b border-[var(--border-primary)] flex justify-between items-center">
             <div class="flex items-center gap-3">
               <!-- Logo -->
               <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-[var(--accent-color)]" viewBox="0 0 24 24" fill="currentColor">
                  <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" />
                  <!-- Checkmark fills with sidebar bg color to simulate transparency -->
                  <path d="M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" style="fill: var(--bg-sidebar);" />
               </svg>
               <div>
                 <div class="font-medium text-[var(--text-primary)]">TrustBureau.ai</div>
                 <div class="text-[10px] text-[var(--text-muted)] uppercase tracking-wider">Offer Portal</div>
               </div>
             </div>
             <button (click)="toggleSidebar()" class="md:hidden text-[var(--text-secondary)] hover:text-[var(--text-primary)]">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
             </button>
          </div>

          <nav class="flex-1 p-4 space-y-1">
             <div class="nav-item" [class.active]="currentView() === 'dashboard'" (click)="switchView('dashboard')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 01-1 1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
                Dashboard
             </div>
             <!-- Business Search Removed -->
             <div class="nav-item" [class.active]="currentView() === 'calculator'" (click)="switchView('calculator')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                New Offer
             </div>
             <div class="nav-item" [class.active]="currentView() === 'offers'" (click)="switchView('offers')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                All Offers
             </div>
             <div class="nav-item" [class.active]="currentView() === 'accepted'" (click)="switchView('accepted')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                Accepted
             </div>
             <div class="nav-item" [class.active]="currentView() === 'clients'" (click)="switchView('clients')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Clients
             </div>
             <div class="nav-item" [class.active]="currentView() === 'settings'" (click)="switchView('settings')">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                Settings
             </div>
          </nav>

          <div class="p-4 border-t border-[var(--border-primary)]">
             <div class="nav-item" (click)="toggleTheme()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                <span>{{ isDark() ? 'Light Mode' : 'Dark Mode' }}</span>
             </div>
             <div class="text-[11px] text-[var(--text-muted)] mt-4 px-4 py-2 bg-[var(--bg-card-inner)] rounded-lg">Rep: <span class="text-[var(--text-secondary)] font-medium">{{ settings().repName || 'Not Set' }}</span></div>
          </div>
        </aside>
        
        <!-- Overlay -->
        <div class="sidebar-overlay" *ngIf="sidebarOpen()" (click)="toggleSidebar()"></div>

        <!-- Main Content -->
        <main class="main-content flex-1 md:ml-64 p-8 transition-all">
          
          <!-- Mobile Header -->
          <div class="md:hidden flex items-center justify-between mb-6 p-4 card-bg rounded-xl border border-[var(--border-primary)] shadow-sm">
            <button (click)="toggleSidebar()" class="p-2 rounded-lg hover:bg-[var(--bg-card-inner)] text-[var(--text-secondary)]">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
            </button>
            <span class="font-medium text-[var(--text-primary)]">TrustBureau.ai</span>
            <div class="w-8"></div>
          </div>

          <!-- Page Header -->
          <header class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
            <div>
              <h1 class="text-2xl font-bold text-[var(--text-primary)]">{{ getPageTitle() }}</h1>
              <p class="text-sm text-[var(--text-muted)] mt-1">Welcome back! Here's your offer activity.</p>
            </div>
            <div class="flex gap-3">
              <button *ngIf="editingOfferId()" (click)="cancelEdit()" class="button-secondary">Cancel Edit</button>
              <button (click)="switchView('calculator')" class="button-primary flex items-center gap-2 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                <span>New Offer</span>
              </button>
            </div>
          </header>

          <!-- DASHBOARD VIEW -->
          <div *ngIf="currentView() === 'dashboard'" class="space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
              <div class="stat-card"><div class="stat-label mb-2">Total Offers</div><div class="stat-value">{{ stats().total }}</div></div>
              <div class="stat-card"><div class="stat-label mb-2">Pending</div><div class="stat-value text-yellow-500">{{ stats().pending }}</div></div>
              <div class="stat-card"><div class="stat-label mb-2">Accepted</div><div class="stat-value text-green-500">{{ stats().accepted }}</div></div>
              <div class="stat-card"><div class="stat-label mb-2">Total Value</div><div class="stat-value text-hero">{{ stats().value | currency:'USD':'symbol':'1.0-0' }}</div></div>
            </div>

            <div class="card-bg rounded-2xl border border-[var(--border-primary)]">
              <div class="p-5 border-b border-[var(--border-primary)] flex flex-col sm:flex-row sm:items-center justify-between gap-4">
                <h2 class="font-medium text-[var(--text-primary)]">Recent Offers</h2>
                <div class="toggle-group">
                  <button class="toggle-btn" [class.active]="currentFilter() === 'all'" (click)="currentFilter.set('all')">All</button>
                  <button class="toggle-btn" [class.active]="currentFilter() === 'pending'" (click)="currentFilter.set('pending')">Pending</button>
                  <button class="toggle-btn" [class.active]="currentFilter() === 'accepted'" (click)="currentFilter.set('accepted')">Accepted</button>
                </div>
              </div>
              <div class="p-5 grid gap-4">
                <div *ngFor="let offer of filteredOffers()" (click)="viewOfferDetails(offer)" class="offer-card cursor-pointer">
                  <div class="flex justify-between items-start mb-3">
                    <div>
                      <div class="font-medium text-[var(--text-primary)]">{{ offer.businessName || 'Unnamed Business' }}</div>
                      <div class="text-[11px] text-[var(--text-muted)] mt-1">
                        {{ offer.options[0].amount | currency:'USD':'symbol':'1.0-0' }} • {{ offer.options[0].payment | currency:'USD' }}/{{ getFreqShort(offer.options[0].frequency) }}
                      </div>
                    </div>
                    <span class="badge" [ngClass]="getStatusClass(offer.status)">{{ offer.status | uppercase }}</span>
                  </div>
                  <div class="flex justify-between text-[11px] text-[var(--text-muted)] mt-1">
                    <span>Created: {{ offer.createdAt | date:'shortDate' }}</span>
                    <span>Expires: {{ offer.expiresAt | date:'shortDate' }}</span>
                  </div>
                </div>
                <div *ngIf="filteredOffers().length === 0" class="empty-state">
                  <p>No offers found.</p>
                </div>
              </div>
            </div>
          </div>

          <!-- CALCULATOR VIEW -->
          <div *ngIf="currentView() === 'calculator'" class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="space-y-6">
              <!-- Client Info -->
              <div class="card-bg rounded-2xl border border-[var(--border-primary)] p-6">
                <div class="flex items-center justify-between mb-4">
                  <h3 class="section-header mb-0">Client Information</h3>
                  <button (click)="toggleContactInfo = !toggleContactInfo" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium border border-[var(--border-primary)] text-[var(--text-secondary)] bg-transparent hover:text-[var(--accent-color)] hover:border-[var(--accent-color)] transition-all">
                    <span>{{ toggleContactInfo ? 'Hide Details' : 'Add Details' }}</span>
                  </button>
                </div>
                <div class="space-y-4">
                  <input type="text" [(ngModel)]="currentOfferState.businessName" class="w-full p-3 border rounded-xl input-field text-sm" placeholder="Business Name">
                  <div *ngIf="toggleContactInfo" class="grid grid-cols-2 gap-4 pt-4 border-t border-[var(--border-primary)]">
                    <input type="text" [(ngModel)]="currentOfferState.contactName" class="w-full p-3 border rounded-xl input-field text-sm" placeholder="Contact Name">
                    <input type="email" [(ngModel)]="currentOfferState.email" class="w-full p-3 border rounded-xl input-field text-sm" placeholder="Email Address">
                  </div>
                </div>
              </div>

              <!-- Calculator -->
              <div class="card-bg rounded-2xl border border-[var(--border-primary)] p-6">
                <div class="flex items-center justify-between mb-5">
                  <h3 class="section-header mb-0">Funding Terms</h3>
                </div>
                <div class="calc-tabs">
                  <button *ngFor="let opt of currentOptions(); let i = index" (click)="activeOptionIndex.set(i)" 
                          class="calc-tab" [class.active]="activeOptionIndex() === i">Option {{ i + 1 }}</button>
                  <button *ngIf="currentOptions().length < 3" (click)="addOption()" class="add-tab-btn">+ Add</button>
                </div>

                <div class="space-y-6">
                  <!-- Amount -->
                  <div>
                    <div class="flex justify-between items-center mb-3">
                      <label class="text-xs font-medium text-[var(--text-secondary)]">Funding Amount</label>
                      <button *ngIf="currentOptions().length > 1" (click)="removeOption()" class="text-xs text-red-500 font-medium hover:text-red-600">Remove Option</button>
                    </div>
                    <div class="flex items-center gap-3 mb-3">
                      <div class="relative w-full">
                        <span class="absolute left-4 top-1/2 -translate-y-1/2 text-[var(--text-muted)] font-medium">$</span>
                        <input type="number" [(ngModel)]="activeOption().amount" class="w-full p-3 pl-8 border rounded-xl input-field font-medium text-lg">
                      </div>
                    </div>
                    <input type="range" min="5000" max="1000000" step="1000" [(ngModel)]="activeOption().amount" 
                           [style.background]="getSliderGradient(activeOption().amount, 5000, 1000000)">
                  </div>

                  <!-- Factor & Term -->
                  <div class="grid grid-cols-2 gap-6">
                    <div>
                      <div class="flex justify-between items-center mb-3"><label class="text-xs font-medium text-[var(--text-secondary)]">Factor Rate</label></div>
                      <div class="relative mb-3">
                        <input type="number" step="0.01" [(ngModel)]="activeOption().factor" class="w-full p-3 border rounded-xl input-field font-medium text-sm">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-[var(--text-muted)] text-xs font-medium">x</span>
                      </div>
                      <input type="range" min="1.05" max="1.7" step="0.01" [(ngModel)]="activeOption().factor"
                             [style.background]="getSliderGradient(activeOption().factor, 1.05, 1.7)">
                    </div>
                    <div>
                      <div class="flex justify-between items-center mb-3"><label class="text-xs font-medium text-[var(--text-secondary)]">Term</label></div>
                      <div class="relative mb-3">
                        <input type="number" [(ngModel)]="activeOption().term" class="w-full p-3 border rounded-xl input-field font-medium text-sm">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-[var(--text-muted)] text-xs font-medium">Pmts</span>
                      </div>
                      <input type="range" min="10" max="300" step="1" [(ngModel)]="activeOption().term"
                             [style.background]="getSliderGradient(activeOption().term, 10, 300)">
                    </div>
                  </div>

                  <!-- Frequency -->
                  <div>
                    <label class="block text-xs font-medium text-[var(--text-secondary)] mb-3">Payment Frequency</label>
                    <div class="toggle-group w-full flex">
                      <button *ngFor="let f of ['daily', 'weekly', 'monthly']" class="toggle-btn flex-1 py-3 text-xs capitalize" 
                              [class.active]="activeOption().frequency === f" (click)="activeOption().frequency = $any(f)">{{ f }}</button>
                    </div>
                  </div>

                  <div class="border-t border-[var(--border-primary)] my-2"></div>

                  <!-- Toggles -->
                  <div>
                    <h4 class="section-header">Additional Options</h4>
                    <div class="option-toggles-grid">
                      <!-- Fee -->
                      <div class="option-toggle-card">
                        <div class="flex items-center justify-between">
                          <span class="text-sm font-medium text-[var(--text-primary)]">Origination Fee</span>
                          <label class="switch scale-90 origin-right"><input type="checkbox" [(ngModel)]="toggles.fee"><span class="slider"></span></label>
                        </div>
                        <div *ngIf="toggles.fee" class="mt-3 pt-3 border-t border-[var(--border-primary)]/50">
                          <div class="flex items-center gap-2 mb-2">
                            <input type="number" [(ngModel)]="activeOption().fee" class="w-20 p-2 bg-transparent border border-[var(--border-primary)] rounded-lg outline-none font-medium text-sm text-[var(--text-primary)]">
                            <span class="text-sm text-[var(--text-muted)] font-medium">%</span>
                          </div>
                          <input type="range" min="0" max="15" step="0.5" [(ngModel)]="activeOption().fee" class="w-full h-1"
                                 [style.background]="getSliderGradient(activeOption().fee, 0, 15)">
                        </div>
                      </div>

                      <!-- Prepay -->
                      <div class="option-toggle-card">
                        <div class="flex items-center justify-between">
                          <span class="text-sm font-medium text-[var(--text-primary)]">Prepay Discount</span>
                          <label class="switch scale-90 origin-right"><input type="checkbox" [(ngModel)]="toggles.prepay"><span class="slider"></span></label>
                        </div>
                        <div *ngIf="toggles.prepay" class="mt-3 pt-3 border-t border-[var(--border-primary)]/50">
                          <div class="flex items-center gap-2 mb-2">
                            <input type="number" [(ngModel)]="activeOption().prepayDiscount" class="w-20 p-2 bg-transparent border border-[var(--border-primary)] rounded-lg outline-none font-medium text-sm text-[var(--text-primary)]">
                            <span class="text-sm text-[var(--text-muted)] font-medium">%</span>
                          </div>
                          <input type="range" min="0" max="50" step="1" [(ngModel)]="activeOption().prepayDiscount" class="w-full h-1"
                                 [style.background]="getSliderGradient(activeOption().prepayDiscount, 0, 50)">
                        </div>
                      </div>

                      <!-- Override -->
                      <div class="option-toggle-card">
                        <div class="flex items-center justify-between">
                          <span class="text-sm font-medium text-[var(--text-primary)]">Custom Term Label</span>
                          <label class="switch scale-90 origin-right"><input type="checkbox" [(ngModel)]="toggles.override"><span class="slider"></span></label>
                        </div>
                        <div *ngIf="toggles.override" class="mt-3 pt-3 border-t border-[var(--border-primary)]/50">
                          <input type="text" [(ngModel)]="activeOption().termOverride" class="w-full p-2 border rounded-lg input-field bg-[var(--bg-card)] text-sm text-[var(--text-primary)]" placeholder="e.g. 6 Months">
                        </div>
                      </div>
                      
                      <!-- Expiry -->
                      <div class="option-toggle-card">
                        <div class="flex items-center justify-between">
                          <span class="text-sm font-medium text-[var(--text-primary)]">Set Expiration</span>
                          <label class="switch scale-90 origin-right"><input id="toggleExpiry" type="checkbox" (change)="toggleExpiry($event)"><span class="slider"></span></label>
                        </div>
                        <div *ngIf="isExpiryToggled" class="mt-3 pt-3 border-t border-[var(--border-primary)]/50">
                           <input type="date" [ngModel]="customExpiryDate" (ngModelChange)="customExpiryDate = $event" class="w-full p-2 border rounded-lg input-field bg-[var(--bg-card)] text-sm text-[var(--text-primary)]">
                        </div>
                      </div>

                      <!-- Notes -->
                      <div class="option-toggle-card full-width">
                        <div class="flex items-center justify-between">
                          <span class="text-sm font-medium text-[var(--text-primary)]">Approval Notes (Client Visible)</span>
                          <label class="switch scale-90 origin-right"><input type="checkbox" [(ngModel)]="toggles.notes"><span class="slider"></span></label>
                        </div>
                        <div *ngIf="toggles.notes" class="mt-3 pt-3 border-t border-[var(--border-primary)]/50">
                          <textarea [(ngModel)]="activeOption().notes" rows="3" class="w-full p-3 border rounded-lg input-field bg-[var(--bg-card)] text-sm text-[var(--text-primary)] resize-none" placeholder="Enter notes here... Use 'Enter' for new bullets."></textarea>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="flex gap-4">
                <button (click)="resetCalculator()" class="button-secondary flex-1">Reset</button>
                <button (click)="saveOffer()" class="button-primary flex-1">{{ editingOfferId() ? 'Update Offer' : 'Create & Share Offer' }}</button>
              </div>
            </div>

            <!-- Preview Column -->
            <div class="space-y-6">
              <div class="preview-card">
                <div class="text-center pb-5 border-b border-[var(--border-primary)] mb-5">
                  <h4 class="section-header mb-0">Option {{ activeOptionIndex() + 1 }} Preview</h4>
                </div>
                <div *ngIf="currentOfferState.businessName" class="text-center text-sm font-medium text-[var(--text-primary)] mb-3">{{ currentOfferState.businessName }}</div>
                
                <div class="text-center py-6">
                  <span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-widest mb-2">You Get</span>
                  <span class="text-5xl font-bold block text-hero leading-tight">{{ activeOption().amount | currency:'USD':'symbol':'1.0-0' }}</span>
                </div>

                <div class="my-6 flex justify-center">
                  <div class="chart-wrapper">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                      <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                      <path class="circle" [attr.stroke-dasharray]="getPreviewCircle()" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="chart-text">
                      <span class="text-[9px] font-bold text-[var(--text-muted)] block uppercase tracking-wider">Payback</span>
                      <span class="text-lg font-bold text-[var(--text-primary)] block">{{ getPreviewCalculations().totalPayback | currency:'USD':'symbol':'1.0-0' }}</span>
                    </div>
                  </div>
                </div>
                
                <div id="previewAprContainer" *ngIf="settings().showApr" class="p-4 rounded-xl text-center mb-5" style="background: var(--bg-card-inner);">
                   <span class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider">Estimated APR</span>
                   <span class="text-3xl font-bold text-hero block mt-1">{{ getPreviewCalculations().apr }}%</span>
                </div>

                <div class="border border-[var(--border-primary)] rounded-2xl overflow-hidden">
                  <div class="grid grid-cols-2 divide-x divide-[var(--border-primary)] border-b border-[var(--border-primary)]">
                    <div class="p-4 text-center"><span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Term Length</span><span class="text-sm font-medium text-[var(--text-primary)]">{{ activeOption().termOverride || getPreviewCalculations().termMonths + ' months' }}</span></div>
                    <div class="p-4 text-center"><span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Payments</span><span class="text-sm font-medium text-[var(--text-primary)]">{{ activeOption().term }}</span></div>
                  </div>
                  <div class="grid grid-cols-2 divide-x divide-[var(--border-primary)] border-b border-[var(--border-primary)]">
                    <div class="p-4 text-center"><span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Factor Rate</span><span class="text-sm font-semibold text-[var(--text-primary)]">{{ activeOption().factor | number:'1.2-2' }}x</span></div>
                    <div class="p-4 text-center"><span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Total Cost</span><span class="text-sm font-semibold text-[var(--text-primary)]">{{ getPreviewCalculations().totalCost | currency:'USD':'symbol':'1.0-0' }}</span></div>
                  </div>
                  <div *ngIf="activeOption().fee > 0" class="grid grid-cols-2 divide-x divide-[var(--border-primary)] border-b border-[var(--border-primary)]">
                     <div class="p-4 text-center"><span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Origination Fee</span><span class="text-sm font-medium text-[var(--text-primary)]">{{ getPreviewCalculations().feeAmount | currency:'USD':'symbol':'1.0-0' }}</span></div>
                     <div class="p-4 text-center"><span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Net Proceeds</span><span class="text-sm font-medium text-[var(--text-primary)]">{{ getPreviewCalculations().netProceeds | currency:'USD':'symbol':'1.0-0' }}</span></div>
                  </div>
                  <div class="p-5 text-center" style="background: var(--bg-card-inner);">
                    <span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Est. {{ activeOption().frequency }} Payment</span>
                    <span class="text-xl font-bold text-[var(--text-primary)]">{{ getPreviewCalculations().payment | currency:'USD' }}</span>
                  </div>
                </div>
                
                <div class="text-center mt-6">
                   <button (click)="openAmortSchedule()" class="text-xs font-bold text-[var(--accent-color)] hover:underline">View Amortization Schedule</button>
                </div>
              </div>
            </div>
          </div>

          <!-- CLIENT VIEW (Inside Dashboard) -->
          <div *ngIf="viewMode() === 'client'" class="min-h-screen flex items-center justify-center">
             <!-- Re-using standalone Client View Logic Below -->
          </div>

          <!-- SETTINGS & OTHER VIEWS REMOVED FOR BREVITY IN TEMPLATE, LOGIC IS SAME -->
          <div *ngIf="currentView() === 'offers'" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
             <div *ngFor="let offer of filteredOffers()" (click)="viewOfferDetails(offer)" class="offer-card cursor-pointer">
                <div class="flex justify-between items-start mb-3">
                   <div class="font-bold text-[var(--text-primary)] text-base">{{ offer.businessName }}</div>
                   <span class="badge" [ngClass]="getStatusClass(offer.status)">{{ offer.status }}</span>
                </div>
                <div class="text-sm text-[var(--text-muted)]">{{ offer.options[0].amount | currency:'USD' }}</div>
             </div>
          </div>

           <!-- VIEW: SETTINGS -->
           <div *ngIf="currentView() === 'settings'" class="max-w-2xl mx-auto">
              
              <!-- Rep Info -->
              <div class="bg-[var(--bg-card-inner)] border border-[var(--border-primary)] rounded-xl p-5 mb-6">
                 <h3 class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider mb-4">Rep Information</h3>
                 <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                       <label class="block text-xs font-semibold text-[var(--text-secondary)] mb-2">Rep Name</label>
                       <input type="text" [(ngModel)]="settings().repName" class="w-full p-3 rounded-lg border border-[var(--border-primary)] bg-[var(--bg-input)] text-sm">
                    </div>
                    <div>
                       <label class="block text-xs font-semibold text-[var(--text-secondary)] mb-2">Email</label>
                       <input type="text" [(ngModel)]="settings().repEmail" class="w-full p-3 rounded-lg border border-[var(--border-primary)] bg-[var(--bg-input)] text-sm">
                    </div>
                 </div>
                 <div class="grid grid-cols-2 gap-4">
                     <div>
                        <label class="block text-xs font-semibold text-[var(--text-secondary)] mb-2">Company Name</label>
                        <input type="text" [(ngModel)]="settings().companyName" class="w-full p-3 rounded-lg border border-[var(--border-primary)] bg-[var(--bg-input)] text-sm">
                     </div>
                     <div>
                        <label class="block text-xs font-semibold text-[var(--text-secondary)] mb-2">Logo URL</label>
                        <input type="text" [(ngModel)]="settings().logoUrl" class="w-full p-3 rounded-lg border border-[var(--border-primary)] bg-[var(--bg-input)] text-sm">
                     </div>
                 </div>
              </div>

              <!-- Appearance -->
              <div class="bg-[var(--bg-card-inner)] border border-[var(--border-primary)] rounded-xl p-5 mb-6">
                 <h3 class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider mb-4">Appearance</h3>
                 <div class="flex flex-wrap gap-3 mb-4">
                    <button *ngFor="let c of ['mint','blue','gold','purple','red','orange','pink','indigo','teal','lime','cyan','black','grey','white','glow']"
                            (click)="updateAccent(c)"
                            class="w-8 h-8 rounded-full border-2 transition-transform hover:scale-110"
                            [class.border-[var(--text-primary)]]="settings().accent === c"
                            [class.border-transparent]="settings().accent !== c"
                            [style.background-color]="getColorHex(c)">
                    </button>
                 </div>
                 <div class="flex items-center gap-2">
                    <input type="checkbox" [(ngModel)]="settings().showApr" id="showApr" class="accent-[var(--accent-color)]">
                    <label for="showApr" class="text-sm font-medium text-[var(--text-primary)]">Show APR on Offers</label>
                 </div>
              </div>

              <!-- Defaults -->
              <div class="bg-[var(--bg-card-inner)] border border-[var(--border-primary)] rounded-xl p-5 mb-6">
                 <h3 class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider mb-4">Default Offer Terms</h3>
                 <div class="grid grid-cols-3 gap-4">
                    <div>
                       <label class="block text-xs font-semibold text-[var(--text-secondary)] mb-2">Default Factor</label>
                       <input type="number" step="0.01" [(ngModel)]="settings().defaultFactor" class="w-full p-3 rounded-lg border border-[var(--border-primary)] bg-[var(--bg-input)] text-sm">
                    </div>
                    <div>
                       <label class="block text-xs font-semibold text-[var(--text-secondary)] mb-2">Default Term</label>
                       <input type="number" [(ngModel)]="settings().defaultTerm" class="w-full p-3 rounded-lg border border-[var(--border-primary)] bg-[var(--bg-input)] text-sm">
                    </div>
                    <div>
                       <label class="block text-xs font-semibold text-[var(--text-secondary)] mb-2">Expiry (Days)</label>
                       <input type="number" [(ngModel)]="settings().defaultExpiry" class="w-full p-3 rounded-lg border border-[var(--border-primary)] bg-[var(--bg-input)] text-sm">
                    </div>
                 </div>
              </div>

              <button (click)="saveSettings()" class="w-full py-3 rounded-xl font-bold bg-[var(--text-primary)] text-[var(--bg-card)] hover:opacity-90 transition-opacity">Save Settings</button>
           </div>

        </main>
      </div>

      <!-- === CLIENT VIEW MODE (STANDALONE) === -->
      <div *ngIf="viewMode() === 'client'" class="client-view">
         <div class="client-card max-w-4xl p-0">
            <div class="p-6 border-b border-[var(--border-primary)] text-center">
               <div class="flex justify-center mb-3">
                  <img *ngIf="clientOffer()?.logoUrl" [src]="clientOffer()?.logoUrl" class="h-14 w-auto object-contain">
                  <div *ngIf="!clientOffer()?.logoUrl" class="w-14 h-14 rounded-2xl flex items-center justify-center bg-[var(--accent-color)] text-white">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24" fill="currentColor"><path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" /></svg>
                  </div>
               </div>
               <div class="font-bold text-[var(--text-primary)] text-2xl">{{ clientOffer()?.companyName || 'TrustBureau.ai' }}</div>
               
               <div *ngIf="clientOffer()?.status === 'pending'" class="expiration-banner mx-auto mt-6 inline-flex shadow-lg">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-hero" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  <span class="text-sm font-medium text-[var(--text-secondary)] mr-2">Expires in</span>
                  <div class="flex gap-1 font-mono font-bold text-[var(--text-primary)]" *ngIf="clientTimer()">
                     <span class="timer-digit">{{ clientTimer().days }}d</span>:
                     <span class="timer-digit">{{ clientTimer().hours }}h</span>:
                     <span class="timer-digit">{{ clientTimer().minutes }}m</span>
                  </div>
               </div>
            </div>

            <div class="p-8">
               <div class="text-center py-6">
                  <span class="text-[11px] font-bold text-[var(--text-muted)] block uppercase tracking-widest mb-2">You Get</span>
                  <span class="text-6xl font-bold block text-hero tracking-tight">{{ clientCalculated().amount | currency:'USD':'symbol':'1.0-0' }}</span>
                  
                  <!-- New Slider -->
                  <div class="mt-6 max-w-xs mx-auto">
                     <input type="range" 
                            [min]="5000" 
                            [max]="getClientActiveOption().amount" 
                            [step]="1000"
                            [ngModel]="clientAdjustedAmount()" 
                            (ngModelChange)="clientAdjustedAmount.set($event)"
                            [style.background]="getSliderGradient(clientAdjustedAmount(), 5000, getClientActiveOption().amount)"
                            class="w-full h-2 rounded-lg appearance-none cursor-pointer bg-[var(--bg-slider-track)]">
                     <div class="flex justify-between text-[10px] text-[var(--text-muted)] mt-2 font-medium px-1">
                        <span>$5,000</span>
                        <span>Approved: {{ getClientActiveOption().amount | currency:'USD':'symbol':'1.0-0' }}</span>
                     </div>
                  </div>
               </div>

               <div class="my-8 flex justify-center">
                  <div class="chart-wrapper">
                     <svg viewBox="0 0 36 36" class="circular-chart">
                        <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        <path class="circle" [attr.stroke-dasharray]="getClientActiveCircle()" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                     </svg>
                     <div class="chart-text">
                        <span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider">Payback</span>
                        <span class="text-lg font-bold text-[var(--text-primary)]">{{ clientCalculated().totalPayback | currency:'USD':'symbol':'1.0-0' }}</span>
                     </div>
                  </div>
               </div>

               <div class="border border-[var(--border-primary)] rounded-2xl overflow-hidden mb-8">
                  <div class="grid grid-cols-2 divide-x divide-[var(--border-primary)] border-b border-[var(--border-primary)]">
                     <div class="p-5 text-center"><span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Term</span><span class="text-lg font-bold text-[var(--text-primary)]">{{ clientCalculated().termOverride || clientCalculated().termMonths + ' mo' }}</span></div>
                     <div class="p-5 text-center"><span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Cost</span><span class="text-lg font-bold text-[var(--text-primary)]">{{ clientCalculated().totalCost | currency:'USD':'symbol':'1.0-0' }}</span></div>
                  </div>
                  <div class="p-6 text-center bg-[var(--bg-card-inner)]">
                     <span class="text-[10px] font-bold text-[var(--text-muted)] block uppercase tracking-wider mb-1">Est. {{ clientCalculated().frequency }} Payment</span>
                     <span class="text-2xl font-bold text-[var(--text-primary)]">{{ clientCalculated().payment | currency:'USD' }}</span>
                  </div>
               </div>

               <!-- Notes -->
               <div *ngIf="getClientActiveOption().notes" class="mb-8 p-5 bg-[var(--bg-card-inner)] rounded-xl text-xs border border-[var(--border-primary)]">
                  <div class="font-bold text-[var(--text-muted)] uppercase tracking-wider mb-3">Approval Notes</div>
                  <div class="text-[var(--text-secondary)] whitespace-pre-wrap leading-relaxed">{{ getClientActiveOption().notes }}</div>
               </div>

               <button *ngIf="clientOffer()?.status === 'pending'" (click)="acceptClientOffer()" class="button-primary w-full py-4 text-sm uppercase tracking-wider shadow-lg">Accept This Offer</button>
               <div *ngIf="clientOffer()?.status === 'accepted'" class="text-center py-6 bg-green-50 border border-green-200 rounded-2xl text-green-700 font-bold text-xl">Offer Accepted!</div>

               <!-- Other Options Grid -->
               <div *ngIf="clientOffer()?.options?.length > 1" class="mt-10 pt-8 border-t border-[var(--border-primary)]">
                  <h4 class="text-xs font-bold text-[var(--text-muted)] uppercase text-center mb-6 tracking-widest">Other Options</h4>
                  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                     <div *ngFor="let opt of clientOffer()?.options; let i = index" 
                          (click)="switchClientOption(i)"
                          class="p-5 rounded-xl border border-[var(--border-primary)] cursor-pointer hover:border-accent-color transition-all bg-[var(--bg-card)] hover:shadow-md"
                          [class.ring-2]="activeClientOptionIndex() === i"
                          [class.ring-[var(--accent-color)]]="activeClientOptionIndex() === i">
                        <div class="flex justify-between items-center mb-1">
                           <span class="text-[10px] font-bold text-[var(--text-muted)] uppercase tracking-wider">Option {{i+1}}</span>
                           <span class="text-lg font-bold text-[var(--text-primary)]">{{ opt.amount | currency:'USD':'symbol':'1.0-0' }}</span>
                        </div>
                        <div class="text-xs text-[var(--text-muted)]">{{ opt.termOverride || opt.termMonths + ' mo' }} • {{ opt.frequency }}</div>
                     </div>
                  </div>
               </div>
            </div>
         </div>
      </div>

      <!-- MODALS -->
      <div class="modal-overlay" *ngIf="selectedOffer" (click)="selectedOffer = null">
         <div class="modal-content" (click)="$event.stopPropagation()">
            <div class="p-6 border-b border-[var(--border-primary)] flex justify-between items-center">
               <h3 class="text-lg font-bold text-[var(--text-primary)]">Offer Details</h3>
               <button (click)="selectedOffer = null" class="p-2 rounded-lg hover:bg-[var(--bg-card-inner)]">✕</button>
            </div>
            <div class="p-6">
               <div class="text-center mb-6">
                  <div class="text-2xl font-bold text-[var(--text-primary)]">{{ selectedOffer?.businessName }}</div>
                  <div class="text-sm text-[var(--text-muted)]">{{ selectedOffer?.createdAt | date }}</div>
               </div>
               <div *ngFor="let opt of selectedOffer?.options; let i = index" class="mb-4 bg-[var(--bg-card-inner)] rounded-xl p-4 border border-[var(--border-primary)]">
                  <div class="flex justify-between items-center mb-2">
                     <span class="text-xs font-bold text-[var(--text-muted)] uppercase tracking-wider">Option {{i+1}}</span>
                     <span class="text-xl font-bold text-hero">{{ opt.amount | currency:'USD':'symbol':'1.0-0' }}</span>
                  </div>
                  <div class="grid grid-cols-3 gap-2 text-center text-xs mt-2 text-[var(--text-muted)] font-medium">
                     <div>{{ opt.termOverride || opt.termMonths + ' mo' }}</div>
                     <div>{{ opt.factor }}x</div>
                     <div>{{ opt.payment | currency:'USD' }}</div>
                  </div>
               </div>
               <div class="flex justify-center mt-6">
                  <img [src]="'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + getOfferUrl(selectedOffer!.id)" 
                       class="border border-[var(--border-primary)] p-2 bg-white rounded-xl" alt="QR Code">
               </div>
            </div>
            <div class="p-6 border-t border-[var(--border-primary)] flex gap-3 bg-[var(--bg-card-inner)]">
               <button (click)="copyOfferText(selectedOffer!)" class="button-secondary flex-1 bg-[var(--bg-card)]">Copy Text</button>
               <button (click)="copyLink(selectedOffer!.id)" class="button-primary flex-1">Copy Link</button>
               <button (click)="openDeleteConfirm(selectedOffer!)" class="button-danger flex-1 bg-[var(--bg-card)]">Delete</button>
            </div>
         </div>
      </div>

      <!-- Delete Confirm -->
      <div class="modal-overlay" *ngIf="offerToDelete()" (click)="offerToDelete.set(null)">
         <div class="modal-content max-w-sm p-8 text-center" (click)="$event.stopPropagation()">
            <h3 class="text-lg font-bold mb-2 text-[var(--text-primary)]">Confirm Deletion</h3>
            <p class="text-[var(--text-muted)] mb-8">Are you sure you want to delete this offer?</p>
            <div class="flex gap-3">
               <button (click)="offerToDelete.set(null)" class="button-secondary flex-1">Cancel</button>
               <button (click)="executeDelete()" class="button-primary flex-1 bg-red-500 hover:bg-red-600 border-none text-white shadow-red-500/30">Delete</button>
            </div>
         </div>
      </div>

      <!-- Amortization Modal -->
      <div class="modal-overlay" *ngIf="amortModalOpen()" (click)="amortModalOpen.set(false)">
         <div class="modal-content max-w-2xl flex flex-col max-h-[80vh]" (click)="$event.stopPropagation()">
            <div class="p-6 border-b border-[var(--border-primary)] flex justify-between items-center bg-[var(--bg-card-inner)]">
               <div>
                  <h3 class="font-bold text-lg text-[var(--text-primary)]">Payment Schedule</h3>
                  <p class="text-xs text-[var(--text-muted)] mt-1">Estimated repayment timeline</p>
               </div>
               <button (click)="amortModalOpen.set(false)" class="p-2 rounded-lg hover:bg-[var(--bg-card-inner)]">✕</button>
            </div>
            <div class="overflow-y-auto flex-1">
               <table class="w-full text-sm amort-table">
                  <thead class="sticky top-0 bg-[var(--bg-card)] z-10"><tr><th>#</th><th>Date</th><th>Payment</th><th>Balance</th></tr></thead>
                  <tbody>
                     <tr *ngFor="let row of amortSchedule()">
                        <td>{{ row.index }}</td><td>{{ row.date | date:'shortDate' }}</td><td>{{ row.payment | currency:'USD' }}</td><td>{{ row.balance | currency:'USD' }}</td>
                     </tr>
                  </tbody>
               </table>
            </div>
         </div>
      </div>

    </div>
  `,
  styles: [`
    :host { display: block; font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; }
    
    /* Theme Variables */
    .theme-light { --bg-body: #f8fafc; --bg-card: #ffffff; --bg-card-inner: #f1f5f9; --bg-input: #ffffff; --bg-sidebar: #ffffff; --border-primary: #e2e8f0; --text-primary: #0f172a; --text-secondary: #475569; --text-muted: #94a3b8; --text-success: #16a34a; --text-warning: #d97706; --text-danger: #dc2626; --shadow-color: rgba(0, 0, 0, 0.05); --bg-slider-track: #e2e8f0; }
    .theme-dark { --bg-body: #000000; --bg-card: #121212; --bg-card-inner: #18181b; --bg-input: #18181b; --bg-sidebar: #121212; --border-primary: #27272a; --text-primary: #f8fafc; --text-secondary: #cbd5e1; --text-muted: #94a3b8; --text-success: #4ade80; --text-warning: #fbbf24; --text-danger: #f87171; --shadow-color: rgba(0, 0, 0, 0.8); --bg-slider-track: #27272a; }

    /* Accents */
    .accent-mint { --accent-color: #42D197; --accent-color-light: #74eabc; --accent-color-dark: #2d9668; --accent-text-inverted: #ffffff; }
    .accent-blue { --accent-color: #3b82f6; --accent-color-light: #60a5fa; --accent-color-dark: #2563eb; --accent-text-inverted: #ffffff; }
    .accent-gold { --accent-color: #D19B2B; --accent-color-light: #e6b650; --accent-color-dark: #a6781c; --accent-text-inverted: #020617; }
    .accent-purple { --accent-color: #a855f7; --accent-color-light: #c084fc; --accent-color-dark: #9333ea; --accent-text-inverted: #ffffff; }
    .accent-red { --accent-color: #ef4444; --accent-color-light: #f87171; --accent-color-dark: #dc2626; --accent-text-inverted: #ffffff; }
    .accent-orange { --accent-color: #f97316; --accent-color-light: #fb923c; --accent-color-dark: #ea580c; --accent-text-inverted: #020617; }
    .accent-pink { --accent-color: #ec4899; --accent-color-light: #f472b6; --accent-color-dark: #db2777; --accent-text-inverted: #020617; }
    .accent-indigo { --accent-color: #6366f1; --accent-color-light: #818cf8; --accent-color-dark: #4f46e5; --accent-text-inverted: #ffffff; }
    .accent-teal { --accent-color: #14b8a6; --accent-color-light: #2dd4bf; --accent-color-dark: #0d9488; --accent-text-inverted: #ffffff; }
    .accent-lime { --accent-color: #84cc16; --accent-color-light: #a3e635; --accent-color-dark: #65a30d; --accent-text-inverted: #020617; }
    .accent-cyan { --accent-color: #06b6d4; --accent-color-light: #22d3ee; --accent-color-dark: #0891b2; --accent-text-inverted: #ffffff; }
    .accent-black { --accent-color: #18181b; --accent-color-light: #3f3f46; --accent-color-dark: #09090b; --accent-text-inverted: #ffffff; }
    .accent-grey { --accent-color: #64748b; --accent-color-light: #94a3b8; --accent-color-dark: #475569; --accent-text-inverted: #ffffff; }
    .accent-white { --accent-color: #ffffff; --accent-color-light: #f1f5f9; --accent-color-dark: #cbd5e1; --accent-text-inverted: #0f172a; }
    .accent-glow { --accent-color: #d946ef; --accent-color-light: #e879f9; --accent-color-dark: #c026d3; --accent-text-inverted: #ffffff; }
    
    .text-hero { color: var(--accent-color); }
    .card-bg { background-color: var(--bg-card); border-color: var(--border-primary); }
    .sidebar-bg { background-color: var(--bg-sidebar); border-color: var(--border-primary); }
    
    /* Inputs */
    .input-field { background-color: var(--bg-input); border-color: var(--border-primary); color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; font-size: 14px; font-weight: 400; outline: none; }
    .input-field:focus { border-color: var(--accent-color); box-shadow: 0 0 0 1px var(--accent-color); }
    
    /* Buttons */
    .button-primary { background-color: var(--accent-color); color: var(--accent-text-inverted); font-weight: 600; border-radius: 10px; padding: 10px 20px; border: none; transition: all 0.2s ease; font-size: 13px; box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-color) 30%, transparent); }
    .button-primary:hover { background-color: var(--accent-color-light); transform: translateY(-1px); }
    .button-secondary { background: transparent; color: var(--text-secondary); font-weight: 600; border-radius: 10px; padding: 10px 20px; border: 1px solid var(--border-primary); transition: all 0.2s ease; font-size: 13px; }
    .button-secondary:hover { border-color: var(--accent-color); color: var(--accent-color); }
    .button-danger { background: transparent; color: #ef4444; font-weight: 600; border-radius: 10px; padding: 10px 20px; border: 1px solid #fecaca; transition: all 0.2s ease; font-size: 13px; }
    
    /* Tabs & Toggles */
    .calc-tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border-primary); padding-bottom: 2px; }
    .calc-tab { padding: 8px 16px; border-radius: 8px 8px 0 0; font-size: 13px; font-weight: 600; color: var(--text-secondary); background: transparent; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; position: relative; bottom: -3px; }
    .calc-tab.active { background: var(--bg-card); color: var(--accent-color); border: 1px solid var(--border-primary); border-bottom-color: var(--bg-card); }
    .add-tab-btn { padding: 8px 12px; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; }
    
    .toggle-group { display: inline-flex; background: var(--bg-card-inner); border: 1px solid var(--border-primary); border-radius: 12px; padding: 4px; gap: 4px; }
    .toggle-btn { padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 500; color: var(--text-secondary); background: transparent; border: none; cursor: pointer; transition: all 0.2s ease; }
    .toggle-btn.active { background: var(--accent-color); color: var(--accent-text-inverted); font-weight: 600; box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-color) 40%, transparent); }

    /* Sliders */
    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; height: 6px; border-radius: 999px; outline: none; }
    input[type=range]::-webkit-slider-thumb { height: 20px; width: 20px; border-radius: 50%; background: var(--accent-color); cursor: pointer; -webkit-appearance: none; margin-top: -7px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); border: 3px solid var(--bg-card); transition: transform 0.15s ease; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: transparent; border-radius: 999px; }

    /* Cards & Stats */
    .stat-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 20px; }
    .stat-value { font-size: 32px; font-weight: 600; color: var(--text-primary); }
    .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }
    .offer-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 20px; transition: all 0.2s ease; }
    .offer-card:hover { box-shadow: 0 8px 25px var(--shadow-color); transform: translateY(-2px); }

    /* Nav */
    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; font-size: 14px; font-weight: 500; color: var(--text-secondary); transition: all 0.15s ease; cursor: pointer; }
    .nav-item:hover { background: var(--bg-card-inner); color: var(--text-primary); }
    .nav-item.active { background: color-mix(in srgb, var(--accent-color) 15%, transparent); color: var(--accent-color-dark); font-weight: 600; }
    .theme-dark .nav-item.active { color: var(--accent-color); }

    /* Charts & Badges */
    .chart-wrapper { position: relative; width: 140px; height: 140px; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
    .chart-text { position: absolute; text-align: center; z-index: 10; }
    .circle-bg { fill: none; stroke: var(--bg-slider-track); stroke-width: 2.5; }
    .circle { fill: none; stroke-width: 2.5; stroke-linecap: round; stroke: var(--accent-color); transition: stroke-dasharray 0.6s ease-out; }
    
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .badge.pending { background: #fef3c7; color: #92400e; }
    .badge.accepted { background: #d1fae5; color: #065f46; }
    .badge.expired { background: #fee2e2; color: #991b1b; }

    /* Modals & Overlays */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal-content { background: var(--bg-card); border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }
    .amort-table th { background-color: var(--bg-slider-track); color: var(--text-secondary); font-size: 0.65rem; text-transform: uppercase; padding: 0.75rem 0.5rem; font-weight: 500; border-bottom: 2px solid var(--accent-color); text-align: right; }
    .amort-table th:first-child { text-align: left; }
    .amort-table td { border-bottom: 1px solid var(--border-primary); color: var(--text-primary); font-size: 0.75rem; padding: 0.6rem 0.5rem; text-align: right; }
    .amort-table td:first-child { text-align: left; }

    /* Utilities */
    .hidden { display: none; }
    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-primary); transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(20px); }
    
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--text-primary); color: var(--bg-card); padding: 14px 20px; border-radius: 12px; font-size: 13px; font-weight: 500; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 200; display: flex; align-items: center; gap: 10px; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }

    /* New Calculator Styles */
    .option-toggles-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .option-toggle-card { background: var(--bg-card-inner); border-radius: 12px; padding: 14px 16px; border: 1px solid var(--border-primary); transition: all 0.2s ease; }
    .option-toggle-card:hover { border-color: color-mix(in srgb, var(--accent-color) 50%, var(--border-primary)); }
    .option-toggle-card.full-width { grid-column: 1 / -1; }
    .section-header { font-size: 11px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 16px; }
    .preview-card { background: var(--bg-card); border: 3px solid var(--accent-color); border-radius: 24px; padding: 28px; position: sticky; top: 24px; box-shadow: 0 8px 30px color-mix(in srgb, var(--accent-color) 15%, transparent); }
    
    /* Client View Specifics */
    .client-card { background: var(--bg-card); border-radius: 24px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); overflow: hidden; border: 4px solid var(--accent-color); transition: transform 0.2s; }
    .expiration-banner { background: linear-gradient(135deg, color-mix(in srgb, var(--accent-color) 15%, transparent), color-mix(in srgb, var(--accent-color) 5%, transparent)); border: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent); border-radius: 14px; padding: 14px 20px; display: flex; align-items: center; justify-content: center; gap: 12px; }
    .timer-digit { background: var(--bg-card); border-radius: 8px; padding: 8px 12px; font-weight: 600; font-size: 18px; min-width: 44px; text-align: center; box-shadow: 0 2px 6px var(--shadow-color); }
  `]
})
export class App implements OnInit {
  @ViewChild('confettiCanvas') confettiCanvas!: ElementRef<HTMLCanvasElement>;

  // State Signals
  isDark = signal<boolean>(false);
  sidebarOpen = signal<boolean>(false);
  currentView = signal<string>('dashboard');
  viewMode = signal<'dashboard' | 'client'>('dashboard');
  currentFilter = signal<'all'|'pending'|'accepted'>('all');
  
  // Data
  offers = signal<Offer[]>([]);
  settings = signal<Settings>({
    repName: '', repEmail: '', repPhone: '', companyName: '', logoUrl: '',
    defaultFactor: 1.25, defaultTerm: 130, defaultExpiry: 14, accent: 'mint', apiKey: '', showApr: false
  });

  // Toggles & Modal State
  toggleContactInfo = false;
  isExpiryToggled = false;
  customExpiryDate: string = new Date().toISOString().split('T')[0];
  toggles = { fee: false, prepay: false, override: false, notes: false };
  toastVisible = signal(false);
  toastMessage = signal('');
  selectedOffer: Offer | null = null;
  offerToDelete = signal<Offer | null>(null);
  amortModalOpen = signal(false);
  
  // Calculator State
  currentOfferState = { businessName: '', contactName: '', email: '' };
  currentOptions = signal<OfferOption[]>([this.getNewOption()]);
  activeOptionIndex = signal(0);
  editingOfferId = signal<string | null>(null);

  // Client View State
  clientOffer = signal<Offer | null>(null);
  activeClientOptionIndex = signal(0);
  clientAdjustedAmount = signal(0);
  showPrepay = signal(false);
  prepayDate = signal(new Date().toISOString().split('T')[0]);
  prepaySavings = signal(0);
  newPayoff = signal(0);
  clientTimer = signal<any>(null);
  
  // Search
  searchQuery = '';
  isSearching = signal(false);
  searchResult = signal<SearchResult | null>(null);
  amortSchedule = signal<AmortizationRow[]>([]);

  // Computed
  activeOption = computed(() => this.currentOptions()[this.activeOptionIndex()]);
  
  // Client Computed
  getClientActiveOption = computed(() => this.clientOffer()!.options[this.activeClientOptionIndex()]);
  clientCalculated = computed(() => {
      const baseOpt = this.getClientActiveOption();
      if (!baseOpt) return { amount: 0, totalPayback: 0, payment: 0, totalCost: 0, termMonths: 0, frequency: 'daily' };
      // Use the adjusted amount for calculations
      return this.calculate({ ...baseOpt, amount: this.clientAdjustedAmount() });
  });
  
  getClientActiveCircle = computed(() => {
      const c = this.clientCalculated();
      if(!c.totalPayback) return '0, 100';
      const pct = (c.amount / c.totalPayback) * 100;
      return `${pct}, ${100-pct}`;
  });

  filteredOffers = computed(() => {
    let list = this.offers();
    if(this.currentFilter() !== 'all') list = list.filter(o => o.status === this.currentFilter());
    return list.sort((a,b) => b.createdAt - a.createdAt);
  });
  
  recentOffers = computed(() => this.offers().slice().sort((a, b) => b.createdAt - a.createdAt).slice(0, 5));
  
  stats = computed(() => {
    const list = this.offers();
    const val = list.filter(o => o.status === 'accepted').reduce((acc, o) => {
      const idx = o.acceptedOptionIndex || 0;
      return acc + (o.options[idx]?.amount || 0);
    }, 0);
    return {
      total: list.length,
      pending: list.filter(o => o.status === 'pending').length,
      accepted: list.filter(o => o.status === 'accepted').length,
      value: val
    };
  });

  ngOnInit() {
    this.loadData();
    const urlParams = new URLSearchParams(window.location.search);
    const oid = urlParams.get('offer');
    if(oid) {
      const found = this.offers().find(o => o.id === oid);
      if(found) {
        this.clientOffer.set(found);
        this.viewMode.set('client');
        // Initialize client adjustment to the full amount of the first option
        this.clientAdjustedAmount.set(found.options[0].amount);
        this.startClientTimer(found.expiresAt);
      }
    }
  }

  // Data Persistence
  loadData() {
    try {
      const o = localStorage.getItem('trustbureau_offers');
      if(o) this.offers.set(JSON.parse(o));
      const s = localStorage.getItem('trustbureau_settings');
      if(s) this.settings.set({...this.settings(), ...JSON.parse(s)});
      const t = localStorage.getItem('trustbureau_theme');
      this.isDark.set(t === 'dark');
    } catch(e) {}
  }
  saveData() { localStorage.setItem('trustbureau_offers', JSON.stringify(this.offers())); }
  saveSettings() { 
    localStorage.setItem('trustbureau_settings', JSON.stringify(this.settings())); 
    this.showToast('Settings Saved'); 
  }

  // UI Helpers
  toggleTheme() {
    this.isDark.update(d => !d);
    localStorage.setItem('trustbureau_theme', this.isDark() ? 'dark' : 'light');
  }
  toggleSidebar() { this.sidebarOpen.update(s => !s); }
  switchView(v: string) { this.currentView.set(v); this.sidebarOpen.set(false); }
  showToast(m: string) { this.toastMessage.set(m); this.toastVisible.set(true); setTimeout(() => this.toastVisible.set(false), 3000); }
  
  getSliderGradient(val: number, min: number, max: number) {
    const pct = ((Number(val) - min) / (max - min)) * 100;
    const color = 'var(--accent-color)'; 
    const track = this.isDark() ? '#27272a' : '#e2e8f0';
    return `linear-gradient(to right, ${color} 0%, ${color} ${pct}%, ${track} ${pct}%, ${track} 100%)`;
  }
  
  switchClientOption(i: number) {
      this.activeClientOptionIndex.set(i);
      const opt = this.clientOffer()?.options[i];
      if (opt) this.clientAdjustedAmount.set(opt.amount);
  }

  getNewOption(): OfferOption {
    return {
      amount: 50000, factor: this.settings().defaultFactor, term: this.settings().defaultTerm,
      frequency: 'daily', fee: 0, prepayDiscount: 0, termOverride: '', notes: ''
    };
  }

  // Calculator Logic
  addOption() { 
    if(this.currentOptions().length >= 3) return;
    const newOpt = { ...this.currentOptions()[this.currentOptions().length-1] }; // clone last
    this.currentOptions.update(o => [...o, newOpt]);
    this.activeOptionIndex.set(this.currentOptions().length - 1);
  }
  removeOption() {
    if(this.currentOptions().length <= 1) return;
    this.currentOptions.update(o => o.filter((_, i) => i !== this.activeOptionIndex()));
    this.activeOptionIndex.set(0);
  }
  setActiveOption(i: number) { this.activeOptionIndex.set(i); }

  calculate(opt: OfferOption) {
    const a = Number(opt.amount);
    const tp = a * opt.factor;
    const tc = tp - a;
    const fa = a * (opt.fee / 100);
    const np = a - fa;
    const p = opt.term > 0 ? tp / opt.term : 0;
    
    // Term months approx
    let tm = 6;
    if(opt.frequency === 'daily') tm = opt.term / 21;
    else if(opt.frequency === 'weekly') tm = opt.term / 4.3;
    else tm = opt.term;
    
    return { ...opt, payment: p, totalPayback: tp, totalCost: tc, feeAmount: fa, netProceeds: np, termMonths: Math.round(tm*10)/10 };
  }

  getPreviewCalculations() { return this.calculate(this.activeOption()); }
  getPreviewCircle() {
    const c = this.getPreviewCalculations();
    if(!c.totalPayback) return '0, 100';
    const pct = (c.amount / c.totalPayback) * 100;
    return `${pct}, ${100-pct}`;
  }

  resetCalculator() {
    this.currentOfferState = { businessName: '', contactName: '', email: '' };
    this.currentOptions.set([this.getNewOption()]);
    this.activeOptionIndex.set(0);
    this.editingOfferId.set(null);
    this.toggles = { fee: false, prepay: false, override: false, notes: false };
    this.isExpiryToggled = false;
  }

  toggleExpiry(event: any) {
    this.isExpiryToggled = event.target.checked;
    if(this.isExpiryToggled) {
        const d = new Date();
        d.setDate(d.getDate() + this.settings().defaultExpiry);
        this.customExpiryDate = d.toISOString().split('T')[0];
    }
  }

  saveOffer() {
    if(!this.currentOfferState.businessName) { this.showToast('Business Name Required'); return; }
    
    const opts = this.currentOptions().map(o => this.calculate(o));
    let expiryTime = Date.now() + (this.settings().defaultExpiry * 86400000);
    if(this.isExpiryToggled && this.customExpiryDate) {
        expiryTime = new Date(this.customExpiryDate).getTime();
    }

    const offer: Offer = {
      id: this.editingOfferId() || `offer_${Date.now()}`,
      status: 'pending',
      createdAt: this.editingOfferId() ? this.offers().find(o => o.id === this.editingOfferId())!.createdAt : Date.now(),
      expiresAt: expiryTime,
      businessName: this.currentOfferState.businessName,
      contactName: this.currentOfferState.contactName,
      email: this.currentOfferState.email,
      options: opts,
      repName: this.settings().repName,
      repEmail: this.settings().repEmail,
      repPhone: this.settings().repPhone,
      companyName: this.settings().companyName,
      logoUrl: this.settings().logoUrl,
      accent: this.settings().accent,
      showApr: this.settings().showApr
    };

    if(this.editingOfferId()) {
      this.offers.update(l => l.map(o => o.id === offer.id ? offer : o));
      this.showToast('Offer Updated');
    } else {
      this.offers.update(l => [...l, offer]);
      this.showToast('Offer Created');
    }
    this.saveData();
    this.resetCalculator();
    this.switchView('dashboard');
  }

  editOffer(offer?: Offer) {
    const o = offer || this.selectedOffer;
    if(!o) return;
    this.editingOfferId.set(o.id);
    this.currentOfferState = { businessName: o.businessName, contactName: o.contactName, email: o.email };
    this.currentOptions.set(o.options.map(opt => ({...opt}))); // deep copy needed
    
    // Set toggles based on first option data
    const opt = o.options[0];
    this.toggles.fee = opt.fee > 0;
    this.toggles.prepay = opt.prepayDiscount > 0;
    this.toggles.override = !!opt.termOverride;
    this.toggles.notes = !!opt.notes;
    
    if (o.expiresAt) {
        this.isExpiryToggled = true;
        this.customExpiryDate = new Date(o.expiresAt).toISOString().split('T')[0];
    }

    this.activeOptionIndex.set(0);
    this.selectedOffer = null;
    this.switchView('calculator');
  }

  cancelEdit() { this.resetCalculator(); this.switchView('dashboard'); }

  // Actions
  viewOfferDetails(o: Offer) { this.selectedOffer = o; }
  openDeleteConfirm(o: Offer) { this.offerToDelete.set(o); this.selectedOffer = null; }
  executeDelete() {
    const o = this.offerToDelete();
    if(o) {
      this.offers.update(l => l.filter(x => x.id !== o.id));
      this.saveData();
      this.offerToDelete.set(null);
      this.showToast('Deleted');
    }
  }

  // Client Logic
  acceptClientOffer() {
    const o = this.clientOffer();
    if(o) {
      o.status = 'accepted';
      o.acceptedAt = Date.now();
      o.acceptedOptionIndex = this.activeClientOptionIndex();
      this.offers.update(l => l.map(x => x.id === o.id ? o : x));
      this.saveData();
      this.showConfetti();
    }
  }
  
  startClientTimer(expires: number) {
    const tick = () => {
      const diff = expires - Date.now();
      if(diff <= 0) { this.clientTimer.set(null); return; }
      const days = Math.floor(diff / 86400000);
      const hours = Math.floor((diff % 86400000) / 3600000);
      const minutes = Math.floor((diff % 3600000) / 60000);
      this.clientTimer.set({ days, hours, minutes });
    };
    tick(); setInterval(tick, 60000);
  }

  calculatePrepay(d: string) {
    this.prepayDate.set(d);
    const opt = this.getClientActiveOption();
    const start = new Date(); start.setHours(0,0,0,0);
    
    let days = opt.term;
    if(opt.frequency === 'weekly') days *= 7;
    else if(opt.frequency === 'monthly') days *= 30;
    else days *= 1.4; // daily biz days approx
    
    const end = new Date(start); end.setDate(end.getDate() + days);
    const sel = new Date(d); sel.setHours(0,0,0,0);
    
    const total = end.getTime() - start.getTime();
    const rem = end.getTime() - sel.getTime();
    let frac = total > 0 ? rem/total : 0;
    frac = Math.max(0, Math.min(1, frac));
    
    const savings = (opt.totalPayback || 0) * (opt.prepayDiscount/100) * frac;
    this.prepaySavings.set(savings);
    this.newPayoff.set((opt.totalPayback || 0) - savings);
  }

  // Amortization
  openAmortSchedule() {
    // If in client view, use client data. Else calculator preview.
    const opt = this.viewMode() === 'client' ? this.clientCalculated() : this.getPreviewCalculations();
    
    let bal = opt.totalPayback || 0;
    const pmt = opt.payment || 0;
    let d = new Date();
    const rows: AmortizationRow[] = [];
    
    for(let i=1; i<=opt.term; i++) {
      if(bal <= 0.1) break;
      
      if(opt.frequency === 'weekly') d.setDate(d.getDate() + 7);
      else if(opt.frequency === 'monthly') d.setMonth(d.getMonth() + 1);
      else {
        d.setDate(d.getDate() + 1);
        if(d.getDay() === 0) d.setDate(d.getDate() + 1);
        if(d.getDay() === 6) d.setDate(d.getDate() + 2);
      }
      
      bal -= pmt;
      if(bal < 0) bal = 0;
      rows.push({ index: i, date: new Date(d), payment: pmt, balance: bal });
      if(i > 500) break; // safety
    }
    this.amortSchedule.set(rows);
    this.amortModalOpen.set(true);
  }

  // Utils
  getFreqShort(f: string) { return f === 'daily' ? 'd' : f === 'weekly' ? 'wk' : 'mo'; }
  getStatusClass(s: string) {
    if(s === 'accepted') return 'badge-accepted';
    if(s === 'expired') return 'badge-expired';
    return 'badge-pending';
  }
  getPageTitle() {
    if(this.currentView() === 'calculator') return this.editingOfferId() ? 'Edit Offer' : 'New Offer';
    if(this.currentView() === 'settings') return 'Settings';
    if(this.currentView() === 'offers') return 'All Offers';
    return 'Dashboard';
  }
  updateAccent(c: string) { this.settings.update(s => ({...s, accent: c})); }
  getOfferUrl(id: string) { return encodeURIComponent(window.location.origin + window.location.pathname + '?offer=' + id); }
  
  copyLink(id: string) {
    const url = window.location.origin + window.location.pathname + '?offer=' + id;
    this.fallbackCopy(url);
  }
  
  copyOfferText(o: Offer) {
    const lines = [`Funding Approval for ${o.businessName}`];
    o.options.forEach((opt, i) => {
      lines.push(`Option ${i+1}: $${Math.round(opt.amount).toLocaleString()} | Term: ${opt.termOverride || opt.term} | Pmt: $${Math.round(opt.payment || 0).toLocaleString()}`);
    });
    lines.push(`\nLink: ${window.location.origin}${window.location.pathname}?offer=${o.id}`);
    this.fallbackCopy(lines.join('\n'));
  }

  fallbackCopy(text: string) {
    const t = document.createElement("textarea");
    t.value = text;
    t.style.position = "fixed"; t.style.left = "-9999px";
    document.body.appendChild(t);
    t.focus(); t.select();
    try {
      if(document.execCommand('copy')) this.showToast('Copied!');
      else this.showToast('Copy Failed');
    } catch(e) { this.showToast('Error Copying'); }
    document.body.removeChild(t);
  }

  getMapUrl(addr: string) {
    // Basic sanitization
    return `https://maps.google.com/maps?q=${encodeURIComponent(addr)}&output=embed` as any;
  }

  getColorHex(name: string) {
    const map: any = {
      'mint': '#42D197', 'blue': '#3b82f6', 'gold': '#D19B2B', 'purple': '#a855f7',
      'red': '#ef4444', 'orange': '#f97316', 'pink': '#ec4899', 'indigo': '#6366f1',
      'teal': '#14b8a6', 'lime': '#84cc16', 'cyan': '#06b6d4', 'black': '#18181b',
      'grey': '#64748b', 'white': '#f8fafc', 'glow': '#d946ef'
    };
    return map[name];
  }

  async performSearch() {
    if(!this.searchQuery || !this.settings().apiKey) return;
    this.isSearching.set(true);
    try {
      const prompt = `Find business info for "${this.searchQuery}". Return JSON: { legal_name, address, formation_date, contact_name, email, ucc_filings, court_records }`;
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${this.settings().apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }], tools: [{ google_search: {} }] })
      });
      const data = await res.json();
      const txt = data.candidates?.[0]?.content?.parts?.[0]?.text || '{}';
      const json = txt.match(/\{[\s\S]*\}/)?.[0] || '{}';
      this.searchResult.set(JSON.parse(json));
    } catch(e) { this.showToast('Search Failed'); }
    finally { this.isSearching.set(false); }
  }
  
  useSearchResult() {
    const r = this.searchResult();
    if(r) {
      this.currentOfferState = { businessName: r.legal_name || '', contactName: '', email: '' };
      this.switchView('calculator');
    }
  }

  showConfetti() {
    const canvas = this.confettiCanvas.nativeElement;
    const ctx = canvas.getContext('2d')!;
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    const p: any[] = [];
    for(let i=0; i<100; i++) p.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height-canvas.height, c: ['#42D197','#3b82f6','#f97316'][Math.floor(Math.random()*3)], s: Math.random()*5+5, vy: Math.random()*3+2 });
    const anim = () => {
      ctx.clearRect(0,0,canvas.width,canvas.height);
      let act = false;
      p.forEach(o => { o.y += o.vy; if(o.y < canvas.height) { act = true; ctx.fillStyle=o.c; ctx.fillRect(o.x,o.y,o.s,o.s); } });
      if(act) requestAnimationFrame(anim);
    };
    anim();
  }

  // Nav Items
  navItems = [
    { id: 'dashboard', label: 'Dashboard', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>' },
    { id: 'search', label: 'Business Search', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>' },
    { id: 'calculator', label: 'New Offer', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>' },
    { id: 'offers', label: 'All Offers', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10" /></svg>' },
    { id: 'settings', label: 'Settings', icon: '<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>' }
  ];
}
