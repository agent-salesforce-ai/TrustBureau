<!DOCTYPE html>
<html lang="en" class="theme-light accent-mint">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TrustBureau.ai | Offer Dashboard</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z%22 fill=%22%2342D197%22/><path d=%22M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z%22 fill=%22white%22/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body, input, button, select, textarea, * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important; }
    body { font-size: 14px; -webkit-font-smoothing: antialiased; background-color: var(--bg-body); color: var(--text-primary); transition: background-color 0.3s ease; }
    
    input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Theme Variables */
    html.theme-light { --bg-body: #f8fafc; --bg-card: #ffffff; --bg-card-inner: #f8fafc; --bg-input: #ffffff; --bg-sidebar: #ffffff; --border-primary: #e2e8f0; --text-primary: #0f172a; --text-secondary: #475569; --text-muted: #64748b; --text-success: #16a34a; --text-warning: #d97706; --text-danger: #dc2626; --shadow-color: rgba(0, 0, 0, 0.05); --bg-slider-track: #e2e8f0; }
    html.theme-dark { --bg-body: #000000; --bg-card: #121212; --bg-card-inner: #18181b; --bg-input: #18181b; --bg-sidebar: #121212; --border-primary: #27272a; --text-primary: #f8fafc; --text-secondary: #cbd5e1; --text-muted: #94a3b8; --text-success: #4ade80; --text-warning: #fbbf24; --text-danger: #f87171; --shadow-color: rgba(0, 0, 0, 0.8); --bg-slider-track: #27272a; }

    /* Accent Colors */
    html.accent-mint { --accent-color: #42D197; --accent-color-light: #74eabc; --accent-color-dark: #2d9668; --accent-text-inverted: #ffffff; }
    html.accent-blue { --accent-color: #3b82f6; --accent-color-light: #60a5fa; --accent-color-dark: #2563eb; --accent-text-inverted: #ffffff; }
    html.accent-gold { --accent-color: #D19B2B; --accent-color-light: #e6b650; --accent-color-dark: #a6781c; --accent-text-inverted: #020617; }
    html.accent-purple { --accent-color: #a855f7; --accent-color-light: #c084fc; --accent-color-dark: #9333ea; --accent-text-inverted: #ffffff; }
    html.accent-red { --accent-color: #ef4444; --accent-color-light: #f87171; --accent-color-dark: #dc2626; --accent-text-inverted: #ffffff; }
    html.accent-teal { --accent-color: #14b8a6; --accent-color-light: #2dd4bf; --accent-color-dark: #0d9488; --accent-text-inverted: #ffffff; }
    html.accent-pink { --accent-color: #ec4899; --accent-color-light: #f472b6; --accent-color-dark: #db2777; --accent-text-inverted: #ffffff; }
    html.accent-orange { --accent-color: #f97316; --accent-color-light: #fb923c; --accent-color-dark: #ea580c; --accent-text-inverted: #ffffff; }
    html.accent-indigo { --accent-color: #6366f1; --accent-color-light: #818cf8; --accent-color-dark: #4f46e5; --accent-text-inverted: #ffffff; }
    html.accent-lime { --accent-color: #84cc16; --accent-color-light: #a3e635; --accent-color-dark: #65a30d; --accent-text-inverted: #020617; }
    html.accent-cyan { --accent-color: #06b6d4; --accent-color-light: #22d3ee; --accent-color-dark: #0891b2; --accent-text-inverted: #ffffff; }
    html.accent-black { --accent-color: #18181b; --accent-color-light: #3f3f46; --accent-color-dark: #09090b; --accent-text-inverted: #ffffff; }
    html.accent-grey { --accent-color: #64748b; --accent-color-light: #94a3b8; --accent-color-dark: #475569; --accent-text-inverted: #ffffff; }
    html.accent-white { --accent-color: #ffffff; --accent-color-light: #f1f5f9; --accent-color-dark: #cbd5e1; --accent-text-inverted: #0f172a; }
    html.accent-glow { --accent-color: #d946ef; --accent-color-light: #e879f9; --accent-color-dark: #c026d3; --accent-text-inverted: #ffffff; }

    html.accent-white.theme-light .button-primary { border: 1px solid #e2e8f0; }
    html.accent-white.theme-light .slider { background-color: #e2e8f0; }
    html.accent-black.theme-dark { --accent-color: #ffffff; --accent-color-light: #e2e8f0; --accent-color-dark: #cbd5e1; --accent-text-inverted: #000000; }
    
    /* Components */
    .card-bg { background-color: var(--bg-card); border-color: var(--border-primary); }
    .sidebar-bg { background-color: var(--bg-sidebar); border-color: var(--border-primary); }
    .input-field { background-color: var(--bg-input); border-color: var(--border-primary); color: var(--text-primary); transition: border-color 0.2s, box-shadow 0.2s; font-size: 14px; font-weight: 400; }
    .input-field:focus { border-color: var(--accent-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); outline: none; }
    .input-field::placeholder { color: var(--text-muted); opacity: 0.7; }
    
    .button-primary { background-color: var(--accent-color); color: var(--accent-text-inverted); font-weight: 600; border-radius: 10px; padding: 10px 20px; border: none; transition: all 0.2s ease; font-size: 13px; box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-color) 30%, transparent); }
    .button-primary:hover { background-color: var(--accent-color-light); transform: translateY(-1px); }
    .button-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
    html.theme-dark .button-primary { color: #000000; }
    
    .button-secondary { background: transparent; color: var(--text-secondary); font-weight: 600; border-radius: 10px; padding: 10px 20px; border: 1px solid var(--border-primary); transition: all 0.2s ease; font-size: 13px; }
    .button-secondary:hover { border-color: var(--accent-color); color: var(--accent-color); }
    
    .button-toggle-action { background: var(--bg-card-inner); color: var(--text-secondary); border: 1px solid var(--border-primary); border-radius: 10px; padding: 10px; font-size: 12px; font-weight: 600; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 6px; cursor: pointer; }
    .button-toggle-action:hover { border-color: var(--accent-color); color: var(--accent-color); }

    .button-danger { background: transparent; color: #ef4444; font-weight: 600; border-radius: 10px; padding: 10px 20px; border: 1px solid #fecaca; transition: all 0.2s ease; font-size: 13px; }
    .button-danger:hover { background: #fef2f2; border-color: #ef4444; }

    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-accepted { background: #d1fae5; color: #065f46; }
    .badge-expired { background: #fee2e2; color: #991b1b; }
    .badge-declined { background: #f1f5f9; color: #475569; }
    .badge-accent { background: color-mix(in srgb, var(--accent-color) 15%, transparent); color: var(--accent-color-dark); }
    html.theme-dark .badge-accent { color: var(--accent-color); }

    .calc-tabs { display: flex; gap: 8px; margin-bottom: 20px; border-bottom: 1px solid var(--border-primary); padding-bottom: 2px; }
    .calc-tab { padding: 8px 16px; border-radius: 8px 8px 0 0; font-size: 13px; font-weight: 600; color: var(--text-secondary); background: transparent; border: 1px solid transparent; cursor: pointer; transition: all 0.2s; position: relative; bottom: -3px; }
    .calc-tab.active { background: var(--bg-card); color: var(--accent-color); border: 1px solid var(--border-primary); border-bottom-color: var(--bg-card); }
    .calc-tab:hover:not(.active) { color: var(--text-primary); }
    .add-tab-btn { padding: 8px 12px; font-size: 13px; font-weight: 600; color: var(--text-muted); cursor: pointer; }
    .add-tab-btn:hover { color: var(--accent-color); }

    .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: 10px; font-size: 14px; font-weight: 500; color: var(--text-secondary); transition: all 0.15s ease; cursor: pointer; }
    .nav-item:hover { background: var(--bg-card-inner); color: var(--text-primary); }
    .nav-item.active { background: color-mix(in srgb, var(--accent-color) 15%, transparent); color: var(--accent-color-dark); font-weight: 600; }
    html.theme-dark .nav-item.active { color: var(--accent-color); }
    .nav-item.active svg { stroke: currentColor; }

    .offer-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 20px; transition: all 0.2s ease; }
    .offer-card:hover { box-shadow: 0 8px 25px var(--shadow-color); transform: translateY(-2px); }

    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    .modal-content { background: var(--bg-card); border-radius: 20px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25); }

    input[type=range] { -webkit-appearance: none; width: 100%; background: transparent; cursor: pointer; height: 6px; border-radius: 999px; }
    input[type=range]:focus { outline: none; }
    input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 6px; background: transparent; border-radius: 999px; }
    input[type=range]::-webkit-slider-thumb { height: 20px; width: 20px; border-radius: 50%; background: var(--accent-color); cursor: pointer; -webkit-appearance: none; margin-top: -7px; box-shadow: 0 2px 6px rgba(0,0,0,0.15); border: 3px solid var(--bg-card); transition: transform 0.15s ease; }
    input[type=range]:hover::-webkit-slider-thumb { transform: scale(1.1); }

    .stat-card { background: var(--bg-card); border: 1px solid var(--border-primary); border-radius: 16px; padding: 20px; }
    .stat-value { font-size: 32px; font-weight: 600; color: var(--text-primary); }
    .stat-label { font-size: 12px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; font-weight: 500; }

    .toggle-group { display: inline-flex; background: var(--bg-card-inner); border: 1px solid var(--border-primary); border-radius: 12px; padding: 4px; gap: 4px; }
    .toggle-btn { padding: 10px 20px; border-radius: 10px; font-size: 13px; font-weight: 500; color: var(--text-secondary); background: transparent; border: none; cursor: pointer; transition: all 0.2s ease; }
    .toggle-btn:hover:not(.active) { background: color-mix(in srgb, var(--accent-color) 10%, transparent); }
    .toggle-btn.active { background: var(--accent-color); color: var(--accent-text-inverted); box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-color) 40%, transparent); font-weight: 600; }
    html.theme-dark .toggle-btn.active { color: #000000; }

    .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--border-primary); transition: .4s; border-radius: 24px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: var(--accent-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    .empty-state { text-align: center; padding: 60px 20px; color: var(--text-muted); }
    .empty-state svg { width: 80px; height: 80px; margin: 0 auto 20px; opacity: 0.3; }
    
    .toast { position: fixed; bottom: 24px; right: 24px; background: var(--text-primary); color: var(--bg-card); padding: 14px 20px; border-radius: 12px; font-size: 13px; font-weight: 500; box-shadow: 0 10px 40px rgba(0,0,0,0.2); z-index: 200; display: flex; align-items: center; gap: 10px; transform: translateY(100px); opacity: 0; transition: all 0.3s ease; }
    .toast.show { transform: translateY(0); opacity: 1; }
    .qr-container { display: flex; justify-content: center; padding: 20px; background: white; border-radius: 12px; margin: 16px 0; }

    .chart-wrapper { position: relative; width: 140px; height: 140px; margin: 0 auto; display: flex; align-items: center; justify-content: center; }
    .chart-text { position: absolute; text-align: center; z-index: 10; }
    .circular-chart { display: block; margin: 0 auto; max-width: 100%; max-height: 100%; }
    .circle-bg { fill: none; stroke: var(--bg-slider-track); stroke-width: 2.5; }
    .circle { fill: none; stroke-width: 2.5; stroke-linecap: round; stroke: var(--accent-color); transition: stroke-dasharray 0.6s ease-out; }

    .tooltip-container { position: relative; display: inline-block; cursor: help; }
    .tooltip-text { visibility: hidden; width: 200px; background-color: var(--text-primary); color: var(--bg-card); text-align: center; border-radius: 8px; padding: 10px; position: absolute; z-index: 50; bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; font-size: 11px; font-weight: normal; box-shadow: 0 4px 12px rgba(0,0,0,0.15); line-height: 1.4; }
    .tooltip-text::after { content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; border-width: 6px; border-style: solid; border-color: var(--text-primary) transparent transparent transparent; }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

    .settings-panel { padding: 16px; background: var(--bg-card-inner); border-radius: 12px; margin-bottom: 16px; }
    .color-swatch { width: 32px; height: 32px; border-radius: 50%; cursor: pointer; border: 3px solid transparent; transition: all 0.15s ease; }
    .color-swatch:hover { transform: scale(1.15); }
    .color-swatch.selected { border-color: var(--text-primary); box-shadow: 0 0 0 3px var(--bg-card); }

    .client-view { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
    .client-card { background: var(--bg-card); border-radius: 24px; width: 100%; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15); overflow: hidden; border: 4px solid var(--accent-color); transition: transform 0.2s; }
    .client-grid { display: grid; gap: 20px; width: 100%; max-width: 1100px; }
    .client-grid-1 { grid-template-columns: minmax(0, 500px); justify-content: center; }
    .client-grid-2 { grid-template-columns: repeat(2, 1fr); }
    .client-grid-3 { grid-template-columns: repeat(3, 1fr); }
    @media (max-width: 1024px) { .client-grid-2, .client-grid-3 { grid-template-columns: 1fr; max-width: 500px; } }

    #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }
    .expiration-banner { background: linear-gradient(135deg, color-mix(in srgb, var(--accent-color) 15%, transparent), color-mix(in srgb, var(--accent-color) 5%, transparent)); border: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent); border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; justify-content: center; gap: 10px; }
    .expiration-banner.urgent { background: linear-gradient(135deg, color-mix(in srgb, var(--text-danger) 15%, transparent), color-mix(in srgb, var(--text-danger) 5%, transparent)); border-color: var(--text-danger); }
    .timer-digit { background: var(--bg-card); border-radius: 6px; padding: 6px 10px; font-weight: 500; font-size: 16px; min-width: 40px; text-align: center; box-shadow: 0 2px 4px var(--shadow-color); }
    .no-select { -webkit-user-select: none; -moz-user-select: none; user-select: none; }

    .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 40; display: none; backdrop-filter: blur(2px); }
    .sidebar.open + .sidebar-overlay { display: block; }
    @media (max-width: 768px) { .sidebar { transform: translateX(-100%); position: fixed; z-index: 50; transition: transform 0.3s ease-in-out; } .sidebar.open { transform: translateX(0); } .main-content { margin-left: 0 !important; } .mobile-header { display: flex !important; } }
    .mobile-header { display: none; }

    .amort-table th { background-color: var(--bg-slider-track); color: var(--text-secondary); font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.05em; padding: 0.75rem 0.5rem; font-weight: 500; border-bottom: 2px solid var(--accent-color); text-align: right; }
    .amort-table th:first-child, .amort-table th:nth-child(2) { text-align: left; }
    .amort-table td { border-bottom: 1px solid var(--border-primary); color: var(--text-primary); font-size: 0.75rem; padding: 0.6rem 0.5rem; text-align: right; }
    .amort-table td:first-child, .amort-table td:nth-child(2) { text-align: left; }
    .amort-table tr:hover { background: color-mix(in srgb, var(--accent-color) 5%, transparent); }
  </style>
</head>
<body class="min-h-screen">
  <canvas id="confettiCanvas"></canvas>

  <!-- DASHBOARD VIEW -->
  <div id="dashboardContainer">
    <div class="flex min-h-screen">
      
      <aside id="sidebar" class="sidebar w-64 sidebar-bg border-r border-primary flex flex-col fixed h-full">
        <div class="p-6 border-b border-primary flex justify-between items-center">
          <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" viewBox="0 0 24 24">
               <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z" fill="var(--accent-color)" />
               <path d="M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" fill="var(--bg-card)" />
            </svg>
            <div>
              <div class="font-medium text-primary">TrustBureau.ai</div>
              <div class="text-[10px] text-muted uppercase tracking-wider">Offer Portal</div>
            </div>
          </div>
          <button onclick="toggleSidebar()" class="md:hidden text-secondary hover:text-primary">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
          </button>
        </div>
        <nav class="flex-1 p-4 space-y-1">
          <div class="nav-item active" data-view="dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 01-1 1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>
            Dashboard
          </div>
          <div class="nav-item" data-view="calculator">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
            New Offer
          </div>
          <div class="nav-item" data-view="offers">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
            All Offers
          </div>
          <div class="nav-item" data-view="accepted">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Accepted
          </div>
          <div class="nav-item" data-view="declined">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            Declined
          </div>
          <div class="nav-item" data-view="clients">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Clients
          </div>
          <div class="nav-item" data-view="settings">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
            Settings
          </div>
        </nav>
        <div class="p-4 border-t border-primary">
            <div class="nav-item" onclick="toggleTheme()" role="button" tabindex="0">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>
                <span id="themeLabel">Dark Mode</span>
            </div>
            <div class="text-[10px] text-muted mt-4 px-2">Rep: <span id="repNameSidebar" class="text-secondary">Not Set</span></div>
        </div>
      </aside>
      <div class="sidebar-overlay" onclick="toggleSidebar()"></div>

      <main class="main-content flex-1 ml-64 p-8 transition-all">
        <div class="mobile-header items-center justify-between mb-6 p-4 card-bg rounded-xl border border-primary shadow-sm">
          <button type="button" onclick="toggleSidebar()" class="p-2 rounded-lg hover:bg-gray-100 text-secondary" aria-label="Toggle navigation">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
          </button>
          <span class="font-medium text-primary">TrustBureau.ai</span>
          <div class="w-8"></div>
        </div>

        <header class="flex items-center justify-between mb-8">
          <div>
            <h1 id="pageTitle" class="text-2xl font-bold text-primary">Dashboard</h1>
            <p id="pageSubtitle" class="text-sm text-muted mt-1">Welcome back! Here's your offer activity.</p>
          </div>
          <div class="flex gap-3">
              <button type="button" id="cancelEditBtn" onclick="cancelEdit()" class="button-secondary hidden">Cancel Edit</button>
              <button type="button" onclick="switchView('calculator')" class="button-primary flex items-center gap-2 shadow-lg shadow-[var(--accent-color)]/20">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                <span id="mainActionBtnText">New Offer</span>
              </button>
          </div>
        </header>

        <div id="dashboardView">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
              <div class="stat-label mb-2">Total Offers</div>
              <div id="statTotal" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Pending</div>
              <div id="statPending" class="stat-value text-yellow-500">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Accepted</div>
              <div id="statAccepted" class="stat-value text-green-500">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Total Value</div>
              <div id="statValue" class="stat-value text-hero">$0</div>
            </div>
          </div>
          <div class="card-bg rounded-2xl border border-primary">
            <div class="p-5 border-b border-primary flex items-center justify-between">
              <h2 class="font-medium text-primary">Recent Offers</h2>
              <div class="toggle-group" role="radiogroup" aria-label="Filter offers by status">
                <button type="button" class="toggle-btn active" data-filter="all">All</button>
                <button type="button" class="toggle-btn" data-filter="pending">Pending</button>
                <button type="button" class="toggle-btn" data-filter="accepted">Accepted</button>
              </div>
            </div>
            <div id="recentOffersList" class="p-5"></div>
          </div>
        </div>

        <div id="calculatorView" class="hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <div class="space-y-6">
                <div class="card-bg rounded-2xl border border-primary p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xs font-medium text-secondary uppercase tracking-wider">Client Information</h3>
                        <button type="button" id="btnToggleContact" onclick="toggleContactInfo()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium border border-primary text-secondary bg-transparent hover:border-[var(--accent-color)] hover:text-[var(--accent-color)] transition-all">
                            <span id="lblContactAction">Add Details</span>
                            <svg id="iconContactChevron" xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" /></svg>
                        </button>
                    </div>
                    <div class="space-y-4">
                      <div><input id="calcBusinessName" type="text" class="w-full p-2.5 border rounded-lg input-field text-sm" placeholder="Business Name (e.g. Acme Holdings)" /></div>
                      <div id="extraContactInfo" class="hidden space-y-4 pt-2 border-t border-primary transition-all">
                          <div class="grid grid-cols-2 gap-4">
                            <input id="calcContactName" type="text" class="w-full p-2.5 border rounded-lg input-field text-sm" placeholder="Contact Name" />
                            <input id="calcEmail" type="email" class="w-full p-2.5 border rounded-lg input-field text-sm" placeholder="Email Address" />
                          </div>
                      </div>
                    </div>
                </div>

                <div class="card-bg rounded-2xl border border-primary p-6">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xs font-medium text-secondary uppercase tracking-wider">Funding Terms</h3>
                    </div>
                    <div class="calc-tabs">
                        <button id="tab-btn-0" class="calc-tab active" onclick="switchCalcTab(0)">Option 1</button>
                        <button id="tab-btn-1" class="calc-tab hidden" onclick="switchCalcTab(1)">Option 2</button>
                        <button id="tab-btn-2" class="calc-tab hidden" onclick="switchCalcTab(2)">Option 3</button>
                        <button id="add-tab-btn" class="add-tab-btn" onclick="addCalcOption()">+ Add</button>
                    </div>
                    <div class="space-y-6">
                      <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-medium text-secondary">Funding Amount</label>
                            <button type="button" id="remove-option-btn" onclick="removeCalcOption()" class="text-xs text-red-500 hidden font-medium">Remove Option</button>
                        </div>
                        <div class="flex items-center gap-3 mb-2">
                            <div class="relative w-full"><span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted font-medium">$</span><input id="calcAmount" type="text" class="w-full p-2.5 pl-7 border rounded-lg input-field font-medium text-sm" value="50,000" /></div>
                        </div>
                        <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000" value="50000" class="w-full accent-[var(--accent-color)]" />
                      </div>
                      <div class="grid grid-cols-2 gap-6">
                        <div>
                            <div class="flex justify-between items-center mb-2"><label class="text-xs font-medium text-secondary">Factor Rate</label></div>
                            <div class="relative mb-2"><input id="calcFactor" type="number" step="0.01" class="w-full p-2.5 border rounded-lg input-field font-medium text-sm" value="1.25" /><span class="absolute right-3 top-1/2 -translate-y-1/2 text-muted text-xs font-medium">x</span></div>
                            <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25" class="w-full" />
                        </div>
                        <div>
                            <div class="flex justify-between items-center mb-2"><label class="text-xs font-medium text-secondary">Term</label></div>
                            <div class="relative mb-2"><input id="calcTerm" type="number" class="w-full p-2.5 border rounded-lg input-field font-medium text-sm" value="130" /><span class="absolute right-3 top-1/2 -translate-y-1/2 text-muted text-xs font-medium">Pmts</span></div>
                            <input id="calcTermSlider" type="range" min="3" max="528" step="1" value="130" class="w-full" />
                        </div>
                      </div>
                      <div>
                        <label class="block text-xs font-medium text-secondary mb-2">Payment Frequency</label>
                        <div class="toggle-group w-full flex" role="radiogroup">
                          <button type="button" class="toggle-btn active flex-1 py-2 text-xs" data-freq="daily" onclick="setFrequency('daily')">Daily</button>
                          <button type="button" class="toggle-btn flex-1 py-2 text-xs" data-freq="weekly" onclick="setFrequency('weekly')">Weekly</button>
                          <button type="button" class="toggle-btn flex-1 py-2 text-xs" data-freq="monthly" onclick="setFrequency('monthly')">Monthly</button>
                        </div>
                      </div>
                      <div class="border-t border-primary my-2"></div>
                      <div>
                        <div class="pl-3 border-l border-primary">
                          <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                              <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)]">
                                <div class="flex items-center justify-between"><span class="text-xs font-medium text-primary">Origination Fee</span><label class="switch scale-75 origin-right"><input id="toggleFee" type="checkbox" onchange="toggleFeeSection(this.checked)"><span class="slider"></span></label></div>
                                <div id="contentFee" class="hidden mt-2 pt-2 border-t border-primary/50"><div class="flex items-center gap-2 mb-2"><input id="calcFee" type="number" step="0.5" min="0" max="10" class="w-20 p-1 bg-transparent border-b border-primary focus:border-accent-color outline-none font-medium text-sm text-primary" value="0" /><span class="text-xs text-muted font-medium">%</span></div><input id="calcFeeSlider" type="range" min="0" max="10" step="0.5" value="0" class="w-full h-1" /></div>
                              </div>
                              <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)]">
                                <div class="flex items-center justify-between"><span class="text-xs font-medium text-primary">Prepay Discount</span><label class="switch scale-75 origin-right"><input id="togglePrepay" type="checkbox" onchange="togglePrepaySection(this.checked)"><span class="slider"></span></label></div>
                                <div id="contentPrepay" class="hidden mt-2 pt-2 border-t border-primary/50"><div class="flex items-center gap-2 mb-2"><input id="calcPrepay" type="number" step="1" min="0" max="50" class="w-20 p-1 bg-transparent border-b border-primary focus:border-accent-color outline-none font-medium text-sm text-primary" value="0" /><span class="text-xs text-muted font-medium">%</span></div><input id="calcPrepaySlider" type="range" min="0" max="50" step="1" value="0" class="w-full h-1" /></div>
                              </div>
                              <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)]">
                                <div class="flex items-center justify-between"><span class="text-xs font-medium text-primary">Custom Term Label</span><label class="switch scale-75 origin-right"><input id="toggleOverride" type="checkbox" onchange="toggleOverrideSection(this.checked)"><span class="slider"></span></label></div>
                                <div id="contentOverride" class="hidden mt-2 pt-2 border-t border-primary/50"><input id="calcTermOverride" type="text" class="w-full p-1.5 border rounded-md input-field bg-[var(--bg-card)] text-xs text-primary" placeholder="e.g. 6 Months" /></div>
                              </div>
                              <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)]">
                                <div class="flex items-center justify-between"><span class="text-xs font-medium text-primary">Set Expiration</span><label class="switch scale-75 origin-right"><input id="toggleExpiry" type="checkbox" onchange="toggleExpirySection(this.checked)"><span class="slider"></span></label></div>
                                <div id="contentExpiry" class="hidden mt-2 pt-2 border-t border-primary/50"><input id="calcExpiryDate" type="date" class="w-full p-1.5 border rounded-md input-field bg-[var(--bg-card)] text-xs text-primary" /></div>
                              </div>
                              <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)] col-span-1 md:col-span-2">
                                <div class="flex items-center justify-between"><span class="text-xs font-medium text-primary">Approval Notes (Client Visible)</span><label class="switch scale-75 origin-right"><input id="toggleNotes" type="checkbox" onchange="toggleNotesSection(this.checked)"><span class="slider"></span></label></div>
                                <div id="contentNotes" class="hidden mt-2 pt-2 border-t border-primary/50"><textarea id="calcNotes" rows="3" class="w-full p-2 border rounded-md input-field bg-[var(--bg-card)] text-xs text-primary resize-none" placeholder="Enter notes here... Use 'Enter' for new bullets."></textarea></div>
                              </div>
                          </div>
                        </div>
                      </div>
                    </div>
                </div>
                <div class="flex gap-4">
                    <button type="button" onclick="resetCalculator()" class="button-secondary flex-1">Reset</button>
                    <button type="button" onclick="createOffer()" class="button-primary flex-1">Create & Share Offer</button>
                </div>
              </div>

              <div class="space-y-6">
                  <div class="card-bg rounded-2xl border-4 border-primary p-6 sticky top-8" style="border-color: var(--accent-color);">
                    <div class="text-center pb-4 border-b border-primary mb-4">
                      <h4 class="text-xs font-medium text-secondary uppercase tracking-wider"><span id="previewOptionLabel">Option 1</span> Preview</h4>
                    </div>
                    <div id="previewBusinessName" class="text-center text-sm font-medium text-primary mb-2 hidden"></div>
                    <div class="text-center py-4">
                      <span class="text-[11px] font-medium text-muted block uppercase tracking-widest">You Get</span>
                      <span id="previewAmount" class="text-5xl font-semibold block my-3 text-hero leading-tight">$50,000</span>
                    </div>
                    <div class="my-5">
                      <div class="chart-wrapper" title="Principal vs Cost">
                        <svg viewBox="0 0 36 36" class="circular-chart"><path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /><path id="previewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" /></svg>
                        <div class="chart-text"><span class="text-[10px] font-medium text-muted block uppercase tracking-wider">Payback</span><span id="previewPaybackChart" class="text-base font-semibold text-primary block">$62,500</span></div>
                      </div>
                      <div class="flex justify-center gap-4 mt-3 text-[11px] font-medium text-secondary">
                        <div class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-[var(--accent-color)] mr-1.5"></span> Principal</div>
                        <div class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-[var(--bg-slider-track)] mr-1.5"></span> Cost</div>
                      </div>
                    </div>
                    <div id="previewAprContainer" class="p-3 rounded-xl text-center mb-4 hidden" style="background: var(--bg-card-inner);">
                      <span class="text-xs font-medium text-muted uppercase tracking-wider">Estimated APR</span><span id="previewApr" class="text-2xl font-semibold text-hero block">48%</span>
                    </div>
                    <div class="border border-primary rounded-xl overflow-hidden">
                      <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
                        <div class="p-3 text-center"><span class="text-[10px] font-medium text-muted block uppercase">Term Length</span><span id="previewTermLength" class="text-sm font-medium text-primary">6 months</span></div>
                        <div class="p-3 text-center"><span class="text-[10px] font-medium text-muted block uppercase">Payments</span><span id="previewTermPayments" class="text-sm font-medium text-primary">130</span></div>
                      </div>
                      <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
                        <div class="p-3 text-center"><span class="text-[10px] font-medium text-muted block uppercase">Factor Rate</span><span id="previewFactor" class="text-sm font-medium text-primary">1.25x</span></div>
                        <div class="p-3 text-center"><span class="text-[10px] font-medium text-muted block uppercase">Total Cost</span><span id="previewCost" class="text-sm font-medium text-primary">$12,500</span></div>
                      </div>
                      <div id="previewFeeRow" class="grid grid-cols-2 divide-x divide-primary border-b border-primary hidden">
                        <div class="p-3 text-center"><span class="text-[10px] font-medium text-muted block uppercase">Origination Fee</span><span id="previewFeeAmount" class="text-sm font-medium text-primary">$0</span></div>
                        <div class="p-3 text-center"><span class="text-[10px] font-medium text-muted block uppercase">Net Proceeds</span><span id="previewNet" class="text-sm font-medium text-primary">$50,000</span></div>
                      </div>
                      <div class="p-4 text-center" style="background: var(--bg-card-inner);">
                        <span id="previewPaymentLabel" class="text-[10px] font-medium text-muted block uppercase">Est. Daily Payment</span><span id="previewPayment" class="text-lg font-medium text-primary">$480.77</span>
                      </div>
                    </div>
                  </div>
              </div>
          </div>
        </div>

        <div id="offersView" class="hidden"><div id="allOffersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div>
        <div id="clientsView" class="hidden"><div id="clientsList" class="space-y-4"></div></div>
        <div id="settingsView" class="hidden">
          <div class="card-bg rounded-2xl border border-primary p-6 max-w-2xl">
            <h2 class="text-lg font-semibold text-primary mb-6">Settings</h2>
            <div class="settings-panel">
              <h3 class="text-xs font-medium text-secondary uppercase tracking-wider mb-4">Rep Information</h3>
              <div class="grid grid-cols-2 gap-4">
                <div><label class="block text-xs font-medium text-secondary mb-1">Your Name</label><input id="settingsRepName" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="John Smith" /></div>
                <div><label class="block text-xs font-medium text-secondary mb-1">Your Email</label><input id="settingsRepEmail" type="email" class="w-full p-3 border rounded-xl input-field" placeholder="john@company.com" /></div>
              </div>
              <div class="grid grid-cols-2 gap-4 mt-4">
                <div><label class="block text-xs font-medium text-secondary mb-1">Company Name</label><input id="settingsCompanyName" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="Trust Capital Funding" /></div>
                <div><label class="block text-xs font-medium text-secondary mb-1">Phone Number</label><input id="settingsRepPhone" type="tel" class="w-full p-3 border rounded-xl input-field" placeholder="(555) 123-4567" /></div>
              </div>
              <div class="mt-4"><label class="block text-xs font-medium text-secondary mb-1">Company Logo URL</label><input id="settingsLogoUrl" type="url" class="w-full p-3 border rounded-xl input-field" placeholder="https://example.com/logo.png" /></div>
            </div>
            <div class="settings-panel">
              <h3 class="text-xs font-medium text-secondary uppercase tracking-wider mb-4">Appearance</h3>
              <div class="flex gap-3 mb-4 flex-wrap">
                <div onclick="setAccent('mint')" class="color-swatch" style="background-color: #42D197;" title="Mint"></div>
                <div onclick="setAccent('blue')" class="color-swatch" style="background-color: #3b82f6;" title="Blue"></div>
                <div onclick="setAccent('gold')" class="color-swatch" style="background-color: #D19B2B;" title="Gold"></div>
                <div onclick="setAccent('purple')" class="color-swatch" style="background-color: #a855f7;" title="Purple"></div>
                <div onclick="setAccent('red')" class="color-swatch" style="background-color: #ef4444;" title="Red"></div>
                <div onclick="setAccent('teal')" class="color-swatch" style="background-color: #14b8a6;" title="Teal"></div>
                <div onclick="setAccent('pink')" class="color-swatch" style="background-color: #ec4899;" title="Pink"></div>
                <div onclick="setAccent('orange')" class="color-swatch" style="background-color: #f97316;" title="Orange"></div>
                <div onclick="setAccent('indigo')" class="color-swatch" style="background-color: #6366f1;" title="Indigo"></div>
                <div onclick="setAccent('lime')" class="color-swatch" style="background-color: #84cc16;" title="Lime"></div>
                <div onclick="setAccent('cyan')" class="color-swatch" style="background-color: #06b6d4;" title="Cyan"></div>
                <div onclick="setAccent('black')" class="color-swatch" style="background-color: #18181b;" title="Black"></div>
                <div onclick="setAccent('grey')" class="color-swatch" style="background-color: #64748b;" title="Grey"></div>
                <div onclick="setAccent('white')" class="color-swatch" style="background-color: #ffffff; border: 1px solid #e2e8f0;" title="White"></div>
                <div onclick="setAccent('glow')" class="color-swatch" style="background: linear-gradient(135deg, #22d3ee, #d946ef);" title="Irridescent Glow"></div>
              </div>
              <div class="flex items-center justify-between pt-2 border-t border-primary"><label class="text-sm font-medium text-primary">Show APR on Offers</label><label class="switch"><input id="settingsShowApr" type="checkbox"><span class="slider"></span></label></div>
            </div>
            <div class="settings-panel">
              <h3 class="text-xs font-medium text-secondary uppercase tracking-wider mb-4">Default Offer Terms</h3>
              <div class="grid grid-cols-3 gap-4">
                <div><label class="block text-xs font-medium text-secondary mb-1">Default Factor</label><input id="settingsDefaultFactor" type="number" step="0.01" class="w-full p-3 border rounded-xl input-field" value="1.25" /></div>
                <div><label class="block text-xs font-medium text-secondary mb-1">Default Term</label><input id="settingsDefaultTerm" type="number" class="w-full p-3 border rounded-xl input-field" value="130" /></div>
                <div><label class="block text-xs font-medium text-secondary mb-1">Expiry (Days)</label><input id="settingsDefaultExpiry" type="number" class="w-full p-3 border rounded-xl input-field" value="14" /></div>
              </div>
            </div>
            <button type="button" onclick="saveSettings()" class="button-primary mt-4">Save Settings</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- CLIENT VIEW -->
  <div id="clientContainer" class="client-view hidden">
    <div id="clientWrapper" class="w-full max-w-[900px] flex flex-col items-center px-4 pb-20">
        <div class="text-center mb-6 w-full">
            <div id="clientLogoWrapper" class="flex items-center justify-center mb-3">
              <img id="clientLogo" src="" alt="Logo" class="h-12 w-auto hidden" />
              <svg id="clientLogoPlaceholder" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-hero" viewBox="0 0 24 24" fill="currentColor"><path fill-rule="evenodd" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" clip-rule="evenodd" /></svg>
            </div>
            <div id="clientCompanyName" class="font-bold text-primary text-2xl">TrustBureau.ai</div>
            <div id="clientBusinessNameDisplay" class="text-lg font-medium text-secondary mt-2 hidden"></div>
            <div id="clientExpirationBanner" class="expiration-banner inline-flex mt-6 hidden shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-hero" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="text-sm font-medium text-secondary">Offer expires in</span>
                <div class="flex items-center gap-1 font-mono">
                  <span id="clientTimerDays" class="timer-digit text-primary">00</span><span class="text-muted font-bold text-xs pt-1">d</span>
                  <span id="clientTimerHours" class="timer-digit text-primary">00</span><span class="text-muted font-bold text-xs pt-1">h</span>
                  <span id="clientTimerMinutes" class="timer-digit text-primary">00</span><span class="text-muted font-bold text-xs pt-1">m</span>
                </div>
            </div>
        </div>
        <div id="clientMainStage" class="w-full mb-8"></div>
        <div id="clientAlternativesContainer" class="w-full hidden">
            <h4 class="text-xs font-bold text-muted uppercase tracking-widest text-center mb-4">Other Available Options</h4>
            <div id="clientThumbnails" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
        </div>
        <div id="clientRepInfo" class="mt-12 pt-6 border-t border-primary text-xs text-secondary text-center hidden w-full max-w-lg mb-10">
          <div class="font-bold text-muted mb-2 uppercase tracking-wider text-[10px]">Your Funding Specialist</div>
          <div id="clientRepName" class="font-bold text-primary text-base"></div>
          <div id="clientRepEmail" class="text-muted font-medium mt-1"></div>
          <div id="clientRepPhone" class="text-muted font-medium"></div>
        </div>
    </div>
  </div>

  <!-- MODALS -->
  <div id="amortModal" class="modal-overlay hidden" style="z-index: 200;">
    <div class="modal-content max-w-2xl bg-[var(--bg-card)] rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
      <div class="p-5 border-b border-primary flex items-center justify-between bg-[var(--bg-card-inner)]">
        <div><h3 class="text-lg font-bold text-primary">Payment Schedule</h3><p id="amortSubtitle" class="text-xs text-muted">Estimated repayment timeline.</p></div>
        <button onclick="document.getElementById('amortModal').classList.add('hidden')" class="p-2 rounded-lg hover:bg-gray-200/50 text-secondary transition-colors"><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button>
      </div>
      <div class="overflow-y-auto flex-1 p-0"><table class="w-full text-sm amort-table"><thead class="sticky top-0 z-10 shadow-sm"><tr><th>#</th><th>Date</th><th>Payment</th><th>Balance</th></tr></thead><tbody id="amortTableBody"></tbody></table></div>
    </div>
  </div>

  <div id="offerDetailModal" class="modal-overlay hidden" role="dialog" aria-modal="true">
    <div class="modal-content max-w-lg">
      <div class="p-6 border-b border-primary flex items-center justify-between"><h3 class="text-lg font-bold text-primary">Offer Details</h3><div class="flex gap-2"><button onclick="editOffer()" class="p-2 rounded-lg hover:bg-gray-100 text-accent-color"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg></button><button onclick="closeOfferDetailModal()" class="p-2 rounded-lg hover:bg-gray-100 text-muted"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg></button></div></div>
      <div id="offerDetailContent" class="p-6"></div>
      <div class="p-6 border-t border-primary bg-[var(--bg-card-inner)]">
        <div class="flex gap-3 mb-3"><button onclick="copyOfferLink()" class="button-secondary flex-1 flex items-center justify-center gap-2 bg-[var(--bg-card)]"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" /></svg>Copy Link</button><button onclick="copyOfferText()" class="button-primary flex-1 flex items-center justify-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>Copy Text</button></div>
        <div class="flex gap-3"><button onclick="confirmDeleteOffer()" class="button-danger flex-1 flex items-center justify-center gap-2 bg-[var(--bg-card)]"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>Delete</button></div>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="modal-overlay hidden" style="z-index: 110;">
    <div class="modal-content max-w-sm p-6 text-center">
      <h3 class="text-lg font-semibold text-primary mb-2">Confirm Deletion</h3>
      <p class="text-muted mb-6">Are you sure you want to delete this offer?</p>
      <div class="flex gap-3"><button onclick="closeConfirmModal()" class="button-secondary flex-1">Cancel</button><button onclick="executeDelete()" class="button-primary flex-1 bg-red-500 hover:bg-red-600 border-none text-white">Delete</button></div>
    </div>
  </div>
  
  <div id="toast" class="toast" role="status" aria-live="polite"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg><span id="toastMessage">Success!</span></div>

  <script>
    let offers = [], currentFilter = 'all', currentView = 'dashboard', selectedOfferId = null, editingOfferId = null, clientTimerId = null, activeClientOptionIdx = 0;
    let activeCalcTab = 0, calcOptions = [];
    let settings = { repName: '', repEmail: '', repPhone: '', companyName: '', logoUrl: '', defaultFactor: 1.25, defaultTerm: 130, defaultExpiry: 14, accent: 'mint', showApr: false };
    let isDark = false;
    const STORAGE_KEY = 'trustbureau_offers', SETTINGS_KEY = 'trustbureau_settings';

    function generateId() { return 'offer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9); }
    function formatCurrency(num) { const n = Number(num); return isNaN(n) ? '$0' : new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n); }
    function parseNumber(val) { return (typeof val !== 'string' || !val) ? 0 : parseFloat(val.replace(/[\$,]/g, '')) || 0; }
    function formatNumber(num) { return new Intl.NumberFormat('en-US').format(num); }
    function copyToClipboard(text) { const t = document.createElement("textarea"); t.value = text; t.style.position = "fixed"; document.body.appendChild(t); t.focus(); t.select(); try { document.execCommand('copy') ? showToast('Copied!') : showToast('Copy failed'); } catch (e) { showToast('Error'); } document.body.removeChild(t); }
    function copyHtmlToClipboard(html, text) { const c = document.createElement("div"); c.innerHTML = html; c.style.position = "fixed"; c.style.opacity = "0"; c.style.background = "white"; document.body.appendChild(c); const r = document.createRange(); r.selectNodeContents(c); const s = window.getSelection(); s.removeAllRanges(); s.addRange(r); try { document.execCommand('copy') ? showToast('Formatted copy!') : copyToClipboard(text); } catch (e) { copyToClipboard(text); } s.removeAllRanges(); document.body.removeChild(c); }
    function fireConfetti() { const c = document.getElementById('confettiCanvas'), x = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; const p = [], colors = ['#42D197', '#3b82f6', '#f97316', '#a855f7', '#ec4899', '#eab308']; for (let i = 0; i < 150; i++) p.push({ x: Math.random() * c.width, y: Math.random() * c.height - c.height, w: Math.random() * 12 + 5, h: Math.random() * 6 + 4, c: colors[Math.floor(Math.random() * colors.length)], vy: Math.random() * 3 + 2, vx: Math.random() * 4 - 2, r: Math.random() * 360 }); function u() { x.clearRect(0, 0, c.width, c.height); let a = false; p.forEach(o => { o.y += o.vy; o.x += o.vx; o.r += 3; if (o.y < c.height + 50) a = true; x.save(); x.translate(o.x, o.y); x.rotate(o.r * Math.PI / 180); x.fillStyle = o.c; x.fillRect(-o.w/2, -o.h/2, o.w, o.h); x.restore(); }); if (a) requestAnimationFrame(u); else x.clearRect(0, 0, c.width, c.height); } u(); }

    function updateStats() {
      const total = offers.length;
      const pending = offers.filter(o => o.status === 'pending').length;
      const accepted = offers.filter(o => o.status === 'accepted').length;
      const totalValue = offers.filter(o => o.status === 'accepted').reduce((sum, o) => {
          const idx = o.acceptedOptionIndex || 0;
          const amount = o.options && o.options[idx] ? o.options[idx].amount : o.amount;
          return sum + amount;
      }, 0);
      
      const statTotalEl = document.getElementById('statTotal');
      const statPendingEl = document.getElementById('statPending');
      const statAcceptedEl = document.getElementById('statAccepted');
      const statValueEl = document.getElementById('statValue');

      if(statTotalEl) statTotalEl.textContent = total;
      if(statPendingEl) statPendingEl.textContent = pending;
      if(statAcceptedEl) statAcceptedEl.textContent = accepted;
      if(statValueEl) statValueEl.textContent = formatCurrency(totalValue);
    }

    function renderOffers(container, filter = 'all', limit = null) {
      let filtered = [...offers];
      
      if (filter !== 'all') {
        filtered = filtered.filter(o => o.status === filter);
      }
      
      filtered.sort((a, b) => b.createdAt - a.createdAt);
      
      if (limit) {
        filtered = filtered.slice(0, limit);
      }
      
      if (filtered.length === 0) {
        let emptyMsg = "No offers yet";
        if (filter === 'accepted') emptyMsg = "No accepted offers";
        if (filter === 'declined') emptyMsg = "No declined offers";
        
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-lg mb-2">${emptyMsg}</p>
            ${filter === 'all' ? '<p class="text-sm">Click "New Offer" to create your first offer.</p>' : ''}
          </div>
        `;
        return;
      }
      
      const html = filtered.map(offer => {
        let statusClass = 'badge-pending';
        if (offer.status === 'accepted') statusClass = 'badge-accepted';
        else if (offer.status === 'expired') statusClass = 'badge-expired';
        else if (offer.status === 'declined') statusClass = 'badge-declined';
        
        const statusLabel = offer.status.charAt(0).toUpperCase() + offer.status.slice(1);
        const date = new Date(offer.createdAt).toLocaleDateString();
        
        const opt1 = offer.options[0];
        const count = offer.options.length;
        const countLabel = count > 1 ? `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full ml-2">+${count-1} more</span>` : '';

        return `
          <div class="offer-card cursor-pointer" onclick="openOfferDetail('${offer.id}')">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="font-medium text-primary">${offer.businessName}</h3>
                <p class="text-sm text-muted">${offer.contactName || 'No contact'}</p>
              </div>
              <span class="badge ${statusClass}">${statusLabel}</span>
            </div>
            <div class="flex items-end justify-between">
              <div>
                <span class="text-2xl font-medium text-hero">${formatCurrency(opt1.amount)}</span>
                <span class="text-sm text-muted block mt-1">${opt1.frequency} payments ${countLabel}</span>
              </div>
              <div class="text-right text-sm">
                <span class="text-muted">${date}</span>
                ${offer.status === 'accepted' ? '<span class="block text-green-500 text-xs mt-1"> Accepted</span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = currentView === 'dashboard' ? 
        `<div class="space-y-4">${html}</div>` : html;
    }

    function loadOffers() { try { const s = localStorage.getItem(STORAGE_KEY); if (s) { offers = JSON.parse(s).map(o => { if (!o.options) o.options = [{ id: 0, amount: o.amount, factor: o.factor, term: o.term, frequency: o.frequency, fee: o.fee || 0, prepayDiscount: o.prepayDiscount || 0, termOverride: o.termOverride || '', ...calculateOffer(o.amount, o.factor, o.term, o.frequency, o.fee || 0) }]; if (o.status === 'pending' && o.expiresAt && Date.now() > o.expiresAt) o.status = 'expired'; return o; }); saveOffers(); } } catch (e) { offers = []; } }
    function saveOffers() { try { localStorage.setItem(STORAGE_KEY, JSON.stringify(offers)); } catch (e) {} }
    function loadSettings() { try { const s = localStorage.getItem(SETTINGS_KEY); if (s) settings = { ...settings, ...JSON.parse(s) }; updateSettingsUI(); updateRepDisplay(); if (settings.accent) setAccent(settings.accent, false); } catch (e) {} }
    function saveSettings() { settings.repName = document.getElementById('settingsRepName').value.trim(); settings.repEmail = document.getElementById('settingsRepEmail').value.trim(); settings.repPhone = document.getElementById('settingsRepPhone').value.trim(); settings.companyName = document.getElementById('settingsCompanyName').value.trim(); settings.logoUrl = document.getElementById('settingsLogoUrl').value.trim(); settings.defaultFactor = parseFloat(document.getElementById('settingsDefaultFactor').value) || 1.25; settings.defaultTerm = parseInt(document.getElementById('settingsDefaultTerm').value) || 130; settings.defaultExpiry = parseInt(document.getElementById('settingsDefaultExpiry').value) || 14; settings.showApr = document.getElementById('settingsShowApr').checked; try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); updateRepDisplay(); showToast('Settings saved!'); updateCalculatorPreview(); } catch (e) {} }
    function updateSettingsUI() { document.getElementById('settingsRepName').value = settings.repName || ''; document.getElementById('settingsRepEmail').value = settings.repEmail || ''; document.getElementById('settingsRepPhone').value = settings.repPhone || ''; document.getElementById('settingsCompanyName').value = settings.companyName || ''; document.getElementById('settingsLogoUrl').value = settings.logoUrl || ''; document.getElementById('settingsDefaultFactor').value = settings.defaultFactor || 1.25; document.getElementById('settingsDefaultTerm').value = settings.defaultTerm || 130; document.getElementById('settingsDefaultExpiry').value = settings.defaultExpiry || 14; document.getElementById('settingsShowApr').checked = settings.showApr || false; }
    function updateRepDisplay() { document.getElementById('repNameSidebar').textContent = settings.repName || 'Not Set'; }
    function toggleTheme() { isDark = !isDark; document.documentElement.classList.toggle('theme-dark', isDark); document.documentElement.classList.toggle('theme-light', !isDark); document.getElementById('themeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode'; localStorage.setItem('theme', isDark ? 'dark' : 'light'); updateSliderFills(); }
    function loadTheme() { const s = localStorage.getItem('theme'); if (s === 'dark') { isDark = true; document.documentElement.classList.remove('theme-light'); document.documentElement.classList.add('theme-dark'); document.getElementById('themeLabel').textContent = 'Light Mode'; } }
    function setAccent(a, s = true) { document.documentElement.className = document.documentElement.className.replace(/accent-\w+/g, ''); document.documentElement.classList.add('accent-' + a); settings.accent = a; if (s) try { localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings)); } catch (e) {} updateSliderFills(); }

    function calculateOffer(a, f, t, fr, fe) { const tp = a * f; const tc = tp - a; const p = tp / t; const fa = a * (fe / 100); const np = a - fa; let ty; if (fr === 'weekly') ty = t / 52; else if (fr === 'monthly') ty = t / 12; else ty = t / 250; const apr = ty > 0 ? Math.round(((tc / a) / ty) * 100) : 0; let tm; if (fr === 'weekly') tm = t * (12 / 52); else if (fr === 'monthly') tm = t; else tm = t * (12 / 250); tm = Math.round(tm * 2) / 2; return { amount: a, factor: f, term: t, frequency: fr, fee: fe, feeAmount: fa, netProceeds: np, totalPayback: tp, totalCost: tc, payment: p, apr, termMonths: tm }; }
    function initDefaultOption() { return { amount: 50000, factor: settings.defaultFactor, term: settings.defaultTerm, frequency: 'daily', fee: 0, prepay: 0, termOverride: '', notes: '' }; }
    function addCalcOption() { if (calcOptions.length >= 3) return; const p = calcOptions[calcOptions.length - 1]; calcOptions.push({ ...p }); updateTabsUI(); switchCalcTab(calcOptions.length - 1); }
    function removeCalcOption() { if (calcOptions.length <= 1) return; calcOptions.splice(activeCalcTab, 1); if (activeCalcTab >= calcOptions.length) activeCalcTab = calcOptions.length - 1; updateTabsUI(); switchCalcTab(activeCalcTab); }
    function switchCalcTab(i) { saveInputsToState(activeCalcTab); activeCalcTab = i; updateTabsUI(); loadStateToInputs(activeCalcTab); updateCalculatorPreview(); updateSliderFills(); }
    function updateTabsUI() { for(let i=0; i<3; i++) { const b = document.getElementById(`tab-btn-${i}`); if (i < calcOptions.length) { b.classList.remove('hidden'); b.classList.toggle('active', i === activeCalcTab); } else { b.classList.add('hidden'); } } document.getElementById('add-tab-btn').classList.toggle('hidden', calcOptions.length >= 3); document.getElementById('remove-option-btn').classList.toggle('hidden', calcOptions.length <= 1); document.getElementById('previewOptionLabel').textContent = `Option ${activeCalcTab + 1}`; }
    function saveInputsToState(i) { if (!calcOptions[i]) return; const fb = document.querySelector('#calculatorView .toggle-btn.active'); const fr = fb ? fb.dataset.freq : 'daily'; 
    const feeEnabled = document.getElementById('toggleFee').checked;
    const prepayEnabled = document.getElementById('togglePrepay').checked;
    const overrideEnabled = document.getElementById('toggleOverride').checked;
    const notesEnabled = document.getElementById('toggleNotes').checked;

    calcOptions[i] = { 
        amount: parseNumber(document.getElementById('calcAmount').value), 
        factor: parseFloat(document.getElementById('calcFactor').value) || 1.25, 
        term: parseInt(document.getElementById('calcTerm').value) || 130, 
        frequency: fr, 
        fee: feeEnabled ? (parseFloat(document.getElementById('calcFee').value) || 0) : 0, 
        prepay: prepayEnabled ? (parseInt(document.getElementById('calcPrepay').value) || 0) : 0, 
        termOverride: overrideEnabled ? document.getElementById('calcTermOverride').value.trim() : '',
        notes: notesEnabled ? document.getElementById('calcNotes').value : ''
    }; }

    function loadStateToInputs(i) { const o = calcOptions[i]; if (!o) return; 
        document.getElementById('calcAmount').value = formatNumber(o.amount); 
        document.getElementById('calcAmountSlider').value = o.amount; 
        document.getElementById('calcFactor').value = o.factor; 
        document.getElementById('calcFactorSlider').value = o.factor; 
        document.getElementById('calcTerm').value = o.term; 
        document.getElementById('calcTermSlider').value = o.term; 
        
        const ho = !!o.termOverride; 
        document.getElementById('toggleOverride').checked = ho; 
        toggleOverrideSection(ho); 
        if(ho) document.getElementById('calcTermOverride').value = o.termOverride; 
        
        document.querySelectorAll('.toggle-btn[data-freq]').forEach(b => { const ia = b.dataset.freq === o.frequency; b.classList.toggle('active', ia); b.setAttribute('aria-pressed', ia); }); 
        
        const hf = o.fee > 0; 
        document.getElementById('toggleFee').checked = hf; 
        toggleFeeSection(hf); 
        if(hf) { document.getElementById('calcFee').value = o.fee; document.getElementById('calcFeeSlider').value = o.fee; } 
        
        const hp = o.prepay > 0; 
        document.getElementById('togglePrepay').checked = hp; 
        togglePrepaySection(hp); 
        if(hp) { document.getElementById('calcPrepay').value = o.prepay; document.getElementById('calcPrepaySlider').value = o.prepay; }
        
        // Load Notes
        const hn = !!o.notes;
        document.getElementById('toggleNotes').checked = hn;
        toggleNotesSection(hn);
        if(hn) document.getElementById('calcNotes').value = o.notes;
    }
    function updateSliderFill(s) { if (!s) return; const m = parseFloat(s.min) || 0, mx = parseFloat(s.max) || 100, v = parseFloat(s.value) || 0, p = ((v - m) / (mx - m)) * 100; s.style.background = `linear-gradient(to right, var(--accent-color) 0%, var(--accent-color) ${p}%, var(--bg-slider-track) ${p}%, var(--bg-slider-track) 100%)`; }
    function updateSliderFills() { ['calcAmountSlider','calcFactorSlider','calcTermSlider','calcFeeSlider','calcPrepaySlider'].forEach(id => updateSliderFill(document.getElementById(id))); }
    function toggleContactInfo(f=null) { const c = document.getElementById('extraContactInfo'), i = document.getElementById('iconContactChevron'), l = document.getElementById('lblContactAction'); const s = f !== null ? f : c.classList.contains('hidden'); if (s) { c.classList.remove('hidden'); i.style.transform = 'rotate(180deg)'; l.textContent = 'Hide Details'; } else { c.classList.add('hidden'); i.style.transform = 'rotate(0deg)'; l.textContent = 'Add Details'; } }
    function toggleFeeSection(s) { const c = document.getElementById('contentFee'); if (s) c.classList.remove('hidden'); else { c.classList.add('hidden'); document.getElementById('calcFee').value = 0; document.getElementById('calcFeeSlider').value = 0; updateSliderFill(document.getElementById('calcFeeSlider')); updateCalculatorPreview(); } }
    function togglePrepaySection(s) { const c = document.getElementById('contentPrepay'); if (s) c.classList.remove('hidden'); else { c.classList.add('hidden'); document.getElementById('calcPrepay').value = 0; document.getElementById('calcPrepaySlider').value = 0; updateSliderFill(document.getElementById('calcPrepaySlider')); } }
    function toggleOverrideSection(s) { const c = document.getElementById('contentOverride'); if (s) c.classList.remove('hidden'); else { c.classList.add('hidden'); document.getElementById('calcTermOverride').value = ''; updateCalculatorPreview(); } }
    function toggleExpirySection(s) { const c = document.getElementById('contentExpiry'); if (s) { c.classList.remove('hidden'); if(!document.getElementById('calcExpiryDate').value) setExpiryDateDefault(); } else c.classList.add('hidden'); }
    function toggleNotesSection(s) { const c = document.getElementById('contentNotes'); if (s) c.classList.remove('hidden'); else { c.classList.add('hidden'); document.getElementById('calcNotes').value = ''; } }
    function setFrequency(f) { document.querySelectorAll('.toggle-btn[data-freq]').forEach(b => b.classList.toggle('active', b.dataset.freq === f)); updateCalculatorPreview(); }
    function setExpiryDateDefault() { const d = new Date(); d.setDate(d.getDate() + (settings.defaultExpiry || 14)); document.getElementById('calcExpiryDate').value = d.toISOString().split('T')[0]; }
    
    function updateCalculatorPreview() {
      const a = parseNumber(document.getElementById('calcAmount').value), f = parseFloat(document.getElementById('calcFactor').value) || 1.25, t = parseInt(document.getElementById('calcTerm').value) || 130;
      const to = document.getElementById('toggleOverride').checked ? document.getElementById('calcTermOverride').value.trim() : '', bn = document.getElementById('calcBusinessName').value.trim();
      const fe = document.getElementById('toggleFee').checked ? (parseFloat(document.getElementById('calcFee').value) || 0) : 0;
      const fb = document.querySelector('#calculatorView .toggle-btn.active'), fr = fb ? fb.dataset.freq : 'daily';
      const c = calculateOffer(a, f, t, fr, fe);
      if (bn) { document.getElementById('previewBusinessName').textContent = bn; document.getElementById('previewBusinessName').classList.remove('hidden'); } else document.getElementById('previewBusinessName').classList.add('hidden');
      document.getElementById('previewAmount').textContent = formatCurrency(c.amount); document.getElementById('previewPaybackChart').textContent = formatCurrency(c.totalPayback);
      const aprC = document.getElementById('previewAprContainer'); if (settings.showApr) { aprC.classList.remove('hidden'); document.getElementById('previewApr').textContent = c.apr + '%'; } else aprC.classList.add('hidden');
      document.getElementById('previewTermLength').textContent = to ? to : (c.termMonths + ' months'); document.getElementById('previewTermPayments').textContent = c.term + ' payments'; document.getElementById('previewFactor').textContent = c.factor.toFixed(2) + 'x'; document.getElementById('previewCost').textContent = formatCurrency(c.totalCost);
      document.getElementById('previewPaymentLabel').textContent = fr === 'weekly' ? 'Est. Weekly Payment' : fr === 'monthly' ? 'Est. Monthly Payment' : 'Est. Daily Payment'; document.getElementById('previewPayment').textContent = formatCurrency(c.payment);
      if (fe > 0) { document.getElementById('previewFeeRow').classList.remove('hidden'); document.getElementById('previewFeeAmount').textContent = formatCurrency(c.feeAmount); document.getElementById('previewNet').textContent = formatCurrency(c.netProceeds); } else document.getElementById('previewFeeRow').classList.add('hidden');
      const pp = c.totalPayback > 0 ? (c.amount / c.totalPayback) * 100 : 0; document.getElementById('previewCircle').setAttribute('stroke-dasharray', `${pp} ${100 - pp}`);
    }
    
    function resetCalculator() {
      document.getElementById('calcBusinessName').value = ''; document.getElementById('calcContactName').value = ''; document.getElementById('calcEmail').value = '';
      setExpiryDateDefault(); toggleContactInfo(false);
      ['toggleFee','togglePrepay','toggleOverride','toggleExpiry', 'toggleNotes'].forEach(id => document.getElementById(id).checked = false);
      toggleFeeSection(false); togglePrepaySection(false); toggleOverrideSection(false); toggleExpirySection(false); toggleNotesSection(false);
      editingOfferId = null; document.getElementById('cancelEditBtn').classList.add('hidden'); document.getElementById('mainActionBtnText').textContent = 'New Offer';
      calcOptions = [initDefaultOption()]; activeCalcTab = 0; updateTabsUI(); loadStateToInputs(0); updateSliderFills(); updateCalculatorPreview();
    }

    function createOffer() {
        const bn = document.getElementById('calcBusinessName').value.trim(); if (!bn) { showToast('Please enter a business name'); document.getElementById('calcBusinessName').focus(); return; }
        saveInputsToState(activeCalcTab);
        let ea; const dv = document.getElementById('calcExpiryDate').value; if (dv) ea = new Date(dv).getTime(); if (!ea || isNaN(ea)) ea = Date.now() + 1209600000;
        const finalOpts = calcOptions.map((o, i) => { const c = calculateOffer(o.amount, o.factor, o.term, o.frequency, o.fee); return { id: i, amount: o.amount, factor: o.factor, term: o.term, frequency: o.frequency, fee: o.fee, prepayDiscount: o.prepay, termOverride: o.termOverride, notes: o.notes, ...c }; });
        if (editingOfferId) {
            const idx = offers.findIndex(o => o.id === editingOfferId);
            if (idx !== -1) {
                offers[idx] = { ...offers[idx], businessName: bn, contactName: document.getElementById('calcContactName').value.trim(), email: document.getElementById('calcEmail').value.trim(), options: finalOpts, expiresAt: ea };
                saveOffers(); showToast('Offer updated!'); cancelEdit(); setTimeout(() => openOfferDetail(editingOfferId), 300); return;
            }
        }
        const newOffer = { id: generateId(), businessName: bn, contactName: document.getElementById('calcContactName').value.trim(), email: document.getElementById('calcEmail').value.trim(), options: finalOpts, status: 'pending', createdAt: Date.now(), expiresAt: ea, repName: settings.repName, repEmail: settings.repEmail, repPhone: settings.repPhone, companyName: settings.companyName, logoUrl: settings.logoUrl, accent: settings.accent, showApr: settings.showApr };
        offers.push(newOffer); saveOffers(); resetCalculator(); refreshView(); showToast('Offer created!'); setTimeout(() => openOfferDetail(newOffer.id), 300);
    }

    function editOffer() { if(!selectedOfferId) return; editingOfferId = selectedOfferId; const o = offers.find(x => x.id === editingOfferId); document.getElementById('calcBusinessName').value = o.businessName; document.getElementById('calcContactName').value = o.contactName; document.getElementById('calcEmail').value = o.email; if(o.contactName || o.email) toggleContactInfo(true); calcOptions = o.options.map(x => ({...x, prepay: x.prepayDiscount})); if(o.expiresAt) { document.getElementById('calcExpiryDate').value = new Date(o.expiresAt).toISOString().split('T')[0]; toggleExpirySection(true); } activeCalcTab = 0; updateTabsUI(); loadStateToInputs(0); document.getElementById('cancelEditBtn').classList.remove('hidden'); document.getElementById('mainActionBtnText').textContent = 'Update Offer'; closeOfferDetailModal(); switchView('calculator'); }
    function cancelEdit() { editingOfferId = null; resetCalculator(); switchView('dashboard'); }
    function confirmDeleteOffer() { if(selectedOfferId) document.getElementById('confirmModal').classList.remove('hidden'); }
    function closeConfirmModal() { document.getElementById('confirmModal').classList.add('hidden'); }
    function executeDelete() { if(selectedOfferId) { offers = offers.filter(x => x.id !== selectedOfferId); saveOffers(); refreshView(); closeConfirmModal(); closeOfferDetailModal(); showToast('Deleted'); } }
    function copyOfferLink() { const o = offers.find(x => x.id === selectedOfferId); if(o) copyToClipboard(`${window.location.origin}${window.location.pathname}?offer=${encodeURIComponent(o.id)}`); }
    function sendOfferEmail() { const o = offers.find(x => x.id === selectedOfferId); if(!o) return; const s = encodeURIComponent(`Funding Offer: ${o.businessName}`); const b = encodeURIComponent(`Hi,\n\nPlease view your funding offer here: ${window.location.origin}${window.location.pathname}?offer=${encodeURIComponent(o.id)}\n\nThanks.`); window.location.href = `mailto:${o.email}?subject=${s}&body=${b}`; }
    
    function copyOfferText() {
        const offer = offers.find(x => x.id === selectedOfferId);
        if (!offer) return;

        const company = offer.companyName || 'TrustBureau.ai';
        const link = generateOfferLink(offer);
        
        // 1. Map accent names to hex codes for inline styling (Required for email clients)
        const colorMap = {
            mint: '#42D197', blue: '#3b82f6', gold: '#D19B2B', purple: '#a855f7',
            red: '#ef4444', teal: '#14b8a6', pink: '#ec4899', orange: '#f97316',
            indigo: '#6366f1', lime: '#84cc16', cyan: '#06b6d4', black: '#18181b',
            grey: '#64748b', white: '#f8fafc', glow: '#d946ef'
        };
        const brandColor = colorMap[offer.accent] || '#42D197';
        // Ensure text is readable on brand color
        const lightAccents = ['mint', 'lime', 'cyan', 'white', 'glow'];
        const headerTextColor = lightAccents.includes(offer.accent) ? '#0f172a' : '#ffffff';
        const btnTextColor = lightAccents.includes(offer.accent) ? '#0f172a' : '#ffffff';

        // 2. Build Options Rows using Tables (Best for Outlook compatibility)
        let optionsRows = '';
        offer.options.forEach((opt, i) => {
            const freqLabel = opt.frequency.charAt(0).toUpperCase() + opt.frequency.slice(1);
            const termLabel = opt.termOverride ? opt.termOverride : (opt.termMonths + ' months');
            
            optionsRows += `
            <!-- Option Card -->
            <table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-bottom: 16px; background-color: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; border-spacing: 0; border-collapse: separate; overflow: hidden;">
                <tr>
                    <td style="border-left: 6px solid ${brandColor}; padding: 20px;">
                        <table width="100%" border="0" cellspacing="0" cellpadding="0">
                            <tr>
                                <td valign="top">
                                    <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 12px; font-weight: bold; color: #64748b; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px;">Option ${i+1}</div>
                                    <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 24px; font-weight: bold; color: #0f172a;">${formatCurrency(opt.amount)}</div>
                                </td>
                                <td align="right" valign="top">
                                    <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; font-weight: bold; color: ${brandColor};">${opt.factor}x</div>
                                </td>
                            </tr>
                        </table>
                        <table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top: 16px; border-top: 1px solid #f1f5f9;">
                            <tr>
                                <td style="padding-top: 12px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; color: #475569;">Term</td>
                                <td align="right" style="padding-top: 12px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; font-weight: 600; color: #0f172a;">${termLabel}</td>
                            </tr>
                            <tr>
                                <td style="padding-top: 8px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; color: #475569;">Payment</td>
                                <td align="right" style="padding-top: 8px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 14px; font-weight: 600; color: #0f172a;">${formatCurrency(opt.payment)} / ${freqLabel}</td>
                            </tr>
                        </table>
                    </td>
                </tr>
            </table>`;
        });

        // 3. Build Notes Section if exists
        let notesHtml = '';
        const allNotes = offer.options.map(o => o.notes).filter(n => n);
        // Use notes from first option or combine them if needed. For simplicity, using first non-empty.
        const displayNotes = allNotes.length > 0 ? allNotes[0] : '';
        
        if (displayNotes) {
            const bullets = displayNotes.split('\n').filter(n => n.trim()).map(n => `<li style="margin-bottom: 4px;">${n}</li>`).join('');
            notesHtml = `
            <div style="background-color: #f8fafc; border: 1px dashed #cbd5e1; border-radius: 8px; padding: 16px; margin-bottom: 24px;">
                <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 11px; font-weight: bold; text-transform: uppercase; color: #64748b; margin-bottom: 8px;">Approval Conditions</div>
                <ul style="margin: 0; padding-left: 20px; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; font-size: 13px; color: #334155;">
                    ${bullets}
                </ul>
            </div>`;
        }

        // 4. Full Email Template
        const htmlContent = `
        <!DOCTYPE html>
        <html>
        <body style="margin: 0; padding: 0; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; background-color: #ffffff;">
            <div style="max-width: 550px; margin: 0 auto; border: 1px solid #e2e8f0; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 12px rgba(0,0,0,0.05);">
                
                <!-- Branding Header -->
                <div style="background-color: ${brandColor}; padding: 32px 24px; text-align: center;">
                    <h1 style="margin: 0; font-size: 26px; color: ${headerTextColor}; letter-spacing: -0.5px;">${company}</h1>
                    <p style="margin: 6px 0 0 0; color: ${headerTextColor}; opacity: 0.9; font-size: 14px; font-weight: 500;">Funding Approval</p>
                </div>
                
                <!-- Content Area -->
                <div style="padding: 32px 24px; background-color: #ffffff;">
                    <p style="margin-top: 0; margin-bottom: 24px; font-size: 15px; line-height: 1.6; color: #334155;">
                        Hi ${offer.contactName || 'there'},<br><br>
                        We are pleased to inform you that <strong>${offer.businessName}</strong> has been approved for funding. Please review your options below.
                    </p>
                    
                    ${optionsRows}
                    ${notesHtml}
                    
                    <!-- CTA Button -->
                    <div style="text-align: center; margin-top: 32px; margin-bottom: 12px;">
                        <a href="${link}" style="background-color: ${brandColor}; color: ${btnTextColor}; font-size: 16px; font-weight: bold; text-decoration: none; padding: 14px 36px; border-radius: 8px; display: inline-block; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">View & Accept Offer</a>
                    </div>
                    <div style="text-align: center;">
                        <a href="${link}" style="font-size: 12px; color: #64748b; text-decoration: none;">Expires on ${new Date(offer.expiresAt).toLocaleDateString()}</a>
                    </div>
                </div>
                
                <!-- Footer -->
                <div style="background-color: #f8fafc; padding: 16px; text-align: center; border-top: 1px solid #e2e8f0; font-size: 11px; color: #94a3b8;">
                    SECURE FUNDING PROPOSAL &bull; POWERED BY TRUSTBUREAU.AI
                </div>
            </div>
        </body>
        </html>`;

        // Plain text fallback
        let plainText = `Funding Approval for ${offer.businessName}\n\n`;
        offer.options.forEach((opt, i) => {
             plainText += `OPTION ${i+1}: ${formatCurrency(opt.amount)} | Term: ${opt.termOverride || opt.term} | Pmt: ${formatCurrency(opt.payment)}\n`;
        });
        plainText += `\nView details and accept here: ${link}`;

        copyHtmlToClipboard(htmlContent, plainText);
    }
    function generateOfferLink(offer) { return window.location.origin + window.location.pathname + '?offer=' + encodeURIComponent(offer.id); }

    // Client View Logic
    function showClientView(id) {
        const o = offers.find(x => x.id === id); if (!o) { document.getElementById('dashboardContainer').classList.remove('hidden'); document.getElementById('clientContainer').classList.add('hidden'); return; }
        if(!o.viewedAt) { o.viewedAt = Date.now(); saveOffers(); }
        if(o.accent) setAccent(o.accent, false);
        document.getElementById('dashboardContainer').classList.add('hidden'); document.getElementById('clientContainer').classList.remove('hidden');
        if(o.logoUrl) { document.getElementById('clientLogo').src = o.logoUrl; document.getElementById('clientLogo').classList.remove('hidden'); document.getElementById('clientLogoPlaceholder').classList.add('hidden'); } else { document.getElementById('clientLogo').classList.add('hidden'); document.getElementById('clientLogoPlaceholder').classList.remove('hidden'); }
        document.getElementById('clientCompanyName').textContent = o.companyName || 'TrustBureau.ai';
        if(o.businessName) { document.getElementById('clientBusinessNameDisplay').textContent = `for ${o.businessName}`; document.getElementById('clientBusinessNameDisplay').classList.remove('hidden'); }
        activeClientOptionIdx = 0; renderClientViewLogic(o);
        if(o.repName || o.repEmail) { document.getElementById('clientRepInfo').classList.remove('hidden'); document.getElementById('clientRepName').textContent = o.repName; document.getElementById('clientRepEmail').textContent = o.repEmail; document.getElementById('clientRepPhone').textContent = o.repPhone; } else document.getElementById('clientRepInfo').classList.add('hidden');
        const now = Date.now(); const ban = document.getElementById('clientExpirationBanner');
        if(o.status !== 'accepted' && o.status !== 'expired' && now < o.expiresAt) { ban.classList.remove('hidden'); startClientTimer(o.expiresAt); } else ban.classList.add('hidden');
        window.currentClientOfferId = id;
    }
    function renderClientViewLogic(o) {
        const ao = o.options[activeClientOptionIdx];
        const ms = document.getElementById('clientMainStage');
        ms.innerHTML = generateMainStageHTML(ao, activeClientOptionIdx, o.status, o.showApr);
        updateClientMainCard(ao.amount);
        const ac = document.getElementById('clientAlternativesContainer');
        const tc = document.getElementById('clientThumbnails');
        if (o.options.length > 1) {
            ac.classList.remove('hidden');
            tc.innerHTML = o.options.map((opt, i) => i === activeClientOptionIdx ? '' : generateThumbnailHTML(opt, i)).join('');
        } else ac.classList.add('hidden');
    }
    function generateMainStageHTML(opt, idx, status, showApr) {
        const tl = opt.termOverride ? opt.termOverride : (opt.termMonths + ' months');
        const paymentLabel = opt.frequency === 'weekly' ? 'Weekly' : opt.frequency === 'monthly' ? 'Monthly' : 'Daily';
        
        let btnState = '';
        if (status === 'accepted') {
            btnState = `<div class="p-4 bg-green-50 text-green-700 rounded-xl font-bold text-center border border-green-200 w-full"><div class="flex items-center justify-center gap-2"><svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>Offer Accepted</div></div>`;
        } else if (status === 'expired') {
            btnState = `<div class="p-4 bg-red-50 text-red-700 rounded-xl font-bold text-center border border-red-200 w-full">Offer Expired</div>`;
        } else {
            btnState = `<button onclick="acceptOffer('${idx}')" class="button-primary w-full py-4 font-bold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">Select This Option</button>`;
        }

        const badgeText = status === 'accepted' ? 'Selected' : 'Recommended';
        const badgeClass = status === 'accepted' ? 'badge-accepted' : 'badge-accent';

        // Approval Notes Rendering
        let notesHtml = '';
        if (opt.notes && opt.notes.trim().length > 0) {
            const bullets = opt.notes.split('\n').filter(n => n.trim()).map(n => `<li class="mb-1 flex items-start gap-2"><span class="mt-1.5 w-1 h-1 rounded-full bg-[var(--accent-color)] flex-shrink-0"></span><span>${n}</span></li>`).join('');
            notesHtml = `
            <div class="mb-6 bg-[var(--bg-card-inner)] border border-primary rounded-xl p-4">
                <h5 class="text-[10px] font-bold text-muted uppercase tracking-wider mb-3 flex items-center gap-1">
                    <svg class="w-3 h-3 text-[var(--accent-color)]" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Approval Conditions
                </h5>
                <ul class="text-sm text-secondary font-medium leading-relaxed">
                    ${bullets}
                </ul>
            </div>`;
        }

        return `
        <div class="bg-[var(--bg-card)] border-4 border-[var(--accent-color)] shadow-2xl rounded-2xl overflow-hidden relative max-w-xl mx-auto">
            <!-- Header -->
            <div class="bg-[var(--bg-card-inner)] p-4 border-b border-primary flex justify-between items-center">
                <span class="text-xs font-bold text-secondary uppercase tracking-widest">Option ${idx + 1}</span>
                <span class="badge ${badgeClass} text-xs">${badgeText}</span>
            </div>
            
            <div class="p-6 md:p-8">
                
                <!-- 1. Funding Amount & Slider -->
                <div class="text-center mb-8">
                    <label class="text-xs font-bold text-muted uppercase tracking-wider mb-2 block">Approved Funding Amount</label>
                    <div class="text-5xl font-bold text-hero mb-4 tracking-tight" id="clientMainAmount">${formatCurrency(opt.amount)}</div>
                    
                    <div class="px-4">
                        <input type="range" id="clientMainSlider" min="5000" max="${opt.amount}" step="1000" value="${opt.amount}" 
                            class="w-full accent-[var(--accent-color)] h-3 bg-[var(--bg-slider-track)] rounded-lg appearance-none cursor-pointer"
                            oninput="updateClientMainCard(this.value)">
                        <div class="flex justify-between text-[10px] font-bold text-muted mt-2 uppercase tracking-wider">
                            <span>$5,000</span>
                            <span>Slide to adjust</span>
                            <span>${formatCurrency(opt.amount)} Max</span>
                        </div>
                    </div>
                </div>

                <!-- 2. Donut Chart (Principal vs Cost) -->
                <div class="flex justify-center mb-6">
                    <div class="relative w-32 h-32">
                         <svg viewBox="0 0 36 36" class="circular-chart w-full h-full transform -rotate-90">
                            <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                            <path id="clientMainDonut" class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                        </svg>
                        <div class="absolute inset-0 flex items-center justify-center flex-col">
                            <span class="text-[10px] font-bold text-muted uppercase">Payback</span>
                            <span id="clientMainPayback" class="text-sm font-bold text-primary">...</span>
                        </div>
                    </div>
                </div>

                <!-- 3. APR Badge -->
                ${showApr ? `
                <div class="text-center mb-6">
                    <span class="inline-block bg-[var(--bg-card-inner)] border border-primary rounded-full px-4 py-1 text-xs font-bold text-secondary">
                        Est. APR: <span class="text-hero">${opt.apr}%</span>
                    </span>
                </div>` : ''}

                <!-- 4. Notes Section (New) -->
                ${notesHtml}

                <!-- 5. Terms Grid (Mirrors Preview) -->
                <div class="border border-primary rounded-xl overflow-hidden mb-6">
                      <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
                        <div class="p-3 text-center">
                            <span class="text-[10px] font-bold text-muted block uppercase">Term Length</span>
                            <span class="text-sm font-medium text-primary">${tl}</span>
                        </div>
                        <div class="p-3 text-center">
                            <span class="text-[10px] font-bold text-muted block uppercase">Payments</span>
                            <span class="text-sm font-medium text-primary">${opt.term}</span>
                        </div>
                      </div>
                      <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
                        <div class="p-3 text-center">
                            <span class="text-[10px] font-bold text-muted block uppercase">Factor Rate</span>
                            <span class="text-sm font-medium text-primary">${opt.factor}x</span>
                        </div>
                        <div class="p-3 text-center">
                            <span class="text-[10px] font-bold text-muted block uppercase">Total Cost</span>
                            <span id="clientMainCost" class="text-sm font-medium text-primary">...</span>
                        </div>
                      </div>
                      <!-- Fee Row -->
                      <div id="clientMainFeeRow" class="grid grid-cols-2 divide-x divide-primary border-b border-primary ${opt.fee > 0 ? '' : 'hidden'}">
                        <div class="p-3 text-center">
                            <span class="text-[10px] font-bold text-muted block uppercase">Origination Fee</span>
                            <span id="clientMainFee" class="text-sm font-medium text-primary">...</span>
                        </div>
                        <div class="p-3 text-center">
                            <span class="text-[10px] font-bold text-muted block uppercase">Net Proceeds</span>
                            <span id="clientMainNet" class="text-sm font-medium text-primary">...</span>
                        </div>
                      </div>
                      
                      <!-- Payment Footer -->
                      <div class="p-4 text-center bg-[var(--bg-card-inner)]">
                        <span class="text-[10px] font-bold text-muted block uppercase">Estimated ${paymentLabel} Payment</span>
                        <span id="clientMainPayment" class="text-xl font-bold text-primary">...</span>
                      </div>
                </div>
                
                <!-- 6. Links -->
                <div class="text-center mb-6">
                     <button onclick="openAmortSchedule(${idx})" class="text-xs font-bold text-[var(--accent-color)] hover:text-primary hover:underline transition-colors">
                        View Amortization Schedule
                    </button>
                </div>

                <!-- 7. Prepay Section -->
                ${opt.prepayDiscount > 0 ? `
                <div class="mb-6 pt-4 border-t border-dashed border-primary">
                    <div class="bg-[var(--bg-card-inner)] border border-primary rounded-xl p-4">
                        <div class="flex items-center justify-between mb-3">
                             <span class="text-xs font-bold text-secondary uppercase tracking-wider">Early Payoff Calculator</span>
                             <span class="text-[10px] font-bold text-white bg-green-500 px-2 py-0.5 rounded-full">${opt.prepayDiscount}% Discount</span>
                        </div>
                        <div class="flex gap-3 items-center mb-3">
                             <input type="date" id="clientMainPrepayDate" 
                                class="flex-1 p-2 text-sm bg-[var(--bg-card)] border border-primary rounded-lg text-center outline-none focus:border-[var(--accent-color)]"
                                onchange="calculateMainClientSavings()">
                        </div>
                        <div class="flex justify-between items-end border-t border-primary/10 pt-2">
                            <div class="text-left">
                                <span class="text-[10px] font-bold text-muted uppercase block">New Payoff</span>
                                <span id="clientMainNewTotal" class="text-sm font-bold text-primary">$0</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] font-bold text-muted uppercase block">You Save</span>
                                <span id="clientMainSavings" class="text-lg font-bold text-green-600">$0</span>
                            </div>
                        </div>
                    </div>
                </div>` : ''}

                <div class="mt-4">
                    ${btnState}
                </div>
            </div>
        </div>
        `;
    }
    
    function updateClientMainCard(amountVal) {
        const offer = offers.find(o => o.id === window.currentClientOfferId);
        if (!offer) return;
        
        const opt = offer.options[activeClientOptionIdx];
        const amount = parseFloat(amountVal);
        
        const totalPayback = amount * opt.factor;
        const totalCost = totalPayback - amount;
        const payment = totalPayback / opt.term;
        const feeAmount = amount * (opt.fee / 100);
        const netProceeds = amount - feeAmount;
        
        document.getElementById('clientMainAmount').textContent = formatCurrency(amount);
        document.getElementById('clientMainPayback').textContent = formatCurrency(totalPayback);
        document.getElementById('clientMainPayment').textContent = formatCurrency(payment);
        document.getElementById('clientMainCost').textContent = formatCurrency(totalCost);
        
        // Fee updates
        if (opt.fee > 0) {
             const feeEl = document.getElementById('clientMainFee');
             const netEl = document.getElementById('clientMainNet');
             if(feeEl) feeEl.textContent = formatCurrency(feeAmount);
             if(netEl) netEl.textContent = formatCurrency(netProceeds);
        }

        const principalPct = (amount / totalPayback) * 100;
        const donut = document.getElementById('clientMainDonut');
        if(donut) donut.setAttribute('stroke-dasharray', `${principalPct}, 100`);
        
        calculateMainClientSavings();
    }

    function calculateMainClientSavings() { 
        const o = offers.find(x => x.id === window.currentClientOfferId); if(!o) return; 
        const di = document.getElementById('clientMainPrepayDate'); if(!di || !di.value) return; 
        const a = parseNumber(document.getElementById('clientMainAmount').textContent); 
        const opt = o.options[activeClientOptionIdx]; 
        const tp = a * opt.factor; 
        const sd = new Date(); sd.setHours(0,0,0,0); 
        let td = opt.term; 
        if(opt.frequency === 'weekly') td = opt.term * 7; 
        else if(opt.frequency === 'monthly') td = opt.term * 30.44; 
        else td = opt.term * 1.42; 
        const ed = new Date(sd); ed.setDate(ed.getDate() + Math.ceil(td)); 
        const sel = new Date(di.value); sel.setHours(0,0,0,0); 
        const tt = ed.getTime() - sd.getTime(); 
        const rt = ed.getTime() - sel.getTime(); 
        let fr = tt > 0 ? rt / tt : 0; fr = Math.max(0, Math.min(1, fr)); 
        const ms = tp * (opt.prepayDiscount / 100); 
        const s = ms * fr; 
        const nt = tp - s; 
        document.getElementById('clientMainSavings').textContent = formatCurrency(s); 
        document.getElementById('clientMainNewTotal').textContent = formatCurrency(nt); 
    }

    function generateThumbnailHTML(opt, idx) { const tl = opt.termOverride ? opt.termOverride : (opt.termMonths + ' months'); return `<div onclick="switchClientOption(${idx})" class="bg-[var(--bg-card)] p-4 rounded-xl border border-primary hover:border-[var(--accent-color)] hover:shadow-md cursor-pointer transition-all flex items-center justify-between group"><div><span class="text-[10px] font-bold text-muted uppercase block mb-1">Option ${idx + 1}</span><div class="text-lg font-bold text-primary group-hover:text-[var(--accent-color)] transition-colors">${formatCurrency(opt.amount)}</div><div class="text-xs text-secondary mt-0.5">${tl}  ${opt.frequency}</div></div><div class="text-right"><div class="text-xs font-medium text-muted">Factor</div><div class="font-bold text-primary">${opt.factor}x</div><div class="text-[10px] font-bold text-[var(--accent-color)] mt-1 uppercase tracking-wide">View &rarr;</div></div></div>`; }
    function switchClientOption(idx) { activeClientOptionIdx = idx; const o = offers.find(x => x.id === window.currentClientOfferId); renderClientViewLogic(o); document.getElementById('clientMainStage').scrollIntoView({ behavior: 'smooth', block: 'center' }); }
    function startClientTimer(ea) { if(clientTimerId) clearInterval(clientTimerId); function u() { const n = Date.now(); const d = ea - n; if(d <= 0) { clearInterval(clientTimerId); location.reload(); return; } const days = Math.floor(d / 86400000); const hours = Math.floor((d % 86400000) / 3600000); const minutes = Math.floor((d % 3600000) / 60000); document.getElementById('clientTimerDays').textContent = days.toString().padStart(2, '0'); document.getElementById('clientTimerHours').textContent = hours.toString().padStart(2, '0'); document.getElementById('clientTimerMinutes').textContent = minutes.toString().padStart(2, '0'); } u(); clientTimerId = setInterval(u, 60000); }
    function acceptOffer(idx) { const o = offers.find(x => x.id === window.currentClientOfferId); if(!o) return; o.status = 'accepted'; o.acceptedAt = Date.now(); o.acceptedOptionIndex = idx; saveOffers(); fireConfetti(); showClientView(window.currentClientOfferId); showToast('Offer accepted!'); }
    function openAmortSchedule(idx) { const o = offers.find(x => x.id === window.currentClientOfferId); if(!o) return; const opt = o.options[idx]; const a = parseNumber(document.getElementById('clientMainAmount').textContent); const tp = a * opt.factor; const p = tp / opt.term; const tb = document.getElementById('amortTableBody'); tb.innerHTML = ''; let b = tp; let d = new Date(); const mr = 260; for(let i = 1; i <= opt.term; i++) { if(i > mr && i < opt.term) continue; if(i === mr && opt.term > mr) { tb.innerHTML += `<tr><td colspan="4" class="text-center text-muted py-2">... remaining payments ...</td></tr>`; let ld = new Date(); ld.setDate(ld.getDate() + (opt.term * (opt.frequency === 'weekly' ? 7 : 1.4))); tb.innerHTML += `<tr><td>${opt.term}</td><td>${ld.toLocaleDateString()}</td><td>${formatCurrency(p)}</td><td>$0.00</td></tr>`; break; } if(opt.frequency === 'weekly') d.setDate(d.getDate() + 7); else if(opt.frequency === 'monthly') d.setMonth(d.getMonth() + 1); else { d.setDate(d.getDate() + 1); if(d.getDay() === 0) d.setDate(d.getDate() + 1); if(d.getDay() === 6) d.setDate(d.getDate() + 2); } b -= p; if(b < 0) b = 0; const tr = document.createElement('tr'); tr.innerHTML = `<td>${i}</td><td>${d.toLocaleDateString()}</td><td>${formatCurrency(p)}</td><td>${formatCurrency(b)}</td>`; tb.appendChild(tr); } document.getElementById('amortModal').classList.remove('hidden'); }

    // --- RESTORED MISSING FUNCTIONS ---
    function switchView(view) {
      currentView = view; 
      if (window.innerWidth <= 768) {
          const sb = document.getElementById('sidebar');
          if(sb) sb.classList.remove('open');
      }

      document.querySelectorAll('.nav-item').forEach(i => { 
          i.classList.remove('active'); 
          if (i.dataset.view === view) i.classList.add('active'); 
      });
      
      const titles = { 
          dashboard: ['Dashboard', 'Welcome back! Here\'s your offer activity.'], 
          calculator: ['Create New Offer', 'Build and share a funding offer with your client.'], 
          offers: ['All Offers', 'Manage and track all your sent offers.'], 
          accepted: ['Accepted Offers', 'View all accepted funding offers.'], 
          declined: ['Declined Offers', 'View all declined or expired offers.'], 
          clients: ['Clients', 'View all your clients and their offer history.'], 
          settings: ['Settings', 'Configure your profile and preferences.'] 
      };
      
      const pageTitle = (view === 'calculator' && editingOfferId) ? 'Edit Offer' : (titles[view] ? titles[view][0] : 'Dashboard');
      const pageSub = (view === 'calculator' && editingOfferId) ? 'Update existing offer details.' : (titles[view] ? titles[view][1] : '');

      const pt = document.getElementById('pageTitle');
      const ps = document.getElementById('pageSubtitle');
      if(pt) pt.textContent = pageTitle;
      if(ps) ps.textContent = pageSub;
      
      ['dashboardView','calculatorView','offersView','clientsView','settingsView'].forEach(id => {
          const el = document.getElementById(id);
          if(el) el.classList.add('hidden');
      });
      
      if(['offers','accepted','declined'].includes(view)) {
          const el = document.getElementById('offersView');
          if(el) el.classList.remove('hidden');
      } else {
          const el = document.getElementById(view+'View');
          if(el) el.classList.remove('hidden');
      }
      
      refreshView();
    }

    function refreshView() {
        if(typeof updateStats === 'function') updateStats();
        
        if (currentView === 'dashboard') {
            const el = document.getElementById('recentOffersList');
            if(el) renderOffers(el, currentFilter, 5);
        } else if (['offers','accepted','declined'].includes(currentView)) {
            const filter = currentView === 'offers' ? 'all' : currentView;
            const el = document.getElementById('allOffersList');
            if(el) renderOffers(el, filter);
        } else if (currentView === 'clients') {
            renderClients();
        }
    }

    function toggleSidebar() { 
        const sb = document.getElementById('sidebar');
        if(sb) sb.classList.toggle('open'); 
    }

    function showToast(msg) { 
        const t = document.getElementById('toast'); 
        const tm = document.getElementById('toastMessage');
        if(t && tm) {
            tm.textContent = msg; 
            t.classList.add('show'); 
            setTimeout(() => t.classList.remove('show'), 3000); 
        }
    }
    // --- END RESTORED FUNCTIONS ---

    // Add event listeners for calculator inputs
    document.getElementById('calcAmountSlider').addEventListener('input', function() { document.getElementById('calcAmount').value = formatNumber(this.value); updateCalculatorPreview(); });
    document.getElementById('calcAmount').addEventListener('input', function() { const v = parseNumber(this.value); if(v >= 5000) document.getElementById('calcAmountSlider').value = v; updateCalculatorPreview(); });
    document.getElementById('calcFactorSlider').addEventListener('input', function() { document.getElementById('calcFactor').value = this.value; updateCalculatorPreview(); });
    document.getElementById('calcFactor').addEventListener('input', function() { document.getElementById('calcFactorSlider').value = this.value; updateCalculatorPreview(); });
    document.getElementById('calcTermSlider').addEventListener('input', function() { document.getElementById('calcTerm').value = this.value; updateCalculatorPreview(); });
    document.getElementById('calcTerm').addEventListener('input', function() { document.getElementById('calcTermSlider').value = this.value; updateCalculatorPreview(); });
    document.getElementById('calcFeeSlider').addEventListener('input', function() { document.getElementById('calcFee').value = this.value; updateCalculatorPreview(); });
    document.getElementById('calcFee').addEventListener('input', function() { document.getElementById('calcFeeSlider').value = this.value; updateCalculatorPreview(); });
    document.getElementById('calcPrepaySlider').addEventListener('input', function() { document.getElementById('calcPrepay').value = this.value; });
    document.getElementById('calcPrepay').addEventListener('input', function() { document.getElementById('calcPrepaySlider').value = this.value; });
    document.getElementById('calcTermOverride').addEventListener('input', updateCalculatorPreview);
    document.getElementById('calcBusinessName').addEventListener('input', updateCalculatorPreview);
    document.getElementById('calcNotes').addEventListener('input', updateCalculatorPreview);

    window.addEventListener('load', init);
    function init() {
        const params = new URLSearchParams(window.location.search); const offerId = params.get('offer');
        loadTheme(); loadSettings(); loadOffers();
        
        if (offerId) { showClientView(offerId); return; }
        
        // RESTORED: Navigation Event Listeners
        document.querySelectorAll('.nav-item[data-view]').forEach(item => {
            item.addEventListener('click', () => switchView(item.dataset.view));
        });

        // RESTORED: Dashboard Filter Event Listeners
        document.querySelectorAll('[data-filter]').forEach(btn => {
            btn.addEventListener('click', () => {
                currentFilter = btn.dataset.filter;
                document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                refreshView();
            });
        });

        resetCalculator(); refreshView(); updateSliderFills();
    }
  </script>
</body>
</html>
