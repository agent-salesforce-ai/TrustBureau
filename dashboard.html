<!DOCTYPE html>
<html lang="en" class="theme-light accent-mint">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TrustBureau.ai | Offer Dashboard</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z%22 fill=%22%2342D197%22/><path d=%22M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z%22 fill=%22white%22/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body, input, button, select, textarea, * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important; font-weight: 400; }
    body { font-size: 14px; -webkit-font-smoothing: antialiased; }
    
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Theme Variables */
    html.theme-light { 
      --bg-body: #f8fafc; 
      --bg-card: #ffffff; 
      --bg-card-inner: #f1f5f9; 
      --bg-input: #ffffff; 
      --bg-sidebar: #ffffff;
      --border-primary: #e2e8f0; 
      --text-primary: #0f172a; 
      --text-secondary: #334155; 
      --text-muted: #94a3b8; 
      --text-success: #16a34a;
      --text-warning: #d97706;
      --text-danger: #dc2626;
      --shadow-color: rgba(0, 0, 0, 0.05); 
      --bg-slider-track: #e2e8f0; 
    }
    html.theme-dark { 
      --bg-body: #0f172a; 
      --bg-card: #1e293b; 
      --bg-card-inner: #0f172a; 
      --bg-input: #1e293b; 
      --bg-sidebar: #1e293b;
      --border-primary: #334155; 
      --text-primary: #f8fafc; 
      --text-secondary: #e2e8f0; 
      --text-muted: #94a3b8; 
      --text-success: #4ade80;
      --text-warning: #fbbf24;
      --text-danger: #f87171;
      --shadow-color: rgba(0, 0, 0, 0.4); 
      --bg-slider-track: #334155; 
    }

    /* Accent Colors */
    html.accent-mint { --accent-color: #42D197; --accent-color-light: #74eabc; --accent-color-dark: #2d9668; --accent-text-inverted: #ffffff; }
    html.accent-blue { --accent-color: #3b82f6; --accent-color-light: #60a5fa; --accent-color-dark: #2563eb; --accent-text-inverted: #ffffff; }
    html.accent-gold { --accent-color: #D19B2B; --accent-color-light: #e6b650; --accent-color-dark: #a6781c; --accent-text-inverted: #020617; }
    html.accent-purple { --accent-color: #a855f7; --accent-color-light: #c084fc; --accent-color-dark: #9333ea; --accent-text-inverted: #ffffff; }
    html.accent-red { --accent-color: #ef4444; --accent-color-light: #f87171; --accent-color-dark: #dc2626; --accent-text-inverted: #ffffff; }
    html.accent-teal { --accent-color: #14b8a6; --accent-color-light: #2dd4bf; --accent-color-dark: #0d9488; --accent-text-inverted: #ffffff; }

    body { background-color: var(--bg-body); color: var(--text-primary); transition: background-color 0.3s ease; }
    
    .card-bg { background-color: var(--bg-card); border-color: var(--border-primary); }
    .sidebar-bg { background-color: var(--bg-sidebar); border-color: var(--border-primary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-muted { color: var(--text-muted); }
    .text-hero { color: var(--accent-color); }
    .text-success { color: var(--text-success); }
    .border-primary { border-color: var(--border-primary); }
    
    .input-field { 
      background-color: var(--bg-input); 
      border-color: var(--border-primary); 
      color: var(--text-primary); 
      transition: border-color 0.2s, box-shadow 0.2s;
    }
    .input-field:focus { 
      border-color: var(--accent-color); 
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); 
      outline: none; 
    }
    
    .button-primary { 
      background-color: var(--accent-color); 
      color: var(--accent-text-inverted); 
      font-weight: 500; 
      border-radius: 10px; 
      padding: 10px 20px; 
      border: none;
      transition: all 0.2s ease; 
      font-size: 13px;
      box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-color) 30%, transparent);
    }
    .button-primary:hover { 
      background-color: var(--accent-color-light); 
      transform: translateY(-1px); 
    }
    .button-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    .button-secondary {
      background: transparent;
      color: var(--text-secondary);
      font-weight: 500; 
      border-radius: 10px;
      padding: 10px 20px;
      border: 1px solid var(--border-primary);
      transition: all 0.2s ease;
      font-size: 13px;
    }
    .button-secondary:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }
    
    .button-toggle-action {
      background: color-mix(in srgb, var(--accent-color) 8%, transparent);
      color: var(--accent-color);
      border: 1px dashed var(--accent-color);
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
    }
    .button-toggle-action:hover {
      background: color-mix(in srgb, var(--accent-color) 15%, transparent);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px color-mix(in srgb, var(--accent-color) 15%, transparent);
    }

    .button-danger {
      background: transparent;
      color: #ef4444;
      font-weight: 500;
      border-radius: 10px;
      padding: 10px 20px;
      border: 1px solid #fecaca;
      transition: all 0.2s ease;
      font-size: 13px;
    }
    .button-danger:hover {
      background: #fef2f2;
      border-color: #ef4444;
    }

    /* Status Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-accepted { background: #d1fae5; color: #065f46; }
    .badge-expired { background: #fee2e2; color: #991b1b; }

    /* Sidebar Nav */
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      color: var(--text-secondary);
      transition: all 0.15s ease;
      cursor: pointer;
    }
    .nav-item:hover { background: var(--bg-card-inner); color: var(--text-primary); }
    .nav-item.active { background: color-mix(in srgb, var(--accent-color) 15%, transparent); color: var(--accent-color); }
    .nav-item.active svg { stroke: var(--accent-color); }

    /* Offer Card */
    .offer-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.2s ease;
    }
    .offer-card:hover {
      box-shadow: 0 8px 25px var(--shadow-color);
      transform: translateY(-2px);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    /* Slider */
    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      background: transparent;
      cursor: pointer;
      height: 6px;
      border-radius: 999px;
    }
    input[type=range]:focus { outline: none; }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 6px;
      background: transparent;
      border-radius: 999px;
    }
    input[type=range]::-webkit-slider-thumb {
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: var(--accent-color);
      cursor: pointer;
      -webkit-appearance: none;
      margin-top: -7px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border: 3px solid var(--bg-card);
      transition: transform 0.15s ease;
    }
    input[type=range]:hover::-webkit-slider-thumb {
      transform: scale(1.1);
    }

    /* Stats Card */
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 20px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Toggle */
    .toggle-group {
      display: inline-flex;
      background: var(--bg-card-inner);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 4px;
      gap: 4px;
    }
    .toggle-btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .toggle-btn:hover:not(.active) {
      background: color-mix(in srgb, var(--accent-color) 10%, transparent);
    }
    .toggle-btn.active {
      background: var(--accent-color);
      color: var(--accent-text-inverted);
      box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-color) 40%, transparent);
    }

    /* Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-primary);
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--accent-color);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      opacity: 0.3;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--text-primary);
      color: var(--bg-card);
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 13px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* QR Code Container */
    .qr-container {
      display: flex;
      justify-content: center;
      padding: 20px;
      background: white;
      border-radius: 12px;
      margin: 16px 0;
    }

    /* Donut Chart */
    .chart-wrapper {
      position: relative;
      width: 140px;
      height: 140px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chart-text {
      position: absolute;
      text-align: center;
      z-index: 10;
    }
    .circular-chart {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 100%;
    }
    .circle-bg {
      fill: none;
      stroke: var(--bg-slider-track);
      stroke-width: 2.5;
    }
    .circle {
      fill: none;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke: var(--accent-color);
      transition: stroke-dasharray 0.6s ease-out;
    }

    /* Tooltip */
    .tooltip-container { position: relative; display: inline-block; cursor: help; }
    .tooltip-text { 
      visibility: hidden; width: 200px; background-color: var(--text-primary); color: var(--bg-card); 
      text-align: center; border-radius: 8px; padding: 10px; position: absolute; z-index: 50; 
      bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; 
      font-size: 11px; font-weight: normal; box-shadow: 0 4px 12px rgba(0,0,0,0.15); line-height: 1.4; 
    }
    .tooltip-text::after { 
      content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; 
      border-width: 6px; border-style: solid; border-color: var(--text-primary) transparent transparent transparent; 
    }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

    /* Settings Panel */
    .settings-panel {
      padding: 16px;
      background: var(--bg-card-inner);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    /* Color Swatch */
    .color-swatch { 
      width: 32px; height: 32px; border-radius: 50%; cursor: pointer; 
      border: 3px solid transparent; transition: all 0.15s ease; 
    }
    .color-swatch:hover { transform: scale(1.15); }
    .color-swatch.selected { border-color: var(--text-primary); box-shadow: 0 0 0 3px var(--bg-card); }

    /* Client View */
    .client-view {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .client-card {
      background: var(--bg-card);
      border-radius: 24px;
      max-width: 500px;
      width: 100%;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
      overflow: hidden;
      border: 4px solid var(--accent-color);
    }

    /* Confetti Canvas */
    #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

    /* Expiration Banner */
    .expiration-banner {
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent-color) 15%, transparent), color-mix(in srgb, var(--accent-color) 5%, transparent));
      border: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent);
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .expiration-banner.urgent {
      background: linear-gradient(135deg, color-mix(in srgb, var(--text-danger) 15%, transparent), color-mix(in srgb, var(--text-danger) 5%, transparent));
      border-color: var(--text-danger);
    }
    .timer-digit {
      background: var(--bg-card);
      border-radius: 6px;
      padding: 6px 10px;
      font-weight: 500;
      font-size: 16px;
      min-width: 40px;
      text-align: center;
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    /* Simple no-select helper (for use if needed) */
    .no-select {
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    /* Mobile Sidebar */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); position: fixed; z-index: 60; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0 !important; }
      .mobile-header { display: flex !important; }
    }
    .mobile-header { display: none; }
  </style>
</head>
<body class="min-h-screen">

  <canvas id="confettiCanvas"></canvas>

  <!-- DASHBOARD VIEW -->
  <div id="dashboardContainer">
    <div class="flex min-h-screen">
      
      <!-- SIDEBAR -->
      <aside id="sidebar" class="sidebar w-64 sidebar-bg border-r border-primary flex flex-col fixed h-full z-50">
        <div class="p-6 border-b border-primary">
          <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-hero" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" clip-rule="evenodd" />
            </svg>
            <div>
              <div class="font-medium text-primary">TrustBureau.ai</div>
              <div class="text-[10px] text-muted uppercase tracking-wider">Offer Portal</div>
            </div>
          </div>
        </div>

        <nav class="flex-1 p-4 space-y-1">
          <div class="nav-item active" data-view="dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            Dashboard
          </div>
          <div class="nav-item" data-view="calculator">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            New Offer
          </div>
          <div class="nav-item" data-view="offers">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            All Offers
          </div>
          <div class="nav-item" data-view="clients">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Clients
          </div>
          <div class="nav-item" data-view="settings">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Settings
          </div>
        </nav>

        <div class="p-4 border-t border-primary">
          <div class="nav-item" onclick="toggleTheme()" role="button" tabindex="0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
            <span id="themeLabel">Dark Mode</span>
          </div>
          <div class="text-[10px] text-muted mt-4 px-2">
            Rep: <span id="repNameSidebar" class="text-secondary">Not Set</span>
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main-content flex-1 ml-64 p-8">
        
        <!-- Mobile Header -->
        <div class="mobile-header items-center justify-between mb-6 p-4 card-bg rounded-xl border border-primary">
          <button type="button" onclick="toggleSidebar()" class="p-2" aria-label="Toggle navigation">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          <span class="font-medium text-primary">TrustBureau.ai</span>
          <div class="w-8"></div>
        </div>

        <!-- HEADER -->
        <header class="flex items-center justify-between mb-8">
          <div>
            <h1 id="pageTitle" class="text-2xl font-medium text-primary">Dashboard</h1>
            <p id="pageSubtitle" class="text-sm text-muted mt-1">Welcome back! Here's your offer activity.</p>
          </div>
          <button type="button" onclick="switchView('calculator')" class="button-primary flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            New Offer
          </button>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
              <div class="stat-label mb-2">Total Offers</div>
              <div id="statTotal" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Pending</div>
              <div id="statPending" class="stat-value text-yellow-500">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Accepted</div>
              <div id="statAccepted" class="stat-value text-green-500">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Total Value</div>
              <div id="statValue" class="stat-value text-hero">$0</div>
            </div>
          </div>

          <div class="card-bg rounded-2xl border border-primary">
            <div class="p-5 border-b border-primary flex items-center justify-between">
              <h2 class="font-medium text-primary">Recent Offers</h2>
              <div class="toggle-group" role="radiogroup" aria-label="Filter offers by status">
                <button type="button" class="toggle-btn active" data-filter="all">All</button>
                <button type="button" class="toggle-btn" data-filter="pending">Pending</button>
                <button type="button" class="toggle-btn" data-filter="accepted">Accepted</button>
              </div>
            </div>
            <div id="recentOffersList" class="p-5"></div>
          </div>
        </div>

        <!-- CALCULATOR VIEW -->
        <div id="calculatorView" class="hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Calculator Inputs -->
            <div class="space-y-6">
              <div class="card-bg rounded-2xl border border-primary p-6">
                <h3 class="text-sm font-medium text-muted uppercase tracking-wider mb-4">Client Information</h3>
                <div class="space-y-4">
                  <div>
                    <label class="block text-xs text-muted mb-1">Business Name *</label>
                    <input id="calcBusinessName" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="Acme Holdings LLC" />
                  </div>
                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-xs text-muted mb-1">Contact Name</label>
                      <input id="calcContactName" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="John Smith" />
                    </div>
                    <div>
                      <label class="block text-xs text-muted mb-1">Email</label>
                      <input id="calcEmail" type="email" class="w-full p-3 border rounded-xl input-field" placeholder="john@acme.com" />
                    </div>
                  </div>
                  <div>
                    <label class="block text-xs text-muted mb-1">Phone</label>
                    <input id="calcPhone" type="tel" class="w-full p-3 border rounded-xl input-field" placeholder="(555) 123-4567" />
                  </div>
                </div>
              </div>

              <div class="card-bg rounded-2xl border border-primary p-6">
                <h3 class="text-sm font-medium text-muted uppercase tracking-wider mb-4">Offer Terms</h3>
                <div class="space-y-5">
                  <div>
                    <label class="block text-xs text-muted mb-2">Funding Amount</label>
                    <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000" value="50000" class="w-full mb-2" />
                    <div class="relative">
                      <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted">$</span>
                      <input id="calcAmount" type="text" class="w-full p-3 pl-8 border rounded-xl input-field font-medium" value="50,000" />
                    </div>
                  </div>

                  <div class="grid grid-cols-2 gap-4">
                    <div>
                      <label class="block text-xs text-muted mb-2 flex items-center gap-1">
                        Factor Rate
                        <div class="tooltip-container">
                          <svg xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 text-muted" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                          <span class="tooltip-text">The multiplier used to determine the total repayment amount.</span>
                        </div>
                      </label>
                      <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25" class="w-full mb-2" />
                      <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted">Ã—</span>
                        <input id="calcFactor" type="number" step="0.01" class="w-full p-3 pl-8 border rounded-xl input-field" value="1.25" />
                      </div>
                    </div>
                    <div>
                      <label class="block text-xs text-muted mb-2">Number of Payments</label>
                      <input id="calcTermSlider" type="range" min="3" max="528" step="1" value="130" class="w-full mb-2" />
                      <input id="calcTerm" type="number" class="w-full p-3 border rounded-xl input-field" value="130" />
                    </div>
                  </div>

                  <div>
                     <label class="block text-xs text-muted mb-1">Display Term (Optional Override)</label>
                     <input id="calcTermOverride" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="e.g. 6 Months" />
                     <p class="text-[10px] text-muted mt-1">Leave blank to calculate automatically from payments.</p>
                  </div>

                  <div>
                    <label class="block text-xs text-muted mb-2">Payment Frequency</label>
                    <div class="toggle-group w-full justify-center" role="radiogroup" aria-label="Payment frequency">
                      <button type="button" class="toggle-btn active" data-freq="daily" aria-pressed="true">Daily</button>
                      <button type="button" class="toggle-btn" data-freq="weekly" aria-pressed="false">Weekly</button>
                      <button type="button" class="toggle-btn" data-freq="monthly" aria-pressed="false">Monthly</button>
                    </div>
                  </div>

                  <div>
                    <label class="block text-xs text-muted mb-2">Expires In (Days)</label>
                    <input id="calcExpiry" type="number" min="1" max="90" class="w-full p-3 border rounded-xl input-field" value="14" />
                  </div>

                  <!-- Optional Toggles -->
                  <div class="flex gap-3">
                    <button type="button" id="btnToggleFee" class="button-toggle-action flex-1" onclick="toggleFeeInput(true)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                        Add Origination Fee
                    </button>
                    <button type="button" id="btnTogglePrepay" class="button-toggle-action flex-1" onclick="togglePrepayInput(true)">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        Add Prepay Discount
                    </button>
                  </div>

                  <!-- Hidden Inputs -->
                  <div id="containerFee" class="hidden relative p-3 border border-dashed border-primary rounded-xl bg-[var(--bg-card-inner)]">
                      <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs text-muted">Origination Fee (%)</label>
                        <button type="button" class="text-muted hover:text-red-500" onclick="toggleFeeInput(false)">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                      </div>
                      <input id="calcFeeSlider" type="range" min="0" max="15" step="0.5" value="0" class="w-full mb-2" />
                      <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted">%</span>
                        <input id="calcFee" type="number" step="0.5" min="0" max="15" class="w-full p-3 pl-8 border rounded-xl input-field bg-[var(--bg-card)]" value="0" />
                      </div>
                  </div>

                  <div id="containerPrepay" class="hidden relative p-3 border border-dashed border-primary rounded-xl bg-[var(--bg-card-inner)]">
                      <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs text-muted">Prepayment Discount (%)</label>
                        <button type="button" class="text-muted hover:text-red-500" onclick="togglePrepayInput(false)">
                             <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                        </button>
                      </div>
                      <input id="calcPrepaySlider" type="range" min="0" max="50" step="1" value="0" class="w-full mb-2" />
                      <div class="relative">
                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted">%</span>
                        <input id="calcPrepay" type="number" step="1" min="0" max="50" class="w-full p-3 pl-8 border rounded-xl input-field bg-[var(--bg-card)]" value="0" />
                      </div>
                  </div>

                </div>
              </div>

              <div class="flex gap-4">
                <button type="button" onclick="resetCalculator()" class="button-secondary flex-1">Reset</button>
                <button type="button" onclick="createOffer()" class="button-primary flex-1">Create & Share Offer</button>
              </div>
            </div>

            <!-- Offer Preview -->
            <div class="space-y-6">
              <div class="card-bg rounded-2xl border-4 border-primary p-6 sticky top-8" style="border-color: var(--accent-color);">
                <div class="text-center pb-4 border-b border-primary mb-4">
                  <h4 class="text-sm font-medium text-secondary uppercase tracking-wider">Offer Preview</h4>
                </div>
                
                <div id="previewBusinessName" class="text-center text-sm font-medium text-primary mb-2 hidden"></div>
                
                <div class="text-center py-4">
                  <span class="text-[11px] font-medium text-muted block uppercase tracking-widest">You Get</span>
                  <span id="previewAmount" class="text-5xl font-semibold block my-3 text-hero leading-tight">$50,000</span>
                </div>

                <!-- Donut Chart -->
                <div class="my-5">
                  <div class="chart-wrapper" title="Principal vs Cost">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                      <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                      <path id="previewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="chart-text">
                      <span class="text-[10px] text-muted block uppercase tracking-wider">Payback</span>
                      <span id="previewPaybackChart" class="text-base font-medium text-primary block">$62,500</span>
                    </div>
                  </div>
                  <div class="flex justify-center gap-4 mt-3 text-[11px]">
                    <div class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-[var(--accent-color)] mr-1.5"></span> Principal</div>
                    <div class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-[var(--bg-slider-track)] mr-1.5"></span> Cost</div>
                  </div>
                </div>

                <!-- APR Display -->
                <div id="previewAprContainer" class="p-3 rounded-xl text-center mb-4 hidden" style="background: var(--bg-card-inner);">
                  <span class="text-xs font-medium text-muted uppercase tracking-wider">Estimated APR</span>
                  <span id="previewApr" class="text-2xl font-medium text-hero block">48%</span>
                </div>

                <!-- Details Grid -->
                <div class="border border-primary rounded-xl overflow-hidden">
                  <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
                    <div class="p-3 text-center">
                      <span class="text-[10px] text-muted block uppercase">Term Length</span>
                      <span id="previewTermLength" class="text-sm font-medium text-primary">6 months</span>
                    </div>
                    <div class="p-3 text-center">
                      <span class="text-[10px] text-muted block uppercase">Payments</span>
                      <span id="previewTermPayments" class="text-sm font-medium text-primary">130</span>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
                    <div class="p-3 text-center">
                      <span class="text-[10px] text-muted block uppercase">Factor Rate</span>
                      <span id="previewFactor" class="text-sm font-medium text-primary">1.25x</span>
                    </div>
                    <div class="p-3 text-center">
                      <span class="text-[10px] text-muted block uppercase">Total Cost</span>
                      <span id="previewCost" class="text-sm font-medium text-primary">$12,500</span>
                    </div>
                  </div>
                  <div id="previewFeeRow" class="grid grid-cols-2 divide-x divide-primary border-b border-primary hidden">
                    <div class="p-3 text-center">
                      <span class="text-[10px] text-muted block uppercase">Origination Fee</span>
                      <span id="previewFeeAmount" class="text-sm font-medium text-primary">$0</span>
                    </div>
                    <div class="p-3 text-center">
                      <span class="text-[10px] text-muted block uppercase">Net Proceeds</span>
                      <span id="previewNet" class="text-sm font-medium text-primary">$50,000</span>
                    </div>
                  </div>
                  <div class="p-4 text-center" style="background: var(--bg-card-inner);">
                    <span id="previewPaymentLabel" class="text-[10px] text-muted block uppercase">Est. Daily Payment</span>
                    <span id="previewPayment" class="text-lg font-medium text-primary">$480.77</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ALL OFFERS VIEW -->
        <div id="offersView" class="hidden">
          <div id="allOffersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- CLIENTS VIEW -->
        <div id="clientsView" class="hidden">
          <div id="clientsList" class="space-y-4"></div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settingsView" class="hidden">
          <div class="card-bg rounded-2xl border border-primary p-6 max-w-2xl">
            <h2 class="text-lg font-medium text-primary mb-6">Settings</h2>
            
            <div class="settings-panel">
              <h3 class="text-sm font-medium text-muted uppercase tracking-wider mb-4">Rep Information</h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs text-muted mb-1">Your Name</label>
                  <input id="settingsRepName" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="John Smith" />
                </div>
                <div>
                  <label class="block text-xs text-muted mb-1">Your Email</label>
                  <input id="settingsRepEmail" type="email" class="w-full p-3 border rounded-xl input-field" placeholder="john@company.com" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4 mt-4">
                <div>
                  <label class="block text-xs text-muted mb-1">Company Name</label>
                  <input id="settingsCompanyName" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="Trust Capital Funding" />
                </div>
                <div>
                  <label class="block text-xs text-muted mb-1">Phone Number</label>
                  <input id="settingsRepPhone" type="tel" class="w-full p-3 border rounded-xl input-field" placeholder="(555) 123-4567" />
                </div>
              </div>
              <div class="mt-4">
                <label class="block text-xs text-muted mb-1">Company Logo URL</label>
                <input id="settingsLogoUrl" type="url" class="w-full p-3 border rounded-xl input-field" placeholder="https://example.com/logo.png" />
              </div>
            </div>

            <div class="settings-panel">
              <h3 class="text-sm font-medium text-muted uppercase tracking-wider mb-4">Appearance</h3>
              <div class="flex gap-3 mb-6">
                <div onclick="setAccent('mint')" class="color-swatch" style="background-color: #42D197;" title="Mint"></div>
                <div onclick="setAccent('blue')" class="color-swatch" style="background-color: #3b82f6;" title="Blue"></div>
                <div onclick="setAccent('gold')" class="color-swatch" style="background-color: #D19B2B;" title="Gold"></div>
                <div onclick="setAccent('purple')" class="color-swatch" style="background-color: #a855f7;" title="Purple"></div>
                <div onclick="setAccent('red')" class="color-swatch" style="background-color: #ef4444;" title="Red"></div>
                <div onclick="setAccent('teal')" class="color-swatch" style="background-color: #14b8a6;" title="Teal"></div>
              </div>
              
              <!-- APR Toggle -->
              <div class="flex items-center justify-between pt-2 border-t border-primary">
                <label class="text-sm font-medium text-primary">Show APR on Offers</label>
                <label class="switch">
                  <input id="settingsShowApr" type="checkbox">
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <div class="settings-panel">
              <h3 class="text-sm font-medium text-muted uppercase tracking-wider mb-4">Default Offer Terms</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs text-muted mb-1">Default Factor</label>
                  <input id="settingsDefaultFactor" type="number" step="0.01" class="w-full p-3 border rounded-xl input-field" value="1.25" />
                </div>
                <div>
                  <label class="block text-xs text-muted mb-1">Default Term</label>
                  <input id="settingsDefaultTerm" type="number" class="w-full p-3 border rounded-xl input-field" value="130" />
                </div>
                <div>
                  <label class="block text-xs text-muted mb-1">Expiry (Days)</label>
                  <input id="settingsDefaultExpiry" type="number" class="w-full p-3 border rounded-xl input-field" value="14" />
                </div>
              </div>
            </div>

            <button type="button" onclick="saveSettings()" class="button-primary mt-4">Save Settings</button>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- CLIENT VIEW (Public Offer View) -->
  <div id="clientContainer" class="client-view hidden">
    <div class="client-card">
      <div class="p-6 border-b border-primary text-center">
        <div id="clientLogoWrapper" class="flex items-center justify-center mb-3">
          <img id="clientLogo" src="" alt="Logo" class="h-12 w-auto hidden" />
          <svg id="clientLogoPlaceholder" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-hero" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" clip-rule="evenodd" />
          </svg>
        </div>
        <div id="clientCompanyName" class="font-medium text-primary text-lg">TrustBureau.ai</div>
        <div id="clientPoweredBy" class="text-[10px] text-muted uppercase tracking-widest mt-1 hidden">powered by TrustBureau.ai</div>
      </div>

      <!-- Expiration Timer -->
      <div id="clientExpirationBanner" class="expiration-banner mx-6 mt-6 hidden">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-hero" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
          <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <span class="text-sm font-medium text-secondary">Offer expires in</span>
        <div class="flex items-center gap-1">
          <span id="clientTimerHours" class="timer-digit text-primary">00</span>
          <span class="text-muted font-medium">:</span>
          <span id="clientTimerMinutes" class="timer-digit text-primary">00</span>
          <span class="text-muted font-medium">:</span>
          <span id="clientTimerSeconds" class="timer-digit text-primary">00</span>
        </div>
      </div>

      <div class="p-6">
        <div class="text-center border-b border-primary pb-4 mb-4">
          <h4 class="text-sm font-medium text-secondary uppercase tracking-wider">Your Approved Terms</h4>
        </div>
        
        <div id="clientBusinessNameDisplay" class="text-center text-sm font-medium text-primary mb-2 hidden"></div>
        
        <div class="text-center py-4">
          <span class="text-[11px] font-medium text-muted block uppercase tracking-widest">You Get</span>
          <span id="clientAmount" class="text-5xl font-semibold block my-3 text-hero leading-tight">$50,000</span>
        </div>

        <!-- Donut Chart -->
        <div class="my-5">
          <div class="chart-wrapper">
            <svg viewBox="0 0 36 36" class="circular-chart">
              <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
              <path id="clientCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
            </svg>
            <div class="chart-text">
              <span class="text-[10px] text-muted block uppercase tracking-wider">Payback</span>
              <span id="clientPaybackChart" class="text-base font-medium text-primary block">$62,500</span>
            </div>
          </div>
          <div class="flex justify-center gap-4 mt-3 text-[11px]">
            <div class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-[var(--accent-color)] mr-1.5"></span> Principal</div>
            <div class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-[var(--bg-slider-track)] mr-1.5"></span> Cost</div>
          </div>
        </div>

        <!-- APR Display -->
        <div id="clientAprSection" class="p-3 rounded-xl text-center mb-4 hidden" style="background: var(--bg-card-inner);">
          <span class="text-xs font-medium text-muted uppercase tracking-wider">Estimated APR</span>
          <span id="clientApr" class="text-2xl font-medium text-hero block">48%</span>
        </div>

        <!-- Details Grid -->
        <div class="border border-primary rounded-xl overflow-hidden mb-6">
          <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
            <div class="p-3 text-center">
              <span class="text-[10px] text-muted block uppercase">Term Length</span>
              <span id="clientTermLength" class="text-sm font-medium text-primary">6 months</span>
            </div>
            <div class="p-3 text-center">
              <span class="text-[10px] text-muted block uppercase">Payments</span>
              <span id="clientTermPayments" class="text-sm font-medium text-primary">130</span>
            </div>
          </div>
          <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
            <div class="p-3 text-center">
              <span class="text-[10px] text-muted block uppercase">Factor Rate</span>
              <span id="clientFactor" class="text-sm font-medium text-primary">1.25x</span>
            </div>
            <div class="p-3 text-center">
              <span class="text-[10px] text-muted block uppercase">Total Cost</span>
              <span id="clientCost" class="text-sm font-medium text-primary">$12,500</span>
            </div>
          </div>
          <div id="clientFeeRow" class="grid grid-cols-2 divide-x divide-primary border-b border-primary hidden">
            <div class="p-3 text-center">
              <span class="text-[10px] text-muted block uppercase">Origination Fee</span>
              <span id="clientFeeAmount" class="text-sm font-medium text-primary">$0</span>
            </div>
            <div class="p-3 text-center">
              <span class="text-[10px] text-muted block uppercase">Net Proceeds</span>
              <span id="clientNet" class="text-sm font-medium text-primary">$50,000</span>
            </div>
          </div>
          <div class="p-4 text-center" style="background: var(--bg-card-inner);">
            <span id="clientPaymentLabel" class="text-[10px] text-muted block uppercase">Est. Daily Payment</span>
            <span id="clientPayment" class="text-lg font-medium text-primary">$480.77</span>
          </div>
        </div>

        <!-- Accept Button -->
        <button id="clientAcceptBtn" type="button" onclick="acceptOffer()" class="w-full button-primary text-sm uppercase tracking-wider py-4 flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" />
          </svg>
          Accept This Offer
        </button>

        <!-- Accepted State -->
        <div id="clientAcceptedState" class="hidden text-center py-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-green-500 mb-4" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
          </svg>
          <div class="text-xl font-semibold text-green-600 mb-2">Offer Accepted!</div>
          <div class="text-sm text-muted">Your funding specialist will be in touch shortly.</div>
        </div>

        <!-- Expired State -->
        <div id="clientExpiredState" class="hidden text-center py-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-red-400 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
          </svg>
          <div class="text-xl font-semibold text-red-500 mb-2">Offer Expired</div>
          <div class="text-sm text-muted">Please contact your funding specialist for a new offer.</div>
        </div>

        <!-- Prepay Section -->
        <div id="clientPrepaySection" class="mt-6 pt-4 border-t border-primary hidden">
          <div class="flex items-center gap-2 mb-3 text-primary font-medium">
             <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-hero" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
               <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
             </svg>
             Prepayment Savings Calculator
          </div>
          <div id="clientPrepayContainer" class="p-4 rounded-xl border border-primary" style="background: var(--bg-card-inner);">
            <div class="flex justify-between items-center mb-3 pb-2 border-b border-primary">
              <span class="text-xs font-medium text-secondary uppercase tracking-wider">Discount Rate</span>
              <span id="clientPrepayPercent" class="text-sm font-medium text-hero">0% Max</span>
            </div>
            <div class="mb-4">
              <label class="block text-xs font-medium text-muted mb-2 text-center">Select Payoff Date to See Savings</label>
              <input id="clientPrepayDate" type="date" class="w-full p-2.5 text-sm rounded-lg border border-primary input-field text-center font-medium" />
              <div class="text-[10px] text-muted text-center mt-1">Adjust date to see potential savings</div>
            </div>
            <div class="grid grid-cols-2 gap-4 text-center border-t border-primary pt-4">
              <div>
                <span class="text-[10px] font-medium text-muted block uppercase tracking-wider">You Save</span>
                <span id="clientPrepaySavings" class="text-xl font-bold text-success">$0</span>
              </div>
              <div>
                <span class="text-[10px] font-medium text-muted block uppercase tracking-wider">New Payoff</span>
                <span id="clientPrepayTotal" class="text-xl font-bold text-primary">$0</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Rep Contact -->
        <div id="clientRepInfo" class="mt-6 pt-4 border-t border-primary text-xs text-secondary text-center hidden">
          <div class="font-medium text-muted mb-1 uppercase tracking-wider text-[10px]">Your Funding Specialist</div>
          <div id="clientRepName" class="font-medium text-primary"></div>
          <div id="clientRepEmail" class="text-muted"></div>
          <div id="clientRepPhone" class="text-muted"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- OFFER DETAIL MODAL -->
  <div id="offerDetailModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="offerDetailTitle">
    <div class="modal-content max-w-lg">
      <div class="p-6 border-b border-primary flex items-center justify-between">
        <h3 id="offerDetailTitle" class="text-lg font-medium text-primary">Offer Details</h3>
        <button type="button" onclick="closeOfferDetailModal()" class="p-2 rounded-lg hover:bg-gray-100 text-muted" aria-label="Close offer details">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="offerDetailContent" class="p-6"></div>
      <div class="px-6 pb-4">
        <div class="text-center text-xs text-muted mb-2">Scan to view offer</div>
        <div id="offerQrCode" class="qr-container"></div>
      </div>
      <div class="p-6 border-t border-primary">
        <div class="flex gap-3 mb-3">
          <button type="button" onclick="copyOfferLink()" class="button-secondary flex-1 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
            Copy Link
          </button>
          <button type="button" onclick="sendOfferEmail()" class="button-secondary flex-1 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            Email Client
          </button>
          <button type="button" onclick="copyOfferText()" class="button-primary flex-1 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Copy Text
          </button>
        </div>
        <button type="button" onclick="confirmDeleteOffer()" class="button-danger w-full flex items-center justify-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
          </svg>
          Delete Offer
        </button>
      </div>
    </div>
  </div>

  <!-- CONFIRM DELETE MODAL -->
  <div id="confirmModal" class="modal-overlay hidden" style="z-index: 110;">
    <div class="modal-content max-w-sm p-6 text-center">
      <h3 class="text-lg font-medium text-primary mb-2">Confirm Deletion</h3>
      <p class="text-muted mb-6">Are you sure you want to delete this offer? This cannot be undone.</p>
      <div class="flex gap-3">
        <button onclick="closeConfirmModal()" class="button-secondary flex-1">Cancel</button>
        <button onclick="executeDelete()" class="button-primary flex-1 bg-red-500 hover:bg-red-600 border-none text-white">Delete</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
    </svg>
    <span id="toastMessage">Success!</span>
  </div>

  <script>
    // ====================
    // DATA STORE
    // ====================
    let offers = [];
    let currentFilter = 'all';
    let currentView = 'dashboard';
    let selectedOfferId = null;
    let selectedFrequency = 'daily';
    let clientTimerId = null;
    let settings = {
      repName: '',
      repEmail: '',
      repPhone: '',
      companyName: '',
      logoUrl: '',
      defaultFactor: 1.25,
      defaultTerm: 130,
      defaultExpiry: 14,
      accent: 'mint',
      showApr: false // Default to false
    };

    const STORAGE_KEY = 'trustbureau_offers';
    const SETTINGS_KEY = 'trustbureau_settings';

    // ====================
    // UTILITIES
    // ====================
    function generateId() {
      return 'offer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function formatCurrency(num) {
      const n = Number(num);
      if (isNaN(n)) return '$0';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n);
    }

    function parseNumber(val) {
      if (typeof val !== 'string' || !val) return 0;
      return parseFloat(val.replace(/[\$,]/g, '')) || 0;
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('en-US').format(num);
    }

    // New Helper: Copy to Clipboard for iframe/canvas
    function copyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";  // Avoid scrolling to bottom
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) showToast('Copied to clipboard!');
            else showToast('Copy failed');
        } catch (err) {
            showToast('Copy failed');
        }
        document.body.removeChild(textArea);
    }

    function fireConfetti() {
      const canvas = document.getElementById('confettiCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const pieces = [];
      const colors = ['#42D197', '#3b82f6', '#f97316', '#a855f7', '#ec4899', '#eab308'];
      for (let i = 0; i < 150; i++) {
        pieces.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          w: Math.random() * 12 + 5,
          h: Math.random() * 6 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          vy: Math.random() * 3 + 2,
          vx: Math.random() * 4 - 2,
          rotation: Math.random() * 360
        });
      }
      function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let active = false;
        pieces.forEach(p => {
          p.y += p.vy;
          p.x += p.vx;
          p.rotation += 3;
          if (p.y < canvas.height + 50) active = true;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.restore();
        });
        if (active) requestAnimationFrame(update);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      update();
    }

    // ====================
    // STORAGE
    // ====================
    function loadOffers() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          offers = JSON.parse(stored);
          const now = Date.now();
          offers = offers.map(offer => {
            if (offer.status === 'pending' && offer.expiresAt && now > offer.expiresAt) {
              return { ...offer, status: 'expired' };
            }
            return offer;
          });
          saveOffers();
        }
      } catch (e) {
        console.error('Error loading offers:', e);
        offers = [];
      }
    }

    function saveOffers() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(offers));
      } catch (e) {
        console.error('Error saving offers:', e);
      }
    }

    function loadSettings() {
      try {
        const stored = localStorage.getItem(SETTINGS_KEY);
        if (stored) {
          settings = { ...settings, ...JSON.parse(stored) };
        }
        updateSettingsUI();
        updateRepDisplay();
        if (settings.accent) {
          setAccent(settings.accent, false);
        }
      } catch (e) {
        console.error('Error loading settings:', e);
      }
    }

    function saveSettings() {
      settings.repName = document.getElementById('settingsRepName').value.trim();
      settings.repEmail = document.getElementById('settingsRepEmail').value.trim();
      settings.repPhone = document.getElementById('settingsRepPhone').value.trim();
      settings.companyName = document.getElementById('settingsCompanyName').value.trim();
      settings.logoUrl = document.getElementById('settingsLogoUrl').value.trim();
      settings.defaultFactor = parseFloat(document.getElementById('settingsDefaultFactor').value) || 1.25;
      settings.defaultTerm = parseInt(document.getElementById('settingsDefaultTerm').value) || 130;
      settings.defaultExpiry = parseInt(document.getElementById('settingsDefaultExpiry').value) || 14;
      settings.showApr = document.getElementById('settingsShowApr').checked; // Save APR toggle state
      
      try {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        updateRepDisplay();
        showToast('Settings saved!');
        
        // Refresh preview if APR setting changed
        updateCalculatorPreview();
      } catch (e) {
        console.error('Error saving settings:', e);
      }
    }

    function updateSettingsUI() {
      document.getElementById('settingsRepName').value = settings.repName || '';
      document.getElementById('settingsRepEmail').value = settings.repEmail || '';
      document.getElementById('settingsRepPhone').value = settings.repPhone || '';
      document.getElementById('settingsCompanyName').value = settings.companyName || '';
      document.getElementById('settingsLogoUrl').value = settings.logoUrl || '';
      document.getElementById('settingsDefaultFactor').value = settings.defaultFactor || 1.25;
      document.getElementById('settingsDefaultTerm').value = settings.defaultTerm || 130;
      document.getElementById('settingsDefaultExpiry').value = settings.defaultExpiry || 14;
      document.getElementById('settingsShowApr').checked = settings.showApr || false; // Set checkbox state
    }

    function updateRepDisplay() {
      const repName = settings.repName || 'Not Set';
      document.getElementById('repNameSidebar').textContent = repName;
    }

    // ====================
    // THEME & ACCENT
    // ====================
    let isDark = false;

    function toggleTheme() {
      isDark = !isDark;
      document.documentElement.classList.toggle('theme-dark', isDark);
      document.documentElement.classList.toggle('theme-light', !isDark);
      document.getElementById('themeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateSliderFills();
    }

    function loadTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') {
        isDark = true;
        document.documentElement.classList.remove('theme-light');
        document.documentElement.classList.add('theme-dark');
        document.getElementById('themeLabel').textContent = 'Light Mode';
      }
    }

    function setAccent(accent, save = true) {
      document.documentElement.classList.remove('accent-mint', 'accent-blue', 'accent-gold', 'accent-purple', 'accent-red', 'accent-teal');
      document.documentElement.classList.add('accent-' + accent);
      settings.accent = accent;
      if (save) {
        try {
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        } catch (e) {
          console.error('Error saving accent to settings:', e);
        }
      }
      updateSliderFills();
    }

    // ====================
    // CALCULATIONS
    // ====================
    function calculateOffer(amount, factor, term, frequency, fee) {
      const totalPayback = amount * factor;
      const totalCost = totalPayback - amount;
      const payment = totalPayback / term;
      const feeAmount = amount * (fee / 100);
      const netProceeds = amount - feeAmount;
      
      let termInYears;
      if (frequency === 'weekly') termInYears = term / 52;
      else if (frequency === 'monthly') termInYears = term / 12;
      else termInYears = term / 250;
      
      const apr = termInYears > 0 ? Math.round(((totalCost / amount) / termInYears) * 100) : 0;

      let termMonths;
      if (frequency === 'weekly') termMonths = term * (12 / 52);
      else if (frequency === 'monthly') termMonths = term;
      else termMonths = term * (12 / 250);
      termMonths = Math.round(termMonths * 2) / 2;
      
      return { amount, factor, term, frequency, fee, feeAmount, netProceeds, totalPayback, totalCost, payment, apr, termMonths };
    }

    // ====================
    // SLIDER MANAGEMENT
    // ====================
    function updateSliderFill(slider) {
      if (!slider) return;
      const min = parseFloat(slider.min) || 0;
      const max = parseFloat(slider.max) || 100;
      const val = parseFloat(slider.value) || 0;
      const percentage = ((val - min) / (max - min)) * 100;
      slider.style.background = `linear-gradient(to right, var(--accent-color) 0%, var(--accent-color) ${percentage}%, var(--bg-slider-track) ${percentage}%, var(--bg-slider-track) 100%)`;
    }

    function updateSliderFills() {
      updateSliderFill(document.getElementById('calcAmountSlider'));
      updateSliderFill(document.getElementById('calcFactorSlider'));
      updateSliderFill(document.getElementById('calcTermSlider'));
      updateSliderFill(document.getElementById('calcFeeSlider'));
      updateSliderFill(document.getElementById('calcPrepaySlider'));
    }

    // ====================
    // CALCULATOR TOGGLES
    // ====================
    function toggleFeeInput(show) {
        const container = document.getElementById('containerFee');
        const button = document.getElementById('btnToggleFee');
        
        if (show) {
            container.classList.remove('hidden');
            button.classList.add('hidden');
        } else {
            container.classList.add('hidden');
            button.classList.remove('hidden');
            document.getElementById('calcFee').value = 0;
            document.getElementById('calcFeeSlider').value = 0;
            updateSliderFill(document.getElementById('calcFeeSlider'));
            updateCalculatorPreview();
        }
    }

    function togglePrepayInput(show) {
        const container = document.getElementById('containerPrepay');
        const button = document.getElementById('btnTogglePrepay');
        
        if (show) {
            container.classList.remove('hidden');
            button.classList.add('hidden');
        } else {
            container.classList.add('hidden');
            button.classList.remove('hidden');
            document.getElementById('calcPrepay').value = 0;
            document.getElementById('calcPrepaySlider').value = 0;
            updateSliderFill(document.getElementById('calcPrepaySlider'));
        }
    }

    // ====================
    // CALCULATOR PREVIEW
    // ====================
    function updateCalculatorPreview() {
      const amount = parseNumber(document.getElementById('calcAmount').value);
      const factor = parseFloat(document.getElementById('calcFactor').value) || 1.25;
      const term = parseInt(document.getElementById('calcTerm').value) || 130;
      const fee = parseFloat(document.getElementById('calcFee').value) || 0;
      const termOverride = document.getElementById('calcTermOverride').value.trim();
      const businessName = document.getElementById('calcBusinessName').value.trim();
      
      const calc = calculateOffer(amount, factor, term, selectedFrequency, fee);
      
      // Update preview
      if (businessName) {
        document.getElementById('previewBusinessName').textContent = businessName;
        document.getElementById('previewBusinessName').classList.remove('hidden');
      } else {
        document.getElementById('previewBusinessName').classList.add('hidden');
      }
      
      document.getElementById('previewAmount').textContent = formatCurrency(calc.amount);
      document.getElementById('previewPaybackChart').textContent = formatCurrency(calc.totalPayback);
      
      // Toggle APR based on setting
      const aprContainer = document.getElementById('previewAprContainer');
      if (settings.showApr) {
          aprContainer.classList.remove('hidden');
          document.getElementById('previewApr').textContent = calc.apr + '%';
      } else {
          aprContainer.classList.add('hidden');
      }

      // Use term override if available, otherwise calc
      document.getElementById('previewTermLength').textContent = termOverride ? termOverride : (calc.termMonths + ' months');

      document.getElementById('previewTermPayments').textContent = calc.term + ' payments';
      document.getElementById('previewFactor').textContent = calc.factor.toFixed(2) + 'x';
      document.getElementById('previewCost').textContent = formatCurrency(calc.totalCost);
      
      const paymentLabel = selectedFrequency === 'weekly' ? 'Est. Weekly Payment' : 
                           selectedFrequency === 'monthly' ? 'Est. Monthly Payment' : 'Est. Daily Payment';
      document.getElementById('previewPaymentLabel').textContent = paymentLabel;
      document.getElementById('previewPayment').textContent = formatCurrency(calc.payment);
      
      // Fee row
      if (fee > 0) {
        document.getElementById('previewFeeRow').classList.remove('hidden');
        document.getElementById('previewFeeAmount').textContent = formatCurrency(calc.feeAmount);
        document.getElementById('previewNet').textContent = formatCurrency(calc.netProceeds);
      } else {
        document.getElementById('previewFeeRow').classList.add('hidden');
      }
      
      // Donut chart
      const principalPct = calc.totalPayback > 0 ? (calc.amount / calc.totalPayback) * 100 : 0;
      document.getElementById('previewCircle').setAttribute('stroke-dasharray', `${principalPct} ${100 - principalPct}`);
    }

    function updateFrequencyButtons() {
      document.querySelectorAll('[data-freq]').forEach(btn => {
        const isActive = btn.dataset.freq === selectedFrequency;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
    }

    function resetCalculator() {
      document.getElementById('calcBusinessName').value = '';
      document.getElementById('calcContactName').value = '';
      document.getElementById('calcEmail').value = '';
      document.getElementById('calcPhone').value = '';
      document.getElementById('calcAmount').value = '50,000';
      document.getElementById('calcAmountSlider').value = 50000;
      document.getElementById('calcFactor').value = settings.defaultFactor;
      document.getElementById('calcFactorSlider').value = settings.defaultFactor;
      document.getElementById('calcTerm').value = settings.defaultTerm;
      document.getElementById('calcTermSlider').value = settings.defaultTerm;
      document.getElementById('calcTermOverride').value = ''; // Reset Override
      
      // Reset Optional Fields
      toggleFeeInput(false);
      togglePrepayInput(false);
      
      // Ensure sliders are reset visually even if hidden
      document.getElementById('calcFeeSlider').value = 0;
      document.getElementById('calcPrepaySlider').value = 0;

      document.getElementById('calcExpiry').value = settings.defaultExpiry;
      selectedFrequency = 'daily';
      updateFrequencyButtons();
      updateSliderFills();
      updateCalculatorPreview();
    }

    // ====================
    // OFFER MANAGEMENT
    // ====================
    function createOffer() {
      const businessName = document.getElementById('calcBusinessName').value.trim();
      if (!businessName) {
        showToast('Please enter a business name');
        document.getElementById('calcBusinessName').focus();
        return;
      }
      
      const amount = parseNumber(document.getElementById('calcAmount').value);
      const factor = parseFloat(document.getElementById('calcFactor').value) || 1.25;
      const term = parseInt(document.getElementById('calcTerm').value) || 130;
      const termOverride = document.getElementById('calcTermOverride').value.trim();
      const fee = parseFloat(document.getElementById('calcFee').value) || 0;
      const expiryDays = parseInt(document.getElementById('calcExpiry').value) || 14;
      const prepay = parseInt(document.getElementById('calcPrepay').value) || 0;
      
      const calc = calculateOffer(amount, factor, term, selectedFrequency, fee);
      
      const offer = {
        id: generateId(),
        businessName,
        contactName: document.getElementById('calcContactName').value.trim(),
        email: document.getElementById('calcEmail').value.trim(),
        phone: document.getElementById('calcPhone').value.trim(),
        ...calc,
        termOverride, // Save override
        prepayDiscount: prepay,
        status: 'pending',
        createdAt: Date.now(),
        expiresAt: Date.now() + (expiryDays * 24 * 60 * 60 * 1000),
        viewedAt: null,
        acceptedAt: null,
        repName: settings.repName,
        repEmail: settings.repEmail,
        repPhone: settings.repPhone,
        companyName: settings.companyName,
        logoUrl: settings.logoUrl,
        accent: settings.accent,
        showApr: settings.showApr // Capture current APR setting
      };
      
      offers.push(offer);
      saveOffers();
      
      resetCalculator();
      refreshView();
      showToast('Offer created successfully!');
      
      setTimeout(() => {
        selectedOfferId = offer.id;
        openOfferDetail(offer.id);
      }, 300);
    }

    function generateOfferLink(offer) {
      const baseUrl = window.location.origin + window.location.pathname;
      return baseUrl + '?offer=' + encodeURIComponent(offer.id);
    }

    function copyOfferLink() {
      const offer = offers.find(o => o.id === selectedOfferId);
      if (!offer) return;
      
      const link = generateOfferLink(offer);
      copyToClipboard(link);
    }

    function sendOfferEmail() {
      const offer = offers.find(o => o.id === selectedOfferId);
      if (!offer) return;
      
      const company = offer.companyName || 'TrustBureau.ai';
      const freqLabel = offer.frequency.charAt(0).toUpperCase() + offer.frequency.slice(1);
      const link = generateOfferLink(offer);
      const aprLine = offer.showApr ? `Estimated APR: ${offer.apr}%` : '';

      const subject = encodeURIComponent(`Funding Offer: ${offer.businessName} - Approval Details`);
      const body = encodeURIComponent(`Hi ${offer.contactName || 'there'},

We are pleased to inform you that ${offer.businessName} has been approved for funding with ${company}.

Here are the details of your offer:
------------------------------------------
Approved Amount: ${formatCurrency(offer.amount)}
Total Payback: ${formatCurrency(offer.totalPayback)}
Payment: ${formatCurrency(offer.payment)} (${freqLabel})
${aprLine}
------------------------------------------

You can review and accept your offer at the link below:
${link}

Please let me know if you have any questions.

Best regards,

${offer.repName || 'Your Funding Specialist'}
${offer.repPhone || ''}
${offer.repEmail || ''}
`);

      // Construct mailto link
      const mailtoLink = `mailto:${offer.email || ''}?subject=${subject}&body=${body}`;
      
      // Open default mail client
      window.location.href = mailtoLink;
    }

    function copyOfferText() {
      const offer = offers.find(o => o.id === selectedOfferId);
      if (!offer) return;
      
      const company = offer.companyName || 'TrustBureau.ai';
      const freqLabel = offer.frequency.charAt(0).toUpperCase() + offer.frequency.slice(1);
      
      // Conditionally include APR in text based on offer setting
      const aprLine = offer.showApr ? `ðŸ“ˆ Est. APR: ${offer.apr}%` : '';
      
      const text = `${company} Funding Offer for ${offer.businessName}

âœ… Approved Amount: ${formatCurrency(offer.amount)}
ðŸ“Š Total Payback: ${formatCurrency(offer.totalPayback)}
ðŸ’° ${freqLabel} Payment: ${formatCurrency(offer.payment)}
${aprLine}

View your offer: ${generateOfferLink(offer)}`;
      
      copyToClipboard(text);
    }

    function confirmDeleteOffer() {
        if (!selectedOfferId) return;
        document.getElementById('confirmModal').classList.remove('hidden');
    }

    function closeConfirmModal() {
        document.getElementById('confirmModal').classList.add('hidden');
    }

    function executeDelete() {
        if (!selectedOfferId) return;
        
        offers = offers.filter(o => o.id !== selectedOfferId);
        saveOffers();
        refreshView();
        
        closeConfirmModal();
        closeOfferDetailModal();
        showToast('Offer deleted');
    }

    // ====================
    // MODALS
    // ====================
    function openOfferDetail(id) {
      selectedOfferId = id;
      const offer = offers.find(o => o.id === id);
      if (!offer) return;
      
      const statusClass = offer.status === 'accepted' ? 'badge-accepted' : 
                         offer.status === 'expired' ? 'badge-expired' : 'badge-pending';
      const statusLabel = offer.status.charAt(0).toUpperCase() + offer.status.slice(1);
      
      const aprBlock = offer.showApr ? `
          <div class="p-3 rounded-lg text-center" style="background: var(--bg-card-inner);">
            <span class="text-muted text-xs block">Est. APR</span>
            <span class="font-medium text-hero">${offer.apr}%</span>
          </div>` : '';

      const content = `
        <div class="text-center mb-6">
          <span class="badge ${statusClass} mb-3">${statusLabel}</span>
          <h2 class="text-xl font-medium text-primary">${offer.businessName}</h2>
          <p class="text-sm text-muted">${offer.contactName || ''} ${offer.email ? 'â€¢ ' + offer.email : ''}</p>
        </div>
        
        <div class="text-center p-4 rounded-xl mb-6" style="background: var(--bg-card-inner);">
          <span class="text-[10px] text-muted uppercase tracking-wider">Funding Amount</span>
          <div class="text-3xl font-medium text-hero">${formatCurrency(offer.amount)}</div>
        </div>
        
        <div class="grid ${offer.showApr ? 'grid-cols-2' : 'grid-cols-3'} gap-4 text-sm">
          <div class="p-3 rounded-lg text-center" style="background: var(--bg-card-inner);">
            <span class="text-muted text-xs block">Factor Rate</span>
            <span class="font-medium text-primary">${offer.factor}x</span>
          </div>
          <div class="p-3 rounded-lg text-center" style="background: var(--bg-card-inner);">
            <span class="text-muted text-xs block">Total Payback</span>
            <span class="font-medium text-primary">${formatCurrency(offer.totalPayback)}</span>
          </div>
          <div class="p-3 rounded-lg text-center" style="background: var(--bg-card-inner);">
            <span class="text-muted text-xs block">${offer.frequency.charAt(0).toUpperCase() + offer.frequency.slice(1)} Payment</span>
            <span class="font-medium text-primary">${formatCurrency(offer.payment)}</span>
          </div>
          ${aprBlock}
        </div>

        <div class="mt-4 p-3 rounded-lg text-center border border-primary">
             <span class="text-xs text-muted block uppercase">Term Length</span>
             <span class="font-medium text-primary">${offer.termOverride ? offer.termOverride : (offer.termMonths + ' months')}</span>
        </div>
        
        <div class="mt-6 pt-4 border-t border-primary text-xs text-muted text-center">
          Created: ${new Date(offer.createdAt).toLocaleString()}<br>
          ${offer.expiresAt ? 'Expires: ' + new Date(offer.expiresAt).toLocaleString() : ''}
          ${offer.acceptedAt ? '<br><span class="text-green-500">Accepted: ' + new Date(offer.acceptedAt).toLocaleString() + '</span>' : ''}
        </div>
      `;
      
      document.getElementById('offerDetailContent').innerHTML = content;
      
      // Generate QR Code
      const qrContainer = document.getElementById('offerQrCode');
      qrContainer.innerHTML = '';
      const link = generateOfferLink(offer);
      new QRCode(qrContainer, {
        text: link,
        width: 150,
        height: 150,
        colorDark: "#0f172a",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.M
      });
      
      document.getElementById('offerDetailModal').classList.remove('hidden');
    }

    function closeOfferDetailModal() {
      document.getElementById('offerDetailModal').classList.add('hidden');
      selectedOfferId = null;
    }

    // ====================
    // CLIENT VIEW
    // ====================
    function showClientView(offerId) {
      const offer = offers.find(o => o.id === offerId);
      if (!offer) {
        document.getElementById('dashboardContainer').classList.remove('hidden');
        document.getElementById('clientContainer').classList.add('hidden');
        return;
      }

      // Mark as viewed
      if (!offer.viewedAt) {
        offer.viewedAt = Date.now();
        saveOffers();
      }

      // Apply offer's theme
      if (offer.accent) {
        setAccent(offer.accent, false);
      }

      document.getElementById('dashboardContainer').classList.add('hidden');
      document.getElementById('clientContainer').classList.remove('hidden');

      // Logo & branding
      if (offer.logoUrl) {
        document.getElementById('clientLogo').src = offer.logoUrl;
        document.getElementById('clientLogo').classList.remove('hidden');
        document.getElementById('clientLogoPlaceholder').classList.add('hidden');
      } else {
        document.getElementById('clientLogo').classList.add('hidden');
        document.getElementById('clientLogoPlaceholder').classList.remove('hidden');
      }
      
      if (offer.companyName) {
        document.getElementById('clientCompanyName').textContent = offer.companyName;
        document.getElementById('clientPoweredBy').classList.remove('hidden');
      } else {
        document.getElementById('clientCompanyName').textContent = 'TrustBureau.ai';
        document.getElementById('clientPoweredBy').classList.add('hidden');
      }

      // Business name
      if (offer.businessName) {
        document.getElementById('clientBusinessNameDisplay').textContent = offer.businessName;
        document.getElementById('clientBusinessNameDisplay').classList.remove('hidden');
      } else {
        document.getElementById('clientBusinessNameDisplay').classList.add('hidden');
      }

      // Offer details
      document.getElementById('clientAmount').textContent = formatCurrency(offer.amount);
      document.getElementById('clientPaybackChart').textContent = formatCurrency(offer.totalPayback);
      
      // APR Section for client view
      const aprSection = document.getElementById('clientAprSection');
      if (offer.showApr) {
          aprSection.classList.remove('hidden');
          document.getElementById('clientApr').textContent = offer.apr + '%';
      } else {
          aprSection.classList.add('hidden');
      }

      // Use override if exists
      document.getElementById('clientTermLength').textContent = offer.termOverride ? offer.termOverride : ((offer.termMonths || '6') + ' months');

      document.getElementById('clientTermPayments').textContent = offer.term + ' payments';
      document.getElementById('clientFactor').textContent = offer.factor + 'x';
      document.getElementById('clientCost').textContent = formatCurrency(offer.totalCost);
      
      const paymentLabel = offer.frequency === 'weekly' ? 'Est. Weekly Payment' : 
                           offer.frequency === 'monthly' ? 'Est. Monthly Payment' : 'Est. Daily Payment';
      document.getElementById('clientPaymentLabel').textContent = paymentLabel;
      document.getElementById('clientPayment').textContent = formatCurrency(offer.payment);

      // Fee row
      if (offer.fee > 0) {
        document.getElementById('clientFeeRow').classList.remove('hidden');
        document.getElementById('clientFeeAmount').textContent = formatCurrency(offer.feeAmount);
        document.getElementById('clientNet').textContent = formatCurrency(offer.netProceeds);
      } else {
        document.getElementById('clientFeeRow').classList.add('hidden');
      }

      // Donut chart
      const principalPct = offer.totalPayback > 0 ? (offer.amount / offer.totalPayback) * 100 : 0;
      document.getElementById('clientCircle').setAttribute('stroke-dasharray', `${principalPct} ${100 - principalPct}`);

      // Rep info
      if (offer.repName || offer.repEmail || offer.repPhone) {
        document.getElementById('clientRepInfo').classList.remove('hidden');
        document.getElementById('clientRepName').textContent = offer.repName || '';
        document.getElementById('clientRepEmail').textContent = offer.repEmail || '';
        document.getElementById('clientRepPhone').textContent = offer.repPhone || '';
      } else {
        document.getElementById('clientRepInfo').classList.add('hidden');
      }

      // Prepay section
      if (offer.prepayDiscount > 0) {
        document.getElementById('clientPrepaySection').classList.remove('hidden');
        document.getElementById('clientPrepayPercent').textContent = offer.prepayDiscount + '% Max';
        
        // Setup prepay date
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('clientPrepayDate').value = today;
        document.getElementById('clientPrepayDate').min = today;
        
        // Calculate end date
        let termDays;
        if (offer.frequency === 'weekly') termDays = offer.term * 7;
        else if (offer.frequency === 'monthly') termDays = offer.term * 30.44;
        else termDays = offer.term * 1.42;
        const endDate = new Date();
        endDate.setDate(endDate.getDate() + Math.ceil(termDays));
        document.getElementById('clientPrepayDate').max = endDate.toISOString().split('T')[0];
        
        calculateClientPrepay(offer);
      } else {
        document.getElementById('clientPrepaySection').classList.add('hidden');
      }

      // Expiration timer
      const now = Date.now();
      const acceptBtn = document.getElementById('clientAcceptBtn');
      const acceptedState = document.getElementById('clientAcceptedState');
      const expiredState = document.getElementById('clientExpiredState');
      const expirationBanner = document.getElementById('clientExpirationBanner');

      acceptBtn.classList.add('hidden');
      acceptedState.classList.add('hidden');
      expiredState.classList.add('hidden');
      expirationBanner.classList.add('hidden');

      if (offer.status === 'accepted') {
        acceptedState.classList.remove('hidden');
      } else if (offer.status === 'expired' || now > offer.expiresAt) {
        expiredState.classList.remove('hidden');
      } else {
        acceptBtn.classList.remove('hidden');
        startClientTimer(offer.expiresAt);
      }

      // Store current offer ID
      window.currentClientOfferId = offerId;
    }

    function startClientTimer(expiresAt) {
      if (clientTimerId) clearInterval(clientTimerId);
      
      const banner = document.getElementById('clientExpirationBanner');
      banner.classList.remove('hidden');
      
      function updateTimer() {
        const now = Date.now();
        const diff = expiresAt - now;
        
        if (diff <= 0) {
          clearInterval(clientTimerId);
          document.getElementById('clientTimerHours').textContent = '00';
          document.getElementById('clientTimerMinutes').textContent = '00';
          document.getElementById('clientTimerSeconds').textContent = '00';
          banner.classList.add('urgent');
          return;
        }
        
        const hours = Math.floor(diff / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diff % (1000 * 60)) / 1000);
        
        document.getElementById('clientTimerHours').textContent = hours.toString().padStart(2, '0');
        document.getElementById('clientTimerMinutes').textContent = minutes.toString().padStart(2, '0');
        document.getElementById('clientTimerSeconds').textContent = seconds.toString().padStart(2, '0');
        
        if (hours < 1) banner.classList.add('urgent');
      }
      
      updateTimer();
      clientTimerId = setInterval(updateTimer, 1000);
    }

    function calculateClientPrepay(offer) {
      const dateInput = document.getElementById('clientPrepayDate');
      if (!dateInput.value) return;
      
      const startDate = new Date();
      startDate.setHours(0, 0, 0, 0);
      
      let termDays;
      if (offer.frequency === 'weekly') termDays = offer.term * 7;
      else if (offer.frequency === 'monthly') termDays = offer.term * 30.44;
      else termDays = offer.term * 1.42;
      
      const endDate = new Date(startDate);
      endDate.setDate(endDate.getDate() + Math.ceil(termDays));
      
      let selectedDate = new Date(dateInput.value);
      selectedDate.setHours(0, 0, 0, 0);
      
      const totalTime = endDate.getTime() - startDate.getTime();
      const remainingTime = endDate.getTime() - selectedDate.getTime();
      let fractionRemaining = totalTime > 0 ? remainingTime / totalTime : 0;
      fractionRemaining = Math.max(0, Math.min(1, fractionRemaining));
      
      const maxSavings = offer.totalPayback * (offer.prepayDiscount / 100);
      const savings = maxSavings * fractionRemaining;
      const newPayoff = offer.totalPayback - savings;
      
      document.getElementById('clientPrepaySavings').textContent = formatCurrency(savings);
      document.getElementById('clientPrepayTotal').textContent = formatCurrency(newPayoff);
    }

    function acceptOffer() {
      const offerId = window.currentClientOfferId;
      const offer = offers.find(o => o.id === offerId);
      if (!offer) return;

      offer.status = 'accepted';
      offer.acceptedAt = Date.now();
      saveOffers();

      fireConfetti();

      document.getElementById('clientAcceptBtn').classList.add('hidden');
      document.getElementById('clientAcceptedState').classList.remove('hidden');
      document.getElementById('clientExpirationBanner').classList.add('hidden');

      showToast('Offer accepted! Your funding specialist will be in touch.');
    }

    // ====================
    // UI UPDATES
    // ====================
    function updateStats() {
      const total = offers.length;
      const pending = offers.filter(o => o.status === 'pending').length;
      const accepted = offers.filter(o => o.status === 'accepted').length;
      const totalValue = offers.filter(o => o.status === 'accepted').reduce((sum, o) => sum + o.amount, 0);
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statAccepted').textContent = accepted;
      document.getElementById('statValue').textContent = formatCurrency(totalValue);
    }

    function renderOffers(container, filter = 'all', limit = null) {
      let filtered = [...offers];
      
      if (filter !== 'all') {
        filtered = filtered.filter(o => o.status === filter);
      }
      
      filtered.sort((a, b) => b.createdAt - a.createdAt);
      
      if (limit) {
        filtered = filtered.slice(0, limit);
      }
      
      if (filtered.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-lg mb-2">No offers yet</p>
            <p class="text-sm">Click "New Offer" to create your first offer.</p>
          </div>
        `;
        return;
      }
      
      const html = filtered.map(offer => {
        const statusClass = offer.status === 'accepted' ? 'badge-accepted' : 
                           offer.status === 'expired' ? 'badge-expired' : 'badge-pending';
        const statusLabel = offer.status.charAt(0).toUpperCase() + offer.status.slice(1);
        const date = new Date(offer.createdAt).toLocaleDateString();
        
        return `
          <div class="offer-card cursor-pointer" onclick="openOfferDetail('${offer.id}')">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="font-medium text-primary">${offer.businessName}</h3>
                <p class="text-sm text-muted">${offer.contactName || 'No contact'}</p>
              </div>
              <span class="badge ${statusClass}">${statusLabel}</span>
            </div>
            <div class="flex items-end justify-between">
              <div>
                <span class="text-2xl font-medium text-hero">${formatCurrency(offer.amount)}</span>
                <span class="text-sm text-muted block mt-1">${offer.frequency} payments</span>
              </div>
              <div class="text-right text-sm">
                <span class="text-muted">${date}</span>
                ${offer.status === 'accepted' ? '<span class="block text-green-500 text-xs mt-1">âœ“ Accepted</span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = currentView === 'dashboard' ? 
        `<div class="space-y-4">${html}</div>` : html;
    }

    function renderClients() {
      const container = document.getElementById('clientsList');
      
      const clients = {};
      offers.forEach(offer => {
        if (!clients[offer.businessName]) {
          clients[offer.businessName] = {
            businessName: offer.businessName,
            contactName: offer.contactName,
            email: offer.email,
            phone: offer.phone,
            offers: []
          };
        }
        clients[offer.businessName].offers.push(offer);
      });
      
      const clientList = Object.values(clients);
      
      if (clientList.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <p class="text-lg mb-2">No clients yet</p>
            <p class="text-sm">Create an offer to add your first client.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = clientList.map(client => {
        const acceptedCount = client.offers.filter(o => o.status === 'accepted').length;
        const totalValue = client.offers.reduce((sum, o) => sum + o.amount, 0);
        
        return `
          <div class="card-bg rounded-xl border border-primary p-5 flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-full flex items-center justify-center font-medium text-lg" style="background: var(--accent-color); color: var(--accent-text-inverted);">
                ${client.businessName.charAt(0).toUpperCase()}
              </div>
              <div>
                <h3 class="font-medium text-primary">${client.businessName}</h3>
                <p class="text-sm text-muted">${client.contactName || client.email || 'No contact info'}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-lg font-medium text-primary">${client.offers.length} offer${client.offers.length > 1 ? 's' : ''}</div>
              <div class="text-sm text-muted">${acceptedCount} accepted â€¢ ${formatCurrency(totalValue)}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ====================
    // VIEW MANAGEMENT
    // ====================
    function switchView(view) {
      currentView = view;
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === view) {
          item.classList.add('active');
        }
      });
      
      const titles = {
        dashboard: ['Dashboard', 'Welcome back! Here\'s your offer activity.'],
        calculator: ['Create New Offer', 'Build and share a funding offer with your client.'],
        offers: ['All Offers', 'Manage and track all your sent offers.'],
        clients: ['Clients', 'View all your clients and their offer history.'],
        settings: ['Settings', 'Configure your profile and preferences.']
      };
      
      document.getElementById('pageTitle').textContent = titles[view][0];
      document.getElementById('pageSubtitle').textContent = titles[view][1];
      
      document.getElementById('dashboardView').classList.toggle('hidden', view !== 'dashboard');
      document.getElementById('calculatorView').classList.toggle('hidden', view !== 'calculator');
      document.getElementById('offersView').classList.toggle('hidden', view !== 'offers');
      document.getElementById('clientsView').classList.toggle('hidden', view !== 'clients');
      document.getElementById('settingsView').classList.toggle('hidden', view !== 'settings');
      
      refreshView();
    }

    function refreshView() {
      updateStats();
      
      if (currentView === 'dashboard') {
        renderOffers(document.getElementById('recentOffersList'), currentFilter, 5);
      } else if (currentView === 'offers') {
        renderOffers(document.getElementById('allOffersList'), currentFilter);
      } else if (currentView === 'clients') {
        renderClients();
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // ====================
    // TOAST
    // ====================
    function showToast(message) {
      const toast = document.getElementById('toast');
      document.getElementById('toastMessage').textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // ====================
    // INITIALIZATION
    // ====================
    function init() {
      // Check for client view
      const params = new URLSearchParams(window.location.search);
      const offerId = params.get('offer');
      
      loadTheme();
      loadSettings();
      loadOffers();

      if (offerId) {
        showClientView(offerId);
        
        // NOTE: The clientTogglePrepay listener is no longer needed as the section is now always visible if applicable
        
        document.getElementById('clientPrepayDate').addEventListener('change', () => {
          const offer = offers.find(o => o.id === window.currentClientOfferId);
          if (offer) calculateClientPrepay(offer);
        });
        
        return;
      }

      refreshView();
      
      // Nav clicks
      document.querySelectorAll('.nav-item[data-view]').forEach(item => {
        item.addEventListener('click', () => switchView(item.dataset.view));
      });
      
      // Filter toggles
      document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          currentFilter = btn.dataset.filter;
          document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          refreshView();
        });
      });
      
      // Frequency toggles
      document.querySelectorAll('[data-freq]').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedFrequency = btn.dataset.freq;
          updateFrequencyButtons();
          updateCalculatorPreview();
        });
      });
      
      // Calculator sliders
      const amountSlider = document.getElementById('calcAmountSlider');
      const amountInput = document.getElementById('calcAmount');
      amountSlider.addEventListener('input', () => {
        amountInput.value = formatNumber(parseInt(amountSlider.value));
        updateSliderFill(amountSlider);
        updateCalculatorPreview();
      });
      amountInput.addEventListener('input', () => {
        const val = parseNumber(amountInput.value);
        if (val >= 5000 && val <= 1000000) amountSlider.value = val;
        updateSliderFill(amountSlider);
        updateCalculatorPreview();
      });
      
      const factorSlider = document.getElementById('calcFactorSlider');
      const factorInput = document.getElementById('calcFactor');
      factorSlider.addEventListener('input', () => {
        factorInput.value = parseFloat(factorSlider.value).toFixed(2);
        updateSliderFill(factorSlider);
        updateCalculatorPreview();
      });
      factorInput.addEventListener('input', () => {
        const val = parseFloat(factorInput.value);
        if (val >= 1.05 && val <= 1.7) factorSlider.value = val;
        updateSliderFill(factorSlider);
        updateCalculatorPreview();
      });
      
      const termSlider = document.getElementById('calcTermSlider');
      const termInput = document.getElementById('calcTerm');
      termSlider.addEventListener('input', () => {
        termInput.value = termSlider.value;
        updateSliderFill(termSlider);
        updateCalculatorPreview();
      });
      termInput.addEventListener('input', () => {
        const val = parseInt(termInput.value);
        if (val >= 3 && val <= 528) termSlider.value = val;
        updateSliderFill(termSlider);
        updateCalculatorPreview();
      });

      // Term Override Listener
      document.getElementById('calcTermOverride').addEventListener('input', updateCalculatorPreview);
      
      document.getElementById('calcFee').addEventListener('input', () => {
        const val = parseFloat(document.getElementById('calcFee').value) || 0;
        document.getElementById('calcFeeSlider').value = val;
        updateSliderFill(document.getElementById('calcFeeSlider'));
        updateCalculatorPreview();
      });
      document.getElementById('calcFeeSlider').addEventListener('input', () => {
        const val = parseFloat(document.getElementById('calcFeeSlider').value) || 0;
        document.getElementById('calcFee').value = val;
        updateSliderFill(document.getElementById('calcFeeSlider'));
        updateCalculatorPreview();
      });

      document.getElementById('calcBusinessName').addEventListener('input', updateCalculatorPreview);
      
      // Prepay Logic
      document.getElementById('calcPrepay').addEventListener('input', () => {
         const val = parseFloat(document.getElementById('calcPrepay').value) || 0;
         document.getElementById('calcPrepaySlider').value = val;
         updateSliderFill(document.getElementById('calcPrepaySlider'));
      });
      document.getElementById('calcPrepaySlider').addEventListener('input', () => {
         const val = parseFloat(document.getElementById('calcPrepaySlider').value) || 0;
         document.getElementById('calcPrepay').value = val;
         updateSliderFill(document.getElementById('calcPrepaySlider'));
      });

      // Initialize calculator preview
      updateSliderFills();
      updateCalculatorPreview();
      
      // Apply default settings to calculator
      document.getElementById('calcFactor').value = settings.defaultFactor;
      document.getElementById('calcFactorSlider').value = settings.defaultFactor;
      document.getElementById('calcTerm').value = settings.defaultTerm;
      document.getElementById('calcTermSlider').value = settings.defaultTerm;
      document.getElementById('calcExpiry').value = settings.defaultExpiry;
      updateSliderFills();
      updateCalculatorPreview();
    }

    init();
  </script>
</body>
</html>
