<!DOCTYPE html>
<html lang="en" class="theme-light accent-mint">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>TrustBureau.ai | Offer Dashboard</title>
  
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22><path d=%22M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z%22 fill=%22%2342D197%22/><path d=%22M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z%22 fill=%22white%22/></svg>">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    body, input, button, select, textarea, * { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif !important; }
    body { font-size: 14px; -webkit-font-smoothing: antialiased; }
    
    input[type=number]::-webkit-inner-spin-button,
    input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
    input[type=number] { -moz-appearance: textfield; }

    /* Theme Variables */
    html.theme-light { 
      --bg-body: #f8fafc; 
      --bg-card: #ffffff; 
      --bg-card-inner: #f8fafc; 
      --bg-input: #ffffff; 
      --bg-sidebar: #ffffff;
      --border-primary: #e2e8f0; 
      --text-primary: #0f172a; 
      --text-secondary: #475569; 
      --text-muted: #64748b; 
      --text-success: #16a34a;
      --text-warning: #d97706;
      --text-danger: #dc2626;
      --shadow-color: rgba(0, 0, 0, 0.05); 
      --bg-slider-track: #e2e8f0; 
    }
    html.theme-dark { 
      --bg-body: #000000; 
      --bg-card: #121212; 
      --bg-card-inner: #18181b; 
      --bg-input: #18181b; 
      --bg-sidebar: #121212;
      --border-primary: #27272a; 
      --text-primary: #f8fafc; 
      --text-secondary: #cbd5e1; 
      --text-muted: #94a3b8; 
      --text-success: #4ade80;
      --text-warning: #fbbf24;
      --text-danger: #f87171;
      --shadow-color: rgba(0, 0, 0, 0.8); 
      --bg-slider-track: #27272a; 
    }

    /* Accent Colors */
    html.accent-mint { --accent-color: #42D197; --accent-color-light: #74eabc; --accent-color-dark: #2d9668; --accent-text-inverted: #ffffff; }
    html.accent-blue { --accent-color: #3b82f6; --accent-color-light: #60a5fa; --accent-color-dark: #2563eb; --accent-text-inverted: #ffffff; }
    html.accent-gold { --accent-color: #D19B2B; --accent-color-light: #e6b650; --accent-color-dark: #a6781c; --accent-text-inverted: #020617; }
    html.accent-purple { --accent-color: #a855f7; --accent-color-light: #c084fc; --accent-color-dark: #9333ea; --accent-text-inverted: #ffffff; }
    html.accent-red { --accent-color: #ef4444; --accent-color-light: #f87171; --accent-color-dark: #dc2626; --accent-text-inverted: #ffffff; }
    html.accent-teal { --accent-color: #14b8a6; --accent-color-light: #2dd4bf; --accent-color-dark: #0d9488; --accent-text-inverted: #ffffff; }
    html.accent-pink { --accent-color: #ec4899; --accent-color-light: #f472b6; --accent-color-dark: #db2777; --accent-text-inverted: #ffffff; }
    html.accent-orange { --accent-color: #f97316; --accent-color-light: #fb923c; --accent-color-dark: #ea580c; --accent-text-inverted: #ffffff; }
    html.accent-indigo { --accent-color: #6366f1; --accent-color-light: #818cf8; --accent-color-dark: #4f46e5; --accent-text-inverted: #ffffff; }
    html.accent-lime { --accent-color: #84cc16; --accent-color-light: #a3e635; --accent-color-dark: #65a30d; --accent-text-inverted: #020617; }
    html.accent-cyan { --accent-color: #06b6d4; --accent-color-light: #22d3ee; --accent-color-dark: #0891b2; --accent-text-inverted: #ffffff; }
    
    /* New Accents */
    html.accent-black { --accent-color: #18181b; --accent-color-light: #3f3f46; --accent-color-dark: #09090b; --accent-text-inverted: #ffffff; }
    html.accent-grey { --accent-color: #64748b; --accent-color-light: #94a3b8; --accent-color-dark: #475569; --accent-text-inverted: #ffffff; }
    html.accent-white { --accent-color: #ffffff; --accent-color-light: #f1f5f9; --accent-color-dark: #cbd5e1; --accent-text-inverted: #0f172a; }
    html.accent-glow { --accent-color: #d946ef; --accent-color-light: #e879f9; --accent-color-dark: #c026d3; --accent-text-inverted: #ffffff; }

    /* Theme-specific overrides for White accent to ensure visibility */
    html.accent-white.theme-light .button-primary { border: 1px solid #e2e8f0; }
    html.accent-white.theme-light .slider { background-color: #e2e8f0; }
    
    /* Dark Mode overrides for Black accent to ensure visibility */
    html.accent-black.theme-dark { --accent-color: #ffffff; --accent-color-light: #e2e8f0; --accent-color-dark: #cbd5e1; --accent-text-inverted: #000000; }

    body { background-color: var(--bg-body); color: var(--text-primary); transition: background-color 0.3s ease; }
    
    .card-bg { background-color: var(--bg-card); border-color: var(--border-primary); }
    .sidebar-bg { background-color: var(--bg-sidebar); border-color: var(--border-primary); }
    .text-primary { color: var(--text-primary); }
    .text-secondary { color: var(--text-secondary); }
    .text-muted { color: var(--text-muted); }
    .text-hero { color: var(--accent-color); }
    .text-success { color: var(--text-success); }
    .border-primary { border-color: var(--border-primary); }
    
    .input-field { 
      background-color: var(--bg-input); 
      border-color: var(--border-primary); 
      color: var(--text-primary); 
      transition: border-color 0.2s, box-shadow 0.2s;
      font-size: 14px; /* Standardized Font Size */
      font-weight: 400;
    }
    .input-field:focus { 
      border-color: var(--accent-color); 
      box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); 
      outline: none; 
    }
    .input-field::placeholder {
        color: var(--text-muted);
        opacity: 0.7;
    }
    
    .button-primary { 
      background-color: var(--accent-color); 
      color: var(--accent-text-inverted); 
      font-weight: 600; 
      border-radius: 10px; 
      padding: 10px 20px; 
      border: none;
      transition: all 0.2s ease; 
      font-size: 13px;
      box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-color) 30%, transparent);
    }
    .button-primary:hover { 
      background-color: var(--accent-color-light); 
      transform: translateY(-1px); 
    }
    .button-primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Dark Mode Button Text Override */
    html.theme-dark .button-primary {
      color: #000000;
    }
    
    .button-secondary {
      background: transparent;
      color: var(--text-secondary);
      font-weight: 600; 
      border-radius: 10px;
      padding: 10px 20px;
      border: 1px solid var(--border-primary);
      transition: all 0.2s ease;
      font-size: 13px;
    }
    .button-secondary:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }
    
    .button-toggle-action {
      background: var(--bg-card-inner);
      color: var(--text-secondary);
      border: 1px solid var(--border-primary);
      border-radius: 10px;
      padding: 10px;
      font-size: 12px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
    }
    .button-toggle-action:hover {
      border-color: var(--accent-color);
      color: var(--accent-color);
    }

    .button-danger {
      background: transparent;
      color: #ef4444;
      font-weight: 600;
      border-radius: 10px;
      padding: 10px 20px;
      border: 1px solid #fecaca;
      transition: all 0.2s ease;
      font-size: 13px;
    }
    .button-danger:hover {
      background: #fef2f2;
      border-color: #ef4444;
    }

    /* Status Badges */
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .badge-pending { background: #fef3c7; color: #92400e; }
    .badge-accepted { background: #d1fae5; color: #065f46; }
    .badge-expired { background: #fee2e2; color: #991b1b; }
    .badge-declined { background: #f1f5f9; color: #475569; }

    /* Tabs */
    .calc-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-primary);
        padding-bottom: 2px;
    }
    .calc-tab {
        padding: 8px 16px;
        border-radius: 8px 8px 0 0;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-secondary);
        background: transparent;
        border: 1px solid transparent;
        cursor: pointer;
        transition: all 0.2s;
        position: relative;
        bottom: -3px;
    }
    .calc-tab.active {
        background: var(--bg-card);
        color: var(--accent-color);
        border: 1px solid var(--border-primary);
        border-bottom-color: var(--bg-card);
    }
    .calc-tab:hover:not(.active) {
        color: var(--text-primary);
    }
    .add-tab-btn {
        padding: 8px 12px;
        font-size: 13px;
        font-weight: 600;
        color: var(--text-muted);
        cursor: pointer;
    }
    .add-tab-btn:hover { color: var(--accent-color); }

    /* Sidebar Nav */
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.15s ease;
      cursor: pointer;
    }
    .nav-item:hover { background: var(--bg-card-inner); color: var(--text-primary); }
    .nav-item.active { 
        background: color-mix(in srgb, var(--accent-color) 15%, transparent); 
        color: var(--accent-color-dark); 
        font-weight: 600;
    }
    html.theme-dark .nav-item.active { color: var(--accent-color); }
    .nav-item.active svg { stroke: currentColor; }

    /* Offer Card */
    .offer-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.2s ease;
    }
    .offer-card:hover {
      box-shadow: 0 8px 25px var(--shadow-color);
      transform: translateY(-2px);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(4px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 20px;
    }
    .modal-content {
      background: var(--bg-card);
      border-radius: 20px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
    }

    /* Slider */
    input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      background: transparent;
      cursor: pointer;
      height: 6px;
      border-radius: 999px;
    }
    input[type=range]:focus { outline: none; }
    input[type=range]::-webkit-slider-runnable-track {
      width: 100%;
      height: 6px;
      background: transparent;
      border-radius: 999px;
    }
    input[type=range]::-webkit-slider-thumb {
      height: 20px;
      width: 20px;
      border-radius: 50%;
      background: var(--accent-color);
      cursor: pointer;
      -webkit-appearance: none;
      margin-top: -7px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
      border: 3px solid var(--bg-card);
      transition: transform 0.15s ease;
    }
    input[type=range]:hover::-webkit-slider-thumb {
      transform: scale(1.1);
    }

    /* Stats Card */
    .stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-primary);
      border-radius: 16px;
      padding: 20px;
    }
    .stat-value {
      font-size: 32px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }

    /* Toggle */
    .toggle-group {
      display: inline-flex;
      background: var(--bg-card-inner);
      border: 1px solid var(--border-primary);
      border-radius: 12px;
      padding: 4px;
      gap: 4px;
    }
    .toggle-btn {
      padding: 10px 20px;
      border-radius: 10px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .toggle-btn:hover:not(.active) {
      background: color-mix(in srgb, var(--accent-color) 10%, transparent);
    }
    .toggle-btn.active {
      background: var(--accent-color);
      color: var(--accent-text-inverted);
      box-shadow: 0 2px 8px color-mix(in srgb, var(--accent-color) 40%, transparent);
      font-weight: 600;
    }

    /* Dark Mode Overrides */
    html.theme-dark .button-primary,
    html.theme-dark .toggle-btn.active {
      color: #000000;
    }

    /* Toggle Switch */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
    }
    .switch input { 
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--border-primary);
      transition: .4s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: var(--accent-color);
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }
    .empty-state svg {
      width: 80px;
      height: 80px;
      margin: 0 auto 20px;
      opacity: 0.3;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--text-primary);
      color: var(--bg-card);
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 500;
      box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      z-index: 200;
      display: flex;
      align-items: center;
      gap: 10px;
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s ease;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }

    /* QR Code Container */
    .qr-container {
      display: flex;
      justify-content: center;
      padding: 20px;
      background: white;
      border-radius: 12px;
      margin: 16px 0;
    }

    /* Donut Chart */
    .chart-wrapper {
      position: relative;
      width: 140px;
      height: 140px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .chart-text {
      position: absolute;
      text-align: center;
      z-index: 10;
    }
    .circular-chart {
      display: block;
      margin: 0 auto;
      max-width: 100%;
      max-height: 100%;
    }
    .circle-bg {
      fill: none;
      stroke: var(--bg-slider-track);
      stroke-width: 2.5;
    }
    .circle {
      fill: none;
      stroke-width: 2.5;
      stroke-linecap: round;
      stroke: var(--accent-color);
      transition: stroke-dasharray 0.6s ease-out;
    }

    /* Tooltip */
    .tooltip-container { position: relative; display: inline-block; cursor: help; }
    .tooltip-text { 
      visibility: hidden; width: 200px; background-color: var(--text-primary); color: var(--bg-card); 
      text-align: center; border-radius: 8px; padding: 10px; position: absolute; z-index: 50; 
      bottom: 125%; left: 50%; margin-left: -100px; opacity: 0; transition: opacity 0.3s; 
      font-size: 11px; font-weight: normal; box-shadow: 0 4px 12px rgba(0,0,0,0.15); line-height: 1.4; 
    }
    .tooltip-text::after { 
      content: ""; position: absolute; top: 100%; left: 50%; margin-left: -6px; 
      border-width: 6px; border-style: solid; border-color: var(--text-primary) transparent transparent transparent; 
    }
    .tooltip-container:hover .tooltip-text { visibility: visible; opacity: 1; }

    /* Settings Panel */
    .settings-panel {
      padding: 16px;
      background: var(--bg-card-inner);
      border-radius: 12px;
      margin-bottom: 16px;
    }

    /* Color Swatch */
    .color-swatch { 
      width: 32px; height: 32px; border-radius: 50%; cursor: pointer; 
      border: 3px solid transparent; transition: all 0.15s ease; 
    }
    .color-swatch:hover { transform: scale(1.15); }
    .color-swatch.selected { border-color: var(--text-primary); box-shadow: 0 0 0 3px var(--bg-card); }

    /* Client View */
    .client-view {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    .client-card {
      background: var(--bg-card);
      border-radius: 24px;
      width: 100%;
      box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15);
      overflow: hidden;
      border: 4px solid var(--accent-color);
      transition: transform 0.2s;
    }
    /* Grid for multiple options */
    .client-grid {
        display: grid;
        gap: 20px;
        width: 100%;
        max-width: 1100px;
    }
    .client-grid-1 { grid-template-columns: minmax(0, 500px); justify-content: center; }
    .client-grid-2 { grid-template-columns: repeat(2, 1fr); }
    .client-grid-3 { grid-template-columns: repeat(3, 1fr); }
    
    @media (max-width: 1024px) {
        .client-grid-2, .client-grid-3 { grid-template-columns: 1fr; max-width: 500px; }
    }

    /* Confetti Canvas */
    #confettiCanvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 9999; }

    /* Expiration Banner */
    .expiration-banner {
      background: linear-gradient(135deg, color-mix(in srgb, var(--accent-color) 15%, transparent), color-mix(in srgb, var(--accent-color) 5%, transparent));
      border: 1px solid color-mix(in srgb, var(--accent-color) 30%, transparent);
      border-radius: 12px;
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    .expiration-banner.urgent {
      background: linear-gradient(135deg, color-mix(in srgb, var(--text-danger) 15%, transparent), color-mix(in srgb, var(--text-danger) 5%, transparent));
      border-color: var(--text-danger);
    }
    .timer-digit {
      background: var(--bg-card);
      border-radius: 6px;
      padding: 6px 10px;
      font-weight: 500;
      font-size: 16px;
      min-width: 40px;
      text-align: center;
      box-shadow: 0 2px 4px var(--shadow-color);
    }

    /* Simple no-select helper (for use if needed) */
    .no-select {
      -webkit-user-select: none;
      -moz-user-select: none;
      user-select: none;
    }

    /* Mobile Sidebar */
    @media (max-width: 768px) {
      .sidebar { transform: translateX(-100%); position: fixed; z-index: 60; }
      .sidebar.open { transform: translateX(0); }
      .main-content { margin-left: 0 !important; }
      .mobile-header { display: flex !important; }
    }
    .mobile-header { display: none; }
  </style>
</head>
<body class="min-h-screen">

  <canvas id="confettiCanvas"></canvas>

  <!-- DASHBOARD VIEW -->
  <div id="dashboardContainer">
    <div class="flex min-h-screen">
      
      <!-- SIDEBAR -->
      <aside id="sidebar" class="sidebar w-64 sidebar-bg border-r border-primary flex flex-col fixed h-full z-50">
        <div class="p-6 border-b border-primary">
          <div class="flex items-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-hero" viewBox="0 0 24 24" fill="currentColor">
              <path fill-rule="evenodd" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" clip-rule="evenodd" />
            </svg>
            <div>
              <div class="font-medium text-primary">TrustBureau.ai</div>
              <div class="text-[10px] text-muted uppercase tracking-wider">Offer Portal</div>
            </div>
          </div>
        </div>

        <nav class="flex-1 p-4 space-y-1">
          <div class="nav-item active" data-view="dashboard">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
            </svg>
            Dashboard
          </div>
          <div class="nav-item" data-view="calculator">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" />
            </svg>
            New Offer
          </div>
          <div class="nav-item" data-view="offers">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            All Offers
          </div>
          <div class="nav-item" data-view="accepted">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Accepted
          </div>
          <div class="nav-item" data-view="declined">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Declined
          </div>
          <div class="nav-item" data-view="clients">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Clients
          </div>
          <div class="nav-item" data-view="settings">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            Settings
          </div>
        </nav>

        <div class="p-4 border-t border-primary">
          <div class="nav-item" onclick="toggleTheme()" role="button" tabindex="0">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
            </svg>
            <span id="themeLabel">Dark Mode</span>
          </div>
          <div class="text-[10px] text-muted mt-4 px-2">
            Rep: <span id="repNameSidebar" class="text-secondary">Not Set</span>
          </div>
        </div>
      </aside>

      <!-- MAIN CONTENT -->
      <main class="main-content flex-1 ml-64 p-8">
        
        <!-- Mobile Header -->
        <div class="mobile-header items-center justify-between mb-6 p-4 card-bg rounded-xl border border-primary">
          <button type="button" onclick="toggleSidebar()" class="p-2" aria-label="Toggle navigation">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
            </svg>
          </button>
          <span class="font-medium text-primary">TrustBureau.ai</span>
          <div class="w-8"></div>
        </div>

        <!-- HEADER -->
        <header class="flex items-center justify-between mb-8">
          <div>
            <h1 id="pageTitle" class="text-2xl font-medium text-primary">Dashboard</h1>
            <p id="pageSubtitle" class="text-sm text-muted mt-1">Welcome back! Here's your offer activity.</p>
          </div>
          <button type="button" onclick="switchView('calculator')" class="button-primary flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
            </svg>
            New Offer
          </button>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="dashboardView">
          <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="stat-card">
              <div class="stat-label mb-2">Total Offers</div>
              <div id="statTotal" class="stat-value">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Pending</div>
              <div id="statPending" class="stat-value text-yellow-500">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Accepted</div>
              <div id="statAccepted" class="stat-value text-green-500">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label mb-2">Total Value</div>
              <div id="statValue" class="stat-value text-hero">$0</div>
            </div>
          </div>

          <div class="card-bg rounded-2xl border border-primary">
            <div class="p-5 border-b border-primary flex items-center justify-between">
              <h2 class="font-medium text-primary">Recent Offers</h2>
              <div class="toggle-group" role="radiogroup" aria-label="Filter offers by status">
                <button type="button" class="toggle-btn active" data-filter="all">All</button>
                <button type="button" class="toggle-btn" data-filter="pending">Pending</button>
                <button type="button" class="toggle-btn" data-filter="accepted">Accepted</button>
              </div>
            </div>
            <div id="recentOffersList" class="p-5"></div>
          </div>
        </div>

        <!-- CALCULATOR VIEW -->
        <div id="calculatorView" class="hidden">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            
            <!-- Calculator Inputs -->
            <div class="space-y-6">
              
              <!-- Client Info Card -->
              <div class="card-bg rounded-2xl border border-primary p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-xs font-medium text-secondary uppercase tracking-wider">Client Information</h3>
                    <!-- FIX: Standardized button style to match 'button-secondary' look (Outline, Transparent) -->
                    <button type="button" id="btnToggleContact" onclick="toggleContactInfo()" class="flex items-center gap-2 px-3 py-1.5 rounded-lg text-xs font-medium border border-primary text-secondary hover:border-[var(--accent-color)] hover:text-[var(--accent-color)] bg-transparent transition-all">
                        <span id="lblContactAction">Add Details</span>
                        <svg id="iconContactChevron" xmlns="http://www.w3.org/2000/svg" class="h-3.5 w-3.5 transition-transform duration-200" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>
                </div>
                <div class="space-y-4">
                  <div>
                    <input id="calcBusinessName" type="text" class="w-full p-2.5 border rounded-lg input-field text-sm" placeholder="Business Name (e.g. Acme Holdings)" />
                  </div>
                  
                  <div id="extraContactInfo" class="hidden space-y-4 pt-2 border-t border-primary transition-all">
                      <div class="grid grid-cols-2 gap-4">
                        <input id="calcContactName" type="text" class="w-full p-2.5 border rounded-lg input-field text-sm" placeholder="Contact Name" />
                        <input id="calcEmail" type="email" class="w-full p-2.5 border rounded-lg input-field text-sm" placeholder="Email Address" />
                      </div>
                  </div>
                </div>
              </div>

              <!-- Terms Card -->
              <div class="card-bg rounded-2xl border border-primary p-6">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-xs font-medium text-secondary uppercase tracking-wider">Funding Terms</h3>
                </div>

                <!-- Tabs -->
                <div class="calc-tabs">
                    <button id="tab-btn-0" class="calc-tab active" onclick="switchCalcTab(0)">Option 1</button>
                    <button id="tab-btn-1" class="calc-tab hidden" onclick="switchCalcTab(1)">Option 2</button>
                    <button id="tab-btn-2" class="calc-tab hidden" onclick="switchCalcTab(2)">Option 3</button>
                    <button id="add-tab-btn" class="add-tab-btn" onclick="addCalcOption()">+ Add</button>
                </div>
                
                <div class="space-y-6">
                  
                  <!-- Amount -->
                  <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="text-xs font-medium text-secondary">Funding Amount</label>
                        <button type="button" id="remove-option-btn" onclick="removeCalcOption()" class="text-xs text-red-500 hidden font-medium">Remove Option</button>
                    </div>
                    <div class="flex items-center gap-3 mb-2">
                        <div class="relative w-full">
                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-muted font-medium">$</span>
                            <input id="calcAmount" type="text" class="w-full p-2.5 pl-7 border rounded-lg input-field font-medium text-sm" value="50,000" />
                        </div>
                    </div>
                    <input id="calcAmountSlider" type="range" min="5000" max="1000000" step="1000" value="50000" class="w-full accent-[var(--accent-color)]" />
                  </div>

                  <!-- Factor & Term Grid -->
                  <div class="grid grid-cols-2 gap-6">
                    <!-- Factor -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-medium text-secondary">Factor Rate</label>
                        </div>
                        <div class="relative mb-2">
                            <input id="calcFactor" type="number" step="0.01" class="w-full p-2.5 border rounded-lg input-field font-medium text-sm" value="1.25" />
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-muted text-xs font-medium">x</span>
                        </div>
                        <input id="calcFactorSlider" type="range" min="1.05" max="1.7" step="0.01" value="1.25" class="w-full" />
                    </div>
                    
                    <!-- Term -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                            <label class="text-xs font-medium text-secondary">Term</label>
                        </div>
                        <div class="relative mb-2">
                            <input id="calcTerm" type="number" class="w-full p-2.5 border rounded-lg input-field font-medium text-sm" value="130" />
                            <span class="absolute right-3 top-1/2 -translate-y-1/2 text-muted text-xs font-medium">Pmts</span>
                        </div>
                        <input id="calcTermSlider" type="range" min="3" max="528" step="1" value="130" class="w-full" />
                    </div>
                  </div>

                  <!-- Frequency -->
                  <div>
                    <label class="block text-xs font-medium text-secondary mb-2">Payment Frequency</label>
                    <div class="toggle-group w-full flex" role="radiogroup">
                      <button type="button" class="toggle-btn active flex-1 py-2 text-xs" data-freq="daily" onclick="setFrequency('daily')">Daily</button>
                      <button type="button" class="toggle-btn flex-1 py-2 text-xs" data-freq="weekly" onclick="setFrequency('weekly')">Weekly</button>
                      <button type="button" class="toggle-btn flex-1 py-2 text-xs" data-freq="monthly" onclick="setFrequency('monthly')">Monthly</button>
                    </div>
                  </div>

                  <div class="border-t border-primary my-2"></div>

                  <!-- Section 3: Adjustments -->
                  <div>
                    <div class="pl-3 border-l border-primary">
                      
                      <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                          
                          <!-- Origination Fee -->
                          <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)]">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-medium text-primary">Origination Fee</span>
                                <label class="switch scale-75 origin-right">
                                  <input id="toggleFee" type="checkbox" onchange="toggleFeeSection(this.checked)">
                                  <span class="slider"></span>
                                </label>
                            </div>
                            <div id="contentFee" class="hidden mt-2 pt-2 border-t border-primary/50">
                                <div class="flex items-center gap-2 mb-2">
                                    <input id="calcFee" type="number" step="0.5" min="0" max="10" class="w-20 p-1 bg-transparent border-b border-primary focus:border-accent-color outline-none font-medium text-sm text-primary" value="0" />
                                    <span class="text-xs text-muted font-medium">%</span>
                                </div>
                                <input id="calcFeeSlider" type="range" min="0" max="10" step="0.5" value="0" class="w-full h-1" />
                            </div>
                          </div>

                          <!-- Prepay Discount -->
                          <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)]">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-medium text-primary">Prepay Discount</span>
                                <label class="switch scale-75 origin-right">
                                  <input id="togglePrepay" type="checkbox" onchange="togglePrepaySection(this.checked)">
                                  <span class="slider"></span>
                                </label>
                            </div>
                            <div id="contentPrepay" class="hidden mt-2 pt-2 border-t border-primary/50">
                                <div class="flex items-center gap-2 mb-2">
                                    <input id="calcPrepay" type="number" step="1" min="0" max="50" class="w-20 p-1 bg-transparent border-b border-primary focus:border-accent-color outline-none font-medium text-sm text-primary" value="0" />
                                    <span class="text-xs text-muted font-medium">%</span>
                                </div>
                                <input id="calcPrepaySlider" type="range" min="0" max="50" step="1" value="0" class="w-full h-1" />
                            </div>
                          </div>

                          <!-- Term Override -->
                          <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)]">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-medium text-primary">Custom Term Label</span>
                                <label class="switch scale-75 origin-right">
                                  <input id="toggleOverride" type="checkbox" onchange="toggleOverrideSection(this.checked)">
                                  <span class="slider"></span>
                                </label>
                            </div>
                            <div id="contentOverride" class="hidden mt-2 pt-2 border-t border-primary/50">
                                <input id="calcTermOverride" type="text" class="w-full p-1.5 border rounded-md input-field bg-[var(--bg-card)] text-xs text-primary" placeholder="e.g. 6 Months" />
                            </div>
                          </div>

                          <!-- Expiration Date -->
                          <div class="bg-[var(--bg-card-inner)] rounded-lg p-2.5 border border-primary transition-all hover:border-[var(--accent-color)]">
                            <div class="flex items-center justify-between">
                                <span class="text-xs font-medium text-primary">Set Expiration</span>
                                <label class="switch scale-75 origin-right">
                                  <input id="toggleExpiry" type="checkbox" onchange="toggleExpirySection(this.checked)">
                                  <span class="slider"></span>
                                </label>
                            </div>
                            <div id="contentExpiry" class="hidden mt-2 pt-2 border-t border-primary/50">
                                <input id="calcExpiryDate" type="date" class="w-full p-1.5 border rounded-md input-field bg-[var(--bg-card)] text-xs text-primary" />
                            </div>
                          </div>

                      </div>

                    </div>
                  </div>

                </div>
              </div>

              <div class="flex gap-4">
                <button type="button" onclick="resetCalculator()" class="button-secondary flex-1">Reset</button>
                <button type="button" onclick="createOffer()" class="button-primary flex-1">Create & Share Offer</button>
              </div>
            </div>

            <!-- Offer Preview -->
            <div class="space-y-6">
              <div class="card-bg rounded-2xl border-4 border-primary p-6 sticky top-8" style="border-color: var(--accent-color);">
                <div class="text-center pb-4 border-b border-primary mb-4">
                  <h4 class="text-xs font-medium text-secondary uppercase tracking-wider">
                      <span id="previewOptionLabel">Option 1</span> Preview
                  </h4>
                </div>
                
                <div id="previewBusinessName" class="text-center text-sm font-medium text-primary mb-2 hidden"></div>
                
                <div class="text-center py-4">
                  <span class="text-[11px] font-medium text-muted block uppercase tracking-widest">You Get</span>
                  <span id="previewAmount" class="text-5xl font-semibold block my-3 text-hero leading-tight">$50,000</span>
                </div>

                <!-- Donut Chart -->
                <div class="my-5">
                  <div class="chart-wrapper" title="Principal vs Cost">
                    <svg viewBox="0 0 36 36" class="circular-chart">
                      <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                      <path id="previewCircle" class="circle" stroke-dasharray="80, 20" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                    </svg>
                    <div class="chart-text">
                      <span class="text-[10px] font-medium text-muted block uppercase tracking-wider">Payback</span>
                      <span id="previewPaybackChart" class="text-base font-semibold text-primary block">$62,500</span>
                    </div>
                  </div>
                  <div class="flex justify-center gap-4 mt-3 text-[11px] font-medium text-secondary">
                    <div class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-[var(--accent-color)] mr-1.5"></span> Principal</div>
                    <div class="flex items-center"><span class="w-2.5 h-2.5 rounded-full bg-[var(--bg-slider-track)] mr-1.5"></span> Cost</div>
                  </div>
                </div>

                <!-- APR Display -->
                <div id="previewAprContainer" class="p-3 rounded-xl text-center mb-4 hidden" style="background: var(--bg-card-inner);">
                  <span class="text-xs font-medium text-muted uppercase tracking-wider">Estimated APR</span>
                  <span id="previewApr" class="text-2xl font-semibold text-hero block">48%</span>
                </div>

                <!-- Details Grid -->
                <div class="border border-primary rounded-xl overflow-hidden">
                  <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
                    <div class="p-3 text-center">
                      <span class="text-[10px] font-medium text-muted block uppercase">Term Length</span>
                      <span id="previewTermLength" class="text-sm font-medium text-primary">6 months</span>
                    </div>
                    <div class="p-3 text-center">
                      <span class="text-[10px] font-medium text-muted block uppercase">Payments</span>
                      <span id="previewTermPayments" class="text-sm font-medium text-primary">130</span>
                    </div>
                  </div>
                  <div class="grid grid-cols-2 divide-x divide-primary border-b border-primary">
                    <div class="p-3 text-center">
                      <span class="text-[10px] font-medium text-muted block uppercase">Factor Rate</span>
                      <span id="previewFactor" class="text-sm font-medium text-primary">1.25x</span>
                    </div>
                    <div class="p-3 text-center">
                      <span class="text-[10px] font-medium text-muted block uppercase">Total Cost</span>
                      <span id="previewCost" class="text-sm font-medium text-primary">$12,500</span>
                    </div>
                  </div>
                  <div id="previewFeeRow" class="grid grid-cols-2 divide-x divide-primary border-b border-primary hidden">
                    <div class="p-3 text-center">
                      <span class="text-[10px] font-medium text-muted block uppercase">Origination Fee</span>
                      <span id="previewFeeAmount" class="text-sm font-medium text-primary">$0</span>
                    </div>
                    <div class="p-3 text-center">
                      <span class="text-[10px] font-medium text-muted block uppercase">Net Proceeds</span>
                      <span id="previewNet" class="text-sm font-medium text-primary">$50,000</span>
                    </div>
                  </div>
                  <div class="p-4 text-center" style="background: var(--bg-card-inner);">
                    <span id="previewPaymentLabel" class="text-[10px] font-medium text-muted block uppercase">Est. Daily Payment</span>
                    <!-- Updated font-semibold to font-medium here -->
                    <span id="previewPayment" class="text-lg font-medium text-primary">$480.77</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- ALL OFFERS VIEW -->
        <div id="offersView" class="hidden">
          <div id="allOffersList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
        </div>

        <!-- CLIENTS VIEW -->
        <div id="clientsView" class="hidden">
          <div id="clientsList" class="space-y-4"></div>
        </div>

        <!-- SETTINGS VIEW -->
        <div id="settingsView" class="hidden">
          <div class="card-bg rounded-2xl border border-primary p-6 max-w-2xl">
            <h2 class="text-lg font-semibold text-primary mb-6">Settings</h2>
            
            <div class="settings-panel">
              <h3 class="text-xs font-medium text-secondary uppercase tracking-wider mb-4">Rep Information</h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-medium text-secondary mb-1">Your Name</label>
                  <input id="settingsRepName" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="John Smith" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-secondary mb-1">Your Email</label>
                  <input id="settingsRepEmail" type="email" class="w-full p-3 border rounded-xl input-field" placeholder="john@company.com" />
                </div>
              </div>
              <div class="grid grid-cols-2 gap-4 mt-4">
                <div>
                  <label class="block text-xs font-medium text-secondary mb-1">Company Name</label>
                  <input id="settingsCompanyName" type="text" class="w-full p-3 border rounded-xl input-field" placeholder="Trust Capital Funding" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-secondary mb-1">Phone Number</label>
                  <input id="settingsRepPhone" type="tel" class="w-full p-3 border rounded-xl input-field" placeholder="(555) 123-4567" />
                </div>
              </div>
              <div class="mt-4">
                <label class="block text-xs font-medium text-secondary mb-1">Company Logo URL</label>
                <input id="settingsLogoUrl" type="url" class="w-full p-3 border rounded-xl input-field" placeholder="https://example.com/logo.png" />
              </div>
            </div>

            <div class="settings-panel">
              <h3 class="text-xs font-medium text-secondary uppercase tracking-wider mb-4">Appearance</h3>
              <div class="flex gap-3 mb-4 flex-wrap">
                <div onclick="setAccent('mint')" class="color-swatch" style="background-color: #42D197;" title="Mint"></div>
                <div onclick="setAccent('blue')" class="color-swatch" style="background-color: #3b82f6;" title="Blue"></div>
                <div onclick="setAccent('gold')" class="color-swatch" style="background-color: #D19B2B;" title="Gold"></div>
                <div onclick="setAccent('purple')" class="color-swatch" style="background-color: #a855f7;" title="Purple"></div>
                <div onclick="setAccent('red')" class="color-swatch" style="background-color: #ef4444;" title="Red"></div>
                <div onclick="setAccent('teal')" class="color-swatch" style="background-color: #14b8a6;" title="Teal"></div>
                <div onclick="setAccent('pink')" class="color-swatch" style="background-color: #ec4899;" title="Pink"></div>
                <div onclick="setAccent('orange')" class="color-swatch" style="background-color: #f97316;" title="Orange"></div>
                <div onclick="setAccent('indigo')" class="color-swatch" style="background-color: #6366f1;" title="Indigo"></div>
                <div onclick="setAccent('lime')" class="color-swatch" style="background-color: #84cc16;" title="Lime"></div>
                <div onclick="setAccent('cyan')" class="color-swatch" style="background-color: #06b6d4;" title="Cyan"></div>
                <!-- New Colors -->
                <div onclick="setAccent('black')" class="color-swatch" style="background-color: #18181b;" title="Black"></div>
                <div onclick="setAccent('grey')" class="color-swatch" style="background-color: #64748b;" title="Grey"></div>
                <div onclick="setAccent('white')" class="color-swatch" style="background-color: #ffffff; border: 1px solid #e2e8f0;" title="White"></div>
                <div onclick="setAccent('glow')" class="color-swatch" style="background: linear-gradient(135deg, #22d3ee, #d946ef);" title="Irridescent Glow"></div>
              </div>
              
              <!-- APR Toggle -->
              <div class="flex items-center justify-between pt-2 border-t border-primary">
                <label class="text-sm font-medium text-primary">Show APR on Offers</label>
                <label class="switch">
                  <input id="settingsShowApr" type="checkbox">
                  <span class="slider"></span>
                </label>
              </div>
            </div>

            <div class="settings-panel">
              <h3 class="text-xs font-medium text-secondary uppercase tracking-wider mb-4">Default Offer Terms</h3>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-xs font-medium text-secondary mb-1">Default Factor</label>
                  <input id="settingsDefaultFactor" type="number" step="0.01" class="w-full p-3 border rounded-xl input-field" value="1.25" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-secondary mb-1">Default Term</label>
                  <input id="settingsDefaultTerm" type="number" class="w-full p-3 border rounded-xl input-field" value="130" />
                </div>
                <div>
                  <label class="block text-xs font-medium text-secondary mb-1">Expiry (Days)</label>
                  <input id="settingsDefaultExpiry" type="number" class="w-full p-3 border rounded-xl input-field" value="14" />
                </div>
              </div>
            </div>

            <button type="button" onclick="saveSettings()" class="button-primary mt-4">Save Settings</button>
          </div>
        </div>

      </main>
    </div>
  </div>

  <!-- CLIENT VIEW (Public Offer View) -->
  <div id="clientContainer" class="client-view hidden">
    <div id="clientWrapper" class="w-full max-w-[900px] flex flex-col items-center px-4 pb-20">
        <!-- Header Info -->
        <div class="text-center mb-6 w-full">
            <div id="clientLogoWrapper" class="flex items-center justify-center mb-3">
              <img id="clientLogo" src="" alt="Logo" class="h-12 w-auto hidden" />
              <svg id="clientLogoPlaceholder" xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 text-hero" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z M10 17l-4-4 1.41-1.41L10 14.17l6.59-6.59L18 9l-8 8z" clip-rule="evenodd" />
              </svg>
            </div>
            <div id="clientCompanyName" class="font-bold text-primary text-2xl">TrustBureau.ai</div>
            <div id="clientBusinessNameDisplay" class="text-lg font-medium text-secondary mt-2 hidden"></div>
            
            <!-- Expiration Timer -->
            <div id="clientExpirationBanner" class="expiration-banner inline-flex mt-6 hidden shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-hero" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-sm font-medium text-secondary">Offer expires in</span>
                <div class="flex items-center gap-1 font-mono">
                  <span id="clientTimerDays" class="timer-digit text-primary">00</span>
                  <span class="text-muted font-bold text-xs pt-1">d</span>
                  <span id="clientTimerHours" class="timer-digit text-primary">00</span>
                  <span class="text-muted font-bold text-xs pt-1">h</span>
                  <span id="clientTimerMinutes" class="timer-digit text-primary">00</span>
                  <span class="text-muted font-bold text-xs pt-1">m</span>
                </div>
            </div>
        </div>

        <!-- MAIN STAGE (Selected Option) -->
        <div id="clientMainStage" class="w-full mb-8">
            <!-- Injected via JS -->
        </div>

        <!-- ALTERNATIVES (Thumbnails) -->
        <div id="clientAlternativesContainer" class="w-full hidden">
            <h4 class="text-xs font-bold text-muted uppercase tracking-widest text-center mb-4">Other Available Options</h4>
            <div id="clientThumbnails" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <!-- Injected via JS -->
            </div>
        </div>

        <!-- Rep Contact -->
        <div id="clientRepInfo" class="mt-12 pt-6 border-t border-primary text-xs text-secondary text-center hidden w-full max-w-lg mb-10">
          <div class="font-bold text-muted mb-2 uppercase tracking-wider text-[10px]">Your Funding Specialist</div>
          <div id="clientRepName" class="font-bold text-primary text-base"></div>
          <div id="clientRepEmail" class="text-muted font-medium mt-1"></div>
          <div id="clientRepPhone" class="text-muted font-medium"></div>
        </div>
    </div>
  </div>

  <!-- AMORTIZATION SCHEDULE MODAL -->
  <div id="amortModal" class="modal-overlay hidden" style="z-index: 200;">
    <div class="modal-content max-w-2xl bg-[var(--bg-card)] rounded-2xl overflow-hidden shadow-2xl flex flex-col max-h-[85vh]">
      <div class="p-5 border-b border-primary flex items-center justify-between bg-[var(--bg-card-inner)]">
        <div>
            <h3 class="text-lg font-bold text-primary">Payment Schedule</h3>
            <p id="amortSubtitle" class="text-xs text-muted">Estimated repayment timeline based on selected terms.</p>
        </div>
        <button onclick="document.getElementById('amortModal').classList.add('hidden')" class="p-2 rounded-lg hover:bg-gray-200/50 text-secondary transition-colors">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
      </div>
      <div class="overflow-y-auto flex-1 p-0">
        <table class="w-full text-sm amort-table">
            <thead class="sticky top-0 z-10 shadow-sm">
                <tr>
                    <th>#</th>
                    <th>Date</th>
                    <th>Payment</th>
                    <th>Balance</th>
                </tr>
            </thead>
            <tbody id="amortTableBody">
                <!-- Rows injected here -->
            </tbody>
        </table>
      </div>
      <div class="p-4 border-t border-primary bg-[var(--bg-card-inner)] text-center text-xs text-muted">
        *Dates are estimates and exclude weekends/holidays where applicable.
      </div>
    </div>
  </div>

  <!-- OFFER DETAIL MODAL (Admin Side) -->
  <div id="offerDetailModal" class="modal-overlay hidden" role="dialog" aria-modal="true" aria-labelledby="offerDetailTitle">
    <div class="modal-content max-w-lg">
      <div class="p-6 border-b border-primary flex items-center justify-between">
        <h3 id="offerDetailTitle" class="text-lg font-bold text-primary">Offer Details</h3>
        <button type="button" onclick="closeOfferDetailModal()" class="p-2 rounded-lg hover:bg-gray-100 text-muted" aria-label="Close offer details">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
      <div id="offerDetailContent" class="p-6"></div>
      <div class="px-6 pb-4">
        <div class="text-center text-xs font-medium text-muted mb-2 uppercase tracking-wider">Scan to view offer</div>
        <div id="offerQrCode" class="qr-container"></div>
      </div>
      <div class="p-6 border-t border-primary">
        <div class="flex gap-3 mb-3">
          <button type="button" onclick="copyOfferLink()" class="button-secondary flex-1 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
            </svg>
            Copy Link
          </button>
          <button type="button" onclick="sendOfferEmail()" class="button-secondary flex-1 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
            Email Client
          </button>
          <button type="button" onclick="copyOfferText()" class="button-primary flex-1 flex items-center justify-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
            Copy Text
          </button>
        </div>
        
        <!-- Action Row 2 -->
        <div class="flex gap-3">
            <button type="button" onclick="cloneOffer()" class="button-toggle-action flex-1 bg-[var(--bg-card)] hover:bg-[var(--bg-card-inner)] border-primary text-primary" style="border-style: solid;">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8 7v8a2 2 0 002 2h6M8 7V5a2 2 0 012-2h4.586a1 1 0 01.707.293l4.414 4.414a1 1 0 01.293.707V15a2 2 0 01-2 2h-2M8 7H6a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2v-2" /></svg>
              Clone as New Offer
            </button>
            <button type="button" onclick="confirmDeleteOffer()" class="button-danger flex-1 flex items-center justify-center gap-2">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
              </svg>
              Delete
            </button>
        </div>
      </div>
    </div>
  </div>

  <!-- CONFIRM DELETE MODAL -->
  <div id="confirmModal" class="modal-overlay hidden" style="z-index: 110;">
    <div class="modal-content max-w-sm p-6 text-center">
      <h3 class="text-lg font-semibold text-primary mb-2">Confirm Deletion</h3>
      <p class="text-muted mb-6">Are you sure you want to delete this offer? This cannot be undone.</p>
      <div class="flex gap-3">
        <button onclick="closeConfirmModal()" class="button-secondary flex-1">Cancel</button>
        <button onclick="executeDelete()" class="button-primary flex-1 bg-red-500 hover:bg-red-600 border-none text-white">Delete</button>
      </div>
    </div>
  </div>

  <!-- TOAST -->
  <div id="toast" class="toast" role="status" aria-live="polite">
    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-400" viewBox="0 0 20 20" fill="currentColor">
      <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" />
    </svg>
    <span id="toastMessage">Success!</span>
  </div>

  <script>
    // ====================
    // DATA STORE
    // ====================
    let offers = [];
    let currentFilter = 'all';
    let currentView = 'dashboard';
    let selectedOfferId = null;
    let clientTimerId = null;
    let activeClientOptionIdx = 0; // Tracks which option is "Front and Center"
    
    // Calculator State
    let activeCalcTab = 0;
    let calcOptions = []; // Array of option objects

    let settings = {
      repName: '',
      repEmail: '',
      repPhone: '',
      companyName: '',
      logoUrl: '',
      defaultFactor: 1.25,
      defaultTerm: 130,
      defaultExpiry: 14,
      accent: 'mint',
      showApr: false 
    };

    const STORAGE_KEY = 'trustbureau_offers';
    const SETTINGS_KEY = 'trustbureau_settings';

    // ====================
    // THEME & ACCENT
    // ====================
    let isDark = false;

    function toggleTheme() {
      isDark = !isDark;
      document.documentElement.classList.toggle('theme-dark', isDark);
      document.documentElement.classList.toggle('theme-light', !isDark);
      document.getElementById('themeLabel').textContent = isDark ? 'Light Mode' : 'Dark Mode';
      localStorage.setItem('theme', isDark ? 'dark' : 'light');
      updateSliderFills();
    }

    function loadTheme() {
      const saved = localStorage.getItem('theme');
      if (saved === 'dark') {
        isDark = true;
        document.documentElement.classList.remove('theme-light');
        document.documentElement.classList.add('theme-dark');
        document.getElementById('themeLabel').textContent = 'Light Mode';
      }
    }

    function setAccent(accent, save = true) {
      document.documentElement.classList.remove(
          'accent-mint', 'accent-blue', 'accent-gold', 'accent-purple', 'accent-red', 'accent-teal',
          'accent-pink', 'accent-orange', 'accent-indigo', 'accent-lime', 'accent-cyan',
          'accent-black', 'accent-grey', 'accent-white', 'accent-glow'
      );
      document.documentElement.classList.add('accent-' + accent);
      settings.accent = accent;
      if (save) {
        try {
          localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        } catch (e) {
          console.error('Error saving accent to settings:', e);
        }
      }
      updateSliderFills();
    }

    // ====================
    // UTILITIES
    // ====================
    function generateId() {
      return 'offer_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    }

    function formatCurrency(num) {
      const n = Number(num);
      if (isNaN(n)) return '$0';
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', minimumFractionDigits: 0, maximumFractionDigits: 2 }).format(n);
    }

    function parseNumber(val) {
      if (typeof val !== 'string' || !val) return 0;
      return parseFloat(val.replace(/[\$,]/g, '')) || 0;
    }

    function formatNumber(num) {
      return new Intl.NumberFormat('en-US').format(num);
    }

    function copyToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.position = "fixed";
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            const successful = document.execCommand('copy');
            if (successful) showToast('Copied to clipboard!');
            else showToast('Copy failed');
        } catch (err) {
            showToast('Copy failed');
        }
        document.body.removeChild(textArea);
    }

    function fireConfetti() {
      const canvas = document.getElementById('confettiCanvas');
      const ctx = canvas.getContext('2d');
      canvas.width = window.innerWidth;
      canvas.height = window.innerHeight;
      const pieces = [];
      const colors = ['#42D197', '#3b82f6', '#f97316', '#a855f7', '#ec4899', '#eab308'];
      for (let i = 0; i < 150; i++) {
        pieces.push({
          x: Math.random() * canvas.width,
          y: Math.random() * canvas.height - canvas.height,
          w: Math.random() * 12 + 5,
          h: Math.random() * 6 + 4,
          color: colors[Math.floor(Math.random() * colors.length)],
          vy: Math.random() * 3 + 2,
          vx: Math.random() * 4 - 2,
          rotation: Math.random() * 360
        });
      }
      function update() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        let active = false;
        pieces.forEach(p => {
          p.y += p.vy;
          p.x += p.vx;
          p.rotation += 3;
          if (p.y < canvas.height + 50) active = true;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate(p.rotation * Math.PI / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h);
          ctx.restore();
        });
        if (active) requestAnimationFrame(update);
        else ctx.clearRect(0, 0, canvas.width, canvas.height);
      }
      update();
    }

    // ====================
    // STORAGE
    // ====================
    function loadOffers() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          let rawOffers = JSON.parse(stored);
          const now = Date.now();
          
          // Data Migration: Ensure all offers have 'options' array
          offers = rawOffers.map(offer => {
            if (!offer.options) {
                // Migrate single offer to options array
                const migratedOption = {
                    id: 0,
                    amount: offer.amount,
                    factor: offer.factor,
                    term: offer.term,
                    frequency: offer.frequency,
                    fee: offer.fee || 0,
                    prepayDiscount: offer.prepayDiscount || 0,
                    termOverride: offer.termOverride || '',
                    // Recalculate derived
                    ...calculateOffer(offer.amount, offer.factor, offer.term, offer.frequency, offer.fee || 0)
                };
                offer.options = [migratedOption];
            }
            
            if (offer.status === 'pending' && offer.expiresAt && now > offer.expiresAt) {
              offer.status = 'expired';
            }
            return offer;
          });
          saveOffers();
        }
      } catch (e) {
        console.error('Error loading offers:', e);
        offers = [];
      }
    }

    function saveOffers() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(offers));
      } catch (e) {
        console.error('Error saving offers:', e);
      }
    }

    function loadSettings() {
      try {
        const stored = localStorage.getItem(SETTINGS_KEY);
        if (stored) {
          settings = { ...settings, ...JSON.parse(stored) };
        }
        updateSettingsUI();
        updateRepDisplay();
        if (settings.accent) {
          setAccent(settings.accent, false);
        }
      } catch (e) {
        console.error('Error loading settings:', e);
      }
    }

    function saveSettings() {
      settings.repName = document.getElementById('settingsRepName').value.trim();
      settings.repEmail = document.getElementById('settingsRepEmail').value.trim();
      settings.repPhone = document.getElementById('settingsRepPhone').value.trim();
      settings.companyName = document.getElementById('settingsCompanyName').value.trim();
      settings.logoUrl = document.getElementById('settingsLogoUrl').value.trim();
      settings.defaultFactor = parseFloat(document.getElementById('settingsDefaultFactor').value) || 1.25;
      settings.defaultTerm = parseInt(document.getElementById('settingsDefaultTerm').value) || 130;
      settings.defaultExpiry = parseInt(document.getElementById('settingsDefaultExpiry').value) || 14;
      settings.showApr = document.getElementById('settingsShowApr').checked;
      
      try {
        localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        updateRepDisplay();
        showToast('Settings saved!');
        updateCalculatorPreview();
      } catch (e) {
        console.error('Error saving settings:', e);
      }
    }

    function updateSettingsUI() {
      document.getElementById('settingsRepName').value = settings.repName || '';
      document.getElementById('settingsRepEmail').value = settings.repEmail || '';
      document.getElementById('settingsRepPhone').value = settings.repPhone || '';
      document.getElementById('settingsCompanyName').value = settings.companyName || '';
      document.getElementById('settingsLogoUrl').value = settings.logoUrl || '';
      document.getElementById('settingsDefaultFactor').value = settings.defaultFactor || 1.25;
      document.getElementById('settingsDefaultTerm').value = settings.defaultTerm || 130;
      document.getElementById('settingsDefaultExpiry').value = settings.defaultExpiry || 14;
      document.getElementById('settingsShowApr').checked = settings.showApr || false;
    }

    function updateRepDisplay() {
      const repName = settings.repName || 'Not Set';
      document.getElementById('repNameSidebar').textContent = repName;
    }

    // ====================
    // CALCULATIONS
    // ====================
    function calculateOffer(amount, factor, term, frequency, fee) {
      const totalPayback = amount * factor;
      const totalCost = totalPayback - amount;
      const payment = totalPayback / term;
      const feeAmount = amount * (fee / 100);
      const netProceeds = amount - feeAmount;
      
      let termInYears;
      if (frequency === 'weekly') termInYears = term / 52;
      else if (frequency === 'monthly') termInYears = term / 12;
      else termInYears = term / 250;
      
      const apr = termInYears > 0 ? Math.round(((totalCost / amount) / termInYears) * 100) : 0;

      let termMonths;
      if (frequency === 'weekly') termMonths = term * (12 / 52);
      else if (frequency === 'monthly') termMonths = term;
      else termMonths = term * (12 / 250);
      termMonths = Math.round(termMonths * 2) / 2;
      
      return { amount, factor, term, frequency, fee, feeAmount, netProceeds, totalPayback, totalCost, payment, apr, termMonths };
    }

    // ====================
    // CALCULATOR STATE & LOGIC
    // ====================
    function initDefaultOption() {
        return {
            amount: 50000,
            factor: settings.defaultFactor,
            term: settings.defaultTerm,
            frequency: 'daily',
            fee: 0,
            prepay: 0,
            termOverride: ''
        };
    }

    function addCalcOption() {
        if (calcOptions.length >= 3) return;
        
        // Clone the previous option for convenience
        const prev = calcOptions[calcOptions.length - 1];
        const newOption = { ...prev }; 
        calcOptions.push(newOption);
        
        updateTabsUI();
        switchCalcTab(calcOptions.length - 1);
    }

    function removeCalcOption() {
        if (calcOptions.length <= 1) return;
        
        calcOptions.splice(activeCalcTab, 1);
        
        // Reset to first tab if we deleted the last one
        if (activeCalcTab >= calcOptions.length) {
            activeCalcTab = calcOptions.length - 1;
        }
        
        updateTabsUI();
        switchCalcTab(activeCalcTab);
    }

    function switchCalcTab(index) {
        // 1. Save current inputs to state before switching
        saveInputsToState(activeCalcTab);
        
        activeCalcTab = index;
        
        // 2. Update UI
        updateTabsUI();
        
        // 3. Load state into inputs
        loadStateToInputs(activeCalcTab);
        
        // 4. Update preview
        updateCalculatorPreview();
        updateSliderFills();
    }

    function updateTabsUI() {
        // Show/Hide tabs
        for(let i=0; i<3; i++) {
            const btn = document.getElementById(`tab-btn-${i}`);
            if (i < calcOptions.length) {
                btn.classList.remove('hidden');
                btn.classList.toggle('active', i === activeCalcTab);
            } else {
                btn.classList.add('hidden');
            }
        }
        
        // Show/Hide Add button
        document.getElementById('add-tab-btn').classList.toggle('hidden', calcOptions.length >= 3);
        
        // Show/Hide Remove button
        document.getElementById('remove-option-btn').classList.toggle('hidden', calcOptions.length <= 1);
        
        // Update Preview Label
        document.getElementById('previewOptionLabel').textContent = `Option ${activeCalcTab + 1}`;
    }

    function saveInputsToState(index) {
        if (!calcOptions[index]) return;
        
        // Check checkboxes directly
        const feeEnabled = document.getElementById('toggleFee').checked;
        const prepayEnabled = document.getElementById('togglePrepay').checked;
        const overrideEnabled = document.getElementById('toggleOverride').checked;
        // Expiry is global for now, but if we wanted per-option expiry we'd grab it here.
        // For structure consistency we save inputs.

        calcOptions[index] = {
            amount: parseNumber(document.getElementById('calcAmount').value),
            factor: parseFloat(document.getElementById('calcFactor').value) || 1.25,
            term: parseInt(document.getElementById('calcTerm').value) || 130,
            frequency: document.querySelector('.toggle-btn.active').dataset.freq,
            fee: feeEnabled ? (parseFloat(document.getElementById('calcFee').value) || 0) : 0,
            prepay: prepayEnabled ? (parseInt(document.getElementById('calcPrepay').value) || 0) : 0,
            termOverride: overrideEnabled ? document.getElementById('calcTermOverride').value.trim() : ''
        };
    }

    function loadStateToInputs(index) {
        const opt = calcOptions[index];
        if (!opt) return;

        document.getElementById('calcAmount').value = formatNumber(opt.amount);
        document.getElementById('calcAmountSlider').value = opt.amount;
        
        document.getElementById('calcFactor').value = opt.factor;
        document.getElementById('calcFactorSlider').value = opt.factor;
        
        document.getElementById('calcTerm').value = opt.term;
        document.getElementById('calcTermSlider').value = opt.term;
        
        // Term Override
        const hasOverride = !!opt.termOverride;
        document.getElementById('toggleOverride').checked = hasOverride;
        toggleOverrideSection(hasOverride);
        if (hasOverride) {
            document.getElementById('calcTermOverride').value = opt.termOverride;
        }

        // Frequency
        document.querySelectorAll('.toggle-btn[data-freq]').forEach(btn => {
            const isActive = btn.dataset.freq === opt.frequency;
            btn.classList.toggle('active', isActive);
            btn.setAttribute('aria-pressed', isActive);
        });

        // Fee
        const hasFee = opt.fee > 0;
        document.getElementById('toggleFee').checked = hasFee;
        toggleFeeSection(hasFee);
        if(hasFee) {
            document.getElementById('calcFee').value = opt.fee;
            document.getElementById('calcFeeSlider').value = opt.fee;
        }

        // Prepay
        const hasPrepay = opt.prepay > 0;
        document.getElementById('togglePrepay').checked = hasPrepay;
        togglePrepaySection(hasPrepay);
        if(hasPrepay) {
            document.getElementById('calcPrepay').value = opt.prepay;
            document.getElementById('calcPrepaySlider').value = opt.prepay;
        }
    }

    // ====================
    // UI HANDLERS
    // ====================
    function updateSliderFill(slider) {
      if (!slider) return;
      const min = parseFloat(slider.min) || 0;
      const max = parseFloat(slider.max) || 100;
      const val = parseFloat(slider.value) || 0;
      const percentage = ((val - min) / (max - min)) * 100;
      slider.style.background = `linear-gradient(to right, var(--accent-color) 0%, var(--accent-color) ${percentage}%, var(--bg-slider-track) ${percentage}%, var(--bg-slider-track) 100%)`;
    }

    function updateSliderFills() {
      updateSliderFill(document.getElementById('calcAmountSlider'));
      updateSliderFill(document.getElementById('calcFactorSlider'));
      updateSliderFill(document.getElementById('calcTermSlider'));
      updateSliderFill(document.getElementById('calcFeeSlider'));
      updateSliderFill(document.getElementById('calcPrepaySlider'));
    }

    function toggleContactInfo(forceState = null) {
        const container = document.getElementById('extraContactInfo');
        const icon = document.getElementById('iconContactChevron');
        const label = document.getElementById('lblContactAction');
        
        const isHidden = container.classList.contains('hidden');
        const shouldShow = forceState !== null ? forceState : isHidden;
        
        if (shouldShow) {
            container.classList.remove('hidden');
            icon.style.transform = 'rotate(180deg)';
            label.textContent = 'Hide Details';
        } else {
            container.classList.add('hidden');
            icon.style.transform = 'rotate(0deg)';
            label.textContent = 'Add Details';
        }
    }

    // Updated Toggle Functions for New Layout
    function toggleFeeSection(show) {
        const content = document.getElementById('contentFee');
        if (show) {
            content.classList.remove('hidden');
        } else {
            content.classList.add('hidden');
            document.getElementById('calcFee').value = 0;
            document.getElementById('calcFeeSlider').value = 0;
            updateSliderFill(document.getElementById('calcFeeSlider'));
            updateCalculatorPreview();
        }
    }

    function togglePrepaySection(show) {
        const content = document.getElementById('contentPrepay');
        if (show) {
            content.classList.remove('hidden');
        } else {
            content.classList.add('hidden');
            document.getElementById('calcPrepay').value = 0;
            document.getElementById('calcPrepaySlider').value = 0;
            updateSliderFill(document.getElementById('calcPrepaySlider'));
        }
    }

    function toggleOverrideSection(show) {
        const content = document.getElementById('contentOverride');
        if (show) {
            content.classList.remove('hidden');
        } else {
            content.classList.add('hidden');
            document.getElementById('calcTermOverride').value = '';
            updateCalculatorPreview();
        }
    }

    function toggleExpirySection(show) {
        const content = document.getElementById('contentExpiry');
        if (show) {
            content.classList.remove('hidden');
            // If empty, set default
            if(!document.getElementById('calcExpiryDate').value) {
                setExpiryDateDefault();
            }
        } else {
            content.classList.add('hidden');
            // We don't necessarily clear it, just hide it. Logic uses default if hidden/empty.
        }
    }

    function setFrequency(freq) {
        document.querySelectorAll('.toggle-btn[data-freq]').forEach(btn => {
            const isActive = btn.dataset.freq === freq;
            btn.classList.toggle('active', isActive);
        });
        updateCalculatorPreview();
    }

    function setExpiryDateDefault() {
        const date = new Date();
        date.setDate(date.getDate() + (settings.defaultExpiry || 14));
        document.getElementById('calcExpiryDate').value = date.toISOString().split('T')[0];
    }

    function updateCalculatorPreview() {
      // Triggered on input change. Since we track state on tab switch, 
      // we just read values directly from DOM for the preview.
      
      const amount = parseNumber(document.getElementById('calcAmount').value);
      const factor = parseFloat(document.getElementById('calcFactor').value) || 1.25;
      const term = parseInt(document.getElementById('calcTerm').value) || 130;
      
      // Override logic
      const overrideEnabled = document.getElementById('toggleOverride').checked;
      const termOverride = overrideEnabled ? document.getElementById('calcTermOverride').value.trim() : '';
      
      const businessName = document.getElementById('calcBusinessName').value.trim();
      
      // Fee logic
      const feeEnabled = document.getElementById('toggleFee').checked;
      const fee = feeEnabled ? (parseFloat(document.getElementById('calcFee').value) || 0) : 0;
      
      const freq = document.querySelector('.toggle-btn.active').dataset.freq;
      
      const calc = calculateOffer(amount, factor, term, freq, fee);
      
      // Update preview
      if (businessName) {
        document.getElementById('previewBusinessName').textContent = businessName;
        document.getElementById('previewBusinessName').classList.remove('hidden');
      } else {
        document.getElementById('previewBusinessName').classList.add('hidden');
      }
      
      document.getElementById('previewAmount').textContent = formatCurrency(calc.amount);
      document.getElementById('previewPaybackChart').textContent = formatCurrency(calc.totalPayback);
      
      const aprContainer = document.getElementById('previewAprContainer');
      if (settings.showApr) {
          aprContainer.classList.remove('hidden');
          document.getElementById('previewApr').textContent = calc.apr + '%';
      } else {
          aprContainer.classList.add('hidden');
      }

      document.getElementById('previewTermLength').textContent = termOverride ? termOverride : (calc.termMonths + ' months');
      document.getElementById('previewTermPayments').textContent = calc.term + ' payments';
      document.getElementById('previewFactor').textContent = calc.factor.toFixed(2) + 'x';
      document.getElementById('previewCost').textContent = formatCurrency(calc.totalCost);
      
      const paymentLabel = freq === 'weekly' ? 'Est. Weekly Payment' : 
                           freq === 'monthly' ? 'Est. Monthly Payment' : 'Est. Daily Payment';
      document.getElementById('previewPaymentLabel').textContent = paymentLabel;
      document.getElementById('previewPayment').textContent = formatCurrency(calc.payment);
      
      if (fee > 0) {
        document.getElementById('previewFeeRow').classList.remove('hidden');
        document.getElementById('previewFeeAmount').textContent = formatCurrency(calc.feeAmount);
        document.getElementById('previewNet').textContent = formatCurrency(calc.netProceeds);
      } else {
        document.getElementById('previewFeeRow').classList.add('hidden');
      }
      
      const principalPct = calc.totalPayback > 0 ? (calc.amount / calc.totalPayback) * 100 : 0;
      document.getElementById('previewCircle').setAttribute('stroke-dasharray', `${principalPct} ${100 - principalPct}`);
    }

    function resetCalculator() {
      document.getElementById('calcBusinessName').value = '';
      document.getElementById('calcContactName').value = '';
      document.getElementById('calcEmail').value = '';
      
      setExpiryDateDefault();
      
      // Reset Contact Toggle
      toggleContactInfo(false);
      
      // Reset Toggles
      document.getElementById('toggleFee').checked = false;
      document.getElementById('togglePrepay').checked = false;
      document.getElementById('toggleOverride').checked = false;
      document.getElementById('toggleExpiry').checked = false;
      
      toggleFeeSection(false);
      togglePrepaySection(false);
      toggleOverrideSection(false);
      toggleExpirySection(false);

      calcOptions = [initDefaultOption()];
      activeCalcTab = 0;
      
      updateTabsUI();
      loadStateToInputs(0);
      updateSliderFills();
      updateCalculatorPreview();
    }

    // ====================
    // CLIENT VIEW LOGIC
    // ====================
    function showClientView(offerId) {
      const offer = offers.find(o => o.id === offerId);
      if (!offer) {
        document.getElementById('dashboardContainer').classList.remove('hidden');
        document.getElementById('clientContainer').classList.add('hidden');
        return;
      }

      if (!offer.viewedAt) {
        offer.viewedAt = Date.now();
        saveOffers();
      }

      if (offer.accent) setAccent(offer.accent, false);

      document.getElementById('dashboardContainer').classList.add('hidden');
      document.getElementById('clientContainer').classList.remove('hidden');

      // Logo & Info Setup
      if (offer.logoUrl) {
        document.getElementById('clientLogo').src = offer.logoUrl;
        document.getElementById('clientLogo').classList.remove('hidden');
        document.getElementById('clientLogoPlaceholder').classList.add('hidden');
      } else {
        document.getElementById('clientLogo').classList.add('hidden');
        document.getElementById('clientLogoPlaceholder').classList.remove('hidden');
      }
      
      document.getElementById('clientCompanyName').textContent = offer.companyName || 'TrustBureau.ai';

      if (offer.businessName) {
        document.getElementById('clientBusinessNameDisplay').textContent = `for ${offer.businessName}`;
        document.getElementById('clientBusinessNameDisplay').classList.remove('hidden');
      }

      // Initialize View with First Option (or previously selected if we tracked it)
      activeClientOptionIdx = 0;
      renderClientViewLogic(offer);

      // Rep info
      if (offer.repName || offer.repEmail) {
        document.getElementById('clientRepInfo').classList.remove('hidden');
        document.getElementById('clientRepName').textContent = offer.repName || '';
        document.getElementById('clientRepEmail').textContent = offer.repEmail || '';
        document.getElementById('clientRepPhone').textContent = offer.repPhone || '';
      } else {
        document.getElementById('clientRepInfo').classList.add('hidden');
      }

      // Expiration
      const now = Date.now();
      const banner = document.getElementById('clientExpirationBanner');
      if (offer.status !== 'accepted' && offer.status !== 'expired' && now < offer.expiresAt) {
        banner.classList.remove('hidden');
        startClientTimer(offer.expiresAt);
      } else {
        banner.classList.add('hidden');
      }

      window.currentClientOfferId = offerId;
    }

    function renderClientViewLogic(offer) {
        // 1. Render Main Stage (Active Option)
        const activeOpt = offer.options[activeClientOptionIdx];
        const mainContainer = document.getElementById('clientMainStage');
        
        mainContainer.innerHTML = generateMainStageHTML(activeOpt, activeClientOptionIdx, offer.status, offer.showApr);
        
        // Initialize the logic for the active card immediately
        updateClientMainCard(activeOpt.amount);

        // 2. Render Thumbnails (Alternatives)
        const altContainer = document.getElementById('clientAlternativesContainer');
        const thumbsContainer = document.getElementById('clientThumbnails');
        
        if (offer.options.length > 1) {
            altContainer.classList.remove('hidden');
            thumbsContainer.innerHTML = offer.options.map((opt, i) => {
                if (i === activeClientOptionIdx) return ''; // Skip active
                return generateThumbnailHTML(opt, i);
            }).join('');
        } else {
            altContainer.classList.add('hidden');
        }
    }

    function generateMainStageHTML(opt, index, status, showApr) {
        const termLabel = opt.termOverride ? opt.termOverride : (opt.termMonths + ' months');
        
        // Button State
        let btnState = '';
        if (status === 'accepted') {
            btnState = `<div class="p-4 bg-green-50 text-green-700 rounded-xl font-bold text-center border border-green-200 w-full">
                <div class="flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path></svg>
                    Offer Accepted
                </div>
            </div>`;
        } else if (status === 'expired') {
            btnState = `<div class="p-4 bg-red-50 text-red-700 rounded-xl font-bold text-center border border-red-200 w-full">Offer Expired</div>`;
        } else {
            btnState = `<button onclick="acceptOffer('${index}')" class="button-primary w-full py-4 font-bold text-lg shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 transition-all">Select This Option</button>`;
        }

        return `
        <div class="bg-[var(--bg-card)] border border-primary/50 shadow-2xl rounded-2xl overflow-hidden relative">
            <div class="bg-[var(--bg-card-inner)] p-4 border-b border-primary flex justify-between items-center">
                <span class="text-xs font-bold text-muted uppercase tracking-widest">Option ${index + 1}</span>
                <span class="badge badge-accepted text-xs">Recommended</span>
            </div>
            
            <div class="p-6 md:p-8">
                <div class="flex flex-col md:flex-row gap-10 items-start">
                    
                    <!-- Left Column: Slider & Stats -->
                    <div class="flex-1 w-full">
                        <label class="text-xs font-bold text-secondary mb-3 block uppercase tracking-wider">Approved Funding Amount</label>
                        <div class="flex items-baseline gap-2 mb-6">
                            <span class="text-5xl font-bold text-hero tracking-tight" id="clientMainAmount">${formatCurrency(opt.amount)}</span>
                            <span class="text-sm font-medium text-muted">/ ${formatCurrency(opt.amount)} Max</span>
                        </div>
                        
                        <div class="mb-8">
                            <input type="range" id="clientMainSlider" min="5000" max="${opt.amount}" step="1000" value="${opt.amount}" 
                                class="w-full accent-[var(--accent-color)] h-3 bg-[var(--bg-slider-track)] rounded-lg appearance-none cursor-pointer"
                                oninput="updateClientMainCard(this.value)">
                            <div class="flex justify-between text-xs text-muted font-medium mt-2">
                                <span>$5,000</span>
                                <span>Slide to adjust amount</span>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 gap-4">
                            <div class="p-3 rounded-xl bg-[var(--bg-card-inner)] border border-primary">
                                <span class="text-[10px] font-bold text-muted uppercase block">Total Payback</span>
                                <span id="clientMainPayback" class="text-lg font-bold text-primary">...</span>
                            </div>
                            <div class="p-3 rounded-xl bg-[var(--bg-card-inner)] border border-primary">
                                <span class="text-[10px] font-bold text-muted uppercase block">Cost of Capital</span>
                                <span id="clientMainCost" class="text-lg font-bold text-secondary">...</span>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Visuals & Payment -->
                    <div class="w-full md:w-80 flex flex-col gap-6 flex-shrink-0">
                        
                        <!-- Donut Visual -->
                        <div class="flex items-center gap-4 bg-[var(--bg-card-inner)] p-4 rounded-xl border border-primary">
                            <div class="relative w-20 h-20 flex-shrink-0">
                                <svg viewBox="0 0 36 36" class="circular-chart w-full h-full transform -rotate-90">
                                    <path class="circle-bg" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                    <path id="clientMainDonut" class="circle" stroke-dasharray="0, 100" d="M18 2.0845 a 15.9155 15.9155 0 0 1 0 31.831 a 15.9155 15.9155 0 0 1 0 -31.831" />
                                </svg>
                            </div>
                            <div>
                                <span class="text-[10px] font-bold text-muted uppercase block">Factor Rate</span>
                                <span class="text-xl font-bold text-primary">${opt.factor}x</span>
                                ${showApr ? `<span class="block text-xs text-hero font-medium mt-1">Est. APR ${opt.apr}%</span>` : ''}
                            </div>
                        </div>

                        <!-- Payment Box -->
                        <div class="border-l-4 border-[var(--accent-color)] pl-4 py-1">
                            <span class="text-[10px] font-bold text-muted uppercase block mb-1">Estimated ${opt.frequency} Payment</span>
                            <span id="clientMainPayment" class="text-3xl font-bold text-primary">...</span>
                            <span class="text-xs font-medium text-secondary block mt-1">${termLabel} Duration</span>
                        </div>

                        <button onclick="openAmortSchedule(${index})" class="text-xs font-bold text-[var(--accent-color)] hover:text-primary flex items-center gap-1 transition-colors">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>
                            View Amortization Schedule
                        </button>
                    </div>
                </div>

                <!-- Prepay Section -->
                ${opt.prepayDiscount > 0 ? `
                <div class="mt-8 pt-6 border-t border-dashed border-primary">
                    <div class="flex items-center gap-2 mb-4">
                        <span class="w-1.5 h-1.5 rounded-full bg-[var(--accent-color)]"></span>
                        <h5 class="text-sm font-bold text-primary">Early Payoff Savings</h5>
                        <span class="ml-auto text-xs font-bold text-[var(--accent-color)] bg-[var(--bg-card-inner)] px-2 py-1 rounded-md border border-primary">Up to ${opt.prepayDiscount}% Discount</span>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 items-end">
                        <div class="w-full sm:w-auto">
                            <label class="text-[10px] font-bold text-muted uppercase block mb-1">Select Payoff Date</label>
                            <input type="date" id="clientMainPrepayDate" 
                                class="p-2 text-sm font-medium bg-[var(--bg-card)] border border-primary rounded-lg focus:border-[var(--accent-color)] outline-none"
                                onchange="calculateMainClientSavings()">
                        </div>
                        <div class="flex-1 flex justify-between sm:justify-end gap-8 pb-1">
                            <div>
                                <span class="text-[10px] text-muted font-bold uppercase block">New Payoff Amount</span>
                                <span id="clientMainNewTotal" class="text-lg font-bold text-primary">$0</span>
                            </div>
                            <div class="text-right">
                                <span class="text-[10px] text-muted font-bold uppercase block">You Save</span>
                                <span id="clientMainSavings" class="text-lg font-bold text-green-600">$0</span>
                            </div>
                        </div>
                    </div>
                </div>` : ''}

                <div class="mt-8">
                    ${btnState}
                </div>
            </div>
        </div>
        `;
    }

    function generateThumbnailHTML(opt, index) {
        const termLabel = opt.termOverride ? opt.termOverride : (opt.termMonths + ' months');
        return `
        <div onclick="switchClientOption(${index})" class="bg-[var(--bg-card)] p-4 rounded-xl border border-primary hover:border-[var(--accent-color)] hover:shadow-md cursor-pointer transition-all flex items-center justify-between group">
            <div>
                <span class="text-[10px] font-bold text-muted uppercase block mb-1">Option ${index + 1}</span>
                <div class="text-lg font-bold text-primary group-hover:text-[var(--accent-color)] transition-colors">${formatCurrency(opt.amount)}</div>
                <div class="text-xs text-secondary mt-0.5">${termLabel}  ${opt.frequency}</div>
            </div>
            <div class="text-right">
                <div class="text-xs font-medium text-muted">Factor</div>
                <div class="font-bold text-primary">${opt.factor}x</div>
                <div class="text-[10px] font-bold text-[var(--accent-color)] mt-1 uppercase tracking-wide">View &rarr;</div>
            </div>
        </div>
        `;
    }

    function switchClientOption(index) {
        activeClientOptionIdx = index;
        const offer = offers.find(o => o.id === window.currentClientOfferId);
        renderClientViewLogic(offer);
        // Scroll up to main stage
        document.getElementById('clientMainStage').scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function updateClientMainCard(amountVal) {
        const offer = offers.find(o => o.id === window.currentClientOfferId);
        if (!offer) return;
        
        const opt = offer.options[activeClientOptionIdx];
        const amount = parseFloat(amountVal);
        
        // Recalculate based on fixed rate/term
        const totalPayback = amount * opt.factor;
        const totalCost = totalPayback - amount;
        const payment = totalPayback / opt.term;
        
        // Update DOM
        document.getElementById('clientMainAmount').textContent = formatCurrency(amount);
        document.getElementById('clientMainPayback').textContent = formatCurrency(totalPayback);
        document.getElementById('clientMainPayment').textContent = formatCurrency(payment);
        document.getElementById('clientMainCost').textContent = formatCurrency(totalCost);
        
        // Update Donut
        const principalPct = (amount / totalPayback) * 100;
        document.getElementById('clientMainDonut').setAttribute('stroke-dasharray', `${principalPct}, 100`);
        
        // Trigger Prepay Recalc if date is set
        calculateMainClientSavings();
    }

    function calculateMainClientSavings() {
        const offer = offers.find(o => o.id === window.currentClientOfferId);
        if (!offer) return;
        
        const dateInput = document.getElementById('clientMainPrepayDate');
        if (!dateInput || !dateInput.value) return;
        
        const amount = parseNumber(document.getElementById('clientMainAmount').textContent);
        const opt = offer.options[activeClientOptionIdx];
        const totalPayback = amount * opt.factor;
        
        const startDate = new Date();
        startDate.setHours(0,0,0,0);
        
        // Estimate Term Days
        let termDays = opt.term; // default daily
        if (opt.frequency === 'weekly') termDays = opt.term * 7;
        else if (opt.frequency === 'monthly') termDays = opt.term * 30.44;
        else termDays = opt.term * 1.42; 
        
        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + Math.ceil(termDays));
        
        let selectedDate = new Date(dateInput.value);
        selectedDate.setHours(0,0,0,0);
        
        const totalTime = endDate.getTime() - startDate.getTime();
        const remainingTime = endDate.getTime() - selectedDate.getTime();
        
        let fractionRemaining = totalTime > 0 ? remainingTime / totalTime : 0;
        fractionRemaining = Math.max(0, Math.min(1, fractionRemaining));
        
        const maxSavings = totalPayback * (opt.prepayDiscount / 100);
        const savings = maxSavings * fractionRemaining;
        const newTotal = totalPayback - savings;
        
        document.getElementById('clientMainSavings').textContent = formatCurrency(savings);
        document.getElementById('clientMainNewTotal').textContent = formatCurrency(newTotal);
    }

    function openAmortSchedule(index) {
        const offer = offers.find(o => o.id === window.currentClientOfferId);
        if (!offer || !offer.options[index]) return;
        
        const opt = offer.options[index];
        // Get current adjusted amount from UI
        const amount = parseNumber(document.getElementById('clientMainAmount').textContent);
        const totalPayback = amount * opt.factor;
        const payment = totalPayback / opt.term;
        
        const tbody = document.getElementById('amortTableBody');
        tbody.innerHTML = '';
        
        let balance = totalPayback;
        let date = new Date();
        const maxRows = 260; 
        
        for (let i = 1; i <= opt.term; i++) {
            if (i > maxRows && i < opt.term) continue; // Skip middle if too long
            if (i === maxRows && opt.term > maxRows) {
                 tbody.innerHTML += `<tr><td colspan="4" class="text-center text-muted py-2">... remaining payments ...</td></tr>`;
                 let lastDate = new Date();
                 lastDate.setDate(lastDate.getDate() + (opt.term * (opt.frequency==='weekly'?7:1.4)));
                 tbody.innerHTML += `<tr><td>${opt.term}</td><td>${lastDate.toLocaleDateString()}</td><td>${formatCurrency(payment)}</td><td>$0.00</td></tr>`;
                 break;
            }

            if (opt.frequency === 'weekly') date.setDate(date.getDate() + 7);
            else if (opt.frequency === 'monthly') date.setMonth(date.getMonth() + 1);
            else {
                date.setDate(date.getDate() + 1);
                if (date.getDay() === 0) date.setDate(date.getDate() + 1);
                if (date.getDay() === 6) date.setDate(date.getDate() + 2);
            }
            
            balance -= payment;
            if (balance < 0) balance = 0;
            
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${i}</td><td>${date.toLocaleDateString()}</td><td>${formatCurrency(payment)}</td><td>${formatCurrency(balance)}</td>`;
            tbody.appendChild(tr);
        }
        
        document.getElementById('amortModal').classList.remove('hidden');
    }

    function startClientTimer(expiresAt) {
      if (clientTimerId) clearInterval(clientTimerId);
      
      function updateTimer() {
        const now = Date.now();
        const diff = expiresAt - now;
        
        if (diff <= 0) {
          clearInterval(clientTimerId);
          location.reload(); 
          return;
        }
        
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        
        document.getElementById('clientTimerDays').textContent = days.toString().padStart(2, '0');
        document.getElementById('clientTimerHours').textContent = hours.toString().padStart(2, '0');
        document.getElementById('clientTimerMinutes').textContent = minutes.toString().padStart(2, '0');
      }
      
      updateTimer();
      clientTimerId = setInterval(updateTimer, 60000); // Update every minute
    }

    // Accepts a specific option index
    function acceptOffer(optionIndex) {
      const offerId = window.currentClientOfferId;
      const offer = offers.find(o => o.id === offerId);
      if (!offer) return;

      offer.status = 'accepted';
      offer.acceptedAt = Date.now();
      offer.acceptedOptionIndex = optionIndex; // Track which option was chosen
      saveOffers();

      fireConfetti();
      showClientView(offerId); // Re-render to show success state
      showToast('Offer accepted! Your funding specialist will be in touch.');
    }

    // ====================
    // UI UPDATES
    // ====================
    function updateStats() {
      const total = offers.length;
      const pending = offers.filter(o => o.status === 'pending').length;
      const accepted = offers.filter(o => o.status === 'accepted').length;
      // Calculate total value based on accepted options (default to opt 0 if index missing)
      const totalValue = offers.filter(o => o.status === 'accepted').reduce((sum, o) => {
          const idx = o.acceptedOptionIndex || 0;
          const amount = o.options && o.options[idx] ? o.options[idx].amount : o.amount;
          return sum + amount;
      }, 0);
      
      document.getElementById('statTotal').textContent = total;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statAccepted').textContent = accepted;
      document.getElementById('statValue').textContent = formatCurrency(totalValue);
    }

    function renderOffers(container, filter = 'all', limit = null) {
      let filtered = [...offers];
      
      if (filter !== 'all') {
        filtered = filtered.filter(o => o.status === filter);
      }
      
      filtered.sort((a, b) => b.createdAt - a.createdAt);
      
      if (limit) {
        filtered = filtered.slice(0, limit);
      }
      
      if (filtered.length === 0) {
        let emptyMsg = "No offers yet";
        if (filter === 'accepted') emptyMsg = "No accepted offers";
        if (filter === 'declined') emptyMsg = "No declined offers";
        
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <p class="text-lg mb-2">${emptyMsg}</p>
            ${filter === 'all' ? '<p class="text-sm">Click "New Offer" to create your first offer.</p>' : ''}
          </div>
        `;
        return;
      }
      
      const html = filtered.map(offer => {
        let statusClass = 'badge-pending';
        if (offer.status === 'accepted') statusClass = 'badge-accepted';
        else if (offer.status === 'expired') statusClass = 'badge-expired';
        else if (offer.status === 'declined') statusClass = 'badge-declined';
        
        const statusLabel = offer.status.charAt(0).toUpperCase() + offer.status.slice(1);
        const date = new Date(offer.createdAt).toLocaleDateString();
        
        // Display summary of first option + count
        const opt1 = offer.options[0];
        const count = offer.options.length;
        const countLabel = count > 1 ? `<span class="text-xs bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full ml-2">+${count-1} more</span>` : '';

        return `
          <div class="offer-card cursor-pointer" onclick="openOfferDetail('${offer.id}')">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h3 class="font-medium text-primary">${offer.businessName}</h3>
                <p class="text-sm text-muted">${offer.contactName || 'No contact'}</p>
              </div>
              <span class="badge ${statusClass}">${statusLabel}</span>
            </div>
            <div class="flex items-end justify-between">
              <div>
                <span class="text-2xl font-medium text-hero">${formatCurrency(opt1.amount)}</span>
                <span class="text-sm text-muted block mt-1">${opt1.frequency} payments ${countLabel}</span>
              </div>
              <div class="text-right text-sm">
                <span class="text-muted">${date}</span>
                ${offer.status === 'accepted' ? '<span class="block text-green-500 text-xs mt-1"> Accepted</span>' : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
      
      container.innerHTML = currentView === 'dashboard' ? 
        `<div class="space-y-4">${html}</div>` : html;
    }

    function renderClients() {
      const container = document.getElementById('clientsList');
      
      const clients = {};
      offers.forEach(offer => {
        if (!clients[offer.businessName]) {
          clients[offer.businessName] = {
            businessName: offer.businessName,
            contactName: offer.contactName,
            email: offer.email,
            phone: offer.phone,
            offers: []
          };
        }
        clients[offer.businessName].offers.push(offer);
      });
      
      const clientList = Object.values(clients);
      
      if (clientList.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1">
              <path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            <p class="text-lg mb-2">No clients yet</p>
            <p class="text-sm">Create an offer to add your first client.</p>
          </div>
        `;
        return;
      }
      
      container.innerHTML = clientList.map(client => {
        const acceptedCount = client.offers.filter(o => o.status === 'accepted').length;
        const totalValue = client.offers.reduce((sum, o) => sum + (o.options[0].amount), 0);
        
        return `
          <div class="card-bg rounded-xl border border-primary p-5 flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-full flex items-center justify-center font-medium text-lg" style="background: var(--accent-color); color: var(--accent-text-inverted);">
                ${client.businessName.charAt(0).toUpperCase()}
              </div>
              <div>
                <h3 class="font-medium text-primary">${client.businessName}</h3>
                <p class="text-sm text-muted">${client.contactName || client.email || 'No contact info'}</p>
              </div>
            </div>
            <div class="text-right">
              <div class="text-lg font-medium text-primary">${client.offers.length} offer${client.offers.length > 1 ? 's' : ''}</div>
              <div class="text-sm text-muted">${acceptedCount} accepted</div>
            </div>
          </div>
        `;
      }).join('');
    }

    // ====================
    // VIEW MANAGEMENT
    // ====================
    function switchView(view) {
      currentView = view;
      
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.remove('active');
        if (item.dataset.view === view) {
          item.classList.add('active');
        }
      });
      
      const titles = {
        dashboard: ['Dashboard', 'Welcome back! Here\'s your offer activity.'],
        calculator: ['Create New Offer', 'Build and share a funding offer with your client.'],
        offers: ['All Offers', 'Manage and track all your sent offers.'],
        accepted: ['Accepted Offers', 'View all accepted funding offers.'],
        declined: ['Declined Offers', 'View all declined or expired offers.'],
        clients: ['Clients', 'View all your clients and their offer history.'],
        settings: ['Settings', 'Configure your profile and preferences.']
      };
      
      document.getElementById('pageTitle').textContent = titles[view][0];
      document.getElementById('pageSubtitle').textContent = titles[view][1];
      
      document.getElementById('dashboardView').classList.toggle('hidden', view !== 'dashboard');
      document.getElementById('calculatorView').classList.toggle('hidden', view !== 'calculator');
      
      // Reuse offersView for All, Accepted, and Declined
      const isOffersView = ['offers', 'accepted', 'declined'].includes(view);
      document.getElementById('offersView').classList.toggle('hidden', !isOffersView);
      
      document.getElementById('clientsView').classList.toggle('hidden', view !== 'clients');
      document.getElementById('settingsView').classList.toggle('hidden', view !== 'settings');
      
      refreshView();
    }

    function refreshView() {
      updateStats();
      
      if (currentView === 'dashboard') {
        renderOffers(document.getElementById('recentOffersList'), currentFilter, 5);
      } else if (currentView === 'offers') {
        renderOffers(document.getElementById('allOffersList'), 'all');
      } else if (currentView === 'accepted') {
        renderOffers(document.getElementById('allOffersList'), 'accepted');
      } else if (currentView === 'declined') {
        // Show both explicit 'declined' and 'expired' in this view for better utility
        const container = document.getElementById('allOffersList');
        const filtered = offers.filter(o => o.status === 'declined' || o.status === 'expired');
        // Manually rendering here to combine statuses, or we could update renderOffers to take an array
        // For simplicity, let's just stick to exact match or handle inside renderOffers if needed.
        // Let's assume strict 'declined' for now to match the user request exactly.
        renderOffers(document.getElementById('allOffersList'), 'declined');
      } else if (currentView === 'clients') {
        renderClients();
      }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('open');
    }

    // ====================
    // INITIALIZATION
    // ====================
    window.addEventListener('load', init);

    function init() {
      // Check for client view
      const params = new URLSearchParams(window.location.search);
      const offerId = params.get('offer');
      
      loadTheme();
      loadSettings();
      loadOffers();

      if (offerId) {
        showClientView(offerId);
        return;
      }

      // If we're starting in app mode, init calculator state
      if (!offerId) {
          resetCalculator();
      }

      refreshView();
      
      // Nav clicks
      document.querySelectorAll('.nav-item[data-view]').forEach(item => {
        item.addEventListener('click', () => switchView(item.dataset.view));
      });
      
      // Filter toggles
      document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', () => {
          currentFilter = btn.dataset.filter;
          document.querySelectorAll('[data-filter]').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          refreshView();
        });
      });
      
      // Frequency toggles
      document.querySelectorAll('[data-freq]').forEach(btn => {
        btn.addEventListener('click', () => {
          selectedFrequency = btn.dataset.freq;
          updateFrequencyButtons();
          updateCalculatorPreview();
        });
      });
      
      // Calculator sliders
      const amountSlider = document.getElementById('calcAmountSlider');
      const amountInput = document.getElementById('calcAmount');
      amountSlider.addEventListener('input', () => {
        amountInput.value = formatNumber(parseInt(amountSlider.value));
        updateSliderFill(amountSlider);
        updateCalculatorPreview();
      });
      amountInput.addEventListener('input', () => {
        const val = parseNumber(amountInput.value);
        if (val >= 5000 && val <= 1000000) amountSlider.value = val;
        updateSliderFill(amountSlider);
        updateCalculatorPreview();
      });
      
      const factorSlider = document.getElementById('calcFactorSlider');
      const factorInput = document.getElementById('calcFactor');
      factorSlider.addEventListener('input', () => {
        factorInput.value = parseFloat(factorSlider.value).toFixed(2);
        updateSliderFill(factorSlider);
        updateCalculatorPreview();
      });
      factorInput.addEventListener('input', () => {
        const val = parseFloat(factorInput.value);
        if (val >= 1.05 && val <= 1.7) factorSlider.value = val;
        updateSliderFill(factorSlider);
        updateCalculatorPreview();
      });
      
      const termSlider = document.getElementById('calcTermSlider');
      const termInput = document.getElementById('calcTerm');
      termSlider.addEventListener('input', () => {
        termInput.value = termSlider.value;
        updateSliderFill(termSlider);
        updateCalculatorPreview();
      });
      termInput.addEventListener('input', () => {
        const val = parseInt(termInput.value);
        if (val >= 3 && val <= 528) termSlider.value = val;
        updateSliderFill(termSlider);
        updateCalculatorPreview();
      });

      // Term Override Listener
      document.getElementById('calcTermOverride').addEventListener('input', updateCalculatorPreview);
      
      // Fee Inputs
      const feeInput = document.getElementById('calcFee');
      const feeSlider = document.getElementById('calcFeeSlider');
      feeInput.addEventListener('input', () => {
        const val = parseFloat(feeInput.value) || 0;
        feeSlider.value = val;
        updateSliderFill(feeSlider);
        updateCalculatorPreview();
      });
      feeSlider.addEventListener('input', () => {
        const val = parseFloat(feeSlider.value) || 0;
        feeInput.value = val;
        updateSliderFill(feeSlider);
        updateCalculatorPreview();
      });

      document.getElementById('calcBusinessName').addEventListener('input', updateCalculatorPreview);
      
      // Prepay Inputs
      const prepayInput = document.getElementById('calcPrepay');
      const prepaySlider = document.getElementById('calcPrepaySlider');
      prepayInput.addEventListener('input', () => {
         const val = parseFloat(prepayInput.value) || 0;
         prepaySlider.value = val;
         updateSliderFill(prepaySlider);
      });
      prepaySlider.addEventListener('input', () => {
         const val = parseFloat(prepaySlider.value) || 0;
         prepayInput.value = val;
         updateSliderFill(prepaySlider);
      });

      // Initialize calculator preview
      updateSliderFills();
      updateCalculatorPreview();
      
      // Apply default settings to calculator
      document.getElementById('calcFactor').value = settings.defaultFactor;
      document.getElementById('calcFactorSlider').value = settings.defaultFactor;
      document.getElementById('calcTerm').value = settings.defaultTerm;
      document.getElementById('calcTermSlider').value = settings.defaultTerm;
      // document.getElementById('calcExpiry').value = settings.defaultExpiry; // Removed, now using Date picker
      updateSliderFills();
      updateCalculatorPreview();
    }
  </script>
</body>
</html>
